<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Khora • Data Import Tool</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0f17;
      --card: #141b28;
      --border: #2a3447;
      --text: #e8edf7;
      --muted: #9aa8c2;
      --accent: #c9a352;
      --accent-dim: rgba(201, 163, 82, 0.15);
      --ok: #3dd68c;
      --ok-dim: rgba(61, 214, 140, 0.12);
      --error: #ff7c7c;
      --error-dim: rgba(255, 124, 124, 0.10);
      --blue: #6ea8fe;
      --blue-dim: rgba(110, 168, 254, 0.10);
      --teal: #3ec9b0;
      --teal-dim: rgba(62, 201, 176, 0.10);
    }
    * { box-sizing: border-box; margin: 0; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at 20% 0%, #141b28 0%, #0b0f17 40%);
      color: var(--text);
      min-height: 100vh;
    }
    main {
      max-width: 1020px;
      margin: 0 auto;
      padding: 28px 16px 48px;
    }
    h1 { font-size: 1.7rem; margin-bottom: 6px; }
    h2 { font-size: 1.15rem; margin: 0; }
    p { color: var(--muted); line-height: 1.5; }
    .subtitle { font-size: 0.9rem; margin-bottom: 20px; }
    .card {
      background: color-mix(in oklab, var(--card) 92%, black);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 14px;
    }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
    label { display: block; margin-top: 10px; font-size: 0.84rem; color: var(--muted); }
    input, textarea, select, button {
      width: 100%;
      border-radius: 9px;
      border: 1px solid var(--border);
      background: #0f1522;
      color: var(--text);
      padding: 10px;
      margin-top: 6px;
      font-size: 0.92rem;
      font-family: inherit;
    }
    select { cursor: pointer; appearance: auto; }
    textarea { resize: vertical; min-height: 70px; }
    button {
      cursor: pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }
    button:hover:not(:disabled) { border-color: var(--accent); transform: translateY(-1px); }
    button:disabled { opacity: 0.4; cursor: default; }
    .btn-row { display: flex; gap: 10px; margin-top: 12px; }
    .btn-row button { flex: 1; }
    button.primary {
      border-color: var(--accent);
      background: linear-gradient(180deg, var(--accent), #9f7f3e);
      color: #121212;
      font-weight: 600;
    }
    button.ghost { background: transparent; }
    .status {
      margin-top: 10px;
      border-radius: 10px;
      background: #090e18;
      border: 1px solid var(--border);
      min-height: 100px;
      padding: 10px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.8rem;
    }
    .pill {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 0.75rem;
      margin-left: 7px;
      color: var(--muted);
    }
    .pill.ok { border-color: color-mix(in srgb, var(--ok) 60%, var(--border)); color: var(--ok); }
    .tag {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .tag-ok { background: var(--ok-dim); color: var(--ok); border: 1px solid rgba(61,214,140,.2); }
    .tag-err { background: var(--error-dim); color: var(--error); border: 1px solid rgba(255,124,124,.2); }
    .tag-blue { background: var(--blue-dim); color: var(--blue); border: 1px solid rgba(110,168,254,.2); }
    .tag-teal { background: var(--teal-dim); color: var(--teal); border: 1px solid rgba(62,201,176,.2); }
    .tag-accent { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(201,163,82,.2); }

    /* Drop zone */
    .dropzone {
      border: 2px dashed var(--border);
      border-radius: 14px;
      padding: 44px 24px;
      text-align: center;
      cursor: pointer;
      transition: all .2s;
      background: var(--card);
    }
    .dropzone.active { border-color: var(--accent); background: var(--accent-dim); }
    .dropzone-icon {
      width: 52px; height: 52px;
      border-radius: 14px;
      background: var(--accent-dim);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 14px;
      font-size: 24px;
    }

    /* Records table */
    .records-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .records-table th {
      text-align: left;
      padding: 8px 10px;
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }
    .records-table td {
      padding: 7px 10px;
      border-bottom: 1px solid rgba(42, 52, 71, 0.5);
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .records-table tr:hover td { background: rgba(201, 163, 82, 0.04); }

    /* Mapping row */
    .map-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(42, 52, 71, 0.5);
    }
    .map-row .source { flex: 1; min-width: 0; }
    .map-row .arrow { color: var(--muted); font-size: 14px; flex-shrink: 0; }
    .map-row .target { flex: 1; min-width: 0; }
    .map-row .source-name { font-size: 0.85rem; font-weight: 500; }
    .map-row .sample { font-size: 0.72rem; color: var(--muted); font-family: ui-monospace, monospace; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Steps indicator */
    .steps { display: flex; gap: 6px; margin-bottom: 18px; }
    .step-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: background .2s;
    }
    .step-dot.active { background: var(--accent); }
    .step-dot.done { background: var(--ok); }

    /* Stats grid */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin: 14px 0; }
    .stat {
      background: #090e18;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }
    .stat-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 4px; }
    .stat-value { font-size: 1.3rem; font-weight: 700; }

    /* Progress bar */
    .progress-bar { background: var(--border); border-radius: 8px; height: 8px; overflow: hidden; margin: 16px auto; max-width: 400px; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 8px; transition: width .3s; }

    /* Hint / info box */
    .hint {
      border-left: 3px solid var(--accent);
      background: var(--accent-dim);
      padding: 10px 14px;
      border-radius: 7px;
      font-size: 0.85rem;
      margin-top: 12px;
      line-height: 1.5;
    }
    .hint.green { border-color: var(--ok); background: var(--ok-dim); }
    .hint.red { border-color: var(--error); background: var(--error-dim); }
    .hint.blue { border-color: var(--blue); background: var(--blue-dim); }

    /* Stored records */
    .stored-records { list-style: none; padding: 0; }
    .stored-records li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(42, 52, 71, 0.5);
      font-size: 0.85rem;
    }
    .stored-records li:last-child { border-bottom: none; }
    .rec-index { color: var(--muted); font-family: monospace; font-size: 0.75rem; min-width: 28px; padding-top: 2px; }
    .rec-fields { flex: 1; }
    .rec-field { display: inline-block; background: #0f1522; border: 1px solid var(--border); border-radius: 6px; padding: 2px 8px; margin: 2px 3px 2px 0; font-size: 0.78rem; }
    .rec-field .key { color: var(--muted); }
    .rec-field .val { color: var(--text); }
    .rec-meta { font-size: 0.7rem; color: var(--muted); margin-top: 3px; }

    a { color: #8db2ff; }
    code { color: #f9de96; font-size: 0.88em; }
    .hidden { display: none; }

    /* Diag check items */
    .diag-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.88rem; }
    .diag-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
    .diag-icon.pass { background: var(--ok-dim); color: var(--ok); }
    .diag-icon.fail { background: var(--error-dim); color: var(--error); }
  </style>
</head>
<body>
<main>
  <h1>Khora Data Import Tool</h1>
  <p class="subtitle">
    Upload CSV or JSON files, map columns to vault fields, preview data, and store records locally.
    Standalone tool — no server required.
  </p>

  <!-- SECTION 1: DIAGNOSTICS + STORAGE INFO -->
  <div class="row">
    <section class="card">
      <h2>1) Browser Capabilities</h2>
      <p style="margin-top:6px;">Verify this browser supports all required APIs.</p>
      <button id="btnCheckApis" class="primary" style="margin-top:10px;">Run Diagnostics</button>
      <div id="diagResults" style="margin-top:12px;"></div>
    </section>

    <section class="card">
      <h2>2) Storage Status</h2>
      <p style="margin-top:6px;">
        Records: <span id="sessionPill" class="pill">0 stored</span>
      </p>
      <div class="stats" id="storageStats" style="margin-top:10px;"></div>
      <div class="btn-row">
        <button id="btnExportJSON" class="primary">Export as JSON</button>
        <button id="btnExportCSV" class="ghost">Export as CSV</button>
      </div>
      <div class="hint" style="margin-top:10px;">
        All data stays in your browser's <code>localStorage</code>. Nothing is sent to any server.
      </div>
    </section>
  </div>

  <!-- SECTION 2: FILE UPLOAD -->
  <section class="card" id="uploadSection">
    <h2>3) Import File</h2>
    <p style="margin-top:6px;">Upload a CSV or JSON file. Records will be parsed, mapped to vault fields, and stored locally.</p>

    <!-- Step indicators -->
    <div class="steps" style="margin-top:14px;">
      <div class="step-dot active" id="dot-upload"></div>
      <div class="step-dot" id="dot-map"></div>
      <div class="step-dot" id="dot-preview"></div>
      <div class="step-dot" id="dot-done"></div>
    </div>

    <!-- STEP: Upload -->
    <div id="step-upload">
      <div class="dropzone" id="dropzone">
        <div class="dropzone-icon">&#128194;</div>
        <p style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px;">Drop a CSV or JSON file here</p>
        <p style="font-size:12px;">or click to browse</p>
        <div style="display:flex;gap:6px;justify-content:center;margin-top:12px;">
          <span class="tag tag-blue">.csv</span>
          <span class="tag tag-teal">.json</span>
        </div>
      </div>
      <input type="file" id="fileInput" accept=".csv,.json,application/json,text/csv" style="display:none;" />
      <div class="hint green" style="margin-top:14px;">
        <strong style="color:var(--ok);">How it works:</strong>
        Your file is parsed entirely in the browser. No data is sent to any server. Records are stored in <code>localStorage</code>.
      </div>
    </div>

    <!-- STEP: Map Columns -->
    <div id="step-map" class="hidden">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div>
          <p style="font-size:13px;font-weight:600;color:var(--text);" id="mapFileName"></p>
          <p style="font-size:11px;color:var(--muted);" id="mapFileMeta"></p>
        </div>
        <button id="btnChangeFile" class="ghost" style="width:auto;padding:6px 14px;font-size:12px;">Change File</button>
      </div>
      <p style="font-size:12px;color:var(--muted);margin-bottom:10px;">
        Map each source column to a target vault field. Unmapped columns are skipped.
      </p>
      <div id="mappingContainer" style="max-height:360px;overflow:auto;"></div>
      <div class="stats" id="mapStats"></div>
      <div class="btn-row">
        <button id="btnBackToUpload" class="ghost">Back</button>
        <button id="btnToPreview" class="primary" disabled>Preview Records</button>
      </div>
    </div>

    <!-- STEP: Preview -->
    <div id="step-preview" class="hidden">
      <p style="font-size:12px;color:var(--muted);margin-bottom:14px;">
        Review the first 10 records before importing. Field values shown as stored.
      </p>
      <div style="overflow-x:auto;">
        <table class="records-table" id="previewTable">
          <thead id="previewHead"></thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
      <p style="font-size:11px;color:var(--muted);text-align:center;margin-top:8px;" id="previewMore"></p>
      <div class="stats" id="previewStats"></div>
      <div class="btn-row">
        <button id="btnBackToMap" class="ghost">Back</button>
        <button id="btnImport" class="primary">Import Records</button>
      </div>
    </div>

    <!-- STEP: Done -->
    <div id="step-done" class="hidden" style="text-align:center;padding:10px 0;">
      <div style="width:52px;height:52px;border-radius:50%;background:var(--ok-dim);display:flex;align-items:center;justify-content:center;font-size:24px;margin:0 auto 12px;">&#10003;</div>
      <p style="font-size:18px;font-weight:700;color:var(--text);">Import Complete</p>
      <p style="font-size:12px;color:var(--muted);margin-top:4px;" id="doneMessage"></p>
      <div class="stats" id="doneStats"></div>
      <button id="btnUploadAnother" class="primary" style="max-width:300px;margin:10px auto 0;">Upload Another File</button>
    </div>
  </section>

  <!-- SECTION 3: STORED RECORDS -->
  <section class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <h2>4) Stored Records</h2>
      <div style="display:flex;gap:8px;">
        <button id="btnRefresh" class="ghost" style="width:auto;padding:6px 14px;font-size:12px;">Refresh</button>
        <button id="btnClearAll" class="ghost" style="width:auto;padding:6px 14px;font-size:12px;color:var(--error);">Clear All</button>
      </div>
    </div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:10px;">
      All imported records stored in <code>localStorage</code>.
      <span id="recordCount" class="tag tag-accent" style="margin-left:6px;">0 records</span>
    </p>
    <ul id="recordsList" class="stored-records">
      <li style="color:var(--muted);font-style:italic;">No records yet. Upload a file above.</li>
    </ul>
  </section>

  <!-- SECTION 4: MANUAL ADD -->
  <section class="card">
    <h2>5) Add Record Manually</h2>
    <p style="margin-top:6px;">Quickly add a structured record without uploading a file.</p>
    <div class="row">
      <div>
        <label>Full Name</label>
        <input id="manualName" type="text" placeholder="Jane Doe" />
        <label>Email</label>
        <input id="manualEmail" type="email" placeholder="jane@example.com" />
        <label>Phone</label>
        <input id="manualPhone" type="tel" placeholder="555-0100" />
      </div>
      <div>
        <label>Organization</label>
        <input id="manualOrg" type="text" placeholder="Org name" />
        <label>Case Notes</label>
        <textarea id="manualNotes" placeholder="Notes about this record..."></textarea>
      </div>
    </div>
    <button id="btnManualAdd" class="primary" style="margin-top:10px;">Add Record</button>
  </section>
</main>

<script>
(() => {
  'use strict';

  const LS_RECORDS = 'khora-filen-test-records';

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const $id = (id) => document.getElementById(id);

  // ═══════════════════ TARGET FIELDS ═══════════════════
  const TARGET_FIELDS = [
    { key: 'full_name', label: 'Full Name', sensitive: true },
    { key: 'dob', label: 'Date of Birth', sensitive: true },
    { key: 'id_number', label: 'ID / SSN', sensitive: true },
    { key: 'email', label: 'Email', sensitive: true },
    { key: 'phone', label: 'Phone', sensitive: true },
    { key: 'address', label: 'Address', sensitive: true },
    { key: 'affiliation', label: 'Organization', sensitive: false },
    { key: 'case_notes', label: 'Case Notes', sensitive: true },
    { key: 'history', label: 'History', sensitive: false },
  ];

  // ═══════════════════ COLUMN AUTO-MAPPING ═══════════════════
  const COLUMN_ALIASES = {
    'name':'full_name','full_name':'full_name','fullname':'full_name',
    'client_name':'full_name','client name':'full_name',
    'first_name':'_first_name','last_name':'_last_name',
    'firstname':'_first_name','lastname':'_last_name',
    'first':'_first_name','last':'_last_name',
    'dob':'dob','date_of_birth':'dob','birthdate':'dob',
    'birth_date':'dob','birthday':'dob','date of birth':'dob',
    'ssn':'id_number','id':'id_number','id_number':'id_number',
    'social_security':'id_number','social':'id_number',
    'email':'email','email_address':'email','e-mail':'email','e_mail':'email',
    'phone':'phone','phone_number':'phone','mobile':'phone',
    'telephone':'phone','cell':'phone','tel':'phone',
    'address':'address','street_address':'address','home_address':'address',
    'street':'address','mailing_address':'address','addr':'address',
    'organization':'affiliation','affiliation':'affiliation',
    'org':'affiliation','agency':'affiliation','employer':'affiliation','company':'affiliation',
    'notes':'case_notes','case_notes':'case_notes','comments':'case_notes',
    'case notes':'case_notes','note':'case_notes',
    'history':'history','case_history':'history','case history':'history',
  };

  function autoMapColumns(headers) {
    const mapping = {};
    for (const h of headers) {
      const normalized = h.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
      const alias = COLUMN_ALIASES[normalized] || COLUMN_ALIASES[h.toLowerCase().trim()];
      if (alias) mapping[h] = alias;
    }
    return mapping;
  }

  // ═══════════════════ CSV PARSER ═══════════════════
  function parseCSV(text) {
    const lines = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      if (ch === '"') { inQuotes = !inQuotes; current += ch; }
      else if (ch === '\n' && !inQuotes) { lines.push(current); current = ''; }
      else if (ch === '\r' && !inQuotes) { /* skip CR */ }
      else { current += ch; }
    }
    if (current.trim()) lines.push(current);
    if (lines.length < 2) throw new Error('CSV must have a header row and at least one data row');

    function parseLine(line) {
      const fields = [];
      let field = '';
      let q = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (q && line[i + 1] === '"') { field += '"'; i++; }
          else { q = !q; }
        } else if (ch === ',' && !q) {
          fields.push(field.trim());
          field = '';
        } else {
          field += ch;
        }
      }
      fields.push(field.trim());
      return fields;
    }

    const headers = parseLine(lines[0]);
    const records = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const vals = parseLine(lines[i]);
      const record = {};
      headers.forEach((h, j) => {
        if (vals[j] !== undefined && vals[j] !== '') record[h] = vals[j];
      });
      records.push(record);
    }
    return { headers, records };
  }

  // ═══════════════════ JSON PARSER ═══════════════════
  function parseJSONImport(text) {
    const data = JSON.parse(text);
    const records = Array.isArray(data) ? data : (data.records || data.data || data.items || data.rows || []);
    if (!Array.isArray(records) || records.length === 0) {
      throw new Error('JSON must contain an array of record objects');
    }
    const headers = [...new Set(records.flatMap(r => Object.keys(r)))];
    return { headers, records };
  }

  // ═══════════════════ STATE ═══════════════════
  let fileData = null;
  let columnMapping = {};
  let currentStep = 'upload';

  // ═══════════════════ LOCALSTORAGE ═══════════════════
  function loadRecords() {
    try {
      const raw = localStorage.getItem(LS_RECORDS);
      const parsed = raw ? JSON.parse(raw) : [];
      return Array.isArray(parsed) ? parsed : [];
    } catch { return []; }
  }

  function saveRecords(records) {
    localStorage.setItem(LS_RECORDS, JSON.stringify(records));
  }

  // ═══════════════════ UI HELPERS ═══════════════════
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function truncate(str, len) {
    return str.length > len ? str.slice(0, len) + '\u2026' : str;
  }

  function setStep(step) {
    currentStep = step;
    const steps = ['upload', 'map', 'preview', 'done'];
    const idx = steps.indexOf(step);

    steps.forEach((s, i) => {
      $id(`step-${s}`).classList.toggle('hidden', s !== step);
      const dot = $id(`dot-${s}`);
      dot.classList.toggle('active', i === idx);
      dot.classList.toggle('done', i < idx);
    });
  }

  // ═══════════════════ DIAGNOSTICS ═══════════════════
  function runDiagnostics() {
    const container = $id('diagResults');
    container.innerHTML = '';

    const checks = [
      { name: 'File API', test: () => typeof File !== 'undefined' && typeof FileReader !== 'undefined' },
      { name: 'Drag & Drop', test: () => 'draggable' in document.createElement('div') },
      { name: 'localStorage', test: () => { localStorage.setItem('__test__', '1'); localStorage.removeItem('__test__'); return true; } },
      { name: 'TextEncoder', test: () => typeof TextEncoder !== 'undefined' },
      { name: 'JSON parsing', test: () => typeof JSON.parse === 'function' && typeof JSON.stringify === 'function' },
      { name: 'Blob / Download', test: () => typeof Blob !== 'undefined' && typeof URL.createObjectURL === 'function' },
    ];

    let allPassed = true;
    for (const check of checks) {
      let passed = false;
      try { passed = check.test(); } catch { passed = false; }
      if (!passed) allPassed = false;

      const item = document.createElement('div');
      item.className = 'diag-item';
      item.innerHTML = `
        <div class="diag-icon ${passed ? 'pass' : 'fail'}">${passed ? '\u2713' : '\u2717'}</div>
        <span>${check.name}</span>
        <span class="tag ${passed ? 'tag-ok' : 'tag-err'}" style="margin-left:auto;">${passed ? 'OK' : 'MISSING'}</span>
      `;
      container.appendChild(item);
    }

    // Summary
    const summary = document.createElement('div');
    summary.className = `hint ${allPassed ? 'green' : 'red'}`;
    summary.style.marginTop = '10px';
    summary.innerHTML = allPassed
      ? '<strong>All checks passed.</strong> This browser supports everything needed.'
      : '<strong>Some checks failed.</strong> The import tool may not work correctly in this browser.';
    container.appendChild(summary);
  }

  // ═══════════════════ STORAGE STATUS ═══════════════════
  function updateStorageStatus() {
    const records = loadRecords();
    const pill = $id('sessionPill');
    pill.textContent = `${records.length} stored`;
    pill.classList.toggle('ok', records.length > 0);

    const batches = new Set(records.filter(r => r.batch).map(r => r.batch));
    const sources = new Set(records.filter(r => r.source).map(r => r.source));
    const storageBytes = new Blob([localStorage.getItem(LS_RECORDS) || '']).size;
    const storageKB = (storageBytes / 1024).toFixed(1);

    $id('storageStats').innerHTML = `
      <div class="stat">
        <span class="stat-label">Records</span>
        <span class="stat-value">${records.length}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Batches</span>
        <span class="stat-value" style="color:var(--accent);">${batches.size}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Sources</span>
        <span class="stat-value" style="color:var(--teal);">${sources.size}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Size</span>
        <span class="stat-value" style="font-size:1rem;color:var(--muted);">${storageKB} KB</span>
      </div>
    `;

    // Enable/disable export buttons
    $id('btnExportJSON').disabled = records.length === 0;
    $id('btnExportCSV').disabled = records.length === 0;
  }

  // ═══════════════════ EXPORT ═══════════════════
  function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportAsJSON() {
    const records = loadRecords();
    if (records.length === 0) return;
    const output = records.map(r => {
      if (r.fields) return { ...r.fields, _meta: { source: r.source, batch: r.batch, createdAt: r.createdAt } };
      if (r.text) return { text: r.text, _meta: { source: r.source, createdAt: r.createdAt } };
      return r;
    });
    downloadFile(JSON.stringify(output, null, 2), `khora-export-${Date.now()}.json`, 'application/json');
  }

  function exportAsCSV() {
    const records = loadRecords();
    if (records.length === 0) return;

    // Collect all field keys
    const allKeys = new Set();
    for (const r of records) {
      if (r.fields) Object.keys(r.fields).forEach(k => allKeys.add(k));
      if (r.text) allKeys.add('text');
    }
    allKeys.add('source');
    allKeys.add('batch');
    allKeys.add('createdAt');

    const keys = [...allKeys];

    function csvEscape(val) {
      if (val == null) return '';
      const s = String(val);
      if (s.includes(',') || s.includes('"') || s.includes('\n')) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }

    const lines = [keys.map(csvEscape).join(',')];
    for (const r of records) {
      const row = keys.map(k => {
        if (k === 'source') return csvEscape(r.source || '');
        if (k === 'batch') return csvEscape(r.batch || '');
        if (k === 'createdAt') return csvEscape(r.createdAt || '');
        if (k === 'text') return csvEscape(r.text || '');
        if (r.fields) return csvEscape(r.fields[k] || '');
        return '';
      });
      lines.push(row.join(','));
    }

    downloadFile(lines.join('\n'), `khora-export-${Date.now()}.csv`, 'text/csv');
  }

  // ═══════════════════ RENDER STORED RECORDS ═══════════════════
  function renderStoredRecords() {
    const records = loadRecords();
    const list = $id('recordsList');
    const countTag = $id('recordCount');
    countTag.textContent = `${records.length} record${records.length !== 1 ? 's' : ''}`;

    list.innerHTML = '';
    if (records.length === 0) {
      list.innerHTML = '<li style="color:var(--muted);font-style:italic;">No records yet. Upload a file above.</li>';
      updateStorageStatus();
      return;
    }

    // Show most recent first, max 50 visible
    const visible = records.slice().reverse().slice(0, 50);
    visible.forEach((rec, i) => {
      const li = document.createElement('li');
      const idx = document.createElement('div');
      idx.className = 'rec-index';
      idx.textContent = `#${records.length - i}`;

      const body = document.createElement('div');
      body.className = 'rec-fields';

      if (rec.fields && typeof rec.fields === 'object') {
        for (const [k, v] of Object.entries(rec.fields)) {
          const span = document.createElement('span');
          span.className = 'rec-field';
          const tf = TARGET_FIELDS.find(f => f.key === k);
          span.innerHTML = `<span class="key">${escapeHtml(tf ? tf.label : k)}:</span> <span class="val">${escapeHtml(truncate(String(v), 50))}</span>`;
          body.appendChild(span);
        }
      } else if (rec.text) {
        const span = document.createElement('span');
        span.className = 'rec-field';
        span.innerHTML = `<span class="val">${escapeHtml(truncate(rec.text, 80))}</span>`;
        body.appendChild(span);
      }

      const meta = document.createElement('div');
      meta.className = 'rec-meta';
      const parts = [];
      if (rec.createdAt) parts.push(new Date(rec.createdAt).toLocaleString());
      if (rec.source) parts.push(`source: ${rec.source}`);
      if (rec.batch) parts.push(`batch: ${rec.batch}`);
      meta.textContent = parts.join(' \u00b7 ');
      body.appendChild(meta);

      li.appendChild(idx);
      li.appendChild(body);
      list.appendChild(li);
    });

    if (records.length > 50) {
      const li = document.createElement('li');
      li.style.color = 'var(--muted)';
      li.style.fontStyle = 'italic';
      li.textContent = `\u2026and ${records.length - 50} more records`;
      list.appendChild(li);
    }

    updateStorageStatus();
  }

  // ═══════════════════ HANDLE FILE ═══════════════════
  async function handleFile(file) {
    try {
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext !== 'csv' && ext !== 'json') {
        alert('Unsupported file type. Please upload a .csv or .json file.');
        return;
      }

      const text = await file.text();
      if (!text.trim()) throw new Error('File is empty');

      const isJSON = ext === 'json' || file.type === 'application/json';
      const parsed = isJSON ? parseJSONImport(text) : parseCSV(text);
      if (parsed.records.length === 0) throw new Error('No records found in file');

      fileData = {
        ...parsed,
        fileName: file.name,
        fileType: isJSON ? 'JSON' : 'CSV',
      };

      columnMapping = autoMapColumns(parsed.headers);
      renderMappingStep();
      setStep('map');
    } catch (e) {
      alert('Parse error: ' + e.message);
    }
  }

  // ═══════════════════ MAPPING STEP ═══════════════════
  function renderMappingStep() {
    if (!fileData) return;

    $id('mapFileName').textContent = fileData.fileName;
    $id('mapFileMeta').textContent = `${fileData.fileType} \u00b7 ${fileData.records.length} records \u00b7 ${fileData.headers.length} columns`;

    const container = $id('mappingContainer');
    container.innerHTML = '';

    for (const header of fileData.headers) {
      const row = document.createElement('div');
      row.className = 'map-row';

      const source = document.createElement('div');
      source.className = 'source';
      const sourceName = document.createElement('div');
      sourceName.className = 'source-name';
      sourceName.textContent = header;
      source.appendChild(sourceName);

      const sampleVal = fileData.records.slice(0, 3).map(r => r[header]).filter(Boolean)[0];
      if (sampleVal) {
        const sample = document.createElement('div');
        sample.className = 'sample';
        sample.textContent = 'e.g. ' + truncate(String(sampleVal), 40);
        source.appendChild(sample);
      }

      const arrow = document.createElement('div');
      arrow.className = 'arrow';
      arrow.textContent = '\u2192';

      const target = document.createElement('div');
      target.className = 'target';
      const sel = document.createElement('select');
      sel.dataset.source = header;

      const skipOpt = document.createElement('option');
      skipOpt.value = '';
      skipOpt.textContent = '\u2014 skip \u2014';
      sel.appendChild(skipOpt);

      for (const tf of TARGET_FIELDS) {
        const opt = document.createElement('option');
        opt.value = tf.key;
        opt.textContent = tf.label + (tf.sensitive ? ' \ud83d\udd12' : '');
        sel.appendChild(opt);
      }

      const fnOpt = document.createElement('option');
      fnOpt.value = '_first_name';
      fnOpt.textContent = 'First Name (will combine)';
      sel.appendChild(fnOpt);
      const lnOpt = document.createElement('option');
      lnOpt.value = '_last_name';
      lnOpt.textContent = 'Last Name (will combine)';
      sel.appendChild(lnOpt);

      sel.value = columnMapping[header] || '';

      sel.addEventListener('change', () => {
        if (sel.value) {
          columnMapping[header] = sel.value;
        } else {
          delete columnMapping[header];
        }
        updateMappingStats();
      });

      target.appendChild(sel);
      row.appendChild(source);
      row.appendChild(arrow);
      row.appendChild(target);
      container.appendChild(row);
    }

    updateMappingStats();
  }

  function getMappedFieldCount() {
    return Object.values(columnMapping).filter(v => v && !v.startsWith('_')).length;
  }

  function updateMappingStats() {
    const mapped = getMappedFieldCount();
    const total = fileData ? fileData.headers.length : 0;
    const hasFirstLast = Object.values(columnMapping).includes('_first_name') && Object.values(columnMapping).includes('_last_name');

    $id('mapStats').innerHTML = `
      <div class="stat">
        <span class="stat-label">Mapped</span>
        <span class="stat-value" style="color:var(--accent);">${mapped}${hasFirstLast ? '+1' : ''}</span>
        <span style="font-size:11px;color:var(--muted);"> of ${total}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Skipped</span>
        <span class="stat-value" style="color:var(--muted);">${total - Object.keys(columnMapping).length}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Sensitive</span>
        <span class="stat-value" style="color:var(--teal);">${
          Object.values(columnMapping)
            .filter(v => v && !v.startsWith('_'))
            .filter(v => TARGET_FIELDS.find(f => f.key === v)?.sensitive).length
        }</span>
      </div>
    `;

    const btn = $id('btnToPreview');
    const hasMapped = mapped > 0 || hasFirstLast;
    btn.disabled = !hasMapped;
    btn.textContent = hasMapped
      ? `Preview ${fileData.records.length} Records`
      : 'Map at least one column';
  }

  // ═══════════════════ PREVIEW STEP ═══════════════════
  function renderPreviewStep() {
    if (!fileData) return;

    const activeMappings = Object.entries(columnMapping).filter(([, v]) => v && !v.startsWith('_'));
    const firstNameCol = Object.entries(columnMapping).find(([, v]) => v === '_first_name')?.[0];
    const lastNameCol = Object.entries(columnMapping).find(([, v]) => v === '_last_name')?.[0];
    const hasNameCombine = firstNameCol && lastNameCol;

    const thead = $id('previewHead');
    thead.innerHTML = '';
    const headerRow = document.createElement('tr');

    const thIdx = document.createElement('th');
    thIdx.textContent = '#';
    headerRow.appendChild(thIdx);

    if (hasNameCombine) {
      const th = document.createElement('th');
      th.textContent = 'Full Name';
      headerRow.appendChild(th);
    }

    for (const [, vaultKey] of activeMappings) {
      const tf = TARGET_FIELDS.find(f => f.key === vaultKey);
      const th = document.createElement('th');
      th.textContent = tf ? tf.label : vaultKey;
      headerRow.appendChild(th);
    }
    thead.appendChild(headerRow);

    const tbody = $id('previewBody');
    tbody.innerHTML = '';
    const previewRows = fileData.records.slice(0, 10);

    previewRows.forEach((row, i) => {
      const tr = document.createElement('tr');

      const tdIdx = document.createElement('td');
      tdIdx.style.color = 'var(--muted)';
      tdIdx.style.fontFamily = 'monospace';
      tdIdx.style.fontSize = '0.75rem';
      tdIdx.textContent = i + 1;
      tr.appendChild(tdIdx);

      if (hasNameCombine) {
        const td = document.createElement('td');
        const first = (row[firstNameCol] || '').trim();
        const last = (row[lastNameCol] || '').trim();
        td.textContent = [first, last].filter(Boolean).join(' ') || '\u2014';
        tr.appendChild(td);
      }

      for (const [srcCol] of activeMappings) {
        const td = document.createElement('td');
        const val = row[srcCol];
        td.textContent = val != null ? truncate(String(val), 50) : '\u2014';
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });

    const moreEl = $id('previewMore');
    if (fileData.records.length > 10) {
      moreEl.textContent = `\u2026and ${fileData.records.length - 10} more records`;
    } else {
      moreEl.textContent = '';
    }

    const totalMapped = activeMappings.length + (hasNameCombine ? 1 : 0);
    $id('previewStats').innerHTML = `
      <div class="stat">
        <span class="stat-label">Records</span>
        <span class="stat-value">${fileData.records.length}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Fields / Row</span>
        <span class="stat-value" style="color:var(--accent);">${totalMapped}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Total Fields</span>
        <span class="stat-value" style="color:var(--ok);">${fileData.records.length * totalMapped}</span>
      </div>
    `;

    $id('btnImport').textContent = `Import ${fileData.records.length} Records`;
  }

  // ═══════════════════ IMPORT ═══════════════════
  function doImport() {
    if (!fileData) return;

    const activeMappings = Object.entries(columnMapping).filter(([, v]) => v && !v.startsWith('_'));
    const firstNameCol = Object.entries(columnMapping).find(([, v]) => v === '_first_name')?.[0];
    const lastNameCol = Object.entries(columnMapping).find(([, v]) => v === '_last_name')?.[0];
    const hasNameCombine = firstNameCol && lastNameCol;

    const batchId = `batch_${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6)}`;
    const existingRecords = loadRecords();
    let imported = 0;
    let skipped = 0;

    for (const row of fileData.records) {
      const fields = {};

      for (const [srcCol, vaultKey] of activeMappings) {
        const val = row[srcCol];
        if (val != null && String(val).trim() !== '') {
          fields[vaultKey] = String(val).trim();
        }
      }

      if (hasNameCombine) {
        const first = (row[firstNameCol] || '').trim();
        const last = (row[lastNameCol] || '').trim();
        const combined = [first, last].filter(Boolean).join(' ');
        if (combined) fields['full_name'] = combined;
      }

      if (Object.keys(fields).length === 0) {
        skipped++;
        continue;
      }

      existingRecords.push({
        fields,
        createdAt: new Date().toISOString(),
        source: fileData.fileName,
        batch: batchId,
        fileType: fileData.fileType,
      });
      imported++;
    }

    saveRecords(existingRecords);

    $id('doneMessage').textContent = `${imported} records imported from ${fileData.fileName}${skipped > 0 ? ` \u00b7 ${skipped} skipped (no data)` : ''}`;
    $id('doneStats').innerHTML = `
      <div class="stat">
        <span class="stat-label">Imported</span>
        <span class="stat-value" style="color:var(--ok);">${imported}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Skipped</span>
        <span class="stat-value" style="color:${skipped > 0 ? 'var(--error)' : 'var(--muted)'};">${skipped}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Batch</span>
        <span class="stat-value" style="font-size:0.75rem;color:var(--muted);">${batchId.slice(-8)}</span>
      </div>
    `;

    setStep('done');
    renderStoredRecords();
  }

  // ═══════════════════ RESET UPLOAD ═══════════════════
  function resetUpload() {
    fileData = null;
    columnMapping = {};
    $id('fileInput').value = '';
    setStep('upload');
  }

  // ═══════════════════ EVENT LISTENERS ═══════════════════

  // Diagnostics
  $id('btnCheckApis').addEventListener('click', runDiagnostics);

  // Export
  $id('btnExportJSON').addEventListener('click', exportAsJSON);
  $id('btnExportCSV').addEventListener('click', exportAsCSV);

  // Drop zone
  const dropzone = $id('dropzone');
  const fileInput = $id('fileInput');

  dropzone.addEventListener('click', () => fileInput.click());
  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('active');
  });
  dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('active');
  });
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('active');
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  });

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (file) handleFile(file);
  });

  // Mapping step buttons
  $id('btnChangeFile').addEventListener('click', resetUpload);
  $id('btnBackToUpload').addEventListener('click', resetUpload);

  $id('btnToPreview').addEventListener('click', () => {
    renderPreviewStep();
    setStep('preview');
  });

  // Preview step buttons
  $id('btnBackToMap').addEventListener('click', () => {
    setStep('map');
  });

  $id('btnImport').addEventListener('click', doImport);

  // Done step
  $id('btnUploadAnother').addEventListener('click', resetUpload);

  // Stored records
  $id('btnRefresh').addEventListener('click', renderStoredRecords);
  $id('btnClearAll').addEventListener('click', () => {
    if (confirm('Clear all stored records?')) {
      localStorage.removeItem(LS_RECORDS);
      renderStoredRecords();
    }
  });

  // Manual add — structured fields
  $id('btnManualAdd').addEventListener('click', () => {
    const name = $id('manualName').value.trim();
    const email = $id('manualEmail').value.trim();
    const phone = $id('manualPhone').value.trim();
    const org = $id('manualOrg').value.trim();
    const notes = $id('manualNotes').value.trim();

    const fields = {};
    if (name) fields.full_name = name;
    if (email) fields.email = email;
    if (phone) fields.phone = phone;
    if (org) fields.affiliation = org;
    if (notes) fields.case_notes = notes;

    if (Object.keys(fields).length === 0) {
      alert('Please fill in at least one field.');
      return;
    }

    const records = loadRecords();
    records.push({
      fields,
      createdAt: new Date().toISOString(),
      source: 'manual',
    });
    saveRecords(records);

    // Clear form
    $id('manualName').value = '';
    $id('manualEmail').value = '';
    $id('manualPhone').value = '';
    $id('manualOrg').value = '';
    $id('manualNotes').value = '';

    renderStoredRecords();
  });

  // ═══════════════════ INIT ═══════════════════
  renderStoredRecords();
  updateStorageStatus();
  setStep('upload');
})();
</script>
</body>
</html>
