<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khora â€” Sovereign Case Management</title>
<script src="https://cdn.jsdelivr.net/npm/matrix-js-sdk@34.11.1/lib/browser-matrix.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&family=Source+Serif+4:wght@300;400;500;600;700&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-0:#08090b;--bg-1:#0e1015;--bg-2:#141720;--bg-3:#1a1e29;--bg-4:#222735;
  --border-0:#1e2230;--border-1:#2a3040;--border-2:#353d50;
  --tx-0:#e6e9f0;--tx-1:#a0a8b8;--tx-2:#6b7385;--tx-3:#454d5f;
  --gold:#c9a352;--gold-dim:rgba(201,163,82,0.10);--gold-mid:rgba(201,163,82,0.22);
  --green:#3dd68c;--green-dim:rgba(61,214,140,0.10);
  --red:#e85d5d;--red-dim:rgba(232,93,93,0.10);
  --blue:#5b9cf5;--blue-dim:rgba(91,156,245,0.10);
  --teal:#3ec9b0;--teal-dim:rgba(62,201,176,0.10);
  --orange:#e0943a;--orange-dim:rgba(224,148,58,0.10);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,0.10);
  --serif:'Source Serif 4',Georgia,serif;--sans:'Manrope',system-ui,sans-serif;--mono:'IBM Plex Mono',monospace;
  --r:5px;--r-lg:8px;
}
/* â•â•â• Light theme â€” WCAG AA accessible (4.5:1+ text contrast) â•â•â• */
html.light {
  --bg-0:#f5f5f7;--bg-1:#ebedf0;--bg-2:#e0e2e7;--bg-3:#d4d7dd;--bg-4:#c8ccd4;
  --border-0:#cdd0d7;--border-1:#b8bcc6;--border-2:#a0a5b2;
  --tx-0:#1a1c20;--tx-1:#3d4250;--tx-2:#5a6073;--tx-3:#7e8498;
  --gold:#8a6d1e;--gold-dim:rgba(138,109,30,0.10);--gold-mid:rgba(138,109,30,0.18);
  --green:#177a4a;--green-dim:rgba(23,122,74,0.10);
  --red:#c03030;--red-dim:rgba(192,48,48,0.10);
  --blue:#2563b0;--blue-dim:rgba(37,99,176,0.10);
  --teal:#137a6a;--teal-dim:rgba(19,122,106,0.10);
  --orange:#a0600a;--orange-dim:rgba(160,96,10,0.10);
  --purple:#6938c0;--purple-dim:rgba(105,56,192,0.10);
}
html.light .b-pri:hover{box-shadow:0 4px 16px rgba(138,109,30,0.18)}
html.light .b-red{border-color:rgba(192,48,48,.22)}
html.light .b-grn{border-color:rgba(23,122,74,.22)}
html.light .toggle-knob{box-shadow:0 1px 3px rgba(0,0,0,.15);border:1px solid var(--border-1)}
html.light ::-webkit-scrollbar-thumb{background:var(--border-2)}
html.light .grid-bg{background-image:radial-gradient(circle at 20% 20%,rgba(138,109,30,.05) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(37,99,176,.04) 0%,transparent 50%),linear-gradient(var(--border-0) 1px,transparent 1px),linear-gradient(90deg,var(--border-0) 1px,transparent 1px);}
html.light .gm-crossing{background:linear-gradient(135deg,rgba(19,122,106,.10) 0%,rgba(138,109,30,.10) 100%);border-left-color:rgba(19,122,106,.25);border-right-color:rgba(138,109,30,.25)}
html.light .gm-crossing::before{background:repeating-linear-gradient(180deg,transparent,transparent 8px,rgba(138,109,30,.06) 8px,rgba(138,109,30,.06) 16px)}
html.light .gm-divergence{background:rgba(138,109,30,.08)}
html.light .gm-obs-field{background:var(--teal-dim);border-color:rgba(19,122,106,.20)}
*{margin:0;padding:0;box-sizing:border-box;}
html,body,#root{height:100%;background:var(--bg-0);color:var(--tx-0);font-family:var(--sans);}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border-1);border-radius:3px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideR{from{opacity:0;transform:translateX(-14px)}to{opacity:1;transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.anim-up{animation:fadeUp .3s ease both}.anim-in{animation:fadeIn .25s ease both}.anim-sl{animation:slideR .28s ease both}
input,textarea,select{font-family:var(--sans);background:var(--bg-1);border:1px solid var(--border-1);color:var(--tx-0);padding:11px 15px;border-radius:var(--r);font-size:14.5px;outline:none;transition:border .2s,box-shadow .2s;width:100%;}
input:focus,textarea:focus,select:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-dim)}
input::placeholder,textarea::placeholder{color:var(--tx-3)}textarea{resize:vertical;min-height:72px;line-height:1.55}
button{font-family:var(--sans);cursor:pointer;border:none;border-radius:var(--r);font-size:13.5px;font-weight:600;padding:9px 18px;transition:all .18s;letter-spacing:.01em;}
.b-pri{background:var(--gold);color:var(--bg-0)}.b-pri:hover{filter:brightness(1.12);transform:translateY(-1px);box-shadow:0 4px 16px var(--gold-dim)}.b-pri:disabled{opacity:.5;transform:none;cursor:default;filter:none}
.b-gho{background:transparent;color:var(--tx-1);border:1px solid var(--border-1)}.b-gho:hover{background:var(--bg-3);color:var(--tx-0);border-color:var(--border-2)}
.b-red{background:var(--red-dim);color:var(--red);border:1px solid rgba(232,93,93,.18)}.b-red:hover{background:rgba(232,93,93,.18)}
.b-grn{background:var(--green-dim);color:var(--green);border:1px solid rgba(61,214,140,.18)}
.b-sm{padding:7px 14px;font-size:12.5px}.b-xs{padding:5px 10px;font-size:12px}
.tag{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:12px;font-weight:600;font-family:var(--mono);letter-spacing:.03em}
.tag-gold{background:var(--gold-dim);color:var(--gold)}.tag-green{background:var(--green-dim);color:var(--green)}
.tag-red{background:var(--red-dim);color:var(--red)}.tag-blue{background:var(--blue-dim);color:var(--blue)}
.tag-teal{background:var(--teal-dim);color:var(--teal)}.tag-orange{background:var(--orange-dim);color:var(--orange)}
.tag-purple{background:var(--purple-dim);color:var(--purple)}
.card{background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r-lg);padding:20px}
.card-h{background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r-lg);padding:20px;transition:border-color .2s,transform .2s;cursor:pointer}
.card-h:hover{border-color:var(--gold);transform:translateY(-2px)}
.section-label{font-size:12px;font-family:var(--mono);color:var(--tx-1);letter-spacing:.07em;font-weight:500;margin-bottom:12px;display:block}
.toggle-track{width:38px;height:20px;border-radius:10px;position:relative;cursor:pointer;transition:background .2s}
.toggle-track.on{background:var(--green)}.toggle-track.off{background:var(--border-1)}
.toggle-knob{width:16px;height:16px;border-radius:50%;background:#fff;position:absolute;top:2px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.toggle-track.on .toggle-knob{left:20px}.toggle-track.off .toggle-knob{left:2px}
.grid-bg{background-image:radial-gradient(circle at 20% 20%,rgba(201,163,82,.03) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(91,156,245,.02) 0%,transparent 50%),linear-gradient(var(--border-0) 1px,transparent 1px),linear-gradient(90deg,var(--border-0) 1px,transparent 1px);background-size:100% 100%,100% 100%,48px 48px,48px 48px;}
.tabs{display:flex;gap:2px;background:var(--bg-1);border-radius:var(--r);padding:3px;margin-bottom:20px}
.tab{padding:9px 18px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;color:var(--tx-1);background:transparent}
.tab.active{background:var(--bg-3);color:var(--tx-0);font-weight:600}
.tab:hover:not(.active){background:var(--bg-2);color:var(--tx-1)}

/* â•â•â• Inbox Responsive Styles â•â•â• */
.inbox-wrap{margin:0 auto;width:100%}
.inbox-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;gap:12px}
.inbox-panel{display:flex;gap:0;border:1px solid var(--border-0);border-radius:var(--r-lg);overflow:hidden;background:var(--bg-1);height:calc(100vh - 200px);min-height:520px;max-height:900px}
.inbox-list{width:300px;min-width:300px;border-right:1px solid var(--border-0);display:flex;flex-direction:column;background:var(--bg-2)}
.inbox-chat{flex:1;display:flex;flex-direction:column;background:var(--bg-1);min-width:0}
.inbox-msgs{flex:1;overflow:auto;padding:20px 24px;display:flex;flex-direction:column;gap:2px}
.inbox-compose{padding:14px 20px;border-top:1px solid var(--border-0);background:var(--bg-2)}
.inbox-chat-hdr{padding:16px 20px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;gap:12px;background:var(--bg-2)}

@media(max-width:1100px){
  .inbox-list{width:260px;min-width:260px}
}
@media(max-width:900px){
  .inbox-header{flex-direction:column;gap:8px}
  .inbox-panel{flex-direction:column;height:auto;max-height:none}
  .inbox-list{width:100%;min-width:100%;border-right:none;border-bottom:1px solid var(--border-0);max-height:260px}
  .inbox-chat{min-height:420px}
  .inbox-msgs{padding:14px 16px}
  .inbox-compose{padding:12px 14px}
  .inbox-chat-hdr{padding:12px 14px}
}
@media(max-width:700px){
  .app-sidebar{width:56px!important;min-width:56px!important;overflow:hidden}
  .app-sidebar .sidebar-label,.app-sidebar .sidebar-detail,.app-sidebar .sidebar-identity,.app-sidebar .sidebar-section{display:none}
  .app-sidebar .sidebar-icon{margin:0 auto}
  .app-main{padding:14px!important}
  .inbox-list{max-height:200px}
}

/* â•â•â• GIVEN/MEANT Divide Visualization â•â•â• */
@keyframes crossingPulse{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes flowRight{from{background-position:0 0}to{background-position:20px 0}}
.gm-container{display:flex;gap:0;border-radius:var(--r-lg);overflow:hidden;border:1px solid var(--border-0);background:var(--bg-1);min-height:200px}
.gm-given{flex:0 0 340px;min-width:280px;background:var(--bg-2);padding:20px;border-right:none;position:relative}
.gm-given::after{content:'';position:absolute;top:0;right:0;bottom:0;width:2px;background:var(--teal);opacity:.3}
.gm-crossing{flex:0 0 56px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
  background:linear-gradient(135deg,rgba(62,201,176,.08) 0%,rgba(201,163,82,.08) 100%);
  border-left:1px solid rgba(62,201,176,.2);border-right:1px solid rgba(201,163,82,.2);position:relative;padding:12px 4px}
.gm-crossing::before{content:'';position:absolute;top:0;bottom:0;left:0;right:0;
  background:repeating-linear-gradient(180deg,transparent,transparent 8px,rgba(201,163,82,.04) 8px,rgba(201,163,82,.04) 16px);pointer-events:none}
.gm-crossing-arrow{width:24px;height:24px;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--teal),var(--gold));border-radius:50%;color:var(--bg-0);font-size:11px;font-weight:800;flex-shrink:0}
.gm-crossing-label{writing-mode:vertical-rl;text-orientation:mixed;font-family:var(--mono);font-size:10px;
  font-weight:600;letter-spacing:.1em;background:linear-gradient(180deg,var(--teal),var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.gm-crossing-op{padding:3px 6px;border-radius:8px;font-size:10px;font-family:var(--mono);font-weight:700;
  background:var(--bg-3);color:var(--tx-1);border:1px solid var(--border-1);flex-shrink:0}
.gm-meant{flex:1;min-width:0;background:var(--bg-1);padding:20px;display:flex;flex-direction:column;gap:10px;position:relative}
.gm-meant::before{content:'';position:absolute;top:0;left:0;bottom:0;width:2px;background:var(--gold);opacity:.3}
.gm-fw-card{border:1px solid var(--border-1);border-radius:var(--r);padding:14px;background:var(--bg-2);
  transition:border-color .2s,transform .15s;position:relative;overflow:hidden}
.gm-fw-card:hover{border-color:var(--gold);transform:translateX(2px)}
.gm-fw-card::before{content:'';position:absolute;top:0;left:0;bottom:0;width:3px}
.gm-fw-card[data-accent="blue"]::before{background:var(--blue)}
.gm-fw-card[data-accent="teal"]::before{background:var(--teal)}
.gm-fw-card[data-accent="orange"]::before{background:var(--orange)}
.gm-fw-card[data-accent="green"]::before{background:var(--green)}
.gm-fw-card[data-accent="purple"]::before{background:var(--purple)}
.gm-divergence{background:rgba(201,163,82,.06);border:1px dashed var(--gold);border-radius:var(--r);padding:10px 14px;
  display:flex;align-items:flex-start;gap:10px;font-size:13px;color:var(--tx-1)}
.gm-obs-field{font-family:var(--mono);font-size:14px;font-weight:500;color:var(--teal);padding:10px 14px;
  background:var(--teal-dim);border:1px solid rgba(62,201,176,.15);border-radius:var(--r)}
.gm-obs-value{font-size:16px;font-weight:600;color:var(--tx-0);margin:10px 0}
.gm-meta-row{display:flex;gap:14px;font-size:12px;color:var(--tx-1);font-family:var(--mono)}
.gm-eo-trace{font-family:var(--mono);font-size:11px;color:var(--purple);padding:5px 10px;background:var(--purple-dim);
  border-radius:var(--r);display:inline-block;margin-top:8px}
.gm-chain{display:flex;gap:3px;align-items:center;flex-wrap:wrap;margin-top:6px}
.gm-chain-step{padding:2px 7px;border-radius:6px;font-size:10px;font-family:var(--mono);font-weight:600}
.gm-wb-left{flex:0 0 340px;min-width:280px;overflow:auto;border-right:1px solid var(--border-0);padding:16px}
.gm-wb-right{flex:1;min-width:0;overflow:auto;padding:16px}
.gm-wb-field{padding:10px 12px;border-radius:var(--r);cursor:pointer;border:1px solid var(--border-0);
  margin-bottom:4px;transition:all .15s}
.gm-wb-field:hover{border-color:var(--teal);background:var(--teal-dim)}
.gm-wb-field.active{border-color:var(--teal);background:var(--teal-dim);border-left:3px solid var(--teal)}
.gm-wb-empty{padding:40px 20px;text-align:center;border:1px dashed var(--border-1);border-radius:var(--r);color:var(--tx-3)}
.gm-sankey-line{position:absolute;pointer-events:none}
.gm-sup-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:10px;
  font-size:11px;font-family:var(--mono);font-weight:600;background:var(--gold-dim);color:var(--gold);border:1px solid rgba(201,163,82,.2)}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo} = React;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ICONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const I = ({n,s=17,c})=>{
const p = {width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:c||"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"};
const d={
lock:<svg {...p}><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
unlock:<svg {...p}><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
shield:<svg {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
shieldCheck:<svg {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg>,
users:<svg {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
user:<svg {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
briefcase:<svg {...p}><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
plus:<svg {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
x:<svg {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
check:<svg {...p}><polyline points="20 6 9 17 4 12"/></svg>,
search:<svg {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
share:<svg {...p}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
key:<svg {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
eye:<svg {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
eyeOff:<svg {...p}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
send:<svg {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
trash:<svg {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
file:<svg {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>,
folder:<svg {...p}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
home:<svg {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
back:<svg {...p}><polyline points="15 18 9 12 15 6"/></svg>,
chevR:<svg {...p}><polyline points="9 18 15 12 9 6"/></svg>,
logout:<svg {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
settings:<svg {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
alert:<svg {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
clock:<svg {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
msg:<svg {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
inbox:<svg {...p}><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>,
zap:<svg {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
grid:<svg {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
globe:<svg {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
bar:<svg {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
clipboard:<svg {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>,
link:<svg {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
copy:<svg {...p}><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
userPlus:<svg {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
upload:<svg {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
download:<svg {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
sun:<svg {...p}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
moon:<svg {...p}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
'alert-triangle':<svg {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
'refresh-cw':<svg {...p}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
};
return <span style={{display:'inline-flex',alignItems:'center',flexShrink:0}}>{d[n]}</span>;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• THEME SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const getInitialTheme = () => {
  const stored = localStorage.getItem('khora-theme');
  if (stored === 'light' || stored === 'dark') return stored;
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
};

// Apply theme immediately to avoid flash
(() => {
  const t = getInitialTheme();
  if (t === 'light') document.documentElement.classList.add('light');
})();

const ThemeContext = React.createContext({theme:'dark', toggle:()=>{}});

const ThemeProvider = ({children}) => {
  const [theme, setTheme] = useState(getInitialTheme);
  useEffect(() => {
    document.documentElement.classList.toggle('light', theme === 'light');
    localStorage.setItem('khora-theme', theme);
  }, [theme]);
  useEffect(() => {
    const mq = window.matchMedia('(prefers-color-scheme: light)');
    const handler = (e) => {
      if (!localStorage.getItem('khora-theme')) setTheme(e.matches ? 'light' : 'dark');
    };
    mq.addEventListener('change', handler);
    return () => mq.removeEventListener('change', handler);
  }, []);
  const toggle = useCallback(() => setTheme(t => t === 'dark' ? 'light' : 'dark'), []);
  return <ThemeContext.Provider value={{theme, toggle}}>{children}</ThemeContext.Provider>;
};

const useTheme = () => React.useContext(ThemeContext);

const ThemeToggle = ({style:sx}) => {
  const {theme, toggle} = useTheme();
  const isDark = theme === 'dark';
  return <button onClick={toggle} aria-label={isDark ? 'Switch to light mode' : 'Switch to dark mode'}
    title={isDark ? 'Switch to light mode' : 'Switch to dark mode'}
    style={{background:'var(--bg-3)',border:'1px solid var(--border-1)',borderRadius:'var(--r)',
      padding:'6px 8px',cursor:'pointer',display:'inline-flex',alignItems:'center',gap:6,
      color:'var(--tx-1)',fontSize:11,fontFamily:'var(--sans)',fontWeight:500,
      transition:'all .18s',...sx}}
    onMouseEnter={e=>{e.currentTarget.style.borderColor='var(--gold)';e.currentTarget.style.color='var(--tx-0)'}}
    onMouseLeave={e=>{e.currentTarget.style.borderColor='var(--border-1)';e.currentTarget.style.color='var(--tx-1)'}}>
    <I n={isDark?'moon':'sun'} s={14}/>{isDark?'Dark':'Light'}
  </button>;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PER-FIELD CRYPTO (AES-256-GCM) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FieldCrypto = {
  async generateKey() {
    const key = await crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);
    const raw = await crypto.subtle.exportKey('raw', key);
    return btoa(String.fromCharCode(...new Uint8Array(raw)));
  },
  async encrypt(plaintext, keyB64) {
    const keyBuf = Uint8Array.from(atob(keyB64), c => c.charCodeAt(0));
    const key = await crypto.subtle.importKey('raw', keyBuf, 'AES-GCM', false, ['encrypt']);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const enc = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(plaintext));
    return { ciphertext: btoa(String.fromCharCode(...new Uint8Array(enc))), iv: btoa(String.fromCharCode(...iv)) };
  },
  async decrypt(cipherB64, ivB64, keyB64) {
    try {
      const keyBuf = Uint8Array.from(atob(keyB64), c => c.charCodeAt(0));
      const key = await crypto.subtle.importKey('raw', keyBuf, 'AES-GCM', false, ['decrypt']);
      const iv = Uint8Array.from(atob(ivB64), c => c.charCodeAt(0));
      const ct = Uint8Array.from(atob(cipherB64), c => c.charCodeAt(0));
      const dec = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      return new TextDecoder().decode(dec);
    } catch { return null; }
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOCAL VAULT CRYPTO (IndexedDB at-rest encryption) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Derives a per-user AES-256-GCM key from the Matrix session using HKDF.
 * All local IndexedDB data is encrypted with this key so that only the
 * authenticated user who synced the data can read it at rest. The key is
 * held in memory only â€” destroyed on logout or tab close. */
const LocalVaultCrypto = {
  _key: null, _userId: null,
  async deriveKey(userId, accessToken, deviceId) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(accessToken), 'HKDF', false, ['deriveKey']);
    this._key = await crypto.subtle.deriveKey(
      { name: 'HKDF', hash: 'SHA-256', salt: enc.encode(`${userId}|${deviceId}`), info: enc.encode('khora-local-vault-v1') },
      keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
    );
    this._userId = userId;
    return this._key;
  },
  get ready() { return !!this._key; },
  async encrypt(data) {
    if (!this._key) throw new Error('LocalVaultCrypto not initialized');
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, this._key, new TextEncoder().encode(JSON.stringify(data)));
    return { __enc: 1, ct: btoa(String.fromCharCode(...new Uint8Array(ct))), iv: btoa(String.fromCharCode(...iv)) };
  },
  async decrypt(envelope) {
    if (!this._key) throw new Error('LocalVaultCrypto not initialized');
    if (!envelope?.__enc) return envelope;
    try {
      const ct = Uint8Array.from(atob(envelope.ct), c => c.charCodeAt(0));
      const iv = Uint8Array.from(atob(envelope.iv), c => c.charCodeAt(0));
      const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, this._key, ct);
      return JSON.parse(new TextDecoder().decode(dec));
    } catch { return null; }
  },
  clear() { this._key = null; this._userId = null; }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ENCRYPTED LOCAL CACHE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* All values written to IndexedDB go through LocalVaultCrypto.encrypt().
 * Keys (primary keys) remain plaintext for lookups; values are AES-256-GCM
 * ciphertext. An attacker inspecting IndexedDB sees only opaque blobs. */
const KhoraEncryptedCache = {
  DB_NAME: 'khora-encrypted-vault', DB_VERSION: 1,
  STORES: ['session', 'rooms', 'state'],
  _db: null,
  async open() {
    if (this._db) return this._db;
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.DB_NAME, this.DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        for (const s of this.STORES) { if (!db.objectStoreNames.contains(s)) db.createObjectStore(s); }
      };
      req.onsuccess = (e) => { this._db = e.target.result; resolve(this._db); };
      req.onerror = () => reject(req.error);
    });
  },
  async put(storeName, key, value) {
    if (!LocalVaultCrypto.ready) return;
    const db = await this.open();
    const encrypted = await LocalVaultCrypto.encrypt(value);
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      tx.objectStore(storeName).put(encrypted, key);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },
  async get(storeName, key) {
    if (!LocalVaultCrypto.ready) return null;
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const req = tx.objectStore(storeName).get(key);
      req.onsuccess = async () => {
        if (!req.result) return resolve(null);
        try { resolve(await LocalVaultCrypto.decrypt(req.result)); }
        catch { resolve(null); }
      };
      req.onerror = () => reject(req.error);
    });
  },
  async getAll(storeName) {
    if (!LocalVaultCrypto.ready) return {};
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const results = {}; const pending = [];
      const req = tx.objectStore(storeName).openCursor();
      req.onsuccess = (e) => {
        const cursor = e.target.result;
        if (cursor) {
          pending.push(LocalVaultCrypto.decrypt(cursor.value).then(v => { if (v !== null) results[cursor.key] = v; }).catch(() => {}));
          cursor.continue();
        } else { Promise.all(pending).then(() => resolve(results)); }
      };
      req.onerror = () => reject(req.error);
    });
  },
  async clear() {
    try {
      const db = await this.open();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(this.STORES, 'readwrite');
        for (const s of this.STORES) tx.objectStore(s).clear();
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    } catch {}
  },
  close() { if (this._db) { this._db.close(); this._db = null; } }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EO OPERATION LAYER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const OPERATORS = ['NUL','DES','INS','SEG','CON','SYN','ALT','SUP','REC'];

// Operator adjacency matrix (Â§5.2) â€” row can transition to column
const OP_ADJ = {
  NUL:['NUL','DES'], DES:['NUL','DES','INS'], INS:['DES','INS','SEG'],
  SEG:['INS','SEG','CON'], CON:['SEG','CON','SYN'], SYN:['CON','SYN','ALT'],
  ALT:['SYN','ALT','SUP'], SUP:['ALT','SUP','REC'], REC:['NUL','SUP','REC'],
};

// BFS pathfinding for auto-intermediate emission
function findOpPath(from, to) {
  if (from === to || OP_ADJ[from]?.includes(to)) return [to];
  const queue = [[from]]; const visited = new Set([from]);
  while (queue.length > 0) {
    const path = queue.shift(); const curr = path[path.length-1];
    for (const next of OP_ADJ[curr]||[]) {
      if (next === to) return path.slice(1).concat(to);
      if (!visited.has(next)) { visited.add(next); queue.push([...path, next]); }
    }
  }
  return [to]; // fallback
}

// Per-entity operation history (session-local)
const entityOpHist = {};
function eKey(roomId, field) { return `${roomId}::${field||'_root'}`; }

let opSeq = 0;
function genOpId() { return `op_${Date.now().toString(36)}${(opSeq++).toString(36)}${Math.random().toString(36).slice(2,5)}`; }

// Emit an EO operation â€” validates transitions, auto-emits intermediates
async function emitOp(roomId, op, target, context, frame, provenance = []) {
  const ek = eKey(roomId, target?.field || target?.entity);
  const lastOp = entityOpHist[ek];
  // Auto-emit intermediate operations if transition is invalid
  if (lastOp && !OP_ADJ[lastOp]?.includes(op)) {
    const path = findOpPath(lastOp, op);
    for (let i = 0; i < path.length - 1; i++) {
      const mid = { id: genOpId(), op: path[i], target, context: { auto_intermediate: true, from: lastOp, to: op }, frame, provenance: [], ts: Date.now() };
      await svc.sendEvent(roomId, EVT.OP, mid);
      entityOpHist[ek] = path[i];
    }
  }
  const event = { id: genOpId(), op, target, context, frame, provenance, ts: Date.now() };
  await svc.sendEvent(roomId, EVT.OP, event);
  entityOpHist[ek] = op;
  return event;
}

// Compute current state from operation history (Â§9.1)
function projectCurrentState(operations, frameType) {
  const state = {};
  const relevant = operations.filter(o => o.frame?.type === frameType).sort((a,b) => a.ts - b.ts);
  for (const op of relevant) {
    switch (op.op) {
      case 'INS':
        if (op.target?.field) state[op.target.field] = { value: op.target.value ?? op.context?.value, source_op: op.id, epistemic: op.frame?.epistemic, ts: op.ts };
        break;
      case 'ALT':
        if (op.target?.field && state[op.target.field]) { state[op.target.field].value = op.context?.to; state[op.target.field].source_op = op.id; state[op.target.field].ts = op.ts; }
        break;
      case 'NUL':
        if (op.target?.field) state[op.target.field] = { value: null, nullified_by: op.id, ts: op.ts };
        break;
      case 'SUP':
        if (op.target?.field) state[op.target.field] = { values: op.context?.states, superposition: true, source_op: op.id, ts: op.ts };
        break;
      case 'DES':
        if (op.target?.entity) state[`${op.target.entity}.designation`] = { value: op.target.designation, source_op: op.id, ts: op.ts };
        break;
    }
  }
  return state;
}

// SHA-256 cohort hash for metrics anonymization
async function cohortHash(userId, salt) {
  const data = new TextEncoder().encode(userId + (salt || 'khora_default_salt'));
  const hash = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(hash)));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMAIL VERIFICATION UTILITIES (Â§10.5) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Generates time-limited 6-digit codes, hashes them with SHA-256, and validates
 * email addresses against organization-approved domains. Codes are stored hashed
 * in Matrix room state â€” the plaintext code is delivered out-of-band (email/webhook).
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EmailVerification = {
  /** Generate a cryptographically random 6-digit code */
  generateCode() {
    const arr = crypto.getRandomValues(new Uint8Array(4));
    const num = (arr[0] << 24 | arr[1] << 16 | arr[2] << 8 | arr[3]) >>> 0;
    return String(num % 1000000).padStart(6, '0');
  },

  /** SHA-256 hash a verification code (stored in state; plaintext never persisted) */
  async hashCode(code) {
    const data = new TextEncoder().encode(code + ':khora_email_verify_v1');
    const hash = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)));
  },

  /** Extract domain from an email address */
  extractDomain(email) {
    const match = (email || '').trim().toLowerCase().match(/@([a-z0-9.-]+)$/);
    return match ? match[1] : null;
  },

  /** Validate email format */
  isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((email || '').trim());
  },

  /** Check if an email's domain matches any of the org's required domains */
  domainMatches(email, requiredDomains) {
    if (!requiredDomains || requiredDomains.length === 0) return true;
    const domain = this.extractDomain(email);
    return domain && requiredDomains.some(d => d.toLowerCase() === domain);
  },

  /** Create a verification challenge object (stored in room state) */
  async createChallenge(userId, email) {
    const code = this.generateCode();
    const codeHash = await this.hashCode(code);
    return {
      challenge: {
        user_id: userId,
        email: email.trim().toLowerCase(),
        domain: this.extractDomain(email),
        code_hash: codeHash,
        created: Date.now(),
        expires: Date.now() + 15 * 60 * 1000, // 15 minutes
        attempts: 0,
        max_attempts: 3,
        status: 'pending',
      },
      plainCode: code, // returned for delivery â€” never stored in state
    };
  },

  /** Validate a submitted code against a stored challenge */
  async validateChallenge(challenge, submittedCode) {
    if (!challenge || challenge.status !== 'pending') return { valid: false, reason: 'no_active_challenge' };
    if (Date.now() > challenge.expires) return { valid: false, reason: 'expired' };
    if (challenge.attempts >= challenge.max_attempts) return { valid: false, reason: 'max_attempts' };
    const submittedHash = await this.hashCode(submittedCode);
    if (submittedHash !== challenge.code_hash) return { valid: false, reason: 'incorrect_code' };
    return { valid: true };
  },

  /** Default email verification config for an organization */
  defaultConfig() {
    return {
      enabled: false,
      required_domains: [],
      require_for_roles: ['admin', 'case_manager', 'field_worker', 'intake_coordinator'],
      grace_period_hours: 72,
    };
  },

  /** Check if a staff member needs verification given org config */
  needsVerification(config, staffEntry) {
    if (!config?.enabled) return false;
    if (!config.require_for_roles?.includes(staffEntry.role)) return false;
    const ev = staffEntry.email_verification;
    if (ev?.status === 'verified') return false;
    return true;
  },

  /** Deliver verification code via n8n webhook (email relay) */
  async sendCodeViaWebhook(email, code, orgName) {
    try {
      const resp = await fetch(`${WEBHOOK_BASE}/email-verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          to: email,
          code: code,
          org_name: orgName,
          subject: `Your verification code for ${orgName}`,
          expires_minutes: 15,
        }),
      });
      return resp.ok;
    } catch { return false; }
  },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EVENT TYPES (Â§11) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const NS = 'io.khora';
const EVT = {
  IDENTITY:       `${NS}.identity`,
  OP:             `${NS}.op`,
  // Vault
  VAULT_SNAPSHOT: `${NS}.vault.snapshot`,
  VAULT_PROVIDERS:`${NS}.vault.providers`,
  // Bridge
  BRIDGE_META:    `${NS}.bridge.meta`,
  BRIDGE_REFS:    `${NS}.bridge.refs`,
  // Roster
  ROSTER_INDEX:   `${NS}.roster.index`,
  ROSTER_ASSIGN:  `${NS}.roster.assignment`,
  // Organization
  ORG_ROSTER:     `${NS}.org.roster`,
  ORG_METADATA:   `${NS}.org.metadata`,
  ORG_INVITE:     `${NS}.org.invite`,
  ORG_OPACITY:    `${NS}.org.opacity`,
  ORG_MSG_ACCESS: `${NS}.org.msg_access`,
  // Inter-org messaging
  ORG_MSG_CHANNEL:`${NS}.org.msg.channel`,
  ORG_MSG_ENVELOPE:`${NS}.org.msg.envelope`,
  // Schema
  SCHEMA_PROMPT:  `${NS}.schema.prompt`,
  SCHEMA_DEF:     `${NS}.schema.definition`,
  SCHEMA_TRANSFORM:`${NS}.schema.transform`,
  SCHEMA_SUB:     `${NS}.schema.subscription`,
  SCHEMA_AUTHORITY:`${NS}.schema.authority`,
  SCHEMA_PROP:    `${NS}.schema.propagation`,
  // Provider observations
  OBSERVATION:    `${NS}.observation`,
  // Metrics
  METRIC:         `${NS}.metric`,
  METRIC_AGG:     `${NS}.metric.aggregate`,
  METRIC_SUPPRESS:`${NS}.metric.suppression`,
  // Network
  NET_MEMBERS:    `${NS}.network.members`,
  NET_HASH_SALT:  `${NS}.network.hash_salt`,
  // Discovery
  INVITE_TOKEN:   `${NS}.invite.token`,
  ENCOUNTER_PROV: `${NS}.encounter.provisional`,
  // Email verification
  ORG_EMAIL_CONFIG: `${NS}.org.email_verification`,
  ORG_VERIFY_CHALLENGE: `${NS}.org.verification_challenge`,
  // Organization terminology customization
  ORG_TERMINOLOGY: `${NS}.org.terminology`,
  // Matching / dedup
  MATCH_TOKEN:    `${NS}.match.token`,
  MATCH_HIT:      `${NS}.match.hit`,
  MATCH_RESOLVE:  `${NS}.match.resolve`,
  // Client records (provider-created rooms representing clients)
  CLIENT_RECORD:  `${NS}.client.record`,
  // Import
  IMPORT_MANIFEST:`${NS}.import.manifest`,
  // Provider profile (self-reported identity & credentials)
  PROVIDER_PROFILE: `${NS}.provider.profile`,
  // Governance (MVP Â§Screen 5)
  GOV_PROPOSAL:   `${NS}.governance.proposal`,
  GOV_RHYTHM:     `${NS}.governance.rhythm`,
  // Schema field & binding (MVP event schema)
  SCHEMA_FIELD:   `${NS}.schema.field`,
  SCHEMA_BINDING: `${NS}.schema.binding`,
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATURITY LEVELS (MVP Â§Screen 4) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MATURITY_LEVELS = {
  draft:      { id: 'draft',      label: 'Draft',      color: 'blue',   icon: 'ğŸ”µ', desc: 'Proposed, not yet reviewed' },
  trial:      { id: 'trial',      label: 'Trial',      color: 'gold',   icon: 'ğŸŸ¡', desc: 'Approved for testing, may change' },
  normative:  { id: 'normative',  label: 'Normative',  color: 'green',  icon: 'ğŸŸ¢', desc: 'Locked, changes require formal process' },
  de_facto:   { id: 'de_facto',   label: 'De facto',   color: 'purple', icon: 'âšª', desc: 'Widely used, never formally proposed' },
  deprecated: { id: 'deprecated', label: 'Deprecated', color: 'red',    icon: 'ğŸ”´', desc: 'Being phased out' },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROPAGATION LEVELS (MVP Â§CON Semantics) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PROPAGATION_LEVELS = {
  required:    { id: 'required',    label: 'Required',    color: 'red',    desc: 'Tight coupling â€” auto-applied to orgs, immutable' },
  standard:    { id: 'standard',    label: 'Standard',    color: 'gold',   desc: 'Expected coupling â€” auto-applied, notify on divergence' },
  recommended: { id: 'recommended', label: 'Recommended', color: 'blue',   desc: 'Suggested coupling â€” org reviews, adopts or ignores' },
  optional:    { id: 'optional',    label: 'Optional',    color: 'teal',   desc: 'Loose coupling â€” available, no expectation' },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GOVERNANCE CONSTANTS (MVP Â§Screen 5) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CONSENT_POSITIONS = {
  adopt_as_is:          { id: 'adopt_as_is',          label: 'Adopt as-is',           icon: 'âœ…', color: 'green' },
  adopt_with_extension: { id: 'adopt_with_extension', label: 'Adopt with extension',  icon: 'ğŸ”„', color: 'blue' },
  needs_modification:   { id: 'needs_modification',   label: 'Needs modification',    icon: 'âš ï¸', color: 'gold' },
  cannot_adopt:         { id: 'cannot_adopt',         label: 'Cannot adopt (block)',   icon: 'ğŸš«', color: 'red' },
};

const PROPOSAL_STATUSES = {
  submitted:     { id: 'submitted',     label: 'Submitted',     color: 'blue' },
  discussion:    { id: 'discussion',    label: 'Discussion',    color: 'gold' },
  consent_round: { id: 'consent_round', label: 'Consent Round', color: 'orange' },
  resolved:      { id: 'resolved',      label: 'Resolved',      color: 'green' },
  adopted:       { id: 'adopted',       label: 'Adopted',       color: 'green' },
  blocked:       { id: 'blocked',       label: 'Blocked',       color: 'red' },
};

const GOV_RHYTHMS = {
  monthly_review:     { id: 'monthly_review',     name: 'Monthly Schema Review',         frequency: 'monthly',    anchor_day: 'first_monday', duration_days: 5, participants: 'org_admins' },
  quarterly_alignment:{ id: 'quarterly_alignment', name: 'Quarterly Framework Alignment', frequency: 'quarterly',  anchor_day: 'first_monday', duration_days: 5, participants: 'network_steward_plus_affected' },
  annual_constitutional:{ id: 'annual_constitutional', name: 'Annual Constitutional Review', frequency: 'annual', anchor_day: 'first_monday', duration_days: 14, participants: 'all_members_supermajority' },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ROLE INFERENCE (MVP Â§Screen 1) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Roles are detected from room memberships â€” no account-type selector.
 * A user can have multiple roles simultaneously. */
const ROLES = {
  client:    { id: 'client',    label: 'Client',            icon: 'shield',    color: 'teal',   desc: 'Data owner with a Client Vault' },
  provider:  { id: 'provider',  label: 'Provider',          icon: 'briefcase', color: 'gold',   desc: 'Case manager or outreach worker' },
  org_admin: { id: 'org_admin', label: 'Org Admin',         icon: 'users',     color: 'blue',   desc: 'Organization administrator' },
  network:   { id: 'network',   label: 'Network Coordinator',icon: 'globe',    color: 'green',  desc: 'Network governance steward' },
};

function inferRolesFromRooms(scannedState, userId) {
  const roles = new Set();
  for (const [roomId, state] of Object.entries(scannedState)) {
    const id = state[EVT.IDENTITY];
    if (!id) continue;
    // Client vault owned by this user â†’ client role
    if (id.account_type === 'client' && id.owner === userId) roles.add('client');
    // Provider roster owned by this user â†’ provider role
    if (id.account_type === 'provider' && id.owner === userId) roles.add('provider');
    // Org room where user is in staff roster â†’ provider role
    if (id.account_type === 'organization') roles.add('provider');
    // Network room â†’ network coordinator role (checked via power levels separately)
    if (id.account_type === 'network') roles.add('provider');
    // Bridge room where user is the provider side â†’ provider role
    const bridge = state[EVT.BRIDGE_META];
    if (bridge && bridge.provider === userId) roles.add('provider');
    // Bridge room where user is the client side â†’ client role
    if (bridge && bridge.client === userId) roles.add('client');
  }
  // Check for org admin role by examining org rosters
  for (const [roomId, state] of Object.entries(scannedState)) {
    const id = state[EVT.IDENTITY];
    const roster = state[EVT.ORG_ROSTER];
    if (id?.account_type === 'organization' && roster?.staff) {
      const staffEntry = roster.staff.find(s => s.userId === userId);
      if (staffEntry?.role === 'admin') roles.add('org_admin');
    }
  }
  return [...roles];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATRIX SERVICE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
class KhoraService {
  constructor() { this.client = null; this._baseUrl = null; this._token = null; this._userId = null; }

  async _withRetry(fn, maxAttempts = 5) {
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
      try { return await fn(); } catch (e) {
        const msg = (e?.data?.error || e?.message || '').toLowerCase();
        const retryMs = e?.data?.retry_after_ms;
        if (msg.includes('too many') || msg.includes('rate') || msg.includes('limit') || retryMs) {
          const wait = Math.min(retryMs || (1000 * Math.pow(2, attempt)), 16000);
          await new Promise(r => setTimeout(r, wait));
          continue;
        }
        throw e;
      }
    }
    throw new Error('Rate limited â€” too many requests. Please try again.');
  }

  async login(homeserver, user, pass) {
    const baseUrl = homeserver.startsWith('http') ? homeserver : `https://${homeserver}`;
    this._baseUrl = baseUrl;
    if (typeof matrixcs !== 'undefined') {
      this.client = matrixcs.createClient({ baseUrl });
      const res = await this.client.login('m.login.password', { user, password: pass });
      // Derive per-user at-rest encryption key (AES-256-GCM via HKDF from access token)
      // Only this user's session can decrypt local IndexedDB data
      await LocalVaultCrypto.deriveKey(res.user_id, res.access_token, res.device_id);
      // Purge any legacy unencrypted IndexedDB databases (preserves Matrix crypto store for E2EE)
      await this._purgeUnencryptedStores();
      this.client = matrixcs.createClient({ baseUrl, accessToken: res.access_token, userId: res.user_id, deviceId: res.device_id });
      try { await this.client.initCrypto(); } catch (e) { console.warn('Crypto:', e.message); }
      await this.client.startClient({ initialSyncLimit: 30 });
      await new Promise((resolve, reject) => {
        if (this.client.isInitialSyncComplete()) return resolve();
        const timeout = setTimeout(() => reject(new Error('Sync timed out â€” the server may be overloaded. Please try again.')), 60000);
        this.client.on('sync', (state, prev, data) => {
          if (state === 'PREPARED') { clearTimeout(timeout); resolve(); }
          else if (state === 'ERROR') { clearTimeout(timeout); reject(new Error(data?.error?.message || 'Sync failed â€” please try again.')); }
        });
      });
      this._userId = res.user_id; this._token = res.access_token;
      // Persist session to sessionStorage so it survives page refresh
      try { sessionStorage.setItem('khora_session', JSON.stringify({ homeserver: baseUrl, accessToken: res.access_token, userId: res.user_id, deviceId: res.device_id })); } catch {}
      // Cache encrypted session metadata in the encrypted vault
      try { await KhoraEncryptedCache.put('session', 'current', { userId: res.user_id, homeserver: baseUrl, deviceId: res.device_id, ts: Date.now() }); } catch {}
      return { userId: res.user_id };
    } else {
      const resp = await this._api('POST', '/login', { type: 'm.login.password', user, password: pass }, true);
      this._token = resp.access_token; this._userId = resp.user_id;
      return { userId: resp.user_id };
    }
  }

  async restoreSession() {
    try {
      const raw = sessionStorage.getItem('khora_session');
      if (!raw) return null;
      const { homeserver, accessToken, userId, deviceId } = JSON.parse(raw);
      if (!homeserver || !accessToken || !userId || !deviceId) return null;
      this._baseUrl = homeserver;
      await LocalVaultCrypto.deriveKey(userId, accessToken, deviceId);
      if (typeof matrixcs !== 'undefined') {
        this.client = matrixcs.createClient({ baseUrl: homeserver, accessToken, userId, deviceId });
        try { await this.client.initCrypto(); } catch (e) { console.warn('Crypto:', e.message); }
        await this.client.startClient({ initialSyncLimit: 30 });
        await new Promise((resolve, reject) => {
          if (this.client.isInitialSyncComplete()) return resolve();
          const timeout = setTimeout(() => reject(new Error('Sync timed out')), 60000);
          this.client.on('sync', (state, prev, data) => {
            if (state === 'PREPARED') { clearTimeout(timeout); resolve(); }
            else if (state === 'ERROR') { clearTimeout(timeout); reject(new Error(data?.error?.message || 'Sync failed')); }
          });
        });
      }
      this._userId = userId; this._token = accessToken;
      return { userId };
    } catch (e) {
      console.warn('Session restore failed:', e.message);
      sessionStorage.removeItem('khora_session');
      this.client = null; this._token = null; this._userId = null;
      LocalVaultCrypto.clear();
      return null;
    }
  }

  get userId() { return this._userId; }
  get hasCrypto() { return this.client && typeof this.client.isCryptoEnabled === 'function' && this.client.isCryptoEnabled(); }

  async _api(method, path, body, noAuth) {
    const url = `${this._baseUrl}/_matrix/client/v3${path}`;
    const h = { 'Content-Type': 'application/json' };
    if (!noAuth) h['Authorization'] = `Bearer ${this._token}`;
    const opts = { method, headers: h };
    if (body) opts.body = JSON.stringify(body);
    for (let attempt = 0; attempt < 5; attempt++) {
      const r = await fetch(url, opts);
      if (r.status === 429) {
        const err = await r.json().catch(()=>({}));
        const wait = Math.min(err.retry_after_ms || (1000 * Math.pow(2, attempt)), 16000);
        await new Promise(res => setTimeout(res, wait));
        continue;
      }
      if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error || `API ${r.status}`); }
      return r.json();
    }
    throw new Error('Rate limited â€” too many requests. Please try again.');
  }

  async createRoom(name, topic, extraState = []) {
    const initial_state = [
      { type: 'm.room.encryption', state_key: '', content: { algorithm: 'm.megolm.v1.aes-sha2' } },
      ...extraState,
    ];
    if (this.client) {
      const r = await this._withRetry(() => this.client.createRoom({ name, topic, visibility: 'private', preset: 'private_chat', initial_state }));
      return r.room_id;
    } else {
      const r = await this._api('POST', '/createRoom', { name, topic, visibility: 'private', preset: 'private_chat', initial_state });
      return r.room_id;
    }
  }

  async createClientRoom(name, topic, extraState = [], clientMatrixId = null) {
    const initial_state = [
      { type: 'm.room.encryption', state_key: '', content: { algorithm: 'm.megolm.v1.aes-sha2' } },
      ...extraState,
    ];
    const opts = { name, topic, visibility: 'private', preset: 'private_chat', initial_state };
    // If we know the client's Matrix ID, pre-set them as room admin (PL 100)
    // Provider gets PL 50 â€” client can kick provider but not vice versa.
    // We must explicitly set `events` to override the preset defaults (which require
    // PL 100 for m.room.encryption etc.) â€” otherwise initial_state events fail
    // because the provider only has PL 50.
    if (clientMatrixId) {
      opts.power_level_content_override = {
        users: { [this._userId]: 50, [clientMatrixId]: 100 },
        events_default: 0, state_default: 50,
        events: { 'm.room.power_levels': 100, 'm.room.tombstone': 100, 'm.room.server_acl': 100 },
        kick: 50, ban: 50, invite: 50, redact: 50,
      };
    }
    if (this.client) {
      const r = await this._withRetry(() => this.client.createRoom(opts));
      return r.room_id;
    } else {
      const r = await this._api('POST', '/createRoom', opts);
      return r.room_id;
    }
  }

  async setPowerLevel(roomId, userId, level) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (room) {
        const plEvent = room.currentState.getStateEvents('m.room.power_levels', '');
        const content = plEvent ? { ...plEvent.getContent() } : {};
        content.users = { ...(content.users || {}), [userId]: level };
        await this._withRetry(() => this.client.sendStateEvent(roomId, 'm.room.power_levels', content, ''));
      }
    } else {
      let current;
      try { current = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/state/m.room.power_levels/`); }
      catch { current = {}; }
      current.users = { ...(current.users || {}), [userId]: level };
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/state/m.room.power_levels/`, current);
    }
  }

  async getState(roomId, type, sk = '') {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (!room) return null;
      const ev = room.currentState.getStateEvents(type, sk);
      return ev ? ev.getContent() : null;
    }
    try { return await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/state/${type}/${sk}`); } catch { return null; }
  }

  async setState(roomId, type, content, sk = '') {
    if (this.client) { await this._withRetry(() => this.client.sendStateEvent(roomId, type, content, sk)); }
    else { await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/state/${type}/${sk}`, content); }
  }

  async sendEvent(roomId, type, content) {
    if (this.client) { await this._withRetry(() => this.client.sendEvent(roomId, type, content)); }
    else {
      const txn = 'txn_' + Date.now() + Math.random().toString(36).slice(2);
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/send/${encodeURIComponent(type)}/${txn}`, content);
    }
  }

  async sendMessage(roomId, body, extra = {}) {
    const content = { msgtype: 'm.text', body, ...extra, timestamp: Date.now() };
    if (this.client) { await this._withRetry(() => this.client.sendMessage(roomId, content)); }
    else {
      const txn = 'txn_' + Date.now() + Math.random().toString(36).slice(2);
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/send/m.room.message/${txn}`, content);
    }
  }

  async getMessages(roomId, limit = 40) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (!room) return [];
      return room.getLiveTimeline().getEvents()
        .filter(ev => ev.getType() === 'm.room.message')
        .map(ev => ({ id: ev.getId(), sender: ev.getSender(), content: ev.getContent(), ts: ev.getTs() }))
        .reverse();
    }
    const d = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/messages?dir=b&limit=${limit}`);
    return (d.chunk || []).filter(e => e.type === 'm.room.message')
      .map(e => ({ id: e.event_id, sender: e.sender, content: e.content, ts: e.origin_server_ts }));
  }

  async invite(roomId, userId) {
    if (this.client) { await this.client.invite(roomId, userId); }
    else { await this._api('POST', `/rooms/${encodeURIComponent(roomId)}/invite`, { user_id: userId }); }
  }

  async kick(roomId, userId, reason = 'Removed') {
    if (this.client) { await this.client.kick(roomId, userId, reason); }
    else { await this._api('POST', `/rooms/${encodeURIComponent(roomId)}/kick`, { user_id: userId, reason }); }
  }

  async tombstone(roomId, newRoomId) {
    await this.setState(roomId, 'm.room.tombstone', { body: 'This room has been replaced', replacement_room: newRoomId });
  }

  async getJoinedRooms() {
    if (this.client) return this.client.getRooms().map(r => r.roomId);
    const d = await this._api('GET', '/joined_rooms');
    return d.joined_rooms || [];
  }

  async getRoomMembers(roomId) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      return room ? room.getJoinedMembers().map(m => ({ userId: m.userId, name: m.name })) : [];
    }
    try {
      const d = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/joined_members`);
      return Object.keys(d.joined || {}).map(id => ({ userId: id, name: d.joined[id]?.display_name || id }));
    } catch { return []; }
  }

  // Batch-fetch all Khora state across joined rooms in a single request.
  // When the SDK is available, reads local sync state (no HTTP calls).
  // When using the API fallback, uses /sync with a tight filter â€” one request
  // instead of 2*N individual getState calls that produce 404s for non-Khora rooms.
  // Returns: { [roomId]: { [eventType]: content } }
  // Results are cached in the encrypted local vault (KhoraEncryptedCache).
  async scanRooms(extraTypes = []) {
    const types = [EVT.IDENTITY, EVT.BRIDGE_META, EVT.BRIDGE_REFS, ...extraTypes];
    if (this.client) {
      const result = {};
      for (const room of this.client.getRooms()) {
        const state = {};
        for (const type of types) {
          const ev = room.currentState.getStateEvents(type, '');
          if (ev) state[type] = ev.getContent();
        }
        if (Object.keys(state).length > 0) result[room.roomId] = state;
      }
      // Persist room state to encrypted local cache
      try { await KhoraEncryptedCache.put('rooms', 'scan_result', { data: result, ts: Date.now() }); } catch {}
      return result;
    }
    // Fallback: single /sync with filter â€” avoids per-room 404 spam
    const filter = JSON.stringify({
      room: {
        state: { types },
        timeline: { limit: 0 },
        ephemeral: { types: [] }
      },
      presence: { types: [] },
      account_data: { types: [] }
    });
    try {
      const data = await this._api('GET', `/sync?filter=${encodeURIComponent(filter)}&timeout=0`);
      const result = {};
      const joined = data?.rooms?.join || {};
      for (const [roomId, roomData] of Object.entries(joined)) {
        const events = roomData?.state?.events || [];
        const state = {};
        for (const ev of events) {
          if (ev.state_key === '') state[ev.type] = ev.content;
        }
        if (Object.keys(state).length > 0) result[roomId] = state;
      }
      return result;
    } catch (e) {
      console.warn('scanRooms sync fallback failed, falling back to per-room scan:', e.message);
      // Last resort: per-room scan (original behavior)
      const rooms = await this.getJoinedRooms();
      const result = {};
      for (const rid of rooms) {
        try {
          const allState = await this._api('GET', `/rooms/${encodeURIComponent(rid)}/state`);
          const state = {};
          for (const ev of allState) {
            if (ev.state_key === '' && types.includes(ev.type)) state[ev.type] = ev.content;
          }
          if (Object.keys(state).length > 0) result[rid] = state;
        } catch { /* skip rooms we can't read */ }
      }
      return result;
    }
  }

  // Purge unencrypted IndexedDB databases created by the Matrix SDK sync layer
  // or legacy application caches. Preserves crypto stores (Olm/Megolm key material
  // needed for E2EE continuity) and our own encrypted vault.
  async _purgeUnencryptedStores() {
    if (typeof indexedDB?.databases === 'function') {
      try {
        const dbs = await indexedDB.databases();
        for (const db of dbs) {
          // Keep our encrypted vault and any crypto key stores
          if (db.name && db.name !== KhoraEncryptedCache.DB_NAME && !db.name.includes('crypto')) {
            try { indexedDB.deleteDatabase(db.name); } catch {}
          }
        }
      } catch (e) { console.warn('IndexedDB purge:', e.message); }
    }
    // Explicitly target known unencrypted sync/state databases by name
    for (const name of ['amino', 'matrix-js-sdk:default', 'matrix-js-sdk:riot-web-sync', 'matrix-js-sdk:web-sync']) {
      try { indexedDB.deleteDatabase(name); } catch {}
    }
  }

  async logout() {
    if (this.client) { this.client.stopClient(); try { await this.client.logout(); } catch {} }
    this.client = null; this._token = null; this._userId = null;
    // Destroy at-rest encryption key â€” local encrypted data becomes unreadable
    LocalVaultCrypto.clear();
    // Wipe encrypted local cache and close database connection
    try { await KhoraEncryptedCache.clear(); KhoraEncryptedCache.close(); } catch {}
    // Purge any remaining unencrypted databases
    try { await this._purgeUnencryptedStores(); } catch {}
  }

  // Scan invited rooms â€” returns rooms the user has been invited to but hasn't joined.
  // Uses invite state from /sync (SDK) or invite section of sync response (API).
  async scanInvitedRooms(types = [EVT.IDENTITY]) {
    if (this.client) {
      const result = {};
      for (const room of this.client.getRooms()) {
        const membership = room.getMyMembership();
        if (membership !== 'invite') continue;
        const state = {};
        for (const type of types) {
          const ev = room.currentState.getStateEvents(type, '');
          if (ev) state[type] = ev.getContent();
        }
        if (Object.keys(state).length > 0) result[room.roomId] = state;
      }
      return result;
    }
    // API fallback: /sync includes invite section with stripped state
    const filter = JSON.stringify({
      room: { state: { types }, timeline: { limit: 0 }, ephemeral: { types: [] } },
      presence: { types: [] }, account_data: { types: [] }
    });
    try {
      const data = await this._api('GET', `/sync?filter=${encodeURIComponent(filter)}&timeout=0`);
      const result = {};
      const invited = data?.rooms?.invite || {};
      for (const [roomId, roomData] of Object.entries(invited)) {
        const events = roomData?.invite_state?.events || [];
        const state = {};
        for (const ev of events) {
          if (ev.state_key === '' && types.includes(ev.type)) state[ev.type] = ev.content;
        }
        if (Object.keys(state).length > 0) result[roomId] = state;
      }
      return result;
    } catch { return {}; }
  }

  async joinRoom(roomId) {
    if (this.client) {
      await this._withRetry(() => this.client.joinRoom(roomId));
    } else {
      await this._api('POST', `/join/${encodeURIComponent(roomId)}`, {});
    }
  }
}

const svc = new KhoraService();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WEBHOOK / AIRTABLE BRIDGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Fetches table and record data from n8n webhook endpoints backed by
 * the amino Postgres schema. Auth is forwarded via query-param so the
 * browser never sends an Authorization header, avoiding CORS preflight.
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WEBHOOK_BASE = 'https://n8n.intelechia.com/webhook';

async function webhookFetch(path, token) {
  const sep = path.includes('?') ? '&' : '?';
  const url = `${WEBHOOK_BASE}${path}${token ? `${sep}access_token=${encodeURIComponent(token)}` : ''}`;
  const resp = await fetch(url);
  if (!resp.ok) {
    const body = await resp.json().catch(() => ({}));
    throw new Error(body.error || body.message || `Webhook ${resp.status}`);
  }
  return resp.json();
}

async function hydrateFromWebhooks(token) {
  const { tables } = await webhookFetch('/api/tables', token);
  const allTables = {};
  await Promise.all(tables.map(async (t) => {
    try {
      const data = await webhookFetch(`/api/records/${encodeURIComponent(t.table_id)}`, token);
      allTables[t.table_id] = { ...t, records: data.records || [] };
    } catch (e) {
      console.warn(`Failed to hydrate table ${t.table_id}:`, e.message);
      allTables[t.table_id] = { ...t, records: [] };
    }
  }));
  return allTables;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DOMAIN CONFIG (Â§C.0) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * All domain-specific content is consolidated here. To adapt Tessera for a
 * different sector, replace the contents of DOMAIN_CONFIG â€” the application
 * logic, encryption model, bridge topology, and EO operator layer are all
 * domain-agnostic.
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DOMAIN_CONFIG = {

  /* â”€â”€ Authorities â”€â”€ */
  authorities: [
    { id:'auth_org_policy', name:'Organization Policy v1',
      uri:'local://org/policy',
      authority_type:'organizational_policy', authority_org:'Organization', version:'v1',
      terms:[
        {id:'policy_1',label:'Eligibility Criteria',
         definition:'Conditions under which an individual qualifies for services'},
        {id:'policy_2',label:'Service Standards',
         definition:'Required standards for service delivery'},
        {id:'policy_3',label:'Data Collection Requirements',
         definition:'Mandatory data elements for intake and ongoing engagement'},
      ]},
    { id:'auth_ext_standard', name:'External Reporting Standard',
      uri:'local://ext/standard',
      authority_type:'external_standard', authority_org:'Regulatory Body', version:'v1',
      terms:[
        {id:'ext_1',label:'Status Classification (1.01)',
         definition:'Current status at point of engagement'},
        {id:'ext_2',label:'Engagement Type (1.02)',
         definition:'Nature of service engagement'},
        {id:'ext_3',label:'Identity Elements (2.01)'},
        {id:'ext_4',label:'Contact Elements (2.02)'},
      ]},
    { id:'auth_service_taxonomy', name:'Service Taxonomy',
      uri:'local://service/taxonomy',
      authority_type:'industry_standard', authority_org:'Standards Body', version:'v1',
      terms:[
        {id:'svc_cat_1',label:'Direct Services',definition:'Services delivered to individuals'},
        {id:'svc_cat_2',label:'Coordination Services',definition:'Referral and linkage services'},
      ]},
    { id:'auth_local_policy', name:'Local Policy',
      uri:'local://local/policy', authority_type:'local_policy', authority_org:'Local Authority',
      terms:[] },
  ],

  /* â”€â”€ Client Observation Prompts â”€â”€ */
  clientPrompts: [
    { id:'prompt_current_status', key:'current_status', question:'What is your current status?', type:'single_select',
      version:1, audience:'client', maturity:'normative', section:'status',
      source:{level:'network',propagation:'required'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'current_status',designation:'Current Status Prompt'},
           frame:{type:'schema',epistemic:'MEANT',role:'network'}},
          {op:'CON',target:{source:'current_status',destination:'ext:standard_1.01'},
           context:{authority_id:'auth_ext_standard',element:'ext_1',
                    authority_name:'External Reporting Standard'}},
          {op:'SEG',target:{field:'response_options',entity:'current_status'},
           context:{rationale:'Simplified from full reporting standard for field use',
                    excluded:['administrative_hold','archived']}}
        ],
        trace:'current_status = DES â†’ CON(ext:standard_1.01) â†’ SEG({field simplified})'
      },
      options:[
        {v:'active',l:'Active â€” currently receiving services',
         eo:{op:'SYN',target:{local:'active',external:'ext:standard_1.01:a'}}},
        {v:'on_hold',l:'On hold â€” temporarily paused',
         eo:{op:'SYN',target:{local:'on_hold',external:'ext:standard_1.01:b'}}},
        {v:'pending_review',l:'Pending review',
         eo:{op:'SYN',target:{local:'pending_review',external:'ext:standard_1.01:c'}}},
        {v:'resolved',l:'Resolved â€” services completed',
         eo:{op:'SYN',target:{local:'resolved',external:'ext:standard_1.01:d'}}},
        {v:'other',l:'Other',
         eo:{op:'INS',target:{local:'other'},context:{note:'Catch-all not in reporting taxonomy'}}}
      ],
      category:'status', sensitive:false, metrics:true },
    { id:'prompt_engagement', key:'engagement_type', question:'What engagement occurred?', type:'single_select',
      version:1, audience:'client', maturity:'normative', section:'engagement',
      source:{level:'network',propagation:'required'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'engagement_type',designation:'Engagement Type Prompt'},
           frame:{type:'schema',epistemic:'MEANT',role:'network'}},
          {op:'CON',target:{source:'engagement_type',destination:'svc:direct_services'},
           context:{authority_id:'auth_service_taxonomy',authority_name:'Service Taxonomy'}}
        ],
        trace:'engagement_type = DES â†’ CON(svc:direct_services)'
      },
      options:[
        {v:'in_person',l:'In-person meeting'},{v:'phone_call',l:'Phone call'},
        {v:'referral_contact',l:'Referral or linkage',eo:{op:'CON',target:{local:'referral_contact',external:'svc:svc_cat_2'}}},
        {v:'intake',l:'Intake or enrollment'},{v:'follow_up',l:'Follow-up contact'},{v:'other',l:'Other'}],
      category:'engagement', sensitive:false, metrics:true },
    { id:'prompt_intake_event', key:'intake_event', question:'What intake event occurred?', type:'single_select',
      version:1, audience:'client', maturity:'trial', section:'intake',
      source:{level:'network',propagation:'standard'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'intake_event',designation:'Intake Event Prompt'},
           frame:{type:'schema',epistemic:'MEANT',role:'network'}}
        ],
        trace:'intake_event = DES'
      },
      options:[
        {v:'application_submitted',l:'Application submitted'},{v:'documents_provided',l:'Documents provided'},
        {v:'eligibility_confirmed',l:'Eligibility confirmed'},{v:'enrolled',l:'Enrolled in program'},
        {v:'waitlisted',l:'Placed on waitlist'},{v:'other',l:'Other'}],
      category:'intake', sensitive:false, metrics:true },
    { id:'prompt_additional_context', key:'additional_context', question:'Any additional context to record?', type:'single_select',
      version:1, audience:'client', maturity:'draft', section:'general',
      source:{level:'local'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'additional_context',designation:'Additional Context Prompt'},
           frame:{type:'schema',epistemic:'MEANT',role:'network'}}
        ],
        trace:'additional_context = DES'
      },
      options:[
        {v:'situation_change',l:'Situation changed'},{v:'new_need',l:'New need identified'},
        {v:'barrier_encountered',l:'Barrier encountered'},{v:'milestone_reached',l:'Milestone reached'},{v:'other',l:'Other'}],
      category:'general', sensitive:true, metrics:true },
  ],

  /* â”€â”€ Provider-Side Prompts â”€â”€ */
  providerPrompts: [
    { id:'pprompt_assessment_score', key:'assessment_score', question:'Assessment Score', type:'numeric',
      version:1, audience:'provider', maturity:'normative', section:'assessment',
      source:{level:'network',propagation:'standard'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'assessment_score',designation:'Assessment Score'},
           frame:{type:'schema',epistemic:'MEANT',role:'provider'}},
          {op:'CON',target:{source:'assessment_score',destination:'org:assessment-v1'},
           context:{authority_name:'Organization Policy',note:'Standard assessment instrument'}}
        ],
        trace:'assessment_score = DES â†’ CON(org:assessment-v1)'
      },
      range:{min:0,max:10}, thresholds:[{v:0,l:'Low'},{v:4,l:'Medium'},{v:7,l:'High'}],
      category:'assessment', sensitive:true, metrics:true },
    { id:'pprompt_case_stage', key:'case_stage', question:'Case stage?', type:'single_select',
      version:1, audience:'provider', maturity:'normative', section:'case_management',
      source:{level:'network',propagation:'required'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'case_stage',designation:'Case Stage'},
           frame:{type:'schema',epistemic:'MEANT',role:'provider'}}
        ],
        trace:'case_stage = DES'
      },
      options:[
        {v:'intake',l:'Intake'},{v:'active',l:'Active'},
        {v:'monitoring',l:'Monitoring'},{v:'closed_complete',l:'Closed â€” completed'},
        {v:'closed_withdrawn',l:'Closed â€” withdrawn'},{v:'closed_lost',l:'Closed â€” lost contact'}],
      category:'case_management', sensitive:false, metrics:true },
    { id:'pprompt_referral', key:'referral_status', question:'Referral status?', type:'single_select',
      version:1, audience:'provider', maturity:'trial', section:'coordination',
      source:{level:'network',propagation:'recommended'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'referral_status',designation:'Referral Status'},
           frame:{type:'schema',epistemic:'MEANT',role:'provider'}},
          {op:'CON',target:{source:'referral_status',destination:'svc:coordination'},
           context:{authority_id:'auth_service_taxonomy'}}
        ],
        trace:'referral_status = DES â†’ CON(svc:coordination)'
      },
      options:[
        {v:'identified',l:'Need identified'},{v:'referred',l:'Referred'},
        {v:'scheduled',l:'Appointment scheduled'},{v:'completed',l:'Service completed'},
        {v:'declined',l:'Declined'},{v:'no_capacity',l:'Receiving org at capacity'}],
      category:'coordination', sensitive:false, metrics:true },
  ],

  /* â”€â”€ Classification Definitions â”€â”€ */
  definitions: [
    { id:'def_priority_level', key:'priority_level', name:'Priority Level', type:'classification_rule',
      version:1, maturity:'normative', source:{level:'network',propagation:'required'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'priority_level',designation:'Priority Level Classification'},
           frame:{type:'schema',epistemic:'MEANT',role:'network'}},
          {op:'CON',target:{source:'priority_level',destination:'org:policy_1'},
           context:{authority_id:'auth_org_policy',
                    authority_name:'Organization Policy v1',version:'v1'}},
          {op:'SEG',target:{field:'categories',entity:'priority_level'},
           context:{included:['priority_a','priority_b'],excluded:['priority_d'],
                    rationale:'Network prioritizes highest-need categories'}}
        ],
        trace:'priority_level = DES â†’ CON(org:policy_1) â†’ SEG({Categories A-B})'
      },
      rules:[
        {category:'priority_a', criteria:'current_status IN (active) AND assessment_score >= 7', authority_code:'A',
         eo:{
           chain:[
             {op:'SYN',target:{local:'priority_a',external:'org:policy_1(a)'}},
             {op:'CON',target:{source:'priority_a',destination:'current_status'},
              context:{derivation:'Classification derived from observation',
                       epistemic_crossing:'GIVEN â†’ MEANT',
                       note:'Observation (current status) is GIVEN; classification (priority A) is MEANT'}}
           ]}},
        {category:'priority_b', criteria:'intake_event=eligibility_confirmed AND engagement_type != none', authority_code:'B',
         eo:{
           chain:[
             {op:'SYN',target:{local:'priority_b',external:'org:policy_1(b)'}},
             {op:'CON',target:{source:'priority_b',destination:'intake_event'},
              context:{derivation:'Classification derived from intake observation + engagement',
                       epistemic_crossing:'GIVEN â†’ MEANT'}}
           ]}},
        {category:'stable', criteria:'current_status=resolved for 30+ days', authority_code:null,
         eo:{
           chain:[
             {op:'DES',target:{entity:'stable',designation:'Stable'},
              context:{note:'Local definition â€” no direct external equivalent'}},
             {op:'CON',target:{source:'stable',destination:'current_status'},
              context:{derivation:'Classification from sustained observation pattern',
                       epistemic_crossing:'GIVEN â†’ MEANT'}}
           ]}},
      ]},
    { id:'def_extended_engagement', key:'extended_engagement', name:'Extended Engagement', type:'classification_rule',
      version:1, maturity:'trial', source:{level:'network',propagation:'standard'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'extended_engagement',designation:'Extended Engagement Definition'},
           frame:{type:'schema',epistemic:'MEANT',role:'network'}},
          {op:'CON',target:{source:'extended_engagement',destination:'org:policy_1'},
           context:{authority_id:'auth_org_policy',
                    authority_name:'Organization Policy v1',version:'v1'}},
          {op:'SUP',target:{entity:'extended_engagement',field:'definition'},
           context:{
             states:[
               {source:'org:policy_1',definition:'12 months continuous OR 4 engagement episodes in 3 years',
                frame:'organization_standard'},
               {source:'local_policy',definition:'6 months continuous OR 3 episodes in 2 years',
                frame:'local_practice'}
             ],
             resolution:null,
             note:'Organization definition used for reporting; local definition used for prioritization'
           }}
        ],
        trace:'extended_engagement = DES â†’ CON(org:policy_1) â†’ SUP({org vs local})'
      },
      rules:[
        {category:'extended_org', criteria:'active engagement for 12+ months continuous OR 4+ episodes in 3 years', authority_code:'ext',
         eo:{chain:[{op:'SYN',target:{local:'extended_org',external:'org:policy_1'}}]}},
        {category:'extended_local', criteria:'active engagement for 6+ months continuous OR 3+ episodes in 2 years', authority_code:null,
         eo:{chain:[{op:'DES',target:{entity:'extended_local'},context:{note:'Local threshold â€” lower bar for outreach'}}]}},
      ]},
  ],

  /* â”€â”€ Anonymization Transforms â”€â”€ */
  transforms: {
    dob:{method:'age_range',buckets:['0-17','18-24','25-34','35-44','45-54','55-64','65+']},
    address:{method:'area_hash'},
    full_name:{method:'block'}, id_number:{method:'block'}, phone:{method:'block'}, email:{method:'block'},
  },

  /* â”€â”€ Vault Fields â”€â”€ */
  vaultFields: [
    {key:'full_name',label:'Full Name',category:'identity',sensitive:false},
    {key:'dob',label:'Date of Birth',category:'identity',sensitive:true},
    {key:'id_number',label:'ID Number',category:'identity',sensitive:true},
    {key:'email',label:'Email',category:'contact',sensitive:false},
    {key:'phone',label:'Phone',category:'contact',sensitive:false},
    {key:'address',label:'Address',category:'contact',sensitive:true},
    {key:'affiliation',label:'Organization / Affiliation',category:'details',sensitive:false},
    {key:'case_notes',label:'Case Notes',category:'case',sensitive:false},
    {key:'documents',label:'Documents',category:'case',sensitive:true},
    {key:'history',label:'Case History',category:'case',sensitive:false},
    {key:'restricted_notes',label:'Restricted Notes',category:'sensitive',sensitive:true},
  ],

  /* â”€â”€ Field Categories â”€â”€ */
  fieldCategories: ['identity','contact','details','case','sensitive'],
  fieldCatLabels: {identity:'Identity',contact:'Contact',details:'Details',case:'Case',sensitive:'Sensitive'},
  fieldCatIcons: {identity:'user',contact:'msg',details:'briefcase',case:'folder',sensitive:'shieldCheck'},
  fieldCatColors: {identity:'blue',contact:'teal',details:'gold',case:'orange',sensitive:'green'},

  /* â”€â”€ Observation Categories â”€â”€ */
  obsCatLabels: {status:'Status',engagement:'Engagement',intake:'Intake',general:'General',
    assessment:'Assessment',case_management:'Case Mgmt',coordination:'Coordination'},
  obsCatColors: {status:'teal',engagement:'blue',intake:'orange',general:'gold',
    assessment:'purple',case_management:'gold',coordination:'blue'},

  /* â”€â”€ Org Roles â”€â”€ */
  orgRoles: ['admin','case_manager','field_worker','intake_coordinator','read_only'],
  orgRoleLabels: {admin:'Admin',case_manager:'Case Manager',field_worker:'Field Worker',
    intake_coordinator:'Intake Coordinator',read_only:'Read Only'},

  /* â”€â”€ Org Types â”€â”€ */
  orgTypes: ['direct_service','administrative','clinical','legal','coordinating_body','advocacy','other'],
  orgTypeLabels: {direct_service:'Direct Service',administrative:'Administrative',clinical:'Clinical',
    legal:'Legal',coordinating_body:'Coordinating Body',advocacy:'Advocacy',other:'Other'},

  /* â”€â”€ Org Opacity Levels â”€â”€ */
  // Controls how much of the org's internal structure is visible to external orgs during messaging
  opacityLevels: ['transparent','translucent','opaque'],
  opacityLabels: {
    transparent: 'Transparent',     // sender name & org visible
    translucent: 'Translucent',     // org name visible, individual sender hidden
    opaque:      'Opaque',          // only "an organization" â€” no name, no members
  },
  opacityDescriptions: {
    transparent: 'External orgs see which staff member sent each message and your org name.',
    translucent: 'External orgs see your org name but individual sender identities are hidden.',
    opaque:      'External orgs see only that a response came from an organization. Org name and all member identities are hidden.',
  },

  /* â”€â”€ Org Message Access Roles â”€â”€ */
  // Which org roles can access inter-org messages by default
  msgAccessDefaults: {
    read: ['admin','case_manager'],
    respond: ['admin'],
  },

  /* â”€â”€ Org Terminology Defaults â”€â”€ */
  // Admins can override these terms at the org level to match their sector vocabulary
  terminologyDefaults: {
    client_term: 'Client',
    client_term_plural: 'Clients',
    provider_term: 'Provider',
    provider_term_plural: 'Providers',
  },
};

/* â”€â”€ Derived constants (backward-compatible references) â”€â”€ */
const DEFAULT_AUTHORITIES = DOMAIN_CONFIG.authorities;
const DEFAULT_PROMPTS = DOMAIN_CONFIG.clientPrompts;
const DEFAULT_PROVIDER_PROMPTS = DOMAIN_CONFIG.providerPrompts;
const DEFAULT_DEFINITIONS = DOMAIN_CONFIG.definitions;
const DEFAULT_TRANSFORMS = DOMAIN_CONFIG.transforms;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VAULT FIELD DEFINITIONS (Â§10) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VAULT_FIELDS = DOMAIN_CONFIG.vaultFields;
const FIELD_CATEGORIES = DOMAIN_CONFIG.fieldCategories;
const CAT_LABELS = DOMAIN_CONFIG.fieldCatLabels;
const CAT_ICONS = DOMAIN_CONFIG.fieldCatIcons;
const CAT_COLORS = DOMAIN_CONFIG.fieldCatColors;
const OBS_CAT_LABELS = DOMAIN_CONFIG.obsCatLabels;
const OBS_CAT_COLORS = DOMAIN_CONFIG.obsCatColors;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ORG ROLES & TYPES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ORG_ROLES = DOMAIN_CONFIG.orgRoles;
const ORG_ROLE_LABELS = DOMAIN_CONFIG.orgRoleLabels;
const ORG_TYPES = DOMAIN_CONFIG.orgTypes;
const ORG_TYPE_LABELS = DOMAIN_CONFIG.orgTypeLabels;
const OPACITY_LEVELS = DOMAIN_CONFIG.opacityLevels;
const OPACITY_LABELS = DOMAIN_CONFIG.opacityLabels;
const OPACITY_DESCRIPTIONS = DOMAIN_CONFIG.opacityDescriptions;
const MSG_ACCESS_DEFAULTS = DOMAIN_CONFIG.msgAccessDefaults;
const TERMINOLOGY_DEFAULTS = DOMAIN_CONFIG.terminologyDefaults;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FRAMEWORK BINDINGS (Â§C.2) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Multi-framework value mappings: same observation value â†’ different classifications
// under different institutional frameworks. This is the GIVEN â†’ MEANT crossing made explicit.
const FRAMEWORK_BINDINGS = {
  sleep_location: {
    prompt_id: 'prompt_sleep_location',
    prompt_key: 'sleep_location',
    question: 'Where did you sleep last night?',
    bindings: {
      vehicle: {
        local_label: 'Car, van, or RV',
        frameworks: [
          { id: 'fb_vehicle_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 â€” Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: 'Â§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services',
            eo_chain: [
              {op:'CON',desc:'sleep_location â†’ hud:hmis_3.12'},
              {op:'SYN',desc:'vehicle â†’ code_7'},
              {op:'CON',desc:'code_7 â†’ 24cfr578.3(b)(1)'}
            ],
            eo_compact: 'CON(sleep_location â†’ hud:hmis_3.12) â†’ SYN(vehicle â†’ code_7)'
          },
          { id: 'fb_vehicle_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: 'Â§3.2 Unsheltered prioritization',
            classification: 'Priority 1 â€” Immediate outreach',
            classification_code: 'priority_1',
            implication: 'Assigned to next available outreach team',
            eo_chain: [
              {op:'CON',desc:'sleep_location â†’ coc:outreach_priority'},
              {op:'SYN',desc:'vehicle â†’ priority_1'}
            ],
            eo_compact: 'CON(sleep_location â†’ coc:outreach_priority) â†’ SYN(vehicle â†’ priority_1)'
          },
          { id: 'fb_vehicle_pit',
            authority_id: 'auth_hud_hmis_ds',
            authority_name: 'PIT Count Methodology',
            authority_org: 'HUD Exchange',
            authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
            provision: 'PIT Unsheltered Definition',
            classification: 'Unsheltered',
            classification_code: 'unsheltered',
            implication: 'Counted in unsheltered PIT total',
            eo_chain: [
              {op:'CON',desc:'sleep_location â†’ pit:shelter_status'},
              {op:'SYN',desc:'vehicle â†’ unsheltered'}
            ],
            eo_compact: 'CON(sleep_location â†’ pit:shelter_status) â†’ SYN(vehicle â†’ unsheltered)'
          }
        ]
      },
      encampment: {
        local_label: 'Tent or encampment',
        frameworks: [
          { id: 'fb_encampment_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 â€” Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: 'Â§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ hud:hmis_3.12'},{op:'SYN',desc:'encampment â†’ code_16'}],
            eo_compact: 'CON â†’ SYN(encampment â†’ code_16)'
          },
          { id: 'fb_encampment_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: 'Â§3.2',
            classification: 'Priority 1 â€” Immediate outreach',
            classification_code: 'priority_1',
            implication: 'Assigned to next available outreach team',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ coc:outreach_priority'},{op:'SYN',desc:'encampment â†’ priority_1'}],
            eo_compact: 'CON â†’ SYN(encampment â†’ priority_1)'
          },
          { id: 'fb_encampment_pit',
            authority_id: 'auth_hud_hmis_ds',
            authority_name: 'PIT Count Methodology',
            authority_org: 'HUD Exchange',
            authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
            provision: 'PIT Unsheltered Definition',
            classification: 'Unsheltered',
            classification_code: 'unsheltered',
            implication: 'Counted in unsheltered PIT total',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ pit:shelter_status'},{op:'SYN',desc:'encampment â†’ unsheltered'}],
            eo_compact: 'CON â†’ SYN(encampment â†’ unsheltered)'
          }
        ]
      },
      unsheltered: {
        local_label: 'Street, park, or unsheltered',
        frameworks: [
          { id: 'fb_unsheltered_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 â€” Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: 'Â§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ hud:hmis_3.12'},{op:'SYN',desc:'unsheltered â†’ code_16'},{op:'SEG',desc:'collapsed with encampment'}],
            eo_compact: 'CON â†’ SYN(unsheltered â†’ code_16) â†’ SEG(collapsed)'
          },
          { id: 'fb_unsheltered_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: 'Â§3.1 Street prioritization',
            classification: 'Priority 1 â€” Immediate outreach',
            classification_code: 'priority_1',
            implication: 'Highest priority â€” immediate deployment',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ coc:outreach_priority'},{op:'SYN',desc:'unsheltered â†’ priority_1'}],
            eo_compact: 'CON â†’ SYN(unsheltered â†’ priority_1)'
          }
        ]
      },
      shelter: {
        local_label: 'Emergency shelter',
        frameworks: [
          { id: 'fb_shelter_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 â€” Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: 'Â§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ hud:hmis_3.12'},{op:'SYN',desc:'shelter â†’ code_3'}],
            eo_compact: 'CON â†’ SYN(shelter â†’ code_3)'
          },
          { id: 'fb_shelter_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: 'Â§4.1 Sheltered services',
            classification: 'Priority 3 â€” Sheltered, active case',
            classification_code: 'priority_3',
            implication: 'Maintain current case management',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ coc:outreach_priority'},{op:'SYN',desc:'shelter â†’ priority_3'}],
            eo_compact: 'CON â†’ SYN(shelter â†’ priority_3)'
          },
          { id: 'fb_shelter_pit',
            authority_id: 'auth_hud_hmis_ds',
            authority_name: 'PIT Count Methodology',
            authority_org: 'HUD Exchange',
            authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
            provision: 'PIT Sheltered Definition',
            classification: 'Sheltered â€” Emergency Shelter',
            classification_code: 'sheltered_es',
            implication: 'Counted in sheltered PIT total',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ pit:shelter_status'},{op:'SYN',desc:'shelter â†’ sheltered_es'}],
            eo_compact: 'CON â†’ SYN(shelter â†’ sheltered_es)'
          }
        ]
      },
      own_housing: {
        local_label: 'Own apartment or house (with lease)',
        frameworks: [
          { id: 'fb_own_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 â€” Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: 'N/A â€” Not homeless',
            classification: 'Not Homeless (Housed)',
            classification_code: 'housed',
            implication: 'Not eligible for CoC homeless services',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ hud:hmis_3.12'},{op:'SYN',desc:'own_housing â†’ code_1'}],
            eo_compact: 'CON â†’ SYN(own_housing â†’ code_1)'
          },
          { id: 'fb_own_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: 'Â§5.1 Housed monitoring',
            classification: 'No Priority â€” Housed',
            classification_code: 'no_priority',
            implication: 'No outreach needed',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ coc:outreach_priority'},{op:'SYN',desc:'own_housing â†’ no_priority'}],
            eo_compact: 'CON â†’ SYN(own_housing â†’ no_priority)'
          }
        ]
      },
      transitional: {
        local_label: 'Transitional housing',
        frameworks: [
          { id: 'fb_trans_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 â€” Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: 'Â§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services (in TH program)',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ hud:hmis_3.12'},{op:'SYN',desc:'transitional â†’ code_4'}],
            eo_compact: 'CON â†’ SYN(transitional â†’ code_4)'
          },
          { id: 'fb_trans_pit',
            authority_id: 'auth_hud_hmis_ds',
            authority_name: 'PIT Count Methodology',
            authority_org: 'HUD Exchange',
            authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
            provision: 'PIT Sheltered Definition',
            classification: 'Sheltered â€” Transitional Housing',
            classification_code: 'sheltered_th',
            implication: 'Counted in sheltered PIT total (TH)',
            eo_chain: [{op:'CON',desc:'sleep_location â†’ pit:shelter_status'},{op:'SYN',desc:'transitional â†’ sheltered_th'}],
            eo_compact: 'CON â†’ SYN(transitional â†’ sheltered_th)'
          }
        ]
      }
    }
  }
};

// Framework accent colors â€” secondary per-framework color for visual distinction
const FRAMEWORK_COLORS = {
  'auth_hud_578_3': {accent:'blue',label:'HUD'},
  'auth_hud_hmis_ds': {accent:'teal',label:'HMIS'},
  'auth_local_coc': {accent:'orange',label:'CoC'},
  'auth_211_airs': {accent:'green',label:'AIRS'},
  'auth_org_policy': {accent:'purple',label:'Org Policy'},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ANONYMIZATION (Â§B.2) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function anonymizeField(key, value) {
  const t = DEFAULT_TRANSFORMS[key];
  if (!t) return {key, value};
  if (t.method === 'block') return null;
  if (t.method === 'age_range' && value) {
    const age = Math.floor((Date.now()-new Date(value).getTime())/(365.25*24*60*60*1000));
    const bucket = t.buckets.find(b => {const [lo,hi]=b.split('-').map(Number);return age>=lo&&(!hi||age<=hi);});
    return {key:'age_range', value:bucket||'unknown'};
  }
  if (t.method === 'bracket' && value) {
    const num = parseFloat(String(value).replace(/[^0-9.]/g,''));
    const bucket = t.buckets.find(b => {const p=b.replace(/k/g,'000').split('-');return num>=parseFloat(p[0])&&(!p[1]||num<parseFloat(p[1]));});
    return {key:'bracket', value:bucket||t.buckets[t.buckets.length-1]};
  }
  if (t.method === 'area_hash') return {key:'geo', value:value?`area_${Math.abs([...value].reduce((h,c)=>((h<<5)-h+c.charCodeAt(0))|0,0)).toString(36).slice(0,6)}`:null};
  return {key, value};
}

async function emitMetric(metricsRoom, clientId, observation, demographics, program) {
  const hash = await cohortHash(clientId);
  const anonDemo = {};
  for (const [k,v] of Object.entries(demographics||{})) {
    const a = anonymizeField(k,v);
    if (a) anonDemo[a.key] = a.value;
  }
  const metric = { cohort_hash:hash, observation, demographics:anonDemo, program:program||'general', ts:Date.now() };
  await svc.sendEvent(metricsRoom, EVT.METRIC, metric);
  return metric;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLIENT DATA IMPORT ENGINE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Parses CSV/JSON files, maps columns to vault fields, encrypts each
 * record with its own AES-256-GCM key, creates a client_record room
 * per row, and emits only anonymized demographic metrics.
 *
 * PII GUARANTEE: Reports only ever contain demographic ranges
 * (age buckets, area hashes, counts). Raw PII (names, DOBs, SSNs,
 * addresses, emails, phones) are either blocked or bucketed before
 * any metric is emitted. The per-record encryption key is stored in
 * the E2EE room state â€” only room members can access it.
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ CSV Parser â”€â”€
// Handles quoted fields, embedded commas, and multi-line values.
function parseCSV(text) {
  const lines = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') { inQuotes = !inQuotes; current += ch; }
    else if (ch === '\n' && !inQuotes) { lines.push(current); current = ''; }
    else if (ch === '\r' && !inQuotes) { /* skip CR */ }
    else { current += ch; }
  }
  if (current.trim()) lines.push(current);
  if (lines.length < 2) throw new Error('CSV must have a header row and at least one data row');

  function parseLine(line) {
    const fields = [];
    let field = '';
    let q = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') { if (q && line[i + 1] === '"') { field += '"'; i++; } else { q = !q; } }
      else if (ch === ',' && !q) { fields.push(field.trim()); field = ''; }
      else { field += ch; }
    }
    fields.push(field.trim());
    return fields;
  }

  const headers = parseLine(lines[0]);
  const records = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const vals = parseLine(lines[i]);
    const record = {};
    headers.forEach((h, j) => { if (vals[j] !== undefined && vals[j] !== '') record[h] = vals[j]; });
    records.push(record);
  }
  return { headers, records };
}

// â”€â”€ JSON Parser â”€â”€
// Accepts an array of objects or { records: [...] } / { data: [...] }
function parseJSONImport(text) {
  const data = JSON.parse(text);
  const records = Array.isArray(data) ? data : (data.records || data.data || []);
  if (!Array.isArray(records) || records.length === 0) throw new Error('JSON must contain an array of record objects');
  const headers = [...new Set(records.flatMap(r => Object.keys(r)))];
  return { headers, records };
}

// â”€â”€ Column auto-mapping â”€â”€
// Maps common CSV/JSON header names to VAULT_FIELDS keys.
const IMPORT_COLUMN_ALIASES = {
  'name':'full_name','full_name':'full_name','fullname':'full_name','client_name':'full_name','client name':'full_name',
  'first_name':'_first_name','last_name':'_last_name','firstname':'_first_name','lastname':'_last_name',
  'dob':'dob','date_of_birth':'dob','birthdate':'dob','birth_date':'dob','birthday':'dob','date of birth':'dob',
  'ssn':'id_number','id':'id_number','id_number':'id_number','social_security':'id_number','social':'id_number',
  'email':'email','email_address':'email','e-mail':'email',
  'phone':'phone','phone_number':'phone','mobile':'phone','telephone':'phone','cell':'phone',
  'address':'address','street_address':'address','home_address':'address','street':'address','mailing_address':'address',
  'organization':'affiliation','affiliation':'affiliation','org':'affiliation','agency':'affiliation','employer':'affiliation',
  'notes':'case_notes','case_notes':'case_notes','comments':'case_notes','case notes':'case_notes',
  'history':'history','case_history':'history','case history':'history',
};

function autoMapColumns(sourceHeaders) {
  const mapping = {};
  for (const h of sourceHeaders) {
    const normalized = h.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
    const alias = IMPORT_COLUMN_ALIASES[normalized] || IMPORT_COLUMN_ALIASES[h.toLowerCase().trim()];
    if (alias && !alias.startsWith('_')) mapping[h] = alias;
  }
  return mapping;
}

// â”€â”€ Per-record encryption + room creation â”€â”€
// Creates one client_record room per row. Each record gets a unique
// AES-256-GCM key. Only anonymized demographics are emitted as metrics.
async function importClientRecords(records, mapping, metricsRoom, onProgress) {
  const results = { created: [], errors: [], demographics: {}, totalFields: 0 };
  const batchId = `batch_${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6)}`;
  const total = records.length;

  // Check for first_name + last_name concatenation
  const firstNameCol = Object.entries(mapping).find(([, v]) => v === '_first_name')?.[0];
  const lastNameCol = Object.entries(mapping).find(([, v]) => v === '_last_name')?.[0];

  for (let i = 0; i < total; i++) {
    try {
      const row = records[i];

      // Map source fields to vault fields
      const fields = {};
      for (const [sourceCol, vaultKey] of Object.entries(mapping)) {
        if (vaultKey.startsWith('_')) continue; // skip internal markers
        if (vaultKey && row[sourceCol] != null && String(row[sourceCol]).trim() !== '') {
          fields[vaultKey] = String(row[sourceCol]).trim();
        }
      }

      // Concatenate first + last name if mapped separately
      if (firstNameCol && lastNameCol) {
        const first = (row[firstNameCol] || '').trim();
        const last = (row[lastNameCol] || '').trim();
        if (first || last) fields['full_name'] = [first, last].filter(Boolean).join(' ');
      }

      if (Object.keys(fields).length === 0) {
        results.errors.push({ row: i + 1, error: 'No mapped fields with values' });
        onProgress({ current: i + 1, total });
        continue;
      }

      // Generate unique per-record AES-256-GCM key
      const recordKey = await FieldCrypto.generateKey();

      // Encrypt each field value individually
      const encryptedFields = {};
      for (const [key, value] of Object.entries(fields)) {
        const { ciphertext, iv } = await FieldCrypto.encrypt(value, recordKey);
        encryptedFields[key] = { ciphertext, iv };
      }

      // Generate anonymized demographics â€” this is the ONLY data that
      // ever appears in reports. Raw PII is blocked or bucketed.
      const anonDemo = {};
      for (const [key, value] of Object.entries(fields)) {
        const anon = anonymizeField(key, value);
        if (anon) anonDemo[anon.key] = anon.value;
      }

      // Non-PII label for room name (never store raw name in room metadata)
      const recordLabel = `Import ${batchId.slice(-4)} #${i + 1}`;

      // Create the client_record room with encrypted data
      const roomId = await svc.createRoom(
        `[Client] ${recordLabel}`,
        'Imported client record â€” encrypted at rest',
        [
          { type: EVT.IDENTITY, state_key: '', content: {
            account_type: 'client_record', owner: svc.userId, created: Date.now(),
            imported: true, import_batch: batchId, import_index: i,
            client_name: recordLabel, status: 'created',
          }},
          { type: EVT.CLIENT_RECORD, state_key: '', content: {
            record_key: recordKey,
            encrypted_fields: encryptedFields,
            demographics: anonDemo,
            imported_at: Date.now(),
            field_count: Object.keys(fields).length,
            import_batch: batchId,
          }},
        ]
      );

      // Emit anonymized metric â€” NEVER contains PII
      if (metricsRoom) {
        const hash = await cohortHash(`import_${roomId}_${batchId}`);
        await svc.sendEvent(metricsRoom, EVT.METRIC, {
          cohort_hash: hash,
          observation: { category: 'intake', value: 'imported', date_bucket: new Date().toISOString().slice(0, 7) },
          demographics: anonDemo,
          program: 'import',
          ts: Date.now(),
        });
      }

      // Accumulate demographic summary (anonymized only)
      for (const [k, v] of Object.entries(anonDemo)) {
        if (!results.demographics[k]) results.demographics[k] = {};
        results.demographics[k][v] = (results.demographics[k][v] || 0) + 1;
      }

      results.created.push({ roomId, displayName: recordLabel, fieldCount: Object.keys(fields).length });
      results.totalFields += Object.keys(fields).length;
      onProgress({ current: i + 1, total });

      // Rate-limit: pause every 2 records to avoid homeserver rate limits
      if (i % 2 === 1) await new Promise(r => setTimeout(r, 400));

    } catch (e) {
      results.errors.push({ row: i + 1, error: e.message });
      onProgress({ current: i + 1, total });
    }
  }

  // Emit import manifest to metrics room (aggregate only, no PII)
  if (metricsRoom) {
    try {
      await svc.sendEvent(metricsRoom, EVT.IMPORT_MANIFEST, {
        batch_id: batchId,
        total_records: total,
        successful: results.created.length,
        failed: results.errors.length,
        demographics_summary: results.demographics,
        ts: Date.now(),
      });
    } catch {}
  }

  return results;
}

// â”€â”€ PII masking for preview display â”€â”€
// Shows first/last char with dots in between. Sensitive fields fully masked.
function maskPII(key, value) {
  if (!value || typeof value !== 'string') return 'â€”';
  const t = DEFAULT_TRANSFORMS[key];
  if (t?.method === 'block') return '\u25CF\u25CF\u25CF\u25CF\u25CF\u25CF';
  if (t?.method === 'age_range') {
    const anon = anonymizeField(key, value);
    return anon ? `[${anon.value}]` : '\u25CF\u25CF\u25CF\u25CF';
  }
  if (t?.method === 'area_hash') {
    const anon = anonymizeField(key, value);
    return anon ? `[${anon.value}]` : '\u25CF\u25CF\u25CF\u25CF';
  }
  // Non-sensitive fields: show as-is
  const vf = VAULT_FIELDS.find(f => f.key === key);
  if (vf?.sensitive) return value.length > 2 ? value[0] + '\u25CF'.repeat(Math.min(value.length - 2, 6)) + value[value.length - 1] : '\u25CF\u25CF';
  return value;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• IMPORT DATA MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ImportDataModal = ({open, onClose, showToast, metricsRoom, onComplete}) => {
  const [step, setStep] = useState('upload');
  const [fileData, setFileData] = useState(null);
  const [mapping, setMapping] = useState({});
  const [progress, setProgress] = useState({current:0, total:0});
  const [results, setResults] = useState(null);
  const [dragOver, setDragOver] = useState(false);
  const fileRef = useRef(null);

  // Reset state when modal closes
  useEffect(() => {
    if (!open) { setStep('upload'); setFileData(null); setMapping({}); setProgress({current:0,total:0}); setResults(null); }
  }, [open]);

  const handleFile = async (file) => {
    try {
      const text = await file.text();
      const isJSON = file.name.endsWith('.json') || file.type === 'application/json';
      const parsed = isJSON ? parseJSONImport(text) : parseCSV(text);
      if (parsed.records.length === 0) throw new Error('No records found in file');
      setFileData({ ...parsed, fileName: file.name, fileType: isJSON ? 'JSON' : 'CSV' });
      // Auto-map columns
      const autoMap = autoMapColumns(parsed.headers);
      setMapping(autoMap);
      setStep('map');
    } catch (e) {
      showToast('Parse error: ' + e.message, 'error');
    }
  };

  const handleDrop = (e) => {
    e.preventDefault(); setDragOver(false);
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  };

  const mappedFieldCount = Object.values(mapping).filter(v => v && !v.startsWith('_')).length;
  const hasMappedFields = mappedFieldCount > 0;

  // Count how many columns map to each vault field (detect duplicates)
  const vaultFieldUsage = {};
  for (const v of Object.values(mapping)) {
    if (v && !v.startsWith('_')) vaultFieldUsage[v] = (vaultFieldUsage[v] || 0) + 1;
  }

  const handleImport = async () => {
    if (!fileData || !hasMappedFields) return;
    setStep('importing');
    setProgress({ current: 0, total: fileData.records.length });
    try {
      const res = await importClientRecords(
        fileData.records, mapping, metricsRoom,
        (p) => setProgress(p)
      );
      setResults(res);
      setStep('done');
      if (onComplete) onComplete(res);
    } catch (e) {
      showToast('Import failed: ' + e.message, 'error');
      setStep('preview');
    }
  };

  if (!open) return null;

  return <Modal open={open} onClose={step === 'importing' ? undefined : onClose} title="Import Client Data" w={720}>

    {/* â”€â”€ STEP 1: UPLOAD â”€â”€ */}
    {step === 'upload' && <div>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Upload a CSV or JSON file containing client records. Each row becomes an encrypted client room with its own AES-256-GCM key. PII is never stored in any reportable format.
      </p>
      <div onDragOver={(e)=>{e.preventDefault();setDragOver(true)}} onDragLeave={()=>setDragOver(false)} onDrop={handleDrop}
        onClick={()=>fileRef.current?.click()}
        style={{border:`2px dashed ${dragOver?'var(--gold)':'var(--border-1)'}`,borderRadius:'var(--r-lg)',
          padding:'48px 24px',textAlign:'center',cursor:'pointer',transition:'all .2s',
          background:dragOver?'var(--gold-dim)':'var(--bg-1)'}}>
        <div style={{width:48,height:48,borderRadius:'var(--r-lg)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',margin:'0 auto 14px'}}>
          <I n="upload" s={24}/>
        </div>
        <p style={{fontSize:14,fontWeight:600,marginBottom:4}}>Drop CSV or JSON file here</p>
        <p style={{fontSize:12,color:'var(--tx-2)'}}>or click to browse</p>
        <div style={{display:'flex',gap:6,justifyContent:'center',marginTop:12}}>
          <span className="tag tag-blue">.csv</span>
          <span className="tag tag-teal">.json</span>
        </div>
      </div>
      <input ref={fileRef} type="file" accept=".csv,.json,application/json,text/csv" style={{display:'none'}}
        onChange={(e)=>{if(e.target.files[0])handleFile(e.target.files[0])}}/>
      <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginTop:16,display:'flex',gap:10,alignItems:'flex-start'}}>
        <I n="shield" s={16} c="var(--teal)"/>
        <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--teal)'}}>Encryption guarantee:</strong> Each record gets a unique AES-256-GCM encryption key. PII fields (name, DOB, SSN, address, phone, email) are encrypted before storage. Reports only contain demographic ranges â€” never raw PII.
        </div>
      </div>
    </div>}

    {/* â”€â”€ STEP 2: MAP COLUMNS â”€â”€ */}
    {step === 'map' && fileData && <div>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:14}}>
        <div>
          <p style={{fontSize:12.5,fontWeight:600}}>{fileData.fileName}</p>
          <p style={{fontSize:11,color:'var(--tx-2)'}}>{fileData.fileType} Â· {fileData.records.length} records Â· {fileData.headers.length} columns</p>
        </div>
        <button onClick={()=>{setStep('upload');setFileData(null);setMapping({})}} className="b-gho b-xs">Change File</button>
      </div>

      <span className="section-label">MAP COLUMNS TO VAULT FIELDS</span>
      <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Assign each source column to a vault field. Unmapped columns are skipped. Fields marked with a lock are encrypted at rest.</p>

      <div style={{maxHeight:340,overflow:'auto',marginBottom:16}}>
        {fileData.headers.map(h => {
          const currentMapping = mapping[h] || '';
          const vf = VAULT_FIELDS.find(f => f.key === currentMapping);
          const transform = DEFAULT_TRANSFORMS[currentMapping];
          const sampleVal = fileData.records.slice(0, 3).map(r => r[h]).filter(Boolean)[0];
          return <div key={h} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 0',borderBottom:'1px solid var(--border-0)'}}>
            <div style={{flex:1,minWidth:0}}>
              <span style={{fontSize:12,fontWeight:500,display:'block'}}>{h}</span>
              {sampleVal && <span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)',display:'block',marginTop:2,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                e.g. {String(sampleVal).slice(0, 40)}{String(sampleVal).length > 40 ? 'â€¦' : ''}
              </span>}
            </div>
            <I n="chevR" s={12} c="var(--tx-3)"/>
            <div style={{flex:1,minWidth:0}}>
              <select value={currentMapping} onChange={e=>setMapping(prev=>({...prev,[h]:e.target.value}))}
                style={{width:'100%',fontSize:12,padding:'7px 10px'}}>
                <option value="">â€” skip â€”</option>
                {VAULT_FIELDS.map(f => <option key={f.key} value={f.key}>
                  {f.label}{f.sensitive ? ' ğŸ”’' : ''}{transform?.method === 'block' ? ' (blocked in reports)' : ''}
                </option>)}
                <option value="_first_name">First Name (will combine)</option>
                <option value="_last_name">Last Name (will combine)</option>
              </select>
            </div>
            <div style={{width:60,textAlign:'center'}}>
              {currentMapping && !currentMapping.startsWith('_') && transform?.method === 'block' &&
                <span className="tag tag-red" style={{fontSize:8}}>BLOCKED</span>}
              {currentMapping && !currentMapping.startsWith('_') && transform?.method === 'age_range' &&
                <span className="tag tag-blue" style={{fontSize:8}}>RANGED</span>}
              {currentMapping && !currentMapping.startsWith('_') && vf?.sensitive &&
                <span className="tag tag-green" style={{fontSize:8}}>ENCRYPT</span>}
              {currentMapping && !currentMapping.startsWith('_') && !transform && !vf?.sensitive &&
                <span className="tag tag-teal" style={{fontSize:8}}>STORED</span>}
            </div>
          </div>;
        })}
      </div>

      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:16}}>
        <div className="card" style={{padding:12}}>
          <span className="section-label">MAPPED</span>
          <span style={{fontSize:18,fontWeight:700,color:'var(--gold)'}}>{mappedFieldCount}</span>
          <span style={{fontSize:11,color:'var(--tx-2)'}}> of {fileData.headers.length} columns</span>
        </div>
        <div className="card" style={{padding:12}}>
          <span className="section-label">REPORT VISIBILITY</span>
          <div style={{display:'flex',gap:3,flexWrap:'wrap',marginTop:4}}>
            {Object.values(mapping).filter(v=>v&&!v.startsWith('_')).map(v => {
              const t = DEFAULT_TRANSFORMS[v];
              const vf = VAULT_FIELDS.find(f=>f.key===v);
              return <span key={v} className={`tag ${t?.method==='block'?'tag-red':t?.method==='age_range'?'tag-blue':'tag-teal'}`} style={{fontSize:8}}>
                {vf?.label||v}: {t?.method==='block'?'NEVER':t?.method==='age_range'?'RANGE ONLY':'visible'}
              </span>;
            })}
          </div>
        </div>
      </div>

      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setStep('upload')} className="b-gho" style={{flex:1}}>Back</button>
        <button onClick={()=>setStep('preview')} className="b-pri" disabled={!hasMappedFields} style={{flex:2}}>
          Preview {fileData.records.length} Records
        </button>
      </div>
    </div>}

    {/* â”€â”€ STEP 3: PREVIEW â”€â”€ */}
    {step === 'preview' && fileData && <div>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
        Review how records will be stored. PII fields are masked below as they will be in reports. The actual data is encrypted per-record and only accessible to room members.
      </p>

      <div style={{overflowX:'auto',marginBottom:16}}>
        <table style={{width:'100%',borderCollapse:'collapse',fontSize:11.5}}>
          <thead>
            <tr style={{borderBottom:'2px solid var(--border-1)'}}>
              <th style={{padding:'8px 10px',textAlign:'left',fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-2)',letterSpacing:'.05em'}}>#</th>
              {Object.entries(mapping).filter(([,v])=>v&&!v.startsWith('_')).map(([src,vk])=>{
                const vf = VAULT_FIELDS.find(f=>f.key===vk);
                const t = DEFAULT_TRANSFORMS[vk];
                return <th key={src} style={{padding:'8px 10px',textAlign:'left',whiteSpace:'nowrap'}}>
                  <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.05em'}}>{vf?.label||vk}</span>
                  {t?.method==='block'&&<span className="tag tag-red" style={{fontSize:7,marginLeft:4}}>BLOCKED</span>}
                  {vf?.sensitive&&!t&&<span className="tag tag-green" style={{fontSize:7,marginLeft:4}}>ENC</span>}
                </th>;
              })}
              <th style={{padding:'8px 10px',textAlign:'left',fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-2)'}}>DEMOGRAPHICS</th>
            </tr>
          </thead>
          <tbody>
            {fileData.records.slice(0, 5).map((row, i) => {
              // Build mapped fields for this row
              const fields = {};
              for (const [src, vk] of Object.entries(mapping)) {
                if (vk && !vk.startsWith('_') && row[src] != null) fields[vk] = String(row[src]);
              }
              // Handle first+last name
              const fnCol = Object.entries(mapping).find(([,v])=>v==='_first_name')?.[0];
              const lnCol = Object.entries(mapping).find(([,v])=>v==='_last_name')?.[0];
              if (fnCol && lnCol) {
                const combined = [(row[fnCol]||'').trim(), (row[lnCol]||'').trim()].filter(Boolean).join(' ');
                if (combined) fields['full_name'] = combined;
              }
              // Anonymize for demographic preview
              const anonDemo = {};
              for (const [k, v] of Object.entries(fields)) {
                const anon = anonymizeField(k, v);
                if (anon) anonDemo[anon.key] = anon.value;
              }
              return <tr key={i} style={{borderBottom:'1px solid var(--border-0)'}}>
                <td style={{padding:'6px 10px',color:'var(--tx-3)',fontFamily:'var(--mono)',fontSize:10}}>{i+1}</td>
                {Object.entries(mapping).filter(([,v])=>v&&!v.startsWith('_')).map(([src,vk])=>{
                  const val = vk==='full_name'&&fields['full_name']?fields['full_name']:row[src];
                  return <td key={src} style={{padding:'6px 10px',fontSize:11,maxWidth:160,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                    {maskPII(vk, val ? String(val) : '')}
                  </td>;
                })}
                <td style={{padding:'6px 10px'}}>
                  <div style={{display:'flex',gap:3,flexWrap:'wrap'}}>
                    {Object.entries(anonDemo).map(([k,v])=>
                      <span key={k} className="tag tag-blue" style={{fontSize:8}}>{k}: {v||'â€”'}</span>
                    )}
                    {Object.keys(anonDemo).length===0&&<span style={{fontSize:10,color:'var(--tx-3)'}}>â€”</span>}
                  </div>
                </td>
              </tr>;
            })}
          </tbody>
        </table>
        {fileData.records.length > 5 && <p style={{fontSize:11,color:'var(--tx-3)',textAlign:'center',padding:8}}>
          â€¦and {fileData.records.length - 5} more records
        </p>}
      </div>

      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:16}}>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">RECORDS</span>
          <span style={{fontSize:18,fontWeight:700,display:'block'}}>{fileData.records.length}</span>
        </div>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">ENCRYPTED FIELDS</span>
          <span style={{fontSize:18,fontWeight:700,color:'var(--green)',display:'block'}}>{mappedFieldCount}</span>
        </div>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">ROOMS TO CREATE</span>
          <span style={{fontSize:18,fontWeight:700,color:'var(--gold)',display:'block'}}>{fileData.records.length}</span>
        </div>
      </div>

      <div style={{background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginBottom:16,display:'flex',gap:10,alignItems:'flex-start'}}>
        <I n="eyeOff" s={16} c="var(--red)"/>
        <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--red)'}}>PII will NEVER appear in reports.</strong> Names, DOBs, SSNs, addresses, phones, and emails are either blocked entirely or converted to demographic ranges (age buckets, area hashes). Only anonymized aggregates flow to the metrics system.
        </div>
      </div>

      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setStep('map')} className="b-gho" style={{flex:1}}>Back</button>
        <button onClick={handleImport} className="b-pri" style={{flex:2,padding:12,fontSize:14}}>
          <I n="lock" s={15}/> Encrypt &amp; Import {fileData.records.length} Records
        </button>
      </div>
    </div>}

    {/* â”€â”€ STEP 4: IMPORTING â”€â”€ */}
    {step === 'importing' && <div style={{textAlign:'center',padding:'20px 0'}}>
      <Spin s={32}/>
      <p style={{fontSize:15,fontWeight:600,marginTop:16}}>Encrypting &amp; creating rooms...</p>
      <p style={{fontSize:12,color:'var(--tx-2)',marginTop:6}}>Record {progress.current} of {progress.total}</p>
      <div style={{background:'var(--bg-3)',borderRadius:8,height:8,overflow:'hidden',marginTop:16,maxWidth:400,margin:'16px auto 0'}}>
        <div style={{height:'100%',background:'var(--gold)',borderRadius:8,transition:'width .3s',
          width:`${progress.total?((progress.current/progress.total)*100):0}%`}}/>
      </div>
      <div style={{display:'flex',gap:12,justifyContent:'center',marginTop:20}}>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <I n="lock" s={12} c="var(--green)"/><span style={{fontSize:11,color:'var(--tx-2)'}}>AES-256-GCM per record</span>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <I n="shield" s={12} c="var(--teal)"/><span style={{fontSize:11,color:'var(--tx-2)'}}>E2EE rooms</span>
        </div>
      </div>
    </div>}

    {/* â”€â”€ STEP 5: DONE â”€â”€ */}
    {step === 'done' && results && <div>
      <div style={{textAlign:'center',marginBottom:20}}>
        <div style={{width:48,height:48,borderRadius:'50%',background:'var(--green-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--green)',margin:'0 auto 12px'}}>
          <I n="check" s={24}/>
        </div>
        <p style={{fontSize:18,fontWeight:700}}>Import Complete</p>
        <p style={{fontSize:12,color:'var(--tx-2)',marginTop:4}}>
          {results.created.length} records encrypted &amp; stored Â· {results.errors.length} errors
        </p>
      </div>

      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:16}}>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">IMPORTED</span>
          <span style={{fontSize:20,fontWeight:700,color:'var(--green)',display:'block'}}>{results.created.length}</span>
        </div>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">ENCRYPTED FIELDS</span>
          <span style={{fontSize:20,fontWeight:700,color:'var(--gold)',display:'block'}}>{results.totalFields}</span>
        </div>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">ERRORS</span>
          <span style={{fontSize:20,fontWeight:700,color:results.errors.length?'var(--red)':'var(--tx-2)',display:'block'}}>{results.errors.length}</span>
        </div>
      </div>

      {/* DEMOGRAPHIC SUMMARY â€” This is the ONLY reportable data */}
      {Object.keys(results.demographics).length > 0 && <div className="card" style={{marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
          <span className="section-label" style={{marginBottom:0}}>DEMOGRAPHIC SUMMARY (ANONYMIZED)</span>
          <span className="tag tag-teal" style={{fontSize:8}}>REPORT-SAFE</span>
        </div>
        <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>This is the only data available for reporting. No PII is present â€” only demographic ranges and hashed areas.</p>
        {Object.entries(results.demographics).map(([category, values]) => <div key={category} style={{marginBottom:10}}>
          <span style={{fontSize:11,fontWeight:600,color:'var(--tx-1)',textTransform:'uppercase',fontFamily:'var(--mono)',letterSpacing:'.05em',display:'block',marginBottom:4}}>{category}</span>
          <div style={{display:'flex',flexDirection:'column',gap:3}}>
            {Object.entries(values).sort((a,b)=>b[1]-a[1]).map(([val, count]) => {
              const max = Math.max(...Object.values(values));
              return <div key={val} style={{display:'flex',alignItems:'center',gap:8}}>
                <span style={{fontSize:11,width:140,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',color:'var(--tx-1)'}}>{val || 'â€”'}</span>
                <div style={{flex:1,height:14,background:'var(--bg-3)',borderRadius:3,overflow:'hidden'}}>
                  <div style={{width:`${(count/max)*100}%`,height:'100%',background:'var(--teal)',borderRadius:3,transition:'width .3s'}}/>
                </div>
                <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-1)',minWidth:24,textAlign:'right'}}>{count}</span>
              </div>;
            })}
          </div>
        </div>)}
      </div>}

      {results.errors.length > 0 && <div className="card" style={{marginBottom:16}}>
        <span className="section-label">ERRORS</span>
        <div style={{maxHeight:120,overflow:'auto',marginTop:4}}>
          {results.errors.map((e, i) => <div key={i} style={{fontSize:11,color:'var(--red)',padding:'4px 0',borderBottom:'1px solid var(--border-0)'}}>
            Row {e.row}: {e.error}
          </div>)}
        </div>
      </div>}

      <div style={{background:'var(--green-dim)',border:'1px solid rgba(61,214,140,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginBottom:16,display:'flex',gap:10,alignItems:'flex-start'}}>
        <I n="shieldCheck" s={16} c="var(--green)"/>
        <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--green)'}}>No PII in reports.</strong> All {results.created.length} records are individually encrypted with unique AES-256-GCM keys. The demographic summary above shows only anonymized ranges â€” this is the maximum granularity available for any report. Names, dates of birth, SSNs, addresses, phones, and emails are cryptographically blocked from reporting.
        </div>
      </div>

      <button onClick={onClose} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
        <I n="check" s={15}/> Done â€” View Clients
      </button>
    </div>}
  </Modal>;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SMALL COMPONENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Spin = ({s=18}) => <div style={{width:s,height:s,border:'2px solid var(--border-1)',borderTopColor:'var(--gold)',borderRadius:'50%',animation:'spin .6s linear infinite'}} />;

const Modal = ({open,onClose,title,w=480,children}) => {
  if (!open) return null;
  return <div style={{position:'fixed',inset:0,zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(0,0,0,.75)',backdropFilter:'blur(6px)'}} onClick={onClose}>
    <div className="anim-up" onClick={e=>e.stopPropagation()} style={{background:'var(--bg-2)',border:'1px solid var(--border-1)',borderRadius:'var(--r-lg)',width:'92%',maxWidth:w,maxHeight:'88vh',overflow:'auto',padding:28}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
        <h3 style={{fontSize:16,fontWeight:700}}>{title}</h3>
        <button onClick={onClose} style={{background:'transparent',color:'var(--tx-2)',padding:4}}><I n="x" s={17}/></button>
      </div>
      {children}
    </div>
  </div>;
};

const Toggle = ({on,onChange,disabled}) => (
  <div className={`toggle-track ${on?'on':'off'}`} onClick={disabled?undefined:onChange} style={disabled?{opacity:.4,cursor:'default'}:{}}>
    <div className="toggle-knob"/>
  </div>
);

const Toast = ({msg,type='info',onClose}) => {
  useEffect(()=>{const t=setTimeout(onClose,3500);return()=>clearTimeout(t)},[]);
  const c = {info:'var(--blue)',success:'var(--green)',error:'var(--red)',warn:'var(--gold)'}[type];
  return <div className="anim-up" style={{position:'fixed',bottom:20,right:20,zIndex:9999,background:'var(--bg-2)',border:`1px solid ${c}30`,borderLeft:`3px solid ${c}`,borderRadius:'var(--r)',padding:'11px 18px',fontSize:12.5,boxShadow:'0 8px 32px rgba(0,0,0,.5)',maxWidth:400}}>{msg}</div>;
};

const OP_COLORS = {INS:'green',ALT:'blue',DES:'gold',SEG:'teal',NUL:'red',REC:'orange',CON:'blue',SYN:'purple',SUP:'gold'};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MVP BADGE COMPONENTS (Â§Screen 4) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Maturity badge: Draft / Trial / Normative / De facto / Deprecated
const MaturityBadge = ({maturity, size='sm'}) => {
  const level = MATURITY_LEVELS[maturity];
  if (!level) return null;
  const pad = size === 'lg' ? '3px 10px' : '2px 7px';
  const fs = size === 'lg' ? 11 : 9.5;
  return <span className={`tag tag-${level.color}`} style={{fontSize:fs, padding:pad}} title={level.desc}>
    {level.label}
  </span>;
};

// Source badge: Network (with propagation level) or Local
const SourceBadge = ({source}) => {
  if (!source) return <span className="tag tag-purple" style={{fontSize:9}}>Local</span>;
  if (source.level === 'local') return <span className="tag tag-purple" style={{fontSize:9}}>Local</span>;
  const prop = PROPAGATION_LEVELS[source.propagation];
  return <span className={`tag tag-${prop?.color || 'blue'}`} style={{fontSize:9}} title={`${source.propagation}: ${prop?.desc || ''}`}>
    Network &middot; {prop?.label || source.propagation}
  </span>;
};

// Consent gradient â€” not a vote count, a distribution of positions
const ConsentGradient = ({positions = {}, totalOrgs = 0}) => {
  const counts = {};
  let responded = 0;
  for (const [orgId, pos] of Object.entries(positions)) {
    if (pos) { const p = pos.position || 'pending'; counts[p] = (counts[p] || 0) + 1; responded++; }
  }
  const pending = totalOrgs - responded;
  const segments = [
    { key: 'adopt_as_is', count: counts.adopt_as_is || 0, ...CONSENT_POSITIONS.adopt_as_is },
    { key: 'adopt_with_extension', count: counts.adopt_with_extension || 0, ...CONSENT_POSITIONS.adopt_with_extension },
    { key: 'needs_modification', count: counts.needs_modification || 0, ...CONSENT_POSITIONS.needs_modification },
    { key: 'cannot_adopt', count: counts.cannot_adopt || 0, ...CONSENT_POSITIONS.cannot_adopt },
  ];
  const hasBlock = (counts.cannot_adopt || 0) > 0;
  return <div style={{marginTop:8}}>
    <div style={{display:'flex',height:8,borderRadius:4,overflow:'hidden',background:'var(--bg-3)',gap:1}}>
      {segments.map(seg => seg.count > 0 ? <div key={seg.key} style={{
        flex: seg.count, background: `var(--${seg.color})`, transition: 'flex .3s',
      }} title={`${seg.label}: ${seg.count}`}/> : null)}
      {pending > 0 && <div style={{flex:pending,background:'var(--border-1)'}} title={`Pending: ${pending}`}/>}
    </div>
    <div style={{display:'flex',gap:10,marginTop:6,flexWrap:'wrap'}}>
      {segments.filter(s=>s.count>0).map(s=><div key={s.key} style={{display:'flex',alignItems:'center',gap:4}}>
        <div style={{width:8,height:8,borderRadius:2,background:`var(--${s.color})`}}/>
        <span style={{fontSize:10,color:'var(--tx-1)'}}>{s.icon} {s.label} ({s.count})</span>
      </div>)}
      {pending > 0 && <div style={{display:'flex',alignItems:'center',gap:4}}>
        <div style={{width:8,height:8,borderRadius:2,background:'var(--border-1)'}}/>
        <span style={{fontSize:10,color:'var(--tx-3)'}}>Pending ({pending})</span>
      </div>}
    </div>
    {hasBlock && <div style={{marginTop:6,padding:'6px 10px',background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.2)',borderRadius:'var(--r)',fontSize:11,color:'var(--red)'}}>
      Block registered â€” structured objection required before proceeding
    </div>}
  </div>;
};

// De facto field detection alert
const DeFactoAlert = ({fieldName, orgCount, totalOrgs, onFormalize, onDismiss}) => (
  <div className="card anim-up" style={{padding:'14px 18px',borderColor:'var(--gold)',borderLeft:'3px solid var(--gold)'}}>
    <div style={{display:'flex',alignItems:'flex-start',gap:10}}>
      <div style={{width:32,height:32,borderRadius:'var(--r)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',flexShrink:0}}><I n="zap" s={16}/></div>
      <div style={{flex:1}}>
        <div style={{fontSize:13,fontWeight:600,marginBottom:2}}>De facto standard detected</div>
        <div style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.5}}>
          {orgCount} of {totalOrgs} orgs have a "{fieldName}" field. Formalize as network standard?
        </div>
        <div style={{display:'flex',gap:8,marginTop:10}}>
          <button onClick={onFormalize} className="b-pri b-sm">Propose Formalization</button>
          <button onClick={onDismiss} className="b-gho b-sm">Dismiss</button>
        </div>
      </div>
    </div>
  </div>
);

// Adoption metrics bar (ambient monitoring)
const AdoptionMetrics = ({adopted, total, extensions, divergences}) => (
  <div className="card" style={{padding:14}}>
    <span className="section-label">SCHEMA ADOPTION</span>
    <div style={{display:'flex',alignItems:'baseline',gap:6,marginTop:4}}>
      <span style={{fontSize:22,fontWeight:700,color:'var(--green)'}}>{adopted}</span>
      <span style={{fontSize:13,color:'var(--tx-2)'}}>of {total} network fields adopted</span>
    </div>
    <div style={{display:'flex',height:6,borderRadius:3,overflow:'hidden',background:'var(--bg-3)',marginTop:8,gap:1}}>
      {adopted > 0 && <div style={{flex:adopted,background:'var(--green)'}}/>}
      {extensions > 0 && <div style={{flex:extensions,background:'var(--blue)'}}/>}
      {divergences > 0 && <div style={{flex:divergences,background:'var(--gold)'}}/>}
      {(total - adopted - (extensions||0) - (divergences||0)) > 0 && <div style={{flex:total - adopted - (extensions||0) - (divergences||0),background:'var(--border-1)'}}/>}
    </div>
    <div style={{display:'flex',gap:12,marginTop:6,fontSize:10,color:'var(--tx-2)'}}>
      {extensions > 0 && <span style={{color:'var(--blue)'}}>{extensions} with extensions</span>}
      {divergences > 0 && <span style={{color:'var(--gold)'}}>{divergences} diverged</span>}
    </div>
  </div>
);

// Governance proposal card (MVP Â§Screen 5)
const ProposalCard = ({proposal, onRespond}) => {
  const status = PROPOSAL_STATUSES[proposal.status] || PROPOSAL_STATUSES.submitted;
  const targetProp = PROPAGATION_LEVELS[proposal.target_propagation];
  const targetMat = MATURITY_LEVELS[proposal.target_maturity];
  const positionEntries = Object.entries(proposal.positions || {});
  const totalOrgs = positionEntries.length;
  return <div className="card" style={{padding:0,overflow:'hidden',marginBottom:10}}>
    <div style={{padding:'14px 18px',borderBottom:'1px solid var(--border-0)'}}>
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6,flexWrap:'wrap'}}>
        <span className={`tag tag-${status.color}`}>{status.label}</span>
        {targetProp && <SourceBadge source={{level:'network',propagation:proposal.target_propagation}}/>}
        {targetMat && <MaturityBadge maturity={proposal.target_maturity}/>}
      </div>
      <div style={{fontSize:14,fontWeight:600,marginBottom:4}}>{proposal.summary}</div>
      {proposal.detail && <div style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.5}}>{proposal.detail}</div>}
      <div style={{display:'flex',gap:12,marginTop:8,fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>
        <span>By: {proposal.proposed_by}</span>
        {proposal.governance_rhythm && <span>{proposal.governance_rhythm}</span>}
        {proposal.deadline && <span>Due: {new Date(proposal.deadline).toLocaleDateString()}</span>}
      </div>
    </div>
    <div style={{padding:'10px 18px'}}>
      <ConsentGradient positions={proposal.positions} totalOrgs={totalOrgs}/>
      {onRespond && proposal.status === 'consent_round' && <div style={{marginTop:10}}>
        <button onClick={onRespond} className="b-pri b-sm">Review & Respond</button>
      </div>}
    </div>
  </div>;
};

// Governance calendar display
const GovernanceCalendar = ({rhythms = Object.values(GOV_RHYTHMS)}) => (
  <div className="card" style={{padding:16}}>
    <span className="section-label">GOVERNANCE CALENDAR</span>
    <div style={{display:'flex',flexDirection:'column',gap:8,marginTop:8}}>
      {rhythms.map(r => <div key={r.id} style={{display:'flex',alignItems:'center',gap:12,padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
        <div style={{width:36,height:36,borderRadius:'var(--r)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',flexShrink:0}}>
          <I n="clock" s={16}/>
        </div>
        <div style={{flex:1}}>
          <div style={{fontSize:13,fontWeight:600}}>{r.name}</div>
          <div style={{fontSize:10.5,color:'var(--tx-2)',marginTop:2}}>{r.frequency} &middot; {r.duration_days} day window &middot; {r.participants}</div>
        </div>
      </div>)}
    </div>
  </div>
);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GIVEN/MEANT DIVIDE VISUALIZATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Core visualization: observation on the left, crossing in the middle, frameworks on the right
const GivenMeantDivide = ({observation, compact = false}) => {
  // observation: {prompt, value, valueLabel, reporter, timestamp, eoTrace, frameworks}
  const [expandedChains, setExpandedChains] = useState(new Set());
  const toggleChain = (id) => setExpandedChains(p => {const n = new Set(p); n.has(id) ? n.delete(id) : n.add(id); return n;});

  if (!observation) return null;
  const {prompt, value, valueLabel, reporter, timestamp, eoTrace, frameworks} = observation;

  // Detect divergence: do frameworks classify differently?
  const classifications = frameworks?.map(f => f.classification) || [];
  const uniqueClassifications = [...new Set(classifications)];
  const hasDivergence = uniqueClassifications.length > 1;

  // Collect all unique EO ops used in the crossing
  const crossingOps = new Set();
  (frameworks || []).forEach(f => (f.eo_chain || []).forEach(s => crossingOps.add(s.op)));

  return <div className="gm-container anim-up" style={compact ? {minHeight:'auto'} : {}}>
    {/* LEFT â€” GIVEN */}
    <div className="gm-given" style={compact ? {flex:'0 0 280px',padding:14} : {}}>
      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:10}}>
        <span className="tag tag-teal" style={{fontSize:9}}>GIVEN</span>
        <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)'}}>OBSERVATION</span>
      </div>
      {prompt && <div className="gm-obs-field">{prompt}</div>}
      <div className="gm-obs-value">{valueLabel || value}</div>
      <div className="gm-meta-row">
        {reporter && <span>{reporter}</span>}
        {timestamp && <span>{new Date(timestamp).toLocaleDateString()}</span>}
      </div>
      {eoTrace && <div className="gm-eo-trace">{eoTrace}</div>}
      {!compact && <div style={{marginTop:12,padding:'8px 10px',background:'var(--bg-3)',borderRadius:'var(--r)',fontSize:10.5,color:'var(--tx-2)',lineHeight:1.5}}>
        This is ground truth. The observation just <em>is</em>. Everything to the right is what it <em>means</em>, according to whom.
      </div>}
    </div>

    {/* CROSSING */}
    <div className="gm-crossing">
      <div className="gm-crossing-arrow" title="Epistemic crossing: observation becomes interpretation">&#8594;</div>
      <div className="gm-crossing-label">GIVEN &#8594; MEANT</div>
      {[...crossingOps].map(op => <div key={op} className="gm-crossing-op" style={{
        background: `var(--${OP_COLORS[op]||'blue'}-dim)`,
        color: `var(--${OP_COLORS[op]||'blue'})`,
        borderColor: `var(--${OP_COLORS[op]||'blue'})20`
      }}>{op}</div>)}
    </div>

    {/* RIGHT â€” MEANT */}
    <div className="gm-meant" style={compact ? {padding:14} : {}}>
      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4}}>
        <span className="tag tag-gold" style={{fontSize:9}}>MEANT</span>
        <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)'}}>FRAMEWORK INTERPRETATIONS ({frameworks?.length || 0})</span>
      </div>

      {hasDivergence && <div className="gm-divergence">
        <span style={{color:'var(--gold)',fontWeight:700,fontSize:13,lineHeight:1}}>&#9670;</span>
        <div>
          <strong style={{color:'var(--gold)',fontSize:11}}>Frameworks diverge</strong>
          <span style={{display:'block',fontSize:10,color:'var(--tx-2)',marginTop:2}}>
            {uniqueClassifications.length} distinct classifications from the same observation.
            This is SUP made visible â€” the value exists in superposition across frameworks.
          </span>
        </div>
      </div>}

      {(frameworks || []).map((fw, i) => {
        const fwColor = FRAMEWORK_COLORS[fw.authority_id] || {accent:'purple',label:'?'};
        const isExpanded = expandedChains.has(fw.id);
        return <div key={fw.id || i} className="gm-fw-card" data-accent={fwColor.accent}>
          <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:8}}>
            <div style={{flex:1,minWidth:0}}>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4,flexWrap:'wrap'}}>
                <span className={`tag tag-${fwColor.accent}`} style={{fontSize:8.5}}>{fw.authority_org}</span>
                <span style={{fontSize:12,fontWeight:600}}>{fw.authority_name}</span>
              </div>
              <div style={{fontSize:14,fontWeight:700,color:'var(--gold)',marginBottom:4}}>{fw.classification}</div>
              {fw.provision && <div style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',marginBottom:4}}>{fw.provision}</div>}
              {fw.authority_uri && <a href={fw.authority_uri} target="_blank" rel="noopener"
                style={{fontSize:9.5,fontFamily:'var(--mono)',color:'var(--blue)',display:'block',marginBottom:4,
                  overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',textDecoration:'none',maxWidth:'100%'}}>
                {fw.authority_uri}</a>}
              {fw.implication && <div style={{fontSize:11,color:'var(--tx-1)',padding:'4px 8px',background:'var(--bg-3)',
                borderRadius:'var(--r)',display:'inline-block',marginTop:2}}>
                {fw.implication}
              </div>}
            </div>
          </div>

          {/* EO chain */}
          <div style={{marginTop:8,borderTop:'1px solid var(--border-0)',paddingTop:8}}>
            <div onClick={() => toggleChain(fw.id)} style={{cursor:'pointer',display:'flex',alignItems:'center',gap:4}}>
              <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--tx-3)'}}>EO CHAIN</span>
              <I n={isExpanded ? 'x' : 'chevR'} s={9} c="var(--tx-3)"/>
            </div>
            {!isExpanded && fw.eo_compact && <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--purple)',marginTop:3}}>{fw.eo_compact}</div>}
            {isExpanded && <div className="gm-chain">
              {(fw.eo_chain || []).map((step, si) => <React.Fragment key={si}>
                {si > 0 && <span style={{color:'var(--tx-3)',fontSize:10}}>&#8594;</span>}
                <span className="gm-chain-step" style={{
                  background: `var(--${OP_COLORS[step.op]||'blue'}-dim)`,
                  color: `var(--${OP_COLORS[step.op]||'blue'})`
                }}>
                  {step.op}({step.desc})
                </span>
              </React.Fragment>)}
            </div>}
          </div>
        </div>;
      })}

      {(!frameworks || frameworks.length === 0) && <div className="gm-wb-empty">
        <I n="grid" s={24}/>
        <p style={{marginTop:8,fontSize:12}}>No frameworks bound</p>
        <p style={{fontSize:10.5,color:'var(--tx-3)',marginTop:4}}>This observation is recorded but not yet interpreted.</p>
      </div>}
    </div>
  </div>;
};

// Record-level GIVEN/MEANT display for a specific client observation
const RecordGivenMeant = ({promptKey, value, reporter, timestamp}) => {
  const prompt = DEFAULT_PROMPTS.find(p => p.key === promptKey);
  if (!prompt) return null;
  const option = prompt.options?.find(o => o.v === value);
  const binding = FRAMEWORK_BINDINGS[promptKey]?.bindings?.[value];

  const observation = {
    prompt: prompt.question,
    value: value,
    valueLabel: option?.l || value,
    reporter: reporter || 'Client self-report',
    timestamp: timestamp,
    eoTrace: prompt.eo?.trace,
    frameworks: binding?.frameworks || []
  };

  return <GivenMeantDivide observation={observation} compact={true}/>;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCHEMA WORKBENCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SWC_DARK = {
  bg: "#07090d", surface: "#0e1218", raised: "#151b23", hover: "#1b2330",
  border: "#1d2735", borderLit: "#2c3d52", text: "#c0c9d4", muted: "#7a8da0",
  dim: "#4a5d72", white: "#edf0f5",
  given: "#2dd4a0", givenBorder: "#18694e",
  meant: "#a78bfa", meantBorder: "#4a2d8a",
  fw: ["#60a5fa","#f0abfc","#fbbf24","#34d399","#fb7185"],
  fwBg: i => `${["#60a5fa","#f0abfc","#fbbf24","#34d399","#fb7185"][i%5]}12`,
  fwBorder: i => `${["#60a5fa","#f0abfc","#fbbf24","#34d399","#fb7185"][i%5]}40`,
  sup: "#fbbf24", supBg: "rgba(251,191,36,0.06)", red: "#f87171",
};
const SWC_LIGHT = {
  bg: "#f5f5f7", surface: "#ebedf0", raised: "#e0e2e7", hover: "#d4d7dd",
  border: "#b8bcc6", borderLit: "#a0a5b2", text: "#2e3340", muted: "#4a5168",
  dim: "#8890a0", white: "#111318",
  given: "#137a6a", givenBorder: "#0a5c4d",
  meant: "#6938c0", meantBorder: "#4a2d8a",
  fw: ["#2563b0","#9333b0","#8a6d1e","#177a4a","#c03050"],
  fwBg: i => `${["#2563b0","#9333b0","#8a6d1e","#177a4a","#c03050"][i%5]}14`,
  fwBorder: i => `${["#2563b0","#9333b0","#8a6d1e","#177a4a","#c03050"][i%5]}40`,
  sup: "#8a6d1e", supBg: "rgba(138,109,30,0.08)", red: "#c03030",
};
const useSWC = () => { const {theme} = useTheme(); return theme === 'light' ? SWC_LIGHT : SWC_DARK; };
/* Legacy alias â€” components that haven't migrated yet still read SWC */
let SWC = SWC_DARK;

let _swId = 100;
const swUid = () => `id_${_swId++}`;

const SwTag = ({color=SWC.muted,children,sm,mono,onClick,style:sx}) => (
  <span onClick={onClick} style={{display:"inline-flex",alignItems:"center",padding:sm?"1px 7px":"2px 9px",fontSize:sm?11:12,fontWeight:600,fontFamily:mono?"var(--mono)":"inherit",background:`${color}10`,border:`1px solid ${color}28`,borderRadius:3,color,cursor:onClick?"pointer":"default",letterSpacing:"0.01em",lineHeight:"20px",whiteSpace:"nowrap",...sx}}>{children}</span>
);
const SwDot = ({color,size=6}) => <span style={{width:size,height:size,borderRadius:"50%",background:color,display:"inline-block",flexShrink:0}}/>;
const SwBtn = ({children,accent=SWC.given,ghost,disabled,onClick,style:sx}) => (
  <button disabled={disabled} onClick={onClick} style={{padding:"8px 18px",borderRadius:6,fontSize:13,fontWeight:600,fontFamily:"inherit",cursor:disabled?"default":"pointer",transition:"all 0.15s",opacity:disabled?0.4:1,border:ghost?`1px solid ${accent}40`:`1px solid ${accent}`,background:ghost?"transparent":accent,color:ghost?accent:SWC.bg,...sx}}>{children}</button>
);
const SwInput = ({value,onChange,placeholder,autoFocus,onKeyDown,style:sx}) => (
  <input autoFocus={autoFocus} value={value} onChange={e=>onChange(e.target.value)} onKeyDown={onKeyDown} placeholder={placeholder} style={{width:"100%",padding:"10px 14px",borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:14,fontFamily:"inherit",outline:"none",boxSizing:"border-box",...sx}} onFocus={e=>e.target.style.borderColor=SWC.borderLit} onBlur={e=>e.target.style.borderColor=SWC.border}/>
);
const SwHdr = ({title,tag,tagColor,right,children:ch}) => (
  <div style={{marginBottom:22}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12}}>
      <div style={{display:"flex",alignItems:"center",gap:8}}>
        <span style={{fontSize:12,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.08em",color:SWC.muted}}>{title}</span>
        {tag && <SwTag color={tagColor} sm>{tag}</SwTag>}
      </div>
      {right}
    </div>
    {ch}
  </div>
);

const SwEpNote = ({type}) => (
  <div style={{padding:"10px 14px",borderRadius:6,border:`1px solid ${type==="given"?SWC.givenBorder:SWC.meantBorder}`,background:type==="given"?"rgba(45,212,160,0.04)":"rgba(167,139,250,0.04)",fontSize:13,color:SWC.muted,lineHeight:1.6,marginBottom:16}}>
    {type==="given" ? (<>
      <SwTag color={SWC.given} sm style={{marginRight:4}}>GIVEN</SwTag> = what happened. Could someone disagree? <b style={{color:SWC.text}}>No</b> â†’ it's a fact of observation. Questions and their answer options live here â€” phenomenological, no interpretation baked in.
    </>) : (<>
      <SwTag color={SWC.meant} sm style={{marginRight:4}}>MEANT</SwTag> = what someone says it means. Could someone disagree? <b style={{color:SWC.text}}>Yes</b> â†’ it's interpretation. Frameworks and their codes live here â€” institutional, perspectival, revisable.
    </>)}
  </div>
);

function SwMRow({opt,frameworks,getBindingCode,setBind,clearBind,hasConflict,isLast}) {
  const [openCell,setOpenCell] = useState(null);
  return (
    <div style={{borderBottom:!isLast?`1px solid ${SWC.border}`:"none"}}>
      <div style={{display:"grid",gridTemplateColumns:`minmax(140px,180px) repeat(${frameworks.length}, 1fr)`}}>
        <div style={{padding:"10px 14px",fontSize:14,color:SWC.white,fontWeight:500,display:"flex",alignItems:"center",gap:5}}>
          {opt.label}{hasConflict(opt)&&<span style={{fontSize:11}}>âš¡</span>}
        </div>
        {frameworks.map((fw,fi) => {
          const code = getBindingCode(opt.id,fw.id);
          const isOpen = openCell===fw.id;
          const hasCodes = fw.codes.length>0;
          return (
            <div key={fw.id} onClick={()=>{if(hasCodes)setOpenCell(isOpen?null:fw.id);}} style={{
              padding:"9px 10px",textAlign:"center",borderLeft:`1px solid ${SWC.border}`,
              cursor:hasCodes?"pointer":"default",transition:"background 0.1s",
              background:isOpen?SWC.fwBg(fi):"transparent",
            }}
            onMouseEnter={e=>{if(hasCodes&&!isOpen)e.currentTarget.style.background=SWC.hover;}}
            onMouseLeave={e=>{if(!isOpen)e.currentTarget.style.background=isOpen?SWC.fwBg(fi):"transparent";}}
            >
              {code?<SwTag color={SWC.fw[fi%5]} mono style={{fontSize:13}}>{code.code}</SwTag>:hasCodes?<span style={{fontSize:12.5,color:SWC.dim}}>â€”</span>:<span style={{fontSize:11.5,color:SWC.dim}}>no codes</span>}
            </div>
          );
        })}
      </div>
      {openCell && (()=>{
        const fi=frameworks.findIndex(f=>f.id===openCell);
        const fw=frameworks[fi];
        if(!fw) return null;
        const cur=getBindingCode(opt.id,fw.id);
        return (
          <div style={{padding:"8px 12px 10px",background:SWC.fwBg(fi),borderTop:`1px solid ${SWC.fwBorder(fi)}`}}>
            <div style={{fontSize:12,color:SWC.muted,marginBottom:8,fontWeight:600}}>
              <span style={{color:SWC.fw[fi%5]}}>{fw.name}</span> reading for "{opt.label}":
            </div>
            <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
              {fw.codes.map(c=>{
                const a=cur?.id===c.id;
                return (
                  <div key={c.id} onClick={e=>{e.stopPropagation();if(a)clearBind(opt.id,fw.id);else setBind(opt.id,c.id,fw.id);setOpenCell(null);}} style={{
                    padding:"6px 10px",borderRadius:6,cursor:"pointer",transition:"all 0.12s",display:"flex",alignItems:"center",gap:6,
                    border:`1px solid ${a?SWC.fw[fi%5]:SWC.border}`,background:a?`${SWC.fw[fi%5]}18`:"transparent",
                  }}
                  onMouseEnter={e=>{e.currentTarget.style.borderColor=SWC.fw[fi%5];if(!a)e.currentTarget.style.background=SWC.hover;}}
                  onMouseLeave={e=>{e.currentTarget.style.borderColor=a?SWC.fw[fi%5]:SWC.border;e.currentTarget.style.background=a?`${SWC.fw[fi%5]}18`:"transparent";}}
                  >
                    <SwTag color={SWC.fw[fi%5]} mono sm>{c.code}</SwTag>
                    <span style={{fontSize:13,color:a?SWC.white:SWC.text}}>{c.label}</span>
                    {a && <span style={{fontSize:11.5,color:SWC.fw[fi%5]}}>âœ“</span>}
                  </div>
                );
              })}
            </div>
            {cur && <div onClick={e=>{e.stopPropagation();clearBind(opt.id,fw.id);setOpenCell(null);}} style={{fontSize:12.5,color:SWC.dim,cursor:"pointer",marginTop:8}}>Clear</div>}
          </div>
        );
      })()}
    </div>
  );
}

const SchemaWorkbench = ({isOrg = false}) => {
  SWC = useSWC();
  const [screen, setScreen] = useState("start");
  const [prompts, setPrompts] = useState([]);
  const [frameworks, setFrameworks] = useState([]);
  const [bindings, setBindings] = useState({});
  const [crosswalks, setCrosswalks] = useState([]);

  const [addingPrompt, setAddingPrompt] = useState(false);
  const [addingOption, setAddingOption] = useState(null);
  const [addingFw, setAddingFw] = useState(false);
  const [addingCode, setAddingCode] = useState(null);
  const [draft, setDraft] = useState("");
  const [draft2, setDraft2] = useState("");
  const [matrixPrompt, setMatrixPrompt] = useState(null);
  const [selectedValue, setSelectedValue] = useState(null);
  const [expandedFw, setExpandedFw] = useState(null);
  const [modalAddingCode, setModalAddingCode] = useState(null);
  const [addingXW, setAddingXW] = useState(false);
  const [xwFrom, setXwFrom] = useState("");
  const [xwTo, setXwTo] = useState("");
  const [xwType, setXwType] = useState("equivalent");
  const [xwNotes, setXwNotes] = useState("");

  const allOptions = prompts.flatMap(p => p.options.map(o => ({...o, promptId: p.id, promptText: p.prompt})));
  const allCodes = frameworks.flatMap((f,fi) => f.codes.map(c => ({...c, frameworkId: f.id, frameworkName: f.name, fwIdx: fi})));

  const getBindingCode = (optId, fwId) => {
    const fw = frameworks.find(f=>f.id===fwId);
    if(!fw) return null;
    for(const c of fw.codes) if(bindings[`${optId}__${c.id}`]) return c;
    return null;
  };
  const getBindingsForOption = (optId) => frameworks.map((f,fi) => {
    const c = getBindingCode(optId,f.id);
    return c ? {...c,fwIdx:fi,frameworkName:f.name} : null;
  }).filter(Boolean);
  const hasConflict = (opt) => {
    const cs = getBindingsForOption(opt.id);
    return cs.length >= 2 && new Set(cs.map(c=>c.label)).size > 1;
  };

  const doAddPrompt = () => { if(!draft.trim()) return; setPrompts(p=>[...p,{id:swUid(),prompt:draft.trim(),options:[]}]); setDraft(""); setAddingPrompt(false); if(screen==="start") setScreen("questions"); };
  const doAddOption = (pid) => { if(!draft.trim()) return; setPrompts(ps=>ps.map(p=>p.id===pid?{...p,options:[...p.options,{id:swUid(),label:draft.trim()}]}:p)); setDraft(""); };
  const doAddFw = () => { if(!draft.trim()) return; setFrameworks(f=>[...f,{id:swUid(),name:draft.trim(),fullName:draft2.trim()||null,codes:[]}]); setDraft(""); setDraft2(""); setAddingFw(false); if(screen==="start") setScreen("frameworks"); };
  const doAddCode = (fwId) => { if(!draft.trim()||!draft2.trim()) return; setFrameworks(fs=>fs.map(f=>f.id===fwId?{...f,codes:[...f.codes,{id:swUid(),code:draft.trim(),label:draft2.trim()}]}:f)); setDraft(""); setDraft2(""); };
  const doSetBind = (optId,codeId,fwId) => { const nb={...bindings}; const fw=frameworks.find(f=>f.id===fwId); if(fw) fw.codes.forEach(c=>{delete nb[`${optId}__${c.id}`];}); nb[`${optId}__${codeId}`]={t:Date.now()}; setBindings(nb); };
  const doClearBind = (optId,fwId) => { const nb={...bindings}; const fw=frameworks.find(f=>f.id===fwId); if(fw) fw.codes.forEach(c=>{delete nb[`${optId}__${c.id}`];}); setBindings(nb); };
  const doAddXW = () => { if(!xwFrom||!xwTo) return; setCrosswalks(x=>[...x,{id:swUid(),fromCodeId:xwFrom,toCodeId:xwTo,type:xwType,notes:xwNotes}]); setAddingXW(false); setXwFrom(""); setXwTo(""); setXwType("equivalent"); setXwNotes(""); };

  const totalBindings = Object.keys(bindings).length;
  const totalPossible = allOptions.length * frameworks.length;
  const hasData = prompts.length > 0 || frameworks.length > 0;

  const tabs = [
    {id:"questions",label:"Questions",ep:"GIVEN",color:SWC.given},
    {id:"frameworks",label:"Frameworks",ep:"MEANT",color:SWC.meant},
    {id:"matrix",label:"Bindings",ep:"GIVEN â†’ MEANT",color:SWC.meant},
    {id:"crosswalks",label:"Crosswalks",ep:"MEANT â†” MEANT",color:SWC.meant},
  ];

  return (
    <div className="anim-up" style={{color:SWC.text}}>
      {/* Header */}
      <div style={{marginBottom:16,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <I n="grid" s={20} c={SWC.given}/>
          <span onClick={()=>setScreen(hasData?"questions":"start")} style={{fontSize:19,fontWeight:700,color:SWC.white,letterSpacing:"-0.03em",cursor:"pointer",fontFamily:"var(--serif)"}}>Schema Workbench</span>
        </div>
        {hasData && (
          <div style={{display:"flex",gap:2}}>
            {tabs.map(t => (
              <button key={t.id} onClick={()=>{setScreen(t.id);setSelectedValue(null);setExpandedFw(null);setMatrixPrompt(null);}} style={{
                padding:"6px 12px",borderRadius:5,border:"none",fontSize:12.5,fontWeight:500,
                cursor:"pointer",fontFamily:"inherit",transition:"all 0.12s",
                display:"flex",alignItems:"center",gap:5,
                background:screen===t.id?SWC.raised:"transparent",
                color:screen===t.id?SWC.white:SWC.muted,
              }}>{t.label}<SwTag color={screen===t.id?t.color:SWC.dim} sm>{t.ep}</SwTag></button>
            ))}
          </div>
        )}
      </div>

      {/* Stats bar */}
      {hasData && (
        <div style={{padding:"8px 0",borderTop:`1px solid ${SWC.border}`,borderBottom:`1px solid ${SWC.border}`,fontSize:12.5,color:SWC.dim,display:"flex",gap:18,marginBottom:18}}>
          <span>{prompts.length} question{prompts.length!==1?"s":""} Â· {allOptions.length} options</span>
          <span>{frameworks.length} framework{frameworks.length!==1?"s":""} Â· {allCodes.length} codes</span>
          {totalPossible > 0 && <span style={{marginLeft:"auto"}}>{totalBindings}/{totalPossible} bindings Â· {crosswalks.length} crosswalks</span>}
        </div>
      )}

      {/* â•â•â• START â•â•â• */}
      {screen === "start" && !hasData && (
        <div style={{paddingTop:40}}>
          <div style={{textAlign:"center",marginBottom:40}}>
            <div style={{fontSize:22,fontWeight:600,color:SWC.white,marginBottom:8}}>Build a schema from any angle</div>
            <div style={{fontSize:15,color:SWC.muted,maxWidth:480,margin:"0 auto",lineHeight:1.6}}>
              Start with what you observe, or start with what you need to report. They'll connect in the middle.
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,maxWidth:520,margin:"0 auto"}}>
            <div onClick={()=>{setAddingPrompt(true);setDraft("");}} style={{
              padding:20,borderRadius:10,border:`1px solid ${SWC.givenBorder}`,background:"rgba(45,212,160,0.03)",
              cursor:"pointer",transition:"all 0.15s",
            }}
            onMouseEnter={e=>e.currentTarget.style.borderColor=SWC.given}
            onMouseLeave={e=>e.currentTarget.style.borderColor=SWC.givenBorder}
            >
              <SwTag color={SWC.given}>GIVEN</SwTag>
              <div style={{fontSize:16,fontWeight:600,color:SWC.white,marginTop:10}}>Start with a question</div>
              <div style={{fontSize:13.5,color:SWC.muted,marginTop:6,lineHeight:1.55}}>What do you need to observe? Something answerable by looking, listening, or asking.</div>
            </div>
            <div onClick={()=>{setAddingFw(true);setDraft("");setDraft2("");}} style={{
              padding:20,borderRadius:10,border:`1px solid ${SWC.meantBorder}`,background:"rgba(167,139,250,0.03)",
              cursor:"pointer",transition:"all 0.15s",
            }}
            onMouseEnter={e=>e.currentTarget.style.borderColor=SWC.meant}
            onMouseLeave={e=>e.currentTarget.style.borderColor=SWC.meantBorder}
            >
              <SwTag color={SWC.meant}>MEANT</SwTag>
              <div style={{fontSize:16,fontWeight:600,color:SWC.white,marginTop:10}}>Start with a framework</div>
              <div style={{fontSize:13.5,color:SWC.muted,marginTop:6,lineHeight:1.55}}>Who do you report to? A regulation, a funder's categories, an internal policy.</div>
            </div>
          </div>
        </div>
      )}

      {/* â•â•â• ADD PROMPT (overlay) â•â•â• */}
      {addingPrompt && (
        <div style={{position:"fixed",bottom:24,right:24,zIndex:1000,width:370,border:`1px solid ${SWC.givenBorder}`,borderRadius:10,background:SWC.surface,padding:20,boxShadow:"0 8px 32px rgba(0,0,0,0.45)"}}>
          <div style={{fontSize:15,fontWeight:600,color:SWC.given,marginBottom:12}}>New Observation Question</div>
          <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Type your question..." onKeyDown={e=>{if(e.key==="Enter")doAddPrompt();if(e.key==="Escape"){setAddingPrompt(false);setDraft("");}}}/>
          <div style={{fontSize:13,color:SWC.dim,marginTop:8,lineHeight:1.55}}>Can it be answered by observing â€” without consulting a policy? Then it's GIVEN.</div>
          <div style={{display:"flex",gap:8,marginTop:12}}>
            <SwBtn onClick={doAddPrompt} disabled={!draft.trim()}>Create</SwBtn>
            <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingPrompt(false);setDraft("");}}>Cancel</SwBtn>
          </div>
          {screen==="start" && (
            <div style={{marginTop:12,display:"flex",flexDirection:"column",gap:6}}>
              {["Where did you sleep last night?","What temperature was recorded?","What condition is this part in?","What did the patient report?"].map(ex => (
                <div key={ex} onClick={()=>setDraft(ex)} style={{padding:"8px 12px",borderRadius:5,border:`1px solid ${SWC.border}`,fontSize:13,color:SWC.dim,cursor:"pointer",transition:"all 0.12s"}}
                  onMouseEnter={e=>{e.currentTarget.style.color=SWC.given;e.currentTarget.style.borderColor=SWC.given;}}
                  onMouseLeave={e=>{e.currentTarget.style.color=SWC.dim;e.currentTarget.style.borderColor=SWC.border;}}
                >{ex}</div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* â•â•â• ADD FRAMEWORK (overlay) â•â•â• */}
      {addingFw && (
        <div style={{border:`1px solid ${SWC.meantBorder}`,borderRadius:10,background:SWC.surface,padding:20,marginBottom:16}}>
          <div style={{fontSize:15,fontWeight:600,color:SWC.meant,marginBottom:12}}>New Reporting Framework</div>
          <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Short name (e.g. HUD Â§578.3)" onKeyDown={e=>{if(e.key==="Enter"&&draft.trim())doAddFw();if(e.key==="Escape"){setAddingFw(false);setDraft("");setDraft2("");}}}/>
          <div style={{marginTop:8}}><SwInput value={draft2} onChange={setDraft2} placeholder="Full name (optional)" onKeyDown={e=>{if(e.key==="Enter"&&draft.trim())doAddFw();}}/></div>
          <div style={{fontSize:13,color:SWC.dim,marginTop:8,lineHeight:1.55}}>Could someone disagree about what a code means? Then it's MEANT.</div>
          <div style={{display:"flex",gap:8,marginTop:12}}>
            <SwBtn accent={SWC.meant} onClick={doAddFw} disabled={!draft.trim()}>Create</SwBtn>
            <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingFw(false);setDraft("");setDraft2("");}}>Cancel</SwBtn>
          </div>
        </div>
      )}


      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TAB 1: QUESTIONS & VALUES
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {screen === "questions" && !addingPrompt && !addingFw && (
        <>
          <SwEpNote type="given"/>
          <SwHdr title="Observation Questions" tag="GIVEN" tagColor={SWC.given}
            right={<SwBtn ghost accent={SWC.given} onClick={()=>{setAddingPrompt(true);setDraft("");}}>+ Add question</SwBtn>}>
            {prompts.length === 0 ? (
              <div style={{padding:20,border:`1px dashed ${SWC.border}`,borderRadius:8,textAlign:"center",color:SWC.dim,fontSize:13.5}}>
                No questions yet. <span style={{color:SWC.given,cursor:"pointer"}} onClick={()=>{setAddingPrompt(true);setDraft("");}}>Create one â†’</span>
              </div>
            ) : prompts.map(p => (
              <div key={p.id} style={{border:`1px solid ${SWC.border}`,borderRadius:8,background:SWC.surface,marginBottom:8,overflow:"hidden"}}>
                <div style={{padding:"10px 14px",borderBottom:`1px solid ${SWC.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <div>
                    <span style={{fontSize:15,fontWeight:600,color:SWC.white}}>{p.prompt}</span>
                    {p.options.some(o=>hasConflict(o)) && <span style={{marginLeft:6}}>âš¡</span>}
                    <div style={{fontSize:12.5,color:SWC.dim,marginTop:3}}>{p.options.length} option{p.options.length!==1?"s":""}</div>
                  </div>
                  {frameworks.length > 0 && p.options.length > 0 && (
                    <button onClick={()=>{setMatrixPrompt(p);setScreen("matrix");}} style={{padding:"5px 12px",borderRadius:5,border:`1px solid ${SWC.border}`,background:"transparent",color:SWC.muted,fontSize:12.5,cursor:"pointer",fontFamily:"inherit"}}>Bindings â†’</button>
                  )}
                </div>
                <div style={{padding:"4px 6px"}}>
                  {p.options.map(o => {
                    const bound = getBindingsForOption(o.id);
                    return (
                      <div key={o.id} onClick={()=>{if(frameworks.length>0){setSelectedValue({prompt:p,option:o});setExpandedFw(null);setModalAddingCode(null);}}} style={{
                        padding:"6px 10px",borderRadius:5,display:"flex",alignItems:"center",justifyContent:"space-between",
                        cursor:frameworks.length>0?"pointer":"default",transition:"background 0.1s",
                      }}
                      onMouseEnter={e=>{if(frameworks.length>0)e.currentTarget.style.background=SWC.hover;}}
                      onMouseLeave={e=>e.currentTarget.style.background="transparent"}
                      >
                        <span style={{fontSize:14,color:SWC.white}}>{o.label}</span>
                        <div style={{display:"flex",alignItems:"center",gap:4}}>
                          {hasConflict(o) && <span style={{fontSize:11}}>âš¡</span>}
                          {bound.map((c,i)=><SwDot key={i} color={SWC.fw[c.fwIdx%5]}/>)}
                          {bound.length===0 && frameworks.length>0 && <span style={{fontSize:11.5,color:SWC.dim}}>unbound</span>}
                        </div>
                      </div>
                    );
                  })}
                  {addingOption === p.id ? (
                    <div style={{padding:"4px 8px",display:"flex",gap:6,alignItems:"center"}}>
                      <SwInput autoFocus value={draft} onChange={setDraft} placeholder="New option..."
                        onKeyDown={e=>{if(e.key==="Enter"){doAddOption(p.id);}else if(e.key==="Escape"){setAddingOption(null);setDraft("");}}}
                        style={{padding:"5px 10px",fontSize:12}}/>
                      <SwBtn onClick={()=>doAddOption(p.id)} disabled={!draft.trim()} style={{padding:"5px 12px",fontSize:11}}>Add</SwBtn>
                      <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingOption(null);setDraft("");}} style={{padding:"5px 8px",fontSize:11}}>Ã—</SwBtn>
                    </div>
                  ) : (
                    <div onClick={()=>{setAddingOption(p.id);setDraft("");}} style={{padding:"8px 12px",fontSize:13,color:SWC.dim,cursor:"pointer"}}>+ Add option</div>
                  )}
                </div>
              </div>
            ))}
          </SwHdr>
        </>
      )}


      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TAB 2: FRAMEWORKS & CODES
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {screen === "frameworks" && !addingPrompt && !addingFw && (
        <>
          <SwEpNote type="meant"/>
          <SwHdr title="Reporting Frameworks" tag="MEANT" tagColor={SWC.meant}
            right={<SwBtn ghost accent={SWC.meant} onClick={()=>{setAddingFw(true);setDraft("");setDraft2("");}}>+ Add framework</SwBtn>}>
            {frameworks.length === 0 ? (
              <div style={{padding:20,border:`1px dashed ${SWC.border}`,borderRadius:8,textAlign:"center",color:SWC.dim,fontSize:13.5}}>
                No frameworks yet. <span style={{color:SWC.meant,cursor:"pointer"}} onClick={()=>{setAddingFw(true);setDraft("");setDraft2("");}}>Create one â†’</span>
              </div>
            ) : frameworks.map((f,fi) => (
              <div key={f.id} style={{border:`1px solid ${SWC.border}`,borderRadius:8,background:SWC.surface,marginBottom:8,overflow:"hidden"}}>
                <div style={{padding:"10px 14px",borderBottom:`1px solid ${SWC.border}`,display:"flex",alignItems:"center",gap:6}}>
                  <SwDot color={SWC.fw[fi%5]} size={8}/>
                  <span style={{fontSize:15,fontWeight:600,color:SWC.fw[fi%5]}}>{f.name}</span>
                  {f.fullName && <span style={{fontSize:13,color:SWC.muted}}>â€” {f.fullName}</span>}
                  <span style={{marginLeft:"auto",fontSize:12.5,color:SWC.dim}}>{f.codes.length} code{f.codes.length!==1?"s":""}</span>
                </div>
                <div style={{padding:"4px 6px"}}>
                  {f.codes.map(c => (
                    <div key={c.id} style={{padding:"5px 10px",display:"flex",alignItems:"center",gap:8}}>
                      <SwTag color={SWC.fw[fi%5]} sm mono>{c.code}</SwTag>
                      <span style={{fontSize:13,color:SWC.text}}>{c.label}</span>
                    </div>
                  ))}
                  {addingCode === f.id ? (
                    <div style={{padding:"4px 8px"}}>
                      <div style={{display:"flex",gap:6,marginBottom:4}}>
                        <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Code (e.g. Cat-1)"
                          onKeyDown={e=>{if(e.key==="Escape"){setAddingCode(null);setDraft("");setDraft2("");}}}
                          style={{padding:"5px 10px",fontSize:12,width:120,flex:"none"}}/>
                        <SwInput value={draft2} onChange={setDraft2} placeholder="Label (e.g. Literally Homeless)"
                          onKeyDown={e=>{if(e.key==="Enter"&&draft.trim()&&draft2.trim()){doAddCode(f.id);}else if(e.key==="Escape"){setAddingCode(null);setDraft("");setDraft2("");}}}
                          style={{padding:"5px 10px",fontSize:12}}/>
                      </div>
                      <div style={{display:"flex",gap:6}}>
                        <SwBtn accent={SWC.meant} onClick={()=>doAddCode(f.id)} disabled={!draft.trim()||!draft2.trim()} style={{padding:"5px 12px",fontSize:11}}>Add</SwBtn>
                        <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingCode(null);setDraft("");setDraft2("");}} style={{padding:"5px 8px",fontSize:11}}>Ã—</SwBtn>
                      </div>
                    </div>
                  ) : (
                    <div onClick={()=>{setAddingCode(f.id);setDraft("");setDraft2("");}} style={{padding:"8px 12px",fontSize:13,color:SWC.dim,cursor:"pointer"}}>+ Add code</div>
                  )}
                </div>
              </div>
            ))}
          </SwHdr>
        </>
      )}


      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          VALUE MODAL â€” with inline binding + inline code creation
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {selectedValue && (
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.65)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:50}}
          onClick={()=>{setSelectedValue(null);setExpandedFw(null);setModalAddingCode(null);setDraft("");setDraft2("");}}>
          <div style={{width:540,maxHeight:"85vh",overflow:"auto",background:SWC.raised,border:`1px solid ${SWC.border}`,borderRadius:12,padding:24}}
            onClick={e=>e.stopPropagation()}>
            <div style={{display:"flex",justifyContent:"space-between",marginBottom:16}}>
              <div>
                <SwTag color={SWC.given}>GIVEN</SwTag>
                <div style={{fontSize:13,color:SWC.muted,marginTop:6}}>{selectedValue.prompt.prompt}</div>
                <div style={{fontSize:20,fontWeight:700,color:SWC.white,marginTop:3}}>{selectedValue.option.label}</div>
              </div>
              <button onClick={()=>{setSelectedValue(null);setExpandedFw(null);setModalAddingCode(null);}} style={{background:"none",border:"none",color:SWC.muted,cursor:"pointer",fontSize:20,padding:4,lineHeight:1}}>Ã—</button>
            </div>

            <div style={{fontSize:12,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.08em",color:SWC.muted,marginBottom:8}}>Framework Readings</div>
            <div style={{fontSize:13,color:SWC.dim,marginBottom:14}}>Click a framework to assign its reading of this observation.</div>

            {frameworks.map((fw,fi) => {
              const code = getBindingCode(selectedValue.option.id, fw.id);
              const isExpanded = expandedFw === fw.id;
              const hasCodes = fw.codes.length > 0;
              const isAddingCodeHere = modalAddingCode === fw.id;

              return (
                <div key={fw.id} style={{
                  borderRadius:8,border:`1px solid ${isExpanded?SWC.fwBorder(fi):SWC.border}`,
                  background:isExpanded?SWC.fwBg(fi):SWC.surface,
                  marginBottom:6,overflow:"hidden",transition:"all 0.15s",
                }}>
                  {/* Header row */}
                  <div onClick={()=>{setExpandedFw(isExpanded?null:fw.id);setModalAddingCode(null);setDraft("");setDraft2("");}} style={{
                    padding:"10px 14px",display:"flex",alignItems:"center",gap:10,cursor:"pointer",
                  }}>
                    <SwDot color={SWC.fw[fi%5]} size={8}/>
                    <span style={{fontSize:14,fontWeight:600,color:SWC.fw[fi%5],minWidth:80}}>{fw.name}</span>
                    <span style={{color:SWC.dim,fontSize:14}}>â†’</span>
                    {code ? (
                      <div style={{display:"flex",alignItems:"center",gap:6,flex:1}}>
                        <SwTag color={SWC.fw[fi%5]} mono>{code.code}</SwTag>
                        <span style={{fontSize:14,fontWeight:500,color:SWC.white}}>{code.label}</span>
                      </div>
                    ) : (
                      <span style={{fontSize:13,color:SWC.muted,fontStyle:"italic",flex:1}}>
                        {hasCodes ? "click to assign" : "no codes yet â€” click to add"}
                      </span>
                    )}
                    <span style={{fontSize:11,color:SWC.dim,transform:isExpanded?"rotate(180deg)":"rotate(0)",transition:"transform 0.15s"}}>â–¼</span>
                  </div>

                  {/* Expanded panel */}
                  {isExpanded && (
                    <div style={{padding:"6px 14px 12px",borderTop:`1px solid ${SWC.fwBorder(fi)}`}}>
                      {hasCodes && (
                        <>
                          <div style={{fontSize:12,color:SWC.muted,marginBottom:8,fontWeight:600}}>Select a code:</div>
                          <div style={{display:"flex",flexDirection:"column",gap:4}}>
                            {fw.codes.map(c => {
                              const isActive = code?.id === c.id;
                              return (
                                <div key={c.id} onClick={()=>{
                                  if(isActive) doClearBind(selectedValue.option.id,fw.id);
                                  else doSetBind(selectedValue.option.id,c.id,fw.id);
                                  setExpandedFw(null);
                                }} style={{
                                  padding:"8px 12px",borderRadius:6,cursor:"pointer",transition:"all 0.12s",
                                  display:"flex",alignItems:"center",gap:8,
                                  border:`1px solid ${isActive?SWC.fw[fi%5]:SWC.border}`,
                                  background:isActive?`${SWC.fw[fi%5]}18`:"transparent",
                                }}
                                onMouseEnter={e=>{e.currentTarget.style.borderColor=SWC.fw[fi%5];if(!isActive)e.currentTarget.style.background=SWC.hover;}}
                                onMouseLeave={e=>{e.currentTarget.style.borderColor=isActive?SWC.fw[fi%5]:SWC.border;e.currentTarget.style.background=isActive?`${SWC.fw[fi%5]}18`:"transparent";}}
                                >
                                  <div style={{width:16,height:16,borderRadius:8,border:`2px solid ${isActive?SWC.fw[fi%5]:SWC.border}`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                                    {isActive && <div style={{width:8,height:8,borderRadius:4,background:SWC.fw[fi%5]}}/>}
                                  </div>
                                  <SwTag color={SWC.fw[fi%5]} mono sm>{c.code}</SwTag>
                                  <span style={{fontSize:13,color:isActive?SWC.white:SWC.text}}>{c.label}</span>
                                  {isActive && <span style={{fontSize:11.5,color:SWC.fw[fi%5],marginLeft:"auto"}}>âœ“ bound</span>}
                                </div>
                              );
                            })}
                          </div>
                          {code && (
                            <div onClick={()=>{doClearBind(selectedValue.option.id,fw.id);setExpandedFw(null);}}
                              style={{fontSize:12.5,color:SWC.dim,cursor:"pointer",marginTop:10}}
                              onMouseEnter={e=>e.currentTarget.style.color=SWC.red}
                              onMouseLeave={e=>e.currentTarget.style.color=SWC.dim}
                            >Clear binding</div>
                          )}
                          <div style={{marginTop:8,borderTop:`1px solid ${SWC.fwBorder(fi)}`,paddingTop:8}}/>
                        </>
                      )}

                      {/* Inline add code */}
                      {isAddingCodeHere ? (
                        <div>
                          <div style={{fontSize:12,color:SWC.muted,marginBottom:6,fontWeight:600}}>Add a code to {fw.name}:</div>
                          <div style={{display:"flex",gap:6,marginBottom:4}}>
                            <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Code"
                              onKeyDown={e=>{if(e.key==="Escape"){setModalAddingCode(null);setDraft("");setDraft2("");}}}
                              style={{padding:"5px 10px",fontSize:12,width:100,flex:"none"}}/>
                            <SwInput value={draft2} onChange={setDraft2} placeholder="Label"
                              onKeyDown={e=>{if(e.key==="Enter"&&draft.trim()&&draft2.trim()){doAddCode(fw.id);} else if(e.key==="Escape"){setModalAddingCode(null);setDraft("");setDraft2("");}}}
                              style={{padding:"5px 10px",fontSize:12}}/>
                          </div>
                          <div style={{display:"flex",gap:6}}>
                            <SwBtn accent={SWC.fw[fi%5]} onClick={()=>doAddCode(fw.id)} disabled={!draft.trim()||!draft2.trim()} style={{padding:"4px 10px",fontSize:11}}>Add code</SwBtn>
                            <SwBtn ghost accent={SWC.muted} onClick={()=>{setModalAddingCode(null);setDraft("");setDraft2("");}} style={{padding:"4px 8px",fontSize:11}}>Done</SwBtn>
                          </div>
                        </div>
                      ) : (
                        <div onClick={()=>{setModalAddingCode(fw.id);setDraft("");setDraft2("");}} style={{fontSize:12.5,color:SWC.fw[fi%5],cursor:"pointer"}}
                          onMouseEnter={e=>e.currentTarget.style.textDecoration="underline"}
                          onMouseLeave={e=>e.currentTarget.style.textDecoration="none"}
                        >+ Add code to {fw.name}</div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}

            {hasConflict(selectedValue.option) && (
              <div style={{marginTop:14,padding:"12px 16px",borderRadius:8,border:`1px solid ${SWC.sup}25`,background:SWC.supBg,fontSize:13.5,color:SWC.text,lineHeight:1.55}}>
                <span style={{color:SWC.sup,fontWeight:600}}>âš¡ Superposition â€” </span>
                Frameworks disagree. Different lenses, same thermometer.{" "}
                <span style={{color:SWC.meant,cursor:"pointer",textDecoration:"underline"}}
                  onClick={()=>{setSelectedValue(null);setExpandedFw(null);setScreen("crosswalks");}}>Document in crosswalks â†’</span>
              </div>
            )}
          </div>
        </div>
      )}


      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TAB 3: BINDING MATRIX
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {screen === "matrix" && !addingPrompt && !addingFw && (
        <>
          {!matrixPrompt && (
            <SwHdr title="Binding Matrix" tag="GIVEN â†’ MEANT" tagColor={SWC.meant}>
              <div style={{fontSize:13.5,color:SWC.muted,marginBottom:14,lineHeight:1.55}}>
                Each binding connects an observation (GIVEN) to a classification (MEANT). The same observation can mean different things to different frameworks.
              </div>
              {prompts.filter(p=>p.options.length>0).length === 0 ? (
                <div style={{padding:20,border:`1px dashed ${SWC.border}`,borderRadius:8,textAlign:"center",color:SWC.dim,fontSize:13.5}}>
                  Add questions with options first. <span style={{color:SWC.given,cursor:"pointer"}} onClick={()=>setScreen("questions")}>Go to Questions â†’</span>
                </div>
              ) : frameworks.length === 0 ? (
                <div style={{padding:20,border:`1px dashed ${SWC.border}`,borderRadius:8,textAlign:"center",color:SWC.dim,fontSize:13.5}}>
                  Add a framework to bind against. <span style={{color:SWC.meant,cursor:"pointer"}} onClick={()=>setScreen("frameworks")}>Go to Frameworks â†’</span>
                </div>
              ) : prompts.filter(p=>p.options.length>0).map(p => {
                const bc = p.options.reduce((n,o)=>n+getBindingsForOption(o.id).length,0);
                const ps = p.options.length * frameworks.length;
                return (
                  <div key={p.id} onClick={()=>setMatrixPrompt(p)} style={{
                    padding:"10px 14px",borderRadius:8,border:`1px solid ${SWC.border}`,background:SWC.surface,
                    marginBottom:6,cursor:"pointer",transition:"all 0.12s",display:"flex",alignItems:"center",justifyContent:"space-between",
                  }}
                  onMouseEnter={e=>e.currentTarget.style.borderColor=SWC.borderLit}
                  onMouseLeave={e=>e.currentTarget.style.borderColor=SWC.border}
                  >
                    <span style={{fontSize:15,fontWeight:600,color:SWC.white}}>{p.prompt}</span>
                    <div style={{display:"flex",alignItems:"center",gap:8}}>
                      {ps>0 && <span style={{fontSize:12.5,color:bc===ps?SWC.given:SWC.dim}}>{bc}/{ps}</span>}
                      <span style={{fontSize:12.5,color:SWC.dim}}>â†’</span>
                    </div>
                  </div>
                );
              })}
            </SwHdr>
          )}

          {matrixPrompt && (
            <>
              <div style={{marginBottom:14}}>
                <button onClick={()=>setMatrixPrompt(null)} style={{background:"none",border:"none",color:SWC.muted,fontSize:12.5,cursor:"pointer",fontFamily:"inherit",padding:0,marginBottom:8}}>â† All questions</button>
                <div style={{fontSize:17,fontWeight:600,color:SWC.white}}>{matrixPrompt.prompt}</div>
                <div style={{fontSize:13,color:SWC.muted,marginTop:3}}>Click any cell to assign a code.</div>
              </div>
              <div style={{border:`1px solid ${SWC.border}`,borderRadius:10,overflow:"hidden",background:SWC.surface}}>
                <div style={{display:"grid",gridTemplateColumns:`minmax(140px,180px) repeat(${frameworks.length}, 1fr)`,borderBottom:`1px solid ${SWC.border}`,background:SWC.raised}}>
                  <div style={{padding:"10px 14px",fontSize:11,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.06em",color:SWC.dim}}>Value</div>
                  {frameworks.map((fw,fi) => (
                    <div key={fw.id} style={{padding:"10px 12px",fontSize:12.5,fontWeight:600,color:SWC.fw[fi%5],textAlign:"center",borderLeft:`1px solid ${SWC.border}`,display:"flex",alignItems:"center",justifyContent:"center",gap:4}}>
                      <SwDot color={SWC.fw[fi%5]} size={5}/>{fw.name}
                    </div>
                  ))}
                </div>
                {matrixPrompt.options.map((opt,oi) => (
                  <SwMRow key={opt.id} opt={opt} frameworks={frameworks} getBindingCode={getBindingCode} setBind={doSetBind} clearBind={doClearBind} hasConflict={hasConflict} isLast={oi===matrixPrompt.options.length-1}/>
                ))}
              </div>
              {matrixPrompt.options.some(o=>hasConflict(o)) && (
                <div style={{marginTop:12,padding:"12px 16px",borderRadius:8,border:`1px solid ${SWC.sup}25`,background:SWC.supBg,fontSize:13.5,color:SWC.text,lineHeight:1.55}}>
                  <span style={{color:SWC.sup,fontWeight:600}}>âš¡ Disagreement.</span>{" "}
                  <span style={{color:SWC.meant,cursor:"pointer",textDecoration:"underline"}} onClick={()=>setScreen("crosswalks")}>Document in crosswalks â†’</span>
                </div>
              )}
            </>
          )}
        </>
      )}


      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TAB 4: CROSSWALKS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {screen === "crosswalks" && !addingPrompt && !addingFw && (
        <SwHdr title="Crosswalks" tag="MEANT â†” MEANT" tagColor={SWC.meant}
          right={allCodes.length>=2 && <SwBtn ghost accent={SWC.meant} onClick={()=>setAddingXW(true)}>+ Add crosswalk</SwBtn>}>
          <div style={{fontSize:13.5,color:SWC.muted,marginBottom:16,lineHeight:1.55}}>
            Crosswalks translate between frameworks â€” how one institution's categories map to another's. Both sides are MEANT.
          </div>
          {addingXW && (
            <div style={{border:`1px solid ${SWC.meantBorder}`,borderRadius:10,background:SWC.surface,padding:16,marginBottom:12}}>
              <div style={{fontSize:15,fontWeight:600,color:SWC.meant,marginBottom:12}}>New Crosswalk</div>
              <div style={{display:"flex",gap:8,marginBottom:8}}>
                <select value={xwFrom} onChange={e=>setXwFrom(e.target.value)} style={{flex:1,padding:"7px 10px",borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:12,fontFamily:"inherit"}}>
                  <option value="">From code...</option>
                  {allCodes.map(c=><option key={c.id} value={c.id}>{c.frameworkName}: {c.code} â€” {c.label}</option>)}
                </select>
                <select value={xwTo} onChange={e=>setXwTo(e.target.value)} style={{flex:1,padding:"7px 10px",borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:12,fontFamily:"inherit"}}>
                  <option value="">To code...</option>
                  {allCodes.filter(c=>c.id!==xwFrom).map(c=><option key={c.id} value={c.id}>{c.frameworkName}: {c.code} â€” {c.label}</option>)}
                </select>
              </div>
              <div style={{display:"flex",gap:6,marginBottom:8}}>
                {["equivalent","implies","overlaps","conflicts"].map(t=>(
                  <SwTag key={t} color={xwType===t?(t==="conflicts"?SWC.sup:t==="equivalent"?SWC.given:SWC.meant):SWC.dim}
                    onClick={()=>setXwType(t)} sm style={{cursor:"pointer",padding:"3px 8px",fontSize:11}}>{t}</SwTag>
                ))}
              </div>
              <SwInput value={xwNotes} onChange={setXwNotes} placeholder="Notes (optional)" style={{marginBottom:10}}/>
              <div style={{display:"flex",gap:8}}>
                <SwBtn accent={SWC.meant} onClick={doAddXW} disabled={!xwFrom||!xwTo}>Create</SwBtn>
                <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingXW(false);setXwFrom("");setXwTo("");setXwNotes("");}}>Cancel</SwBtn>
              </div>
            </div>
          )}
          {crosswalks.length===0 && !addingXW ? (
            <div style={{padding:24,border:`1px dashed ${SWC.border}`,borderRadius:8,textAlign:"center",color:SWC.dim,fontSize:13.5}}>
              {allCodes.length<2?"Need codes in at least two frameworks first.":"No crosswalks yet."}
            </div>
          ) : crosswalks.map(xw=>{
            const from=allCodes.find(c=>c.id===xw.fromCodeId);
            const to=allCodes.find(c=>c.id===xw.toCodeId);
            if(!from||!to) return null;
            return (
              <div key={xw.id} style={{border:`1px solid ${SWC.border}`,borderRadius:8,background:SWC.surface,padding:"10px 14px",marginBottom:6}}>
                <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:xw.notes?6:0}}>
                  <SwDot color={SWC.fw[from.fwIdx%5]} size={6}/><SwTag color={SWC.fw[from.fwIdx%5]} sm>{from.frameworkName}: {from.code}</SwTag>
                  <span style={{color:SWC.dim,fontSize:13}}>{xw.type==="equivalent"?"=":xw.type==="implies"?"â†’":xw.type==="overlaps"?"â†”":"âš¡"}</span>
                  <SwDot color={SWC.fw[to.fwIdx%5]} size={6}/><SwTag color={SWC.fw[to.fwIdx%5]} sm>{to.frameworkName}: {to.code}</SwTag>
                  <SwTag color={xw.type==="conflicts"?SWC.sup:xw.type==="equivalent"?SWC.given:SWC.meant} sm>{xw.type}</SwTag>
                </div>
                {xw.notes && <div style={{fontSize:13,color:SWC.text,lineHeight:1.55}}>{xw.notes}</div>}
              </div>
            );
          })}
        </SwHdr>
      )}

    </div>
  );
};


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACTIVITY STREAM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ROOM_COLORS = {vault:'teal',bridge:'blue',roster:'gold',org:'blue',schema:'purple',metrics:'orange',network:'green',client_record:'teal',unknown:'orange'};

// Classify a room from pre-scanned state (no HTTP calls) or fallback to getState
const classifyRoom = async (roomId, scannedState) => {
  const state = scannedState || {};
  const id = state[EVT.IDENTITY] || await svc.getState(roomId, EVT.IDENTITY);
  if (id) {
    if (id.account_type==='client') return {type:'vault',label:'Client Vault',color:'teal'};
    if (id.account_type==='client_record') return {type:'client_record',label:'Client Record',color:'teal'};
    if (id.account_type==='provider') return {type:'roster',label:'Provider Roster',color:'gold'};
    if (id.account_type==='organization') return {type:'org',label:'Organization',color:'blue'};
    if (id.account_type==='schema') return {type:'schema',label:'Schema Room',color:'purple'};
    if (id.account_type==='metrics') return {type:'metrics',label:'Metrics Room',color:'orange'};
    if (id.account_type==='network') return {type:'network',label:'Network Room',color:'green'};
  }
  const meta = state[EVT.BRIDGE_META] || await svc.getState(roomId, EVT.BRIDGE_META);
  if (meta) return {type:'bridge',label:'Bridge Room',color:'blue'};
  return {type:'unknown',label:'Unknown',color:'orange'};
};

const classifyEvent = (ev, roomInfo) => {
  const type = ev.getType(); const content = ev.getContent();
  // Native EO operations
  if (type === EVT.OP) return { op:content.op||'INS', epistemic:content.frame?.epistemic||'GIVEN',
    label:`${content.op} Operation`, desc:content.target?.field||content.target?.entity||content.target?.type||'' };
  if (ev.isState && ev.isState()) {
    switch (type) {
      case EVT.IDENTITY: return {op:'INS',epistemic:'GIVEN',label:'Identity Declaration',desc:`Type: ${content.account_type}`};
      case EVT.VAULT_SNAPSHOT: return {op:'ALT',epistemic:'GIVEN',label:'Vault Snapshot',desc:`${Object.keys(content.fields||{}).length} fields`};
      case EVT.VAULT_PROVIDERS: return {op:'SEG',epistemic:'GIVEN',label:'Provider Index',desc:`${(content.providers||[]).length} providers`};
      case EVT.BRIDGE_META: return {op:'CON',epistemic:'MEANT',label:'Bridge Connection',desc:`${content.status} â€” ${content.client?.slice(0,16)} â†” ${content.provider?.slice(0,16)}`};
      case EVT.BRIDGE_REFS: return {op:'SEG',epistemic:'MEANT',label:'Field Refs Update',desc:`${Object.keys(content.fields||{}).length} encrypted refs${content.revoked?' (REVOKED)':''}`};
      case EVT.ROSTER_INDEX: return {op:'ALT',epistemic:'MEANT',label:'Roster Update',desc:`${(content.cases||[]).length} cases`};
      case EVT.ROSTER_ASSIGN: return {op:'SEG',epistemic:'MEANT',label:'Case Assignment',desc:`${Object.keys(content).length} assignments`};
      case EVT.ORG_ROSTER: return {op:'ALT',epistemic:'MEANT',label:'Org Roster',desc:`${(content.staff||[]).length} staff`};
      case EVT.ORG_METADATA: return {op:'DES',epistemic:'MEANT',label:'Org Metadata',desc:content.name||'org'};
      case EVT.ORG_INVITE: return {op:'CON',epistemic:'MEANT',label:'Org Invite',desc:content.userId};
      case EVT.SCHEMA_AUTHORITY: return {op:'CON',epistemic:'MEANT',label:'Authority Binding',desc:content.name?.slice(0,40)};
      case EVT.SCHEMA_PROP: return {op:'REC',epistemic:'MEANT',label:'Schema Propagation',desc:`${content.level}: ${content.prompt_key}`};
      case EVT.OBSERVATION: return {op:'INS',epistemic:'MEANT',label:'Provider Observation',desc:`${content.prompt_id}: ${content.value}`};
      case EVT.INVITE_TOKEN: return {op:'CON',epistemic:'MEANT',label:'Invite Token',desc:'QR/link token'};
      case EVT.ENCOUNTER_PROV: return {op:'INS',epistemic:'MEANT',label:'Provisional Encounter',desc:content.description?.slice(0,40)};
      case EVT.MATCH_TOKEN: return {op:'CON',epistemic:'MEANT',label:'Match Token',desc:'Blind matching token'};
      case EVT.MATCH_HIT: return {op:'SUP',epistemic:'MEANT',label:'Match Hit',desc:'Potential duplicate'};
      case EVT.MATCH_RESOLVE: return {op:'REC',epistemic:'MEANT',label:'Match Resolved',desc:content.resolution};
      case EVT.SCHEMA_PROMPT: return {op:'DES',epistemic:'MEANT',label:'Schema Prompt',desc:content.question?.slice(0,40)};
      case EVT.SCHEMA_DEF: return {op:'DES',epistemic:'MEANT',label:'Schema Definition',desc:content.name?.slice(0,40)};
      case EVT.SCHEMA_TRANSFORM: return {op:'REC',epistemic:'MEANT',label:'Transform Rule',desc:`${Object.keys(content.transforms||{}).length} transforms`};
      case EVT.NET_MEMBERS: return {op:'CON',epistemic:'MEANT',label:'Network Members',desc:`${(content.organizations||[]).length} orgs`};
      case EVT.GOV_PROPOSAL: return {op:'INS',epistemic:'MEANT',label:'Governance Proposal',desc:content.summary?.slice(0,50)};
      case EVT.GOV_RHYTHM: return {op:'REC',epistemic:'MEANT',label:'Governance Rhythm',desc:content.name};
      case EVT.SCHEMA_FIELD: return {op:'DES',epistemic:'MEANT',label:'Schema Field',desc:content.question_text?.slice(0,40)};
      case EVT.SCHEMA_BINDING: return {op:'DES',epistemic:'MEANT',label:'Framework Binding',desc:`${content.field_id} â†’ ${content.framework?.name?.slice(0,25)}`};
      case 'm.room.encryption': return {op:'REC',epistemic:'GIVEN',label:'Encryption Policy',desc:content.algorithm};
      case 'm.room.tombstone': return {op:'NUL',epistemic:'MEANT',label:'Room Tombstoned',desc:`â†’ ${content.replacement_room?.slice(0,24)}â€¦`};
      case 'm.room.create': return {op:'INS',epistemic:'GIVEN',label:'Room Created',desc:'New room initialized'};
      case 'm.room.member': {
        const ms=content.membership;
        if(ms==='join')return{op:'CON',epistemic:'MEANT',label:'Member Joined',desc:ev.getStateKey()};
        if(ms==='invite')return{op:'CON',epistemic:'MEANT',label:'Member Invited',desc:ev.getStateKey()};
        if(ms==='leave')return{op:'NUL',epistemic:'MEANT',label:'Member Left/Kicked',desc:ev.getStateKey()};
        return{op:'ALT',epistemic:'MEANT',label:`Membership: ${ms}`,desc:ev.getStateKey()};
      }
      default: return {op:'INS',epistemic:'GIVEN',label:type,desc:'State event'};
    }
  }
  if (type === EVT.METRIC) return {op:'INS',epistemic:'MEANT',label:'Metric Event',desc:`${content.observation?.category}: ${content.observation?.value}`};
  if (type === 'm.room.message') {
    const cvType = content[`${NS}.type`];
    if (cvType==='request') return {op:'DES',epistemic:'MEANT',label:'Info Request',desc:content.body?.slice(0,60)};
    if (cvType==='note') return {op:'INS',epistemic:roomInfo.type==='vault'?'GIVEN':'MEANT',label:'Bridge Note',desc:content.body?.slice(0,60)};
    return {op:'INS',epistemic:'GIVEN',label:'Message',desc:content.body?.slice(0,60)};
  }
  return {op:'INS',epistemic:'GIVEN',label:type,desc:'Timeline event'};
};

const ActivityStream = ({session}) => {
  const [events,setEvents] = useState([]); const [rooms,setRooms] = useState([]);
  const [loading,setLoading] = useState(true); const [filter,setFilter] = useState({roomType:'all',operator:'all',epistemic:'all'});
  const [expanded,setExpanded] = useState(new Set()); const [autoRefresh,setAutoRefresh] = useState(false);

  const loadEvents = useCallback(async () => {
    setLoading(true);
    try {
      // Single scan: classify all rooms without per-room HTTP calls
      const scanned = await svc.scanRooms();
      const roomIds = svc.client ? svc.client.getRooms().map(r=>r.roomId) : Object.keys(scanned);
      const allRooms=[]; const allEvents=[];
      for (const rid of roomIds) {
        const roomInfo = await classifyRoom(rid, scanned[rid]); allRooms.push({id:rid,...roomInfo});
        if (svc.client) {
          const room = svc.client.getRoom(rid);
          if (room) {
            for (const ev of room.getLiveTimeline().getEvents()) {
              const cls = classifyEvent(ev, roomInfo);
              allEvents.push({ id:ev.getId(),roomId:rid,roomInfo,sender:ev.getSender(),ts:ev.getTs(),type:ev.getType(),
                stateKey:(ev.isState&&ev.isState())?ev.getStateKey():null,content:ev.getContent(),isState:ev.isState&&ev.isState(),...cls });
            }
          }
        }
      }
      allEvents.sort((a,b)=>b.ts-a.ts); setRooms(allRooms); setEvents(allEvents);
    } catch(e){console.error('Activity error:',e);}
    setLoading(false);
  },[]);

  useEffect(()=>{loadEvents();},[]);
  useEffect(()=>{if(!autoRefresh)return;const iv=setInterval(loadEvents,5000);return()=>clearInterval(iv);},[autoRefresh]);

  const filtered = useMemo(()=>events.filter(ev=>{
    if(filter.roomType!=='all'&&ev.roomInfo.type!==filter.roomType)return false;
    if(filter.operator!=='all'&&ev.op!==filter.operator)return false;
    if(filter.epistemic!=='all'&&ev.epistemic!==filter.epistemic)return false;
    return true;
  }),[events,filter]);

  const stats = useMemo(()=>{const s={total:events.length,byOp:{},byRoom:{},given:0,meant:0};
    events.forEach(ev=>{s.byOp[ev.op]=(s.byOp[ev.op]||0)+1;s.byRoom[ev.roomInfo.type]=(s.byRoom[ev.roomInfo.type]||0)+1;if(ev.epistemic==='GIVEN')s.given++;else s.meant++;});
    return s;
  },[events]);

  const toggle=(id)=>setExpanded(p=>{const n=new Set(p);n.has(id)?n.delete(id):n.add(id);return n;});

  if(loading)return<div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}><Spin s={28}/></div>;

  return <div className="anim-up" style={{maxWidth:960,margin:'0 auto'}}>
    <div style={{marginBottom:24}}>
      <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:6}}>
        <I n="zap" s={20} c="var(--orange)"/>
        <h2 style={{fontFamily:'var(--serif)',fontSize:24,fontWeight:700,letterSpacing:'-0.02em'}}>Activity Stream</h2>
        <span className="tag tag-orange">DEV</span>
      </div>
      <p style={{color:'var(--tx-1)',fontSize:13}}>Live EO event stream across all rooms. Operator classification, epistemic layer, and room topology.</p>
    </div>

    {/* Room topology */}
    <div className="card" style={{marginBottom:16,padding:16}}>
      <span className="section-label">ROOM TOPOLOGY ({rooms.length} rooms)</span>
      <div style={{display:'flex',gap:8,flexWrap:'wrap',marginTop:8}}>
        {rooms.map(r=><div key={r.id} style={{padding:'6px 10px',borderRadius:'var(--r)',background:`var(--${r.color}-dim)`,border:`1px solid var(--${r.color})20`,display:'flex',alignItems:'center',gap:6}}>
          <div style={{width:7,height:7,borderRadius:'50%',background:`var(--${r.color})`}}/>
          <span style={{fontSize:10,fontWeight:600,color:`var(--${r.color})`}}>{r.label}</span>
          <span style={{fontSize:8,fontFamily:'var(--mono)',color:'var(--tx-3)'}}>{r.id.slice(0,20)}â€¦</span>
        </div>)}
      </div>
    </div>

    {/* Stats */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(120px,1fr))',gap:8,marginBottom:16}}>
      {[{l:'TOTAL',v:stats.total},{l:'GIVEN',v:stats.given,c:'teal'},{l:'MEANT',v:stats.meant,c:'gold'},{l:'ROOMS',v:rooms.length}].map((s,i)=>
        <div key={i} className="card" style={{padding:12}}><span className="section-label">{s.l}</span>
          <span style={{fontSize:20,fontWeight:700,color:s.c?`var(--${s.c})`:'var(--tx-0)'}}>{s.v}</span></div>)}
    </div>

    {/* Filters */}
    <div style={{display:'flex',gap:6,marginBottom:12,flexWrap:'wrap',alignItems:'center'}}>
      <select value={filter.roomType} onChange={e=>setFilter({...filter,roomType:e.target.value})} style={{width:'auto',padding:'5px 8px',fontSize:11}}>
        <option value="all">All Rooms</option>
        {['vault','bridge','roster','schema','metrics','network'].map(t=><option key={t} value={t}>{t}</option>)}
      </select>
      <select value={filter.operator} onChange={e=>setFilter({...filter,operator:e.target.value})} style={{width:'auto',padding:'5px 8px',fontSize:11}}>
        <option value="all">All Operators</option>
        {OPERATORS.map(op=><option key={op} value={op}>{op}</option>)}
      </select>
      <select value={filter.epistemic} onChange={e=>setFilter({...filter,epistemic:e.target.value})} style={{width:'auto',padding:'5px 8px',fontSize:11}}>
        <option value="all">All Epistemic</option><option value="GIVEN">GIVEN</option><option value="MEANT">MEANT</option>
      </select>
      <div style={{marginLeft:'auto',display:'flex',gap:6,alignItems:'center'}}>
        <span style={{fontSize:9,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>AUTO</span>
        <Toggle on={autoRefresh} onChange={()=>setAutoRefresh(!autoRefresh)}/>
        <button onClick={loadEvents} className="b-gho b-xs"><I n="search" s={10}/></button>
      </div>
    </div>
    <div style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)',marginBottom:8}}>Showing {filtered.length} of {events.length}</div>

    {/* Events */}
    <div style={{display:'flex',flexDirection:'column',gap:3}}>
      {filtered.length===0&&<div className="card" style={{textAlign:'center',padding:'30px 20px',borderStyle:'dashed'}}><I n="search" s={24}/><p style={{color:'var(--tx-3)',marginTop:8,fontSize:12}}>No events match filters</p></div>}
      {filtered.slice(0,100).map((ev,i)=>{
        const isExp=expanded.has(ev.id);const opC=OP_COLORS[ev.op]||'blue';const rmC=ROOM_COLORS[ev.roomInfo.type]||'orange';
        return <div key={ev.id||i} style={{background:'var(--bg-2)',border:'1px solid var(--border-0)',borderRadius:'var(--r)',overflow:'hidden'}}>
          <div onClick={()=>toggle(ev.id)} style={{padding:'8px 12px',display:'flex',alignItems:'center',gap:6,cursor:'pointer'}}
            onMouseEnter={e=>e.currentTarget.style.background='var(--bg-3)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
            <div style={{width:7,height:7,borderRadius:'50%',background:`var(--${opC})`,flexShrink:0}}/>
            <span className={`tag tag-${opC}`} style={{fontSize:9,minWidth:26,textAlign:'center'}}>{ev.op}</span>
            <span className={`tag tag-${rmC}`} style={{fontSize:8.5}}>{ev.roomInfo.type.toUpperCase()}</span>
            <span className={`tag ${ev.epistemic==='GIVEN'?'tag-teal':'tag-gold'}`} style={{fontSize:8.5}}>{ev.epistemic}</span>
            <span style={{fontSize:11.5,fontWeight:500,flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ev.label}</span>
            <span style={{fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)',maxWidth:160,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ev.desc}</span>
            <span style={{fontSize:8.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{ev.ts?new Date(ev.ts).toLocaleTimeString():''}</span>
            <I n={isExp?'x':'chevR'} s={10} c="var(--tx-3)"/>
          </div>
          {isExp&&<div className="anim-in" style={{borderTop:'1px solid var(--border-0)',padding:'12px 14px',background:'var(--bg-1)'}}>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
              {[['EVENT TYPE',ev.type],['SENDER',ev.sender],['ROOM',ev.roomId],['TIMESTAMP',ev.ts?new Date(ev.ts).toISOString():'â€”']].map(([l,v])=>
                <div key={l}><span className="section-label">{l}</span><span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-1)',display:'block',wordBreak:'break-all'}}>{v}</span></div>)}
            </div>
            <span className="section-label">RAW CONTENT</span>
            <pre style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-1)',background:'var(--bg-0)',border:'1px solid var(--border-0)',borderRadius:'var(--r)',padding:10,overflow:'auto',maxHeight:200,whiteSpace:'pre-wrap',wordBreak:'break-all',marginTop:4}}>
{JSON.stringify(ev.content,null,2)}</pre>
          </div>}
        </div>;
      })}
    </div>
  </div>;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WELCOME / INVITATION SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const WelcomeScreen = ({onContinue}) => (
  <div className="grid-bg" style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center',position:'relative'}}>
    <div style={{position:'absolute',top:16,right:16}}><ThemeToggle/></div>
    <div className="anim-up" style={{width:'100%',maxWidth:600,padding:20}}>
      <div style={{background:'var(--bg-1)',border:'1px solid var(--border-0)',borderRadius:'var(--r-lg)',padding:'48px 44px',position:'relative',overflow:'hidden'}}>
        <div style={{position:'absolute',top:0,left:0,right:0,height:3,background:'linear-gradient(90deg, var(--gold), var(--teal), var(--blue))'}}/>

        <div style={{display:'flex',alignItems:'center',gap:14,marginBottom:6}}>
          <div style={{width:48,height:48,borderRadius:'var(--r-lg)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)'}}><I n="shield" s={26}/></div>
          <div><h1 style={{fontSize:28,fontWeight:800,fontFamily:'var(--serif)',letterSpacing:'-0.02em'}}>Khora</h1>
            <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-2)',letterSpacing:'.08em'}}>SOVEREIGN CASE MANAGEMENT</span></div>
        </div>

        <p style={{color:'var(--tx-0)',fontSize:15,marginTop:24,lineHeight:1.7,fontWeight:500}}>
          You've been invited to access Khora â€” a system where <em>you</em> own your data.
        </p>
        <p style={{color:'var(--tx-1)',fontSize:13.5,marginTop:12,lineHeight:1.7}}>
          Khora runs on the <strong style={{color:'var(--tx-0)'}}>Matrix protocol</strong>, which means your information lives on a server you choose â€” not locked inside a single company's platform. To get started you'll need a free Matrix account.
        </p>

        <div style={{background:'var(--bg-2)',border:'1px solid var(--border-1)',borderRadius:'var(--r-lg)',padding:'20px 22px',marginTop:24}}>
          <span style={{fontFamily:'var(--mono)',fontSize:10.5,color:'var(--gold)',letterSpacing:'.06em',fontWeight:600,display:'block',marginBottom:12}}>GETTING STARTED</span>
          <div style={{display:'flex',gap:14,marginBottom:16}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'var(--teal-dim)',color:'var(--teal)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:800,fontFamily:'var(--mono)',flexShrink:0,marginTop:1}}>1</div>
            <div>
              <div style={{fontSize:13.5,fontWeight:600,color:'var(--tx-0)',marginBottom:4}}>Create a Matrix account</div>
              <div style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6}}>
                You can register with any Matrix homeserver. For a free, general-purpose account we recommend <a href="https://app.element.io/#/register" target="_blank" rel="noopener noreferrer" style={{color:'var(--teal)',textDecoration:'none',fontWeight:600}}>matrix.org</a> â€” sign up takes under a minute.
              </div>
              <div style={{fontSize:11.5,color:'var(--tx-2)',lineHeight:1.5,marginTop:6}}>
                If your organization runs its own server, use that address instead. Your admin will know the homeserver URL.
              </div>
            </div>
          </div>
          <div style={{display:'flex',gap:14,marginBottom:16}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'var(--teal-dim)',color:'var(--teal)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:800,fontFamily:'var(--mono)',flexShrink:0,marginTop:1}}>2</div>
            <div>
              <div style={{fontSize:13.5,fontWeight:600,color:'var(--tx-0)',marginBottom:4}}>Sign in here</div>
              <div style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6}}>
                Use your Matrix username (e.g. <span style={{fontFamily:'var(--mono)',color:'var(--tx-0)',fontSize:12}}>@you:matrix.org</span>) and password to connect.
              </div>
            </div>
          </div>
          <div style={{display:'flex',gap:14}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'var(--teal-dim)',color:'var(--teal)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:800,fontFamily:'var(--mono)',flexShrink:0,marginTop:1}}>3</div>
            <div>
              <div style={{fontSize:13.5,fontWeight:600,color:'var(--tx-0)',marginBottom:4}}>Roles are detected automatically</div>
              <div style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6}}>
                Khora infers your <strong style={{color:'var(--teal)'}}>Client</strong>, <strong style={{color:'var(--gold)'}}>Provider</strong>, Org Admin, and Network roles from room membership. If you hold multiple roles, you can switch contexts without signing out.
              </div>
            </div>
          </div>
        </div>

        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginTop:20,fontSize:12,color:'var(--tx-1)',lineHeight:1.6,display:'flex',gap:10,alignItems:'flex-start'}}>
          <div style={{flexShrink:0,marginTop:1}}><I n="lock" s={15}/></div>
          <span>Your data is encrypted per-field on your device before it ever leaves. Providers see only the specific fields you share. You can revoke access at any time.</span>
        </div>

        <button onClick={onContinue} className="b-pri" style={{width:'100%',padding:14,fontSize:15,marginTop:28,display:'flex',alignItems:'center',justifyContent:'center',gap:10}}>
          Get Started <I n="chevR" s={18}/>
        </button>

        <p style={{textAlign:'center',marginTop:16,fontSize:11.5,color:'var(--tx-3)',fontFamily:'var(--mono)',letterSpacing:'.03em'}}>
          Already have an account? Click above to sign in.
        </p>
      </div>
    </div>
  </div>
);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LoginScreen = ({onLogin}) => {
  const [mode,setMode] = useState('login'); // login | register
  const [hs,setHs] = useState('matrix.org'); const [user,setUser] = useState(''); const [pass,setPass] = useState('');
  const [loading,setLoading] = useState(false); const [err,setErr] = useState('');

  // Extract host server from username if present (e.g. @user:matrix.org -> matrix.org)
  const userHost = user.includes(':') ? user.split(':').slice(1).join(':') : '';
  const effectiveHs = userHost || hs;
  const hideHs = !!userHost;

  const go = async (e) => {
    e.preventDefault(); setLoading(true); setErr('');
    try {
      if (mode === 'register') {
        const baseUrl = effectiveHs.startsWith('http') ? effectiveHs : `https://${effectiveHs}`;
        const resp = await fetch(`${baseUrl}/_matrix/client/v3/register`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ username: user.replace(/^@/,'').split(':')[0], password: pass, auth: { type: 'm.login.dummy' } })
        });
        if (!resp.ok) { const e = await resp.json().catch(()=>({})); throw new Error(e.error || `Registration failed (${resp.status}). Try logging in if account exists.`); }
      }
      const s = await svc.login(effectiveHs, user, pass); onLogin(s);
    }
    catch (e) { setErr(e.message); }
    setLoading(false);
  };

  return <div className="grid-bg" style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center',position:'relative'}}>
    <div style={{position:'absolute',top:16,right:16}}><ThemeToggle/></div>
    <div className="anim-up" style={{width:'100%',maxWidth:440,padding:20}}>
      <div style={{background:'var(--bg-1)',border:'1px solid var(--border-0)',borderRadius:'var(--r-lg)',padding:'44px 40px',position:'relative',overflow:'hidden'}}>
        <div style={{position:'absolute',top:0,left:0,right:0,height:3,background:'linear-gradient(90deg, var(--gold), var(--teal), var(--blue))'}}/>
        <div style={{display:'flex',alignItems:'center',gap:14,marginBottom:10}}>
          <div style={{width:44,height:44,borderRadius:'var(--r-lg)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)'}}><I n="shield" s={24}/></div>
          <div><h1 style={{fontSize:24,fontWeight:800,fontFamily:'var(--serif)',letterSpacing:'-0.02em'}}>Khora</h1>
            <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-2)',letterSpacing:'.08em'}}>SOVEREIGN CASE MANAGEMENT</span></div>
        </div>
        <p style={{color:'var(--tx-1)',fontSize:13,marginTop:18,marginBottom:24,lineHeight:1.65}}>
          Client-owned data vaults on Matrix. Per-field encryption. Providers see only what clients share. Each tile is yours to place.
        </p>

        <div className="tabs" style={{marginBottom:20}}>
          <div className={`tab ${mode==='login'?'active':''}`} onClick={()=>{setMode('login');setErr('')}}>Sign In</div>
          <div className={`tab ${mode==='register'?'active':''}`} onClick={()=>{setMode('register');setErr('')}}>Create Account</div>
        </div>

        {mode==='register'&&<div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--teal)'}}>Pick any Matrix homeserver</strong> â€” we recommend <strong style={{color:'var(--tx-0)'}}>matrix.org</strong> for a free, general-purpose account. If your organization runs its own server, enter that homeserver URL instead.
        </div>}

        <form onSubmit={go}>
          <div style={{marginBottom:14}}><span className="section-label">USERNAME</span><input value={user} onChange={e=>setUser(e.target.value)} placeholder={mode==='register'?'choose a username':'@you:matrix.org'} autoComplete="username"/></div>
          <div style={{marginBottom:14}}><span className="section-label">PASSWORD</span><input type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autoComplete={mode==='register'?'new-password':'current-password'}/></div>
          {!hideHs&&<div style={{marginBottom:14}}><span className="section-label">HOMESERVER</span><input value={hs} onChange={e=>setHs(e.target.value)} placeholder="matrix.org"/></div>}
          {err&&<div style={{background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.2)',borderRadius:'var(--r)',padding:'9px 14px',fontSize:12.5,color:'var(--red)',marginBottom:16}}>{err}</div>}
          <button type="submit" className="b-pri" disabled={loading} style={{width:'100%',padding:12,fontSize:14,display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
            {loading?<Spin s={16}/>:<I n="lock" s={16}/>} {loading?'Connecting...':(mode==='register'?'Create Account & Connect':'Connect')}
          </button>
        </form>
        <div style={{marginTop:16,display:'flex',alignItems:'center',gap:8,justifyContent:'center'}}>
          <div style={{width:6,height:6,borderRadius:'50%',background:typeof matrixcs!=='undefined'?'var(--green)':'var(--gold)'}}/>
          <span style={{fontFamily:'var(--mono)',fontSize:10.5,color:'var(--tx-3)'}}>
            {typeof matrixcs!=='undefined'?'matrix-js-sdk + Megolm E2EE':'SDK loading â€” fallback ready'}
          </span>
        </div>
      </div>
    </div>
  </div>;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLIENT APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ClientApp = ({session, onLogout, showToast}) => {
  const [vaultRoom, setVaultRoom] = useState(null);
  const [schemaRoom, setSchemaRoom] = useState(null);
  const [vaultData, setVaultData] = useState({});
  const [observations, setObservations] = useState([]);
  const [metricsConsent, setMetricsConsent] = useState({enabled:false,categories:[]});
  const [providers, setProviders] = useState([]);
  const [view, setView] = useState('vault');
  const [activeBridge, setActiveBridge] = useState(null);
  const [loading, setLoading] = useState(true);
  const [editModal, setEditModal] = useState(false);
  const [editData, setEditData] = useState({});
  const [addProviderModal, setAddProviderModal] = useState(false);
  const [newProviderId, setNewProviderId] = useState('');
  const [bridgeMessages, setBridgeMessages] = useState([]);
  const [msgText, setMsgText] = useState('');
  // Inbox chat state
  const [inboxConvo, setInboxConvo] = useState(null); // provider index for active inbox conversation
  const [inboxMessages, setInboxMessages] = useState([]);
  const [inboxMsgText, setInboxMsgText] = useState('');
  const [hardRevokeTarget, setHardRevokeTarget] = useState(null);
  const [obsModal, setObsModal] = useState(null); // prompt object or null
  const [obsValue, setObsValue] = useState('');
  const [obsDate, setObsDate] = useState(new Date().toISOString().slice(0,10));
  const [obsFreeText, setObsFreeText] = useState('');
  const [initError, setInitError] = useState(null);
  const [claimedRooms, setClaimedRooms] = useState([]);
  const [pendingClaims, setPendingClaims] = useState([]);
  const [customFieldDefs, setCustomFieldDefs] = useState([]); // [{key,label,category,sensitive}]
  const [addFieldModal, setAddFieldModal] = useState(false);
  const [newFieldLabel, setNewFieldLabel] = useState('');
  const [newFieldCategory, setNewFieldCategory] = useState('details');
  const [newFieldSensitive, setNewFieldSensitive] = useState(false);

  useEffect(() => { initVault(); }, []);

  // Merge built-in fields with client-defined custom fields
  const allFields = useMemo(() => [...VAULT_FIELDS, ...customFieldDefs], [customFieldDefs]);
  const allCategories = useMemo(() => {
    const cats = [...FIELD_CATEGORIES];
    for (const f of customFieldDefs) { if (!cats.includes(f.category)) cats.push(f.category); }
    return cats;
  }, [customFieldDefs]);

  const handleAddCustomField = async () => {
    const label = newFieldLabel.trim();
    if (!label) return;
    const key = 'custom_' + label.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
    if (allFields.some(f => f.key === key)) { showToast('A field with that name already exists','error'); return; }
    const def = {key, label, category: newFieldCategory, sensitive: newFieldSensitive, custom: true};
    const updated = [...customFieldDefs, def];
    await emitOp(vaultRoom, 'INS', {field:key,entity:'custom_field_def'}, {label,category:newFieldCategory,sensitive:newFieldSensitive}, vaultFrame());
    await saveSnapshot(undefined, undefined, undefined, updated);
    setAddFieldModal(false); setNewFieldLabel(''); setNewFieldCategory('details'); setNewFieldSensitive(false);
    showToast(`Custom field "${label}" created`, 'success');
  };

  const handleDeleteCustomField = async (fieldKey) => {
    const updated = customFieldDefs.filter(f => f.key !== fieldKey);
    const updatedData = {...vaultData};
    delete updatedData[fieldKey];
    await emitOp(vaultRoom, 'NUL', {field:fieldKey,entity:'custom_field_def'}, {reason:'client_deleted'}, vaultFrame());
    await saveSnapshot(updatedData, undefined, undefined, updated);
    showToast('Custom field removed', 'warn');
  };

  const vaultFrame = (room) => ({type:'vault',room:room||vaultRoom,role:'client',epistemic:'GIVEN'});
  const bridgeFrame = (room) => ({type:'bridge',room,role:'client',epistemic:'MEANT'});

  const initVault = async () => {
    setLoading(true);
    setInitError(null);
    try {
      // Phase 1: Auto-join any invited client_record rooms so they appear in scanRooms
      try {
        const invited = await svc.scanInvitedRooms([EVT.IDENTITY]);
        for (const [rid, state] of Object.entries(invited)) {
          const id = state[EVT.IDENTITY];
          if (id?.account_type === 'client_record' && id.client_matrix_id === svc.userId) {
            try { await svc.joinRoom(rid); } catch (e) { console.warn('Auto-join failed for', rid, e.message); }
          }
        }
      } catch (e) { console.warn('Invited room scan failed:', e.message); }

      // Phase 2: Scan joined rooms (now includes any rooms we just auto-joined)
      const scanned = await svc.scanRooms([EVT.PROVIDER_PROFILE]);
      let vault = null, schema = null;
      const detectedPending = [], detectedClaimed = [];
      const bridgeProfiles = {}; // bridgeRoomId â†’ provider profile
      for (const [rid, state] of Object.entries(scanned)) {
        const id = state[EVT.IDENTITY];
        if (id?.account_type === 'client' && id.owner === svc.userId) vault = rid;
        if (id?.account_type === 'schema' && id.owner === svc.userId) schema = rid;
        // Detect client_record rooms where this client was invited or has claimed
        if (id?.account_type === 'client_record' && id.client_matrix_id === svc.userId) {
          if (id.status === 'claimed' && id.owner === svc.userId) {
            detectedClaimed.push({roomId: rid, ...id});
          } else {
            detectedPending.push({roomId: rid, ...id});
          }
        }
        // Collect provider profiles from bridge rooms
        const bridgeMeta = state[EVT.BRIDGE_META];
        const provProfile = state[EVT.PROVIDER_PROFILE];
        if (bridgeMeta && bridgeMeta.client === svc.userId && provProfile) {
          bridgeProfiles[rid] = provProfile;
        }
      }
      if (!vault) {
        vault = await svc.createRoom('[Khora Vault]', 'Personal data vault', [
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'client',owner:svc.userId,created:Date.now()}},
          {type:EVT.VAULT_SNAPSHOT,state_key:'',content:{fields:{},observations:[],
            metrics_consent:{enabled:false,categories:[]},
            matching_consent:{enabled:false,layers:[],network_id:null,last_token_ts:null},
            custom_field_defs:[]}},
          {type:EVT.VAULT_PROVIDERS,state_key:'',content:{providers:[]}},
        ]);
        showToast('Vault created â€” encrypted room ready','success');
      }
      if (!schema) {
        schema = await svc.createRoom('[Khora Schema]','Schema definitions', [
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'schema',owner:svc.userId,created:Date.now()}},
        ]);
        const allSeeds = [
          ...DEFAULT_PROMPTS.map(p => () => svc.setState(schema, EVT.SCHEMA_PROMPT, p, p.key)),
          ...DEFAULT_DEFINITIONS.map(d => () => svc.setState(schema, EVT.SCHEMA_DEF, d, d.key)),
          ...DEFAULT_AUTHORITIES.map(a => () => svc.setState(schema, EVT.SCHEMA_AUTHORITY, a, a.id)),
          [() => svc.setState(schema, EVT.SCHEMA_TRANSFORM, {id:'transform_default',transforms:DEFAULT_TRANSFORMS}, 'default')],
        ].flat();
        for (let i = 0; i < allSeeds.length; i++) {
          await allSeeds[i]();
          if (i % 3 === 2) await new Promise(r => setTimeout(r, 200));
        }
      }
      setVaultRoom(vault); setSchemaRoom(schema);
      await loadVault(vault, bridgeProfiles);
      setPendingClaims(detectedPending);
      setClaimedRooms(detectedClaimed);
    } catch (e) {
      console.error('Vault init failed:', e);
      setInitError(e.message || 'Failed to initialize vault.');
    }
    setLoading(false);
  };

  const loadVault = async (rid, bridgeProfiles) => {
    const snap = await svc.getState(rid, EVT.VAULT_SNAPSHOT);
    setVaultData(snap?.fields || {});
    setObservations(snap?.observations || []);
    setMetricsConsent(snap?.metrics_consent || {enabled:false,categories:[]});
    setCustomFieldDefs(snap?.custom_field_defs || []);
    const idx = await svc.getState(rid, EVT.VAULT_PROVIDERS);
    // Enrich providers with profile data from bridge rooms
    const enrichedProviders = (idx?.providers || []).map(p => {
      const profile = bridgeProfiles?.[p.bridgeRoomId];
      return profile ? {...p, providerProfile: profile, providerName: profile.display_name || p.providerName} : p;
    });
    setProviders(enrichedProviders);
  };

  const saveSnapshot = async (fields, obs, mc, cfd) => {
    const snapshot = {fields:fields??vaultData, observations:obs??observations, metrics_consent:mc??metricsConsent, custom_field_defs:cfd??customFieldDefs};
    await svc.setState(vaultRoom, EVT.VAULT_SNAPSHOT, snapshot);
    setVaultData(snapshot.fields); setObservations(snapshot.observations); setMetricsConsent(snapshot.metrics_consent); setCustomFieldDefs(snapshot.custom_field_defs);
  };

  const saveProviderIndex = async (provs) => {
    await svc.setState(vaultRoom, EVT.VAULT_PROVIDERS, {providers:provs});
    setProviders(provs);
  };

  // Edit identity fields â€” emits INS or ALT per field
  const handleEditSave = async () => {
    const updated = {...vaultData, ...editData};
    for (const [key, val] of Object.entries(editData)) {
      if (val && !vaultData[key]) {
        await emitOp(vaultRoom, 'INS', {field:key,value:val}, {source:'client_input'}, vaultFrame());
      } else if (val && vaultData[key] && val !== vaultData[key]) {
        await emitOp(vaultRoom, 'ALT', {field:key,entity:'client_profile'}, {from:vaultData[key],to:val,source:'client_input'}, vaultFrame());
      } else if (!val && vaultData[key]) {
        await emitOp(vaultRoom, 'NUL', {field:key,entity:'client_profile'}, {reason:'client_cleared',previous_value:vaultData[key]}, vaultFrame());
      }
    }
    await saveSnapshot(updated);
    setEditModal(false);
    showToast('Vault updated','success');
    // Propagate to bridges (Â§8.3)
    for (const prov of providers) {
      const changedShared = Object.keys(editData).filter(k => prov.sharedFields?.[k]);
      if (changedShared.length > 0) await syncFieldsToBridge(prov.bridgeRoomId, prov.sharedFields, updated);
    }
  };

  // Record structured observation (Addendum A)
  const handleRecordObservation = async () => {
    if (!obsValue || !obsModal) return;
    const obs = { id:genOpId(), category:obsModal.key, value:obsValue, date:obsDate, prompt_id:obsModal.id,
      schema_version:obsModal.version||1, free_text:obsFreeText||undefined, ts:Date.now() };
    await emitOp(vaultRoom, 'INS', {type:'observation',category:obsModal.key,value:obsValue,date:obsDate},
      {reported_by:'client',method:'self_report',prompt:obsModal.question,free_text:obsFreeText||undefined}, vaultFrame());
    const newObs = [...observations, obs];
    await saveSnapshot(undefined, newObs);
    setObsModal(null); setObsValue(''); setObsFreeText('');
    showToast(`Observation recorded: ${obsModal.question}`,'success');
    // Emit to metrics if consent
    if (metricsConsent.enabled && obsModal.metrics && metricsConsent.categories?.includes(obsModal.category)) {
      for (const prov of providers) {
        if (prov.metricsRoom) {
          await emitMetric(prov.metricsRoom, svc.userId, {category:obsModal.key,value:obsValue,date_bucket:`${obsDate.slice(0,7)}`}, vaultData);
        }
      }
    }
  };

  const handleAddProvider = async () => {
    if (!newProviderId.trim()) return;
    try {
      const bridgeId = await svc.createRoom(`[Khora Bridge] ${svc.userId} â†” ${newProviderId}`, 'Khora bridge â€” shared data room', [
        {type:EVT.BRIDGE_META,state_key:'',content:{client:svc.userId,provider:newProviderId,created:Date.now(),status:'active'}},
        {type:EVT.BRIDGE_REFS,state_key:'',content:{fields:{}}},
      ]);
      await svc.invite(bridgeId, newProviderId);
      await emitOp(vaultRoom, 'CON', {source:svc.userId,destination:newProviderId,relationship:'client_provider'},
        {bridge_room:bridgeId,initiated_by:'client'}, vaultFrame());
      const newProv = {bridgeRoomId:bridgeId,providerUserId:newProviderId,sharedFields:{},providerName:newProviderId};
      await saveProviderIndex([...providers, newProv]);
      setAddProviderModal(false); setNewProviderId('');
      showToast(`Bridge created â€” invite sent to ${newProviderId}`,'success');
    } catch(e) { showToast('Failed: '+e.message,'error'); }
  };

  const syncFieldsToBridge = async (bridgeRoomId, sharedFields, data) => {
    const refs = {};
    for (const [fk, shared] of Object.entries(sharedFields)) {
      if (shared && data[fk]) {
        const keyB64 = await FieldCrypto.generateKey();
        const enc = await FieldCrypto.encrypt(data[fk], keyB64);
        refs[fk] = {...enc, key:keyB64};
      }
    }
    await svc.setState(bridgeRoomId, EVT.BRIDGE_REFS, {fields:refs, updated:Date.now()});
  };

  const handleToggleField = async (pi, fk) => {
    const prov = providers[pi];
    const newShared = {...prov.sharedFields, [fk]:!prov.sharedFields[fk]};
    const ups = [...providers]; ups[pi] = {...prov, sharedFields:newShared};
    await saveProviderIndex(ups);
    await emitOp(prov.bridgeRoomId, 'SEG', {field:fk,visibility:newShared[fk]?'shared':'revoked'},
      {provider:prov.providerUserId}, bridgeFrame(prov.bridgeRoomId), newShared[fk]?[]:[`prev_seg_${fk}`]);
    await syncFieldsToBridge(prov.bridgeRoomId, newShared, vaultData);
    const label = allFields.find(f=>f.key===fk)?.label||fk;
    showToast(newShared[fk]?`Shared ${label} â€” new key issued`:`Revoked ${label} â€” key destroyed`, newShared[fk]?'success':'warn');
  };

  const handleHardRevoke = async (pi) => {
    const prov = providers[pi];
    try {
      const newBridgeId = await svc.createRoom(`[Khora Bridge] ${svc.userId} â†” ${prov.providerUserId}`, 'Khora bridge â€” replaced', [
        {type:EVT.BRIDGE_META,state_key:'',content:{client:svc.userId,provider:prov.providerUserId,created:Date.now(),status:'active',previous:prov.bridgeRoomId}},
        {type:EVT.BRIDGE_REFS,state_key:'',content:{fields:{}}},
      ]);
      await emitOp(prov.bridgeRoomId, 'NUL', {entity:'bridge',field:'relationship'}, {reason:'hard_revoke'}, bridgeFrame(prov.bridgeRoomId));
      const stillShared = Object.fromEntries(Object.entries(prov.sharedFields).filter(([,v])=>v));
      if (Object.keys(stillShared).length > 0) await syncFieldsToBridge(newBridgeId, stillShared, vaultData);
      await svc.invite(newBridgeId, prov.providerUserId);
      await svc.tombstone(prov.bridgeRoomId, newBridgeId);
      try { await svc.kick(prov.bridgeRoomId, prov.providerUserId, 'Bridge rotated â€” data revoked'); } catch {}
      await emitOp(newBridgeId, 'CON', {source:svc.userId,destination:prov.providerUserId,relationship:'client_provider'},
        {bridge_room:newBridgeId,initiated_by:'client',reason:'hard_revoke_replacement'}, bridgeFrame(newBridgeId));
      const ups = [...providers]; ups[pi] = {...prov, bridgeRoomId:newBridgeId};
      await saveProviderIndex(ups);
      setHardRevokeTarget(null);
      showToast('Hard revoke complete â€” old room tombstoned, all keys rotated','success');
    } catch(e) { showToast('Hard revoke failed: '+e.message,'error'); }
  };

  const handleRemoveProvider = async (pi) => {
    const prov = providers[pi];
    try {
      try { await svc.kick(prov.bridgeRoomId, prov.providerUserId); } catch {}
      await svc.setState(prov.bridgeRoomId, EVT.BRIDGE_REFS, {fields:{},revoked:true,updated:Date.now()});
      await emitOp(vaultRoom, 'NUL', {entity:'provider_relationship',field:prov.providerUserId},
        {reason:'full_severance',bridge:prov.bridgeRoomId}, vaultFrame());
      await saveProviderIndex(providers.filter((_,i)=>i!==pi));
      showToast('Provider removed, all keys destroyed','warn');
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // â”€â”€â”€ Room claiming: client takes ownership of a provider-created client_record room â”€â”€â”€
  const claimFrame = (room) => ({type:'client_record',room,role:'client',epistemic:'GIVEN'});

  const handleClaimRoom = async (record) => {
    try {
      // 0. Ensure we've joined the room (required before writing state)
      try { await svc.joinRoom(record.roomId); } catch {}
      const prevIdentity = await svc.getState(record.roomId, EVT.IDENTITY);
      const previousOwner = prevIdentity?.owner || record.owner;
      // 1. Ensure client has PL 100 and provider drops to PL 50
      await svc.setPowerLevel(record.roomId, svc.userId, 100);
      if (previousOwner && previousOwner !== svc.userId) {
        await svc.setPowerLevel(record.roomId, previousOwner, 50);
      }
      // 2. Transfer ownership in identity state
      await svc.setState(record.roomId, EVT.IDENTITY, {
        ...prevIdentity,
        owner: svc.userId,
        status: 'claimed',
        claimed_at: Date.now(),
        claimed_by: svc.userId,
        previous_owner: previousOwner,
      });
      // 3. Emit ALT operation recording the ownership transfer
      await emitOp(record.roomId, 'ALT',
        {entity: 'room_ownership', field: 'owner'},
        {from: previousOwner, to: svc.userId, reason: 'client_claim'},
        claimFrame(record.roomId));
      // 4. Move from pending to claimed
      setPendingClaims(prev => prev.filter(r => r.roomId !== record.roomId));
      setClaimedRooms(prev => [...prev, {
        ...record, owner: svc.userId, status: 'claimed',
        claimed_at: Date.now(), previous_owner: previousOwner,
      }]);
      showToast(`Room claimed â€” you now have full control of "${record.client_name || 'this record'}"`, 'success');
    } catch (e) { showToast('Claim failed: ' + e.message, 'error'); }
  };

  const handleRevokeFromClaimed = async (record, targetUserId) => {
    try {
      await svc.kick(record.roomId, targetUserId, 'Removed by room owner');
      await emitOp(record.roomId, 'NUL',
        {entity: 'room_member', field: targetUserId},
        {reason: 'owner_revocation', removed_by: svc.userId},
        claimFrame(record.roomId));
      showToast(`Removed ${targetUserId} from room`, 'warn');
    } catch (e) { showToast('Remove failed: ' + e.message, 'error'); }
  };

  const handleDeleteClaimedRoom = async (record) => {
    try {
      // Tombstone the room â€” marks it as permanently closed
      await svc.setState(record.roomId, 'm.room.tombstone', {
        body: 'This room has been closed by the owner',
      });
      await emitOp(record.roomId, 'NUL',
        {entity: 'client_record', field: 'room'},
        {reason: 'owner_closed', closed_by: svc.userId},
        claimFrame(record.roomId));
      setClaimedRooms(prev => prev.filter(r => r.roomId !== record.roomId));
      showToast('Room closed permanently', 'warn');
    } catch (e) { showToast('Close failed: ' + e.message, 'error'); }
  };

  const handleMetricsToggle = async () => {
    const newConsent = {...metricsConsent, enabled:!metricsConsent.enabled,
      categories:!metricsConsent.enabled? DEFAULT_PROMPTS.filter(p=>p.metrics).map(p=>p.category) : []};
    await emitOp(vaultRoom, 'REC', {rule:'metrics_consent',scope:'vault'},
      {consent_level:newConsent.enabled?'anonymized_demographics':'none',categories:newConsent.categories}, vaultFrame());
    await saveSnapshot(undefined, undefined, newConsent);
    showToast(newConsent.enabled?'Metrics consent enabled â€” anonymized data will flow':'Metrics consent revoked',newConsent.enabled?'success':'warn');
  };

  const loadBridgeMessages = async (bid) => { setBridgeMessages(await svc.getMessages(bid)); };
  const handleSendBridgeMsg = async () => {
    if (!msgText.trim()||!activeBridge) return;
    await svc.sendMessage(activeBridge, msgText, {[`${NS}.type`]:'note'});
    setMsgText(''); setTimeout(()=>loadBridgeMessages(activeBridge),500);
  };
  const openBridge = (bid) => { setActiveBridge(bid); setView('bridge'); loadBridgeMessages(bid); };

  // â”€â”€â”€ Inbox chat functions â”€â”€â”€
  const loadInboxMessages = async (bid) => { setInboxMessages(await svc.getMessages(bid)); };
  const openInboxConvo = (providerIdx) => {
    setInboxConvo(providerIdx);
    const prov = providers[providerIdx];
    if (prov) loadInboxMessages(prov.bridgeRoomId);
  };
  const handleSendInboxMsg = async () => {
    if (!inboxMsgText.trim() || inboxConvo === null) return;
    const prov = providers[inboxConvo];
    if (!prov) return;
    await svc.sendMessage(prov.bridgeRoomId, inboxMsgText, {[`${NS}.type`]:'note'});
    setInboxMsgText('');
    setTimeout(() => loadInboxMessages(prov.bridgeRoomId), 500);
  };

  const activeProviderIdx = providers.findIndex(p=>p.bridgeRoomId===activeBridge);
  const activeProvider = activeProviderIdx>=0?providers[activeProviderIdx]:null;
  const filledFields = allFields.filter(f=>vaultData[f.key]);
  const sharedCount = providers.reduce((s,p)=>s+Object.values(p.sharedFields||{}).filter(Boolean).length,0);

  if(loading)return<div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}><Spin s={28}/></div>;

  if(initError) return <div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center',maxWidth:400,padding:20}}>
      <div style={{width:48,height:48,borderRadius:'var(--r-lg)',background:'var(--red-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--red)',margin:'0 auto 16px'}}><I n="alert-triangle" s={24}/></div>
      <h3 style={{fontSize:16,fontWeight:700,marginBottom:8}}>Vault Setup Failed</h3>
      <p style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6,marginBottom:16}}>{initError}</p>
      <div style={{display:'flex',gap:8,justifyContent:'center'}}>
        <button onClick={initVault} className="b-pri"><I n="refresh-cw" s={13}/>Retry</button>
        <button onClick={onLogout} className="b-gho">Sign Out</button>
      </div>
    </div>
  </div>;

  return <div style={{display:'flex',height:'100%'}}>
    {/* Sidebar */}
    <div className="app-sidebar" style={{width:250,minWidth:250,height:'100%',background:'var(--bg-1)',borderRight:'1px solid var(--border-0)',display:'flex',flexDirection:'column'}}>
      <div style={{padding:'18px 14px 14px',borderBottom:'1px solid var(--border-0)'}}>
        <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
          <div style={{width:28,height:28,borderRadius:'var(--r)',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)'}}><I n="shield" s={15}/></div>
          <span style={{fontFamily:'var(--serif)',fontWeight:700,fontSize:15}}>Khora</span>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:6,marginTop:8}}>
          <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}}>{svc.userId}</span>
          <span className="tag tag-teal">CLIENT</span>
        </div>
      </div>
      <div style={{flex:1,overflow:'auto',padding:'6px 6px'}}>
        {[{id:'vault',icon:'folder',label:'My Vault'},{id:'inbox',icon:'inbox',label:'Inbox'},
          {id:'observations',icon:'clipboard',label:'Observations'},
          {id:'providers',icon:'users',label:'My Providers'},{id:'records',icon:'shield',label:'My Records'},
          {id:'metrics',icon:'bar',label:'Metrics'},{id:'activity',icon:'zap',label:'Activity Stream'}
        ].map(item=><div key={item.id} onClick={()=>{setView(item.id);setActiveBridge(null);if(item.id!=='inbox')setInboxConvo(null)}}
          style={{padding:'9px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
            background:view===item.id&&!activeBridge?'var(--bg-4)':'transparent',
            borderLeft:view===item.id&&!activeBridge?'2px solid var(--teal)':'2px solid transparent',
            display:'flex',alignItems:'center',gap:8,transition:'all .15s',
            color:view===item.id&&!activeBridge?'var(--tx-0)':'var(--tx-1)'}}
          onMouseEnter={e=>{if(!(view===item.id&&!activeBridge))e.currentTarget.style.background='var(--bg-3)'}}
          onMouseLeave={e=>{if(!(view===item.id&&!activeBridge))e.currentTarget.style.background='transparent'}}>
          <I n={item.icon} s={14}/><span style={{fontSize:12.5,fontWeight:view===item.id?600:400}}>{item.label}</span>
          {item.id==='inbox'&&providers.length>0&&<span style={{marginLeft:'auto',background:'var(--teal)',color:'var(--bg-0)',fontSize:9,fontWeight:700,borderRadius:10,padding:'1px 6px',minWidth:16,textAlign:'center'}}>{providers.length}</span>}
          {item.id==='records'&&pendingClaims.length>0&&<span style={{marginLeft:'auto',background:'var(--gold)',color:'var(--bg-0)',fontSize:9,fontWeight:700,borderRadius:10,padding:'1px 6px',minWidth:16,textAlign:'center'}}>{pendingClaims.length}</span>}
        </div>)}
        {providers.length>0&&<><div style={{padding:'14px 10px 4px'}}><span className="section-label">BRIDGES</span></div>
          {providers.map((p,i)=><div key={p.bridgeRoomId} onClick={()=>openBridge(p.bridgeRoomId)}
            style={{padding:'8px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
              background:activeBridge===p.bridgeRoomId?'var(--bg-4)':'transparent',
              borderLeft:activeBridge===p.bridgeRoomId?'2px solid var(--gold)':'2px solid transparent',transition:'all .15s'}}
            onMouseEnter={e=>{if(activeBridge!==p.bridgeRoomId)e.currentTarget.style.background='var(--bg-3)'}}
            onMouseLeave={e=>{if(activeBridge!==p.bridgeRoomId)e.currentTarget.style.background='transparent'}}>
            <span style={{fontSize:12,fontWeight:activeBridge===p.bridgeRoomId?600:400,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.providerName||p.providerUserId}</span>
            <div style={{display:'flex',alignItems:'center',gap:4}}>
              {p.providerProfile?.org_membership?.verified && <><I n="shieldCheck" s={9} c="var(--blue)"/><span style={{fontSize:8.5,color:'var(--blue)',fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',maxWidth:100}}>{p.providerProfile.org_membership.org_name}</span></>}
              <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{Object.values(p.sharedFields||{}).filter(Boolean).length} fields</span>
            </div>
          </div>)}</>}
      </div>
      <div style={{padding:'8px 10px',borderTop:'1px solid var(--border-0)',display:'flex',flexDirection:'column',gap:6}}>
        <ThemeToggle style={{width:'100%',justifyContent:'center'}}/>
        <button onClick={onLogout} className="b-gho b-sm" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:5}}><I n="logout" s={12}/>Logout</button>
      </div>
    </div>

    {/* Main content */}
    <div className="app-main" style={{flex:1,overflow:'auto',padding:24}}>

      {/* VAULT VIEW */}
      {view==='vault'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Your Vault</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>All data encrypted in your private Matrix room. Only you can read this.</p></div>
          <div style={{display:'flex',gap:8}}>
            <button onClick={()=>setAddFieldModal(true)} className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>Add Field</button>
            <button onClick={()=>{setEditData({...vaultData});setEditModal(true)}} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="key" s={14}/>Edit Vault</button>
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(170px,1fr))',gap:10,marginBottom:24}}>
          {[{l:'Fields',v:`${filledFields.length}/${allFields.length}`,c:'teal',i:'folder'},
            {l:'Providers',v:providers.length,c:'gold',i:'users'},
            {l:'Observations',v:observations.length,c:'blue',i:'clipboard'},
            {l:'Shared Fields',v:sharedCount,c:'orange',i:'share'},
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {allCategories.map(cat=>{const fields=allFields.filter(f=>f.category===cat);const color=CAT_COLORS[cat]||'gold';
          if(!fields.length) return null;
          return <div key={cat} style={{marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
              <span style={{color:`var(--${color})`}}><I n={CAT_ICONS[cat]||'file'} s={13}/></span>
              <span className="section-label" style={{marginBottom:0}}>{(CAT_LABELS[cat]||cat.charAt(0).toUpperCase()+cat.slice(1)).toUpperCase()}</span></div>
            <div className="card" style={{padding:0,overflow:'hidden'}}>
              {fields.map((f,fi)=><div key={f.key} style={{padding:'10px 16px',borderBottom:fi<fields.length-1?'1px solid var(--border-0)':'none',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:12.5,fontWeight:500}}>{f.label}</span>
                  {f.sensitive&&<span className="tag tag-red" style={{fontSize:8.5}}>SENSITIVE</span>}
                  {f.custom&&<span className="tag tag-purple" style={{fontSize:8.5}}>CUSTOM</span>}</div>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontFamily:'var(--mono)',fontSize:11.5,color:vaultData[f.key]?'var(--tx-1)':'var(--tx-3)',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                    {vaultData[f.key]?(f.sensitive?'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢':vaultData[f.key]):'â€”'}</span>
                  {f.custom&&<span onClick={()=>handleDeleteCustomField(f.key)} style={{cursor:'pointer',color:'var(--tx-3)',transition:'color .15s'}}
                    onMouseEnter={e=>e.currentTarget.style.color='var(--red)'} onMouseLeave={e=>e.currentTarget.style.color='var(--tx-3)'}><I n="trash" s={12}/></span>}
                </div>
              </div>)}
            </div>
          </div>;
        })}
      </div>}

      {/* OBSERVATIONS VIEW (Addendum A) */}
      {view==='observations'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Observations</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Structured observations â€” the thermometer readings. What happened, not what it means.</p></div>
        </div>
        <div className="card" style={{marginBottom:20}}>
          <span className="section-label">RECORD NEW OBSERVATION</span>
          <p style={{fontSize:12,color:'var(--tx-2)',marginBottom:12}}>Choose a prompt to record what you observed. Each observation is an immutable GIVEN event in your vault.</p>
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(240px,1fr))',gap:8}}>
            {DEFAULT_PROMPTS.map(p=><div key={p.id} className="card-h" onClick={()=>{setObsModal(p);setObsValue('');setObsFreeText('');setObsDate(new Date().toISOString().slice(0,10))}}
              style={{padding:14}}>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6,flexWrap:'wrap'}}>
                <span className={`tag tag-${OBS_CAT_COLORS[p.category]||'blue'}`}>{p.category}</span>
                {p.sensitive&&<span className="tag tag-red" style={{fontSize:8}}>SENSITIVE</span>}
                {p.maturity && <MaturityBadge maturity={p.maturity}/>}
              </div>
              <span style={{fontSize:13,fontWeight:600,display:'block'}}>{p.question}</span>
              <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4}}>
                <span style={{fontSize:10.5,color:'var(--tx-3)'}}>{p.options.length} response options</span>
                {p.source && <SourceBadge source={p.source}/>}
              </div>
            </div>)}
          </div>
        </div>
        {/* Observation history */}
        <div className="card">
          <span className="section-label">OBSERVATION HISTORY ({observations.length})</span>
          {observations.length===0?<p style={{color:'var(--tx-3)',fontSize:12.5,padding:'16px 0',textAlign:'center'}}>No observations recorded yet</p>
          :<div style={{display:'flex',flexDirection:'column',gap:4,marginTop:8}}>
            {[...observations].reverse().map((obs,i)=>{
              const prompt = DEFAULT_PROMPTS.find(p=>p.key===obs.category);
              const optLabel = prompt?.options.find(o=>o.v===obs.value)?.l || obs.value;
              return <div key={obs.id||i} style={{padding:'10px 14px',background:'var(--bg-3)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:10}}>
                <span className={`tag tag-${OBS_CAT_COLORS[obs.category]||'blue'}`} style={{fontSize:9}}>{obs.category}</span>
                <span className="tag tag-teal" style={{fontSize:8.5}}>GIVEN</span>
                <span style={{fontSize:12,flex:1}}>{optLabel}</span>
                {obs.free_text&&<span style={{fontSize:10.5,color:'var(--tx-2)',fontStyle:'italic'}}>{obs.free_text}</span>}
                <span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{obs.date}</span>
              </div>;
            })}
          </div>}
        </div>
        {/* GIVEN/MEANT divide for client observations with framework bindings */}
        {observations.filter(obs => FRAMEWORK_BINDINGS[obs.category]?.bindings?.[obs.value]).length > 0 && <div style={{marginTop:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'linear-gradient(135deg,var(--teal),var(--gold))',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-0)',fontSize:11,fontWeight:800}}>&#8594;</div>
            <span style={{fontFamily:'var(--serif)',fontSize:15,fontWeight:700}}>What Your Observations Mean</span>
            <span className="gm-sup-badge">GIVEN &#8594; MEANT</span>
          </div>
          <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Your observations are facts. Below you can see how different institutional frameworks interpret those same facts differently.</p>
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            {observations.filter(obs => FRAMEWORK_BINDINGS[obs.category]?.bindings?.[obs.value]).slice(-3).reverse().map((obs,i) =>
              <RecordGivenMeant key={obs.id||i} promptKey={obs.category} value={obs.value}
                reporter="Client self-report" timestamp={obs.ts}/>
            )}
          </div>
        </div>}
      </div>}

      {/* PROVIDERS VIEW */}
      {view==='providers'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>My Providers</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Each provider gets a dedicated encrypted bridge room. You control what they see.</p></div>
          <button onClick={()=>setAddProviderModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>Add Provider</button>
        </div>
        {providers.length===0?<div className="card" style={{textAlign:'center',padding:'40px 20px',borderStyle:'dashed'}}><I n="users" s={32}/><p style={{color:'var(--tx-2)',marginTop:10}}>No providers yet</p></div>
        :<div style={{display:'flex',flexDirection:'column',gap:10}}>
          {providers.map((prov,pi)=>{const shCount=Object.values(prov.sharedFields||{}).filter(Boolean).length;
            const pp = prov.providerProfile;
            const orgInfo = pp?.org_membership;
            return <div key={prov.bridgeRoomId} className="card" style={{padding:0,overflow:'hidden'}}>
              <div style={{padding:'14px 18px',display:'flex',alignItems:'center',justifyContent:'space-between',borderBottom:'1px solid var(--border-0)'}}>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,flexWrap:'wrap'}}>
                    <span style={{fontSize:14,fontWeight:600}}>{prov.providerName||prov.providerUserId}</span>
                    {pp?.title && <span style={{fontSize:11,color:'var(--tx-2)'}}>{pp.title}</span>}
                    <span className="tag tag-green"><I n="lock" s={9}/>E2EE</span>
                  </div>
                  {orgInfo?.verified ? <div style={{display:'flex',alignItems:'center',gap:5,marginTop:4}}>
                    <I n="shieldCheck" s={12} c="var(--blue)"/>
                    <span style={{fontSize:11,fontWeight:600,color:'var(--blue)'}}>{orgInfo.org_name}</span>
                    {orgInfo.email_verified ? <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>EMAIL VERIFIED</span>
                    : <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>VERIFIED</span>}
                    {orgInfo.role && <span style={{fontSize:9,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{orgInfo.role}</span>}
                  </div> : <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-3)'}}>Independent provider</span>}
                  {pp?.credentials && <div style={{marginTop:2}}><span style={{fontSize:9.5,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{pp.credentials}</span></div>}
                  <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-3)',display:'block',marginTop:2}}>Bridge: {prov.bridgeRoomId.slice(0,20)}â€¦</span>
                </div>
                <div style={{display:'flex',gap:4}}>
                  <button onClick={()=>openBridge(prov.bridgeRoomId)} className="b-gho b-sm">Open Bridge</button>
                  <button onClick={()=>setHardRevokeTarget(pi)} className="b-red b-sm"><I n="zap" s={11}/></button>
                  <button onClick={()=>handleRemoveProvider(pi)} className="b-gho b-sm" style={{color:'var(--red)'}}><I n="trash" s={12}/></button>
                </div>
              </div>
              <div style={{padding:'12px 18px'}}>
                <span className="section-label">FIELD-LEVEL SHARING</span>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0'}}>
                  {allFields.map(f=>{const isShared=prov.sharedFields?.[f.key]||false;const hasData=!!vaultData[f.key];
                    return <div key={f.key} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border-0)',marginRight:16}}>
                      <span style={{fontSize:12,color:hasData?'var(--tx-0)':'var(--tx-3)'}}>{f.label}{f.custom?' âœ¦':''}</span>
                      <Toggle on={isShared} onChange={()=>handleToggleField(pi,f.key)} disabled={!hasData}/>
                    </div>;})}
                </div>
                <div style={{marginTop:10,display:'flex',alignItems:'center',gap:6}}>
                  <I n="key" s={12} c="var(--tx-3)"/>
                  <span style={{fontSize:10.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{shCount}/{allFields.length} fields â€” unique AES-256-GCM keys</span>
                </div>
              </div>
            </div>;})}
        </div>}
      </div>}

      {/* MY RECORDS VIEW â€” rooms claimed from providers */}
      {view==='records'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>My Records</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Rooms created by providers on your behalf. Claim them to take full ownership and control.</p></div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(140px,1fr))',gap:10,marginBottom:20}}>
          {[{l:'Pending',v:pendingClaims.length,c:'gold',i:'clock'},
            {l:'Claimed',v:claimedRooms.length,c:'teal',i:'shield'},
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {/* Pending claims */}
        {pendingClaims.length>0&&<div style={{marginBottom:20}}>
          <span className="section-label">PENDING â€” AWAITING YOUR CLAIM</span>
          <div style={{display:'flex',flexDirection:'column',gap:8,marginTop:8}}>
            {pendingClaims.map(rec=><div key={rec.roomId} className="card" style={{padding:'14px 18px',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <div>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:14,fontWeight:600}}>{rec.client_name||'Unnamed Record'}</span>
                  <span className="tag tag-gold">Pending</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:10,marginTop:4}}>
                  <span style={{fontSize:10.5,color:'var(--tx-2)'}}>Created by: <span style={{fontFamily:'var(--mono)'}}>{rec.owner}</span></span>
                  {rec.created&&<span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{new Date(rec.created).toLocaleDateString()}</span>}
                </div>
                {rec.notes&&<span style={{fontSize:11,color:'var(--tx-2)',marginTop:4,display:'block',fontStyle:'italic'}}>{rec.notes}</span>}
              </div>
              <button onClick={()=>handleClaimRoom(rec)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6,whiteSpace:'nowrap'}}>
                <I n="shield" s={13}/>Claim Room
              </button>
            </div>)}
          </div>
        </div>}
        {/* Claimed rooms */}
        {claimedRooms.length>0&&<div style={{marginBottom:20}}>
          <span className="section-label">CLAIMED â€” YOU OWN THESE ROOMS</span>
          <div style={{display:'flex',flexDirection:'column',gap:8,marginTop:8}}>
            {claimedRooms.map(rec=><div key={rec.roomId} className="card" style={{padding:0,overflow:'hidden'}}>
              <div style={{padding:'14px 18px',display:'flex',alignItems:'center',justifyContent:'space-between',borderBottom:'1px solid var(--border-0)'}}>
                <div>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <span style={{fontSize:14,fontWeight:600}}>{rec.client_name||'Record'}</span>
                    <span className="tag tag-teal">Claimed</span>
                    <span className="tag tag-green"><I n="lock" s={9}/>PL 100</span>
                  </div>
                  <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-3)'}}>Room: {rec.roomId.slice(0,25)}â€¦</span>
                </div>
                <div style={{display:'flex',gap:4}}>
                  {rec.previous_owner&&<button onClick={()=>handleRevokeFromClaimed(rec,rec.previous_owner)} className="b-gho b-sm" style={{color:'var(--red)',display:'flex',alignItems:'center',gap:3}}>
                    <I n="userMinus" s={11}/>Remove Provider
                  </button>}
                  <button onClick={()=>handleDeleteClaimedRoom(rec)} className="b-gho b-sm" style={{color:'var(--red)',display:'flex',alignItems:'center',gap:3}}>
                    <I n="trash" s={11}/>Close Room
                  </button>
                </div>
              </div>
              <div style={{padding:'12px 18px',fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
                <div style={{display:'flex',gap:16,flexWrap:'wrap'}}>
                  {rec.previous_owner&&<span>Previous owner: <span style={{fontFamily:'var(--mono)',fontSize:10.5}}>{rec.previous_owner}</span></span>}
                  {rec.claimed_at&&<span>Claimed: <span style={{fontFamily:'var(--mono)',fontSize:10.5}}>{new Date(rec.claimed_at).toLocaleString()}</span></span>}
                </div>
              </div>
            </div>)}
          </div>
        </div>}
        {pendingClaims.length===0&&claimedRooms.length===0&&
          <div className="card" style={{textAlign:'center',padding:'40px 20px',borderStyle:'dashed'}}>
            <I n="shield" s={32}/>
            <p style={{color:'var(--tx-2)',marginTop:10,fontSize:13}}>No records to claim</p>
            <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:4}}>When a provider creates a room for you and sends an invite, it will appear here for you to claim.</p>
          </div>}
        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="shield" s={16} c="var(--teal)"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong style={{color:'var(--teal)'}}>Full control after claiming:</strong> When you claim a room, ownership transfers to you (power level 100). You can remove the provider, close the room, or manage who has access. The provider cannot undo your claim.
          </span>
        </div>
      </div>}

      {/* METRICS VIEW (Â§B) */}
      {view==='metrics'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:6}}>Metrics Consent</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:20}}>Control whether anonymized observations flow to provider metrics rooms. Your name, DOB, SSN, and address are never transmitted.</p>
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:14}}>
            <div><span style={{fontSize:14,fontWeight:600}}>Anonymized Metrics Reporting</span>
              <p style={{fontSize:11.5,color:'var(--tx-2)',marginTop:2}}>Observations are anonymized before leaving your bridge. PII is always blocked.</p></div>
            <Toggle on={metricsConsent.enabled} onChange={handleMetricsToggle}/>
          </div>
          {metricsConsent.enabled&&<div>
            <span className="section-label">CONSENTED CATEGORIES</span>
            <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
              {metricsConsent.categories?.map(c=><span key={c} className="tag tag-green">{c}</span>)}
            </div>
            <div style={{marginTop:12,padding:'10px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span className="section-label" style={{marginBottom:6}}>WHAT GETS SENT</span>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4,fontSize:11}}>
                {[['Sleep location','pass-through'],['Service contacts','pass-through'],['DOB','age range only'],['Address','census tract only'],
                  ['Income','bracket only'],['Name','BLOCKED'],['SSN','BLOCKED'],['Phone','BLOCKED'],['Email','BLOCKED']].map(([f,t])=>
                  <div key={f} style={{display:'flex',justifyContent:'space-between',padding:'3px 0'}}>
                    <span style={{color:'var(--tx-1)'}}>{f}</span>
                    <span className={`tag ${t==='BLOCKED'?'tag-red':'tag-teal'}`} style={{fontSize:8.5}}>{t}</span>
                  </div>)}
              </div>
            </div>
          </div>}
        </div>
        <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'14px 18px',display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="eye" s={16} c="var(--gold)"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong>K-anonymity (k=5):</strong> No demographic combination with fewer than 5 matching individuals is reported. Data is generalized or suppressed to prevent re-identification.
          </span>
        </div>
      </div>}

      {/* INBOX VIEW */}
      {view==='inbox'&&!activeBridge&&<div className="anim-up inbox-wrap">
        <div className="inbox-header">
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Inbox</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>All your encrypted conversations with providers in one place. Messages are end-to-end encrypted.</p>
          </div>
          <button onClick={()=>setAddProviderModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}><I n="plus" s={14}/>New Conversation</button>
        </div>
        <div className="inbox-panel">
          {/* Conversation list */}
          <div className="inbox-list">
            <div style={{padding:'14px 14px 10px',borderBottom:'1px solid var(--border-0)'}}>
              <span className="section-label" style={{marginBottom:0}}>CONVERSATIONS ({providers.length})</span>
            </div>
            <div style={{flex:1,overflow:'auto'}}>
              {providers.length===0?
                <div style={{padding:'40px 16px',textAlign:'center'}}>
                  <I n="msg" s={28} c="var(--tx-3)"/>
                  <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:10}}>No conversations yet</p>
                  <p style={{color:'var(--tx-3)',fontSize:10.5,marginTop:4}}>Add a provider to start chatting</p>
                </div>
              :providers.map((p,i)=><div key={p.bridgeRoomId} onClick={()=>openInboxConvo(i)}
                style={{padding:'12px 14px',cursor:'pointer',borderBottom:'1px solid var(--border-0)',
                  background:inboxConvo===i?'var(--bg-4)':'transparent',
                  borderLeft:inboxConvo===i?'3px solid var(--teal)':'3px solid transparent',
                  transition:'all .15s'}}
                onMouseEnter={e=>{if(inboxConvo!==i)e.currentTarget.style.background='var(--bg-3)'}}
                onMouseLeave={e=>{if(inboxConvo!==i)e.currentTarget.style.background=inboxConvo===i?'var(--bg-4)':'transparent'}}>
                <div style={{display:'flex',alignItems:'center',gap:10}}>
                  <div style={{width:36,height:36,borderRadius:'50%',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',border:'2px solid var(--gold)',flexShrink:0}}>
                    {p.providerProfile?.org_membership?.verified ? <I n="shieldCheck" s={16}/> : <I n="user" s={16}/>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <span style={{fontSize:13,fontWeight:inboxConvo===i?700:500,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.providerName||p.providerUserId}</span>
                    <div style={{display:'flex',alignItems:'center',gap:4,marginTop:2}}>
                      {p.providerProfile?.org_membership?.verified && <><I n="shieldCheck" s={9} c="var(--blue)"/><span style={{fontSize:9,color:'var(--blue)',fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',maxWidth:120}}>{p.providerProfile.org_membership.org_name}</span></>}
                      <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{Object.values(p.sharedFields||{}).filter(Boolean).length} shared</span>
                    </div>
                  </div>
                </div>
              </div>)}
            </div>
          </div>
          {/* Active conversation */}
          <div className="inbox-chat">
            {inboxConvo!==null&&providers[inboxConvo] ? (() => {
              const p = providers[inboxConvo];
              return <>
                {/* Chat header */}
                <div className="inbox-chat-hdr">
                  <div style={{width:32,height:32,borderRadius:'50%',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',border:'2px solid var(--gold)'}}>
                    {p.providerProfile?.org_membership?.verified ? <I n="shieldCheck" s={14}/> : <I n="user" s={14}/>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <span style={{fontSize:14,fontWeight:700,display:'block'}}>{p.providerName||p.providerUserId}</span>
                    <div style={{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}}>
                      <span className="tag tag-green" style={{fontSize:8}}><I n="lock" s={8}/>E2EE</span>
                      {p.providerProfile?.title && <span style={{fontSize:10,color:'var(--tx-2)'}}>{p.providerProfile.title}</span>}
                      {p.providerProfile?.org_membership?.verified && <span className="tag tag-blue" style={{fontSize:8}}>{p.providerProfile.org_membership.org_name}</span>}
                    </div>
                  </div>
                  <button onClick={()=>openBridge(p.bridgeRoomId)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="share" s={11}/>Bridge</button>
                  <button onClick={()=>loadInboxMessages(p.bridgeRoomId)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="refresh-cw" s={11}/></button>
                </div>
                {/* Messages */}
                <div className="inbox-msgs">
                  {inboxMessages.length===0?
                    <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
                      <I n="msg" s={32} c="var(--tx-3)"/>
                      <p style={{color:'var(--tx-3)',fontSize:12,marginTop:10}}>No messages yet</p>
                      <p style={{color:'var(--tx-3)',fontSize:11,marginTop:4}}>Start the conversation below</p>
                    </div>
                  :[...inboxMessages].reverse().map((msg,i)=>{
                    const isOwn = msg.sender===svc.userId;
                    return <div key={msg.id||i} style={{display:'flex',flexDirection:'column',alignItems:isOwn?'flex-end':'flex-start',marginBottom:4}}>
                      <div style={{maxWidth:'75%',padding:'10px 14px',borderRadius:isOwn?'14px 14px 4px 14px':'14px 14px 14px 4px',
                        background:isOwn?'var(--teal-dim)':'var(--bg-3)',border:`1px solid ${isOwn?'rgba(62,201,176,.2)':'var(--border-0)'}`,
                        transition:'transform .1s'}}>
                        <p style={{fontSize:12.5,color:'var(--tx-0)',lineHeight:1.5,wordBreak:'break-word'}}>{msg.content?.body}</p>
                      </div>
                      <div style={{display:'flex',alignItems:'center',gap:4,marginTop:3,padding:'0 6px'}}>
                        <span style={{fontFamily:'var(--mono)',fontSize:9,color:isOwn?'var(--teal)':'var(--gold)'}}>{isOwn?'You':p.providerName||msg.sender}</span>
                        <span style={{fontFamily:'var(--mono)',fontSize:8,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):''}</span>
                      </div>
                    </div>;
                  })}
                </div>
                {/* Compose */}
                <div className="inbox-compose">
                  <div style={{display:'flex',gap:8}}>
                    <input value={inboxMsgText} onChange={e=>setInboxMsgText(e.target.value)} placeholder="Type a message (E2EE)..."
                      onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendInboxMsg()}}}
                      style={{flex:1,borderRadius:20,padding:'10px 18px'}}/>
                    <button onClick={handleSendInboxMsg} className="b-pri" disabled={!inboxMsgText.trim()}
                      style={{borderRadius:20,width:42,height:42,padding:0,display:'flex',alignItems:'center',justifyContent:'center'}}>
                      <I n="send" s={16}/>
                    </button>
                  </div>
                </div>
              </>;
            })()
            : <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
              <div style={{width:64,height:64,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)',marginBottom:16}}>
                <I n="inbox" s={28}/>
              </div>
              <h3 style={{fontSize:16,fontWeight:700,marginBottom:6}}>Your Inbox</h3>
              <p style={{color:'var(--tx-2)',fontSize:12,maxWidth:280,textAlign:'center',lineHeight:1.6}}>
                {providers.length>0?'Select a conversation from the left to start chatting with your providers.':'Add a provider to begin your first encrypted conversation.'}
              </p>
              {providers.length===0&&<button onClick={()=>setAddProviderModal(true)} className="b-pri" style={{marginTop:14,display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>Add Provider</button>}
            </div>}
          </div>
        </div>
      </div>}

      {/* BRIDGE VIEW */}
      {view==='bridge'&&activeBridge&&activeProvider&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <button onClick={()=>{setView('providers');setActiveBridge(null)}} className="b-gho b-sm" style={{marginBottom:14,display:'flex',alignItems:'center',gap:4}}><I n="back" s={13}/>Back</button>
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:20}}>
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:20,fontWeight:700}}>Bridge: {activeProvider.providerName||activeProvider.providerUserId}</h2>
            {activeProvider.providerProfile?.title && <span style={{fontSize:12,color:'var(--tx-2)',display:'block',marginTop:2}}>{activeProvider.providerProfile.title}</span>}
            <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4,flexWrap:'wrap'}}>
              <span className="tag tag-green"><I n="lock" s={9}/>Megolm + AES-GCM</span>
              {activeProvider.providerProfile?.org_membership?.verified && <span className="tag tag-blue"><I n="shieldCheck" s={9}/>{activeProvider.providerProfile.org_membership.org_name}</span>}
              <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)'}}>{activeBridge}</span>
            </div>
          </div>
          <button onClick={()=>setHardRevokeTarget(activeProviderIdx)} className="b-red b-sm"><I n="zap" s={12}/>Hard Revoke</button>
        </div>
        {activeProvider.providerProfile?.org_membership?.verified && <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:28,height:28,borderRadius:'50%',background:'var(--bg-3)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--blue)',border:'2px solid var(--blue)'}}><I n="shieldCheck" s={14}/></div>
          <div style={{flex:1}}>
            <div style={{display:'flex',alignItems:'center',gap:6}}>
              <span style={{fontSize:12,fontWeight:700,color:'var(--blue)'}}>{activeProvider.providerProfile.org_membership.org_name}</span>
              {activeProvider.providerProfile.org_membership.email_verified ? <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>EMAIL VERIFIED</span>
              : <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>VERIFIED</span>}
            </div>
            <span style={{fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{activeProvider.providerProfile.org_membership.org_type ? (ORG_TYPE_LABELS[activeProvider.providerProfile.org_membership.org_type]||activeProvider.providerProfile.org_membership.org_type)+' Â· ':''}{activeProvider.providerProfile.org_membership.role}</span>
            {activeProvider.providerProfile.org_membership.verified_domain && <span style={{fontSize:9,color:'var(--green)',fontFamily:'var(--mono)',display:'block',marginTop:2}}>@{activeProvider.providerProfile.org_membership.verified_domain}</span>}
          </div>
          {activeProvider.providerProfile.credentials && <span style={{fontSize:9.5,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{activeProvider.providerProfile.credentials}</span>}
        </div>}
        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">CURRENTLY SHARED</span>
          <div style={{display:'flex',flexWrap:'wrap',gap:6,marginTop:4}}>
            {allFields.filter(f=>activeProvider.sharedFields?.[f.key]).map(f=><span key={f.key} className="tag tag-blue">{f.label}</span>)}
            {Object.values(activeProvider.sharedFields||{}).filter(Boolean).length===0&&<span style={{fontSize:12,color:'var(--tx-3)'}}>No fields shared</span>}
          </div>
        </div>
        <div className="card">
          <span className="section-label">BRIDGE MESSAGES</span>
          <div style={{maxHeight:280,overflow:'auto',marginBottom:12}}>
            {bridgeMessages.length===0?<p style={{color:'var(--tx-3)',fontSize:12,padding:'14px 0',textAlign:'center'}}>No messages yet</p>
            :bridgeMessages.map((msg,i)=><div key={msg.id||i} style={{padding:'8px 0',borderBottom:'1px solid var(--border-0)'}}>
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
                <span style={{fontFamily:'var(--mono)',fontSize:10,color:msg.sender===svc.userId?'var(--teal)':'var(--gold)'}}>{msg.sender===svc.userId?'You':msg.sender}</span>
                <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleString():''}</span></div>
              <p style={{fontSize:12.5,color:'var(--tx-1)'}}>{msg.content?.body}</p>
            </div>)}
          </div>
          <div style={{display:'flex',gap:6}}>
            <input value={msgText} onChange={e=>setMsgText(e.target.value)} placeholder="Message (E2EE)..." onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey)handleSendBridgeMsg()}} style={{flex:1}}/>
            <button onClick={handleSendBridgeMsg} className="b-pri"><I n="send" s={13}/></button>
          </div>
        </div>
      </div>}

      {/* ACTIVITY STREAM */}
      {view==='activity'&&!activeBridge&&<ActivityStream session={session}/>}
    </div>

    {/* EDIT VAULT MODAL */}
    <Modal open={editModal} onClose={()=>setEditModal(false)} title="Edit Vault Data" w={540}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>Changes to shared fields are re-encrypted with new keys per provider. Each edit emits EO operations (INS/ALT/NUL) to the vault timeline.</p>
      {allCategories.map(cat=>{const fields=allFields.filter(f=>f.category===cat);
        if(!fields.length) return null;
        return <div key={cat} style={{marginBottom:14}}>
        <span className="section-label">{(CAT_LABELS[cat]||cat.charAt(0).toUpperCase()+cat.slice(1)).toUpperCase()}</span>
        {fields.map(f=><div key={f.key} style={{marginBottom:8}}>
          <div style={{display:'flex',alignItems:'center',gap:4,marginBottom:3}}>
            <label style={{fontSize:11.5,color:'var(--tx-1)'}}>{f.label}</label>
            {f.sensitive&&<span className="tag tag-red" style={{fontSize:8}}>SENSITIVE</span>}
            {f.custom&&<span className="tag tag-purple" style={{fontSize:8}}>CUSTOM</span>}</div>
          {['case_notes','history','medical','documents'].includes(f.key)||(f.custom&&f.category==='case')?
            <textarea value={editData[f.key]||''} onChange={e=>setEditData({...editData,[f.key]:e.target.value})} placeholder={`Enter ${f.label.toLowerCase()}...`} style={{minHeight:50}}/>:
            <input value={editData[f.key]||''} onChange={e=>setEditData({...editData,[f.key]:e.target.value})} placeholder={`Enter ${f.label.toLowerCase()}...`}/>}
        </div>)}
      </div>;})}
      <button onClick={handleEditSave} className="b-pri" style={{width:'100%'}}>Save & Re-encrypt Shared Fields</button>
    </Modal>

    {/* ADD PROVIDER MODAL */}
    <Modal open={addProviderModal} onClose={()=>setAddProviderModal(false)} title="Add Provider">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Creates a new encrypted bridge room and invites the provider. No data shared until you toggle fields on.</p>
      <div style={{marginBottom:14}}><span className="section-label">PROVIDER MATRIX ID</span>
        <input value={newProviderId} onChange={e=>setNewProviderId(e.target.value)} placeholder="@provider:matrix.org"/></div>
      <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14}}>
        <span style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.5}}>Bridge uses Megolm + per-field AES-256-GCM. Keys destroyed on revocation.</span>
      </div>
      <button onClick={handleAddProvider} className="b-pri" style={{width:'100%'}}>Create Bridge Room</button>
    </Modal>

    {/* OBSERVATION MODAL */}
    <Modal open={!!obsModal} onClose={()=>setObsModal(null)} title={obsModal?.question||'Record Observation'} w={500}>
      {obsModal&&<>
        <div style={{marginBottom:14}}><span className="section-label">DATE</span>
          <input type="date" value={obsDate} onChange={e=>setObsDate(e.target.value)}/></div>
        <div style={{marginBottom:14}}><span className="section-label">RESPONSE</span>
          <div style={{display:'flex',flexDirection:'column',gap:4}}>
            {obsModal.options.map(o=><div key={o.v} onClick={()=>setObsValue(o.v)}
              style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',border:`1px solid ${obsValue===o.v?'var(--teal)':'var(--border-1)'}`,
                background:obsValue===o.v?'var(--teal-dim)':'var(--bg-3)',transition:'all .15s'}}>
              <span style={{fontSize:12.5,color:obsValue===o.v?'var(--teal)':'var(--tx-1)'}}>{o.l}</span>
            </div>)}
          </div>
        </div>
        <div style={{marginBottom:14}}><span className="section-label">ADDITIONAL NOTES (OPTIONAL)</span>
          <textarea value={obsFreeText} onChange={e=>setObsFreeText(e.target.value)} placeholder="Any additional context..." style={{minHeight:50}}/></div>
        <div style={{background:'var(--teal-dim)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14,fontSize:11,color:'var(--teal)'}}>
          This observation will be recorded as a GIVEN event in your vault â€” immutable, append-only.
        </div>
        <button onClick={handleRecordObservation} className="b-pri" disabled={!obsValue} style={{width:'100%'}}>Record Observation</button>
      </>}
    </Modal>

    {/* HARD REVOKE CONFIRM */}
    <Modal open={hardRevokeTarget!==null} onClose={()=>setHardRevokeTarget(null)} title="Hard Revoke" w={440}>
      <div style={{background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginBottom:14}}>
        <p style={{fontSize:12.5,color:'var(--red)',fontWeight:600,marginBottom:4}}>Destructive operation</p>
        <p style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>Current bridge will be <strong>tombstoned</strong>, provider <strong>kicked</strong>. A new bridge with <strong>fresh encryption keys</strong> is created for any still-shared fields.</p>
      </div>
      <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:14,lineHeight:1.6}}>
        <strong>Caveat:</strong> If the provider previously decrypted and cached data, we cannot delete it from their device. This prevents future access, not retroactive erasure.
      </p>
      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setHardRevokeTarget(null)} className="b-gho" style={{flex:1}}>Cancel</button>
        <button onClick={()=>handleHardRevoke(hardRevokeTarget)} className="b-red" style={{flex:1}}><I n="zap" s={13}/>Execute</button>
      </div>
    </Modal>

    {/* ADD CUSTOM FIELD MODAL */}
    <Modal open={addFieldModal} onClose={()=>{setAddFieldModal(false);setNewFieldLabel('');setNewFieldCategory('details');setNewFieldSensitive(false)}} title="Add Custom Field" w={440}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>Create a new field to store any data you want in your vault. Custom fields work just like built-in fields â€” encrypted, shareable, and fully under your control.</p>
      <div style={{marginBottom:14}}><span className="section-label">FIELD NAME</span>
        <input value={newFieldLabel} onChange={e=>setNewFieldLabel(e.target.value)} placeholder="e.g. Emergency Contact, Preferred Language..." autoFocus
          onKeyDown={e=>{if(e.key==='Enter'&&newFieldLabel.trim())handleAddCustomField()}}/></div>
      <div style={{marginBottom:14}}><span className="section-label">CATEGORY</span>
        <select value={newFieldCategory} onChange={e=>setNewFieldCategory(e.target.value)} style={{width:'100%'}}>
          {FIELD_CATEGORIES.map(c=><option key={c} value={c}>{CAT_LABELS[c]}</option>)}
        </select></div>
      <div style={{marginBottom:14,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <div><span style={{fontSize:12,fontWeight:500}}>Sensitive field</span>
          <p style={{fontSize:10.5,color:'var(--tx-2)',marginTop:2}}>Sensitive fields are masked in the vault view</p></div>
        <Toggle on={newFieldSensitive} onChange={()=>setNewFieldSensitive(!newFieldSensitive)}/>
      </div>
      <div style={{background:'var(--purple-dim)',border:'1px solid rgba(167,139,250,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14}}>
        <span style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.5}}>Custom fields are encrypted with AES-256-GCM, stored in your vault, and can be selectively shared with providers â€” identical to built-in fields.</span>
      </div>
      <button onClick={handleAddCustomField} className="b-pri" disabled={!newFieldLabel.trim()} style={{width:'100%'}}>Create Field</button>
    </Modal>
  </div>;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROVIDER APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ProviderApp = ({session, onLogout, showToast}) => {
  const [rosterRoom, setRosterRoom] = useState(null);
  const [metricsRoom, setMetricsRoom] = useState(null);
  const [schemaRoom, setSchemaRoom] = useState(null);
  const [networkRoom, setNetworkRoom] = useState(null);
  const [cases, setCases] = useState([]);
  const [metrics, setMetrics] = useState([]);
  const [networkMembers, setNetworkMembers] = useState([]);
  const [activeCase, setActiveCase] = useState(null);
  const [view, setView] = useState('dashboard'); // dashboard|inbox|case|metrics|schema|network|activity|staff|org-settings|org-inbox
  const [loading, setLoading] = useState(true);
  const [messages, setMessages] = useState([]);
  const [msgText, setMsgText] = useState('');
  const [requestText, setRequestText] = useState('');
  const [discoverModal, setDiscoverModal] = useState(false);
  const [discoverUserId, setDiscoverUserId] = useState('');
  const [networkModal, setNetworkModal] = useState(false);
  const [networkName, setNetworkName] = useState('');
  const [joinNetworkModal, setJoinNetworkModal] = useState(false);
  const [joinNetworkId, setJoinNetworkId] = useState('');
  const [provObsModal, setProvObsModal] = useState(null);
  const [provObsValue, setProvObsValue] = useState('');
  const [provObsNotes, setProvObsNotes] = useState('');
  const [provObservations, setProvObservations] = useState([]);
  const [initError, setInitError] = useState(null);
  // Organization context â€” orgs are a feature within the provider experience
  const [orgRoom, setOrgRoom] = useState(null);
  const [orgMeta, setOrgMeta] = useState({});
  const [staff, setStaff] = useState([]);
  const [orgRole, setOrgRole] = useState(null); // null = no org, 'admin', 'case_manager', etc.
  const [createOrgModal, setCreateOrgModal] = useState(false);
  const [joinOrgModal, setJoinOrgModal] = useState(false);
  const [joinOrgId, setJoinOrgId] = useState('');
  const [setupData, setSetupData] = useState({name:'',type:'direct_service',service_area:'',languages:'en'});
  const [inviteModal, setInviteModal] = useState(false);
  const [inviteUserId, setInviteUserId] = useState('');
  const [inviteRole, setInviteRole] = useState('case_manager');
  // Client records â€” provider-created rooms representing clients
  const [clientRecords, setClientRecords] = useState([]);
  const [createClientModal, setCreateClientModal] = useState(false);
  const [clientInviteModal, setClientInviteModal] = useState(null); // client record object or null
  const [newClientName, setNewClientName] = useState('');
  const [newClientMatrixId, setNewClientMatrixId] = useState('');
  const [newClientNotes, setNewClientNotes] = useState('');
  const [clientInviteMatrixId, setClientInviteMatrixId] = useState('');
  const [copiedField, setCopiedField] = useState(null);
  // Client data import
  const [importModal, setImportModal] = useState(false);
  // Provider profile â€” self-reported identity info
  const [providerProfile, setProviderProfile] = useState({});
  const [profileModal, setProfileModal] = useState(false);
  const [profileDraft, setProfileDraft] = useState({display_name:'',title:'',credentials:'',bio:'',service_types:''});
  // Email verification state
  const [emailVerifyConfig, setEmailVerifyConfig] = useState(EmailVerification.defaultConfig());
  const [emailVerifyModal, setEmailVerifyModal] = useState(false);
  const [verifyEmail, setVerifyEmail] = useState('');
  const [verifyCode, setVerifyCode] = useState('');
  const [verifyStep, setVerifyStep] = useState('email'); // 'email' | 'code' | 'done'
  const [verifyError, setVerifyError] = useState('');
  const [verifyPending, setVerifyPending] = useState(false);
  const [myVerification, setMyVerification] = useState(null); // current user's verification status
  const [emailConfigDraft, setEmailConfigDraft] = useState(EmailVerification.defaultConfig());
  const [emailConfigModal, setEmailConfigModal] = useState(false);
  // â”€â”€â”€ Inter-org messaging & opacity â”€â”€â”€
  const [orgOpacity, setOrgOpacity] = useState('translucent'); // transparent|translucent|opaque
  const [orgMsgAccess, setOrgMsgAccess] = useState({read:['admin','case_manager'],respond:['admin']});
  const [orgChannels, setOrgChannels] = useState([]); // [{roomId, peerOrg:{name,roomId}, lastMessage, unread}]
  const [activeChannel, setActiveChannel] = useState(null);
  const [channelMessages, setChannelMessages] = useState([]);
  const [orgMsgText, setOrgMsgText] = useState('');
  const [composeOrgModal, setComposeOrgModal] = useState(false);
  const [composePeerOrgId, setComposePeerOrgId] = useState('');
  const [composePeerOrgName, setComposePeerOrgName] = useState('');
  const [msgAccessModal, setMsgAccessModal] = useState(false);
  const [msgAccessDraft, setMsgAccessDraft] = useState({read:[],respond:[]});
  // â”€â”€â”€ Org terminology customization â”€â”€â”€
  const [orgTerminology, setOrgTerminology] = useState({...TERMINOLOGY_DEFAULTS});
  const [terminologyDraft, setTerminologyDraft] = useState({...TERMINOLOGY_DEFAULTS});
  const [terminologyModal, setTerminologyModal] = useState(false);
  // Convenience accessors for the active terminology
  const T = orgTerminology; // T.client_term, T.client_term_plural, T.provider_term, T.provider_term_plural
  // â”€â”€â”€ Inbox chat state â”€â”€â”€
  const [inboxConvo, setInboxConvo] = useState(null); // room ID of active inbox conversation
  const [inboxMessages, setInboxMessages] = useState([]);
  const [inboxMsgText, setInboxMsgText] = useState('');
  const [inboxTab, setInboxTab] = useState('cases'); // 'cases' | 'channels'

  useEffect(() => { initProvider(); }, []);

  const rosterFrame = (room) => ({type:'roster',room:room||rosterRoom,role:'provider',epistemic:'MEANT'});
  const bridgeFrame = (room) => ({type:'bridge',room,role:'provider',epistemic:'MEANT'});
  const networkFrame = (room) => ({type:'network',room:room||networkRoom,role:'provider',epistemic:'MEANT'});
  const orgFrame = (room) => ({type:'org',room:room||orgRoom,role:orgRole||'admin',epistemic:'MEANT'});

  const initProvider = async () => {
    setLoading(true);
    setInitError(null);
    try {
      // Single-pass scan: fetch all Khora state across rooms in one request
      const scanned = await svc.scanRooms([EVT.ORG_METADATA, EVT.ORG_ROSTER, EVT.PROVIDER_PROFILE, EVT.ORG_OPACITY, EVT.ORG_MSG_ACCESS, EVT.ORG_MSG_CHANNEL, EVT.ORG_TERMINOLOGY]);
      let roster=null, metricsR=null, schema=null, network=null;
      let detectedOrg=null, detectedOrgRole=null;
      const bridgeData = [];
      const detectedClientRecords = [];
      const detectedOrgChannels = [];
      for (const [rid, state] of Object.entries(scanned)) {
        const id = state[EVT.IDENTITY];
        if (id?.account_type==='provider'&&id.owner===svc.userId) roster=rid;
        if (id?.account_type==='metrics'&&id.owner===svc.userId) metricsR=rid;
        if (id?.account_type==='schema'&&id.owner===svc.userId) schema=rid;
        if (id?.account_type==='network') network=rid;
        // Detect client record rooms created by this provider (or claimed from this provider)
        if (id?.account_type==='client_record'&&(id.owner===svc.userId||id.previous_owner===svc.userId)) {
          detectedClientRecords.push({roomId:rid, ...id});
        }
        // Detect org rooms â€” owned or joined as staff
        if (id?.account_type==='organization') {
          if (id.owner===svc.userId) {
            detectedOrg=rid; detectedOrgRole='admin';
          } else {
            const orgRoster = state[EVT.ORG_ROSTER];
            const entry = orgRoster?.staff?.find(s=>s.userId===svc.userId);
            if (entry) { detectedOrg=rid; detectedOrgRole=entry.role; }
          }
        }
        // Detect inter-org messaging channels
        const chanMeta = state[EVT.ORG_MSG_CHANNEL];
        if (chanMeta && chanMeta.type === 'org_msg_channel') {
          detectedOrgChannels.push({roomId: rid, ...chanMeta});
        }
        const meta = state[EVT.BRIDGE_META];
        if (meta && meta.provider===svc.userId && meta.status!=='tombstoned') {
          bridgeData.push({rid, meta, refs: state[EVT.BRIDGE_REFS]});
        }
      }
      if (!roster) {
        roster = await svc.createRoom('[Khora Roster]','Provider case index',[
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'provider',owner:svc.userId,created:Date.now()}},
          {type:EVT.ROSTER_INDEX,state_key:'',content:{cases:[]}},
        ]);
      }
      if (!metricsR) {
        metricsR = await svc.createRoom('[Khora Metrics]','Anonymized metrics',[
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'metrics',owner:svc.userId,created:Date.now()}},
        ]);
      }
      if (!schema) {
        schema = await svc.createRoom('[Khora Schema]','Schema definitions',[
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'schema',owner:svc.userId,created:Date.now()}},
        ]);
        const allSeeds = [
          ...DEFAULT_PROMPTS.map(p => () => svc.setState(schema, EVT.SCHEMA_PROMPT, p, p.key)),
          ...DEFAULT_PROVIDER_PROMPTS.map(pp => () => svc.setState(schema, EVT.SCHEMA_PROMPT, pp, pp.key)),
          ...DEFAULT_DEFINITIONS.map(d => () => svc.setState(schema, EVT.SCHEMA_DEF, d, d.key)),
          ...DEFAULT_AUTHORITIES.map(a => () => svc.setState(schema, EVT.SCHEMA_AUTHORITY, a, a.id)),
          [() => svc.setState(schema, EVT.SCHEMA_TRANSFORM, {id:'transform_default',transforms:DEFAULT_TRANSFORMS}, 'default')],
        ].flat();
        for (let i = 0; i < allSeeds.length; i++) {
          await allSeeds[i]();
          if (i % 3 === 2) await new Promise(r => setTimeout(r, 200));
        }
      }
      setRosterRoom(roster); setMetricsRoom(metricsR); setSchemaRoom(schema);
      // Load provider profile from roster room
      const rosterState = scanned[roster];
      if (rosterState?.[EVT.PROVIDER_PROFILE]) setProviderProfile(rosterState[EVT.PROVIDER_PROFILE]);
      if (network) { setNetworkRoom(network); await loadNetworkMembers(network); }
      // Load org context if detected during scan
      if (detectedOrg) {
        setOrgRoom(detectedOrg); setOrgRole(detectedOrgRole);
        const orgState = scanned[detectedOrg];
        if (orgState?.[EVT.ORG_METADATA]) setOrgMeta(orgState[EVT.ORG_METADATA]);
        if (orgState?.[EVT.ORG_ROSTER]?.staff) setStaff(orgState[EVT.ORG_ROSTER].staff);
        // Load email verification config
        try {
          const evConfig = await svc.getState(detectedOrg, EVT.ORG_EMAIL_CONFIG).catch(()=>null);
          if (evConfig) { setEmailVerifyConfig(evConfig); setEmailConfigDraft(evConfig); }
          // Load my verification status from roster
          const myStaff = orgState?.[EVT.ORG_ROSTER]?.staff?.find(s=>s.userId===svc.userId);
          if (myStaff?.email_verification) setMyVerification(myStaff.email_verification);
        } catch(e) { console.warn('Email verify config load:', e.message); }
        // Load opacity & message access settings
        if (orgState?.[EVT.ORG_OPACITY]) setOrgOpacity(orgState[EVT.ORG_OPACITY].level || 'translucent');
        if (orgState?.[EVT.ORG_MSG_ACCESS]) setOrgMsgAccess(orgState[EVT.ORG_MSG_ACCESS]);
        // Load org terminology customization
        if (orgState?.[EVT.ORG_TERMINOLOGY]) {
          const t = {...TERMINOLOGY_DEFAULTS, ...orgState[EVT.ORG_TERMINOLOGY]};
          setOrgTerminology(t);
          setTerminologyDraft(t);
        }
        // Load detected org messaging channels
        if (detectedOrgChannels.length > 0) setOrgChannels(detectedOrgChannels);
      }
      // Load client records detected during scan
      if (detectedClientRecords.length > 0) {
        // Check room membership to determine status
        const enriched = [];
        for (const rec of detectedClientRecords) {
          let status = rec.status || 'created';
          // If the identity state already says 'claimed', respect that
          if (status === 'claimed') {
            enriched.push({ ...rec, status });
            continue;
          }
          if (rec.client_matrix_id && svc.client) {
            try {
              const members = await svc.getRoomMembers(rec.roomId);
              const clientMember = members.find(m => m.userId === rec.client_matrix_id);
              if (clientMember) status = 'joined';
              else if (status === 'created' && rec.client_matrix_id) status = 'invited';
            } catch {}
          }
          enriched.push({ ...rec, status });
        }
        setClientRecords(enriched);
      }
      // Process bridge data collected during scan (no second pass needed)
      await loadCasesFromScan(bridgeData, metricsR);
      await loadMetrics(metricsR);
    } catch (e) {
      console.error('Provider init failed:', e);
      setInitError(e.message || 'Failed to initialize provider workspace.');
    }
    setLoading(false);
  };

  const loadCasesFromScan = async (bridgeData, mRoom) => {
    const found = [];
    for (const {rid, meta, refs} of bridgeData) {
      const decrypted = {};
      if (refs?.fields) {
        for (const [key,ref] of Object.entries(refs.fields)) {
          try {
            if (ref.key&&ref.ciphertext&&ref.iv) {
              const plain = await FieldCrypto.decrypt(ref.ciphertext, ref.iv, ref.key);
              if (plain!==null) decrypted[key]=plain;
            }
          } catch { /* skip undecryptable field */ }
        }
      }
      found.push({bridgeRoomId:rid, clientUserId:meta.client, meta, sharedData:decrypted, metricsRoom:mRoom||metricsRoom});
    }
    setCases(found);
  };

  const loadCases = async () => {
    const scanned = await svc.scanRooms();
    const bridgeData = [];
    for (const [rid, state] of Object.entries(scanned)) {
      const meta = state[EVT.BRIDGE_META];
      if (meta && meta.provider===svc.userId && meta.status!=='tombstoned') {
        bridgeData.push({rid, meta, refs: state[EVT.BRIDGE_REFS]});
      }
    }
    await loadCasesFromScan(bridgeData);
  };

  const loadMetrics = async (mRoom) => {
    if (!svc.client || !mRoom) return;
    const room = svc.client.getRoom(mRoom);
    if (!room) return;
    const evts = room.getLiveTimeline().getEvents().filter(e=>e.getType()===EVT.METRIC).map(e=>e.getContent());
    setMetrics(evts);
  };

  const loadNetworkMembers = async (nRoom) => {
    const members = await svc.getState(nRoom, EVT.NET_MEMBERS);
    setNetworkMembers(members?.organizations || []);
  };

  const loadMessages = async (bid) => { setMessages(await svc.getMessages(bid)); };

  const handleSendMsg = async () => {
    if (!msgText.trim()||!activeCase) return;
    await svc.sendMessage(activeCase, msgText, {[`${NS}.type`]:'note'});
    await emitOp(activeCase, 'INS', {type:'provider_note',field:'message'}, {body:msgText}, bridgeFrame(activeCase));
    setMsgText(''); setTimeout(()=>loadMessages(activeCase),500);
  };

  const handleSendRequest = async () => {
    if (!requestText.trim()||!activeCase) return;
    await svc.sendMessage(activeCase, `Information Request: ${requestText}`, {[`${NS}.type`]:'request'});
    await emitOp(activeCase, 'DES', {type:'information_request',entity:'case'}, {request:requestText}, bridgeFrame(activeCase));
    setRequestText(''); showToast('Request sent to client','success'); setTimeout(()=>loadMessages(activeCase),500);
  };

  // Record structured provider observation in bridge room (MEANT frame)
  const handleProviderObservation = async () => {
    if (!provObsValue || !provObsModal || !activeCase) return;
    const obs = {
      id:genOpId(), prompt_id:provObsModal.id, prompt_key:provObsModal.key,
      value:provObsValue, notes:provObsNotes||undefined,
      schema_version:provObsModal.version||1,
      author:svc.userId, ts:Date.now()
    };
    await svc.sendEvent(activeCase, EVT.OBSERVATION, obs);
    await emitOp(activeCase, 'INS',
      {type:'provider_observation',field:provObsModal.key,value:provObsValue},
      {prompt:provObsModal.question,notes:provObsNotes||undefined,
       epistemic_crossing:provObsModal.category==='assessment'?'GIVEN â†’ MEANT':undefined},
      bridgeFrame(activeCase));
    setProvObservations(prev=>[...prev,obs]);
    setProvObsModal(null); setProvObsValue(''); setProvObsNotes('');
    showToast(`Observation recorded: ${provObsModal.question}`,'success');
  };

  // Load provider observations from bridge
  const loadProviderObservations = async (bid) => {
    if (!svc.client) return;
    const room = svc.client.getRoom(bid);
    if (!room) return;
    const obs = room.getLiveTimeline().getEvents()
      .filter(e=>e.getType()===EVT.OBSERVATION)
      .map(e=>e.getContent());
    setProvObservations(obs);
  };

  // â”€â”€â”€ Client record management â”€â”€â”€
  const handleCreateClientRecord = async () => {
    if (!newClientName.trim()) return;
    try {
      const clientId = newClientMatrixId.trim() || null;
      const roomId = await svc.createClientRoom(
        `[Client] ${newClientName}`,
        `Client record for ${newClientName}`,
        [
          { type: EVT.IDENTITY, state_key: '', content: {
            account_type: 'client_record', owner: svc.userId, created: Date.now(),
            client_name: newClientName, client_matrix_id: clientId,
            notes: newClientNotes || undefined, status: 'created',
          }},
        ],
        clientId
      );
      // If client Matrix ID provided, invite them and set them as admin
      if (clientId) {
        try {
          await svc.invite(roomId, clientId);
          await svc.setState(roomId, EVT.IDENTITY, {
            account_type: 'client_record', owner: svc.userId, created: Date.now(),
            client_name: newClientName, client_matrix_id: clientId,
            notes: newClientNotes || undefined, status: 'invited',
          });
        } catch (e) { console.warn('Invite failed:', e.message); }
      }
      const newRecord = {
        roomId, client_name: newClientName, client_matrix_id: clientId,
        notes: newClientNotes || undefined, owner: svc.userId,
        created: Date.now(), status: clientId ? 'invited' : 'created',
      };
      setClientRecords(prev => [...prev, newRecord]);
      setCreateClientModal(false);
      setNewClientName(''); setNewClientMatrixId(''); setNewClientNotes('');
      showToast(`Client "${newClientName}" created${clientId ? ' â€” invite sent' : ''}`,'success');
    } catch (e) { showToast('Failed: ' + e.message, 'error'); }
  };

  const handleClientInvite = async () => {
    if (!clientInviteModal || !clientInviteMatrixId.trim()) return;
    try {
      const clientId = clientInviteMatrixId.trim();
      // Set power levels: client gets PL 100 (superadmin), provider stays at 50
      await svc.setPowerLevel(clientInviteModal.roomId, clientId, 100);
      await svc.setPowerLevel(clientInviteModal.roomId, svc.userId, 50);
      // Invite the client
      await svc.invite(clientInviteModal.roomId, clientId);
      // Update identity state with the client's Matrix ID
      await svc.setState(clientInviteModal.roomId, EVT.IDENTITY, {
        ...clientInviteModal, client_matrix_id: clientId, status: 'invited',
      });
      setClientRecords(prev => prev.map(r =>
        r.roomId === clientInviteModal.roomId
          ? { ...r, client_matrix_id: clientId, status: 'invited' }
          : r
      ));
      showToast(`Invite sent to ${clientId} â€” they will have full room control`, 'success');
    } catch (e) { showToast('Invite failed: ' + e.message, 'error'); }
  };

  const copyToClipboard = async (text, label) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedField(label);
      setTimeout(() => setCopiedField(null), 2000);
    } catch { showToast('Copy failed â€” please select and copy manually', 'warn'); }
  };

  // â”€â”€â”€ Import completion handler â”€â”€â”€
  const handleImportComplete = (importResults) => {
    const newRecords = importResults.created.map(r => ({
      roomId: r.roomId, client_name: r.displayName, client_matrix_id: null,
      notes: `Imported (${r.fieldCount} encrypted fields)`,
      owner: svc.userId, created: Date.now(), status: 'created', imported: true,
    }));
    setClientRecords(prev => [...prev, ...newRecords]);
  };

  const getInviteUrl = (roomId) => `https://matrix.to/#/${roomId}`;

  const getSetupInstructions = (roomId) => {
    const hs = svc._baseUrl ? svc._baseUrl.replace(/^https?:\/\//, '') : 'matrix.org';
    const link = getInviteUrl(roomId);
    return `You've been invited to securely manage your information on Khora.\n\nTo get started:\n\n1. Create a free Matrix account:\n   Go to https://${hs} and click "Create Account"\n   (Matrix is a secure, decentralized messaging protocol â€” your data stays on the server you choose)\n\n2. Download a Matrix client (optional):\n   Web: https://app.element.io\n   Mobile: Search "Element" in your app store\n   Or use any Matrix-compatible app\n\n3. Sign in with your new account\n\n4. Click this link to join your room:\n   ${link}\n\n5. You will have full control of this room â€” you can remove anyone from it at any time.\n\nQuestions? Contact your provider for help getting set up.`;
  };

  // Discover client by Matrix ID
  const handleDiscoverClient = async () => {
    if (!discoverUserId.trim()) return;
    try {
      // Check if we already have a bridge with this client
      const existing = cases.find(c=>c.clientUserId===discoverUserId);
      if (existing) { showToast('Already connected with this client','info'); setDiscoverModal(false); return; }
      // We can't create the bridge â€” the client must initiate. But we can check if one exists.
      const scanned = await svc.scanRooms();
      let found = false;
      for (const [rid, state] of Object.entries(scanned)) {
        const meta = state[EVT.BRIDGE_META];
        if (meta && meta.client===discoverUserId && meta.provider===svc.userId) { found=true; break; }
      }
      if (found) {
        await loadCases(); showToast('Bridge found â€” refreshing cases','success');
      } else {
        showToast(`No bridge found for ${discoverUserId}. The client must create a bridge and invite you.`,'warn');
      }
      setDiscoverModal(false);
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // Create a network â€” requires an org
  const handleCreateNetwork = async () => {
    if (!networkName.trim()) return;
    if (!orgRoom) { showToast('Create or join an organization before creating a network','warn'); return; }
    try {
      const nRoom = await svc.createRoom(`[Khora Network] ${networkName}`, 'Network governance room', [
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'network',name:networkName,owner:svc.userId,created:Date.now()}},
        {type:EVT.NET_MEMBERS,state_key:'',content:{organizations:[{id:orgRoom,name:orgMeta.name||'',joined:Date.now(),role:'admin'}],
          governance:{schema_changes_require:'admin_approval',admins:[orgRoom]}}},
      ]);
      // Seed network schema
      for (const p of DEFAULT_PROMPTS) await svc.setState(nRoom, EVT.SCHEMA_PROMPT, {...p, propagation:'standard', network:networkName}, `net:${p.key}`);
      for (const d of DEFAULT_DEFINITIONS) await svc.setState(nRoom, EVT.SCHEMA_DEF, {...d, propagation:'required', network:networkName}, `net:${d.key}`);
      await emitOp(nRoom, 'INS', {entity:'network',field:networkName}, {created_by:svc.userId,org:orgMeta.name}, networkFrame(nRoom));
      setNetworkRoom(nRoom);
      await loadNetworkMembers(nRoom);
      setNetworkModal(false); setNetworkName('');
      showToast(`Network "${networkName}" created`,'success');
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // Join existing network by room ID â€” requires an org
  const handleJoinNetwork = async () => {
    if (!joinNetworkId.trim()) return;
    if (!orgRoom) { showToast('Create or join an organization before joining a network','warn'); return; }
    try {
      if (svc.client) { await svc.client.joinRoom(joinNetworkId); }
      else { await svc._api('POST', `/join/${encodeURIComponent(joinNetworkId)}`, {}); }
      setNetworkRoom(joinNetworkId);
      await loadNetworkMembers(joinNetworkId);
      setJoinNetworkModal(false); setJoinNetworkId('');
      showToast('Joined network','success');
    } catch(e) { showToast('Failed to join: '+e.message,'error'); }
  };

  // â”€â”€â”€ Organization management â”€â”€â”€
  const handleCreateOrg = async () => {
    if (!setupData.name.trim()) return;
    try {
      const org = await svc.createRoom(`[Khora Org] ${setupData.name}`, `Organization: ${setupData.name}`, [
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'organization',owner:svc.userId,created:Date.now()}},
        {type:EVT.ORG_METADATA,state_key:'',content:{
          name:setupData.name, type:setupData.type, service_area:setupData.service_area,
          languages:setupData.languages.split(',').map(s=>s.trim()), created:Date.now()}},
        {type:EVT.ORG_ROSTER,state_key:'',content:{staff:[
          {userId:svc.userId,role:'admin',joined:Date.now()}
        ]}},
        {type:EVT.ROSTER_ASSIGN,state_key:'',content:{}},
        {type:EVT.ORG_OPACITY,state_key:'',content:{level:'translucent',updated:Date.now(),updated_by:svc.userId}},
        {type:EVT.ORG_MSG_ACCESS,state_key:'',content:{read:['admin','case_manager'],respond:['admin'],updated:Date.now()}},
      ]);
      await emitOp(org, 'DES', {entity:'organization',designation:setupData.name},
        {type:setupData.type,service_area:setupData.service_area}, orgFrame(org));
      await emitOp(org, 'INS', {entity:'staff',field:svc.userId},
        {role:'admin',initiated_by:'org_creation'}, orgFrame(org));
      setOrgRoom(org); setOrgRole('admin');
      setOrgMeta({name:setupData.name,type:setupData.type,service_area:setupData.service_area});
      setStaff([{userId:svc.userId,role:'admin',joined:Date.now()}]);
      setCreateOrgModal(false);
      setSetupData({name:'',type:'direct_service',service_area:'',languages:'en'});
      showToast(`Organization "${setupData.name}" created`,'success');
      // Create supporting rooms for org
      const orgMetricsR = await svc.createRoom('[Khora Metrics]','Org anonymized metrics',[
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'metrics',owner:svc.userId,created:Date.now()}},
      ]);
      const orgSchema = await svc.createRoom('[Khora Schema]','Org schema definitions',[
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'schema',owner:svc.userId,created:Date.now()}},
      ]);
      for (const p of DEFAULT_PROMPTS) await svc.setState(orgSchema, EVT.SCHEMA_PROMPT, p, p.key);
      for (const pp of DEFAULT_PROVIDER_PROMPTS) await svc.setState(orgSchema, EVT.SCHEMA_PROMPT, pp, pp.key);
      for (const d of DEFAULT_DEFINITIONS) await svc.setState(orgSchema, EVT.SCHEMA_DEF, d, d.key);
      for (const a of DEFAULT_AUTHORITIES) await svc.setState(orgSchema, EVT.SCHEMA_AUTHORITY, a, a.id);
      await svc.setState(orgSchema, EVT.SCHEMA_TRANSFORM, {id:'transform_default',transforms:DEFAULT_TRANSFORMS}, 'default');
    } catch(e) { showToast('Error creating org: '+e.message,'error'); }
  };

  const handleJoinOrg = async () => {
    if (!joinOrgId.trim()) return;
    try {
      if (svc.client) { await svc.client.joinRoom(joinOrgId); }
      else { await svc._api('POST', `/join/${encodeURIComponent(joinOrgId)}`, {}); }
      // Load the org metadata
      const meta = await svc.getState(joinOrgId, EVT.ORG_METADATA);
      const roster = await svc.getState(joinOrgId, EVT.ORG_ROSTER);
      const entry = roster?.staff?.find(s=>s.userId===svc.userId);
      setOrgRoom(joinOrgId); setOrgRole(entry?.role||'read_only');
      if (meta) setOrgMeta(meta);
      if (roster?.staff) setStaff(roster.staff);
      setJoinOrgModal(false); setJoinOrgId('');
      showToast(`Joined organization${meta?.name?' "'+meta.name+'"':''}`,'success');
    } catch(e) { showToast('Failed to join org: '+e.message,'error'); }
  };

  const handleInviteStaff = async () => {
    if (!inviteUserId.trim()||!orgRoom) return;
    try {
      await svc.invite(orgRoom, inviteUserId);
      const newStaff = [...staff, {userId:inviteUserId,role:inviteRole,joined:Date.now()}];
      await svc.setState(orgRoom, EVT.ORG_ROSTER, {staff:newStaff});
      await emitOp(orgRoom, 'CON', {source:orgRoom,destination:inviteUserId,relationship:'staff'},
        {role:inviteRole,invited_by:svc.userId}, orgFrame());
      setStaff(newStaff);
      setInviteModal(false); setInviteUserId('');
      showToast(`Invited ${inviteUserId} as ${ORG_ROLE_LABELS[inviteRole]}`,'success');
    } catch(e) { showToast('Invite failed: '+e.message,'error'); }
  };

  const handleRemoveStaff = async (userId) => {
    if (userId===svc.userId) { showToast('Cannot remove yourself','error'); return; }
    try {
      await svc.kick(orgRoom, userId, 'Removed from organization');
      const newStaff = staff.filter(s=>s.userId!==userId);
      await svc.setState(orgRoom, EVT.ORG_ROSTER, {staff:newStaff});
      await emitOp(orgRoom, 'NUL', {entity:'staff',field:userId},
        {reason:'removed',removed_by:svc.userId}, orgFrame());
      setStaff(newStaff);
      showToast(`Removed ${userId}`,'warn');
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // â”€â”€â”€ Email verification management â”€â”€â”€
  const handleSaveEmailVerifyConfig = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const config = {
        enabled: emailConfigDraft.enabled,
        required_domains: emailConfigDraft.required_domains.filter(d => d.trim()),
        require_for_roles: emailConfigDraft.require_for_roles,
        grace_period_hours: emailConfigDraft.grace_period_hours || 72,
      };
      await svc.setState(orgRoom, EVT.ORG_EMAIL_CONFIG, config);
      setEmailVerifyConfig(config);
      await emitOp(orgRoom, 'ALT', {entity:'email_verification_config', field:'enabled', value:config.enabled},
        {domains:config.required_domains, roles:config.require_for_roles}, orgFrame());
      setEmailConfigModal(false);
      showToast(`Email verification ${config.enabled ? 'enabled' : 'disabled'}`, 'success');
    } catch(e) { showToast('Error saving config: '+e.message, 'error'); }
  };

  const handleStartEmailVerify = async () => {
    if (!verifyEmail.trim() || !orgRoom) return;
    setVerifyError('');
    if (!EmailVerification.isValidEmail(verifyEmail)) {
      setVerifyError('Please enter a valid email address');
      return;
    }
    if (emailVerifyConfig.required_domains?.length > 0 && !EmailVerification.domainMatches(verifyEmail, emailVerifyConfig.required_domains)) {
      setVerifyError(`Email must be from: ${emailVerifyConfig.required_domains.join(', ')}`);
      return;
    }
    setVerifyPending(true);
    try {
      const { challenge, plainCode } = await EmailVerification.createChallenge(svc.userId, verifyEmail);
      // Store challenge in org room state (hashed code only)
      await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, challenge, svc.userId);
      // Attempt to deliver via webhook; fall back to Matrix DM display
      const sent = await EmailVerification.sendCodeViaWebhook(verifyEmail, plainCode, orgMeta.name || 'Organization');
      if (!sent) {
        // Fallback: show code in-app for development/demo (in production, email infra handles this)
        showToast(`Verification code: ${plainCode} (demo mode â€” production sends via email)`, 'info', 12000);
      } else {
        showToast('Verification code sent to ' + verifyEmail, 'success');
      }
      await emitOp(orgRoom, 'INS', {entity:'email_verification', field:svc.userId},
        {email_domain:EmailVerification.extractDomain(verifyEmail), status:'pending'}, orgFrame());
      setVerifyStep('code');
    } catch(e) { setVerifyError('Failed to start verification: ' + e.message); }
    setVerifyPending(false);
  };

  const handleSubmitVerifyCode = async () => {
    if (!verifyCode.trim() || verifyCode.length !== 6 || !orgRoom) return;
    setVerifyError('');
    setVerifyPending(true);
    try {
      // Fetch the stored challenge
      const challenge = await svc.getState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, svc.userId);
      const result = await EmailVerification.validateChallenge(challenge, verifyCode);
      if (!result.valid) {
        // Update attempt count
        if (result.reason === 'incorrect_code') {
          const updated = { ...challenge, attempts: (challenge.attempts || 0) + 1 };
          await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, updated, svc.userId);
          setVerifyError(`Incorrect code (${updated.attempts}/${challenge.max_attempts} attempts)`);
        } else if (result.reason === 'expired') {
          setVerifyError('Code expired. Please request a new one.');
          setVerifyStep('email');
        } else if (result.reason === 'max_attempts') {
          setVerifyError('Too many attempts. Please request a new code.');
          setVerifyStep('email');
        } else {
          setVerifyError('Verification failed. Please try again.');
        }
        setVerifyPending(false);
        return;
      }
      // Success â€” update roster with verified status
      const verifiedEntry = {
        status: 'verified',
        email: verifyEmail.trim().toLowerCase(),
        domain: EmailVerification.extractDomain(verifyEmail),
        verified_at: Date.now(),
      };
      const newStaff = staff.map(s =>
        s.userId === svc.userId ? { ...s, email_verification: verifiedEntry } : s
      );
      await svc.setState(orgRoom, EVT.ORG_ROSTER, { staff: newStaff });
      // Clear the challenge
      await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, { status: 'completed', verified_at: Date.now() }, svc.userId);
      await emitOp(orgRoom, 'ALT', {entity:'email_verification', field:svc.userId, value:'verified'},
        {email_domain:EmailVerification.extractDomain(verifyEmail), verified_at:Date.now()}, orgFrame());
      setStaff(newStaff);
      setMyVerification(verifiedEntry);
      setVerifyStep('done');
      showToast('Email verified successfully', 'success');
    } catch(e) { setVerifyError('Verification error: ' + e.message); }
    setVerifyPending(false);
  };

  const handleRevokeVerification = async (userId) => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const newStaff = staff.map(s =>
        s.userId === userId ? { ...s, email_verification: { status: 'revoked', revoked_at: Date.now(), revoked_by: svc.userId } } : s
      );
      await svc.setState(orgRoom, EVT.ORG_ROSTER, { staff: newStaff });
      await emitOp(orgRoom, 'NUL', {entity:'email_verification', field:userId},
        {reason:'admin_revoked', revoked_by:svc.userId}, orgFrame());
      setStaff(newStaff);
      if (userId === svc.userId) setMyVerification({ status: 'revoked' });
      showToast(`Revoked verification for ${userId}`, 'warn');
    } catch(e) { showToast('Error revoking: '+e.message, 'error'); }
  };

  const openEmailVerifyModal = () => {
    setVerifyEmail('');
    setVerifyCode('');
    setVerifyStep('email');
    setVerifyError('');
    setVerifyPending(false);
    setEmailVerifyModal(true);
  };

  // â”€â”€â”€ Provider profile management â”€â”€â”€
  const handleSaveProfile = async () => {
    if (!rosterRoom) return;
    try {
      const profile = {
        display_name: profileDraft.display_name.trim(),
        title: profileDraft.title.trim(),
        credentials: profileDraft.credentials.trim(),
        bio: profileDraft.bio.trim(),
        service_types: profileDraft.service_types.trim(),
        org_membership: orgRoom ? {
          org_room_id: orgRoom,
          org_name: orgMeta.name || '',
          org_type: orgMeta.type || '',
          role: orgRole || '',
          verified: myVerification?.status === 'verified' || !emailVerifyConfig.enabled,
          email_verified: myVerification?.status === 'verified',
          verified_email: myVerification?.status === 'verified' ? myVerification.email : null,
          verified_domain: myVerification?.status === 'verified' ? myVerification.domain : null,
        } : null,
        updated: Date.now(),
      };
      await svc.setState(rosterRoom, EVT.PROVIDER_PROFILE, profile);
      setProviderProfile(profile);
      // Broadcast profile to all bridge rooms so clients can see provider identity
      for (const c of cases) {
        try {
          await svc.setState(c.bridgeRoomId, EVT.PROVIDER_PROFILE, profile);
        } catch (e) { console.warn('Profile broadcast failed for bridge', c.bridgeRoomId, e.message); }
      }
      setProfileModal(false);
      showToast('Profile updated â€” broadcast to all bridges', 'success');
    } catch (e) { showToast('Failed to save profile: ' + e.message, 'error'); }
  };

  const openProfileModal = () => {
    setProfileDraft({
      display_name: providerProfile.display_name || '',
      title: providerProfile.title || '',
      credentials: providerProfile.credentials || '',
      bio: providerProfile.bio || '',
      service_types: providerProfile.service_types || '',
    });
    setProfileModal(true);
  };

  // â”€â”€â”€ Inter-org messaging â”€â”€â”€

  // Check if current user has permission for an org messaging action
  const hasOrgMsgPermission = useCallback((action) => {
    // action: 'read' or 'respond'
    if (!orgRole) return false;
    const allowed = orgMsgAccess[action] || [];
    return allowed.includes(orgRole);
  }, [orgRole, orgMsgAccess]);

  // Save opacity setting (admin only)
  const handleSaveOpacity = async (level) => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      await svc.setState(orgRoom, EVT.ORG_OPACITY, {level, updated: Date.now(), updated_by: svc.userId});
      setOrgOpacity(level);
      await emitOp(orgRoom, 'ALT', {entity:'org_opacity',field:'level'}, {from:orgOpacity,to:level,changed_by:svc.userId}, orgFrame());
      showToast(`Opacity set to ${OPACITY_LABELS[level]}`,'success');
    } catch(e) { showToast('Failed to update opacity: '+e.message,'error'); }
  };

  // Save message access settings (admin only)
  const handleSaveMsgAccess = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      await svc.setState(orgRoom, EVT.ORG_MSG_ACCESS, {...msgAccessDraft, updated: Date.now()});
      setOrgMsgAccess(msgAccessDraft);
      await emitOp(orgRoom, 'ALT', {entity:'org_msg_access',field:'roles'}, {read:msgAccessDraft.read,respond:msgAccessDraft.respond}, orgFrame());
      setMsgAccessModal(false);
      showToast('Message access roles updated','success');
    } catch(e) { showToast('Failed to update access: '+e.message,'error'); }
  };

  // Save org terminology customization (admin only)
  const handleSaveTerminology = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const payload = {...terminologyDraft, updated: Date.now(), updated_by: svc.userId};
      await svc.setState(orgRoom, EVT.ORG_TERMINOLOGY, payload);
      setOrgTerminology({...TERMINOLOGY_DEFAULTS, ...terminologyDraft});
      setTerminologyModal(false);
      await emitOp(orgRoom, 'ALT', {entity:'org_terminology',field:'terms'}, {
        client_term: terminologyDraft.client_term,
        provider_term: terminologyDraft.provider_term,
        changed_by: svc.userId
      }, orgFrame());
      showToast('Terminology updated','success');
    } catch(e) { showToast('Failed to update terminology: '+e.message,'error'); }
  };

  // Reset terminology to defaults
  const handleResetTerminology = () => {
    setTerminologyDraft({...TERMINOLOGY_DEFAULTS});
  };

  // Create org-to-org messaging channel
  const handleCreateOrgChannel = async () => {
    if (!orgRoom || !composePeerOrgId.trim()) return;
    // Check for existing channel
    const existing = orgChannels.find(c => c.orgs?.includes(composePeerOrgId.trim()));
    if (existing) {
      setActiveChannel(existing.roomId);
      setView('org-inbox');
      setComposeOrgModal(false);
      showToast('Channel already exists â€” opened','info');
      return;
    }
    try {
      const peerOrgId = composePeerOrgId.trim();
      const channelRoom = await svc.createRoom(
        `[Khora Org Msg] ${orgMeta.name||'Org'} â†” ${composePeerOrgName||peerOrgId.slice(0,12)}`,
        'Inter-org messaging channel',
        [
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'org_msg_channel',created:Date.now()}},
          {type:EVT.ORG_MSG_CHANNEL,state_key:'',content:{
            type:'org_msg_channel',
            orgs:[orgRoom, peerOrgId],
            org_names:{[orgRoom]:orgMeta.name||'',[peerOrgId]:composePeerOrgName||''},
            created:Date.now(), created_by:svc.userId,
          }},
        ]
      );
      // Invite the peer org room members (the channel inherits access from org rooms)
      try { await svc.invite(channelRoom, peerOrgId); } catch(e) { console.warn('Peer invite:', e.message); }
      await emitOp(channelRoom, 'INS', {entity:'org_msg_channel',field:'channel'},
        {from_org:orgRoom,to_org:peerOrgId}, orgFrame());
      const newChannel = {roomId:channelRoom,orgs:[orgRoom,peerOrgId],
        org_names:{[orgRoom]:orgMeta.name||'',[peerOrgId]:composePeerOrgName||''},type:'org_msg_channel',created:Date.now()};
      setOrgChannels(prev=>[...prev,newChannel]);
      setActiveChannel(channelRoom);
      setView('org-inbox');
      setComposeOrgModal(false); setComposePeerOrgId(''); setComposePeerOrgName('');
      showToast('Messaging channel created','success');
    } catch(e) { showToast('Failed to create channel: '+e.message,'error'); }
  };

  // Load messages for an org channel
  const loadChannelMessages = async (channelRoomId) => {
    if (!channelRoomId) return;
    const msgs = await svc.getMessages(channelRoomId);
    setChannelMessages(msgs);
  };

  // Send a message in an org channel â€” applies opacity envelope
  const handleSendOrgMsg = async () => {
    if (!orgMsgText.trim() || !activeChannel) return;
    if (!hasOrgMsgPermission('respond')) { showToast('You do not have permission to send org messages','warn'); return; }
    try {
      // Build opacity envelope: what the receiving org sees depends on our opacity setting
      const envelope = {
        [`${NS}.type`]: 'org_message',
        [`${NS}.envelope`]: {
          opacity: orgOpacity,
          org_room_id: orgOpacity === 'opaque' ? undefined : orgRoom,
          org_name: orgOpacity === 'opaque' ? undefined : (orgMeta.name || undefined),
          sender_id: orgOpacity === 'transparent' ? svc.userId : undefined,
          sender_name: orgOpacity === 'transparent' ? (providerProfile.display_name || undefined) : undefined,
          ts: Date.now(),
        },
      };
      await svc.sendMessage(activeChannel, orgMsgText, envelope);
      await emitOp(activeChannel, 'INS', {type:'org_message',field:'message'},
        {opacity:orgOpacity,body_length:orgMsgText.length}, orgFrame());
      setOrgMsgText('');
      setTimeout(()=>loadChannelMessages(activeChannel),500);
    } catch(e) { showToast('Send failed: '+e.message,'error'); }
  };

  // Open a channel
  const openChannel = (channelRoomId) => {
    setActiveChannel(channelRoomId);
    setView('org-inbox');
    loadChannelMessages(channelRoomId);
  };

  // Resolve display info for a message based on opacity
  const resolveMessageSender = useCallback((msg) => {
    const env = msg.content?.[`${NS}.envelope`];
    if (!env) return {label: msg.sender === svc.userId ? 'You' : msg.sender, isOwn: msg.sender === svc.userId};
    const isOwn = msg.sender === svc.userId || env.org_room_id === orgRoom;
    switch (env.opacity) {
      case 'transparent':
        return {label: env.sender_name || env.sender_id || 'Unknown', org: env.org_name, isOwn};
      case 'translucent':
        return {label: env.org_name || 'Organization', org: env.org_name, isOwn};
      case 'opaque':
        return {label: 'An organization', org: null, isOwn};
      default:
        return {label: msg.sender, isOwn};
    }
  }, [orgRoom]);

  // â”€â”€â”€ Inbox chat functions â”€â”€â”€
  const loadInboxMessages = async (roomId) => { setInboxMessages(await svc.getMessages(roomId)); };
  const openInboxConvo = (roomId) => {
    setInboxConvo(roomId);
    loadInboxMessages(roomId);
  };
  const handleSendInboxMsg = async () => {
    if (!inboxMsgText.trim() || !inboxConvo) return;
    const isOrgChannel = orgChannels.some(ch => ch.roomId === inboxConvo);
    if (isOrgChannel) {
      if (!hasOrgMsgPermission('respond')) { showToast('You do not have permission to send org messages','warn'); return; }
      const envelope = {
        [`${NS}.type`]: 'org_message',
        [`${NS}.envelope`]: {
          opacity: orgOpacity,
          org_room_id: orgOpacity === 'opaque' ? undefined : orgRoom,
          org_name: orgOpacity === 'opaque' ? undefined : (orgMeta.name || undefined),
          sender_id: orgOpacity === 'transparent' ? svc.userId : undefined,
          sender_name: orgOpacity === 'transparent' ? (providerProfile.display_name || undefined) : undefined,
          ts: Date.now(),
        },
      };
      await svc.sendMessage(inboxConvo, inboxMsgText, envelope);
    } else {
      await svc.sendMessage(inboxConvo, inboxMsgText, {[`${NS}.type`]:'note'});
      await emitOp(inboxConvo, 'INS', {type:'provider_note',field:'message'}, {body:inboxMsgText}, bridgeFrame(inboxConvo));
    }
    setInboxMsgText('');
    setTimeout(() => loadInboxMessages(inboxConvo), 500);
  };
  const getInboxConvoName = useCallback((roomId) => {
    const c = cases.find(c => c.bridgeRoomId === roomId);
    if (c) return c.sharedData.full_name || c.clientUserId;
    const ch = orgChannels.find(ch => ch.roomId === roomId);
    if (ch) {
      const peerOrgId = ch.orgs?.find(o => o !== orgRoom);
      return ch.org_names?.[peerOrgId] || peerOrgId?.slice(0,20) || 'Organization';
    }
    return roomId?.slice(0,20) || 'Unknown';
  }, [cases, orgChannels, orgRoom]);
  const getInboxConvoType = useCallback((roomId) => {
    if (cases.some(c => c.bridgeRoomId === roomId)) return 'case';
    if (orgChannels.some(ch => ch.roomId === roomId)) return 'channel';
    return 'unknown';
  }, [cases, orgChannels]);

  // Determine network role based on org membership
  const networkRole = useMemo(() => {
    if (!networkRoom || !orgRoom) return null;
    const myOrg = networkMembers.find(m => m.id === orgRoom || m.id === svc.userId);
    return myOrg?.role || 'member';
  }, [networkRoom, orgRoom, networkMembers]);

  const openCase = (bid) => { setView('case'); setActiveCase(bid); loadMessages(bid); loadProviderObservations(bid); };
  const activeCaseData = cases.find(c=>c.bridgeRoomId===activeCase);

  // Aggregate metrics for dashboard
  const metricsByCategory = useMemo(() => {
    const agg = {};
    metrics.forEach(m => {
      const cat = m.observation?.category||'unknown';
      const val = m.observation?.value||'unknown';
      if (!agg[cat]) agg[cat]={};
      agg[cat][val] = (agg[cat][val]||0) + 1;
    });
    return agg;
  }, [metrics]);

  if(loading) return <div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}><Spin s={28}/></div>;

  if(initError) return <div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center',maxWidth:400,padding:20}}>
      <div style={{width:48,height:48,borderRadius:'var(--r-lg)',background:'var(--red-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--red)',margin:'0 auto 16px'}}><I n="alert-triangle" s={24}/></div>
      <h3 style={{fontSize:16,fontWeight:700,marginBottom:8}}>Provider Setup Failed</h3>
      <p style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6,marginBottom:16}}>{initError}</p>
      <div style={{display:'flex',gap:8,justifyContent:'center'}}>
        <button onClick={initProvider} className="b-pri"><I n="refresh-cw" s={13}/>Retry</button>
        <button onClick={onLogout} className="b-gho">Sign Out</button>
      </div>
    </div>
  </div>;

  return <div style={{display:'flex',height:'100%'}}>
    {/* Sidebar */}
    <div className="app-sidebar" style={{width:260,minWidth:260,height:'100%',background:'var(--bg-1)',borderRight:'1px solid var(--border-0)',display:'flex',flexDirection:'column'}}>
      <div style={{padding:'18px 14px 14px',borderBottom:'1px solid var(--border-0)'}}>
        <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
          <div style={{width:28,height:28,borderRadius:'var(--r)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)'}}><I n="briefcase" s={15}/></div>
          <span style={{fontFamily:'var(--serif)',fontWeight:700,fontSize:15}}>Khora</span>
        </div>
        {/* Provider identity card */}
        <div onClick={openProfileModal} style={{marginTop:10,padding:'10px 12px',background:'var(--bg-2)',border:'1px solid var(--border-1)',borderRadius:'var(--r-lg)',cursor:'pointer',transition:'border-color .2s'}}
          onMouseEnter={e=>e.currentTarget.style.borderColor='var(--gold)'}
          onMouseLeave={e=>e.currentTarget.style.borderColor='var(--border-1)'}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
            <div style={{width:32,height:32,borderRadius:'50%',background:orgRoom?'var(--blue-dim)':'var(--gold-dim)',
              display:'flex',alignItems:'center',justifyContent:'center',color:orgRoom?'var(--blue)':'var(--gold)',
              border:orgRoom?'2px solid var(--blue)':'2px solid var(--gold)'}}>
              <I n={orgRoom?'shieldCheck':'user'} s={16}/>
            </div>
            <div style={{flex:1,minWidth:0}}>
              <span style={{fontSize:13,fontWeight:700,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',color:'var(--tx-0)'}}>
                {providerProfile.display_name || svc.userId?.split(':')[0]?.replace('@','') || T.provider_term}
              </span>
              {providerProfile.title && <span style={{fontSize:10,color:'var(--tx-2)',display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{providerProfile.title}</span>}
            </div>
          </div>
          {orgRoom ? <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.2)',borderRadius:'var(--r)',padding:'6px 8px',display:'flex',alignItems:'center',gap:6}}>
            <I n="shieldCheck" s={12} c="var(--blue)"/>
            <div style={{flex:1,minWidth:0}}>
              <span style={{fontSize:10.5,fontWeight:600,color:'var(--blue)',display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{orgMeta.name || 'Organization'}</span>
              <span style={{fontSize:9,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{ORG_ROLE_LABELS[orgRole]||orgRole} Â· {ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type}</span>
            </div>
            {myVerification?.status==='verified' ? <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>VERIFIED</span>
            : emailVerifyConfig.enabled ? <span className="tag tag-gold" style={{fontSize:7.5,padding:'1px 5px',cursor:'pointer'}} onClick={openEmailVerifyModal}>UNVERIFIED</span>
            : <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>VERIFIED</span>}
          </div> : <div style={{display:'flex',alignItems:'center',gap:4,padding:'4px 0'}}>
            <span style={{fontSize:9.5,color:'var(--tx-3)',fontStyle:'italic'}}>No organization â€” unaffiliated</span>
          </div>}
          <div style={{display:'flex',alignItems:'center',gap:4,marginTop:6}}>
            <span style={{fontFamily:'var(--mono)',fontSize:8.5,color:'var(--tx-3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}}>{svc.userId}</span>
            <span className="tag tag-gold" style={{fontSize:8}}>{T.provider_term.toUpperCase()}</span>
          </div>
          {providerProfile.credentials && <div style={{marginTop:4}}>
            <span style={{fontSize:9,color:'var(--tx-2)',fontFamily:'var(--mono)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',display:'block'}}>{providerProfile.credentials}</span>
          </div>}
        </div>
      </div>
      <div style={{flex:1,overflow:'auto',padding:'6px 6px'}}>
        {/* Personal nav */}
        {[{id:'dashboard',icon:'briefcase',label:'Dashboard'},{id:'inbox',icon:'inbox',label:'Inbox'},
          {id:'clients',icon:'users',label:T.client_term_plural},
          {id:'metrics',icon:'bar',label:'Metrics'},
          {id:'schema',icon:'grid',label:'Schema'},
          {id:'activity',icon:'zap',label:'Activity Stream'}
        ].map(item=><div key={item.id} onClick={()=>{setView(item.id);setActiveCase(null);if(item.id!=='inbox'){setInboxConvo(null);setInboxMessages([])}}}
          style={{padding:'9px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
            background:view===item.id&&!activeCase?'var(--bg-4)':'transparent',
            borderLeft:view===item.id&&!activeCase?'2px solid var(--gold)':'2px solid transparent',
            display:'flex',alignItems:'center',gap:8,transition:'all .15s',
            color:view===item.id&&!activeCase?'var(--tx-0)':'var(--tx-1)'}}
          onMouseEnter={e=>{if(!(view===item.id&&!activeCase))e.currentTarget.style.background='var(--bg-3)'}}
          onMouseLeave={e=>{if(!(view===item.id&&!activeCase))e.currentTarget.style.background='transparent'}}>
          <I n={item.icon} s={14}/><span style={{fontSize:12.5,fontWeight:view===item.id?600:400}}>{item.label}</span>
          {item.id==='inbox'&&(cases.length+orgChannels.length)>0&&<span style={{marginLeft:'auto',background:'var(--gold)',color:'var(--bg-0)',fontSize:9,fontWeight:700,borderRadius:10,padding:'1px 6px',minWidth:16,textAlign:'center'}}>{cases.length+orgChannels.length}</span>}
        </div>)}

        {/* Organization section */}
        <div style={{padding:'14px 10px 4px'}}><span className="section-label">ORGANIZATION</span></div>
        {orgRoom ? <>
          <div style={{padding:'6px 10px',marginBottom:4}}>
            <div style={{display:'flex',alignItems:'center',gap:6}}>
              <div style={{width:20,height:20,borderRadius:'var(--r)',background:'var(--blue-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--blue)'}}><I n="users" s={11}/></div>
              <span style={{fontSize:11.5,fontWeight:600,color:'var(--tx-0)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{orgMeta.name||'Organization'}</span>
            </div>
            {orgMeta.type&&<span className="tag tag-teal" style={{fontSize:8,marginTop:4,marginLeft:26}}>{ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type}</span>}
          </div>
          {[
            {id:'org-settings',icon:'settings',label:'Org Settings',reqRole:'admin'},
            {id:'org-inbox',icon:'msg',label:`Inbox${orgChannels.length?` (${orgChannels.length})`:''}`},
            {id:'staff',icon:'users',label:'Staff'},
            {id:'network',icon:'globe',label:'Network'},
          ].filter(item=>!item.reqRole||orgRole===item.reqRole).filter(item=>item.id!=='org-inbox'||hasOrgMsgPermission('read')).map(item=><div key={item.id} onClick={()=>{setView(item.id);setActiveCase(null)}}
            style={{padding:'9px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
              background:view===item.id&&!activeCase?'var(--bg-4)':'transparent',
              borderLeft:view===item.id&&!activeCase?'2px solid var(--blue)':'2px solid transparent',
              display:'flex',alignItems:'center',gap:8,transition:'all .15s',
              color:view===item.id&&!activeCase?'var(--tx-0)':'var(--tx-1)'}}
            onMouseEnter={e=>{if(!(view===item.id&&!activeCase))e.currentTarget.style.background='var(--bg-3)'}}
            onMouseLeave={e=>{if(!(view===item.id&&!activeCase))e.currentTarget.style.background='transparent'}}>
            <I n={item.icon} s={14}/><span style={{fontSize:12.5,fontWeight:view===item.id?600:400}}>{item.label}</span>
          </div>)}
        </> : <div style={{padding:'4px 10px',display:'flex',flexDirection:'column',gap:4}}>
          <button onClick={()=>setCreateOrgModal(true)} className="b-gho b-sm" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:4}}>
            <I n="plus" s={12}/>Create Organization</button>
          <button onClick={()=>setJoinOrgModal(true)} className="b-gho b-xs" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:4}}>
            <I n="users" s={10}/>Join Organization</button>
        </div>}

        {/* Cases section */}
        <div style={{padding:'14px 10px 4px'}}><span className="section-label">CASES ({cases.length})</span></div>
        {cases.length===0&&<p style={{color:'var(--tx-3)',fontSize:11.5,padding:'12px 10px',textAlign:'center'}}>No clients shared with you yet</p>}
        {cases.map((c,i)=><div key={c.bridgeRoomId} onClick={()=>openCase(c.bridgeRoomId)}
          style={{padding:'8px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
            background:activeCase===c.bridgeRoomId?'var(--bg-4)':'transparent',
            borderLeft:activeCase===c.bridgeRoomId?'2px solid var(--gold)':'2px solid transparent',transition:'all .15s'}}
          onMouseEnter={e=>{if(activeCase!==c.bridgeRoomId)e.currentTarget.style.background='var(--bg-3)'}}
          onMouseLeave={e=>{if(activeCase!==c.bridgeRoomId)e.currentTarget.style.background='transparent'}}>
          <span style={{fontSize:12,fontWeight:activeCase===c.bridgeRoomId?600:400,display:'block'}}>{c.sharedData.full_name||c.clientUserId}</span>
          <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{Object.keys(c.sharedData).length} fields</span>
        </div>)}
        <div style={{padding:'12px 10px',display:'flex',flexDirection:'column',gap:4}}>
          <button onClick={()=>setDiscoverModal(true)} className="b-gho b-sm" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:4}}>
            <I n="search" s={12}/>Find Client</button>
          <button onClick={()=>loadCases()} className="b-gho b-xs" style={{width:'100%'}}><I n="search" s={10}/>Refresh</button>
        </div>
      </div>
      <div style={{padding:'8px 10px',borderTop:'1px solid var(--border-0)',display:'flex',flexDirection:'column',gap:6}}>
        <ThemeToggle style={{width:'100%',justifyContent:'center'}}/>
        <button onClick={onLogout} className="b-gho b-sm" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:5}}><I n="logout" s={12}/>Logout</button>
      </div>
    </div>

    {/* Main */}
    <div className="app-main" style={{flex:1,overflow:'auto',padding:24}}>

      {/* DASHBOARD */}
      {view==='dashboard'&&!activeCase&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>{T.provider_term} Dashboard</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:24}}>You can only see data {T.client_term_plural.toLowerCase()} have explicitly shared. Each case is a separate encrypted bridge room.</p>

        {/* Provider identity card */}
        <div className="card" style={{marginBottom:20,padding:0,overflow:'hidden'}}>
          <div style={{padding:'16px 18px',display:'flex',alignItems:'center',gap:14}}>
            <div style={{width:48,height:48,borderRadius:'50%',background:orgRoom?'var(--blue-dim)':'var(--gold-dim)',
              display:'flex',alignItems:'center',justifyContent:'center',color:orgRoom?'var(--blue)':'var(--gold)',
              border:orgRoom?'2px solid var(--blue)':'2px solid var(--gold)',flexShrink:0}}>
              <I n={orgRoom?'shieldCheck':'user'} s={24}/>
            </div>
            <div style={{flex:1,minWidth:0}}>
              <span style={{fontSize:17,fontWeight:700,display:'block'}}>{providerProfile.display_name || svc.userId?.split(':')[0]?.replace('@','') || T.provider_term}</span>
              {providerProfile.title && <span style={{fontSize:12,color:'var(--tx-2)',display:'block'}}>{providerProfile.title}</span>}
              {providerProfile.credentials && <span style={{fontSize:10.5,color:'var(--tx-2)',fontFamily:'var(--mono)',display:'block',marginTop:2}}>{providerProfile.credentials}</span>}
            </div>
            <button onClick={openProfileModal} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="settings" s={11}/>Edit</button>
          </div>
          {orgRoom ? <div style={{padding:'10px 18px',background:'var(--blue-dim)',borderTop:'1px solid rgba(91,156,245,.12)',display:'flex',alignItems:'center',gap:10}}>
            <I n="shieldCheck" s={16} c="var(--blue)"/>
            <div style={{flex:1}}>
              <span style={{fontSize:12.5,fontWeight:600,color:'var(--blue)',display:'block'}}>{orgMeta.name||'Organization'}</span>
              <span style={{fontSize:10,color:'var(--tx-2)'}}>{ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type} Â· {staff.length} staff Â· {ORG_ROLE_LABELS[orgRole]||orgRole}</span>
            </div>
            {myVerification?.status==='verified' ? <span className="tag tag-green" style={{fontSize:8}}>VERIFIED</span>
            : emailVerifyConfig.enabled ? <span className="tag tag-gold" style={{fontSize:8,cursor:'pointer'}} onClick={openEmailVerifyModal}>VERIFY</span>
            : <span className="tag tag-green" style={{fontSize:8}}>VERIFIED</span>}
            <button onClick={()=>setView('org-settings')} className="b-gho b-xs"><I n="settings" s={11}/></button>
          </div> : <div style={{padding:'10px 18px',background:'var(--gold-dim)',borderTop:'1px solid var(--gold-mid)',display:'flex',alignItems:'center',gap:8}}>
            <I n="alert" s={14} c="var(--gold)"/>
            <span style={{fontSize:11,color:'var(--gold)',flex:1}}>Not affiliated with an organization</span>
            <button onClick={()=>setCreateOrgModal(true)} className="b-gho b-xs">Set Up</button>
          </div>}
          {providerProfile.bio && <div style={{padding:'10px 18px',borderTop:'1px solid var(--border-0)'}}>
            <span style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.5}}>{providerProfile.bio}</span>
          </div>}
          {!providerProfile.display_name && <div style={{padding:'10px 18px',borderTop:'1px solid var(--border-0)',display:'flex',alignItems:'center',gap:8}}>
            <I n="alert" s={13} c="var(--gold)"/>
            <span style={{fontSize:11,color:'var(--gold)'}}>Set up your profile â€” {T.client_term_plural.toLowerCase()} will see your name, title, and org membership on bridges.</span>
            <button onClick={openProfileModal} className="b-pri b-xs">Set Up</button>
          </div>}
        </div>

        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))',gap:10,marginBottom:24}}>
          {[{l:'Active Cases',v:cases.length,c:'gold',i:'briefcase'},
            {l:orgRoom?'Staff':'Organization',v:orgRoom?`${staff.length} members`:'Not set up',c:orgRoom?'blue':'teal',i:orgRoom?'users':'plus'},
            {l:'Access Model',v:`${T.client_term}-granted`,c:'teal',i:'shield'},{l:'Metric Events',v:metrics.length,c:'orange',i:'bar'}
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {cases.length>0&&<><span className="section-label">ALL CASES</span>
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(250px,1fr))',gap:10,marginTop:6}}>
            {cases.map(c=><div key={c.bridgeRoomId} className="card-h" onClick={()=>openCase(c.bridgeRoomId)}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
                <span style={{fontSize:14,fontWeight:600}}>{c.sharedData.full_name||`Anonymous ${T.client_term}`}</span>
                <I n="chevR" s={13} c="var(--tx-3)"/></div>
              {c.sharedData.email&&<span style={{fontFamily:'var(--mono)',fontSize:10.5,color:'var(--tx-2)',display:'block',marginBottom:6}}>{c.sharedData.email}</span>}
              <div style={{display:'flex',gap:4}}>
                <span className="tag tag-green"><I n="lock" s={9}/>E2EE</span>
                <span className="tag tag-blue">{Object.keys(c.sharedData).length} fields</span></div>
            </div>)}
          </div></>}
        <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="eye" s={16} c="var(--gold)"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>As a provider, you cannot modify client vault data. Clients can revoke your access at any time.{!orgRoom&&' Create or join an organization to manage staff, cases across your team, and participate in networks.'}</span>
        </div>
      </div>}

      {/* INBOX VIEW */}
      {view==='inbox'&&!activeCase&&<div className="anim-up inbox-wrap">
        <div className="inbox-header">
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Inbox</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>All your encrypted conversations with clients{orgRoom?' and organizations':''} in one place.</p>
          </div>
          <div style={{display:'flex',gap:6,flexShrink:0}}>
            <button onClick={()=>setDiscoverModal(true)} className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="search" s={14}/>Find Client</button>
            {orgRoom&&hasOrgMsgPermission('read')&&<button onClick={()=>setComposeOrgModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>New Channel</button>}
          </div>
        </div>
        {/* Tabs */}
        {orgRoom&&hasOrgMsgPermission('read')&&<div className="tabs" style={{marginBottom:16}}>
          <div className={`tab${inboxTab==='cases'?' active':''}`} onClick={()=>{setInboxTab('cases');setInboxConvo(null);setInboxMessages([])}}>Cases ({cases.length})</div>
          <div className={`tab${inboxTab==='channels'?' active':''}`} onClick={()=>{setInboxTab('channels');setInboxConvo(null);setInboxMessages([])}}>Org Channels ({orgChannels.length})</div>
        </div>}
        <div className="inbox-panel">
          {/* Conversation list */}
          <div className="inbox-list">
            <div style={{padding:'14px 14px 10px',borderBottom:'1px solid var(--border-0)'}}>
              <span className="section-label" style={{marginBottom:0}}>{inboxTab==='cases'?`CASES (${cases.length})`:`CHANNELS (${orgChannels.length})`}</span>
            </div>
            <div style={{flex:1,overflow:'auto'}}>
              {inboxTab==='cases' ? <>
                {cases.length===0?
                  <div style={{padding:'40px 16px',textAlign:'center'}}>
                    <I n="briefcase" s={28} c="var(--tx-3)"/>
                    <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:10}}>No cases yet</p>
                    <p style={{color:'var(--tx-3)',fontSize:10.5,marginTop:4}}>Clients must share a bridge with you first</p>
                  </div>
                :cases.map(c=><div key={c.bridgeRoomId} onClick={()=>openInboxConvo(c.bridgeRoomId)}
                  style={{padding:'12px 14px',cursor:'pointer',borderBottom:'1px solid var(--border-0)',
                    background:inboxConvo===c.bridgeRoomId?'var(--bg-4)':'transparent',
                    borderLeft:inboxConvo===c.bridgeRoomId?'3px solid var(--gold)':'3px solid transparent',
                    transition:'all .15s'}}
                  onMouseEnter={e=>{if(inboxConvo!==c.bridgeRoomId)e.currentTarget.style.background='var(--bg-3)'}}
                  onMouseLeave={e=>{if(inboxConvo!==c.bridgeRoomId)e.currentTarget.style.background=inboxConvo===c.bridgeRoomId?'var(--bg-4)':'transparent'}}>
                  <div style={{display:'flex',alignItems:'center',gap:10}}>
                    <div style={{width:36,height:36,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)',border:'2px solid var(--teal)',flexShrink:0}}>
                      <I n="user" s={16}/>
                    </div>
                    <div style={{flex:1,minWidth:0}}>
                      <span style={{fontSize:13,fontWeight:inboxConvo===c.bridgeRoomId?700:500,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{c.sharedData.full_name||c.clientUserId}</span>
                      <div style={{display:'flex',alignItems:'center',gap:4,marginTop:2}}>
                        <span className="tag tag-green" style={{fontSize:8}}><I n="lock" s={7}/>E2EE</span>
                        <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{Object.keys(c.sharedData).length} fields</span>
                      </div>
                    </div>
                  </div>
                </div>)}
              </> : <>
                {orgChannels.length===0?
                  <div style={{padding:'40px 16px',textAlign:'center'}}>
                    <I n="msg" s={28} c="var(--tx-3)"/>
                    <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:10}}>No channels yet</p>
                    <p style={{color:'var(--tx-3)',fontSize:10.5,marginTop:4}}>Create a channel to message another org</p>
                  </div>
                :orgChannels.map(ch=>{
                  const peerOrgId = ch.orgs?.find(o=>o!==orgRoom);
                  const peerName = ch.org_names?.[peerOrgId]||peerOrgId?.slice(0,20)||'Unknown Org';
                  return <div key={ch.roomId} onClick={()=>openInboxConvo(ch.roomId)}
                    style={{padding:'12px 14px',cursor:'pointer',borderBottom:'1px solid var(--border-0)',
                      background:inboxConvo===ch.roomId?'var(--bg-4)':'transparent',
                      borderLeft:inboxConvo===ch.roomId?'3px solid var(--blue)':'3px solid transparent',
                      transition:'all .15s'}}
                    onMouseEnter={e=>{if(inboxConvo!==ch.roomId)e.currentTarget.style.background='var(--bg-3)'}}
                    onMouseLeave={e=>{if(inboxConvo!==ch.roomId)e.currentTarget.style.background=inboxConvo===ch.roomId?'var(--bg-4)':'transparent'}}>
                    <div style={{display:'flex',alignItems:'center',gap:10}}>
                      <div style={{width:36,height:36,borderRadius:'50%',background:'var(--blue-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--blue)',border:'2px solid var(--blue)',flexShrink:0}}>
                        <I n="users" s={16}/>
                      </div>
                      <div style={{flex:1,minWidth:0}}>
                        <span style={{fontSize:13,fontWeight:inboxConvo===ch.roomId?700:500,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{peerName}</span>
                        <div style={{display:'flex',alignItems:'center',gap:4,marginTop:2}}>
                          <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:8}}>{orgOpacity}</span>
                          <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>org channel</span>
                        </div>
                      </div>
                    </div>
                  </div>;
                })}
              </>}
            </div>
          </div>
          {/* Active conversation */}
          <div className="inbox-chat">
            {inboxConvo ? (() => {
              const convoType = getInboxConvoType(inboxConvo);
              const convoName = getInboxConvoName(inboxConvo);
              const caseData = cases.find(c => c.bridgeRoomId === inboxConvo);
              const channelData = orgChannels.find(ch => ch.roomId === inboxConvo);
              return <>
                {/* Chat header */}
                <div className="inbox-chat-hdr">
                  <div style={{width:32,height:32,borderRadius:'50%',background:convoType==='case'?'var(--teal-dim)':'var(--blue-dim)',
                    display:'flex',alignItems:'center',justifyContent:'center',color:convoType==='case'?'var(--teal)':'var(--blue)',
                    border:`2px solid ${convoType==='case'?'var(--teal)':'var(--blue)'}`}}>
                    <I n={convoType==='case'?'user':'users'} s={14}/>
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <span style={{fontSize:14,fontWeight:700,display:'block'}}>{convoName}</span>
                    <div style={{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}}>
                      <span className="tag tag-green" style={{fontSize:8}}><I n="lock" s={8}/>E2EE</span>
                      {convoType==='case'&&caseData&&<span style={{fontSize:10,color:'var(--tx-2)'}}>{Object.keys(caseData.sharedData).length} shared fields</span>}
                      {convoType==='channel'&&<span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:8}}>OUTGOING: {orgOpacity}</span>}
                    </div>
                  </div>
                  {convoType==='case'&&<button onClick={()=>openCase(inboxConvo)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="briefcase" s={11}/>Full Case</button>}
                  {convoType==='channel'&&<button onClick={()=>openChannel(inboxConvo)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="msg" s={11}/>Full Channel</button>}
                  <button onClick={()=>loadInboxMessages(inboxConvo)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="refresh-cw" s={11}/></button>
                </div>
                {/* Messages */}
                <div className="inbox-msgs">
                  {inboxMessages.length===0?
                    <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
                      <I n="msg" s={32} c="var(--tx-3)"/>
                      <p style={{color:'var(--tx-3)',fontSize:12,marginTop:10}}>No messages yet</p>
                      <p style={{color:'var(--tx-3)',fontSize:11,marginTop:4}}>Start the conversation below</p>
                    </div>
                  :[...inboxMessages].reverse().map((msg,i)=>{
                    const isOwn = msg.sender===svc.userId;
                    const sender = convoType==='channel' ? resolveMessageSender(msg) : {label:isOwn?'You':T.client_term,isOwn};
                    return <div key={msg.id||i} style={{display:'flex',flexDirection:'column',alignItems:sender.isOwn?'flex-end':'flex-start',marginBottom:4}}>
                      <div style={{maxWidth:'75%',padding:'10px 14px',borderRadius:sender.isOwn?'14px 14px 4px 14px':'14px 14px 14px 4px',
                        background:sender.isOwn?'var(--gold-dim)':'var(--bg-3)',border:`1px solid ${sender.isOwn?'rgba(201,163,82,.2)':'var(--border-0)'}`,
                        transition:'transform .1s'}}>
                        <p style={{fontSize:12.5,color:'var(--tx-0)',lineHeight:1.5,wordBreak:'break-word'}}>{msg.content?.body}</p>
                      </div>
                      <div style={{display:'flex',alignItems:'center',gap:4,marginTop:3,padding:'0 6px'}}>
                        <span style={{fontFamily:'var(--mono)',fontSize:9,color:sender.isOwn?'var(--gold)':'var(--teal)'}}>{sender.isOwn?'You'+(sender.org?` (${sender.org})`:convoType==='case'?` (${T.provider_term})`:''):sender.label}</span>
                        <span style={{fontFamily:'var(--mono)',fontSize:8,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):''}</span>
                      </div>
                    </div>;
                  })}
                </div>
                {/* Compose */}
                <div className="inbox-compose">
                  {(convoType==='case'||hasOrgMsgPermission('respond'))?<div style={{display:'flex',gap:8}}>
                    <input value={inboxMsgText} onChange={e=>setInboxMsgText(e.target.value)}
                      placeholder={convoType==='channel'?`Message as ${orgOpacity==='transparent'?(providerProfile.display_name||'you'):orgOpacity==='translucent'?(orgMeta.name||'your org'):'anonymous org'}... (E2EE)`:'Type a message (E2EE)...'}
                      onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendInboxMsg()}}}
                      style={{flex:1,borderRadius:20,padding:'10px 18px'}}/>
                    <button onClick={handleSendInboxMsg} className="b-pri" disabled={!inboxMsgText.trim()}
                      style={{borderRadius:20,width:42,height:42,padding:0,display:'flex',alignItems:'center',justifyContent:'center'}}>
                      <I n="send" s={16}/>
                    </button>
                  </div>
                  :<div style={{padding:'10px 14px',background:'var(--gold-dim)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:8}}>
                    <I n="lock" s={13} c="var(--gold)"/>
                    <span style={{fontSize:11.5,color:'var(--gold)'}}>Your role ({orgRole}) does not have permission to respond. Contact your admin.</span>
                  </div>}
                </div>
              </>;
            })()
            : <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
              <div style={{width:64,height:64,borderRadius:'50%',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',marginBottom:16}}>
                <I n="inbox" s={28}/>
              </div>
              <h3 style={{fontSize:16,fontWeight:700,marginBottom:6}}>Provider Inbox</h3>
              <p style={{color:'var(--tx-2)',fontSize:12,maxWidth:300,textAlign:'center',lineHeight:1.6}}>
                {(cases.length+orgChannels.length)>0?'Select a conversation from the left to start chatting.':'No conversations yet. Clients must share a bridge, or create an org channel.'}
              </p>
            </div>}
          </div>
        </div>
      </div>}

      {/* CLIENTS TABLE VIEW */}
      {view==='clients'&&!activeCase&&<div className="anim-up" style={{maxWidth:960,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>{T.client_term_plural}</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Each {T.client_term.toLowerCase()} record is a private encrypted room. Invite {T.client_term_plural.toLowerCase()} to give them full control.</p>
          </div>
          <div style={{display:'flex',gap:8}}>
            <button onClick={()=>setImportModal(true)} className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="upload" s={14}/>Import Data</button>
            <button onClick={()=>{setCreateClientModal(true);setNewClientName('');setNewClientMatrixId('');setNewClientNotes('')}} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>New {T.client_term}</button>
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(140px,1fr))',gap:10,marginBottom:20}}>
          {[{l:`Total ${T.client_term_plural}`,v:clientRecords.length,c:'teal',i:'users'},
            {l:'Imported',v:clientRecords.filter(r=>r.imported).length,c:'purple',i:'upload'},
            {l:'Invited',v:clientRecords.filter(r=>r.status==='invited').length,c:'gold',i:'send'},
            {l:'Joined',v:clientRecords.filter(r=>r.status==='joined').length,c:'green',i:'check'},
            {l:'Claimed',v:clientRecords.filter(r=>r.status==='claimed').length,c:'teal',i:'shield'},
            {l:'Pending',v:clientRecords.filter(r=>r.status==='created'&&!r.imported).length,c:'orange',i:'clock'},
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {clientRecords.length===0?
          <div className="card" style={{textAlign:'center',padding:'40px 20px',borderStyle:'dashed'}}>
            <I n="users" s={32}/>
            <p style={{color:'var(--tx-2)',marginTop:10,fontSize:13}}>No {T.client_term.toLowerCase()} records yet</p>
            <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:4}}>Click "New {T.client_term}" to create a record, or "Import Data" to upload a CSV/JSON. Each {T.client_term.toLowerCase()} gets their own encrypted room.</p>
          </div>
        :<div className="card" style={{padding:0,overflow:'hidden'}}>
          {/* Table header */}
          <div style={{display:'grid',gridTemplateColumns:'2fr 1.5fr 1fr 1fr 1.2fr',gap:0,padding:'10px 16px',background:'var(--bg-3)',borderBottom:'1px solid var(--border-1)'}}>
            {['NAME','MATRIX ID','STATUS','CREATED','ACTIONS'].map(h=>
              <span key={h} style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.07em',fontWeight:600}}>{h}</span>)}
          </div>
          {/* Table rows */}
          {clientRecords.map((rec,i)=>{
            const statusColors = {created:'orange',invited:'gold',joined:'green',claimed:'teal'};
            const statusLabels = {created:'Pending',invited:'Invited',joined:'Joined',claimed:'Claimed'};
            return <div key={rec.roomId} style={{display:'grid',gridTemplateColumns:'2fr 1.5fr 1fr 1fr 1.2fr',gap:0,padding:'12px 16px',
              borderBottom:i<clientRecords.length-1?'1px solid var(--border-0)':'none',alignItems:'center',
              transition:'background .15s'}}
              onMouseEnter={e=>e.currentTarget.style.background='var(--bg-3)'}
              onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
              <div>
                <div style={{display:'flex',alignItems:'center',gap:6}}>
                  <span style={{fontSize:13,fontWeight:600}}>{rec.client_name}</span>
                  {rec.imported&&<span className="tag tag-purple" style={{fontSize:8}}><I n="lock" s={8}/>Encrypted</span>}
                </div>
                {rec.notes&&<span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:2}}>{rec.notes}</span>}
              </div>
              <span style={{fontFamily:'var(--mono)',fontSize:10.5,color:rec.client_matrix_id?'var(--tx-1)':'var(--tx-3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                {rec.client_matrix_id||'â€”'}
              </span>
              <span className={`tag tag-${statusColors[rec.status]||'orange'}`} style={{fontSize:9,justifySelf:'start'}}>
                {statusLabels[rec.status]||rec.status}
              </span>
              <span style={{fontSize:10.5,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>
                {rec.created?new Date(rec.created).toLocaleDateString():'â€”'}
              </span>
              <div style={{display:'flex',gap:4}}>
                <button onClick={()=>{setClientInviteModal(rec);setClientInviteMatrixId(rec.client_matrix_id||'');setCopiedField(null)}}
                  className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:3}}>
                  <I n="userPlus" s={11}/>Invite
                </button>
                <button onClick={()=>openCase(rec.roomId)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:3}}>
                  <I n="chevR" s={11}/>Open
                </button>
              </div>
            </div>;
          })}
        </div>}
        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="shield" s={16} c="var(--teal)"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong style={{color:'var(--teal)'}}>Client sovereignty:</strong> When a client joins their room, they receive superadmin power level (100). When they claim the room, ownership transfers to them permanently. They can kick anyone â€” including you â€” from their room at any time. You cannot remove a joined or claimed client.
          </span>
        </div>
      </div>}

      {/* CASE VIEW */}
      {view==='case'&&activeCaseData&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <button onClick={()=>{setView('dashboard');setActiveCase(null)}} className="b-gho b-sm" style={{marginBottom:14,display:'flex',alignItems:'center',gap:4}}><I n="back" s={13}/>All Cases</button>
        <div style={{marginBottom:20}}>
          <h2 style={{fontFamily:'var(--serif)',fontSize:20,fontWeight:700}}>{activeCaseData.sharedData.full_name||activeCaseData.clientUserId}</h2>
          <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4}}>
            <span className="tag tag-green"><I n="lock" s={9}/>Megolm + AES-GCM</span>
            <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)'}}>Client-owned bridge</span></div>
        </div>
        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">SHARED DATA â€” CLIENT CONTROLLED</span>
          {(()=>{
            const knownKeys = new Set(VAULT_FIELDS.map(f=>f.key));
            const customShared = Object.keys(activeCaseData.sharedData).filter(k=>!knownKeys.has(k));
            return <>
              {FIELD_CATEGORIES.map(cat=>{const fields=VAULT_FIELDS.filter(f=>f.category===cat&&activeCaseData.sharedData[f.key]);
                if(!fields.length) return null;
                return <div key={cat} style={{marginBottom:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
                    <span style={{color:`var(--${CAT_COLORS[cat]})`}}><I n={CAT_ICONS[cat]} s={12}/></span>
                    <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.05em'}}>{CAT_LABELS[cat].toUpperCase()}</span></div>
                  {fields.map(f=><div key={f.key} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border-0)'}}>
                    <span style={{fontSize:12,color:'var(--tx-1)'}}>{f.label}</span>
                    <span style={{fontSize:12.5,fontWeight:500,maxWidth:260,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{activeCaseData.sharedData[f.key]}</span>
                  </div>)}
                </div>;})}
              {customShared.length>0&&<div style={{marginBottom:10}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
                  <span style={{color:'var(--purple)'}}><I n="file" s={12}/></span>
                  <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.05em'}}>CLIENT CUSTOM FIELDS</span></div>
                {customShared.map(k=><div key={k} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border-0)'}}>
                  <span style={{fontSize:12,color:'var(--tx-1)'}}>{k.replace(/^custom_/,'').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</span>
                  <span style={{fontSize:12.5,fontWeight:500,maxWidth:260,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{activeCaseData.sharedData[k]}</span>
                </div>)}
              </div>}
            </>;
          })()}
          {Object.keys(activeCaseData.sharedData).length===0&&<p style={{color:'var(--tx-3)',fontSize:12,padding:'10px 0'}}>No fields shared yet</p>}
        </div>
        {/* GIVEN/MEANT DIVIDE â€” Record-level framework interpretations */}
        {provObservations.filter(obs => {
          const prompt = [...DEFAULT_PROMPTS,...DEFAULT_PROVIDER_PROMPTS].find(p=>p.id===obs.prompt_id||p.key===obs.prompt_key);
          return prompt && FRAMEWORK_BINDINGS[prompt.key]?.bindings?.[obs.value];
        }).length > 0 && <div style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'linear-gradient(135deg,var(--teal),var(--gold))',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-0)',fontSize:11,fontWeight:800}}>&#8594;</div>
            <span style={{fontFamily:'var(--serif)',fontSize:15,fontWeight:700}}>GIVEN / MEANT Divide</span>
            <span className="gm-sup-badge">SUP</span>
          </div>
          <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Same observations, different institutional meanings. Each framework interprets the data according to its own rules.</p>
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            {provObservations.filter(obs => {
              const prompt = [...DEFAULT_PROMPTS,...DEFAULT_PROVIDER_PROMPTS].find(p=>p.id===obs.prompt_id||p.key===obs.prompt_key);
              return prompt && FRAMEWORK_BINDINGS[prompt.key]?.bindings?.[obs.value];
            }).map((obs,i) => {
              const prompt = [...DEFAULT_PROMPTS,...DEFAULT_PROVIDER_PROMPTS].find(p=>p.id===obs.prompt_id||p.key===obs.prompt_key);
              return <RecordGivenMeant key={obs.id||i} promptKey={prompt.key} value={obs.value}
                reporter={obs.author ? `${T.provider_term}: ${obs.author}` : `${T.provider_term} observation`}
                timestamp={obs.ts}/>;
            })}
          </div>
        </div>}
        {/* PROVIDER OBSERVATIONS (MEANT frame) */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}}>
            <span className="section-label" style={{marginBottom:0}}>{T.provider_term.toUpperCase()} OBSERVATIONS (MEANT)</span>
            <span className="tag tag-gold">EPISTEMIC: MEANT</span>
          </div>
          <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Structured assessments and case management observations. Each entry is an EO event in the bridge room with full provenance.</p>
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:6,marginBottom:12}}>
            {DEFAULT_PROVIDER_PROMPTS.map(p=><div key={p.id} className="card-h" onClick={()=>{setProvObsModal(p);setProvObsValue('');setProvObsNotes('')}}
              style={{padding:10}}>
              <div style={{display:'flex',alignItems:'center',gap:4,marginBottom:4,flexWrap:'wrap'}}>
                <span className={`tag tag-${OBS_CAT_COLORS[p.category]||'purple'}`} style={{fontSize:8.5}}>{p.category}</span>
                {p.maturity && <MaturityBadge maturity={p.maturity}/>}
                {p.source && <SourceBadge source={p.source}/>}
              </div>
              <span style={{fontSize:11.5,fontWeight:600,display:'block'}}>{p.question}</span>
            </div>)}
          </div>
          {provObservations.length>0&&<>
            <span className="section-label">RECORDED ({provObservations.length})</span>
            <div style={{display:'flex',flexDirection:'column',gap:3,marginTop:4}}>
              {[...provObservations].reverse().map((obs,i)=>{
                const prompt = DEFAULT_PROVIDER_PROMPTS.find(p=>p.id===obs.prompt_id||p.key===obs.prompt_key);
                const optLabel = prompt?.options?.find(o=>o.v===obs.value)?.l || obs.value;
                return <div key={obs.id||i} style={{padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:8}}>
                  <span className={`tag tag-${OBS_CAT_COLORS[prompt?.category]||'purple'}`} style={{fontSize:8.5}}>{prompt?.category||'obs'}</span>
                  <span className="tag tag-gold" style={{fontSize:8}}>MEANT</span>
                  <span style={{fontSize:11.5,flex:1}}>{prompt?.question}: <strong>{optLabel}</strong></span>
                  {obs.notes&&<span style={{fontSize:10,color:'var(--tx-2)',fontStyle:'italic'}}>{obs.notes}</span>}
                  <span style={{fontSize:9,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{obs.ts?new Date(obs.ts).toLocaleTimeString():''}</span>
                </div>;
              })}
            </div>
          </>}
        </div>

        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">REQUEST INFORMATION</span>
          <div style={{display:'flex',gap:6}}>
            <input value={requestText} onChange={e=>setRequestText(e.target.value)} placeholder="e.g. Could you share employment docs?" onKeyDown={e=>{if(e.key==='Enter')handleSendRequest()}}/>
            <button onClick={handleSendRequest} className="b-pri" style={{whiteSpace:'nowrap'}}><I n="send" s={12}/>Request</button>
          </div>
        </div>
        <div className="card">
          <span className="section-label">BRIDGE MESSAGES</span>
          <div style={{maxHeight:260,overflow:'auto',marginBottom:12}}>
            {messages.length===0?<p style={{color:'var(--tx-3)',fontSize:12,padding:'12px 0',textAlign:'center'}}>No messages</p>
            :messages.map((msg,i)=><div key={msg.id||i} style={{padding:'8px 0',borderBottom:'1px solid var(--border-0)'}}>
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
                <span style={{fontFamily:'var(--mono)',fontSize:10,color:msg.sender===svc.userId?'var(--gold)':'var(--teal)'}}>{msg.sender===svc.userId?`You (${T.provider_term})`:T.client_term}</span>
                <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleString():''}</span></div>
              <p style={{fontSize:12.5,color:'var(--tx-1)'}}>{msg.content?.body}</p>
            </div>)}
          </div>
          <div style={{display:'flex',gap:6}}>
            <input value={msgText} onChange={e=>setMsgText(e.target.value)} placeholder="Message (E2EE)..." onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey)handleSendMsg()}} style={{flex:1}}/>
            <button onClick={handleSendMsg} className="b-pri"><I n="send" s={13}/></button>
          </div>
        </div>
      </div>}

      {/* METRICS DASHBOARD (Â§B.5) */}
      {view==='metrics'&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>Metrics Dashboard</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:20}}>Anonymized, aggregate data from consenting clients. No PII â€” names, DOBs, SSNs, and addresses are never present.</p>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(170px,1fr))',gap:10,marginBottom:20}}>
          {[{l:'Metric Events',v:metrics.length,c:'orange'},{l:'Unique Cohorts',v:new Set(metrics.map(m=>m.cohort_hash)).size,c:'blue'},
            {l:'Categories',v:Object.keys(metricsByCategory).length,c:'teal'}
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <span style={{fontSize:18,fontWeight:700,color:`var(--${s.c})`}}>{s.v}</span></div>)}
        </div>
        {Object.keys(metricsByCategory).length===0?
          <div className="card" style={{textAlign:'center',padding:'30px',borderStyle:'dashed'}}><I n="bar" s={28}/><p style={{color:'var(--tx-3)',marginTop:8}}>No metric events yet. Clients must consent to anonymized reporting.</p></div>
        :Object.entries(metricsByCategory).map(([cat,vals])=><div key={cat} className="card" style={{marginBottom:12}}>
          <span className="section-label">{cat.toUpperCase()}</span>
          <div style={{display:'flex',flexDirection:'column',gap:4,marginTop:6}}>
            {Object.entries(vals).sort((a,b)=>b[1]-a[1]).map(([val,count])=>{
              const max = Math.max(...Object.values(vals));
              return <div key={val} style={{display:'flex',alignItems:'center',gap:8}}>
                <span style={{fontSize:11.5,width:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{val}</span>
                <div style={{flex:1,height:16,background:'var(--bg-3)',borderRadius:3,overflow:'hidden'}}>
                  <div style={{width:`${(count/max)*100}%`,height:'100%',background:'var(--teal)',borderRadius:3,transition:'width .3s'}}/>
                </div>
                <span style={{fontSize:11,fontFamily:'var(--mono)',color:'var(--tx-1)',minWidth:30,textAlign:'right'}}>{count}</span>
              </div>;
            })}
          </div>
        </div>)}
        {/* DEMOGRAPHIC RANGES from imported/consented data */}
        {(()=>{
          const demoAgg = {};
          metrics.forEach(m => {
            if (!m.demographics) return;
            for (const [k,v] of Object.entries(m.demographics)) {
              if (!v) return;
              if (!demoAgg[k]) demoAgg[k] = {};
              demoAgg[k][v] = (demoAgg[k][v]||0) + 1;
            }
          });
          return Object.keys(demoAgg).length > 0 ? <div className="card" style={{marginTop:12}}>
            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
              <span className="section-label" style={{marginBottom:0}}>DEMOGRAPHIC RANGES</span>
              <span className="tag tag-green" style={{fontSize:8}}><I n="shieldCheck" s={8}/>NO PII</span>
            </div>
            <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Aggregated from anonymized transforms. Names, DOBs, SSNs, addresses, phones, and emails are cryptographically blocked â€” only bucketed ranges appear.</p>
            {Object.entries(demoAgg).map(([cat,vals])=><div key={cat} style={{marginBottom:8}}>
              <span style={{fontSize:10.5,fontWeight:600,color:'var(--tx-1)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.05em'}}>{cat}</span>
              <div style={{display:'flex',flexDirection:'column',gap:3,marginTop:4}}>
                {Object.entries(vals).sort((a,b)=>b[1]-a[1]).map(([val,count])=>{
                  const max = Math.max(...Object.values(vals));
                  return <div key={val} style={{display:'flex',alignItems:'center',gap:8}}>
                    <span style={{fontSize:11,width:140,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{val}</span>
                    <div style={{flex:1,height:14,background:'var(--bg-3)',borderRadius:3,overflow:'hidden'}}>
                      <div style={{width:`${(count/max)*100}%`,height:'100%',background:'var(--green)',borderRadius:3,transition:'width .3s'}}/>
                    </div>
                    <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-1)',minWidth:24,textAlign:'right'}}>{count}</span>
                  </div>;
                })}
              </div>
            </div>)}
          </div> : null;
        })()}

        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginTop:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--teal)'}}>K-anonymity (k=5):</strong> Combinations with fewer than 5 matching individuals are suppressed. This data is suitable for compliance reporting and aggregate analysis. PII fields (name, DOB, SSN, address, phone, email) are never present â€” only demographic ranges and hashed identifiers.
        </div>
      </div>}

      {/* SCHEMA WORKBENCH */}
      {view==='schema'&&<SchemaWorkbench isOrg={false}/>}

      {/* ORG SETTINGS VIEW (admin only) */}
      {view==='org-settings'&&orgRoom&&orgRole==='admin'&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>Organization Settings</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:24}}>Manage your organization metadata, privacy, and inter-org messaging configuration.</p>
        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">ORGANIZATION DETAILS</span>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginTop:8}}>
            {[{l:'Name',v:orgMeta.name||'â€”'},{l:'Type',v:ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type||'â€”'},
              {l:'Service Area',v:orgMeta.service_area||'â€”'},{l:'Languages',v:(orgMeta.languages||[]).join(', ')||'â€”'},
              {l:'Staff',v:`${staff.length} members`},{l:'Room',v:orgRoom?.slice(0,24)+'â€¦'}
            ].map((s,i)=><div key={i}><span className="section-label">{s.l.toUpperCase()}</span>
              <span style={{fontSize:13,fontWeight:500,display:'block'}}>{s.v}</span></div>)}
          </div>
        </div>

        {/* TERMINOLOGY CUSTOMIZATION */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <I n="settings" s={16} c="var(--gold)"/>
              <span className="section-label" style={{marginBottom:0}}>TERMINOLOGY</span>
              {(T.client_term!=='Client'||T.provider_term!=='Provider')&&<span className="tag tag-gold" style={{fontSize:8}}>CUSTOMIZED</span>}
            </div>
            <button onClick={()=>{setTerminologyDraft({...orgTerminology});setTerminologyModal(true)}} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="settings" s={11}/>Customize</button>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:14,lineHeight:1.6}}>
            Customize what your organization calls its service recipients and service providers. These terms appear throughout the interface for all staff in your organization.
          </p>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
            <div style={{padding:'12px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>SERVICE RECIPIENT</span>
              <span style={{fontSize:15,fontWeight:700,display:'block'}}>{T.client_term}</span>
              <span style={{fontSize:11,color:'var(--tx-2)'}}>Plural: {T.client_term_plural}</span>
            </div>
            <div style={{padding:'12px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>SERVICE PROVIDER</span>
              <span style={{fontSize:15,fontWeight:700,display:'block'}}>{T.provider_term}</span>
              <span style={{fontSize:11,color:'var(--tx-2)'}}>Plural: {T.provider_term_plural}</span>
            </div>
          </div>
          {(T.client_term!=='Client'||T.provider_term!=='Provider')&&<div style={{marginTop:10,padding:'8px 12px',background:'var(--gold-dim)',borderRadius:'var(--r)',fontSize:11,color:'var(--gold)',display:'flex',alignItems:'center',gap:6}}>
            <I n="alert" s={12} c="var(--gold)"/>
            Custom terminology active â€” staff will see "{T.client_term}" and "{T.provider_term}" instead of the defaults.
          </div>}
        </div>

        {/* OPACITY SETTINGS */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
            <I n="eyeOff" s={16} c="var(--purple)"/>
            <span className="section-label" style={{marginBottom:0}}>ORGANIZATION OPACITY</span>
            <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:9}}>{OPACITY_LABELS[orgOpacity]?.toUpperCase()}</span>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:14,lineHeight:1.6}}>
            Controls how much of your organization's identity is revealed when communicating with other organizations. This affects all outgoing inter-org messages.
          </p>
          <div style={{display:'flex',flexDirection:'column',gap:8}}>
            {OPACITY_LEVELS.map(level => <div key={level} onClick={()=>handleSaveOpacity(level)}
              style={{padding:'14px 16px',borderRadius:'var(--r-lg)',cursor:'pointer',
                border:`2px solid ${orgOpacity===level?'var(--gold)':'var(--border-1)'}`,
                background:orgOpacity===level?'var(--gold-dim)':'var(--bg-3)',transition:'all .18s'}}
              onMouseEnter={e=>{if(orgOpacity!==level)e.currentTarget.style.borderColor='var(--border-2)'}}
              onMouseLeave={e=>{if(orgOpacity!==level)e.currentTarget.style.borderColor='var(--border-1)'}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
                <span style={{width:10,height:10,borderRadius:'50%',border:`2px solid ${orgOpacity===level?'var(--gold)':'var(--tx-3)'}`,
                  background:orgOpacity===level?'var(--gold)':'transparent',flexShrink:0}}/>
                <span style={{fontSize:14,fontWeight:700,color:orgOpacity===level?'var(--gold)':'var(--tx-0)'}}>{OPACITY_LABELS[level]}</span>
                {level==='opaque'&&<span className="tag tag-red" style={{fontSize:8}}>MAX PRIVACY</span>}
                {level==='translucent'&&<span className="tag tag-gold" style={{fontSize:8}}>RECOMMENDED</span>}
                {level==='transparent'&&<span className="tag tag-green" style={{fontSize:8}}>OPEN</span>}
              </div>
              <p style={{fontSize:11.5,color:'var(--tx-2)',lineHeight:1.5,marginLeft:18}}>{OPACITY_DESCRIPTIONS[level]}</p>
              {/* Preview of what external org sees */}
              <div style={{marginTop:8,marginLeft:18,padding:'8px 12px',background:'var(--bg-1)',borderRadius:'var(--r)',border:'1px solid var(--border-0)'}}>
                <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:4}}>EXTERNAL ORG SEES:</span>
                <span style={{fontSize:11,color:'var(--tx-1)'}}>
                  {level==='transparent'?`"${providerProfile.display_name||'Jamie R.'} from ${orgMeta.name||'Your Org'}"`
                  :level==='translucent'?`"${orgMeta.name||'Your Org'}"`
                  :'"An organization"'}
                </span>
              </div>
            </div>)}
          </div>
        </div>

        {/* MESSAGE ACCESS CONTROLS */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <I n="lock" s={16} c="var(--blue)"/>
              <span className="section-label" style={{marginBottom:0}}>INTER-ORG MESSAGE ACCESS</span>
            </div>
            <button onClick={()=>{setMsgAccessDraft({...orgMsgAccess});setMsgAccessModal(true)}} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="settings" s={11}/>Configure</button>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:12,lineHeight:1.6}}>
            Control which staff roles can read and respond to messages sent to your organization from other organizations.
          </p>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
            <div style={{padding:'10px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>CAN READ</span>
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                {orgMsgAccess.read?.map(r=><span key={r} className="tag tag-blue" style={{fontSize:9}}>{ORG_ROLE_LABELS[r]||r}</span>)}
                {(!orgMsgAccess.read||orgMsgAccess.read.length===0)&&<span style={{fontSize:10,color:'var(--tx-3)',fontStyle:'italic'}}>No roles assigned</span>}
              </div>
            </div>
            <div style={{padding:'10px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>CAN RESPOND</span>
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                {orgMsgAccess.respond?.map(r=><span key={r} className="tag tag-gold" style={{fontSize:9}}>{ORG_ROLE_LABELS[r]||r}</span>)}
                {(!orgMsgAccess.respond||orgMsgAccess.respond.length===0)&&<span style={{fontSize:10,color:'var(--tx-3)',fontStyle:'italic'}}>No roles assigned</span>}
              </div>
            </div>
          </div>
        </div>

        {/* ORG MESSAGING CHANNELS */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <I n="msg" s={16} c="var(--teal)"/>
              <span className="section-label" style={{marginBottom:0}}>MESSAGING CHANNELS ({orgChannels.length})</span>
            </div>
            <button onClick={()=>setComposeOrgModal(true)} className="b-pri b-sm" style={{display:'flex',alignItems:'center',gap:4}}><I n="plus" s={12}/>New Channel</button>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:10,lineHeight:1.6}}>
            Secure encrypted channels for org-to-org communication. Messages are governed by your opacity setting.
          </p>
          {orgChannels.length===0?<div style={{textAlign:'center',padding:'20px 0'}}>
            <I n="msg" s={24}/>
            <p style={{color:'var(--tx-3)',fontSize:11,marginTop:6}}>No messaging channels yet. Create one to start communicating with another organization.</p>
          </div>
          :<div style={{display:'flex',flexDirection:'column',gap:4}}>
            {orgChannels.map(ch=>{
              const peerOrgId = ch.orgs?.find(o=>o!==orgRoom);
              const peerName = ch.org_names?.[peerOrgId]||peerOrgId?.slice(0,20)||'Unknown Org';
              return <div key={ch.roomId} onClick={()=>openChannel(ch.roomId)}
                className="card-h" style={{padding:'10px 14px'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <div style={{width:28,height:28,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)'}}><I n="msg" s={14}/></div>
                    <div>
                      <span style={{fontSize:12.5,fontWeight:600,display:'block'}}>{peerName}</span>
                      <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{ch.roomId?.slice(0,20)}â€¦</span>
                    </div>
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:6}}>
                    <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:8}}>{OPACITY_LABELS[orgOpacity]}</span>
                    <I n="chevR" s={13} c="var(--tx-3)"/>
                  </div>
                </div>
              </div>;
            })}
          </div>}
        </div>

        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">ORG ROOM ID</span>
          <div style={{fontFamily:'var(--mono)',fontSize:11,color:'var(--tx-1)',background:'var(--bg-3)',padding:'8px 12px',borderRadius:'var(--r)',wordBreak:'break-all',marginTop:4}}>{orgRoom}</div>
          <p style={{fontSize:11,color:'var(--tx-2)',marginTop:8}}>Share this room ID with providers who want to join your organization, or with other orgs to open a messaging channel.</p>
        </div>

        {/* EMAIL VERIFICATION CONFIGURATION */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <I n="shieldCheck" s={16} c={emailVerifyConfig.enabled ? 'var(--green)' : 'var(--tx-3)'}/>
              <span className="section-label" style={{margin:0}}>EMAIL VERIFICATION</span>
              <span className={`tag ${emailVerifyConfig.enabled ? 'tag-green' : 'tag-gold'}`} style={{fontSize:8}}>
                {emailVerifyConfig.enabled ? 'ENABLED' : 'DISABLED'}
              </span>
            </div>
            <button onClick={()=>{setEmailConfigDraft({...emailVerifyConfig});setEmailConfigModal(true)}} className="b-gho b-xs">
              <I n="settings" s={11}/> Configure
            </button>
          </div>
          {emailVerifyConfig.enabled ? <div>
            <p style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6,marginBottom:8}}>
              Staff members must verify their identity via email before accessing cases. Verification confirms they control an email address at an approved domain.
            </p>
            {emailVerifyConfig.required_domains?.length > 0 && <div style={{marginBottom:8}}>
              <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginBottom:4}}>APPROVED DOMAINS</span>
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                {emailVerifyConfig.required_domains.map((d,i)=><span key={i} className="tag tag-blue" style={{fontSize:9}}>@{d}</span>)}
              </div>
            </div>}
            <div style={{marginBottom:8}}>
              <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginBottom:4}}>REQUIRED FOR ROLES</span>
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                {emailVerifyConfig.require_for_roles?.map((r,i)=><span key={i} className="tag tag-gold" style={{fontSize:9}}>{ORG_ROLE_LABELS[r]||r}</span>)}
              </div>
            </div>
            <div style={{fontSize:10,color:'var(--tx-3)'}}>
              Grace period: {emailVerifyConfig.grace_period_hours}h Â· {staff.filter(s=>s.email_verification?.status==='verified').length}/{staff.length} verified
            </div>
          </div> : <p style={{fontSize:11.5,color:'var(--tx-2)',lineHeight:1.6}}>
            Email verification is disabled. Enable it to require staff members to confirm their identity with an organization email address before accessing cases.
          </p>}
        </div>
      </div>}

      {/* STAFF ROSTER VIEW */}
      {view==='staff'&&orgRoom&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Staff Roster</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Manage staff membership and roles. Each role determines case access level.</p></div>
          {orgRole==='admin'&&<button onClick={()=>setInviteModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>Invite Staff</button>}
        </div>
        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">ROLE DEFINITIONS</span>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginTop:6}}>
            {ORG_ROLES.map(r=><div key={r} style={{padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span className="tag tag-blue" style={{fontSize:9,marginBottom:4}}>{ORG_ROLE_LABELS[r]}</span>
              <p style={{fontSize:10.5,color:'var(--tx-2)',marginTop:2}}>
                {r==='admin'?'Full access. Manage staff, see all cases, configure schema.':
                 r==='case_manager'?'Assigned cases only. Full read/write on assigned bridges.':
                 r==='field_worker'?'Assigned cases. Record encounters. Limited to own observations.':
                 r==='intake_coordinator'?'Create new bridges. Run intake assessments. Route to case managers.':
                 'View aggregate dashboards only. No PII access.'}
              </p>
            </div>)}
          </div>
        </div>
        <div className="card">
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <span className="section-label">CURRENT STAFF ({staff.length})</span>
            {emailVerifyConfig.enabled && <span style={{fontSize:10,color:'var(--tx-3)'}}>
              {staff.filter(s=>s.email_verification?.status==='verified').length} of {staff.length} verified
            </span>}
          </div>
          <div style={{display:'flex',flexDirection:'column',gap:4,marginTop:6}}>
            {staff.map(s=>{
              const ev = s.email_verification;
              const needsVerify = emailVerifyConfig.enabled && EmailVerification.needsVerification(emailVerifyConfig, s);
              const isMe = s.userId === svc.userId;
              return <div key={s.userId} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'10px 0',borderBottom:'1px solid var(--border-0)'}}>
              <div>
                <div style={{display:'flex',alignItems:'center',gap:6}}>
                  <span style={{fontSize:13,fontWeight:500}}>{s.userId}</span>
                  {ev?.status==='verified' && <span className="tag tag-green" style={{fontSize:8}}>VERIFIED</span>}
                  {needsVerify && !ev && <span className="tag tag-gold" style={{fontSize:8}}>UNVERIFIED</span>}
                  {ev?.status==='pending' && <span className="tag tag-gold" style={{fontSize:8}}>PENDING</span>}
                  {ev?.status==='revoked' && <span className="tag tag-red" style={{fontSize:8}}>REVOKED</span>}
                </div>
                <span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>
                  Joined {s.joined?new Date(s.joined).toLocaleDateString():'â€”'}
                  {ev?.status==='verified' && ev.email && <> Â· {ev.email}</>}
                </span>
              </div>
              <div style={{display:'flex',gap:6,alignItems:'center'}}>
                <span className={`tag ${s.role==='admin'?'tag-gold':'tag-blue'}`} style={{fontSize:9}}>{ORG_ROLE_LABELS[s.role]}</span>
                {isMe && needsVerify && ev?.status!=='verified' && <button onClick={openEmailVerifyModal} className="b-pri b-xs" style={{fontSize:10}}>Verify Email</button>}
                {orgRole==='admin' && ev?.status==='verified' && s.userId!==svc.userId && <button onClick={()=>handleRevokeVerification(s.userId)} className="b-gho b-xs" title="Revoke verification"><I n="x" s={10}/></button>}
                {orgRole==='admin'&&s.userId!==svc.userId&&<button onClick={()=>handleRemoveStaff(s.userId)} className="b-gho b-xs" style={{color:'var(--red)'}}><I n="trash" s={11}/></button>}
              </div>
            </div>})}
          </div>
        </div>
        {/* Verification prompt for current user */}
        {emailVerifyConfig.enabled && myVerification?.status!=='verified' && EmailVerification.needsVerification(emailVerifyConfig, {role:orgRole, email_verification:myVerification}) && <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
            <I n="alert" s={16} c="var(--gold)"/>
            <span style={{fontSize:13,fontWeight:700,color:'var(--gold)'}}>Email Verification Required</span>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6,marginBottom:10}}>
            Your organization requires email verification for your role ({ORG_ROLE_LABELS[orgRole]}). Verify your identity with an approved email address{emailVerifyConfig.required_domains?.length > 0 ? ` (${emailVerifyConfig.required_domains.map(d=>'@'+d).join(', ')})` : ''}.
          </p>
          <button onClick={openEmailVerifyModal} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}>
            <I n="shieldCheck" s={14}/> Verify My Email
          </button>
        </div>}
      </div>}

      {/* NETWORK VIEW (Addendum E) â€” org-to-org relationships */}
      {view==='network'&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>Network</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:20}}>Networks are org-to-org relationships. Organizations join voluntarily; the network defines shared vocabulary that propagates.</p>

        {!orgRoom?<div>
          <div className="card" style={{textAlign:'center',padding:'30px',borderStyle:'dashed'}}>
            <I n="users" s={32}/><p style={{color:'var(--tx-2)',marginTop:8,marginBottom:8}}>Create or join an organization to participate in networks</p>
            <p style={{fontSize:11,color:'var(--tx-3)'}}>Networks are org-to-org relationships. An independent provider who wants to join a network first needs to create an organization.</p>
          </div>
        </div>
        :!networkRoom?<div>
          <div className="card" style={{textAlign:'center',padding:'30px',borderStyle:'dashed',marginBottom:16}}>
            <I n="globe" s={32}/><p style={{color:'var(--tx-2)',marginTop:8}}>Not part of a network yet</p>
            <p style={{fontSize:11,color:'var(--tx-3)',marginTop:4}}>Your org "{orgMeta.name}" can create or join a network.</p>
          </div>
          <div style={{display:'flex',gap:10}}>
            <button onClick={()=>setNetworkModal(true)} className="b-pri" style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
              <I n="plus" s={14}/>Create Network</button>
            <button onClick={()=>setJoinNetworkModal(true)} className="b-gho" style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
              <I n="globe" s={14}/>Join Network</button>
          </div>
        </div>
        :<div>
          <div className="card" style={{marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <span className="tag tag-green"><I n="globe" s={10}/>NETWORK</span>
                <span style={{fontSize:15,fontWeight:700}}>Connected</span>
                <span className={`tag ${networkRole==='admin'?'tag-gold':'tag-blue'}`} style={{fontSize:9}}>{networkRole==='admin'?'ADMIN':'MEMBER'}</span>
              </div>
              <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)'}}>{networkRoom.slice(0,24)}â€¦</span>
            </div>

            {/* Network Admin controls */}
            {networkRole==='admin'&&<div style={{marginBottom:16}}>
              <span className="section-label">NETWORK ADMINISTRATION</span>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginTop:6}}>
                <div style={{padding:'10px 14px',background:'var(--gold-dim)',borderRadius:'var(--r)',border:'1px solid var(--gold-mid)'}}>
                  <span style={{fontSize:11,fontWeight:600,color:'var(--gold)',display:'block',marginBottom:2}}>Invite Organization</span>
                  <span style={{fontSize:10,color:'var(--tx-2)'}}>Invite orgs by room ID or token</span>
                </div>
                <div style={{padding:'10px 14px',background:'var(--purple-dim)',borderRadius:'var(--r)',border:'1px solid rgba(167,139,250,.15)'}}>
                  <span style={{fontSize:11,fontWeight:600,color:'var(--purple)',display:'block',marginBottom:2}}>Schema Proposals</span>
                  <span style={{fontSize:10,color:'var(--tx-2)'}}>Review pending schema changes</span>
                </div>
                <div style={{padding:'10px 14px',background:'var(--blue-dim)',borderRadius:'var(--r)',border:'1px solid rgba(91,156,245,.15)'}}>
                  <span style={{fontSize:11,fontWeight:600,color:'var(--blue)',display:'block',marginBottom:2}}>Authority Catalog</span>
                  <span style={{fontSize:10,color:'var(--tx-2)'}}>Shared external authorities</span>
                </div>
                <div style={{padding:'10px 14px',background:'var(--teal-dim)',borderRadius:'var(--r)',border:'1px solid rgba(62,201,176,.15)'}}>
                  <span style={{fontSize:11,fontWeight:600,color:'var(--teal)',display:'block',marginBottom:2}}>Metrics Aggregation</span>
                  <span style={{fontSize:10,color:'var(--tx-2)'}}>Configure cross-org aggregation</span>
                </div>
              </div>
            </div>}

            <span className="section-label">MEMBER ORGANIZATIONS ({networkMembers.length})</span>
            <div style={{display:'flex',flexDirection:'column',gap:4}}>
              {networkMembers.map((m,i)=><div key={i} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid var(--border-0)'}}>
                <div>
                  <span style={{fontSize:12,fontWeight:500}}>{m.name||m.id}</span>
                  {m.name&&<span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)',display:'block'}}>{m.id}</span>}
                </div>
                <div style={{display:'flex',gap:6,alignItems:'center'}}>
                  <span className={`tag ${m.role==='admin'?'tag-gold':'tag-blue'}`} style={{fontSize:9}}>{m.role}</span>
                  {networkRole==='admin'&&m.role!=='admin'&&<button className="b-gho b-xs" style={{color:'var(--red)'}}><I n="trash" s={10}/></button>}
                </div>
              </div>)}
            </div>
          </div>

          {/* Schema Commons â€” Network schema catalog with maturity & propagation (MVP Â§Screen 5A) */}
          <div className="card" style={{marginBottom:16}}>
            <span className="section-label">SCHEMA COMMONS</span>
            <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>All fields in the network schema. Definitions propagate to member organizations.</p>
            <div style={{display:'flex',flexDirection:'column',gap:4}}>
              {DEFAULT_PROMPTS.map(p=><div key={p.key} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
                <div style={{display:'flex',alignItems:'center',gap:8,flex:1,minWidth:0}}>
                  <span style={{fontSize:12,fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.question}</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}>
                  <MaturityBadge maturity={p.maturity || 'normative'}/>
                  <SourceBadge source={p.source || {level:'network',propagation:'standard'}}/>
                </div>
              </div>)}
              {DEFAULT_DEFINITIONS.map(d=><div key={d.key} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
                <div style={{display:'flex',alignItems:'center',gap:8,flex:1,minWidth:0}}>
                  <span style={{fontSize:12,fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{d.name}</span>
                  <span className="tag tag-purple" style={{fontSize:8}}>DEFINITION</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}>
                  <MaturityBadge maturity={d.maturity || 'normative'}/>
                  <SourceBadge source={d.source || {level:'network',propagation:'required'}}/>
                </div>
              </div>)}
            </div>
          </div>

          {/* Adoption metrics (MVP Â§Screen 4B â€” ambient monitoring) */}
          <AdoptionMetrics adopted={DEFAULT_PROMPTS.length + DEFAULT_DEFINITIONS.length}
            total={DEFAULT_PROMPTS.length + DEFAULT_DEFINITIONS.length + 2}
            extensions={1} divergences={0}/>

          {/* Propagation model reference */}
          <div className="card" style={{marginBottom:16,marginTop:16}}>
            <span className="section-label">PROPAGATION MODEL (CON SEMANTICS)</span>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginTop:6}}>
              {Object.values(PROPAGATION_LEVELS).map(p=><div key={p.id} style={{padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
                <span className={`tag tag-${p.color}`} style={{marginBottom:4,fontSize:9}}>{p.label.toUpperCase()}</span>
                <p style={{fontSize:11,color:'var(--tx-2)',marginTop:2}}>{p.desc}</p>
              </div>)}
            </div>
          </div>

          {/* Active Proposals (MVP Â§Screen 5B) */}
          <div className="card" style={{marginBottom:16}}>
            <span className="section-label">ACTIVE PROPOSALS</span>
            <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Consent-based governance. Required/standard proposals trigger a consent round; recommended/optional use lazy consensus.</p>
            {/* Example proposal â€” in production these come from GOV_PROPOSAL events in the network room */}
            <ProposalCard proposal={{
              proposal_id: 'prop_example_001',
              type: 'add_field',
              summary: 'Add "safe parking program" as a network-standard option for sleep location',
              detail: 'Multiple orgs already track this locally. Formalizing ensures consistent reporting across the network.',
              proposed_by: '@steward:khora.io',
              proposed_at: Date.now() - 86400000 * 3,
              target_propagation: 'standard',
              target_maturity: 'trial',
              governance_rhythm: 'monthly_review',
              deadline: Date.now() + 86400000 * 4,
              status: 'consent_round',
              positions: {
                '!org_a:khora.io': { position: 'adopt_as_is', at: Date.now() - 86400000 * 2 },
                '!org_b:khora.io': { position: 'adopt_with_extension', at: Date.now() - 86400000, note: 'Will add "safe lot" sub-type' },
                '!org_c:khora.io': null,
                '!org_d:khora.io': null,
              }
            }}/>
            <div style={{textAlign:'center',padding:'12px',fontSize:11,color:'var(--tx-3)'}}>
              Active proposals from the network room will appear here. Proposals use consent-based governance â€” not majority voting.
            </div>
          </div>

          {/* Governance Calendar (MVP Â§Screen 5C) */}
          <div style={{marginBottom:16}}>
            <GovernanceCalendar/>
          </div>

          {/* De facto detection placeholder (MVP Â§Screen 5A) */}
          <div style={{marginBottom:16}}>
            <DeFactoAlert fieldName="safe parking" orgCount={4} totalOrgs={5}
              onFormalize={()=>showToast('Proposal creation flow coming in Phase 3','info')}
              onDismiss={()=>showToast('Dismissed','info')}/>
          </div>

          {/* Member-specific actions */}
          {networkRole!=='admin'&&<div style={{display:'flex',gap:8}}>
            <button className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={13}/>Propose Schema Change</button>
            <button className="b-red b-sm" style={{marginLeft:'auto'}}>Leave Network</button>
          </div>}

          <div style={{background:'var(--green-dim)',border:'1px solid rgba(61,214,140,.15)',borderRadius:'var(--r)',padding:'12px 16px',fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6,marginTop:16}}>
            <strong style={{color:'var(--green)'}}>Polycentric governance:</strong> Shared prompts propagate Network â†’ Org â†’ Provider â†’ Client. Observations vary locally; interpretations feeding into shared metrics use network-level definitions for consistency.
          </div>
        </div>}
      </div>}

      {/* ORG INBOX â€” Inter-org messaging view */}
      {view==='org-inbox'&&orgRoom&&<div className="anim-up" style={{maxWidth:860,margin:'0 auto'}}>
        {!activeChannel ? <>
          {/* Channel list */}
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
            <div>
              <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Organization Inbox</h2>
              <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>
                Encrypted org-to-org messaging. Your opacity is set to <strong style={{color:orgOpacity==='opaque'?'var(--red)':orgOpacity==='translucent'?'var(--gold)':'var(--green)'}}>{OPACITY_LABELS[orgOpacity]}</strong>.
                {orgRole==='admin'&&<span style={{color:'var(--tx-3)'}}> â€” change in Org Settings</span>}
              </p>
            </div>
            <button onClick={()=>setComposeOrgModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>New Channel</button>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(160px,1fr))',gap:10,marginBottom:20}}>
            {[{l:'Channels',v:orgChannels.length,c:'teal',i:'msg'},
              {l:'Opacity',v:OPACITY_LABELS[orgOpacity],c:orgOpacity==='opaque'?'red':orgOpacity==='translucent'?'gold':'green',i:'eyeOff'},
              {l:'Your Role',v:ORG_ROLE_LABELS[orgRole]||orgRole,c:'blue',i:'user'},
            ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
                <span style={{fontSize:16,fontWeight:700}}>{s.v}</span>
                <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
          </div>
          {orgChannels.length===0?
            <div className="card" style={{textAlign:'center',padding:'40px 20px',borderStyle:'dashed'}}>
              <I n="msg" s={32}/>
              <p style={{color:'var(--tx-2)',marginTop:10,fontSize:13}}>No messaging channels</p>
              <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:4}}>Create a channel to start communicating with another organization.</p>
              <button onClick={()=>setComposeOrgModal(true)} className="b-pri" style={{marginTop:14}}><I n="plus" s={14}/>New Channel</button>
            </div>
          :<div className="card" style={{padding:0,overflow:'hidden'}}>
            <div style={{padding:'10px 16px',background:'var(--bg-3)',borderBottom:'1px solid var(--border-1)',display:'grid',gridTemplateColumns:'2fr 1fr 1fr',gap:0}}>
              {['ORGANIZATION','OPACITY','ACTIONS'].map(h=>
                <span key={h} style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.07em',fontWeight:600}}>{h}</span>)}
            </div>
            {orgChannels.map((ch,i)=>{
              const peerOrgId = ch.orgs?.find(o=>o!==orgRoom);
              const peerName = ch.org_names?.[peerOrgId]||peerOrgId?.slice(0,20)||'Unknown Org';
              return <div key={ch.roomId} style={{display:'grid',gridTemplateColumns:'2fr 1fr 1fr',gap:0,padding:'12px 16px',
                borderBottom:i<orgChannels.length-1?'1px solid var(--border-0)':'none',alignItems:'center',transition:'background .15s'}}
                onMouseEnter={e=>e.currentTarget.style.background='var(--bg-3)'}
                onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <div style={{width:28,height:28,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)'}}><I n="msg" s={14}/></div>
                  <div>
                    <span style={{fontSize:13,fontWeight:600,display:'block'}}>{peerName}</span>
                    <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{ch.roomId?.slice(0,20)}â€¦</span>
                  </div>
                </div>
                <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:9,justifySelf:'start'}}>{OPACITY_LABELS[orgOpacity]}</span>
                <button onClick={()=>openChannel(ch.roomId)} className="b-gho b-sm" style={{justifySelf:'start',display:'flex',alignItems:'center',gap:4}}>
                  <I n="msg" s={12}/>Open
                </button>
              </div>;
            })}
          </div>}
          <div style={{background:'var(--purple-dim)',border:'1px solid rgba(167,139,250,.15)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
            <I n="eyeOff" s={16} c="var(--purple)"/>
            <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
              <strong style={{color:'var(--purple)'}}>Opacity governs outgoing messages.</strong> When your org responds, the receiving org will see your identity according to your opacity setting ({OPACITY_LABELS[orgOpacity]}). Incoming messages are displayed according to the <em>sending</em> org's opacity setting â€” you cannot force another org to reveal more than they choose to.
            </span>
          </div>
        </>
        : <>
          {/* Active channel â€” message thread */}
          <button onClick={()=>{setActiveChannel(null);setChannelMessages([])}} className="b-gho b-sm" style={{marginBottom:14,display:'flex',alignItems:'center',gap:4}}><I n="back" s={13}/>All Channels</button>
          {(() => {
            const ch = orgChannels.find(c=>c.roomId===activeChannel);
            const peerOrgId = ch?.orgs?.find(o=>o!==orgRoom);
            const peerName = ch?.org_names?.[peerOrgId]||peerOrgId?.slice(0,20)||'Unknown Org';
            return <>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:20}}>
                <div>
                  <h2 style={{fontFamily:'var(--serif)',fontSize:20,fontWeight:700}}>{peerName}</h2>
                  <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4}}>
                    <span className="tag tag-teal"><I n="lock" s={9}/>E2EE</span>
                    <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:9}}>OUTGOING: {OPACITY_LABELS[orgOpacity]?.toUpperCase()}</span>
                    <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)'}}>org-to-org channel</span>
                  </div>
                </div>
                <button onClick={()=>loadChannelMessages(activeChannel)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="refresh-cw" s={11}/>Refresh</button>
              </div>
              <div className="card" style={{marginBottom:16}}>
                <span className="section-label">MESSAGES</span>
                <div style={{maxHeight:400,overflow:'auto',marginBottom:12}}>
                  {channelMessages.length===0?
                    <p style={{color:'var(--tx-3)',fontSize:12,padding:'20px 0',textAlign:'center'}}>No messages yet. Start the conversation.</p>
                  :channelMessages.map((msg,i)=>{
                    const sender = resolveMessageSender(msg);
                    return <div key={msg.id||i} style={{padding:'10px 0',borderBottom:'1px solid var(--border-0)'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
                        <div style={{display:'flex',alignItems:'center',gap:6}}>
                          <span style={{fontFamily:'var(--mono)',fontSize:10.5,fontWeight:600,
                            color:sender.isOwn?'var(--gold)':'var(--teal)'}}>
                            {sender.isOwn?'You'+(sender.org?` (${sender.org})`:''):sender.label}
                          </span>
                          {msg.content?.[`${NS}.envelope`]&&<span className={`tag ${
                            msg.content[`${NS}.envelope`].opacity==='opaque'?'tag-red':
                            msg.content[`${NS}.envelope`].opacity==='translucent'?'tag-gold':'tag-green'
                          }`} style={{fontSize:7.5}}>
                            {msg.content[`${NS}.envelope`].opacity?.toUpperCase()}
                          </span>}
                        </div>
                        <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleString():''}</span>
                      </div>
                      <p style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.5}}>{msg.content?.body}</p>
                    </div>;
                  })}
                </div>
                {hasOrgMsgPermission('respond')?<div style={{display:'flex',gap:6}}>
                  <input value={orgMsgText} onChange={e=>setOrgMsgText(e.target.value)}
                    placeholder={`Message as ${orgOpacity==='transparent'?(providerProfile.display_name||'you'):orgOpacity==='translucent'?(orgMeta.name||'your org'):'anonymous org'}... (E2EE)`}
                    onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey)handleSendOrgMsg()}} style={{flex:1}}/>
                  <button onClick={handleSendOrgMsg} className="b-pri" style={{display:'flex',alignItems:'center',gap:4}}><I n="send" s={13}/>Send</button>
                </div>
                :<div style={{padding:'10px 14px',background:'var(--gold-dim)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:8}}>
                  <I n="lock" s={13} c="var(--gold)"/>
                  <span style={{fontSize:11.5,color:'var(--gold)'}}>Your role ({ORG_ROLE_LABELS[orgRole]||orgRole}) does not have permission to respond to org messages. Contact your admin.</span>
                </div>}
              </div>
            </>;
          })()}
        </>}
      </div>}

      {/* ACTIVITY */}
      {view==='activity'&&<ActivityStream session={session}/>}
    </div>

    {/* DISCOVER CLIENT MODAL */}
    <Modal open={discoverModal} onClose={()=>setDiscoverModal(false)} title="Find Client">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Look up a client by their Matrix ID. If they've created a bridge room and invited you, it will appear in your cases.</p>
      <div style={{marginBottom:14}}><span className="section-label">CLIENT MATRIX ID</span>
        <input value={discoverUserId} onChange={e=>setDiscoverUserId(e.target.value)} placeholder="@client:matrix.org"/></div>
      <button onClick={handleDiscoverClient} className="b-pri" style={{width:'100%'}}>Search for Bridge</button>
    </Modal>

    {/* CREATE ORGANIZATION MODAL */}
    <Modal open={createOrgModal} onClose={()=>setCreateOrgModal(false)} title="Create Organization" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Create an organization to manage staff, cases across your team, and participate in networks. You'll be the admin.</p>
      <div style={{marginBottom:14}}>
        <span className="section-label">ORGANIZATION NAME</span>
        <input value={setupData.name} onChange={e=>setSetupData({...setupData,name:e.target.value})} placeholder="e.g. Metro Services Organization"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">ORGANIZATION TYPE</span>
        <select value={setupData.type} onChange={e=>setSetupData({...setupData,type:e.target.value})}>
          {ORG_TYPES.map(t=><option key={t} value={t}>{ORG_TYPE_LABELS[t]}</option>)}
        </select>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">SERVICE AREA</span>
        <input value={setupData.service_area} onChange={e=>setSetupData({...setupData,service_area:e.target.value})} placeholder="e.g. Davidson County, TN"/>
      </div>
      <div style={{marginBottom:20}}>
        <span className="section-label">LANGUAGES (comma-separated)</span>
        <input value={setupData.languages} onChange={e=>setSetupData({...setupData,languages:e.target.value})} placeholder="en, es"/>
      </div>
      <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        This creates an encrypted Matrix room for your organization. You'll be the admin. Staff can be invited with specific roles. Your provider account gains org context â€” you can manage staff, cases, and networks from your dashboard.
      </div>
      <button onClick={handleCreateOrg} className="b-pri" disabled={!setupData.name.trim()} style={{width:'100%',padding:12,fontSize:14}}>
        <I n="users" s={16}/> Create Organization
      </button>
    </Modal>

    {/* JOIN ORGANIZATION MODAL */}
    <Modal open={joinOrgModal} onClose={()=>setJoinOrgModal(false)} title="Join Organization">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Enter the Matrix room ID of an existing Khora organization to join it. The org admin must have invited you.</p>
      <div style={{marginBottom:14}}><span className="section-label">ORGANIZATION ROOM ID</span>
        <input value={joinOrgId} onChange={e=>setJoinOrgId(e.target.value)} placeholder="!roomid:matrix.org"/></div>
      <button onClick={handleJoinOrg} className="b-pri" style={{width:'100%'}}>Join Organization</button>
    </Modal>

    {/* INVITE STAFF MODAL */}
    <Modal open={inviteModal} onClose={()=>setInviteModal(false)} title="Invite Staff Member">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Invite a provider to your organization. They'll receive access to cases based on their assigned role.</p>
      <div style={{marginBottom:14}}><span className="section-label">MATRIX ID</span>
        <input value={inviteUserId} onChange={e=>setInviteUserId(e.target.value)} placeholder="@staff:matrix.org"/></div>
      <div style={{marginBottom:14}}><span className="section-label">ROLE</span>
        <select value={inviteRole} onChange={e=>setInviteRole(e.target.value)}>
          {ORG_ROLES.map(r=><option key={r} value={r}>{ORG_ROLE_LABELS[r]}</option>)}
        </select></div>
      <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14,fontSize:11.5,color:'var(--tx-1)'}}>
        Role determines which cases and data the staff member can access. Admins see everything; read-only users see only aggregate dashboards.
      </div>
      <button onClick={handleInviteStaff} className="b-pri" style={{width:'100%'}}>Send Invite</button>
    </Modal>

    {/* CREATE NETWORK MODAL */}
    <Modal open={networkModal} onClose={()=>setNetworkModal(false)} title="Create Network">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Create a new governance network for your organization. Other organizations can join. Networks define shared vocabulary and schema propagation.</p>
      <div style={{marginBottom:14}}><span className="section-label">NETWORK NAME</span>
        <input value={networkName} onChange={e=>setNetworkName(e.target.value)} placeholder="e.g. Metro Partnership"/></div>
      <div style={{background:'var(--green-dim)',border:'1px solid rgba(61,214,140,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14,fontSize:11.5,color:'var(--tx-1)'}}>
        The network room will contain shared schema definitions that propagate to all member organizations. Your org "{orgMeta.name}" will be the network admin.
      </div>
      <button onClick={handleCreateNetwork} className="b-pri" style={{width:'100%'}}>Create Network</button>
    </Modal>

    {/* JOIN NETWORK MODAL */}
    <Modal open={joinNetworkModal} onClose={()=>setJoinNetworkModal(false)} title="Join Network">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Enter the Matrix room ID of an existing Khora network to join as "{orgMeta.name||'your organization'}".</p>
      <div style={{marginBottom:14}}><span className="section-label">NETWORK ROOM ID</span>
        <input value={joinNetworkId} onChange={e=>setJoinNetworkId(e.target.value)} placeholder="!roomid:matrix.org"/></div>
      <button onClick={handleJoinNetwork} className="b-pri" style={{width:'100%'}}>Join Network</button>
    </Modal>

    {/* PROVIDER OBSERVATION MODAL */}
    <Modal open={!!provObsModal} onClose={()=>setProvObsModal(null)} title={provObsModal?.question||'Record Observation'} w={500}>
      {provObsModal&&<>
        {provObsModal.eo?.trace&&<div style={{background:'var(--purple-dim)',border:'1px solid rgba(167,139,250,.15)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14}}>
          <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--purple)'}}>{provObsModal.eo.trace}</span>
        </div>}
        <div style={{marginBottom:14}}>
          <span className="section-label">RESPONSE</span>
          {provObsModal.type==='numeric'?
            <div>
              <input type="number" value={provObsValue} onChange={e=>setProvObsValue(e.target.value)}
                placeholder={`${provObsModal.range?.min||0} â€” ${provObsModal.range?.max||100}`}
                min={provObsModal.range?.min} max={provObsModal.range?.max}/>
              {provObsModal.thresholds&&<div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:6}}>
                {provObsModal.thresholds.map((t,i)=><span key={i} style={{fontSize:9.5,padding:'2px 8px',
                  background:provObsValue>=t.v&&(i===provObsModal.thresholds.length-1||provObsValue<provObsModal.thresholds[i+1]?.v)?'var(--gold-dim)':'var(--bg-3)',
                  borderRadius:10,color:provObsValue>=t.v&&(i===provObsModal.thresholds.length-1||provObsValue<provObsModal.thresholds[i+1]?.v)?'var(--gold)':'var(--tx-2)'}}>
                  {t.v}+ {t.l}</span>)}
              </div>}
            </div>
          :<div style={{display:'flex',flexDirection:'column',gap:4}}>
            {provObsModal.options?.map(o=><div key={o.v} onClick={()=>setProvObsValue(o.v)}
              style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',
                border:`1px solid ${provObsValue===o.v?'var(--gold)':'var(--border-1)'}`,
                background:provObsValue===o.v?'var(--gold-dim)':'var(--bg-3)',transition:'all .15s'}}>
              <span style={{fontSize:12.5,color:provObsValue===o.v?'var(--gold)':'var(--tx-1)'}}>{o.l}</span>
            </div>)}
          </div>}
        </div>
        <div style={{marginBottom:14}}>
          <span className="section-label">CLINICAL NOTES (OPTIONAL)</span>
          <textarea value={provObsNotes} onChange={e=>setProvObsNotes(e.target.value)} placeholder="Additional clinical context..." style={{minHeight:50}}/>
        </div>
        <div style={{background:'var(--gold-dim)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14,fontSize:11,color:'var(--gold)'}}>
          This observation is recorded as a MEANT event â€” a professional assessment with full EO provenance chain.
        </div>
        <button onClick={handleProviderObservation} className="b-pri" disabled={!provObsValue} style={{width:'100%'}}>Record {T.provider_term} Observation</button>
      </>}
    </Modal>

    {/* PROVIDER PROFILE MODAL */}
    <Modal open={profileModal} onClose={()=>setProfileModal(false)} title={`${T.provider_term} Profile`} w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Your profile is stored in your roster room and broadcast to all bridge rooms. {T.client_term_plural} see your name, title, credentials, and organization membership.
      </p>
      <div style={{marginBottom:14}}>
        <span className="section-label">DISPLAY NAME</span>
        <input value={profileDraft.display_name} onChange={e=>setProfileDraft({...profileDraft,display_name:e.target.value})} placeholder="e.g. Jamie Rivera"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">TITLE / ROLE</span>
        <input value={profileDraft.title} onChange={e=>setProfileDraft({...profileDraft,title:e.target.value})} placeholder="e.g. Case Manager, Outreach Worker"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">CREDENTIALS / CERTIFICATIONS</span>
        <input value={profileDraft.credentials} onChange={e=>setProfileDraft({...profileDraft,credentials:e.target.value})} placeholder="e.g. LCSW, CHW, HMIS Certified"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">SERVICE TYPES</span>
        <input value={profileDraft.service_types} onChange={e=>setProfileDraft({...profileDraft,service_types:e.target.value})} placeholder="e.g. Housing navigation, Benefits enrollment"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">BIO</span>
        <textarea value={profileDraft.bio} onChange={e=>setProfileDraft({...profileDraft,bio:e.target.value})} placeholder="Brief description of your role and how you help clients..." style={{minHeight:70}}/>
      </div>
      {orgRoom ? <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.2)',borderRadius:'var(--r)',padding:'12px 14px',marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
          <I n="shieldCheck" s={16} c="var(--blue)"/>
          <span style={{fontSize:13,fontWeight:700,color:'var(--blue)'}}>Organization Membership</span>
          {myVerification?.status==='verified' ? <span className="tag tag-green" style={{fontSize:8}}>EMAIL VERIFIED</span>
          : emailVerifyConfig.enabled ? <span className="tag tag-gold" style={{fontSize:8}}>EMAIL UNVERIFIED</span>
          : <span className="tag tag-green" style={{fontSize:8}}>ROSTER VERIFIED</span>}
        </div>
        <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong>{orgMeta.name}</strong> Â· {ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type}<br/>
          Role: <strong>{ORG_ROLE_LABELS[orgRole]||orgRole}</strong>
          {orgMeta.service_area && <><br/>Service Area: {orgMeta.service_area}</>}
          {myVerification?.status==='verified' && myVerification.email && <><br/>Verified email: <strong>{myVerification.email}</strong></>}
        </div>
        {emailVerifyConfig.enabled && myVerification?.status!=='verified' ?
          <div style={{marginTop:8}}>
            <p style={{fontSize:10,color:'var(--gold)',marginBottom:6}}>Your organization requires email verification. Verify your email to display a verified badge to clients.</p>
            <button onClick={openEmailVerifyModal} className="b-pri b-sm" style={{fontSize:11}}>
              <I n="shieldCheck" s={12}/> Verify Email Now
            </button>
          </div>
        : <p style={{fontSize:10,color:'var(--tx-2)',marginTop:6}}>
            {myVerification?.status==='verified' ? 'Your identity is email-verified and visible to clients on all bridges.' : 'Your organization membership is verified through the Matrix room roster and will be visible to clients on all bridges.'}
          </p>}
      </div> : <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'12px 14px',marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <I n="alert" s={14} c="var(--gold)"/>
          <span style={{fontSize:11.5,color:'var(--gold)',fontWeight:600}}>No organization affiliation</span>
        </div>
        <p style={{fontSize:10.5,color:'var(--tx-2)',marginTop:4}}>Clients will see you as an independent provider. Create or join an organization to display a verified affiliation badge on your profile.</p>
      </div>}
      <button onClick={handleSaveProfile} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
        <I n="check" s={16}/> Save Profile & Broadcast
      </button>
    </Modal>

    {/* EMAIL VERIFICATION MODAL */}
    <Modal open={emailVerifyModal} onClose={()=>setEmailVerifyModal(false)} title="Verify Your Email" w={480}>
      {verifyStep==='email' && <>
        <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
          Enter your organization email address to verify your identity. A 6-digit code will be sent to your email.
          {emailVerifyConfig.required_domains?.length > 0 && <> Your email must be from: <strong>{emailVerifyConfig.required_domains.map(d=>'@'+d).join(', ')}</strong>.</>}
        </p>
        <div style={{marginBottom:14}}>
          <span className="section-label">EMAIL ADDRESS</span>
          <input value={verifyEmail} onChange={e=>{setVerifyEmail(e.target.value);setVerifyError('')}} placeholder={emailVerifyConfig.required_domains?.[0] ? `you@${emailVerifyConfig.required_domains[0]}` : 'you@organization.org'} type="email"/>
        </div>
        {verifyError && <div style={{background:'var(--red-dim)',border:'1px solid rgba(239,68,68,.2)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14,fontSize:11.5,color:'var(--red)'}}>{verifyError}</div>}
        <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14,fontSize:11,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--blue)'}}>How it works:</strong> We'll send a one-time 6-digit code to this email. Enter it on the next screen to confirm you control this address. The code expires after 15 minutes.
        </div>
        <button onClick={handleStartEmailVerify} disabled={verifyPending || !verifyEmail.trim()} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
          {verifyPending ? 'Sending...' : <><I n="msg" s={14}/> Send Verification Code</>}
        </button>
      </>}
      {verifyStep==='code' && <>
        <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
          A verification code was sent to <strong>{verifyEmail}</strong>. Enter the 6-digit code below.
        </p>
        <div style={{marginBottom:14}}>
          <span className="section-label">VERIFICATION CODE</span>
          <input value={verifyCode} onChange={e=>{setVerifyCode(e.target.value.replace(/\D/g,'').slice(0,6));setVerifyError('')}}
            placeholder="000000" maxLength={6}
            style={{fontSize:28,letterSpacing:'0.3em',textAlign:'center',fontFamily:'var(--mono)',fontWeight:700}}/>
        </div>
        {verifyError && <div style={{background:'var(--red-dim)',border:'1px solid rgba(239,68,68,.2)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14,fontSize:11.5,color:'var(--red)'}}>{verifyError}</div>}
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>{setVerifyStep('email');setVerifyCode('');setVerifyError('')}} className="b-gho" style={{flex:1}}>
            Back
          </button>
          <button onClick={handleSubmitVerifyCode} disabled={verifyPending || verifyCode.length !== 6} className="b-pri" style={{flex:2,padding:12,fontSize:14}}>
            {verifyPending ? 'Verifying...' : <><I n="shieldCheck" s={14}/> Verify</>}
          </button>
        </div>
      </>}
      {verifyStep==='done' && <>
        <div style={{textAlign:'center',padding:'20px 0'}}>
          <div style={{width:60,height:60,borderRadius:'50%',background:'var(--green-dim)',border:'2px solid var(--green)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 16px'}}>
            <I n="check" s={28} c="var(--green)"/>
          </div>
          <h3 style={{fontSize:18,fontWeight:700,color:'var(--green)',marginBottom:8}}>Email Verified</h3>
          <p style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6,marginBottom:4}}>
            Your identity has been confirmed via <strong>{myVerification?.email}</strong>
          </p>
          <p style={{fontSize:11,color:'var(--tx-2)'}}>
            Your verified status is now visible to clients on all bridges and reflected in your provider profile.
          </p>
        </div>
        <button onClick={()=>setEmailVerifyModal(false)} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>Done</button>
      </>}
    </Modal>

    {/* EMAIL VERIFICATION CONFIG MODAL (admin only) */}
    <Modal open={emailConfigModal} onClose={()=>setEmailConfigModal(false)} title="Email Verification Settings" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Configure email verification requirements for your organization. When enabled, staff members must verify they control an email at an approved domain before accessing cases.
      </p>
      <div style={{marginBottom:16}}>
        <label style={{display:'flex',alignItems:'center',gap:10,cursor:'pointer',padding:'12px 14px',background:emailConfigDraft.enabled?'var(--green-dim)':'var(--bg-3)',border:`1px solid ${emailConfigDraft.enabled?'rgba(61,214,140,.2)':'var(--border-0)'}`,borderRadius:'var(--r)'}}>
          <input type="checkbox" checked={emailConfigDraft.enabled} onChange={e=>setEmailConfigDraft({...emailConfigDraft,enabled:e.target.checked})} style={{width:16,height:16}}/>
          <div>
            <span style={{fontSize:13,fontWeight:600,display:'block'}}>Require Email Verification</span>
            <span style={{fontSize:11,color:'var(--tx-2)'}}>Staff must verify their email before full access</span>
          </div>
        </label>
      </div>
      {emailConfigDraft.enabled && <>
        <div style={{marginBottom:14}}>
          <span className="section-label">APPROVED EMAIL DOMAINS</span>
          <input value={(emailConfigDraft.required_domains||[]).join(', ')}
            onChange={e=>setEmailConfigDraft({...emailConfigDraft,required_domains:e.target.value.split(',').map(s=>s.trim().replace(/^@/,''))})}
            placeholder="e.g. metroservices.org, metro-services.com"/>
          <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>Comma-separated list of allowed email domains. Leave empty to allow any domain.</span>
        </div>
        <div style={{marginBottom:14}}>
          <span className="section-label">REQUIRED FOR ROLES</span>
          <div style={{display:'flex',flexWrap:'wrap',gap:6,marginTop:4}}>
            {ORG_ROLES.map(r=>{
              const active = (emailConfigDraft.require_for_roles||[]).includes(r);
              return <label key={r} style={{display:'flex',alignItems:'center',gap:4,cursor:'pointer',padding:'4px 8px',background:active?'var(--blue-dim)':'var(--bg-3)',border:`1px solid ${active?'rgba(91,156,245,.2)':'var(--border-0)'}`,borderRadius:6,fontSize:11}}>
                <input type="checkbox" checked={active} onChange={e=>{
                  const roles = e.target.checked ? [...(emailConfigDraft.require_for_roles||[]),r] : (emailConfigDraft.require_for_roles||[]).filter(x=>x!==r);
                  setEmailConfigDraft({...emailConfigDraft,require_for_roles:roles});
                }} style={{width:12,height:12}}/>
                {ORG_ROLE_LABELS[r]}
              </label>;
            })}
          </div>
        </div>
        <div style={{marginBottom:14}}>
          <span className="section-label">GRACE PERIOD (HOURS)</span>
          <input type="number" min={0} max={720} value={emailConfigDraft.grace_period_hours||72}
            onChange={e=>setEmailConfigDraft({...emailConfigDraft,grace_period_hours:parseInt(e.target.value)||72})}/>
          <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>Time before unverified staff lose access. 0 = immediate.</span>
        </div>
        <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14,fontSize:11,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--gold)'}}>Note:</strong> Enabling verification will prompt all existing staff in the selected roles to verify their email. Currently {staff.filter(s=>s.email_verification?.status==='verified').length} of {staff.length} staff are verified.
        </div>
      </>}
      <button onClick={handleSaveEmailVerifyConfig} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
        <I n="shieldCheck" s={16}/> Save Verification Settings
      </button>
    </Modal>

    {/* TERMINOLOGY CUSTOMIZATION MODAL */}
    <Modal open={terminologyModal} onClose={()=>setTerminologyModal(false)} title="Customize Terminology" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Customize the terms your organization uses for service recipients and service providers. These labels will appear throughout the interface for all staff at your organization.
      </p>
      <div style={{marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:12}}>
          <I n="shield" s={14} c="var(--teal)"/>
          <span style={{fontSize:13,fontWeight:700}}>Service Recipient Term</span>
          <span style={{fontSize:10,color:'var(--tx-3)'}}>(default: Client)</span>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
          <div>
            <span className="section-label">SINGULAR</span>
            <input value={terminologyDraft.client_term} onChange={e=>setTerminologyDraft({...terminologyDraft,client_term:e.target.value})} placeholder="e.g. Patient, Participant, Member"/>
          </div>
          <div>
            <span className="section-label">PLURAL</span>
            <input value={terminologyDraft.client_term_plural} onChange={e=>setTerminologyDraft({...terminologyDraft,client_term_plural:e.target.value})} placeholder="e.g. Patients, Participants, Members"/>
          </div>
        </div>
        <div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:8}}>
          {['Client','Patient','Participant','Member','Resident','Student','Guest'].map(t=>
            <span key={t} onClick={()=>setTerminologyDraft({...terminologyDraft,client_term:t,client_term_plural:t+'s'})}
              className={`tag ${terminologyDraft.client_term===t?'tag-teal':'tag-blue'}`}
              style={{fontSize:9,cursor:'pointer',transition:'all .15s'}}>{t}</span>)}
        </div>
      </div>
      <div style={{marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:12}}>
          <I n="briefcase" s={14} c="var(--gold)"/>
          <span style={{fontSize:13,fontWeight:700}}>Service Provider Term</span>
          <span style={{fontSize:10,color:'var(--tx-3)'}}>(default: Provider)</span>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
          <div>
            <span className="section-label">SINGULAR</span>
            <input value={terminologyDraft.provider_term} onChange={e=>setTerminologyDraft({...terminologyDraft,provider_term:e.target.value})} placeholder="e.g. Counselor, Therapist, Advocate"/>
          </div>
          <div>
            <span className="section-label">PLURAL</span>
            <input value={terminologyDraft.provider_term_plural} onChange={e=>setTerminologyDraft({...terminologyDraft,provider_term_plural:e.target.value})} placeholder="e.g. Counselors, Therapists, Advocates"/>
          </div>
        </div>
        <div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:8}}>
          {['Provider','Counselor','Therapist','Advocate','Case Worker','Coordinator','Staff'].map(t=>
            <span key={t} onClick={()=>setTerminologyDraft({...terminologyDraft,provider_term:t,provider_term_plural:t+(t.endsWith('f')?'s':t.endsWith('or')?'s':'s')})}
              className={`tag ${terminologyDraft.provider_term===t?'tag-gold':'tag-blue'}`}
              style={{fontSize:9,cursor:'pointer',transition:'all .15s'}}>{t}</span>)}
        </div>
      </div>
      <div style={{background:'var(--bg-3)',borderRadius:'var(--r)',padding:'12px 14px',marginBottom:16}}>
        <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:8}}>PREVIEW</span>
        <div style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.8}}>
          <span>"{terminologyDraft.provider_term||'Provider'} Dashboard" &middot; "My {terminologyDraft.client_term_plural||'Clients'}" &middot; "New {terminologyDraft.client_term||'Client'} Record"</span><br/>
          <span>"Anonymous {terminologyDraft.client_term||'Client'}" &middot; "{terminologyDraft.provider_term||'Provider'} Observation" &middot; "{terminologyDraft.provider_term||'Provider'} Profile"</span>
        </div>
      </div>
      <div style={{display:'flex',gap:8}}>
        <button onClick={handleResetTerminology} className="b-gho" style={{flex:1,padding:10}}>Reset to Defaults</button>
        <button onClick={handleSaveTerminology} className="b-pri"
          disabled={!terminologyDraft.client_term?.trim()||!terminologyDraft.client_term_plural?.trim()||!terminologyDraft.provider_term?.trim()||!terminologyDraft.provider_term_plural?.trim()}
          style={{flex:1,padding:10,fontSize:14}}>
          <I n="shieldCheck" s={14}/> Save Terminology
        </button>
      </div>
    </Modal>

    {/* CREATE CLIENT RECORD MODAL */}
    <Modal open={createClientModal} onClose={()=>setCreateClientModal(false)} title={`New ${T.client_term} Record`} w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
        Create a {T.client_term.toLowerCase()} record. This creates a private encrypted Matrix room. If you provide a Matrix ID, the {T.client_term.toLowerCase()} will be invited and given superadmin control (power level 100) â€” they can remove anyone from the room.
      </p>
      <div style={{marginBottom:14}}>
        <span className="section-label">{T.client_term.toUpperCase()} NAME *</span>
        <input value={newClientName} onChange={e=>setNewClientName(e.target.value)} placeholder="e.g. John Doe"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">{T.client_term.toUpperCase()} MATRIX ID (OPTIONAL)</span>
        <input value={newClientMatrixId} onChange={e=>setNewClientMatrixId(e.target.value)} placeholder="@user:matrix.org"/>
        <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>If provided, the {T.client_term.toLowerCase()} will be invited immediately. You can also invite them later.</span>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">NOTES (OPTIONAL)</span>
        <textarea value={newClientNotes} onChange={e=>setNewClientNotes(e.target.value)} placeholder={`Any notes about this ${T.client_term.toLowerCase()}...`} style={{minHeight:50}}/>
      </div>
      <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        <strong style={{color:'var(--teal)'}}>Data sovereignty:</strong> The {T.client_term.toLowerCase()} will receive power level 100 (superadmin). They can kick any member â€” including you â€” from their room at any time.
      </div>
      <button onClick={handleCreateClientRecord} className="b-pri" disabled={!newClientName.trim()} style={{width:'100%',padding:12,fontSize:14}}>
        <I n="plus" s={16}/> Create {T.client_term} Record
      </button>
    </Modal>

    {/* CLIENT INVITE MODAL */}
    <Modal open={!!clientInviteModal} onClose={()=>{setClientInviteModal(null);setCopiedField(null)}} title={`Invite: ${clientInviteModal?.client_name||''}`} w={600}>
      {clientInviteModal&&<>
        <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
          Generate an invite link and setup instructions to share with this {T.client_term.toLowerCase()}. When they join, they'll have full control of their room.
        </p>

        {/* Matrix ID input */}
        <div style={{marginBottom:16}}>
          <span className="section-label">{T.client_term.toUpperCase()} MATRIX ID</span>
          <div style={{display:'flex',gap:6}}>
            <input value={clientInviteMatrixId} onChange={e=>setClientInviteMatrixId(e.target.value)}
              placeholder="@user:matrix.org" style={{flex:1}}/>
            <button onClick={handleClientInvite} className="b-pri" disabled={!clientInviteMatrixId.trim()}
              style={{whiteSpace:'nowrap',display:'flex',alignItems:'center',gap:4}}>
              <I n="send" s={12}/>Send Invite
            </button>
          </div>
          <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>
            Enter the client's Matrix ID to send a direct room invite and grant them superadmin (PL 100).
          </span>
        </div>

        {/* Invite link */}
        <div style={{marginBottom:16}}>
          <span className="section-label">INVITE LINK</span>
          <div style={{display:'flex',gap:6,alignItems:'center'}}>
            <div style={{flex:1,fontFamily:'var(--mono)',fontSize:11,color:'var(--tx-1)',background:'var(--bg-3)',padding:'10px 14px',borderRadius:'var(--r)',border:'1px solid var(--border-1)',wordBreak:'break-all',userSelect:'all'}}>
              {getInviteUrl(clientInviteModal.roomId)}
            </div>
            <button onClick={()=>copyToClipboard(getInviteUrl(clientInviteModal.roomId),'link')}
              className="b-gho b-sm" style={{display:'flex',alignItems:'center',gap:4,whiteSpace:'nowrap'}}>
              <I n={copiedField==='link'?'check':'copy'} s={12}/>
              {copiedField==='link'?'Copied':'Copy'}
            </button>
          </div>
        </div>

        {/* Setup instructions */}
        <div style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <span className="section-label" style={{marginBottom:0}}>SETUP INSTRUCTIONS â€” SHARE WITH CLIENT</span>
            <button onClick={()=>copyToClipboard(getSetupInstructions(clientInviteModal.roomId),'instructions')}
              className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:3}}>
              <I n={copiedField==='instructions'?'check':'copy'} s={11}/>
              {copiedField==='instructions'?'Copied':'Copy All'}
            </button>
          </div>
          <div style={{fontFamily:'var(--mono)',fontSize:10.5,color:'var(--tx-1)',background:'var(--bg-1)',border:'1px solid var(--border-1)',
            borderRadius:'var(--r)',padding:'14px 16px',lineHeight:1.7,whiteSpace:'pre-wrap',maxHeight:300,overflow:'auto'}}>
            {getSetupInstructions(clientInviteModal.roomId)}
          </div>
        </div>

        {/* Power level info */}
        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'12px 16px',display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="shield" s={16} c="var(--teal)"/>
          <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong style={{color:'var(--teal)'}}>Client gets power level 100 (superadmin).</strong> Once joined, they can remove anyone from this room â€” including you. This ensures the client always has sovereign control over who can access their space.
          </div>
        </div>
      </>}
    </Modal>
    {/* IMPORT DATA MODAL */}
    <ImportDataModal open={importModal} onClose={()=>setImportModal(false)}
      showToast={showToast} metricsRoom={metricsRoom} onComplete={handleImportComplete}/>

    {/* COMPOSE ORG MESSAGE CHANNEL MODAL */}
    <Modal open={composeOrgModal} onClose={()=>setComposeOrgModal(false)} title="New Org Messaging Channel" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
        Create an encrypted messaging channel with another organization. Messages you send will be governed by your opacity setting (<strong style={{color:orgOpacity==='opaque'?'var(--red)':orgOpacity==='translucent'?'var(--gold)':'var(--green)'}}>{OPACITY_LABELS[orgOpacity]}</strong>).
      </p>
      <div style={{marginBottom:14}}>
        <span className="section-label">PEER ORGANIZATION ROOM ID</span>
        <input value={composePeerOrgId} onChange={e=>setComposePeerOrgId(e.target.value)} placeholder="!orgroom:matrix.org"/>
        <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>The Matrix room ID of the organization you want to message.</span>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">ORGANIZATION NAME (OPTIONAL)</span>
        <input value={composePeerOrgName} onChange={e=>setComposePeerOrgName(e.target.value)} placeholder="e.g. Metro Housing Authority"/>
        <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>A display name for the other org. Helps identify the channel.</span>
      </div>
      {/* Opacity preview */}
      <div style={{background:'var(--bg-3)',borderRadius:'var(--r)',padding:'12px 14px',marginBottom:14}}>
        <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>OPACITY PREVIEW â€” THEY WILL SEE:</span>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:9}}>{OPACITY_LABELS[orgOpacity]?.toUpperCase()}</span>
          <span style={{fontSize:12,color:'var(--tx-1)'}}>
            {orgOpacity==='transparent'?`${providerProfile.display_name||'Staff Name'} from ${orgMeta.name||'Your Org'}`
            :orgOpacity==='translucent'?orgMeta.name||'Your Org'
            :'An organization'}
          </span>
        </div>
      </div>
      <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        Both organizations maintain independent opacity settings. You control what they see about you; they control what you see about them.
      </div>
      <button onClick={handleCreateOrgChannel} className="b-pri" disabled={!composePeerOrgId.trim()} style={{width:'100%',padding:12,fontSize:14}}>
        <I n="msg" s={16}/> Create Channel
      </button>
    </Modal>

    {/* MESSAGE ACCESS CONFIGURATION MODAL */}
    <Modal open={msgAccessModal} onClose={()=>setMsgAccessModal(false)} title="Configure Message Access" w={560}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Control which staff roles in your organization can read and respond to inter-org messages. Only roles listed under "Respond" can send messages on behalf of your organization.
      </p>
      <div style={{marginBottom:16}}>
        <span className="section-label">CAN READ ORG MESSAGES</span>
        <p style={{fontSize:10.5,color:'var(--tx-3)',marginBottom:8}}>Select roles that can view messages sent to your organization.</p>
        <div style={{display:'flex',flexDirection:'column',gap:4}}>
          {ORG_ROLES.map(role=><div key={role} onClick={()=>{
            setMsgAccessDraft(prev=>({...prev,read:prev.read.includes(role)?prev.read.filter(r=>r!==role):[...prev.read,role]}));
          }} style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'space-between',
            border:`1px solid ${msgAccessDraft.read?.includes(role)?'var(--blue)':'var(--border-1)'}`,
            background:msgAccessDraft.read?.includes(role)?'var(--blue-dim)':'var(--bg-3)',transition:'all .15s'}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <span style={{width:14,height:14,borderRadius:3,border:`2px solid ${msgAccessDraft.read?.includes(role)?'var(--blue)':'var(--tx-3)'}`,
                background:msgAccessDraft.read?.includes(role)?'var(--blue)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontSize:9,fontWeight:800}}>
                {msgAccessDraft.read?.includes(role)?'âœ“':''}
              </span>
              <span style={{fontSize:12.5,fontWeight:msgAccessDraft.read?.includes(role)?600:400}}>{ORG_ROLE_LABELS[role]}</span>
            </div>
            <span className="tag tag-blue" style={{fontSize:8}}>READ</span>
          </div>)}
        </div>
      </div>
      <div style={{marginBottom:16}}>
        <span className="section-label">CAN RESPOND TO ORG MESSAGES</span>
        <p style={{fontSize:10.5,color:'var(--tx-3)',marginBottom:8}}>Select roles that can send messages on behalf of your organization. These roles can also read.</p>
        <div style={{display:'flex',flexDirection:'column',gap:4}}>
          {ORG_ROLES.map(role=><div key={role} onClick={()=>{
            setMsgAccessDraft(prev=>({...prev,respond:prev.respond.includes(role)?prev.respond.filter(r=>r!==role):[...prev.respond,role]}));
          }} style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'space-between',
            border:`1px solid ${msgAccessDraft.respond?.includes(role)?'var(--gold)':'var(--border-1)'}`,
            background:msgAccessDraft.respond?.includes(role)?'var(--gold-dim)':'var(--bg-3)',transition:'all .15s'}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <span style={{width:14,height:14,borderRadius:3,border:`2px solid ${msgAccessDraft.respond?.includes(role)?'var(--gold)':'var(--tx-3)'}`,
                background:msgAccessDraft.respond?.includes(role)?'var(--gold)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-0)',fontSize:9,fontWeight:800}}>
                {msgAccessDraft.respond?.includes(role)?'âœ“':''}
              </span>
              <span style={{fontSize:12.5,fontWeight:msgAccessDraft.respond?.includes(role)?600:400}}>{ORG_ROLE_LABELS[role]}</span>
            </div>
            <span className="tag tag-gold" style={{fontSize:8}}>RESPOND</span>
          </div>)}
        </div>
      </div>
      <div style={{background:'var(--purple-dim)',border:'1px solid rgba(167,139,250,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        <strong style={{color:'var(--purple)'}}>Opacity + Access = Privacy.</strong> Opacity controls <em>what</em> external orgs see. Access controls <em>who inside your org</em> can participate. Together, they form your org's communication privacy posture.
      </div>
      <button onClick={handleSaveMsgAccess} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
        <I n="check" s={16}/> Save Access Settings
      </button>
    </Modal>
  </div>;
};



/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const App = () => {
  const [welcomed, setWelcomed] = useState(false);
  const [session, setSession] = useState(null);
  const [availableContexts, setAvailableContexts] = useState([]);
  const [activeContext, setActiveContext] = useState(null);
  const [detectedRoles, setDetectedRoles] = useState(null); // roles from inferRolesFromRooms
  const [toast, setToast] = useState(null);
  const [webhookData, setWebhookData] = useState(null);
  const [restoring, setRestoring] = useState(true);
  const [detectingRoles, setDetectingRoles] = useState(false);

  const showToast = (msg, type='info') => setToast({msg, type, k:Date.now()});

  // Context detection: scan rooms to infer roles (MVP Â§Screen 1)
  // Uses inferRolesFromRooms for fine-grained role detection (client/provider/org_admin/network)
  const detectContexts = React.useCallback(async () => {
    setDetectingRoles(true);
    try {
      const scanned = await svc.scanRooms([EVT.ORG_ROSTER]);
      // Fine-grained role detection via inferRolesFromRooms
      const roles = inferRolesFromRooms(scanned, svc.userId);
      setDetectedRoles(roles);

      // Context detection for app routing (client vs provider)
      let hasClient = false;
      let hasProvider = false;
      for (const state of Object.values(scanned || {})) {
        const accountType = state?.[EVT.IDENTITY]?.account_type;
        if (accountType === 'client' || accountType === 'client_record') hasClient = true;
        if (accountType === 'provider' || accountType === 'organization' || accountType === 'schema' || accountType === 'metrics' || accountType === 'network') hasProvider = true;
      }

      const contexts = [];
      if (hasProvider) contexts.push('provider');
      if (hasClient) contexts.push('client');
      if (contexts.length === 0) contexts.push('provider');
      setAvailableContexts(contexts);

      let preferred = null;
      try { preferred = sessionStorage.getItem('khora_active_context'); } catch {}
      const next = (preferred && contexts.includes(preferred)) ? preferred : contexts[0];
      setActiveContext(next);
    } catch (e) {
      console.warn('Context detection failed, defaulting to provider:', e.message);
      setAvailableContexts(['provider']);
      setActiveContext('provider');
    }
    setDetectingRoles(false);
  }, []);

  const switchContext = (context) => {
    if (!availableContexts.includes(context)) return;
    setActiveContext(context);
    try { sessionStorage.setItem('khora_active_context', context); } catch {}
  };

  // Attempt to restore previous session from sessionStorage on mount
  React.useEffect(() => {
    (async () => {
      try {
        const restored = await svc.restoreSession();
        if (restored) {
          setSession(restored);
          // Hydrate webhook data in background
          try {
            const tables = await hydrateFromWebhooks(svc._token);
            setWebhookData(tables);
          } catch (e) { console.warn('Webhook hydration failed:', e.message); }
          await detectContexts();
        }
      } catch {} finally { setRestoring(false); }
    })();
  }, [detectContexts]);

  const handleLogin = async (s) => {
    setSession(s);
    // Detect contexts + roles from room membership (MVP Â§Screen 1)
    await detectContexts();
    // Hydrate Airtable data from n8n webhooks in background
    try {
      const tables = await hydrateFromWebhooks(svc._token);
      setWebhookData(tables);
    } catch (e) {
      console.warn('Webhook hydration failed (CORS or network):', e.message);
    }
  };

  if (restoring || detectingRoles) return <div className="grid-bg" style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center'}}><Spin s={32}/><p style={{color:'var(--tx-2)',fontSize:13,marginTop:16}}>{detectingRoles ? 'Detecting roles from room membershipâ€¦' : 'Restoring sessionâ€¦'}</p></div>
  </div>;
  if (!welcomed && !session) return <WelcomeScreen onContinue={() => setWelcomed(true)}/>;
  if (!session) return <LoginScreen onLogin={handleLogin}/>;
  if (!activeContext) return <div className="grid-bg" style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center'}}><Spin s={28}/><p style={{color:'var(--tx-2)',fontSize:13,marginTop:16}}>Detecting role contextâ€¦</p></div>
  </div>;

  const handleLogout = async () => {
    try { sessionStorage.removeItem('khora_session'); sessionStorage.removeItem('khora_active_context'); } catch {}
    await svc.logout(); setSession(null); setAvailableContexts([]); setActiveContext(null); setDetectedRoles(null); setWebhookData(null);
  };

  return <>
    {activeContext === 'client' ?
      <ClientApp session={session} onLogout={handleLogout} showToast={showToast} webhookData={webhookData}/> :
      <ProviderApp session={session} onLogout={handleLogout} showToast={showToast} webhookData={webhookData}/>
    }
    {/* Context switcher â€” visible when user has multiple role contexts */}
    {availableContexts.length > 1 && <div style={{position:'fixed',bottom:14,right:14,zIndex:30,display:'flex',gap:6,padding:'6px',border:'1px solid var(--border-0)',background:'var(--bg-2)',borderRadius:'999px',backdropFilter:'blur(4px)'}}>
      {[{id:'provider',label:'Provider',icon:'briefcase'},{id:'client',label:'Client',icon:'shield'}]
        .filter(opt => availableContexts.includes(opt.id))
        .map(opt => <button key={opt.id} onClick={()=>switchContext(opt.id)} className={activeContext===opt.id?'b-pri b-xs':'b-gho b-xs'} style={{display:'inline-flex',alignItems:'center',gap:4,borderRadius:'999px'}}>
          <I n={opt.icon} s={11}/>{opt.label}
        </button>)}
    </div>}
    {toast && <Toast key={toast.k} msg={toast.msg} type={toast.type} onClose={()=>setToast(null)}/>}
  </>;
};

ReactDOM.createRoot(document.getElementById('root')).render(<ThemeProvider><App/></ThemeProvider>);
</script>
</body>
</html>
