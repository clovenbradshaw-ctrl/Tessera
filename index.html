<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khora — Sovereign Case Management</title>
<script src="https://cdn.jsdelivr.net/npm/matrix-js-sdk@34.11.1/lib/browser-matrix.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&family=Source+Serif+4:wght@300;400;500;600;700&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-0:#08090b;--bg-1:#0e1015;--bg-2:#141720;--bg-3:#1a1e29;--bg-4:#222735;
  --border-0:#1e2230;--border-1:#2a3040;--border-2:#353d50;
  --tx-0:#e6e9f0;--tx-1:#a0a8b8;--tx-2:#6b7385;--tx-3:#454d5f;
  --gold:#c9a352;--gold-dim:rgba(201,163,82,0.10);--gold-mid:rgba(201,163,82,0.22);
  --green:#3dd68c;--green-dim:rgba(61,214,140,0.10);
  --red:#e85d5d;--red-dim:rgba(232,93,93,0.10);
  --blue:#5b9cf5;--blue-dim:rgba(91,156,245,0.10);
  --teal:#3ec9b0;--teal-dim:rgba(62,201,176,0.10);
  --orange:#e0943a;--orange-dim:rgba(224,148,58,0.10);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,0.10);
  --serif:'Source Serif 4',Georgia,serif;--sans:'Manrope',system-ui,sans-serif;--mono:'IBM Plex Mono',monospace;
  --r:5px;--r-lg:8px;
}
/* ═══ Light theme — WCAG AA accessible (4.5:1+ text contrast) ═══ */
html.light {
  --bg-0:#f5f5f7;--bg-1:#ebedf0;--bg-2:#e0e2e7;--bg-3:#d4d7dd;--bg-4:#c8ccd4;
  --border-0:#cdd0d7;--border-1:#b8bcc6;--border-2:#a0a5b2;
  --tx-0:#1a1c20;--tx-1:#3d4250;--tx-2:#5a6073;--tx-3:#7e8498;
  --gold:#8a6d1e;--gold-dim:rgba(138,109,30,0.10);--gold-mid:rgba(138,109,30,0.18);
  --green:#177a4a;--green-dim:rgba(23,122,74,0.10);
  --red:#c03030;--red-dim:rgba(192,48,48,0.10);
  --blue:#2563b0;--blue-dim:rgba(37,99,176,0.10);
  --teal:#137a6a;--teal-dim:rgba(19,122,106,0.10);
  --orange:#a0600a;--orange-dim:rgba(160,96,10,0.10);
  --purple:#6938c0;--purple-dim:rgba(105,56,192,0.10);
}
html.light .b-pri:hover{box-shadow:0 4px 16px rgba(138,109,30,0.18)}
html.light .b-red{border-color:rgba(192,48,48,.22)}
html.light .b-grn{border-color:rgba(23,122,74,.22)}
html.light .toggle-knob{box-shadow:0 1px 3px rgba(0,0,0,.15);border:1px solid var(--border-1)}
html.light ::-webkit-scrollbar-thumb{background:var(--border-2)}
html.light .grid-bg{background-image:radial-gradient(circle at 20% 20%,rgba(138,109,30,.05) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(37,99,176,.04) 0%,transparent 50%),linear-gradient(var(--border-0) 1px,transparent 1px),linear-gradient(90deg,var(--border-0) 1px,transparent 1px);}
html.light .gm-crossing{background:linear-gradient(135deg,rgba(19,122,106,.10) 0%,rgba(138,109,30,.10) 100%);border-left-color:rgba(19,122,106,.25);border-right-color:rgba(138,109,30,.25)}
html.light .gm-crossing::before{background:repeating-linear-gradient(180deg,transparent,transparent 8px,rgba(138,109,30,.06) 8px,rgba(138,109,30,.06) 16px)}
html.light .gm-divergence{background:rgba(138,109,30,.08)}
html.light .gm-obs-field{background:var(--teal-dim);border-color:rgba(19,122,106,.20)}
*{margin:0;padding:0;box-sizing:border-box;}
html,body,#root{height:100%;background:var(--bg-0);color:var(--tx-0);font-family:var(--sans);}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border-1);border-radius:3px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideR{from{opacity:0;transform:translateX(-14px)}to{opacity:1;transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.anim-up{animation:fadeUp .3s ease both}.anim-in{animation:fadeIn .25s ease both}.anim-sl{animation:slideR .28s ease both}
input,textarea,select{font-family:var(--sans);background:var(--bg-1);border:1px solid var(--border-1);color:var(--tx-0);padding:11px 15px;border-radius:var(--r);font-size:14.5px;outline:none;transition:border .2s,box-shadow .2s;width:100%;}
input:focus,textarea:focus,select:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-dim)}
input::placeholder,textarea::placeholder{color:var(--tx-3)}textarea{resize:vertical;min-height:72px;line-height:1.55}
button{font-family:var(--sans);cursor:pointer;border:none;border-radius:var(--r);font-size:13.5px;font-weight:600;padding:9px 18px;transition:all .18s;letter-spacing:.01em;}
.b-pri{background:var(--gold);color:var(--bg-0)}.b-pri:hover{filter:brightness(1.12);transform:translateY(-1px);box-shadow:0 4px 16px var(--gold-dim)}.b-pri:disabled{opacity:.5;transform:none;cursor:default;filter:none}
.b-gho{background:transparent;color:var(--tx-1);border:1px solid var(--border-1)}.b-gho:hover{background:var(--bg-3);color:var(--tx-0);border-color:var(--border-2)}
.b-red{background:var(--red-dim);color:var(--red);border:1px solid rgba(232,93,93,.18)}.b-red:hover{background:rgba(232,93,93,.18)}
.b-grn{background:var(--green-dim);color:var(--green);border:1px solid rgba(61,214,140,.18)}
.b-sm{padding:7px 14px;font-size:12.5px}.b-xs{padding:5px 10px;font-size:12px}
.tag{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:12px;font-weight:600;font-family:var(--mono);letter-spacing:.03em}
.tag-gold{background:var(--gold-dim);color:var(--gold)}.tag-green{background:var(--green-dim);color:var(--green)}
.tag-red{background:var(--red-dim);color:var(--red)}.tag-blue{background:var(--blue-dim);color:var(--blue)}
.tag-teal{background:var(--teal-dim);color:var(--teal)}.tag-orange{background:var(--orange-dim);color:var(--orange)}
.tag-purple{background:var(--purple-dim);color:var(--purple)}
.card{background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r-lg);padding:20px}
.card-h{background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r-lg);padding:20px;transition:border-color .2s,transform .2s;cursor:pointer}
.card-h:hover{border-color:var(--gold);transform:translateY(-2px)}
.section-label{font-size:12px;font-family:var(--mono);color:var(--tx-1);letter-spacing:.07em;font-weight:500;margin-bottom:12px;display:block}
.toggle-track{width:38px;height:20px;border-radius:10px;position:relative;cursor:pointer;transition:background .2s}
.toggle-track.on{background:var(--green)}.toggle-track.off{background:var(--border-1)}
.toggle-knob{width:16px;height:16px;border-radius:50%;background:#fff;position:absolute;top:2px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.toggle-track.on .toggle-knob{left:20px}.toggle-track.off .toggle-knob{left:2px}
.grid-bg{background-image:radial-gradient(circle at 20% 20%,rgba(201,163,82,.03) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(91,156,245,.02) 0%,transparent 50%),linear-gradient(var(--border-0) 1px,transparent 1px),linear-gradient(90deg,var(--border-0) 1px,transparent 1px);background-size:100% 100%,100% 100%,48px 48px,48px 48px;}
.tabs{display:flex;gap:2px;background:var(--bg-1);border-radius:var(--r);padding:3px;margin-bottom:20px}
.tab{padding:9px 18px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;color:var(--tx-1);background:transparent}
.tab.active{background:var(--bg-3);color:var(--tx-0);font-weight:600}
.tab:hover:not(.active){background:var(--bg-2);color:var(--tx-1)}

/* ═══ Inbox Responsive Styles ═══ */
.inbox-wrap{margin:0 auto;width:100%}
.inbox-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;gap:12px}
.inbox-panel{display:flex;gap:0;border:1px solid var(--border-0);border-radius:var(--r-lg);overflow:hidden;background:var(--bg-1);height:calc(100vh - 200px);min-height:520px;max-height:900px}
.inbox-list{width:300px;min-width:300px;border-right:1px solid var(--border-0);display:flex;flex-direction:column;background:var(--bg-2)}
.inbox-chat{flex:1;display:flex;flex-direction:column;background:var(--bg-1);min-width:0}
.inbox-msgs{flex:1;overflow:auto;padding:20px 24px;display:flex;flex-direction:column;gap:2px}
.inbox-compose{padding:14px 20px;border-top:1px solid var(--border-0);background:var(--bg-2)}
.inbox-chat-hdr{padding:16px 20px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;gap:12px;background:var(--bg-2)}

@media(max-width:1100px){
  .inbox-list{width:260px;min-width:260px}
}
@media(max-width:900px){
  .inbox-header{flex-direction:column;gap:8px}
  .inbox-panel{flex-direction:column;height:auto;max-height:none}
  .inbox-list{width:100%;min-width:100%;border-right:none;border-bottom:1px solid var(--border-0);max-height:260px}
  .inbox-chat{min-height:420px}
  .inbox-msgs{padding:14px 16px}
  .inbox-compose{padding:12px 14px}
  .inbox-chat-hdr{padding:12px 14px}
}
@media(max-width:700px){
  .app-sidebar{width:56px!important;min-width:56px!important;overflow:hidden}
  .app-sidebar .sidebar-label,.app-sidebar .sidebar-detail,.app-sidebar .sidebar-identity,.app-sidebar .sidebar-section{display:none}
  .app-sidebar .sidebar-icon{margin:0 auto}
  .app-main{padding:14px!important}
  .inbox-list{max-height:200px}
}

/* ═══ GIVEN/MEANT Divide Visualization ═══ */
@keyframes crossingPulse{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes flowRight{from{background-position:0 0}to{background-position:20px 0}}
.gm-container{display:flex;gap:0;border-radius:var(--r-lg);overflow:hidden;border:1px solid var(--border-0);background:var(--bg-1);min-height:200px}
.gm-given{flex:0 0 340px;min-width:280px;background:var(--bg-2);padding:20px;border-right:none;position:relative}
.gm-given::after{content:'';position:absolute;top:0;right:0;bottom:0;width:2px;background:var(--teal);opacity:.3}
.gm-crossing{flex:0 0 56px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
  background:linear-gradient(135deg,rgba(62,201,176,.08) 0%,rgba(201,163,82,.08) 100%);
  border-left:1px solid rgba(62,201,176,.2);border-right:1px solid rgba(201,163,82,.2);position:relative;padding:12px 4px}
.gm-crossing::before{content:'';position:absolute;top:0;bottom:0;left:0;right:0;
  background:repeating-linear-gradient(180deg,transparent,transparent 8px,rgba(201,163,82,.04) 8px,rgba(201,163,82,.04) 16px);pointer-events:none}
.gm-crossing-arrow{width:24px;height:24px;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--teal),var(--gold));border-radius:50%;color:var(--bg-0);font-size:11px;font-weight:800;flex-shrink:0}
.gm-crossing-label{writing-mode:vertical-rl;text-orientation:mixed;font-family:var(--mono);font-size:10px;
  font-weight:600;letter-spacing:.1em;background:linear-gradient(180deg,var(--teal),var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.gm-crossing-op{padding:3px 6px;border-radius:8px;font-size:10px;font-family:var(--mono);font-weight:700;
  background:var(--bg-3);color:var(--tx-1);border:1px solid var(--border-1);flex-shrink:0}
.gm-meant{flex:1;min-width:0;background:var(--bg-1);padding:20px;display:flex;flex-direction:column;gap:10px;position:relative}
.gm-meant::before{content:'';position:absolute;top:0;left:0;bottom:0;width:2px;background:var(--gold);opacity:.3}
.gm-fw-card{border:1px solid var(--border-1);border-radius:var(--r);padding:14px;background:var(--bg-2);
  transition:border-color .2s,transform .15s;position:relative;overflow:hidden}
.gm-fw-card:hover{border-color:var(--gold);transform:translateX(2px)}
.gm-fw-card::before{content:'';position:absolute;top:0;left:0;bottom:0;width:3px}
.gm-fw-card[data-accent="blue"]::before{background:var(--blue)}
.gm-fw-card[data-accent="teal"]::before{background:var(--teal)}
.gm-fw-card[data-accent="orange"]::before{background:var(--orange)}
.gm-fw-card[data-accent="green"]::before{background:var(--green)}
.gm-fw-card[data-accent="purple"]::before{background:var(--purple)}
.gm-divergence{background:rgba(201,163,82,.06);border:1px dashed var(--gold);border-radius:var(--r);padding:10px 14px;
  display:flex;align-items:flex-start;gap:10px;font-size:13px;color:var(--tx-1)}
.gm-obs-field{font-family:var(--mono);font-size:14px;font-weight:500;color:var(--teal);padding:10px 14px;
  background:var(--teal-dim);border:1px solid rgba(62,201,176,.15);border-radius:var(--r)}
.gm-obs-value{font-size:16px;font-weight:600;color:var(--tx-0);margin:10px 0}
.gm-meta-row{display:flex;gap:14px;font-size:12px;color:var(--tx-1);font-family:var(--mono)}
.gm-eo-trace{font-family:var(--mono);font-size:11px;color:var(--purple);padding:5px 10px;background:var(--purple-dim);
  border-radius:var(--r);display:inline-block;margin-top:8px}
.gm-chain{display:flex;gap:3px;align-items:center;flex-wrap:wrap;margin-top:6px}
.gm-chain-step{padding:2px 7px;border-radius:6px;font-size:10px;font-family:var(--mono);font-weight:600}
.gm-wb-left{flex:0 0 340px;min-width:280px;overflow:auto;border-right:1px solid var(--border-0);padding:16px}
.gm-wb-right{flex:1;min-width:0;overflow:auto;padding:16px}
.gm-wb-field{padding:10px 12px;border-radius:var(--r);cursor:pointer;border:1px solid var(--border-0);
  margin-bottom:4px;transition:all .15s}
.gm-wb-field:hover{border-color:var(--teal);background:var(--teal-dim)}
.gm-wb-field.active{border-color:var(--teal);background:var(--teal-dim);border-left:3px solid var(--teal)}
.gm-wb-empty{padding:40px 20px;text-align:center;border:1px dashed var(--border-1);border-radius:var(--r);color:var(--tx-3)}
.gm-sankey-line{position:absolute;pointer-events:none}
.gm-sup-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:10px;
  font-size:11px;font-family:var(--mono);font-weight:600;background:var(--gold-dim);color:var(--gold);border:1px solid rgba(201,163,82,.2)}

/* ═══ Form Builder / Schema Builder UX ═══ */
/* fb-canvas, fb-header, fb-header-title, fb-header-meta removed — now inline */
.fb-mode-toggle{display:flex;gap:2px;background:var(--bg-1);border-radius:var(--r);padding:3px}
.fb-mode-btn{padding:8px 16px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;
  color:var(--tx-2);background:transparent;border:none;font-family:inherit;display:flex;align-items:center;gap:6px}
.fb-mode-btn.active{background:var(--bg-3);color:var(--tx-0);font-weight:600}
.fb-mode-btn:hover:not(.active){background:var(--bg-2)}
.fb-section{border:1px solid var(--border-0);border-radius:var(--r-lg);margin-bottom:16px;overflow:hidden;background:var(--bg-1)}
.fb-section-header{padding:14px 18px;background:var(--bg-2);border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.fb-section-title{font-size:14px;font-weight:600;color:var(--tx-0);display:flex;align-items:center;gap:8px}
.fb-section-count{font-size:11px;color:var(--tx-2);font-family:var(--mono)}
.fb-question{padding:16px 18px;border-bottom:1px solid var(--border-0);transition:background .15s}
.fb-question:last-child{border-bottom:none}
.fb-question:hover{background:var(--bg-2)}
.fb-question-prompt{font-size:15px;font-weight:600;color:var(--tx-0);margin-bottom:4px;display:flex;align-items:center;gap:8px}
.fb-question-type{font-size:11px;color:var(--tx-2);font-family:var(--mono);padding:2px 8px;background:var(--bg-3);border-radius:3px}
.fb-answer-list{margin-top:10px;display:flex;flex-direction:column;gap:4px}
.fb-answer{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:5px;transition:all .12s;cursor:pointer}
.fb-answer:hover{background:var(--bg-3)}
.fb-answer-radio{width:16px;height:16px;border-radius:50%;border:2px solid var(--border-2);flex-shrink:0}
.fb-answer-check{width:16px;height:16px;border-radius:3px;border:2px solid var(--border-2);flex-shrink:0}
.fb-answer-label{font-size:14px;color:var(--tx-0);flex:1}
.fb-answer-dots{display:flex;gap:3px;align-items:center;flex-shrink:0}
.fb-prov-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:all .15s}
.fb-prov-dot.bound{background:var(--green)}
.fb-prov-dot.unbound{background:var(--border-2);border:1.5px solid var(--tx-3);box-sizing:border-box}
.fb-prov-dot.conflict{background:var(--gold);box-shadow:0 0 4px var(--gold)}
.fb-source-tag{font-size:11px;color:var(--tx-2);margin-top:8px;display:flex;align-items:center;gap:6px}
.fb-wire-btn{font-size:12px;color:var(--teal);cursor:pointer;padding:4px 10px;border:1px solid rgba(62,201,176,.2);
  border-radius:var(--r);background:var(--teal-dim);transition:all .15s;font-family:inherit;font-weight:500}
.fb-wire-btn:hover{border-color:var(--teal);background:rgba(62,201,176,.12)}
.fb-add-btn{display:flex;align-items:center;gap:6px;padding:10px 16px;color:var(--tx-2);font-size:13px;
  cursor:pointer;transition:color .15s;border:none;background:none;font-family:inherit;width:100%}
.fb-add-btn:hover{color:var(--tx-0)}
.fb-nudge{padding:12px 16px;border-radius:var(--r);border:1px solid rgba(91,156,245,.2);
  background:var(--blue-dim);font-size:13px;color:var(--tx-1);line-height:1.6;margin-top:8px}
.fb-nudge-title{color:var(--blue);font-weight:600;font-size:12px;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.fb-nudge-suggestion{padding:6px 10px;margin-top:6px;border:1px solid var(--border-1);border-radius:var(--r);
  cursor:pointer;font-size:13px;color:var(--tx-1);transition:all .12s}
.fb-nudge-suggestion:hover{border-color:var(--blue);color:var(--blue);background:rgba(91,156,245,.06)}

/* Wiring Panel */
.fb-wire-panel{position:fixed;top:0;right:0;bottom:0;width:520px;max-width:90vw;background:var(--bg-1);
  border-left:1px solid var(--border-0);z-index:40;display:flex;flex-direction:column;
  animation:slideInRight .2s ease both;box-shadow:-8px 0 32px rgba(0,0,0,.3)}
@keyframes slideInRight{from{transform:translateX(100%)}to{transform:translateX(0)}}
.fb-wire-panel-header{padding:18px 20px;border-bottom:1px solid var(--border-0);background:var(--bg-2)}
.fb-wire-panel-body{flex:1;overflow:auto;padding:16px 20px}
.fb-wire-fw-card{border:1px solid var(--border-0);border-radius:var(--r-lg);margin-bottom:10px;overflow:hidden;
  background:var(--bg-2);transition:border-color .15s}
.fb-wire-fw-card:hover{border-color:var(--border-2)}
.fb-wire-fw-card-header{padding:12px 16px;display:flex;align-items:center;gap:10px;cursor:pointer}
.fb-wire-fw-card-body{padding:10px 16px;border-top:1px solid var(--border-0)}
.fb-wire-code-option{padding:8px 12px;border-radius:6px;cursor:pointer;transition:all .12s;
  display:flex;align-items:center;gap:8px;border:1px solid transparent;margin-bottom:4px}
.fb-wire-code-option:hover{border-color:var(--border-2);background:var(--bg-3)}
.fb-wire-code-option.selected{border-color:var(--green);background:var(--green-dim)}
.fb-wire-ground-truth{padding:14px 16px;border-radius:var(--r);border:1px solid var(--border-0);
  background:var(--bg-2);font-size:12.5px;color:var(--tx-2);line-height:1.6;margin-top:16px}
.fb-wire-conflict{padding:10px 14px;border-radius:var(--r);border:1px solid rgba(201,163,82,.25);
  background:rgba(201,163,82,.06);margin-top:6px;font-size:12.5px;color:var(--tx-1);line-height:1.6}

/* Inheritance markers */
.fb-inherit-lock{display:inline-flex;align-items:center;gap:3px;font-size:10px;color:var(--blue);
  font-family:var(--mono);font-weight:600;padding:1px 6px;border-radius:3px;background:var(--blue-dim)}
.fb-inherit-local{display:inline-flex;align-items:center;gap:3px;font-size:10px;color:var(--green);
  font-family:var(--mono);font-weight:600;padding:1px 6px;border-radius:3px;background:var(--green-dim)}

/* Framework adoption modal */
.fb-adopt-modal{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;z-index:50}
.fb-adopt-panel{width:600px;max-height:85vh;overflow:auto;background:var(--bg-1);
  border:1px solid var(--border-0);border-radius:var(--r-lg);padding:24px}

/* Form preview mode */
.fb-preview{max-width:640px;margin:0 auto;padding:24px}
.fb-preview-question{margin-bottom:24px}
.fb-preview-prompt{font-size:16px;font-weight:500;color:var(--tx-0);margin-bottom:10px}
.fb-preview-option{padding:10px 14px;border:1px solid var(--border-0);border-radius:var(--r);
  margin-bottom:6px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:10px}
.fb-preview-option:hover{border-color:var(--teal);background:var(--teal-dim)}

/* ═══ Schema Builder Layout ═══ */
@keyframes siPulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes notifSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.si-wrap{display:flex;height:calc(100vh - 104px);overflow:hidden;margin:-24px;border-radius:var(--r-lg);border:1px solid var(--border-0)}
.si-sidebar{width:280px;min-width:280px;border-right:1px solid var(--border-0);display:flex;flex-direction:column;background:var(--bg-2);overflow:hidden}
.si-sidebar-scroll{flex:1;overflow-y:auto;overflow-x:hidden}
.si-canvas{flex:1;min-width:0;overflow:auto;padding:20px}
.si-context{width:260px;min-width:260px;border-left:1px solid var(--border-0);display:flex;flex-direction:column;background:var(--bg-2);overflow-y:auto;transition:width 200ms ease-out,min-width 200ms ease-out,opacity 150ms}
.si-context.collapsed{width:36px;min-width:36px;overflow:hidden}
.si-header{padding:14px 16px 10px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between}
.si-search{margin:8px 12px;position:relative}
.si-search input{width:100%;padding:8px 12px 8px 30px;border-radius:6px;border:1px solid var(--border-0);background:var(--bg-0);color:var(--tx-0);font-size:12px;font-family:var(--sans);outline:none;transition:border .2s}
.si-search input:focus{border-color:var(--border-2)}
.si-search input::placeholder{color:var(--tx-3)}
.si-search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);pointer-events:none}
.si-group-header{padding:10px 16px 6px;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border-0);transition:background 150ms}
.si-group-header:hover{background:var(--bg-3)}
.si-group-label{font-size:10.5px;font-family:var(--mono);font-weight:600;color:var(--tx-1);letter-spacing:.08em;display:flex;align-items:center;gap:6px}
.si-group-count{font-size:10px;font-family:var(--mono);color:var(--tx-2)}
.si-group-count.alert{color:var(--teal);background:rgba(62,201,176,.12);padding:1px 6px;border-radius:8px;animation:siPulse 2s infinite}
.si-form-item{padding:8px 16px 8px 12px;cursor:pointer;border-left:3px solid transparent;border-bottom:1px solid var(--border-0);transition:all 150ms;display:flex;gap:6px;align-items:flex-start}
.si-form-item:hover{background:var(--bg-3)}
.si-form-item.active{background:var(--bg-4);border-left-color:var(--teal)}
.si-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:5px}
.si-dot.unread{background:var(--teal);animation:siPulse 2s infinite}
.si-dot.current{background:var(--tx-0);border-radius:2px}
.si-dot.read{background:var(--tx-3);opacity:.4}
.si-form-name{font-size:12.5px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--tx-0)}
.si-form-item.active .si-form-name{font-weight:600}
.si-form-meta{font-size:10px;font-family:var(--mono);color:var(--tx-2);margin-top:2px;display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.si-form-update{font-size:9px;font-family:var(--mono);font-weight:600;color:var(--gold);background:rgba(201,163,82,.10);padding:1px 5px;border-radius:3px;margin-top:2px;display:inline-block}
.si-ctx-section{padding:12px 14px;border-bottom:1px solid var(--border-0)}
.si-ctx-label{font-size:10px;font-family:var(--mono);font-weight:600;color:var(--tx-1);letter-spacing:.07em;margin-bottom:8px;display:block}
.si-vt{position:relative;padding-left:20px}
.si-vt::before{content:'';position:absolute;left:16px;top:0;bottom:0;width:1px;background:var(--border-0)}
.si-vt-node{position:relative;padding:6px 0 12px 16px}
.si-vt-dot{position:absolute;left:-8px;top:8px;width:9px;height:9px;border-radius:50%}
.si-vt-dot.current{background:var(--teal);box-shadow:0 0 6px rgba(62,201,176,.3)}
.si-vt-dot.past{background:transparent;border:2px solid var(--tx-3);cursor:pointer}
.si-vt-dot.past:hover{border-color:var(--tx-1)}
.si-lineage-node{padding:8px 12px;border-radius:6px;margin-bottom:0}
.si-lineage-connector{display:flex;align-items:center;gap:6px;padding:2px 0 2px 20px}
.si-lineage-connector::before{content:'';width:1px;height:14px;background:var(--border-1);flex-shrink:0}
.si-adopt-bar{height:4px;border-radius:2px;background:var(--border-0);overflow:hidden;margin:6px 0 10px}
.si-adopt-fill{height:100%;background:var(--teal);border-radius:2px;transition:width 300ms ease-out}
.si-breadcrumb{display:flex;align-items:center;gap:0;font-size:12px;color:var(--tx-2);font-family:var(--sans)}
.si-breadcrumb span.sep{color:var(--tx-3);padding:0 6px;font-size:10px}
.si-breadcrumb span.current{color:var(--tx-0);font-weight:600}
.si-empty{padding:20px 16px;text-align:center}
.si-empty-icon{margin-bottom:6px;opacity:.5}
.si-empty-title{font-size:12px;font-weight:600;color:var(--tx-1);margin-bottom:4px}
.si-empty-desc{font-size:11px;color:var(--tx-3);line-height:1.5}
.si-ctx-strip{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px 0}
.si-ctx-strip button{background:none;border:none;color:var(--tx-3);cursor:pointer;padding:4px;transition:color .15s}
.si-ctx-strip button:hover{color:var(--tx-1)}
@media(max-width:1100px){
  .si-sidebar{width:240px;min-width:240px}
  .si-context:not(.collapsed){width:36px;min-width:36px}
}
@media(max-width:900px){
  .si-sidebar{position:fixed;left:-300px;top:56px;bottom:0;width:300px;min-width:300px;z-index:40;transition:left 250ms ease-out;box-shadow:8px 0 32px rgba(0,0,0,.4)}
  .si-sidebar.open{left:0}
  .si-context{display:none}
  .si-canvas{padding:14px}
  .si-mobile-menu{display:inline-flex!important}
}
/* ═══ Notification System ═══ */
.notif-bell{position:relative;background:none;border:none;color:var(--tx-1);cursor:pointer;padding:4px;border-radius:6px;transition:all .15s;display:flex;align-items:center;justify-content:center}
.notif-bell:hover{background:var(--bg-3);color:var(--tx-0)}
.notif-badge{position:absolute;top:-2px;right:-2px;min-width:14px;height:14px;border-radius:7px;background:var(--teal);color:var(--bg-0);font-size:8px;font-weight:700;font-family:var(--mono);display:flex;align-items:center;justify-content:center;padding:0 3px;line-height:1;pointer-events:none}
.notif-dropdown{position:absolute;top:100%;right:0;margin-top:6px;width:340px;max-height:420px;background:var(--bg-1);border:1px solid var(--border-1);border-radius:var(--r-lg);box-shadow:0 12px 40px rgba(0,0,0,.4);z-index:100;overflow:hidden;animation:notifSlide .15s ease-out}
.notif-dropdown-hdr{padding:12px 14px;border-bottom:1px solid var(--border-0);display:flex;align-items:center;justify-content:space-between}
.notif-dropdown-list{overflow-y:auto;max-height:340px}
.notif-item{padding:10px 14px;border-bottom:1px solid var(--border-0);cursor:pointer;transition:background .12s;display:flex;gap:10px;align-items:flex-start}
.notif-item:hover{background:var(--bg-3)}
.notif-item.unread{background:rgba(62,201,176,.04)}
.notif-item .notif-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.notif-item .notif-body{flex:1;min-width:0}
.notif-item .notif-title{font-size:12px;font-weight:500;color:var(--tx-0);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.notif-item .notif-desc{font-size:10.5px;color:var(--tx-2);margin-top:2px;line-height:1.4;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.notif-item .notif-time{font-size:9px;font-family:var(--mono);color:var(--tx-3);margin-top:3px}
.notif-empty{padding:32px 16px;text-align:center;color:var(--tx-3);font-size:12px}
.si-filter-bar{display:flex;gap:4px;padding:6px 12px;border-bottom:1px solid var(--border-0)}
.si-filter-btn{padding:4px 10px;border-radius:12px;border:1px solid var(--border-0);background:transparent;color:var(--tx-2);font-size:10px;font-family:var(--mono);font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap}
.si-filter-btn:hover{border-color:var(--border-2);color:var(--tx-1)}
.si-filter-btn.active{background:var(--teal-dim);border-color:var(--teal);color:var(--teal)}
.nav-badge{margin-left:auto;min-width:16px;height:16px;border-radius:8px;font-size:9px;font-weight:700;font-family:var(--mono);display:flex;align-items:center;justify-content:center;padding:0 4px;line-height:1}
.nav-badge-gold{background:var(--gold);color:var(--bg-0)}
.nav-badge-teal{background:rgba(62,201,176,.15);color:var(--teal)}
.nav-badge-blue{background:rgba(91,156,245,.15);color:var(--blue)}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo} = React;

/* ═══════════════════ ICONS ═══════════════════ */
const I = ({n,s=17,c})=>{
const p = {width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:c||"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"};
const d={
lock:<svg {...p}><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
unlock:<svg {...p}><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
shield:<svg {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
shieldCheck:<svg {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg>,
users:<svg {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
user:<svg {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
briefcase:<svg {...p}><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
plus:<svg {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
x:<svg {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
check:<svg {...p}><polyline points="20 6 9 17 4 12"/></svg>,
search:<svg {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
share:<svg {...p}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
key:<svg {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
eye:<svg {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
eyeOff:<svg {...p}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
send:<svg {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
trash:<svg {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
file:<svg {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>,
folder:<svg {...p}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
home:<svg {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
back:<svg {...p}><polyline points="15 18 9 12 15 6"/></svg>,
chevR:<svg {...p}><polyline points="9 18 15 12 9 6"/></svg>,
logout:<svg {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
settings:<svg {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
alert:<svg {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
clock:<svg {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
msg:<svg {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
inbox:<svg {...p}><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>,
zap:<svg {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
grid:<svg {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
globe:<svg {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
bar:<svg {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
clipboard:<svg {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>,
link:<svg {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
copy:<svg {...p}><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
userPlus:<svg {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
upload:<svg {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
download:<svg {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
sun:<svg {...p}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
moon:<svg {...p}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
'alert-triangle':<svg {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
'refresh-cw':<svg {...p}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
layers:<svg {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
chevronDown:<svg {...p}><polyline points="6 9 12 15 18 9"/></svg>,
chevronRight:<svg {...p}><polyline points="9 18 15 12 9 6"/></svg>,
chevronLeft:<svg {...p}><polyline points="15 18 9 12 15 6"/></svg>,
gitBranch:<svg {...p}><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>,
activity:<svg {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
menu:<svg {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
'more-v':<svg {...p}><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
bell:<svg {...p}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
filter:<svg {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
};
return <span style={{display:'inline-flex',alignItems:'center',flexShrink:0}}>{d[n]}</span>;
};

/* ═══════════════════ THEME SYSTEM ═══════════════════ */
const getInitialTheme = () => {
  const stored = localStorage.getItem('khora-theme');
  if (stored === 'light' || stored === 'dark') return stored;
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
};

// Apply theme immediately to avoid flash
(() => {
  const t = getInitialTheme();
  if (t === 'light') document.documentElement.classList.add('light');
})();

const ThemeContext = React.createContext({theme:'dark', toggle:()=>{}});

const ThemeProvider = ({children}) => {
  const [theme, setTheme] = useState(getInitialTheme);
  useEffect(() => {
    document.documentElement.classList.toggle('light', theme === 'light');
    localStorage.setItem('khora-theme', theme);
  }, [theme]);
  useEffect(() => {
    const mq = window.matchMedia('(prefers-color-scheme: light)');
    const handler = (e) => {
      if (!localStorage.getItem('khora-theme')) setTheme(e.matches ? 'light' : 'dark');
    };
    mq.addEventListener('change', handler);
    return () => mq.removeEventListener('change', handler);
  }, []);
  const toggle = useCallback(() => setTheme(t => t === 'dark' ? 'light' : 'dark'), []);
  return <ThemeContext.Provider value={{theme, toggle}}>{children}</ThemeContext.Provider>;
};

const useTheme = () => React.useContext(ThemeContext);

const ThemeToggle = ({style:sx}) => {
  const {theme, toggle} = useTheme();
  const isDark = theme === 'dark';
  return <button onClick={toggle} aria-label={isDark ? 'Switch to light mode' : 'Switch to dark mode'}
    title={isDark ? 'Switch to light mode' : 'Switch to dark mode'}
    style={{background:'var(--bg-3)',border:'1px solid var(--border-1)',borderRadius:'var(--r)',
      padding:'6px 8px',cursor:'pointer',display:'inline-flex',alignItems:'center',gap:6,
      color:'var(--tx-1)',fontSize:11,fontFamily:'var(--sans)',fontWeight:500,
      transition:'all .18s',...sx}}
    onMouseEnter={e=>{e.currentTarget.style.borderColor='var(--gold)';e.currentTarget.style.color='var(--tx-0)'}}
    onMouseLeave={e=>{e.currentTarget.style.borderColor='var(--border-1)';e.currentTarget.style.color='var(--tx-1)'}}>
    <I n={isDark?'moon':'sun'} s={14}/>{isDark?'Dark':'Light'}
  </button>;
};

/* ═══════════════════ PER-FIELD CRYPTO (AES-256-GCM) ═══════════════════ */
const FieldCrypto = {
  async generateKey() {
    const key = await crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);
    const raw = await crypto.subtle.exportKey('raw', key);
    return btoa(String.fromCharCode(...new Uint8Array(raw)));
  },
  async encrypt(plaintext, keyB64) {
    const keyBuf = Uint8Array.from(atob(keyB64), c => c.charCodeAt(0));
    const key = await crypto.subtle.importKey('raw', keyBuf, 'AES-GCM', false, ['encrypt']);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const enc = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(plaintext));
    return { ciphertext: btoa(String.fromCharCode(...new Uint8Array(enc))), iv: btoa(String.fromCharCode(...iv)) };
  },
  async decrypt(cipherB64, ivB64, keyB64) {
    try {
      const keyBuf = Uint8Array.from(atob(keyB64), c => c.charCodeAt(0));
      const key = await crypto.subtle.importKey('raw', keyBuf, 'AES-GCM', false, ['decrypt']);
      const iv = Uint8Array.from(atob(ivB64), c => c.charCodeAt(0));
      const ct = Uint8Array.from(atob(cipherB64), c => c.charCodeAt(0));
      const dec = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      return new TextDecoder().decode(dec);
    } catch { return null; }
  }
};

/* ═══════════════════ LOCAL VAULT CRYPTO (IndexedDB at-rest encryption) ═══════════════════ */
/* Derives a per-user AES-256-GCM key from the Matrix session using HKDF.
 * All local IndexedDB data is encrypted with this key so that only the
 * authenticated user who synced the data can read it at rest. The key is
 * held in memory only — destroyed on logout or tab close. */
const LocalVaultCrypto = {
  _key: null, _userId: null,
  async deriveKey(userId, accessToken, deviceId) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(accessToken), 'HKDF', false, ['deriveKey']);
    this._key = await crypto.subtle.deriveKey(
      { name: 'HKDF', hash: 'SHA-256', salt: enc.encode(`${userId}|${deviceId}`), info: enc.encode('khora-local-vault-v1') },
      keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
    );
    this._userId = userId;
    return this._key;
  },
  get ready() { return !!this._key; },
  async encrypt(data) {
    if (!this._key) throw new Error('LocalVaultCrypto not initialized');
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, this._key, new TextEncoder().encode(JSON.stringify(data)));
    return { __enc: 1, ct: btoa(String.fromCharCode(...new Uint8Array(ct))), iv: btoa(String.fromCharCode(...iv)) };
  },
  async decrypt(envelope) {
    if (!this._key) throw new Error('LocalVaultCrypto not initialized');
    if (!envelope?.__enc) return envelope;
    try {
      const ct = Uint8Array.from(atob(envelope.ct), c => c.charCodeAt(0));
      const iv = Uint8Array.from(atob(envelope.iv), c => c.charCodeAt(0));
      const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, this._key, ct);
      return JSON.parse(new TextDecoder().decode(dec));
    } catch { return null; }
  },
  clear() { this._key = null; this._userId = null; }
};

/* ═══════════════════ ENCRYPTED LOCAL CACHE ═══════════════════ */
/* All values written to IndexedDB go through LocalVaultCrypto.encrypt().
 * Keys (primary keys) remain plaintext for lookups; values are AES-256-GCM
 * ciphertext. An attacker inspecting IndexedDB sees only opaque blobs. */
const KhoraEncryptedCache = {
  DB_NAME: 'khora-encrypted-vault', DB_VERSION: 1,
  STORES: ['session', 'rooms', 'state'],
  _db: null,
  async open() {
    if (this._db) return this._db;
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.DB_NAME, this.DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        for (const s of this.STORES) { if (!db.objectStoreNames.contains(s)) db.createObjectStore(s); }
      };
      req.onsuccess = (e) => { this._db = e.target.result; resolve(this._db); };
      req.onerror = () => reject(req.error);
    });
  },
  async put(storeName, key, value) {
    if (!LocalVaultCrypto.ready) return;
    const db = await this.open();
    const encrypted = await LocalVaultCrypto.encrypt(value);
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      tx.objectStore(storeName).put(encrypted, key);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },
  async get(storeName, key) {
    if (!LocalVaultCrypto.ready) return null;
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const req = tx.objectStore(storeName).get(key);
      req.onsuccess = async () => {
        if (!req.result) return resolve(null);
        try { resolve(await LocalVaultCrypto.decrypt(req.result)); }
        catch { resolve(null); }
      };
      req.onerror = () => reject(req.error);
    });
  },
  async getAll(storeName) {
    if (!LocalVaultCrypto.ready) return {};
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const results = {}; const pending = [];
      const req = tx.objectStore(storeName).openCursor();
      req.onsuccess = (e) => {
        const cursor = e.target.result;
        if (cursor) {
          pending.push(LocalVaultCrypto.decrypt(cursor.value).then(v => { if (v !== null) results[cursor.key] = v; }).catch(() => {}));
          cursor.continue();
        } else { Promise.all(pending).then(() => resolve(results)); }
      };
      req.onerror = () => reject(req.error);
    });
  },
  async clear() {
    try {
      const db = await this.open();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(this.STORES, 'readwrite');
        for (const s of this.STORES) tx.objectStore(s).clear();
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    } catch {}
  },
  close() { if (this._db) { this._db.close(); this._db = null; } }
};

/* ═══════════════════ EO OPERATION LAYER ═══════════════════ */
const OPERATORS = ['NUL','DES','INS','SEG','CON','SYN','ALT','SUP','REC'];

// Operator adjacency matrix (§5.2) — row can transition to column
const OP_ADJ = {
  NUL:['NUL','DES'], DES:['NUL','DES','INS'], INS:['DES','INS','SEG'],
  SEG:['INS','SEG','CON'], CON:['SEG','CON','SYN'], SYN:['CON','SYN','ALT'],
  ALT:['SYN','ALT','SUP'], SUP:['ALT','SUP','REC'], REC:['NUL','SUP','REC'],
};

// BFS pathfinding for auto-intermediate emission
function findOpPath(from, to) {
  if (from === to || OP_ADJ[from]?.includes(to)) return [to];
  const queue = [[from]]; const visited = new Set([from]);
  while (queue.length > 0) {
    const path = queue.shift(); const curr = path[path.length-1];
    for (const next of OP_ADJ[curr]||[]) {
      if (next === to) return path.slice(1).concat(to);
      if (!visited.has(next)) { visited.add(next); queue.push([...path, next]); }
    }
  }
  return [to]; // fallback
}

// Per-entity operation history (session-local)
const entityOpHist = {};
function eKey(roomId, field) { return `${roomId}::${field||'_root'}`; }

let opSeq = 0;
function genOpId() { return `op_${Date.now().toString(36)}${(opSeq++).toString(36)}${Math.random().toString(36).slice(2,5)}`; }

// Emit an EO operation — validates transitions, auto-emits intermediates
async function emitOp(roomId, op, target, context, frame, provenance = []) {
  const ek = eKey(roomId, target?.field || target?.entity);
  const lastOp = entityOpHist[ek];
  // Auto-emit intermediate operations if transition is invalid
  if (lastOp && !OP_ADJ[lastOp]?.includes(op)) {
    const path = findOpPath(lastOp, op);
    for (let i = 0; i < path.length - 1; i++) {
      const mid = { id: genOpId(), op: path[i], target, context: { auto_intermediate: true, from: lastOp, to: op }, frame, provenance: [], ts: Date.now() };
      await svc.sendEvent(roomId, EVT.OP, mid);
      entityOpHist[ek] = path[i];
    }
  }
  const event = { id: genOpId(), op, target, context, frame, provenance, ts: Date.now() };
  await svc.sendEvent(roomId, EVT.OP, event);
  entityOpHist[ek] = op;
  return event;
}

// Compute current state from operation history (§9.1)
function projectCurrentState(operations, frameType) {
  const state = {};
  const relevant = operations.filter(o => o.frame?.type === frameType).sort((a,b) => a.ts - b.ts);
  for (const op of relevant) {
    switch (op.op) {
      case 'INS':
        if (op.target?.field) state[op.target.field] = { value: op.target.value ?? op.context?.value, source_op: op.id, epistemic: op.frame?.epistemic, ts: op.ts };
        break;
      case 'ALT':
        if (op.target?.field && state[op.target.field]) { state[op.target.field].value = op.context?.to; state[op.target.field].source_op = op.id; state[op.target.field].ts = op.ts; }
        break;
      case 'NUL':
        if (op.target?.field) state[op.target.field] = { value: null, nullified_by: op.id, ts: op.ts };
        break;
      case 'SUP':
        if (op.target?.field) state[op.target.field] = { values: op.context?.states, superposition: true, source_op: op.id, ts: op.ts };
        break;
      case 'DES':
        if (op.target?.entity) state[`${op.target.entity}.designation`] = { value: op.target.designation, source_op: op.id, ts: op.ts };
        break;
    }
  }
  return state;
}

// SHA-256 cohort hash for metrics anonymization
async function cohortHash(userId, salt) {
  const data = new TextEncoder().encode(userId + (salt || 'khora_default_salt'));
  const hash = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(hash)));
}

/* ═══════════════════ EMAIL VERIFICATION UTILITIES (§10.5) ═══════════════════
 * Generates time-limited 6-digit codes, hashes them with SHA-256, and validates
 * email addresses against organization-approved domains. Codes are stored hashed
 * in Matrix room state — the plaintext code is delivered out-of-band (email/webhook).
 * ════════════════════════════════════════════════════════════════════════════════ */
const EmailVerification = {
  /** Generate a cryptographically random 6-digit code */
  generateCode() {
    const arr = crypto.getRandomValues(new Uint8Array(4));
    const num = (arr[0] << 24 | arr[1] << 16 | arr[2] << 8 | arr[3]) >>> 0;
    return String(num % 1000000).padStart(6, '0');
  },

  /** SHA-256 hash a verification code (stored in state; plaintext never persisted) */
  async hashCode(code) {
    const data = new TextEncoder().encode(code + ':khora_email_verify_v1');
    const hash = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)));
  },

  /** Extract domain from an email address */
  extractDomain(email) {
    const match = (email || '').trim().toLowerCase().match(/@([a-z0-9.-]+)$/);
    return match ? match[1] : null;
  },

  /** Validate email format */
  isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((email || '').trim());
  },

  /** Check if an email's domain matches any of the org's required domains */
  domainMatches(email, requiredDomains) {
    if (!requiredDomains || requiredDomains.length === 0) return true;
    const domain = this.extractDomain(email);
    return domain && requiredDomains.some(d => d.toLowerCase() === domain);
  },

  /** Create a verification challenge object (stored in room state) */
  async createChallenge(userId, email) {
    const code = this.generateCode();
    const codeHash = await this.hashCode(code);
    return {
      challenge: {
        user_id: userId,
        email: email.trim().toLowerCase(),
        domain: this.extractDomain(email),
        code_hash: codeHash,
        created: Date.now(),
        expires: Date.now() + 15 * 60 * 1000, // 15 minutes
        attempts: 0,
        max_attempts: 3,
        status: 'pending',
      },
      plainCode: code, // returned for delivery — never stored in state
    };
  },

  /** Validate a submitted code against a stored challenge */
  async validateChallenge(challenge, submittedCode) {
    if (!challenge || challenge.status !== 'pending') return { valid: false, reason: 'no_active_challenge' };
    if (Date.now() > challenge.expires) return { valid: false, reason: 'expired' };
    if (challenge.attempts >= challenge.max_attempts) return { valid: false, reason: 'max_attempts' };
    const submittedHash = await this.hashCode(submittedCode);
    if (submittedHash !== challenge.code_hash) return { valid: false, reason: 'incorrect_code' };
    return { valid: true };
  },

  /** Default email verification config for an organization */
  defaultConfig() {
    return {
      enabled: false,
      required_domains: [],
      require_for_roles: ['admin', 'case_manager', 'field_worker', 'intake_coordinator'],
      grace_period_hours: 72,
    };
  },

  /** Check if a staff member needs verification given org config */
  needsVerification(config, staffEntry) {
    if (!config?.enabled) return false;
    if (!config.require_for_roles?.includes(staffEntry.role)) return false;
    const ev = staffEntry.email_verification;
    if (ev?.status === 'verified') return false;
    return true;
  },

  /** Deliver verification code via n8n webhook (email relay) */
  async sendCodeViaWebhook(email, code, orgName) {
    try {
      const resp = await fetch(`${WEBHOOK_BASE}/email-verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          to: email,
          code: code,
          org_name: orgName,
          subject: `Your verification code for ${orgName}`,
          expires_minutes: 15,
        }),
      });
      return resp.ok;
    } catch { return false; }
  },
};

/* ═══════════════════ EVENT TYPES (§11) ═══════════════════ */
const NS = 'io.khora';
const EVT = {
  IDENTITY:       `${NS}.identity`,
  OP:             `${NS}.op`,
  // Vault
  VAULT_SNAPSHOT: `${NS}.vault.snapshot`,
  VAULT_PROVIDERS:`${NS}.vault.providers`,
  // Bridge
  BRIDGE_META:    `${NS}.bridge.meta`,
  BRIDGE_REFS:    `${NS}.bridge.refs`,
  // Roster
  ROSTER_INDEX:   `${NS}.roster.index`,
  ROSTER_ASSIGN:  `${NS}.roster.assignment`,
  // Organization
  ORG_ROSTER:     `${NS}.org.roster`,
  ORG_METADATA:   `${NS}.org.metadata`,
  ORG_INVITE:     `${NS}.org.invite`,
  ORG_OPACITY:    `${NS}.org.opacity`,
  ORG_MSG_ACCESS: `${NS}.org.msg_access`,
  // Inter-org messaging
  ORG_MSG_CHANNEL:`${NS}.org.msg.channel`,
  ORG_MSG_ENVELOPE:`${NS}.org.msg.envelope`,
  // Schema — Forms (GIVEN data collection)
  SCHEMA_FORM:    `${NS}.schema.form`,
  SCHEMA_PROMPT:  `${NS}.schema.prompt`,       // individual form field (backward compat)
  // Schema — Interpretations (MEANT frameworks)
  SCHEMA_ASSESSMENT:`${NS}.schema.assessment`,  // provider-side MEANT instruments
  SCHEMA_DEF:     `${NS}.schema.definition`,
  SCHEMA_TRANSFORM:`${NS}.schema.transform`,
  SCHEMA_SUB:     `${NS}.schema.subscription`,
  SCHEMA_AUTHORITY:`${NS}.schema.authority`,
  SCHEMA_PROP:    `${NS}.schema.propagation`,
  // Provider observations
  OBSERVATION:    `${NS}.observation`,
  // Metrics
  METRIC:         `${NS}.metric`,
  METRIC_AGG:     `${NS}.metric.aggregate`,
  METRIC_SUPPRESS:`${NS}.metric.suppression`,
  // Network
  NET_MEMBERS:    `${NS}.network.members`,
  NET_HASH_SALT:  `${NS}.network.hash_salt`,
  // Discovery
  INVITE_TOKEN:   `${NS}.invite.token`,
  ENCOUNTER_PROV: `${NS}.encounter.provisional`,
  // Email verification
  ORG_EMAIL_CONFIG: `${NS}.org.email_verification`,
  ORG_VERIFY_CHALLENGE: `${NS}.org.verification_challenge`,
  // Organization terminology customization
  ORG_TERMINOLOGY: `${NS}.org.terminology`,
  // Teams (flexible groups of people, not tied to a single org)
  TEAM_META:      `${NS}.team.metadata`,
  TEAM_MEMBERS:   `${NS}.team.members`,
  // Matching / dedup
  MATCH_TOKEN:    `${NS}.match.token`,
  MATCH_HIT:      `${NS}.match.hit`,
  MATCH_RESOLVE:  `${NS}.match.resolve`,
  // Client records (provider-created rooms representing clients)
  CLIENT_RECORD:  `${NS}.client.record`,
  // Import
  IMPORT_MANIFEST:`${NS}.import.manifest`,
  // Provider profile (self-reported identity & credentials)
  PROVIDER_PROFILE: `${NS}.provider.profile`,
  // Governance (MVP §Screen 5)
  GOV_PROPOSAL:   `${NS}.governance.proposal`,
  GOV_RHYTHM:     `${NS}.governance.rhythm`,
  // Schema field & binding (MVP event schema)
  SCHEMA_FIELD:   `${NS}.schema.field`,
  SCHEMA_BINDING: `${NS}.schema.binding`,
  // Resource tracking (§Resource Build)
  RESOURCE_TYPE:       `${NS}.resource.type`,        // catalog entry (network or org)
  RESOURCE_INVENTORY:  `${NS}.resource.inventory`,   // org stock levels per relation
  RESOURCE_RELATION:   `${NS}.resource.relation`,    // relational position between holder and resource
  RESOURCE_ALLOC:      `${NS}.resource.allocation`,  // individual allocation (bridge room)
  RESOURCE_EVENT:      `${NS}.resource.event`,       // lifecycle event (timeline, not state)
  RESOURCE_POLICY:     `${NS}.resource.policy`,      // allocation rules / constraints
  RESOURCE_OPACITY:    `${NS}.resource.opacity`,     // per-relation visibility controls
  RESOURCE_VAULT:      `${NS}.resource.vault_record`,// client vault shadow record
};

/* ═══════════════════ MATURITY LEVELS (MVP §Screen 4) ═══════════════════ */
const MATURITY_LEVELS = {
  draft:      { id: 'draft',      label: 'Draft',      color: 'blue',   icon: '🔵', desc: 'Proposed, not yet reviewed' },
  trial:      { id: 'trial',      label: 'Trial',      color: 'gold',   icon: '🟡', desc: 'Approved for testing, may change' },
  normative:  { id: 'normative',  label: 'Normative',  color: 'green',  icon: '🟢', desc: 'Locked, changes require formal process' },
  de_facto:   { id: 'de_facto',   label: 'De facto',   color: 'purple', icon: '⚪', desc: 'Widely used, never formally proposed' },
  deprecated: { id: 'deprecated', label: 'Deprecated', color: 'red',    icon: '🔴', desc: 'Being phased out' },
};

/* ═══════════════════ PROPAGATION LEVELS (MVP §CON Semantics) ═══════════════════ */
const PROPAGATION_LEVELS = {
  required:    { id: 'required',    label: 'Required',    color: 'red',    desc: 'Tight coupling — auto-applied to orgs, immutable' },
  standard:    { id: 'standard',    label: 'Standard',    color: 'gold',   desc: 'Expected coupling — auto-applied, notify on divergence' },
  recommended: { id: 'recommended', label: 'Recommended', color: 'blue',   desc: 'Suggested coupling — org reviews, adopts or ignores' },
  optional:    { id: 'optional',    label: 'Optional',    color: 'teal',   desc: 'Loose coupling — available, no expectation' },
};

/* ═══════════════════ GOVERNANCE CONSTANTS (MVP §Screen 5) ═══════════════════ */
const CONSENT_POSITIONS = {
  adopt_as_is:          { id: 'adopt_as_is',          label: 'Adopt as-is',           icon: '✅', color: 'green' },
  adopt_with_extension: { id: 'adopt_with_extension', label: 'Adopt with extension',  icon: '🔄', color: 'blue' },
  needs_modification:   { id: 'needs_modification',   label: 'Needs modification',    icon: '⚠️', color: 'gold' },
  cannot_adopt:         { id: 'cannot_adopt',         label: 'Cannot adopt (block)',   icon: '🚫', color: 'red' },
};

const PROPOSAL_STATUSES = {
  submitted:     { id: 'submitted',     label: 'Submitted',     color: 'blue' },
  discussion:    { id: 'discussion',    label: 'Discussion',    color: 'gold' },
  consent_round: { id: 'consent_round', label: 'Consent Round', color: 'orange' },
  resolved:      { id: 'resolved',      label: 'Resolved',      color: 'green' },
  adopted:       { id: 'adopted',       label: 'Adopted',       color: 'green' },
  blocked:       { id: 'blocked',       label: 'Blocked',       color: 'red' },
};

const GOV_RHYTHMS = {
  monthly_review:     { id: 'monthly_review',     name: 'Monthly Schema Review',         frequency: 'monthly',    anchor_day: 'first_monday', duration_days: 5, participants: 'org_admins' },
  quarterly_alignment:{ id: 'quarterly_alignment', name: 'Quarterly Framework Alignment', frequency: 'quarterly',  anchor_day: 'first_monday', duration_days: 5, participants: 'network_steward_plus_affected' },
  annual_constitutional:{ id: 'annual_constitutional', name: 'Annual Constitutional Review', frequency: 'annual', anchor_day: 'first_monday', duration_days: 14, participants: 'all_members_supermajority' },
};

/* ═══════════════════ RESOURCE TRACKING CONSTANTS (§Resource Build) ═══════════════════ */

/** Resource categories — the top-level classification for resource types */
const RESOURCE_CATEGORIES = [
  'housing',          // beds, units, vouchers, rental assistance
  'financial',        // emergency funds, deposits, stipends
  'transportation',   // bus passes, ride vouchers, gas cards
  'food',             // meals, pantry bags, grocery cards
  'health',           // medical supplies, prescriptions, hygiene kits
  'employment',       // job training slots, interview clothing, tools
  'legal',            // legal aid hours, document preparation
  'education',        // tutoring hours, school supplies, enrollment slots
  'general',          // catch-all for org-specific items
];

const RESOURCE_CATEGORY_LABELS = {
  housing:        'Housing',
  financial:      'Financial',
  transportation: 'Transportation',
  food:           'Food',
  health:         'Health',
  employment:     'Employment',
  legal:          'Legal',
  education:      'Education',
  general:        'General',
};

const RESOURCE_CATEGORY_COLORS = {
  housing:        'blue',
  financial:      'green',
  transportation: 'teal',
  food:           'orange',
  health:         'red',
  employment:     'gold',
  legal:          'purple',
  education:      'blue',
  general:        'teal',
};

/**
 * Opacity levels control resource visibility. Defaults to SOVEREIGN (holder-only).
 * The holder controls disclosure — not the network admin.
 */
const RESOURCE_OPACITY = {
  SOVEREIGN:   0,  // holder-only, no one else sees it
  ATTESTED:    1,  // shared with specific partners via bridge
  CONTRIBUTED: 2,  // visible in network resource commons
  PUBLISHED:   3,  // externally visible (API, 211 feed, directory)
};

const RESOURCE_OPACITY_LABELS = {
  0: 'Sovereign',
  1: 'Attested',
  2: 'Contributed',
  3: 'Published',
};

const RESOURCE_OPACITY_DESCRIPTIONS = {
  0: 'Only visible to the holding org',
  1: 'Shared with specific partners via bridge',
  2: 'Visible in network resource commons',
  3: 'Externally visible (API, directory)',
};

/** Relation types describe how a holder relates to a resource */
const RESOURCE_RELATION_TYPES = [
  'operates',       // org runs/owns the resource directly
  'funds',          // org provides funding for the resource
  'refers_to',      // org can refer clients to this resource
  'contributes_to', // org contributes inventory to a shared pool
  'transfers',      // one-time transfer between orgs
];

const RESOURCE_RELATION_LABELS = {
  operates:       'Operates',
  funds:          'Funds',
  refers_to:      'Refers to',
  contributes_to: 'Contributes to',
  transfers:      'Transfers',
};

/** Allocation statuses */
const RESOURCE_ALLOC_STATUSES = ['active', 'consumed', 'expired', 'revoked'];

/** Lifecycle event types */
const RESOURCE_LIFECYCLE_EVENTS = ['allocated', 'consumed', 'expired', 'revoked', 'returned'];

/** Dedup link statuses */
const RESOURCE_DEDUP_STATUSES = ['confirmed', 'attested_non_additive', 'unresolved'];

/** Dedup link types */
const RESOURCE_DEDUP_LINK_TYPES = ['subset', 'same', 'overlaps'];

/* ═══════════════════ ROLE INFERENCE (MVP §Screen 1) ═══════════════════ */
/* Roles are detected from room memberships — no account-type selector.
 * A user can have multiple roles simultaneously. */
const ROLES = {
  client:    { id: 'client',    label: 'Individual',         icon: 'shield',    color: 'teal',   desc: 'Data owner with a personal Vault' },
  provider:  { id: 'provider',  label: 'Team Member',        icon: 'briefcase', color: 'gold',   desc: 'Case manager or outreach worker' },
  org_admin: { id: 'org_admin', label: 'Org Admin',         icon: 'users',     color: 'blue',   desc: 'Organization administrator' },
  network:   { id: 'network',   label: 'Network Coordinator',icon: 'globe',    color: 'green',  desc: 'Network governance steward' },
};

function inferRolesFromRooms(scannedState, userId) {
  const roles = new Set();
  for (const [roomId, state] of Object.entries(scannedState)) {
    const id = state[EVT.IDENTITY];
    if (!id) continue;
    // Client vault owned by this user → client role
    if (id.account_type === 'client' && id.owner === userId) roles.add('client');
    // Provider roster owned by this user → provider role
    if (id.account_type === 'provider' && id.owner === userId) roles.add('provider');
    // Org room where user is in staff roster → provider role
    if (id.account_type === 'organization') roles.add('provider');
    // Network room → network coordinator role (checked via power levels separately)
    if (id.account_type === 'network') roles.add('provider');
    // Bridge room where user is the provider side → provider role
    const bridge = state[EVT.BRIDGE_META];
    if (bridge && bridge.provider === userId) roles.add('provider');
    // Bridge room where user is the client side → client role
    if (bridge && bridge.client === userId) roles.add('client');
  }
  // Check for org admin role by examining org rosters
  for (const [roomId, state] of Object.entries(scannedState)) {
    const id = state[EVT.IDENTITY];
    const roster = state[EVT.ORG_ROSTER];
    if (id?.account_type === 'organization' && roster?.staff) {
      const staffEntry = roster.staff.find(s => s.userId === userId);
      if (staffEntry?.role === 'admin') roles.add('org_admin');
    }
  }
  return [...roles];
}

/* ═══════════════════ MATRIX SERVICE ═══════════════════ */
class KhoraService {
  constructor() { this.client = null; this._baseUrl = null; this._token = null; this._userId = null; }

  async _withRetry(fn, maxAttempts = 5) {
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
      try { return await fn(); } catch (e) {
        const msg = (e?.data?.error || e?.message || '').toLowerCase();
        const retryMs = e?.data?.retry_after_ms;
        if (msg.includes('too many') || msg.includes('rate') || msg.includes('limit') || retryMs) {
          const wait = Math.min(retryMs || (1000 * Math.pow(2, attempt)), 16000);
          await new Promise(r => setTimeout(r, wait));
          continue;
        }
        throw e;
      }
    }
    throw new Error('Rate limited — too many requests. Please try again.');
  }

  async login(homeserver, user, pass) {
    const baseUrl = homeserver.startsWith('http') ? homeserver : `https://${homeserver}`;
    this._baseUrl = baseUrl;
    if (typeof matrixcs !== 'undefined') {
      this.client = matrixcs.createClient({ baseUrl });
      const res = await this.client.login('m.login.password', { user, password: pass });
      // Derive per-user at-rest encryption key (AES-256-GCM via HKDF from access token)
      // Only this user's session can decrypt local IndexedDB data
      await LocalVaultCrypto.deriveKey(res.user_id, res.access_token, res.device_id);
      // Purge any legacy unencrypted IndexedDB databases (preserves Matrix crypto store for E2EE)
      await this._purgeUnencryptedStores();
      this.client = matrixcs.createClient({ baseUrl, accessToken: res.access_token, userId: res.user_id, deviceId: res.device_id });
      try { await this.client.initCrypto(); } catch (e) { console.warn('Crypto:', e.message); }
      await this.client.startClient({ initialSyncLimit: 30 });
      await new Promise((resolve, reject) => {
        if (this.client.isInitialSyncComplete()) return resolve();
        const timeout = setTimeout(() => reject(new Error('Sync timed out — the server may be overloaded. Please try again.')), 60000);
        this.client.on('sync', (state, prev, data) => {
          if (state === 'PREPARED') { clearTimeout(timeout); resolve(); }
          else if (state === 'ERROR') { clearTimeout(timeout); reject(new Error(data?.error?.message || 'Sync failed — please try again.')); }
        });
      });
      this._userId = res.user_id; this._token = res.access_token;
      // Persist session to localStorage so it survives page refresh, tab close, and browser restart
      try { localStorage.setItem('khora_session', JSON.stringify({ homeserver: baseUrl, accessToken: res.access_token, userId: res.user_id, deviceId: res.device_id })); } catch {}
      // Cache encrypted session metadata in the encrypted vault
      try { await KhoraEncryptedCache.put('session', 'current', { userId: res.user_id, homeserver: baseUrl, deviceId: res.device_id, ts: Date.now() }); } catch {}
      return { userId: res.user_id };
    } else {
      const resp = await this._api('POST', '/login', { type: 'm.login.password', user, password: pass }, true);
      this._token = resp.access_token; this._userId = resp.user_id;
      return { userId: resp.user_id };
    }
  }

  async restoreSession() {
    try {
      const raw = localStorage.getItem('khora_session');
      if (!raw) return null;
      const { homeserver, accessToken, userId, deviceId } = JSON.parse(raw);
      if (!homeserver || !accessToken || !userId || !deviceId) return null;
      this._baseUrl = homeserver;
      await LocalVaultCrypto.deriveKey(userId, accessToken, deviceId);
      if (typeof matrixcs !== 'undefined') {
        this.client = matrixcs.createClient({ baseUrl: homeserver, accessToken, userId, deviceId });
        try { await this.client.initCrypto(); } catch (e) { console.warn('Crypto:', e.message); }
        await this.client.startClient({ initialSyncLimit: 30 });
        await new Promise((resolve, reject) => {
          if (this.client.isInitialSyncComplete()) return resolve();
          const timeout = setTimeout(() => reject(new Error('Sync timed out')), 60000);
          this.client.on('sync', (state, prev, data) => {
            if (state === 'PREPARED') { clearTimeout(timeout); resolve(); }
            else if (state === 'ERROR') { clearTimeout(timeout); reject(new Error(data?.error?.message || 'Sync failed')); }
          });
        });
      }
      this._userId = userId; this._token = accessToken;
      return { userId };
    } catch (e) {
      console.warn('Session restore failed:', e.message);
      localStorage.removeItem('khora_session');
      this.client = null; this._token = null; this._userId = null;
      LocalVaultCrypto.clear();
      return null;
    }
  }

  get userId() { return this._userId; }
  get hasCrypto() { return this.client && typeof this.client.isCryptoEnabled === 'function' && this.client.isCryptoEnabled(); }

  async _api(method, path, body, noAuth) {
    const url = `${this._baseUrl}/_matrix/client/v3${path}`;
    const h = { 'Content-Type': 'application/json' };
    if (!noAuth) h['Authorization'] = `Bearer ${this._token}`;
    const opts = { method, headers: h };
    if (body) opts.body = JSON.stringify(body);
    for (let attempt = 0; attempt < 5; attempt++) {
      const r = await fetch(url, opts);
      if (r.status === 429) {
        const err = await r.json().catch(()=>({}));
        const wait = Math.min(err.retry_after_ms || (1000 * Math.pow(2, attempt)), 16000);
        await new Promise(res => setTimeout(res, wait));
        continue;
      }
      if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error || `API ${r.status}`); }
      return r.json();
    }
    throw new Error('Rate limited — too many requests. Please try again.');
  }

  async createRoom(name, topic, extraState = []) {
    const initial_state = [
      { type: 'm.room.encryption', state_key: '', content: { algorithm: 'm.megolm.v1.aes-sha2' } },
      ...extraState,
    ];
    if (this.client) {
      const r = await this._withRetry(() => this.client.createRoom({ name, topic, visibility: 'private', preset: 'private_chat', initial_state }));
      return r.room_id;
    } else {
      const r = await this._api('POST', '/createRoom', { name, topic, visibility: 'private', preset: 'private_chat', initial_state });
      return r.room_id;
    }
  }

  async createClientRoom(name, topic, extraState = [], clientMatrixId = null) {
    const initial_state = [
      { type: 'm.room.encryption', state_key: '', content: { algorithm: 'm.megolm.v1.aes-sha2' } },
      ...extraState,
    ];
    const opts = { name, topic, visibility: 'private', preset: 'private_chat', initial_state };
    // If we know the client's Matrix ID, pre-set them as room admin (PL 100)
    // Provider gets PL 50 — client can kick provider but not vice versa.
    // We must explicitly set `events` to override the preset defaults (which require
    // PL 100 for m.room.encryption etc.) — otherwise initial_state events fail
    // because the provider only has PL 50.
    if (clientMatrixId) {
      opts.power_level_content_override = {
        users: { [this._userId]: 50, [clientMatrixId]: 100 },
        events_default: 0, state_default: 50,
        events: { 'm.room.power_levels': 100, 'm.room.tombstone': 100, 'm.room.server_acl': 100 },
        kick: 50, ban: 50, invite: 50, redact: 50,
      };
    }
    if (this.client) {
      const r = await this._withRetry(() => this.client.createRoom(opts));
      return r.room_id;
    } else {
      const r = await this._api('POST', '/createRoom', opts);
      return r.room_id;
    }
  }

  async setPowerLevel(roomId, userId, level) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (room) {
        const plEvent = room.currentState.getStateEvents('m.room.power_levels', '');
        const content = plEvent ? { ...plEvent.getContent() } : {};
        content.users = { ...(content.users || {}), [userId]: level };
        await this._withRetry(() => this.client.sendStateEvent(roomId, 'm.room.power_levels', content, ''));
      }
    } else {
      let current;
      try { current = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/state/m.room.power_levels/`); }
      catch { current = {}; }
      current.users = { ...(current.users || {}), [userId]: level };
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/state/m.room.power_levels/`, current);
    }
  }

  async getState(roomId, type, sk = '') {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (!room) return null;
      const ev = room.currentState.getStateEvents(type, sk);
      return ev ? ev.getContent() : null;
    }
    try { return await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/state/${type}/${sk}`); } catch { return null; }
  }

  async setState(roomId, type, content, sk = '') {
    if (this.client) { await this._withRetry(() => this.client.sendStateEvent(roomId, type, content, sk)); }
    else { await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/state/${type}/${sk}`, content); }
  }

  async sendEvent(roomId, type, content) {
    if (this.client) { await this._withRetry(() => this.client.sendEvent(roomId, type, content)); }
    else {
      const txn = 'txn_' + Date.now() + Math.random().toString(36).slice(2);
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/send/${encodeURIComponent(type)}/${txn}`, content);
    }
  }

  async sendMessage(roomId, body, extra = {}) {
    const content = { msgtype: 'm.text', body, ...extra, timestamp: Date.now() };
    if (this.client) { await this._withRetry(() => this.client.sendMessage(roomId, content)); }
    else {
      const txn = 'txn_' + Date.now() + Math.random().toString(36).slice(2);
      await this._api('PUT', `/rooms/${encodeURIComponent(roomId)}/send/m.room.message/${txn}`, content);
    }
  }

  async getMessages(roomId, limit = 40) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      if (!room) return [];
      return room.getLiveTimeline().getEvents()
        .filter(ev => ev.getType() === 'm.room.message')
        .map(ev => ({ id: ev.getId(), sender: ev.getSender(), content: ev.getContent(), ts: ev.getTs() }))
        .reverse();
    }
    const d = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/messages?dir=b&limit=${limit}`);
    return (d.chunk || []).filter(e => e.type === 'm.room.message')
      .map(e => ({ id: e.event_id, sender: e.sender, content: e.content, ts: e.origin_server_ts }));
  }

  async invite(roomId, userId) {
    if (this.client) { await this.client.invite(roomId, userId); }
    else { await this._api('POST', `/rooms/${encodeURIComponent(roomId)}/invite`, { user_id: userId }); }
  }

  async kick(roomId, userId, reason = 'Removed') {
    if (this.client) { await this.client.kick(roomId, userId, reason); }
    else { await this._api('POST', `/rooms/${encodeURIComponent(roomId)}/kick`, { user_id: userId, reason }); }
  }

  async tombstone(roomId, newRoomId) {
    await this.setState(roomId, 'm.room.tombstone', { body: 'This room has been replaced', replacement_room: newRoomId });
  }

  async getJoinedRooms() {
    if (this.client) return this.client.getRooms().map(r => r.roomId);
    const d = await this._api('GET', '/joined_rooms');
    return d.joined_rooms || [];
  }

  async getRoomMembers(roomId) {
    if (this.client) {
      const room = this.client.getRoom(roomId);
      return room ? room.getJoinedMembers().map(m => ({ userId: m.userId, name: m.name })) : [];
    }
    try {
      const d = await this._api('GET', `/rooms/${encodeURIComponent(roomId)}/joined_members`);
      return Object.keys(d.joined || {}).map(id => ({ userId: id, name: d.joined[id]?.display_name || id }));
    } catch { return []; }
  }

  // Batch-fetch all Khora state across joined rooms in a single request.
  // When the SDK is available, reads local sync state (no HTTP calls).
  // When using the API fallback, uses /sync with a tight filter — one request
  // instead of 2*N individual getState calls that produce 404s for non-Khora rooms.
  // Returns: { [roomId]: { [eventType]: content } }
  // Results are cached in the encrypted local vault (KhoraEncryptedCache).
  async scanRooms(extraTypes = []) {
    const types = [EVT.IDENTITY, EVT.BRIDGE_META, EVT.BRIDGE_REFS, ...extraTypes];
    if (this.client) {
      const result = {};
      for (const room of this.client.getRooms()) {
        const state = {};
        for (const type of types) {
          const ev = room.currentState.getStateEvents(type, '');
          if (ev) state[type] = ev.getContent();
        }
        if (Object.keys(state).length > 0) result[room.roomId] = state;
      }
      // Persist room state to encrypted local cache
      try { await KhoraEncryptedCache.put('rooms', 'scan_result', { data: result, ts: Date.now() }); } catch {}
      return result;
    }
    // Fallback: single /sync with filter — avoids per-room 404 spam
    const filter = JSON.stringify({
      room: {
        state: { types },
        timeline: { limit: 0 },
        ephemeral: { types: [] }
      },
      presence: { types: [] },
      account_data: { types: [] }
    });
    try {
      const data = await this._api('GET', `/sync?filter=${encodeURIComponent(filter)}&timeout=0`);
      const result = {};
      const joined = data?.rooms?.join || {};
      for (const [roomId, roomData] of Object.entries(joined)) {
        const events = roomData?.state?.events || [];
        const state = {};
        for (const ev of events) {
          if (ev.state_key === '') state[ev.type] = ev.content;
        }
        if (Object.keys(state).length > 0) result[roomId] = state;
      }
      return result;
    } catch (e) {
      console.warn('scanRooms sync fallback failed, falling back to per-room scan:', e.message);
      // Last resort: per-room scan (original behavior)
      const rooms = await this.getJoinedRooms();
      const result = {};
      for (const rid of rooms) {
        try {
          const allState = await this._api('GET', `/rooms/${encodeURIComponent(rid)}/state`);
          const state = {};
          for (const ev of allState) {
            if (ev.state_key === '' && types.includes(ev.type)) state[ev.type] = ev.content;
          }
          if (Object.keys(state).length > 0) result[rid] = state;
        } catch { /* skip rooms we can't read */ }
      }
      return result;
    }
  }

  // Purge unencrypted IndexedDB databases created by the Matrix SDK sync layer
  // or legacy application caches. Preserves crypto stores (Olm/Megolm key material
  // needed for E2EE continuity) and our own encrypted vault.
  async _purgeUnencryptedStores() {
    if (typeof indexedDB?.databases === 'function') {
      try {
        const dbs = await indexedDB.databases();
        for (const db of dbs) {
          // Keep our encrypted vault and any crypto key stores
          if (db.name && db.name !== KhoraEncryptedCache.DB_NAME && !db.name.includes('crypto')) {
            try { indexedDB.deleteDatabase(db.name); } catch {}
          }
        }
      } catch (e) { console.warn('IndexedDB purge:', e.message); }
    }
    // Explicitly target known unencrypted sync/state databases by name
    for (const name of ['amino', 'matrix-js-sdk:default', 'matrix-js-sdk:riot-web-sync', 'matrix-js-sdk:web-sync']) {
      try { indexedDB.deleteDatabase(name); } catch {}
    }
  }

  async logout() {
    if (this.client) { this.client.stopClient(); try { await this.client.logout(); } catch {} }
    this.client = null; this._token = null; this._userId = null;
    // Destroy at-rest encryption key — local encrypted data becomes unreadable
    LocalVaultCrypto.clear();
    // Wipe encrypted local cache and close database connection
    try { await KhoraEncryptedCache.clear(); KhoraEncryptedCache.close(); } catch {}
    // Purge any remaining unencrypted databases
    try { await this._purgeUnencryptedStores(); } catch {}
  }

  // Scan invited rooms — returns rooms the user has been invited to but hasn't joined.
  // Uses invite state from /sync (SDK) or invite section of sync response (API).
  async scanInvitedRooms(types = [EVT.IDENTITY]) {
    if (this.client) {
      const result = {};
      for (const room of this.client.getRooms()) {
        const membership = room.getMyMembership();
        if (membership !== 'invite') continue;
        const state = {};
        for (const type of types) {
          const ev = room.currentState.getStateEvents(type, '');
          if (ev) state[type] = ev.getContent();
        }
        if (Object.keys(state).length > 0) result[room.roomId] = state;
      }
      return result;
    }
    // API fallback: /sync includes invite section with stripped state
    const filter = JSON.stringify({
      room: { state: { types }, timeline: { limit: 0 }, ephemeral: { types: [] } },
      presence: { types: [] }, account_data: { types: [] }
    });
    try {
      const data = await this._api('GET', `/sync?filter=${encodeURIComponent(filter)}&timeout=0`);
      const result = {};
      const invited = data?.rooms?.invite || {};
      for (const [roomId, roomData] of Object.entries(invited)) {
        const events = roomData?.invite_state?.events || [];
        const state = {};
        for (const ev of events) {
          if (ev.state_key === '' && types.includes(ev.type)) state[ev.type] = ev.content;
        }
        if (Object.keys(state).length > 0) result[roomId] = state;
      }
      return result;
    } catch { return {}; }
  }

  async joinRoom(roomId) {
    if (this.client) {
      await this._withRetry(() => this.client.joinRoom(roomId));
    } else {
      await this._api('POST', `/join/${encodeURIComponent(roomId)}`, {});
    }
  }
}

const svc = new KhoraService();

/* ═══════════════════ WEBHOOK / AIRTABLE BRIDGE ═══════════════════
 * Fetches table and record data from n8n webhook endpoints backed by
 * the amino Postgres schema. Auth is forwarded via query-param so the
 * browser never sends an Authorization header, avoiding CORS preflight.
 * ═══════════════════════════════════════════════════════════════════ */
const WEBHOOK_BASE = 'https://n8n.intelechia.com/webhook';

async function webhookFetch(path, token) {
  const sep = path.includes('?') ? '&' : '?';
  const url = `${WEBHOOK_BASE}${path}${token ? `${sep}access_token=${encodeURIComponent(token)}` : ''}`;
  const resp = await fetch(url);
  if (!resp.ok) {
    const body = await resp.json().catch(() => ({}));
    throw new Error(body.error || body.message || `Webhook ${resp.status}`);
  }
  return resp.json();
}

async function hydrateFromWebhooks(token) {
  const { tables } = await webhookFetch('/api/tables', token);
  const allTables = {};
  await Promise.all(tables.map(async (t) => {
    try {
      const data = await webhookFetch(`/api/records/${encodeURIComponent(t.table_id)}`, token);
      allTables[t.table_id] = { ...t, records: data.records || [] };
    } catch (e) {
      console.warn(`Failed to hydrate table ${t.table_id}:`, e.message);
      allTables[t.table_id] = { ...t, records: [] };
    }
  }));
  return allTables;
}

/* ═══════════════════ DOMAIN CONFIG (§C.0) ═══════════════════
 * All domain-specific content is consolidated here. To adapt Tessera for a
 * different sector, replace the contents of DOMAIN_CONFIG — the application
 * logic, encryption model, bridge topology, and EO operator layer are all
 * domain-agnostic.
 * ═══════════════════════════════════════════════════════════════════════════ */
const DOMAIN_CONFIG = {

  /* ═══════════════════════════════════════════════════════════════════════════
   * FORMS — Structured GIVEN Data Collection
   *
   * Forms are the primary artifact of the schema system. A form is a versioned
   * collection of fields that collects structured data at the GIVEN level —
   * what actually happened, observed by or about the client.
   *
   * Forms are authored at the network or org level and propagate downward:
   *   Network → Organization → Provider → Client
   *
   * Propagation levels control how member orgs interact with network forms:
   *   required  — Auto-applied, immutable at org level
   *   standard  — Auto-applied, orgs may extend (additive only)
   *   recommended — Org reviews, decides whether to adopt
   *   optional  — Available in catalog, no adoption expectation
   *
   * Each form groups related fields into a coherent data collection instrument
   * that can be versioned, governed, and propagated as a unit.
   * ═══════════════════════════════════════════════════════════════════════════ */
  forms: [
    { id:'form_status_engagement', name:'Status & Engagement', version:1,
      description:'Core status and engagement tracking for active cases',
      maturity:'normative',
      source:{level:'network',propagation:'required'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'form_status_engagement',designation:'Status & Engagement Form'},
           frame:{type:'schema',epistemic:'GIVEN',role:'network'}},
        ],
        trace:'form_status_engagement = DES (network-authored, required propagation)'
      },
      fields: [
        { id:'prompt_current_status', key:'current_status', question:'What is your current status?', type:'single_select',
          version:1, maturity:'normative', section:'status',
          eo:{
            chain:[
              {op:'DES',target:{entity:'current_status',designation:'Current Status Field'},
               frame:{type:'schema',epistemic:'GIVEN',role:'network'}},
              {op:'CON',target:{source:'current_status',destination:'ext:standard_1.01'},
               context:{authority_id:'auth_ext_standard',element:'ext_1',
                        authority_name:'External Reporting Standard'}},
              {op:'SEG',target:{field:'response_options',entity:'current_status'},
               context:{rationale:'Simplified from full reporting standard for field use',
                        excluded:['administrative_hold','archived']}}
            ],
            trace:'current_status = DES → CON(ext:standard_1.01) → SEG({field simplified})'
          },
          options:[
            {v:'active',l:'Active — currently receiving services',
             eo:{op:'SYN',target:{local:'active',external:'ext:standard_1.01:a'}}},
            {v:'on_hold',l:'On hold — temporarily paused',
             eo:{op:'SYN',target:{local:'on_hold',external:'ext:standard_1.01:b'}}},
            {v:'pending_review',l:'Pending review',
             eo:{op:'SYN',target:{local:'pending_review',external:'ext:standard_1.01:c'}}},
            {v:'resolved',l:'Resolved — services completed',
             eo:{op:'SYN',target:{local:'resolved',external:'ext:standard_1.01:d'}}},
            {v:'other',l:'Other',
             eo:{op:'INS',target:{local:'other'},context:{note:'Catch-all not in reporting taxonomy'}}}
          ],
          category:'status', sensitive:false, metrics:true },
        { id:'prompt_engagement', key:'engagement_type', question:'What engagement occurred?', type:'single_select',
          version:1, maturity:'normative', section:'engagement',
          eo:{
            chain:[
              {op:'DES',target:{entity:'engagement_type',designation:'Engagement Type Field'},
               frame:{type:'schema',epistemic:'GIVEN',role:'network'}},
              {op:'CON',target:{source:'engagement_type',destination:'svc:direct_services'},
               context:{authority_id:'auth_service_taxonomy',authority_name:'Service Taxonomy'}}
            ],
            trace:'engagement_type = DES → CON(svc:direct_services)'
          },
          options:[
            {v:'in_person',l:'In-person meeting'},{v:'phone_call',l:'Phone call'},
            {v:'referral_contact',l:'Referral or linkage',eo:{op:'CON',target:{local:'referral_contact',external:'svc:svc_cat_2'}}},
            {v:'intake',l:'Intake or enrollment'},{v:'follow_up',l:'Follow-up contact'},{v:'other',l:'Other'}],
          category:'engagement', sensitive:false, metrics:true },
      ]},
    { id:'form_intake', name:'Intake', version:1,
      description:'Intake and enrollment event tracking',
      maturity:'trial',
      source:{level:'network',propagation:'standard'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'form_intake',designation:'Intake Form'},
           frame:{type:'schema',epistemic:'GIVEN',role:'network'}},
        ],
        trace:'form_intake = DES (network-authored, standard propagation)'
      },
      fields: [
        { id:'prompt_intake_event', key:'intake_event', question:'What intake event occurred?', type:'single_select',
          version:1, maturity:'trial', section:'intake',
          eo:{
            chain:[
              {op:'DES',target:{entity:'intake_event',designation:'Intake Event Field'},
               frame:{type:'schema',epistemic:'GIVEN',role:'network'}}
            ],
            trace:'intake_event = DES'
          },
          options:[
            {v:'application_submitted',l:'Application submitted'},{v:'documents_provided',l:'Documents provided'},
            {v:'eligibility_confirmed',l:'Eligibility confirmed'},{v:'enrolled',l:'Enrolled in program'},
            {v:'waitlisted',l:'Placed on waitlist'},{v:'other',l:'Other'}],
          category:'intake', sensitive:false, metrics:true },
      ]},
    { id:'form_context', name:'Additional Context', version:1,
      description:'Supplementary context and situation changes',
      maturity:'draft',
      source:{level:'local'},
      eo:{
        chain:[
          {op:'DES',target:{entity:'form_context',designation:'Context Form'},
           frame:{type:'schema',epistemic:'GIVEN',role:'local'}},
        ],
        trace:'form_context = DES (local, no propagation)'
      },
      fields: [
        { id:'prompt_additional_context', key:'additional_context', question:'Any additional context to record?', type:'single_select',
          version:1, maturity:'draft', section:'general',
          eo:{
            chain:[
              {op:'DES',target:{entity:'additional_context',designation:'Additional Context Field'},
               frame:{type:'schema',epistemic:'GIVEN',role:'local'}}
            ],
            trace:'additional_context = DES'
          },
          options:[
            {v:'situation_change',l:'Situation changed'},{v:'new_need',l:'New need identified'},
            {v:'barrier_encountered',l:'Barrier encountered'},{v:'milestone_reached',l:'Milestone reached'},{v:'other',l:'Other'}],
          category:'general', sensitive:true, metrics:true },
      ]},
  ],

  /* ═══════════════════════════════════════════════════════════════════════════
   * INTERPRETATIONS — Frameworks That Create MEANT From GIVEN
   *
   * Interpretations are the structures that derive institutional meaning from
   * the raw GIVEN data collected by forms. They include:
   *
   *   authorities  — External standards/frameworks (HUD, CoC, etc.)
   *   assessments  — Provider-side structured observations (MEANT frame)
   *   definitions  — Classification rules that derive categories from GIVEN values
   *
   * The GIVEN/MEANT divide is the core epistemic boundary:
   *   GIVEN = what was observed (collected via forms)
   *   MEANT = what an institution classifies that observation as
   *
   * Interpretations are also authored at network/org level and propagate
   * alongside forms, but they operate on a different epistemic plane.
   * ═══════════════════════════════════════════════════════════════════════════ */
  interpretations: {
    /* ── Authorities: External institutional standards ── */
    authorities: [
      { id:'auth_org_policy', name:'Organization Policy v1',
        uri:'local://org/policy',
        authority_type:'organizational_policy', authority_org:'Organization', version:'v1',
        terms:[
          {id:'policy_1',label:'Eligibility Criteria',
           definition:'Conditions under which an individual qualifies for services'},
          {id:'policy_2',label:'Service Standards',
           definition:'Required standards for service delivery'},
          {id:'policy_3',label:'Data Collection Requirements',
           definition:'Mandatory data elements for intake and ongoing engagement'},
        ]},
      { id:'auth_ext_standard', name:'External Reporting Standard',
        uri:'local://ext/standard',
        authority_type:'external_standard', authority_org:'Regulatory Body', version:'v1',
        terms:[
          {id:'ext_1',label:'Status Classification (1.01)',
           definition:'Current status at point of engagement'},
          {id:'ext_2',label:'Engagement Type (1.02)',
           definition:'Nature of service engagement'},
          {id:'ext_3',label:'Identity Elements (2.01)'},
          {id:'ext_4',label:'Contact Elements (2.02)'},
        ]},
      { id:'auth_service_taxonomy', name:'Service Taxonomy',
        uri:'local://service/taxonomy',
        authority_type:'industry_standard', authority_org:'Standards Body', version:'v1',
        terms:[
          {id:'svc_cat_1',label:'Direct Services',definition:'Services delivered to individuals'},
          {id:'svc_cat_2',label:'Coordination Services',definition:'Referral and linkage services'},
        ]},
      { id:'auth_local_policy', name:'Local Policy',
        uri:'local://local/policy', authority_type:'local_policy', authority_org:'Local Authority',
        terms:[] },
    ],

    /* ── Assessments: Provider-side structured observations (MEANT frame) ──
     * These are NOT forms — they are interpretation instruments. Providers use
     * them to record professional assessments that classify or evaluate the
     * GIVEN data collected from clients. Each assessment produces a MEANT event.
     */
    assessments: [
      { id:'pprompt_assessment_score', key:'assessment_score', question:'Assessment Score', type:'numeric',
        version:1, audience:'provider', maturity:'normative', section:'assessment',
        source:{level:'network',propagation:'standard'},
        eo:{
          chain:[
            {op:'DES',target:{entity:'assessment_score',designation:'Assessment Score'},
             frame:{type:'schema',epistemic:'MEANT',role:'provider'}},
            {op:'CON',target:{source:'assessment_score',destination:'org:assessment-v1'},
             context:{authority_name:'Organization Policy',note:'Standard assessment instrument'}}
          ],
          trace:'assessment_score = DES → CON(org:assessment-v1)'
        },
        range:{min:0,max:10}, thresholds:[{v:0,l:'Low'},{v:4,l:'Medium'},{v:7,l:'High'}],
        category:'assessment', sensitive:true, metrics:true },
      { id:'pprompt_case_stage', key:'case_stage', question:'Case stage?', type:'single_select',
        version:1, audience:'provider', maturity:'normative', section:'case_management',
        source:{level:'network',propagation:'required'},
        eo:{
          chain:[
            {op:'DES',target:{entity:'case_stage',designation:'Case Stage'},
             frame:{type:'schema',epistemic:'MEANT',role:'provider'}}
          ],
          trace:'case_stage = DES'
        },
        options:[
          {v:'intake',l:'Intake'},{v:'active',l:'Active'},
          {v:'monitoring',l:'Monitoring'},{v:'closed_complete',l:'Closed — completed'},
          {v:'closed_withdrawn',l:'Closed — withdrawn'},{v:'closed_lost',l:'Closed — lost contact'}],
        category:'case_management', sensitive:false, metrics:true },
      { id:'pprompt_referral', key:'referral_status', question:'Referral status?', type:'single_select',
        version:1, audience:'provider', maturity:'trial', section:'coordination',
        source:{level:'network',propagation:'recommended'},
        eo:{
          chain:[
            {op:'DES',target:{entity:'referral_status',designation:'Referral Status'},
             frame:{type:'schema',epistemic:'MEANT',role:'provider'}},
            {op:'CON',target:{source:'referral_status',destination:'svc:coordination'},
             context:{authority_id:'auth_service_taxonomy'}}
          ],
          trace:'referral_status = DES → CON(svc:coordination)'
        },
        options:[
          {v:'identified',l:'Need identified'},{v:'referred',l:'Referred'},
          {v:'scheduled',l:'Appointment scheduled'},{v:'completed',l:'Service completed'},
          {v:'declined',l:'Declined'},{v:'no_capacity',l:'Receiving org at capacity'}],
        category:'coordination', sensitive:false, metrics:true },
    ],

    /* ── Definitions: Classification rules that derive MEANT from GIVEN ──
     * These rules operate on GIVEN observation values (collected via forms)
     * and produce MEANT classifications. The epistemic crossing is explicit:
     * each rule documents which GIVEN fields it reads and which MEANT
     * category it produces.
     */
    definitions: [
      { id:'def_priority_level', key:'priority_level', name:'Priority Level', type:'classification_rule',
        version:1, maturity:'normative', source:{level:'network',propagation:'required'},
        eo:{
          chain:[
            {op:'DES',target:{entity:'priority_level',designation:'Priority Level Classification'},
             frame:{type:'schema',epistemic:'MEANT',role:'network'}},
            {op:'CON',target:{source:'priority_level',destination:'org:policy_1'},
             context:{authority_id:'auth_org_policy',
                      authority_name:'Organization Policy v1',version:'v1'}},
            {op:'SEG',target:{field:'categories',entity:'priority_level'},
             context:{included:['priority_a','priority_b'],excluded:['priority_d'],
                      rationale:'Network prioritizes highest-need categories'}}
          ],
          trace:'priority_level = DES → CON(org:policy_1) → SEG({Categories A-B})'
        },
        rules:[
          {category:'priority_a', criteria:'current_status IN (active) AND assessment_score >= 7', authority_code:'A',
           eo:{
             chain:[
               {op:'SYN',target:{local:'priority_a',external:'org:policy_1(a)'}},
               {op:'CON',target:{source:'priority_a',destination:'current_status'},
                context:{derivation:'Classification derived from observation',
                         epistemic_crossing:'GIVEN → MEANT',
                         note:'Observation (current status) is GIVEN; classification (priority A) is MEANT'}}
             ]}},
          {category:'priority_b', criteria:'intake_event=eligibility_confirmed AND engagement_type != none', authority_code:'B',
           eo:{
             chain:[
               {op:'SYN',target:{local:'priority_b',external:'org:policy_1(b)'}},
               {op:'CON',target:{source:'priority_b',destination:'intake_event'},
                context:{derivation:'Classification derived from intake observation + engagement',
                         epistemic_crossing:'GIVEN → MEANT'}}
             ]}},
          {category:'stable', criteria:'current_status=resolved for 30+ days', authority_code:null,
           eo:{
             chain:[
               {op:'DES',target:{entity:'stable',designation:'Stable'},
                context:{note:'Local definition — no direct external equivalent'}},
               {op:'CON',target:{source:'stable',destination:'current_status'},
                context:{derivation:'Classification from sustained observation pattern',
                         epistemic_crossing:'GIVEN → MEANT'}}
             ]}},
        ]},
      { id:'def_extended_engagement', key:'extended_engagement', name:'Extended Engagement', type:'classification_rule',
        version:1, maturity:'trial', source:{level:'network',propagation:'standard'},
        eo:{
          chain:[
            {op:'DES',target:{entity:'extended_engagement',designation:'Extended Engagement Definition'},
             frame:{type:'schema',epistemic:'MEANT',role:'network'}},
            {op:'CON',target:{source:'extended_engagement',destination:'org:policy_1'},
             context:{authority_id:'auth_org_policy',
                      authority_name:'Organization Policy v1',version:'v1'}},
            {op:'SUP',target:{entity:'extended_engagement',field:'definition'},
             context:{
               states:[
                 {source:'org:policy_1',definition:'12 months continuous OR 4 engagement episodes in 3 years',
                  frame:'organization_standard'},
                 {source:'local_policy',definition:'6 months continuous OR 3 episodes in 2 years',
                  frame:'local_practice'}
               ],
               resolution:null,
               note:'Organization definition used for reporting; local definition used for prioritization'
             }}
          ],
          trace:'extended_engagement = DES → CON(org:policy_1) → SUP({org vs local})'
        },
        rules:[
          {category:'extended_org', criteria:'active engagement for 12+ months continuous OR 4+ episodes in 3 years', authority_code:'ext',
           eo:{chain:[{op:'SYN',target:{local:'extended_org',external:'org:policy_1'}}]}},
          {category:'extended_local', criteria:'active engagement for 6+ months continuous OR 3+ episodes in 2 years', authority_code:null,
           eo:{chain:[{op:'DES',target:{entity:'extended_local'},context:{note:'Local threshold — lower bar for outreach'}}]}},
        ]},
    ],
  },

  /* ── Anonymization Transforms ── */
  transforms: {
    dob:{method:'age_range',buckets:['0-17','18-24','25-34','35-44','45-54','55-64','65+']},
    address:{method:'area_hash'},
    full_name:{method:'block'}, id_number:{method:'block'}, phone:{method:'block'}, email:{method:'block'},
  },

  /* ── Vault Fields ── */
  vaultFields: [
    {key:'full_name',label:'Full Name',category:'identity',sensitive:false},
    {key:'dob',label:'Date of Birth',category:'identity',sensitive:true},
    {key:'id_number',label:'ID Number',category:'identity',sensitive:true},
    {key:'email',label:'Email',category:'contact',sensitive:false},
    {key:'phone',label:'Phone',category:'contact',sensitive:false},
    {key:'address',label:'Address',category:'contact',sensitive:true},
    {key:'affiliation',label:'Organization / Affiliation',category:'details',sensitive:false},
    {key:'case_notes',label:'Case Notes',category:'case',sensitive:false},
    {key:'documents',label:'Documents',category:'case',sensitive:true},
    {key:'history',label:'Case History',category:'case',sensitive:false},
    {key:'restricted_notes',label:'Restricted Notes',category:'sensitive',sensitive:true},
  ],

  /* ── Field Categories ── */
  fieldCategories: ['identity','contact','details','case','sensitive'],
  fieldCatLabels: {identity:'Identity',contact:'Contact',details:'Details',case:'Case',sensitive:'Sensitive'},
  fieldCatIcons: {identity:'user',contact:'msg',details:'briefcase',case:'folder',sensitive:'shieldCheck'},
  fieldCatColors: {identity:'blue',contact:'teal',details:'gold',case:'orange',sensitive:'green'},

  /* ── Observation Categories ── */
  obsCatLabels: {status:'Status',engagement:'Engagement',intake:'Intake',general:'General',
    assessment:'Assessment',case_management:'Case Mgmt',coordination:'Coordination'},
  obsCatColors: {status:'teal',engagement:'blue',intake:'orange',general:'gold',
    assessment:'purple',case_management:'gold',coordination:'blue'},

  /* ── Org Roles ── */
  orgRoles: ['admin','provider','case_manager','field_worker','intake_coordinator','read_only'],
  orgRoleLabels: {admin:'Admin',provider:'Provider (Team Member)',case_manager:'Case Manager',field_worker:'Field Worker',
    intake_coordinator:'Intake Coordinator',read_only:'Read Only'},

  /* ── Relationship Types ── */
  // Accounts can be connected through multiple relationship kinds.
  // client_provider is the default service relationship in MVP bridge flows.
  relationshipTypes: {
    client_provider: {
      id: 'client_provider',
      label: 'Individual ↔ Team Member',
      legacyLabel: 'Client ↔ Provider',
      description: 'Service relationship between an individual and a team member.'
    },
    teammate: {
      id: 'teammate',
      label: 'Team Member ↔ Team Member',
      description: 'Collaboration relationship between two team members.'
    },
    org_membership: {
      id: 'org_membership',
      label: 'Team Member ↔ Organization',
      description: 'Membership relationship connecting a person to an organization.'
    },
    network_membership: {
      id: 'network_membership',
      label: 'Organization ↔ Network',
      description: 'Membership relationship connecting an organization to a network.'
    }
  },

  /* ── Org Types ── */
  orgTypes: ['direct_service','administrative','clinical','legal','coordinating_body','advocacy','other'],
  orgTypeLabels: {direct_service:'Direct Service',administrative:'Administrative',clinical:'Clinical',
    legal:'Legal',coordinating_body:'Coordinating Body',advocacy:'Advocacy',other:'Other'},

  /* ── Org Opacity Levels ── */
  // Controls how much of the org's internal structure is visible to external orgs during messaging
  opacityLevels: ['transparent','translucent','opaque'],
  opacityLabels: {
    transparent: 'Transparent',     // sender name & org visible
    translucent: 'Translucent',     // org name visible, individual sender hidden
    opaque:      'Opaque',          // only "an organization" — no name, no members
  },
  opacityDescriptions: {
    transparent: 'External orgs see which staff member sent each message and your org name.',
    translucent: 'External orgs see your org name but individual sender identities are hidden.',
    opaque:      'External orgs see only that a response came from an organization. Org name and all member identities are hidden.',
  },

  /* ── Org Message Access Roles ── */
  // Which org roles can access inter-org messages by default
  msgAccessDefaults: {
    read: ['admin','case_manager'],
    respond: ['admin'],
  },

  /* ── Org Terminology Defaults ── */
  // Admins can override these terms at the org level to match their sector vocabulary
  terminologyDefaults: {
    client_term: 'Individual',
    client_term_plural: 'Individuals',
    provider_term: 'Team Member',
    provider_term_plural: 'Team Members',
  },
};

/* ── Derived constants ──
 * Forms → flat field arrays for backward compatibility with seeding & UI.
 * DEFAULT_PROMPTS = all GIVEN fields (client-facing) extracted from forms.
 * DEFAULT_PROVIDER_PROMPTS = all MEANT assessments (provider-facing).
 */
const DEFAULT_FORMS = DOMAIN_CONFIG.forms;
const DEFAULT_PROMPTS = DOMAIN_CONFIG.forms.flatMap(f =>
  f.fields.map(field => ({...field, audience:'client', source:field.source||f.source, form_id:f.id, form_name:f.name}))
);
const DEFAULT_PROVIDER_PROMPTS = DOMAIN_CONFIG.interpretations.assessments;
const DEFAULT_AUTHORITIES = DOMAIN_CONFIG.interpretations.authorities;
const DEFAULT_DEFINITIONS = DOMAIN_CONFIG.interpretations.definitions;
const DEFAULT_TRANSFORMS = DOMAIN_CONFIG.transforms;

/* ═══════════════════ VAULT FIELD DEFINITIONS (§10) ═══════════════════ */
const VAULT_FIELDS = DOMAIN_CONFIG.vaultFields;
const FIELD_CATEGORIES = DOMAIN_CONFIG.fieldCategories;
const CAT_LABELS = DOMAIN_CONFIG.fieldCatLabels;
const CAT_ICONS = DOMAIN_CONFIG.fieldCatIcons;
const CAT_COLORS = DOMAIN_CONFIG.fieldCatColors;
const OBS_CAT_LABELS = DOMAIN_CONFIG.obsCatLabels;
const OBS_CAT_COLORS = DOMAIN_CONFIG.obsCatColors;

/* ═══════════════════ ORG ROLES & TYPES ═══════════════════ */
const ORG_ROLES = DOMAIN_CONFIG.orgRoles;
const ORG_ROLE_LABELS = DOMAIN_CONFIG.orgRoleLabels;
const ORG_TYPES = DOMAIN_CONFIG.orgTypes;
const ORG_TYPE_LABELS = DOMAIN_CONFIG.orgTypeLabels;
const OPACITY_LEVELS = DOMAIN_CONFIG.opacityLevels;
const OPACITY_LABELS = DOMAIN_CONFIG.opacityLabels;
const OPACITY_DESCRIPTIONS = DOMAIN_CONFIG.opacityDescriptions;
const MSG_ACCESS_DEFAULTS = DOMAIN_CONFIG.msgAccessDefaults;
const TERMINOLOGY_DEFAULTS = DOMAIN_CONFIG.terminologyDefaults;
const RELATIONSHIP_TYPES = DOMAIN_CONFIG.relationshipTypes;

/* ═══════════════════ DEFAULT RESOURCE TYPES (§Resource Build §11) ═══════════════════
 * Seed data for initial deployment. Created as draft maturity, optional propagation,
 * so networks can adopt and promote them through governance rather than having them imposed.
 * Loaded when a network is created. Network coordinator sees these in the catalog.
 * ════════════════════════════════════════════════════════════════════════════════════════ */
const DEFAULT_RESOURCE_TYPES = [
  { id: 'rtype_bus_voucher',       name: 'Bus Voucher',           category: 'transportation', unit: 'voucher',  fungible: true,  perishable: true,  ttl_days: 90,  tags: ['transit'] },
  { id: 'rtype_gas_card',          name: 'Gas Card',              category: 'transportation', unit: 'card',     fungible: true,  perishable: false, tags: ['transit','fuel'] },
  { id: 'rtype_ride_voucher',      name: 'Ride Voucher',          category: 'transportation', unit: 'ride',     fungible: true,  perishable: true,  ttl_days: 30,  tags: ['transit','rideshare'] },
  { id: 'rtype_emergency_fund',    name: 'Emergency Fund',        category: 'financial',      unit: 'dollars',  fungible: true,  perishable: false, tags: ['emergency','cash'] },
  { id: 'rtype_rental_assist',     name: 'Rental Assistance',     category: 'financial',      unit: 'dollars',  fungible: true,  perishable: false, tags: ['rent','housing'] },
  { id: 'rtype_deposit_assist',    name: 'Deposit Assistance',    category: 'financial',      unit: 'dollars',  fungible: true,  perishable: false, tags: ['deposit','housing'] },
  { id: 'rtype_shelter_bed',       name: 'Shelter Bed Night',     category: 'housing',        unit: 'night',    fungible: true,  perishable: true,  ttl_days: 1,   tags: ['shelter','emergency'] },
  { id: 'rtype_housing_voucher',   name: 'Housing Voucher',       category: 'housing',        unit: 'voucher',  fungible: false, perishable: true,  ttl_days: 120, tags: ['voucher','permanent'] },
  { id: 'rtype_transitional_bed',  name: 'Transitional Bed',      category: 'housing',        unit: 'night',    fungible: true,  perishable: true,  ttl_days: 1,   tags: ['transitional'] },
  { id: 'rtype_hygiene_kit',       name: 'Hygiene Kit',           category: 'health',         unit: 'kit',      fungible: true,  perishable: false, tags: ['hygiene','supplies'] },
  { id: 'rtype_prescription',      name: 'Prescription Assist',   category: 'health',         unit: 'fill',     fungible: false, perishable: false, tags: ['rx','medical'] },
  { id: 'rtype_meal',              name: 'Meal',                  category: 'food',           unit: 'meal',     fungible: true,  perishable: true,  ttl_days: 1,   tags: ['meal','hot'] },
  { id: 'rtype_grocery_card',      name: 'Grocery Card',          category: 'food',           unit: 'card',     fungible: true,  perishable: false, tags: ['grocery','card'] },
  { id: 'rtype_pantry_bag',        name: 'Pantry Bag',            category: 'food',           unit: 'bag',      fungible: true,  perishable: true,  ttl_days: 7,   tags: ['pantry','dry goods'] },
  { id: 'rtype_legal_consult',     name: 'Legal Consultation',    category: 'legal',          unit: 'hour',     fungible: true,  perishable: false, tags: ['legal','consultation'] },
  { id: 'rtype_doc_prep',          name: 'Document Preparation',  category: 'legal',          unit: 'session',  fungible: true,  perishable: false, tags: ['legal','documents'] },
  { id: 'rtype_job_training',      name: 'Job Training Slot',     category: 'employment',     unit: 'slot',     fungible: false, perishable: true,  ttl_days: 30,  tags: ['training','job'] },
  { id: 'rtype_interview_clothes', name: 'Interview Clothing',    category: 'employment',     unit: 'set',      fungible: true,  perishable: false, tags: ['clothing','interview'] },
  { id: 'rtype_school_supplies',   name: 'School Supplies',       category: 'education',      unit: 'kit',      fungible: true,  perishable: false, tags: ['school','supplies'] },
  { id: 'rtype_tutoring',          name: 'Tutoring Session',      category: 'education',      unit: 'hour',     fungible: true,  perishable: false, tags: ['tutoring','education'] },
];

/* ═══════════════════ FRAMEWORK BINDINGS (§C.2) ═══════════════════ */
// Multi-framework value mappings: same observation value → different classifications
// under different institutional frameworks. This is the GIVEN → MEANT crossing made explicit.
const FRAMEWORK_BINDINGS = {
  sleep_location: {
    prompt_id: 'prompt_sleep_location',
    prompt_key: 'sleep_location',
    question: 'Where did you sleep last night?',
    bindings: {
      vehicle: {
        local_label: 'Car, van, or RV',
        frameworks: [
          { id: 'fb_vehicle_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 — Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: '§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services',
            eo_chain: [
              {op:'CON',desc:'sleep_location → hud:hmis_3.12'},
              {op:'SYN',desc:'vehicle → code_7'},
              {op:'CON',desc:'code_7 → 24cfr578.3(b)(1)'}
            ],
            eo_compact: 'CON(sleep_location → hud:hmis_3.12) → SYN(vehicle → code_7)'
          },
          { id: 'fb_vehicle_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: '§3.2 Unsheltered prioritization',
            classification: 'Priority 1 — Immediate outreach',
            classification_code: 'priority_1',
            implication: 'Assigned to next available outreach team',
            eo_chain: [
              {op:'CON',desc:'sleep_location → coc:outreach_priority'},
              {op:'SYN',desc:'vehicle → priority_1'}
            ],
            eo_compact: 'CON(sleep_location → coc:outreach_priority) → SYN(vehicle → priority_1)'
          },
          { id: 'fb_vehicle_pit',
            authority_id: 'auth_hud_hmis_ds',
            authority_name: 'PIT Count Methodology',
            authority_org: 'HUD Exchange',
            authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
            provision: 'PIT Unsheltered Definition',
            classification: 'Unsheltered',
            classification_code: 'unsheltered',
            implication: 'Counted in unsheltered PIT total',
            eo_chain: [
              {op:'CON',desc:'sleep_location → pit:shelter_status'},
              {op:'SYN',desc:'vehicle → unsheltered'}
            ],
            eo_compact: 'CON(sleep_location → pit:shelter_status) → SYN(vehicle → unsheltered)'
          }
        ]
      },
      encampment: {
        local_label: 'Tent or encampment',
        frameworks: [
          { id: 'fb_encampment_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 — Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: '§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services',
            eo_chain: [{op:'CON',desc:'sleep_location → hud:hmis_3.12'},{op:'SYN',desc:'encampment → code_16'}],
            eo_compact: 'CON → SYN(encampment → code_16)'
          },
          { id: 'fb_encampment_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: '§3.2',
            classification: 'Priority 1 — Immediate outreach',
            classification_code: 'priority_1',
            implication: 'Assigned to next available outreach team',
            eo_chain: [{op:'CON',desc:'sleep_location → coc:outreach_priority'},{op:'SYN',desc:'encampment → priority_1'}],
            eo_compact: 'CON → SYN(encampment → priority_1)'
          },
          { id: 'fb_encampment_pit',
            authority_id: 'auth_hud_hmis_ds',
            authority_name: 'PIT Count Methodology',
            authority_org: 'HUD Exchange',
            authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
            provision: 'PIT Unsheltered Definition',
            classification: 'Unsheltered',
            classification_code: 'unsheltered',
            implication: 'Counted in unsheltered PIT total',
            eo_chain: [{op:'CON',desc:'sleep_location → pit:shelter_status'},{op:'SYN',desc:'encampment → unsheltered'}],
            eo_compact: 'CON → SYN(encampment → unsheltered)'
          }
        ]
      },
      unsheltered: {
        local_label: 'Street, park, or unsheltered',
        frameworks: [
          { id: 'fb_unsheltered_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 — Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: '§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services',
            eo_chain: [{op:'CON',desc:'sleep_location → hud:hmis_3.12'},{op:'SYN',desc:'unsheltered → code_16'},{op:'SEG',desc:'collapsed with encampment'}],
            eo_compact: 'CON → SYN(unsheltered → code_16) → SEG(collapsed)'
          },
          { id: 'fb_unsheltered_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: '§3.1 Street prioritization',
            classification: 'Priority 1 — Immediate outreach',
            classification_code: 'priority_1',
            implication: 'Highest priority — immediate deployment',
            eo_chain: [{op:'CON',desc:'sleep_location → coc:outreach_priority'},{op:'SYN',desc:'unsheltered → priority_1'}],
            eo_compact: 'CON → SYN(unsheltered → priority_1)'
          }
        ]
      },
      shelter: {
        local_label: 'Emergency shelter',
        frameworks: [
          { id: 'fb_shelter_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 — Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: '§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services',
            eo_chain: [{op:'CON',desc:'sleep_location → hud:hmis_3.12'},{op:'SYN',desc:'shelter → code_3'}],
            eo_compact: 'CON → SYN(shelter → code_3)'
          },
          { id: 'fb_shelter_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: '§4.1 Sheltered services',
            classification: 'Priority 3 — Sheltered, active case',
            classification_code: 'priority_3',
            implication: 'Maintain current case management',
            eo_chain: [{op:'CON',desc:'sleep_location → coc:outreach_priority'},{op:'SYN',desc:'shelter → priority_3'}],
            eo_compact: 'CON → SYN(shelter → priority_3)'
          },
          { id: 'fb_shelter_pit',
            authority_id: 'auth_hud_hmis_ds',
            authority_name: 'PIT Count Methodology',
            authority_org: 'HUD Exchange',
            authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
            provision: 'PIT Sheltered Definition',
            classification: 'Sheltered — Emergency Shelter',
            classification_code: 'sheltered_es',
            implication: 'Counted in sheltered PIT total',
            eo_chain: [{op:'CON',desc:'sleep_location → pit:shelter_status'},{op:'SYN',desc:'shelter → sheltered_es'}],
            eo_compact: 'CON → SYN(shelter → sheltered_es)'
          }
        ]
      },
      own_housing: {
        local_label: 'Own apartment or house (with lease)',
        frameworks: [
          { id: 'fb_own_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 — Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: 'N/A — Not homeless',
            classification: 'Not Homeless (Housed)',
            classification_code: 'housed',
            implication: 'Not eligible for CoC homeless services',
            eo_chain: [{op:'CON',desc:'sleep_location → hud:hmis_3.12'},{op:'SYN',desc:'own_housing → code_1'}],
            eo_compact: 'CON → SYN(own_housing → code_1)'
          },
          { id: 'fb_own_coc',
            authority_id: 'auth_local_coc',
            authority_name: 'Local CoC Outreach Priority',
            authority_org: 'CoC',
            authority_uri: 'local://coc/outreach-policy-2025',
            provision: '§5.1 Housed monitoring',
            classification: 'No Priority — Housed',
            classification_code: 'no_priority',
            implication: 'No outreach needed',
            eo_chain: [{op:'CON',desc:'sleep_location → coc:outreach_priority'},{op:'SYN',desc:'own_housing → no_priority'}],
            eo_compact: 'CON → SYN(own_housing → no_priority)'
          }
        ]
      },
      transitional: {
        local_label: 'Transitional housing',
        frameworks: [
          { id: 'fb_trans_hud',
            authority_id: 'auth_hud_578_3',
            authority_name: '24 CFR 578.3 — Homeless Definition',
            authority_org: 'HUD',
            authority_uri: 'https://www.ecfr.gov/current/title-24/subtitle-B/chapter-V/subchapter-C/part-578/subpart-A/section-578.3',
            provision: '§578.3(b)(1)',
            classification: 'Literally Homeless (Category 1)',
            classification_code: 'cat_1',
            implication: 'Eligible for CoC-funded services (in TH program)',
            eo_chain: [{op:'CON',desc:'sleep_location → hud:hmis_3.12'},{op:'SYN',desc:'transitional → code_4'}],
            eo_compact: 'CON → SYN(transitional → code_4)'
          },
          { id: 'fb_trans_pit',
            authority_id: 'auth_hud_hmis_ds',
            authority_name: 'PIT Count Methodology',
            authority_org: 'HUD Exchange',
            authority_uri: 'https://hudexchange.info/programs/hdx/pit-hic/',
            provision: 'PIT Sheltered Definition',
            classification: 'Sheltered — Transitional Housing',
            classification_code: 'sheltered_th',
            implication: 'Counted in sheltered PIT total (TH)',
            eo_chain: [{op:'CON',desc:'sleep_location → pit:shelter_status'},{op:'SYN',desc:'transitional → sheltered_th'}],
            eo_compact: 'CON → SYN(transitional → sheltered_th)'
          }
        ]
      }
    }
  }
};

// Framework accent colors — secondary per-framework color for visual distinction
const FRAMEWORK_COLORS = {
  'auth_hud_578_3': {accent:'blue',label:'HUD'},
  'auth_hud_hmis_ds': {accent:'teal',label:'HMIS'},
  'auth_local_coc': {accent:'orange',label:'CoC'},
  'auth_211_airs': {accent:'green',label:'AIRS'},
  'auth_org_policy': {accent:'purple',label:'Org Policy'},
};

/* ═══════════════════ FRAMEWORK FIELD STANDARDS (§C.3) ═══════════════════
 * Built-in data field frameworks from established standards. Each framework
 * defines a set of vault fields tagged to authoritative URIs. Users toggle
 * frameworks on/off — enabled framework fields appear in the vault alongside
 * built-in and custom fields. The URI linkage gives every field an objective,
 * externally-verifiable semantic meaning (the MEANT side of the GIVEN/MEANT
 * divide). The observation value is GIVEN; the framework tag is what it MEANS.
 * ═══════════════════════════════════════════════════════════════════════════ */
const FRAMEWORK_FIELD_STANDARDS = [
  // 1. vCard (RFC 6350) — Core identity & contact interchange
  {
    id: 'ffs_vcard',
    name: 'vCard',
    spec: 'RFC 6350',
    uri: 'https://datatracker.ietf.org/doc/html/rfc6350',
    description: 'Contact & identity interchange format',
    domain: 'Person / Identity',
    accent: 'blue',
    fields: [
      {key:'vcard_nickname', label:'Nickname', category:'identity', sensitive:false, property:'NICKNAME', uri:'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.3'},
      {key:'vcard_prefix', label:'Name Prefix', category:'identity', sensitive:false, property:'N.prefix', uri:'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.2'},
      {key:'vcard_suffix', label:'Name Suffix', category:'identity', sensitive:false, property:'N.suffix', uri:'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.2'},
      {key:'vcard_gender', label:'Gender', category:'identity', sensitive:false, property:'GENDER', uri:'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.7'},
      {key:'vcard_language', label:'Preferred Language', category:'details', sensitive:false, property:'LANG', uri:'https://datatracker.ietf.org/doc/html/rfc6350#section-6.4.4'},
      {key:'vcard_bday', label:'Birthday', category:'identity', sensitive:true, property:'BDAY', uri:'https://datatracker.ietf.org/doc/html/rfc6350#section-6.2.5'},
    ]
  },
  // 2. Schema.org Person — Structured linked-data person
  {
    id: 'ffs_schema_person',
    name: 'Schema.org Person',
    spec: 'Schema.org',
    uri: 'https://schema.org/Person',
    description: 'Linked-data person identification',
    domain: 'Person / Identity',
    accent: 'teal',
    fields: [
      {key:'schema_given_name', label:'Given Name', category:'identity', sensitive:false, property:'givenName', uri:'https://schema.org/givenName'},
      {key:'schema_family_name', label:'Family Name', category:'identity', sensitive:false, property:'familyName', uri:'https://schema.org/familyName'},
      {key:'schema_additional_name', label:'Middle / Additional Name', category:'identity', sensitive:false, property:'additionalName', uri:'https://schema.org/additionalName'},
      {key:'schema_nationality', label:'Nationality', category:'details', sensitive:false, property:'nationality', uri:'https://schema.org/nationality'},
      {key:'schema_job_title', label:'Job Title', category:'details', sensitive:false, property:'jobTitle', uri:'https://schema.org/jobTitle'},
      {key:'schema_works_for', label:'Works For', category:'details', sensitive:false, property:'worksFor', uri:'https://schema.org/worksFor'},
    ]
  },
  // 3. HL7 FHIR Patient — Healthcare interoperability
  {
    id: 'ffs_fhir_patient',
    name: 'FHIR Patient',
    spec: 'HL7 FHIR R4',
    uri: 'https://www.hl7.org/fhir/patient.html',
    description: 'Healthcare patient resource',
    domain: 'Healthcare',
    accent: 'green',
    fields: [
      {key:'fhir_marital_status', label:'Marital Status', category:'details', sensitive:false, property:'maritalStatus', uri:'https://www.hl7.org/fhir/patient-definitions.html#Patient.maritalStatus'},
      {key:'fhir_communication_lang', label:'Communication Language', category:'details', sensitive:false, property:'communication.language', uri:'https://www.hl7.org/fhir/patient-definitions.html#Patient.communication.language'},
      {key:'fhir_general_practitioner', label:'General Practitioner', category:'case', sensitive:false, property:'generalPractitioner', uri:'https://www.hl7.org/fhir/patient-definitions.html#Patient.generalPractitioner'},
      {key:'fhir_emergency_contact', label:'Emergency Contact', category:'contact', sensitive:true, property:'contact', uri:'https://www.hl7.org/fhir/patient-definitions.html#Patient.contact'},
      {key:'fhir_medical_record_num', label:'Medical Record Number', category:'sensitive', sensitive:true, property:'identifier', uri:'https://www.hl7.org/fhir/patient-definitions.html#Patient.identifier'},
    ]
  },
  // 4. NIEM Person — Government demographics
  {
    id: 'ffs_niem_person',
    name: 'NIEM Person',
    spec: 'NIEM 6.0',
    uri: 'https://niem.github.io/niem-releases/',
    description: 'National information exchange demographics',
    domain: 'Government',
    accent: 'purple',
    fields: [
      {key:'niem_race', label:'Race', category:'identity', sensitive:true, property:'PersonRaceCode', uri:'https://niem.github.io/niem-releases/'},
      {key:'niem_ethnicity', label:'Ethnicity', category:'identity', sensitive:true, property:'PersonEthnicityCode', uri:'https://niem.github.io/niem-releases/'},
      {key:'niem_sex', label:'Sex', category:'identity', sensitive:false, property:'PersonSexCode', uri:'https://niem.github.io/niem-releases/'},
      {key:'niem_height', label:'Height', category:'details', sensitive:false, property:'PersonHeightMeasure', uri:'https://niem.github.io/niem-releases/'},
      {key:'niem_weight', label:'Weight', category:'details', sensitive:false, property:'PersonWeightMeasure', uri:'https://niem.github.io/niem-releases/'},
      {key:'niem_eye_color', label:'Eye Color', category:'details', sensitive:false, property:'PersonEyeColorCode', uri:'https://niem.github.io/niem-releases/'},
      {key:'niem_hair_color', label:'Hair Color', category:'details', sensitive:false, property:'PersonHairColorCode', uri:'https://niem.github.io/niem-releases/'},
    ]
  },
  // 5. Schema.org PostalAddress — Structured address
  {
    id: 'ffs_postal_address',
    name: 'PostalAddress',
    spec: 'Schema.org',
    uri: 'https://schema.org/PostalAddress',
    description: 'Structured postal address fields',
    domain: 'Address / Location',
    accent: 'orange',
    fields: [
      {key:'addr_street', label:'Street Address', category:'contact', sensitive:true, property:'streetAddress', uri:'https://schema.org/streetAddress'},
      {key:'addr_locality', label:'City / Locality', category:'contact', sensitive:false, property:'addressLocality', uri:'https://schema.org/addressLocality'},
      {key:'addr_region', label:'State / Region', category:'contact', sensitive:false, property:'addressRegion', uri:'https://schema.org/addressRegion'},
      {key:'addr_postal_code', label:'Postal Code', category:'contact', sensitive:false, property:'postalCode', uri:'https://schema.org/postalCode'},
      {key:'addr_country', label:'Country', category:'contact', sensitive:false, property:'addressCountry', uri:'https://schema.org/addressCountry'},
    ]
  },
  // 6. HR Open Standards — Employment & candidate data
  {
    id: 'ffs_hr_open',
    name: 'HR Open',
    spec: 'HR Open Standards',
    uri: 'https://hropenstandards.org/',
    description: 'Employment history & credentials',
    domain: 'Employment / HR',
    accent: 'gold',
    fields: [
      {key:'hr_employer', label:'Employer Name', category:'details', sensitive:false, property:'EmployerName', uri:'https://hropenstandards.org/'},
      {key:'hr_title', label:'Employment Title', category:'details', sensitive:false, property:'Title', uri:'https://hropenstandards.org/'},
      {key:'hr_start_date', label:'Employment Start', category:'details', sensitive:false, property:'StartDate', uri:'https://hropenstandards.org/'},
      {key:'hr_end_date', label:'Employment End', category:'details', sensitive:false, property:'EndDate', uri:'https://hropenstandards.org/'},
      {key:'hr_certifications', label:'Certifications', category:'details', sensitive:false, property:'Certifications', uri:'https://hropenstandards.org/'},
      {key:'hr_degree', label:'Degree', category:'details', sensitive:false, property:'Degree', uri:'https://hropenstandards.org/'},
    ]
  },
  // 7. CEDS — Education data
  {
    id: 'ffs_ceds',
    name: 'CEDS',
    spec: 'Common Education Data Standards',
    uri: 'https://ceds.ed.gov/',
    description: 'Education enrollment & assessment',
    domain: 'Education',
    accent: 'blue',
    fields: [
      {key:'ceds_school', label:'School Name', category:'details', sensitive:false, property:'SchoolId', uri:'https://ceds.ed.gov/'},
      {key:'ceds_grade', label:'Grade Level', category:'details', sensitive:false, property:'GradeLevel', uri:'https://ceds.ed.gov/'},
      {key:'ceds_enrollment_date', label:'Enrollment Date', category:'details', sensitive:false, property:'EntryDate', uri:'https://ceds.ed.gov/'},
      {key:'ceds_english_learner', label:'English Learner Status', category:'details', sensitive:false, property:'EnglishLearnerStatus', uri:'https://ceds.ed.gov/'},
      {key:'ceds_disability', label:'Disability Status', category:'sensitive', sensitive:true, property:'DisabilityStatus', uri:'https://ceds.ed.gov/'},
    ]
  },
  // 8. RESO Data Dictionary — Housing & property
  {
    id: 'ffs_reso',
    name: 'RESO',
    spec: 'RESO Data Dictionary',
    uri: 'https://www.reso.org/data-dictionary/',
    description: 'Real estate & housing data',
    domain: 'Real Estate / Property',
    accent: 'orange',
    fields: [
      {key:'reso_property_type', label:'Property Type', category:'details', sensitive:false, property:'PropertyType', uri:'https://ddwiki.reso.org/'},
      {key:'reso_bedrooms', label:'Bedrooms', category:'details', sensitive:false, property:'BedroomsTotal', uri:'https://ddwiki.reso.org/'},
      {key:'reso_rent', label:'Monthly Rent', category:'sensitive', sensitive:true, property:'ListPrice', uri:'https://ddwiki.reso.org/'},
      {key:'reso_lease_start', label:'Lease Start', category:'details', sensitive:false, property:'ListingContractDate', uri:'https://ddwiki.reso.org/'},
      {key:'reso_lease_end', label:'Lease End', category:'details', sensitive:false, property:'CloseDate', uri:'https://ddwiki.reso.org/'},
      {key:'reso_landlord', label:'Landlord / Manager', category:'contact', sensitive:true, property:'ListAgentKey', uri:'https://ddwiki.reso.org/'},
    ]
  },
  // 9. ISO 20022 — Financial data
  {
    id: 'ffs_iso20022',
    name: 'ISO 20022',
    spec: 'ISO 20022',
    uri: 'https://www.iso20022.org/',
    description: 'Financial messaging & account data',
    domain: 'Finance',
    accent: 'green',
    fields: [
      {key:'fin_income_source', label:'Income Source', category:'sensitive', sensitive:true, property:'Debtor', uri:'https://www.iso20022.org/'},
      {key:'fin_monthly_income', label:'Monthly Income', category:'sensitive', sensitive:true, property:'InstructedAmount', uri:'https://www.iso20022.org/'},
      {key:'fin_bank_name', label:'Bank Name', category:'sensitive', sensitive:true, property:'DebtorAgent', uri:'https://www.iso20022.org/'},
      {key:'fin_benefits', label:'Benefits Received', category:'details', sensitive:false, property:'RemittanceInformation', uri:'https://www.iso20022.org/'},
    ]
  },
  // 10. NIEM Justice — Court & legal records
  {
    id: 'ffs_niem_justice',
    name: 'NIEM Justice',
    spec: 'NIEM Justice Domain',
    uri: 'https://release.niem.gov/niem/domains/justice/',
    description: 'Court cases, charges & sentencing',
    domain: 'Legal / Court',
    accent: 'purple',
    fields: [
      {key:'justice_case_number', label:'Case Number', category:'case', sensitive:true, property:'CaseNumberText', uri:'https://release.niem.gov/niem/domains/justice/'},
      {key:'justice_case_status', label:'Court Case Status', category:'case', sensitive:false, property:'CaseStatusText', uri:'https://release.niem.gov/niem/domains/justice/'},
      {key:'justice_court', label:'Court Name', category:'case', sensitive:false, property:'CourtName', uri:'https://release.niem.gov/niem/domains/justice/'},
      {key:'justice_charge', label:'Charge Description', category:'sensitive', sensitive:true, property:'ChargeDescriptionText', uri:'https://release.niem.gov/niem/domains/justice/'},
      {key:'justice_probation_officer', label:'Probation / Parole Officer', category:'case', sensitive:false, property:'SupervisionPerson', uri:'https://release.niem.gov/niem/domains/justice/'},
    ]
  },
  // 11. Dublin Core — Record & document metadata
  {
    id: 'ffs_dublin_core',
    name: 'Dublin Core',
    spec: 'ISO 15836',
    uri: 'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/',
    description: 'Document & record metadata',
    domain: 'Bibliographic / Metadata',
    accent: 'gold',
    fields: [
      {key:'dc_title', label:'Case Title', category:'case', sensitive:false, property:'title', uri:'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#title'},
      {key:'dc_description', label:'Case Description', category:'case', sensitive:false, property:'description', uri:'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#description'},
      {key:'dc_creator', label:'Record Creator', category:'case', sensitive:false, property:'creator', uri:'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#creator'},
      {key:'dc_date', label:'Date Created', category:'case', sensitive:false, property:'date', uri:'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#date'},
      {key:'dc_rights', label:'Rights / Consent Scope', category:'case', sensitive:false, property:'rights', uri:'https://www.dublincore.org/specifications/dublin-core/dcmi-terms/#rights'},
    ]
  },
  // 12. GeoJSON (RFC 7946) — Geographic coordinates
  {
    id: 'ffs_geojson',
    name: 'GeoJSON',
    spec: 'RFC 7946',
    uri: 'https://datatracker.ietf.org/doc/html/rfc7946',
    description: 'Geographic coordinates & geometry',
    domain: 'Geospatial',
    accent: 'teal',
    fields: [
      {key:'geo_latitude', label:'Latitude', category:'contact', sensitive:true, property:'coordinates[1]', uri:'https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.1'},
      {key:'geo_longitude', label:'Longitude', category:'contact', sensitive:true, property:'coordinates[0]', uri:'https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.1'},
      {key:'geo_service_area', label:'Service Area', category:'details', sensitive:false, property:'Polygon', uri:'https://datatracker.ietf.org/doc/html/rfc7946#section-3.1.6'},
    ]
  },
];

// Lookup: framework id → framework object (for fast field tagging)
const FRAMEWORK_BY_ID = {};
FRAMEWORK_FIELD_STANDARDS.forEach(fw => { FRAMEWORK_BY_ID[fw.id] = fw; });

// Build framework fields for a set of enabled framework ids
function getFrameworkFields(enabledIds) {
  const fields = [];
  const seen = new Set();
  for (const fwId of enabledIds) {
    const fw = FRAMEWORK_BY_ID[fwId];
    if (!fw) continue;
    for (const f of fw.fields) {
      if (seen.has(f.key)) continue;
      seen.add(f.key);
      fields.push({...f, framework: fw.id, frameworkName: fw.name, frameworkUri: fw.uri});
    }
  }
  return fields;
}

/* ═══════════════════ ANONYMIZATION (§B.2) ═══════════════════ */
function anonymizeField(key, value) {
  const t = DEFAULT_TRANSFORMS[key];
  if (!t) return {key, value};
  if (t.method === 'block') return null;
  if (t.method === 'age_range' && value) {
    const age = Math.floor((Date.now()-new Date(value).getTime())/(365.25*24*60*60*1000));
    const bucket = t.buckets.find(b => {const [lo,hi]=b.split('-').map(Number);return age>=lo&&(!hi||age<=hi);});
    return {key:'age_range', value:bucket||'unknown'};
  }
  if (t.method === 'bracket' && value) {
    const num = parseFloat(String(value).replace(/[^0-9.]/g,''));
    const bucket = t.buckets.find(b => {const p=b.replace(/k/g,'000').split('-');return num>=parseFloat(p[0])&&(!p[1]||num<parseFloat(p[1]));});
    return {key:'bracket', value:bucket||t.buckets[t.buckets.length-1]};
  }
  if (t.method === 'area_hash') return {key:'geo', value:value?`area_${Math.abs([...value].reduce((h,c)=>((h<<5)-h+c.charCodeAt(0))|0,0)).toString(36).slice(0,6)}`:null};
  return {key, value};
}

async function emitMetric(metricsRoom, clientId, observation, demographics, program) {
  const hash = await cohortHash(clientId);
  const anonDemo = {};
  for (const [k,v] of Object.entries(demographics||{})) {
    const a = anonymizeField(k,v);
    if (a) anonDemo[a.key] = a.value;
  }
  const metric = { cohort_hash:hash, observation, demographics:anonDemo, program:program||'general', ts:Date.now() };
  await svc.sendEvent(metricsRoom, EVT.METRIC, metric);
  return metric;
}

/* ═══════════════════ RESOURCE TRACKING SERVICE (§Resource Build) ═══════════════════
 * Core resource tracking infrastructure. Resources (beds, vouchers, funds, services) are
 * tracked across three levels — network, org, individual — using the existing room topology.
 *
 * Design principles:
 * 1. A resource is a relational configuration, not a fixed entity.
 * 2. Client sovereignty: vault shadow records are the client's inviolable record.
 * 3. Every resource has an opacity level (default SOVEREIGN) controlled by the holder.
 * 4. Governance hooks carry provenance metadata for every policy and constraint.
 * 5. All mutations emit EO operations — no silent state changes.
 * ════════════════════════════════════════════════════════════════════════════════════════ */

/** Generate unique resource IDs */
function genResourceId(prefix) {
  return `${prefix}_${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`;
}

/** Build a default source/provenance block for a resource type */
function buildResourceSource(level, propagation, adoptedVia, proposedBy, originOrg) {
  const src = { level };
  if (level === 'network' && propagation) src.propagation = propagation;
  if (adoptedVia) src.adopted_via = adoptedVia;
  if (proposedBy) src.proposed_by = proposedBy;
  if (originOrg) src.origin_org = originOrg;
  src.adopted_at = Date.now();
  return src;
}

/** Build a governance metadata block for a constraint */
function buildConstraintGovernance(sourceLevel, propagation, adoptedVia, divergenceAllowed) {
  return {
    propagation: propagation || 'optional',
    adopted_via: adoptedVia || null,
    source_level: sourceLevel || 'org',
    divergence_allowed: divergenceAllowed !== false,
  };
}

/* ─── Constraint Validation (§10) ─── */

/**
 * Validate a proposed allocation against resource type constraints, policies,
 * and existing allocations. Returns { valid, violations[] } where each violation
 * includes governance provenance for contestability.
 */
function validateAllocation(allocationData, resourceType, policies, existingAllocations, callerRole) {
  const violations = [];

  // Merge constraints: resource type constraints + standalone policies
  const constraints = { ...(resourceType.constraints || {}) };
  for (const policy of (policies || [])) {
    if (policy.resource_type_id === resourceType.id) {
      Object.assign(constraints, policy.constraints || {});
    }
  }

  // CHECK 1: eligible_roles
  if (constraints.eligible_roles && constraints.eligible_roles.length > 0) {
    if (!constraints.eligible_roles.includes(callerRole)) {
      violations.push({
        check: 'eligible_roles',
        message: `Role '${callerRole}' is not authorized to allocate this resource. Authorized roles: ${constraints.eligible_roles.join(', ')}`,
        governance: constraints.governance || null,
      });
    }
  }

  // CHECK 2: max_per_client
  if (constraints.max_per_client != null) {
    const periodMs = (constraints.period_days || 365) * 24 * 60 * 60 * 1000;
    const cutoff = Date.now() - periodMs;
    const activeCount = (existingAllocations || []).filter(a =>
      a.resource_type_id === resourceType.id &&
      a.allocated_to === allocationData.allocated_to &&
      a.status === 'active' &&
      a.allocated_at >= cutoff
    ).length;
    if (activeCount + 1 > constraints.max_per_client) {
      violations.push({
        check: 'max_per_client',
        message: `Client already has ${activeCount} active allocation(s) of ${resourceType.name} within the ${constraints.period_days || 365}-day period (max: ${constraints.max_per_client})${constraints.governance?.adopted_via ? `, adopted via ${constraints.governance.adopted_via}` : ''}`,
        governance: constraints.governance || null,
      });
    }
  }

  // CHECK 3: requires_approval
  if (constraints.requires_approval) {
    const needsApproval = constraints.approval_threshold
      ? (allocationData.quantity * 1) > constraints.approval_threshold
      : true;
    if (needsApproval && !allocationData.approval) {
      violations.push({
        check: 'requires_approval',
        message: `This allocation requires approval${constraints.approval_threshold ? ` (amount exceeds threshold of ${constraints.approval_threshold})` : ''}. Approver roles: ${(constraints.approver_roles || ['admin']).join(', ')}`,
        governance: constraints.governance || null,
      });
    }
  }

  // CHECK 4: inventory availability (advisory, not blocking)
  // Logged but does not prevent allocation in emergency situations

  // CHECK 5: perishable TTL (informational)
  // Computed at allocation time, not a blocking constraint

  return { valid: violations.length === 0, violations };
}

/* ─── Resource Service ─── */

const ResourceService = {

  /* ═══ 5.1 Resource Type Management ═══ */

  /**
   * Create a resource type in the catalog (network or org room).
   * Emits DES operation. Returns event ID.
   */
  async createResourceType(roomId, typeData, roomType) {
    const level = roomType === 'network' ? 'network' : 'org';
    if (level === 'network' && !typeData.source?.propagation) {
      throw new Error('Network-level resource types require a propagation level');
    }

    const resourceType = {
      id: typeData.id || genResourceId('rtype'),
      name: typeData.name,
      category: typeData.category,
      unit: typeData.unit,
      fungible: typeData.fungible !== false,
      perishable: typeData.perishable || false,
      ttl_days: typeData.ttl_days || null,
      tags: typeData.tags || [],
      source: typeData.source || buildResourceSource(level, typeData.propagation),
      maturity: typeData.maturity || 'draft',
      constraints: typeData.constraints || null,
    };

    // Validate category
    if (!RESOURCE_CATEGORIES.includes(resourceType.category)) {
      throw new Error(`Invalid resource category: ${resourceType.category}. Must be one of: ${RESOURCE_CATEGORIES.join(', ')}`);
    }

    // Write state event
    await svc.setState(roomId, EVT.RESOURCE_TYPE, resourceType, resourceType.id);

    // Emit DES operation
    await emitOp(roomId, 'DES',
      { entity: resourceType.id, designation: resourceType.name },
      { category: resourceType.category, unit: resourceType.unit, source_level: level },
      { type: roomType === 'network' ? 'network' : 'org', room: roomId, epistemic: 'GIVEN' }
    );

    return resourceType;
  },

  /**
   * Update an existing resource type. Emits ALT for each changed field.
   * If propagation level changes, requires adopted_via reference (governance action).
   */
  async updateResourceType(roomId, typeId, changes, roomType) {
    const existing = await svc.getState(roomId, EVT.RESOURCE_TYPE, typeId);
    if (!existing) throw new Error(`Resource type ${typeId} not found`);

    // Check if propagation is changing (governance action)
    if (changes.source?.propagation && changes.source.propagation !== existing.source?.propagation) {
      if (!changes.source.adopted_via) {
        throw new Error('Changing propagation level is a governance action — adopted_via reference required');
      }
    }

    const updated = { ...existing, ...changes };
    await svc.setState(roomId, EVT.RESOURCE_TYPE, updated, typeId);

    // Emit ALT for each changed field
    for (const [key, val] of Object.entries(changes)) {
      if (JSON.stringify(existing[key]) !== JSON.stringify(val)) {
        await emitOp(roomId, 'ALT',
          { field: `resource_type.${key}`, entity: typeId },
          { from: existing[key], to: val },
          { type: roomType === 'network' ? 'network' : 'org', room: roomId, epistemic: 'GIVEN' }
        );
      }
    }

    return updated;
  },

  /**
   * Propagate a resource type from network room to org room.
   * Respects propagation levels: required (immutable), standard (extendable),
   * recommended (visible), optional (catalog only).
   */
  async propagateResourceType(networkRoomId, orgRoomId, typeId) {
    const networkType = await svc.getState(networkRoomId, EVT.RESOURCE_TYPE, typeId);
    if (!networkType) throw new Error(`Resource type ${typeId} not found in network room`);

    const orgType = {
      ...networkType,
      source: {
        ...networkType.source,
        level: 'network',
        origin_org: null, // came from network, not from an org
      },
    };

    const propagation = networkType.source?.propagation || 'optional';

    if (propagation === 'required' || propagation === 'standard') {
      await svc.setState(orgRoomId, EVT.RESOURCE_TYPE, orgType, typeId);
    } else if (propagation === 'recommended') {
      // Write to org as draft — visible but not active until adopted
      orgType.maturity = orgType.maturity === 'normative' ? orgType.maturity : 'draft';
      await svc.setState(orgRoomId, EVT.RESOURCE_TYPE, orgType, typeId);
    }
    // 'optional': do nothing — org browses network catalog manually

    // Emit CON operation for the propagation relationship
    await emitOp(orgRoomId, 'CON',
      { source: networkRoomId, dest: orgRoomId, relation: 'propagates' },
      { type_id: typeId, propagation },
      { type: 'org', room: orgRoomId, epistemic: 'GIVEN' }
    );

    return orgType;
  },

  /* ═══ 5.2 Resource Relations ═══ */

  /**
   * Establish a relation between an org and a resource type.
   * Defaults opacity to SOVEREIGN (0). Emits CON operation.
   */
  async establishRelation(orgRoomId, relationData) {
    if (!RESOURCE_RELATION_TYPES.includes(relationData.relation_type)) {
      throw new Error(`Invalid relation type: ${relationData.relation_type}. Must be one of: ${RESOURCE_RELATION_TYPES.join(', ')}`);
    }

    const relation = {
      id: relationData.id || genResourceId('rrel'),
      resource_type_id: relationData.resource_type_id,
      holder: orgRoomId,
      relation_type: relationData.relation_type,
      target: relationData.target || null,
      capacity: relationData.capacity || 0,
      available: relationData.available ?? relationData.capacity ?? 0,
      constraints_override: relationData.constraints_override || null,
      // Opacity defaults to SOVEREIGN
      opacity: relationData.opacity ?? RESOURCE_OPACITY.SOVEREIGN,
      disclosed_fields: relationData.disclosed_fields || null,
      attested_to: relationData.attested_to || null,
      // Provenance
      established_at: Date.now(),
      established_by: svc.userId,
      funding_source: relationData.funding_source || null,
      notes: relationData.notes || null,
      // Dedup starts null
      dedup: null,
    };

    await svc.setState(orgRoomId, EVT.RESOURCE_RELATION, relation, relation.id);

    // Emit CON operation
    await emitOp(orgRoomId, 'CON',
      { source: orgRoomId, dest: relation.resource_type_id, relation: relation.relation_type },
      { relation_id: relation.id, capacity: relation.capacity },
      { type: 'org', room: orgRoomId, epistemic: 'GIVEN' }
    );

    // Initialize inventory for this relation
    if (relation.capacity > 0) {
      await this.restockInventory(orgRoomId, relation.id, relation.capacity, { initial: true });
    }

    return relation;
  },

  /**
   * Update opacity level on a resource relation.
   * Validates caller is org admin. Emits SEG operation.
   */
  async updateRelationOpacity(orgRoomId, relationId, newOpacity, disclosedFields, attestedTo) {
    const relation = await svc.getState(orgRoomId, EVT.RESOURCE_RELATION, relationId);
    if (!relation) throw new Error(`Relation ${relationId} not found`);

    const oldOpacity = relation.opacity;
    relation.opacity = newOpacity;

    // Validate opacity-specific requirements
    if (newOpacity === RESOURCE_OPACITY.ATTESTED) {
      if (!attestedTo || attestedTo.length === 0) {
        throw new Error('ATTESTED opacity requires attestedTo list of bridge room IDs');
      }
      relation.attested_to = attestedTo;
    }
    if (newOpacity >= RESOURCE_OPACITY.CONTRIBUTED) {
      relation.disclosed_fields = disclosedFields || ['resource_type_id', 'capacity', 'available', 'relation_type'];
    }

    await svc.setState(orgRoomId, EVT.RESOURCE_RELATION, relation, relationId);

    // Write opacity state event
    await svc.setState(orgRoomId, EVT.RESOURCE_OPACITY, {
      relation_id: relationId,
      opacity: newOpacity,
      previous_opacity: oldOpacity,
      disclosed_fields: relation.disclosed_fields,
      attested_to: relation.attested_to,
      changed_by: svc.userId,
      changed_at: Date.now(),
    }, relationId);

    // Emit SEG operation
    await emitOp(orgRoomId, 'SEG',
      { relation: relationId, opacity: newOpacity, disclosed_fields: relation.disclosed_fields },
      { from_opacity: oldOpacity, to_opacity: newOpacity, direction: newOpacity > oldOpacity ? 'disclosure' : 'withdrawal' },
      { type: 'org', room: orgRoomId, epistemic: 'MEANT' }
    );

    return relation;
  },

  /* ═══ 5.3 Inventory Management ═══ */

  /**
   * Restock inventory for a resource relation.
   * Adds quantity to total_capacity and available. Emits INS operation.
   */
  async restockInventory(orgRoomId, relationId, quantity, metadata) {
    const existing = await svc.getState(orgRoomId, EVT.RESOURCE_INVENTORY, relationId);
    const now = Date.now();

    const inventory = existing ? {
      ...existing,
      total_capacity: existing.total_capacity + quantity,
      available: existing.available + quantity,
      last_restocked: now,
      last_updated: now,
    } : {
      resource_type_id: null, // will be filled from relation
      relation_id: relationId,
      total_capacity: quantity,
      available: quantity,
      allocated: 0,
      reserved: 0,
      last_restocked: now,
      last_updated: now,
    };

    // Fill resource_type_id from relation if not set
    if (!inventory.resource_type_id) {
      const relation = await svc.getState(orgRoomId, EVT.RESOURCE_RELATION, relationId);
      if (relation) inventory.resource_type_id = relation.resource_type_id;
    }

    await svc.setState(orgRoomId, EVT.RESOURCE_INVENTORY, inventory, relationId);

    // Emit INS operation
    await emitOp(orgRoomId, 'INS',
      { field: 'inventory', entity: relationId },
      { quantity, total_capacity: inventory.total_capacity, available: inventory.available, metadata },
      { type: 'org', room: orgRoomId, epistemic: 'GIVEN' }
    );

    return inventory;
  },

  /**
   * Adjust inventory for write-offs, corrections, or manual adjustments.
   * Emits ALT operation with reason.
   */
  async adjustInventory(orgRoomId, relationId, adjustment, reason) {
    const inventory = await svc.getState(orgRoomId, EVT.RESOURCE_INVENTORY, relationId);
    if (!inventory) throw new Error(`No inventory found for relation ${relationId}`);

    inventory.total_capacity += adjustment;
    inventory.available += adjustment;
    inventory.last_updated = Date.now();

    // Prevent negatives
    if (inventory.available < 0) inventory.available = 0;
    if (inventory.total_capacity < 0) inventory.total_capacity = 0;

    await svc.setState(orgRoomId, EVT.RESOURCE_INVENTORY, inventory, relationId);

    await emitOp(orgRoomId, 'ALT',
      { field: 'inventory', entity: relationId },
      { adjustment, reason, available: inventory.available, total_capacity: inventory.total_capacity },
      { type: 'org', room: orgRoomId, epistemic: 'GIVEN' }
    );

    return inventory;
  },

  /* ═══ 5.4 Resource Allocation (Critical Path) ═══ */

  /**
   * Allocate a resource to a client. Writes to THREE places:
   * 1. Bridge room (allocation state event)
   * 2. Client vault (shadow record)
   * 3. Org room (inventory decrement)
   *
   * Returns { allocation, bridgeEventId, vaultEventId, inventoryEventId }
   */
  async allocateResource(bridgeRoomId, allocationData, orgRoomId, vaultRoomId) {
    // STEP 1: Validate constraints
    const resourceType = await svc.getState(orgRoomId, EVT.RESOURCE_TYPE, allocationData.resource_type_id);
    if (!resourceType) throw new Error(`Resource type ${allocationData.resource_type_id} not found`);

    // Load applicable policies from org room
    const policies = [];
    if (svc.client) {
      const room = svc.client.getRoom(orgRoomId);
      if (room) {
        const stateEvents = room.currentState.getStateEvents(EVT.RESOURCE_POLICY);
        if (stateEvents) {
          for (const ev of (Array.isArray(stateEvents) ? stateEvents : [stateEvents])) {
            if (ev && ev.getContent) policies.push(ev.getContent());
          }
        }
      }
    }

    // Load existing allocations for this client from bridge room
    const existingAllocations = [];
    if (svc.client) {
      const room = svc.client.getRoom(bridgeRoomId);
      if (room) {
        const allocEvents = room.currentState.getStateEvents(EVT.RESOURCE_ALLOC);
        if (allocEvents) {
          for (const ev of (Array.isArray(allocEvents) ? allocEvents : [allocEvents])) {
            if (ev && ev.getContent) existingAllocations.push(ev.getContent());
          }
        }
      }
    }

    // Determine caller's org role
    const orgRoster = await svc.getState(orgRoomId, EVT.ORG_ROSTER);
    const staffEntry = orgRoster?.staff?.find(s => s.userId === svc.userId);
    const callerRole = staffEntry?.role || 'provider';

    const validation = validateAllocation(allocationData, resourceType, policies, existingAllocations, callerRole);
    if (!validation.valid) {
      return { valid: false, violations: validation.violations };
    }

    // STEP 2: Write allocation to bridge room
    const allocation = {
      id: allocationData.id || genResourceId('ralloc'),
      resource_type_id: allocationData.resource_type_id,
      relation_id: allocationData.relation_id,
      quantity: allocationData.quantity,
      unit: resourceType.unit,
      allocated_by: svc.userId,
      allocated_to: allocationData.allocated_to,
      org_id: orgRoomId,
      status: 'active',
      allocated_at: Date.now(),
      expires_at: resourceType.perishable && resourceType.ttl_days
        ? Date.now() + (resourceType.ttl_days * 24 * 60 * 60 * 1000)
        : null,
      notes: allocationData.notes || null,
      approval: allocationData.approval || null,
    };

    await svc.setState(bridgeRoomId, EVT.RESOURCE_ALLOC, allocation, allocation.id);

    // Emit INS operation for bridge allocation
    await emitOp(bridgeRoomId, 'INS',
      { field: 'allocation', entity: allocation.id },
      { resource_type: resourceType.name, quantity: allocation.quantity, unit: allocation.unit },
      { type: 'bridge', room: bridgeRoomId, epistemic: 'GIVEN' }
    );

    // STEP 3: Write shadow record to client vault
    // Denormalized intentionally — vault must be readable even if bridge is severed
    const orgMeta = await svc.getState(orgRoomId, EVT.ORG_METADATA);
    const vaultRecord = {
      allocation_id: allocation.id,
      resource_type_id: allocation.resource_type_id,
      resource_name: resourceType.name,
      quantity: allocation.quantity,
      unit: allocation.unit,
      provider_display_name: svc.userId, // Matrix user ID as fallback display
      org_display_name: orgMeta?.name || orgRoomId,
      allocated_at: allocation.allocated_at,
      status: 'active',
      notes: allocationData.notes || null,
      bridge_room_id: bridgeRoomId,
      source_event_id: allocation.id,
    };

    try {
      await svc.setState(vaultRoomId, EVT.RESOURCE_VAULT, vaultRecord, allocation.id);

      // Emit INS operation for vault shadow
      await emitOp(vaultRoomId, 'INS',
        { field: 'vault_record', entity: allocation.id },
        { resource_name: resourceType.name, quantity: allocation.quantity },
        { type: 'vault', room: vaultRoomId, epistemic: 'GIVEN' }
      );
    } catch (e) {
      // If vault write fails, log error — bridge allocation is source of truth.
      // Background reconciliation can fix missing vault shadows.
      console.error(`[ResourceService] Vault shadow write failed for allocation ${allocation.id}:`, e.message);
    }

    // STEP 4: Decrement inventory
    try {
      const inventory = await svc.getState(orgRoomId, EVT.RESOURCE_INVENTORY, allocation.relation_id);
      if (inventory) {
        inventory.available = Math.max(0, inventory.available - allocation.quantity);
        inventory.allocated = (inventory.allocated || 0) + allocation.quantity;
        inventory.last_updated = Date.now();
        await svc.setState(orgRoomId, EVT.RESOURCE_INVENTORY, inventory, allocation.relation_id);

        await emitOp(orgRoomId, 'ALT',
          { field: 'inventory.available', entity: allocation.relation_id },
          { decremented_by: allocation.quantity, available: inventory.available, allocated: inventory.allocated },
          { type: 'org', room: orgRoomId, epistemic: 'GIVEN' }
        );
      }
    } catch (e) {
      // Inventory sync failure should never block allocation.
      console.error(`[ResourceService] Inventory decrement failed for relation ${allocation.relation_id}:`, e.message);
    }

    return { valid: true, allocation };
  },

  /* ═══ 5.5 Resource Lifecycle Events ═══ */

  /**
   * Record a lifecycle event (consumed, expired, revoked, returned).
   * Updates allocation state, vault shadow, and inventory.
   */
  async recordResourceEvent(bridgeRoomId, eventData, orgRoomId, vaultRoomId) {
    const event = {
      allocation_id: eventData.allocation_id,
      event: eventData.event,
      quantity: eventData.quantity,
      recorded_by: svc.userId,
      recorded_at: Date.now(),
      notes: eventData.notes || null,
    };

    // Validate event type
    if (!RESOURCE_LIFECYCLE_EVENTS.includes(event.event)) {
      throw new Error(`Invalid lifecycle event: ${event.event}`);
    }

    // Send timeline event to bridge room (NOT state — lifecycle events are append-only)
    await svc.sendEvent(bridgeRoomId, EVT.RESOURCE_EVENT, event);

    // Update allocation state event
    const allocation = await svc.getState(bridgeRoomId, EVT.RESOURCE_ALLOC, event.allocation_id);
    if (allocation) {
      const newStatus = event.event === 'consumed' ? 'consumed'
        : event.event === 'expired' ? 'expired'
        : event.event === 'revoked' ? 'revoked'
        : allocation.status;
      allocation.status = newStatus;
      await svc.setState(bridgeRoomId, EVT.RESOURCE_ALLOC, allocation, event.allocation_id);
    }

    // Update vault shadow record status
    if (vaultRoomId) {
      try {
        const vaultRecord = await svc.getState(vaultRoomId, EVT.RESOURCE_VAULT, event.allocation_id);
        if (vaultRecord) {
          vaultRecord.status = allocation?.status || event.event;
          await svc.setState(vaultRoomId, EVT.RESOURCE_VAULT, vaultRecord, event.allocation_id);
        }
      } catch (e) {
        console.error(`[ResourceService] Vault shadow update failed for ${event.allocation_id}:`, e.message);
      }
    }

    // Adjust inventory based on event type
    if (orgRoomId && allocation?.relation_id) {
      try {
        const inventory = await svc.getState(orgRoomId, EVT.RESOURCE_INVENTORY, allocation.relation_id);
        if (inventory) {
          switch (event.event) {
            case 'consumed':
              // Partial consumption: decrement allocated
              inventory.allocated = Math.max(0, inventory.allocated - event.quantity);
              break;
            case 'expired':
              // Expired: decrement allocated, do NOT increment available (resource is gone)
              inventory.allocated = Math.max(0, inventory.allocated - event.quantity);
              break;
            case 'revoked':
              // Revoked: decrement allocated, increment available (resource reclaimed)
              inventory.allocated = Math.max(0, inventory.allocated - event.quantity);
              inventory.available += event.quantity;
              break;
            case 'returned':
              // Returned: decrement allocated, increment available
              inventory.allocated = Math.max(0, inventory.allocated - event.quantity);
              inventory.available += event.quantity;
              break;
          }
          inventory.last_updated = Date.now();
          await svc.setState(orgRoomId, EVT.RESOURCE_INVENTORY, inventory, allocation.relation_id);
        }
      } catch (e) {
        console.error(`[ResourceService] Inventory adjustment failed for lifecycle event:`, e.message);
      }
    }

    // Emit appropriate EO operation
    const eoOp = event.event === 'revoked' ? 'NUL' : 'ALT';
    const eoTarget = event.event === 'revoked'
      ? { field: 'allocation', entity: event.allocation_id }
      : { field: 'status', entity: event.allocation_id };

    await emitOp(bridgeRoomId, eoOp, eoTarget,
      { event: event.event, quantity: event.quantity },
      { type: 'bridge', room: bridgeRoomId, epistemic: 'GIVEN' }
    );

    return event;
  },

  /* ═══ 5.6 Automated Expiry ═══ */

  /**
   * Check for expired allocations across bridge rooms.
   * For each expired allocation: emit lifecycle event, update status, adjust inventory.
   */
  async checkExpiredAllocations(bridgeRoomIds, orgRoomId, vaultRoomId) {
    const now = Date.now();
    const expired = [];

    for (const bridgeRoomId of bridgeRoomIds) {
      if (!svc.client) continue;
      const room = svc.client.getRoom(bridgeRoomId);
      if (!room) continue;

      const allocEvents = room.currentState.getStateEvents(EVT.RESOURCE_ALLOC);
      if (!allocEvents) continue;

      const allocs = Array.isArray(allocEvents) ? allocEvents : [allocEvents];
      for (const ev of allocs) {
        const alloc = ev.getContent ? ev.getContent() : ev;
        if (alloc.status === 'active' && alloc.expires_at && alloc.expires_at < now) {
          try {
            await this.recordResourceEvent(bridgeRoomId, {
              allocation_id: alloc.id,
              event: 'expired',
              quantity: alloc.quantity,
              notes: 'Automatic expiry',
            }, orgRoomId, vaultRoomId);
            expired.push(alloc.id);
          } catch (e) {
            console.error(`[ResourceService] Auto-expiry failed for ${alloc.id}:`, e.message);
          }
        }
      }
    }

    return expired;
  },

  /* ═══ 5.7 Deduplication Detection ═══ */

  /**
   * Detect potential overlaps among CONTRIBUTED resource relations.
   * Groups by resource_type_id + capacity range overlap.
   * Does NOT auto-merge — surfaces candidates for human review.
   */
  async detectPotentialOverlaps(networkRoomId) {
    const netMembers = await svc.getState(networkRoomId, EVT.NET_MEMBERS);
    if (!netMembers?.organizations) return [];

    const contributedRelations = [];

    for (const org of netMembers.organizations) {
      const orgRoomId = org.roomId;
      if (!svc.client) continue;
      const room = svc.client.getRoom(orgRoomId);
      if (!room) continue;

      const relEvents = room.currentState.getStateEvents(EVT.RESOURCE_RELATION);
      if (!relEvents) continue;

      const rels = Array.isArray(relEvents) ? relEvents : [relEvents];
      for (const ev of rels) {
        const rel = ev.getContent ? ev.getContent() : ev;
        // Only consider CONTRIBUTED or PUBLISHED relations
        if (rel.opacity >= RESOURCE_OPACITY.CONTRIBUTED) {
          contributedRelations.push({ ...rel, _org_room: orgRoomId, _org_name: org.name || orgRoomId });
        }
      }
    }

    // Group by resource_type_id
    const groups = {};
    for (const rel of contributedRelations) {
      const key = rel.resource_type_id;
      if (!groups[key]) groups[key] = [];
      groups[key].push(rel);
    }

    // Find clusters with 2+ relations (potential overlaps)
    const candidates = [];
    for (const [typeId, rels] of Object.entries(groups)) {
      if (rels.length < 2) continue;

      // Check if already resolved
      const unresolvedPairs = [];
      for (let i = 0; i < rels.length; i++) {
        for (let j = i + 1; j < rels.length; j++) {
          const a = rels[i], b = rels[j];
          const aResolved = a.dedup?.linked_to === b.id && a.dedup?.link_status !== 'unresolved';
          const bResolved = b.dedup?.linked_to === a.id && b.dedup?.link_status !== 'unresolved';
          if (!aResolved && !bResolved) {
            unresolvedPairs.push({ a, b });
          }
        }
      }

      if (unresolvedPairs.length > 0) {
        candidates.push({
          resource_type_id: typeId,
          relations: rels,
          unresolved_pairs: unresolvedPairs,
          total_capacity_range: {
            min: Math.min(...rels.map(r => r.capacity || 0)),
            max: rels.reduce((sum, r) => sum + (r.capacity || 0), 0),
          },
        });
      }
    }

    return candidates;
  },

  /**
   * Record a dedup resolution between two resource relations.
   * Emits CON (confirmed), DES (attested_non_additive), or SUP (unresolved).
   */
  async resolveDedup(orgRoomId, relationId, resolution) {
    const relation = await svc.getState(orgRoomId, EVT.RESOURCE_RELATION, relationId);
    if (!relation) throw new Error(`Relation ${relationId} not found`);

    relation.dedup = {
      linked_to: resolution.linked_to || null,
      link_type: resolution.link_type || null,
      link_status: resolution.link_status,
      link_resolved_by: svc.userId,
      link_resolved_at: Date.now(),
    };

    await svc.setState(orgRoomId, EVT.RESOURCE_RELATION, relation, relationId);

    // Emit appropriate EO operation
    switch (resolution.link_status) {
      case 'confirmed':
        await emitOp(orgRoomId, 'CON',
          { source: relationId, dest: resolution.linked_to, link_type: resolution.link_type },
          { resolution: 'confirmed_overlap' },
          { type: 'org', room: orgRoomId, epistemic: 'MEANT' }
        );
        break;
      case 'attested_non_additive':
        await emitOp(orgRoomId, 'DES',
          { entity: relationId, designation: 'non_additive' },
          { resolution: 'attested_non_additive' },
          { type: 'org', room: orgRoomId, epistemic: 'MEANT' }
        );
        break;
      case 'unresolved':
        await emitOp(orgRoomId, 'SUP',
          { entities: [relationId, resolution.linked_to], superposition: 'potential_overlap' },
          { resolution: 'unresolved' },
          { type: 'org', room: orgRoomId, epistemic: 'MEANT' }
        );
        break;
    }

    return relation;
  },

  /* ═══ 5.8 Upward Promotion (Org → Network) ═══ */

  /**
   * Propose promoting an org-level resource type to network level.
   * Creates a governance proposal event (same format as schema proposals).
   */
  async proposeResourceTypePromotion(networkRoomId, orgRoomId, typeId, proposedPropagation) {
    const orgType = await svc.getState(orgRoomId, EVT.RESOURCE_TYPE, typeId);
    if (!orgType) throw new Error(`Resource type ${typeId} not found in org room`);

    const proposal = {
      id: genResourceId('prop'),
      type: 'resource_type_promotion',
      summary: `Promote "${orgType.name}" (${orgType.category}) from org to network catalog`,
      resource_type: orgType,
      target_propagation: proposedPropagation || 'optional',
      origin_org: orgRoomId,
      proposed_by: svc.userId,
      proposed_at: Date.now(),
      status: 'submitted',
      positions: {},
    };

    await svc.setState(networkRoomId, EVT.GOV_PROPOSAL, proposal, proposal.id);

    // Emit REC operation (recentering from org to network)
    await emitOp(networkRoomId, 'REC',
      { entity: typeId, recentered_from: 'org', to: 'network' },
      { proposal_id: proposal.id, org_room: orgRoomId, propagation: proposedPropagation },
      { type: 'network', room: networkRoomId, epistemic: 'MEANT' }
    );

    return proposal;
  },

  /* ═══ §6 Propagation Service Extensions ═══ */

  /**
   * Handle resource type propagation from network to member orgs.
   * Called by the propagation service when a RESOURCE_TYPE event is received.
   */
  async handleResourceTypePropagation(networkRoomId, event) {
    const netMembers = await svc.getState(networkRoomId, EVT.NET_MEMBERS);
    if (!netMembers?.organizations) return;

    const typeData = event;
    const propagation = typeData.source?.propagation || 'optional';

    for (const org of netMembers.organizations) {
      const orgRoomId = org.roomId;
      try {
        if (propagation === 'required') {
          // Auto-apply, immutable
          await this.propagateResourceType(networkRoomId, orgRoomId, typeData.id);
        } else if (propagation === 'standard') {
          // Auto-apply, notify org admin
          await this.propagateResourceType(networkRoomId, orgRoomId, typeData.id);
          // Notification would be sent here (via existing notification system)
        } else if (propagation === 'recommended') {
          // Write to org catalog as visible but not active
          await this.propagateResourceType(networkRoomId, orgRoomId, typeData.id);
        }
        // 'optional': do nothing
      } catch (e) {
        console.error(`[ResourceService] Propagation to ${orgRoomId} failed for ${typeData.id}:`, e.message);
      }
    }
  },

  /**
   * Handle resource policy propagation from network to member orgs.
   * Policies propagate alongside the resource types they govern.
   */
  async handleResourcePolicyPropagation(networkRoomId, policyData) {
    const netMembers = await svc.getState(networkRoomId, EVT.NET_MEMBERS);
    if (!netMembers?.organizations) return;

    const propagation = policyData.governance?.propagation || 'optional';

    for (const org of netMembers.organizations) {
      const orgRoomId = org.roomId;
      try {
        if (propagation === 'required' || propagation === 'standard') {
          const stateKey = `${policyData.resource_type_id}:${policyData.rule_type || 'default'}`;
          await svc.setState(orgRoomId, EVT.RESOURCE_POLICY, policyData, stateKey);
        }
      } catch (e) {
        console.error(`[ResourceService] Policy propagation to ${orgRoomId} failed:`, e.message);
      }
    }
  },

  /* ═══ §7 Opacity Propagation Logic ═══ */

  /**
   * Handle opacity change events. Propagates visibility to appropriate rooms.
   * SOVEREIGN → ATTESTED: write projection to listed bridge rooms
   * → CONTRIBUTED: write projection to network resource commons
   * → PUBLISHED: requires governance approval
   * Downgrade: remove projections from appropriate rooms
   */
  async handleOpacityChange(orgRoomId, relationId, newOpacity, oldOpacity, relation) {
    // Build projection (only disclosed fields)
    const disclosedFields = relation.disclosed_fields || ['resource_type_id', 'capacity', 'available', 'relation_type'];
    const projection = {};
    for (const field of disclosedFields) {
      if (relation[field] !== undefined) projection[field] = relation[field];
    }
    projection._source_org = orgRoomId;
    projection._source_relation = relationId;
    projection._projected_at = Date.now();

    if (newOpacity > oldOpacity) {
      // Upgrading opacity — disclosing more

      if (newOpacity >= RESOURCE_OPACITY.ATTESTED && relation.attested_to) {
        // Write projection to listed bridge rooms
        for (const bridgeRoomId of relation.attested_to) {
          try {
            await svc.setState(bridgeRoomId, EVT.RESOURCE_RELATION, projection, `proj_${relationId}`);
          } catch (e) {
            console.error(`[ResourceService] Bridge projection failed for ${bridgeRoomId}:`, e.message);
          }
        }
      }

      if (newOpacity >= RESOURCE_OPACITY.CONTRIBUTED) {
        // Contributed to network — trigger dedup detection
        // The projection is already on the org room; network reads from org rooms
      }

      if (newOpacity >= RESOURCE_OPACITY.PUBLISHED) {
        // Published — would require governance approval check
        // Deferred to governance integration phase
      }
    } else if (newOpacity < oldOpacity) {
      // Downgrading opacity — withdrawing disclosure

      if (oldOpacity >= RESOURCE_OPACITY.ATTESTED && newOpacity < RESOURCE_OPACITY.ATTESTED) {
        // Remove projections from bridge rooms
        if (relation.attested_to) {
          for (const bridgeRoomId of relation.attested_to) {
            try {
              await svc.setState(bridgeRoomId, EVT.RESOURCE_RELATION, { _withdrawn: true, _source_relation: relationId }, `proj_${relationId}`);
            } catch (e) {
              console.error(`[ResourceService] Bridge projection withdrawal failed:`, e.message);
            }
          }
        }
      }

      // Emit NUL on withdrawn projections
      await emitOp(orgRoomId, 'NUL',
        { field: 'resource_projection', entity: relationId },
        { from_opacity: oldOpacity, to_opacity: newOpacity, withdrawn: true },
        { type: 'org', room: orgRoomId, epistemic: 'MEANT' }
      );
    }
  },

  /* ═══ §9 Anonymized Resource Metrics ═══ */

  /**
   * Emit an anonymized resource metric from an allocation.
   * Follows the existing metrics anonymization pipeline.
   * Strips PII, buckets amounts, hashes cohort.
   */
  async emitResourceMetric(metricsRoomId, allocation, resourceType, clientId) {
    const hash = await cohortHash(clientId);

    // Bucket quantity for anonymization
    const qty = allocation.quantity;
    let quantityBucket;
    if (qty <= 1) quantityBucket = '1';
    else if (qty <= 5) quantityBucket = '2-5';
    else if (qty <= 10) quantityBucket = '6-10';
    else if (qty <= 25) quantityBucket = '11-25';
    else if (qty <= 50) quantityBucket = '26-50';
    else if (qty <= 100) quantityBucket = '51-100';
    else quantityBucket = '100+';

    const now = new Date();
    const period = `${now.getFullYear()}-Q${Math.floor(now.getMonth() / 3) + 1}`;

    const metric = {
      cohort_hash: hash,
      resource_category: resourceType.category, // category, not specific type
      quantity_bucket: quantityBucket,
      period,
      ts: Date.now(),
      type: 'resource', // distinguishes from observation metrics
    };

    await svc.sendEvent(metricsRoomId, EVT.METRIC, metric);

    return metric;
  },

  /**
   * Emit a network aggregate resource metric.
   * k-anonymity: suppress if fewer than 5 clients in a bucket.
   */
  async emitResourceAggregate(networkMetricsRoomId, orgMetrics) {
    // Group by category + period
    const aggregates = {};
    for (const m of orgMetrics) {
      const key = `${m.resource_category}:${m.period}`;
      if (!aggregates[key]) {
        aggregates[key] = { resource_category: m.resource_category, period: m.period, cohorts: new Set(), total: 0, org_count: 0 };
      }
      aggregates[key].cohorts.add(m.cohort_hash);
      aggregates[key].total++;
    }

    const emitted = [];
    for (const [, agg] of Object.entries(aggregates)) {
      // k-anonymity: suppress if fewer than 5 distinct cohorts
      if (agg.cohorts.size < 5) continue;

      // Bucket total
      const total = agg.total;
      let totalBucket;
      if (total <= 10) totalBucket = '1-10';
      else if (total <= 50) totalBucket = '11-50';
      else if (total <= 100) totalBucket = '51-100';
      else if (total <= 500) totalBucket = '101-500';
      else totalBucket = '500+';

      const aggregate = {
        resource_category: agg.resource_category,
        total_bucket: totalBucket,
        period: agg.period,
        org_count: agg.org_count,
        type: 'resource',
        ts: Date.now(),
      };

      await svc.sendEvent(networkMetricsRoomId, EVT.METRIC_AGG, aggregate);
      emitted.push(aggregate);
    }

    return emitted;
  },

  /* ═══ Seed Data Loader ═══ */

  /**
   * Load default resource types into a network room.
   * All seed types are created as draft maturity, optional propagation.
   */
  async loadSeedResourceTypes(networkRoomId) {
    const loaded = [];
    for (const seed of DEFAULT_RESOURCE_TYPES) {
      try {
        const existing = await svc.getState(networkRoomId, EVT.RESOURCE_TYPE, seed.id);
        if (existing) continue; // Already loaded

        const typeData = {
          ...seed,
          source: buildResourceSource('network', 'optional', null, svc.userId),
          maturity: 'draft',
          constraints: null,
        };
        const created = await this.createResourceType(networkRoomId, typeData, 'network');
        loaded.push(created);
      } catch (e) {
        console.error(`[ResourceService] Failed to load seed type ${seed.id}:`, e.message);
      }
    }
    return loaded;
  },
};

/* ═══════════════════ CLIENT DATA IMPORT ENGINE ═══════════════════
 * Parses CSV/JSON files, maps columns to vault fields, encrypts each
 * record with its own AES-256-GCM key, creates a client_record room
 * per row, and emits only anonymized demographic metrics.
 *
 * PII GUARANTEE: Reports only ever contain demographic ranges
 * (age buckets, area hashes, counts). Raw PII (names, DOBs, SSNs,
 * addresses, emails, phones) are either blocked or bucketed before
 * any metric is emitted. The per-record encryption key is stored in
 * the E2EE room state — only room members can access it.
 * ═══════════════════════════════════════════════════════════════════ */

// ── CSV Parser ──
// Handles quoted fields, embedded commas, and multi-line values.
function parseCSV(text) {
  const lines = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') { inQuotes = !inQuotes; current += ch; }
    else if (ch === '\n' && !inQuotes) { lines.push(current); current = ''; }
    else if (ch === '\r' && !inQuotes) { /* skip CR */ }
    else { current += ch; }
  }
  if (current.trim()) lines.push(current);
  if (lines.length < 2) throw new Error('CSV must have a header row and at least one data row');

  function parseLine(line) {
    const fields = [];
    let field = '';
    let q = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') { if (q && line[i + 1] === '"') { field += '"'; i++; } else { q = !q; } }
      else if (ch === ',' && !q) { fields.push(field.trim()); field = ''; }
      else { field += ch; }
    }
    fields.push(field.trim());
    return fields;
  }

  const headers = parseLine(lines[0]);
  const records = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const vals = parseLine(lines[i]);
    const record = {};
    headers.forEach((h, j) => { if (vals[j] !== undefined && vals[j] !== '') record[h] = vals[j]; });
    records.push(record);
  }
  return { headers, records };
}

// ── JSON Parser ──
// Accepts an array of objects or { records: [...] } / { data: [...] }
function parseJSONImport(text) {
  const data = JSON.parse(text);
  const records = Array.isArray(data) ? data : (data.records || data.data || []);
  if (!Array.isArray(records) || records.length === 0) throw new Error('JSON must contain an array of record objects');
  const headers = [...new Set(records.flatMap(r => Object.keys(r)))];
  return { headers, records };
}

// ── Column auto-mapping ──
// Maps common CSV/JSON header names to VAULT_FIELDS keys.
const IMPORT_COLUMN_ALIASES = {
  'name':'full_name','full_name':'full_name','fullname':'full_name','client_name':'full_name','client name':'full_name',
  'first_name':'_first_name','last_name':'_last_name','firstname':'_first_name','lastname':'_last_name',
  'dob':'dob','date_of_birth':'dob','birthdate':'dob','birth_date':'dob','birthday':'dob','date of birth':'dob',
  'ssn':'id_number','id':'id_number','id_number':'id_number','social_security':'id_number','social':'id_number',
  'email':'email','email_address':'email','e-mail':'email',
  'phone':'phone','phone_number':'phone','mobile':'phone','telephone':'phone','cell':'phone',
  'address':'address','street_address':'address','home_address':'address','street':'address','mailing_address':'address',
  'organization':'affiliation','affiliation':'affiliation','org':'affiliation','agency':'affiliation','employer':'affiliation',
  'notes':'case_notes','case_notes':'case_notes','comments':'case_notes','case notes':'case_notes',
  'history':'history','case_history':'history','case history':'history',
};

function autoMapColumns(sourceHeaders) {
  const mapping = {};
  for (const h of sourceHeaders) {
    const normalized = h.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
    const alias = IMPORT_COLUMN_ALIASES[normalized] || IMPORT_COLUMN_ALIASES[h.toLowerCase().trim()];
    if (alias && !alias.startsWith('_')) mapping[h] = alias;
  }
  return mapping;
}

// ── Per-record encryption + room creation ──
// Creates one client_record room per row. Each record gets a unique
// AES-256-GCM key. Only anonymized demographics are emitted as metrics.
async function importClientRecords(records, mapping, metricsRoom, onProgress) {
  const results = { created: [], errors: [], demographics: {}, totalFields: 0 };
  const batchId = `batch_${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6)}`;
  const total = records.length;

  // Check for first_name + last_name concatenation
  const firstNameCol = Object.entries(mapping).find(([, v]) => v === '_first_name')?.[0];
  const lastNameCol = Object.entries(mapping).find(([, v]) => v === '_last_name')?.[0];

  for (let i = 0; i < total; i++) {
    try {
      const row = records[i];

      // Map source fields to vault fields
      const fields = {};
      for (const [sourceCol, vaultKey] of Object.entries(mapping)) {
        if (vaultKey.startsWith('_')) continue; // skip internal markers
        if (vaultKey && row[sourceCol] != null && String(row[sourceCol]).trim() !== '') {
          fields[vaultKey] = String(row[sourceCol]).trim();
        }
      }

      // Concatenate first + last name if mapped separately
      if (firstNameCol && lastNameCol) {
        const first = (row[firstNameCol] || '').trim();
        const last = (row[lastNameCol] || '').trim();
        if (first || last) fields['full_name'] = [first, last].filter(Boolean).join(' ');
      }

      if (Object.keys(fields).length === 0) {
        results.errors.push({ row: i + 1, error: 'No mapped fields with values' });
        onProgress({ current: i + 1, total });
        continue;
      }

      // Generate unique per-record AES-256-GCM key
      const recordKey = await FieldCrypto.generateKey();

      // Encrypt each field value individually
      const encryptedFields = {};
      for (const [key, value] of Object.entries(fields)) {
        const { ciphertext, iv } = await FieldCrypto.encrypt(value, recordKey);
        encryptedFields[key] = { ciphertext, iv };
      }

      // Generate anonymized demographics — this is the ONLY data that
      // ever appears in reports. Raw PII is blocked or bucketed.
      const anonDemo = {};
      for (const [key, value] of Object.entries(fields)) {
        const anon = anonymizeField(key, value);
        if (anon) anonDemo[anon.key] = anon.value;
      }

      // Non-PII label for room name (never store raw name in room metadata)
      const recordLabel = `Import ${batchId.slice(-4)} #${i + 1}`;

      // Create the client_record room with encrypted data
      const roomId = await svc.createRoom(
        `[Client] ${recordLabel}`,
        'Imported client record — encrypted at rest',
        [
          { type: EVT.IDENTITY, state_key: '', content: {
            account_type: 'client_record', owner: svc.userId, created: Date.now(),
            imported: true, import_batch: batchId, import_index: i,
            client_name: recordLabel, status: 'created',
          }},
          { type: EVT.CLIENT_RECORD, state_key: '', content: {
            record_key: recordKey,
            encrypted_fields: encryptedFields,
            demographics: anonDemo,
            imported_at: Date.now(),
            field_count: Object.keys(fields).length,
            import_batch: batchId,
          }},
        ]
      );

      // Emit anonymized metric — NEVER contains PII
      if (metricsRoom) {
        const hash = await cohortHash(`import_${roomId}_${batchId}`);
        await svc.sendEvent(metricsRoom, EVT.METRIC, {
          cohort_hash: hash,
          observation: { category: 'intake', value: 'imported', date_bucket: new Date().toISOString().slice(0, 7) },
          demographics: anonDemo,
          program: 'import',
          ts: Date.now(),
        });
      }

      // Accumulate demographic summary (anonymized only)
      for (const [k, v] of Object.entries(anonDemo)) {
        if (!results.demographics[k]) results.demographics[k] = {};
        results.demographics[k][v] = (results.demographics[k][v] || 0) + 1;
      }

      results.created.push({ roomId, displayName: recordLabel, fieldCount: Object.keys(fields).length });
      results.totalFields += Object.keys(fields).length;
      onProgress({ current: i + 1, total });

      // Rate-limit: pause every 2 records to avoid homeserver rate limits
      if (i % 2 === 1) await new Promise(r => setTimeout(r, 400));

    } catch (e) {
      results.errors.push({ row: i + 1, error: e.message });
      onProgress({ current: i + 1, total });
    }
  }

  // Emit import manifest to metrics room (aggregate only, no PII)
  if (metricsRoom) {
    try {
      await svc.sendEvent(metricsRoom, EVT.IMPORT_MANIFEST, {
        batch_id: batchId,
        total_records: total,
        successful: results.created.length,
        failed: results.errors.length,
        demographics_summary: results.demographics,
        ts: Date.now(),
      });
    } catch {}
  }

  return results;
}

// ── PII masking for preview display ──
// Shows first/last char with dots in between. Sensitive fields fully masked.
function maskPII(key, value) {
  if (!value || typeof value !== 'string') return '—';
  const t = DEFAULT_TRANSFORMS[key];
  if (t?.method === 'block') return '\u25CF\u25CF\u25CF\u25CF\u25CF\u25CF';
  if (t?.method === 'age_range') {
    const anon = anonymizeField(key, value);
    return anon ? `[${anon.value}]` : '\u25CF\u25CF\u25CF\u25CF';
  }
  if (t?.method === 'area_hash') {
    const anon = anonymizeField(key, value);
    return anon ? `[${anon.value}]` : '\u25CF\u25CF\u25CF\u25CF';
  }
  // Non-sensitive fields: show as-is
  const vf = VAULT_FIELDS.find(f => f.key === key);
  if (vf?.sensitive) return value.length > 2 ? value[0] + '\u25CF'.repeat(Math.min(value.length - 2, 6)) + value[value.length - 1] : '\u25CF\u25CF';
  return value;
}

/* ═══════════════════ IMPORT DATA MODAL ═══════════════════ */
const ImportDataModal = ({open, onClose, showToast, metricsRoom, onComplete}) => {
  const [step, setStep] = useState('upload');
  const [fileData, setFileData] = useState(null);
  const [mapping, setMapping] = useState({});
  const [progress, setProgress] = useState({current:0, total:0});
  const [results, setResults] = useState(null);
  const [dragOver, setDragOver] = useState(false);
  const fileRef = useRef(null);

  // Reset state when modal closes
  useEffect(() => {
    if (!open) { setStep('upload'); setFileData(null); setMapping({}); setProgress({current:0,total:0}); setResults(null); }
  }, [open]);

  const handleFile = async (file) => {
    try {
      const text = await file.text();
      const isJSON = file.name.endsWith('.json') || file.type === 'application/json';
      const parsed = isJSON ? parseJSONImport(text) : parseCSV(text);
      if (parsed.records.length === 0) throw new Error('No records found in file');
      setFileData({ ...parsed, fileName: file.name, fileType: isJSON ? 'JSON' : 'CSV' });
      // Auto-map columns
      const autoMap = autoMapColumns(parsed.headers);
      setMapping(autoMap);
      setStep('map');
    } catch (e) {
      showToast('Parse error: ' + e.message, 'error');
    }
  };

  const handleDrop = (e) => {
    e.preventDefault(); setDragOver(false);
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  };

  const mappedFieldCount = Object.values(mapping).filter(v => v && !v.startsWith('_')).length;
  const hasMappedFields = mappedFieldCount > 0;

  // Count how many columns map to each vault field (detect duplicates)
  const vaultFieldUsage = {};
  for (const v of Object.values(mapping)) {
    if (v && !v.startsWith('_')) vaultFieldUsage[v] = (vaultFieldUsage[v] || 0) + 1;
  }

  const handleImport = async () => {
    if (!fileData || !hasMappedFields) return;
    setStep('importing');
    setProgress({ current: 0, total: fileData.records.length });
    try {
      const res = await importClientRecords(
        fileData.records, mapping, metricsRoom,
        (p) => setProgress(p)
      );
      setResults(res);
      setStep('done');
      if (onComplete) onComplete(res);
    } catch (e) {
      showToast('Import failed: ' + e.message, 'error');
      setStep('preview');
    }
  };

  if (!open) return null;

  return <Modal open={open} onClose={step === 'importing' ? undefined : onClose} title="Import Client Data" w={720}>

    {/* ── STEP 1: UPLOAD ── */}
    {step === 'upload' && <div>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Upload a CSV or JSON file containing client records. Each row becomes an encrypted client room with its own AES-256-GCM key. PII is never stored in any reportable format.
      </p>
      <div onDragOver={(e)=>{e.preventDefault();setDragOver(true)}} onDragLeave={()=>setDragOver(false)} onDrop={handleDrop}
        onClick={()=>fileRef.current?.click()}
        style={{border:`2px dashed ${dragOver?'var(--gold)':'var(--border-1)'}`,borderRadius:'var(--r-lg)',
          padding:'48px 24px',textAlign:'center',cursor:'pointer',transition:'all .2s',
          background:dragOver?'var(--gold-dim)':'var(--bg-1)'}}>
        <div style={{width:48,height:48,borderRadius:'var(--r-lg)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',margin:'0 auto 14px'}}>
          <I n="upload" s={24}/>
        </div>
        <p style={{fontSize:14,fontWeight:600,marginBottom:4}}>Drop CSV or JSON file here</p>
        <p style={{fontSize:12,color:'var(--tx-2)'}}>or click to browse</p>
        <div style={{display:'flex',gap:6,justifyContent:'center',marginTop:12}}>
          <span className="tag tag-blue">.csv</span>
          <span className="tag tag-teal">.json</span>
        </div>
      </div>
      <input ref={fileRef} type="file" accept=".csv,.json,application/json,text/csv" style={{display:'none'}}
        onChange={(e)=>{if(e.target.files[0])handleFile(e.target.files[0])}}/>
      <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginTop:16,display:'flex',gap:10,alignItems:'flex-start'}}>
        <I n="shield" s={16} c="var(--teal)"/>
        <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--teal)'}}>Encryption guarantee:</strong> Each record gets a unique AES-256-GCM encryption key. PII fields (name, DOB, SSN, address, phone, email) are encrypted before storage. Reports only contain demographic ranges — never raw PII.
        </div>
      </div>
    </div>}

    {/* ── STEP 2: MAP COLUMNS ── */}
    {step === 'map' && fileData && <div>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:14}}>
        <div>
          <p style={{fontSize:12.5,fontWeight:600}}>{fileData.fileName}</p>
          <p style={{fontSize:11,color:'var(--tx-2)'}}>{fileData.fileType} · {fileData.records.length} records · {fileData.headers.length} columns</p>
        </div>
        <button onClick={()=>{setStep('upload');setFileData(null);setMapping({})}} className="b-gho b-xs">Change File</button>
      </div>

      <span className="section-label">MAP COLUMNS TO VAULT FIELDS</span>
      <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Assign each source column to a vault field. Unmapped columns are skipped. Fields marked with a lock are encrypted at rest.</p>

      <div style={{maxHeight:340,overflow:'auto',marginBottom:16}}>
        {fileData.headers.map(h => {
          const currentMapping = mapping[h] || '';
          const vf = VAULT_FIELDS.find(f => f.key === currentMapping);
          const transform = DEFAULT_TRANSFORMS[currentMapping];
          const sampleVal = fileData.records.slice(0, 3).map(r => r[h]).filter(Boolean)[0];
          return <div key={h} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 0',borderBottom:'1px solid var(--border-0)'}}>
            <div style={{flex:1,minWidth:0}}>
              <span style={{fontSize:12,fontWeight:500,display:'block'}}>{h}</span>
              {sampleVal && <span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)',display:'block',marginTop:2,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                e.g. {String(sampleVal).slice(0, 40)}{String(sampleVal).length > 40 ? '…' : ''}
              </span>}
            </div>
            <I n="chevR" s={12} c="var(--tx-3)"/>
            <div style={{flex:1,minWidth:0}}>
              <select value={currentMapping} onChange={e=>setMapping(prev=>({...prev,[h]:e.target.value}))}
                style={{width:'100%',fontSize:12,padding:'7px 10px'}}>
                <option value="">— skip —</option>
                {VAULT_FIELDS.map(f => <option key={f.key} value={f.key}>
                  {f.label}{f.sensitive ? ' 🔒' : ''}{transform?.method === 'block' ? ' (blocked in reports)' : ''}
                </option>)}
                <option value="_first_name">First Name (will combine)</option>
                <option value="_last_name">Last Name (will combine)</option>
              </select>
            </div>
            <div style={{width:60,textAlign:'center'}}>
              {currentMapping && !currentMapping.startsWith('_') && transform?.method === 'block' &&
                <span className="tag tag-red" style={{fontSize:8}}>BLOCKED</span>}
              {currentMapping && !currentMapping.startsWith('_') && transform?.method === 'age_range' &&
                <span className="tag tag-blue" style={{fontSize:8}}>RANGED</span>}
              {currentMapping && !currentMapping.startsWith('_') && vf?.sensitive &&
                <span className="tag tag-green" style={{fontSize:8}}>ENCRYPT</span>}
              {currentMapping && !currentMapping.startsWith('_') && !transform && !vf?.sensitive &&
                <span className="tag tag-teal" style={{fontSize:8}}>STORED</span>}
            </div>
          </div>;
        })}
      </div>

      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:16}}>
        <div className="card" style={{padding:12}}>
          <span className="section-label">MAPPED</span>
          <span style={{fontSize:18,fontWeight:700,color:'var(--gold)'}}>{mappedFieldCount}</span>
          <span style={{fontSize:11,color:'var(--tx-2)'}}> of {fileData.headers.length} columns</span>
        </div>
        <div className="card" style={{padding:12}}>
          <span className="section-label">REPORT VISIBILITY</span>
          <div style={{display:'flex',gap:3,flexWrap:'wrap',marginTop:4}}>
            {Object.values(mapping).filter(v=>v&&!v.startsWith('_')).map(v => {
              const t = DEFAULT_TRANSFORMS[v];
              const vf = VAULT_FIELDS.find(f=>f.key===v);
              return <span key={v} className={`tag ${t?.method==='block'?'tag-red':t?.method==='age_range'?'tag-blue':'tag-teal'}`} style={{fontSize:8}}>
                {vf?.label||v}: {t?.method==='block'?'NEVER':t?.method==='age_range'?'RANGE ONLY':'visible'}
              </span>;
            })}
          </div>
        </div>
      </div>

      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setStep('upload')} className="b-gho" style={{flex:1}}>Back</button>
        <button onClick={()=>setStep('preview')} className="b-pri" disabled={!hasMappedFields} style={{flex:2}}>
          Preview {fileData.records.length} Records
        </button>
      </div>
    </div>}

    {/* ── STEP 3: PREVIEW ── */}
    {step === 'preview' && fileData && <div>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
        Review how records will be stored. PII fields are masked below as they will be in reports. The actual data is encrypted per-record and only accessible to room members.
      </p>

      <div style={{overflowX:'auto',marginBottom:16}}>
        <table style={{width:'100%',borderCollapse:'collapse',fontSize:11.5}}>
          <thead>
            <tr style={{borderBottom:'2px solid var(--border-1)'}}>
              <th style={{padding:'8px 10px',textAlign:'left',fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-2)',letterSpacing:'.05em'}}>#</th>
              {Object.entries(mapping).filter(([,v])=>v&&!v.startsWith('_')).map(([src,vk])=>{
                const vf = VAULT_FIELDS.find(f=>f.key===vk);
                const t = DEFAULT_TRANSFORMS[vk];
                return <th key={src} style={{padding:'8px 10px',textAlign:'left',whiteSpace:'nowrap'}}>
                  <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.05em'}}>{vf?.label||vk}</span>
                  {t?.method==='block'&&<span className="tag tag-red" style={{fontSize:7,marginLeft:4}}>BLOCKED</span>}
                  {vf?.sensitive&&!t&&<span className="tag tag-green" style={{fontSize:7,marginLeft:4}}>ENC</span>}
                </th>;
              })}
              <th style={{padding:'8px 10px',textAlign:'left',fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-2)'}}>DEMOGRAPHICS</th>
            </tr>
          </thead>
          <tbody>
            {fileData.records.slice(0, 5).map((row, i) => {
              // Build mapped fields for this row
              const fields = {};
              for (const [src, vk] of Object.entries(mapping)) {
                if (vk && !vk.startsWith('_') && row[src] != null) fields[vk] = String(row[src]);
              }
              // Handle first+last name
              const fnCol = Object.entries(mapping).find(([,v])=>v==='_first_name')?.[0];
              const lnCol = Object.entries(mapping).find(([,v])=>v==='_last_name')?.[0];
              if (fnCol && lnCol) {
                const combined = [(row[fnCol]||'').trim(), (row[lnCol]||'').trim()].filter(Boolean).join(' ');
                if (combined) fields['full_name'] = combined;
              }
              // Anonymize for demographic preview
              const anonDemo = {};
              for (const [k, v] of Object.entries(fields)) {
                const anon = anonymizeField(k, v);
                if (anon) anonDemo[anon.key] = anon.value;
              }
              return <tr key={i} style={{borderBottom:'1px solid var(--border-0)'}}>
                <td style={{padding:'6px 10px',color:'var(--tx-3)',fontFamily:'var(--mono)',fontSize:10}}>{i+1}</td>
                {Object.entries(mapping).filter(([,v])=>v&&!v.startsWith('_')).map(([src,vk])=>{
                  const val = vk==='full_name'&&fields['full_name']?fields['full_name']:row[src];
                  return <td key={src} style={{padding:'6px 10px',fontSize:11,maxWidth:160,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                    {maskPII(vk, val ? String(val) : '')}
                  </td>;
                })}
                <td style={{padding:'6px 10px'}}>
                  <div style={{display:'flex',gap:3,flexWrap:'wrap'}}>
                    {Object.entries(anonDemo).map(([k,v])=>
                      <span key={k} className="tag tag-blue" style={{fontSize:8}}>{k}: {v||'—'}</span>
                    )}
                    {Object.keys(anonDemo).length===0&&<span style={{fontSize:10,color:'var(--tx-3)'}}>—</span>}
                  </div>
                </td>
              </tr>;
            })}
          </tbody>
        </table>
        {fileData.records.length > 5 && <p style={{fontSize:11,color:'var(--tx-3)',textAlign:'center',padding:8}}>
          …and {fileData.records.length - 5} more records
        </p>}
      </div>

      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:16}}>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">RECORDS</span>
          <span style={{fontSize:18,fontWeight:700,display:'block'}}>{fileData.records.length}</span>
        </div>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">ENCRYPTED FIELDS</span>
          <span style={{fontSize:18,fontWeight:700,color:'var(--green)',display:'block'}}>{mappedFieldCount}</span>
        </div>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">ROOMS TO CREATE</span>
          <span style={{fontSize:18,fontWeight:700,color:'var(--gold)',display:'block'}}>{fileData.records.length}</span>
        </div>
      </div>

      <div style={{background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginBottom:16,display:'flex',gap:10,alignItems:'flex-start'}}>
        <I n="eyeOff" s={16} c="var(--red)"/>
        <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--red)'}}>PII will NEVER appear in reports.</strong> Names, DOBs, SSNs, addresses, phones, and emails are either blocked entirely or converted to demographic ranges (age buckets, area hashes). Only anonymized aggregates flow to the metrics system.
        </div>
      </div>

      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setStep('map')} className="b-gho" style={{flex:1}}>Back</button>
        <button onClick={handleImport} className="b-pri" style={{flex:2,padding:12,fontSize:14}}>
          <I n="lock" s={15}/> Encrypt &amp; Import {fileData.records.length} Records
        </button>
      </div>
    </div>}

    {/* ── STEP 4: IMPORTING ── */}
    {step === 'importing' && <div style={{textAlign:'center',padding:'20px 0'}}>
      <Spin s={32}/>
      <p style={{fontSize:15,fontWeight:600,marginTop:16}}>Encrypting &amp; creating rooms...</p>
      <p style={{fontSize:12,color:'var(--tx-2)',marginTop:6}}>Record {progress.current} of {progress.total}</p>
      <div style={{background:'var(--bg-3)',borderRadius:8,height:8,overflow:'hidden',marginTop:16,maxWidth:400,margin:'16px auto 0'}}>
        <div style={{height:'100%',background:'var(--gold)',borderRadius:8,transition:'width .3s',
          width:`${progress.total?((progress.current/progress.total)*100):0}%`}}/>
      </div>
      <div style={{display:'flex',gap:12,justifyContent:'center',marginTop:20}}>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <I n="lock" s={12} c="var(--green)"/><span style={{fontSize:11,color:'var(--tx-2)'}}>AES-256-GCM per record</span>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:4}}>
          <I n="shield" s={12} c="var(--teal)"/><span style={{fontSize:11,color:'var(--tx-2)'}}>E2EE rooms</span>
        </div>
      </div>
    </div>}

    {/* ── STEP 5: DONE ── */}
    {step === 'done' && results && <div>
      <div style={{textAlign:'center',marginBottom:20}}>
        <div style={{width:48,height:48,borderRadius:'50%',background:'var(--green-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--green)',margin:'0 auto 12px'}}>
          <I n="check" s={24}/>
        </div>
        <p style={{fontSize:18,fontWeight:700}}>Import Complete</p>
        <p style={{fontSize:12,color:'var(--tx-2)',marginTop:4}}>
          {results.created.length} records encrypted &amp; stored · {results.errors.length} errors
        </p>
      </div>

      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:16}}>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">IMPORTED</span>
          <span style={{fontSize:20,fontWeight:700,color:'var(--green)',display:'block'}}>{results.created.length}</span>
        </div>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">ENCRYPTED FIELDS</span>
          <span style={{fontSize:20,fontWeight:700,color:'var(--gold)',display:'block'}}>{results.totalFields}</span>
        </div>
        <div className="card" style={{padding:10,textAlign:'center'}}>
          <span className="section-label">ERRORS</span>
          <span style={{fontSize:20,fontWeight:700,color:results.errors.length?'var(--red)':'var(--tx-2)',display:'block'}}>{results.errors.length}</span>
        </div>
      </div>

      {/* DEMOGRAPHIC SUMMARY — This is the ONLY reportable data */}
      {Object.keys(results.demographics).length > 0 && <div className="card" style={{marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
          <span className="section-label" style={{marginBottom:0}}>DEMOGRAPHIC SUMMARY (ANONYMIZED)</span>
          <span className="tag tag-teal" style={{fontSize:8}}>REPORT-SAFE</span>
        </div>
        <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>This is the only data available for reporting. No PII is present — only demographic ranges and hashed areas.</p>
        {Object.entries(results.demographics).map(([category, values]) => <div key={category} style={{marginBottom:10}}>
          <span style={{fontSize:11,fontWeight:600,color:'var(--tx-1)',textTransform:'uppercase',fontFamily:'var(--mono)',letterSpacing:'.05em',display:'block',marginBottom:4}}>{category}</span>
          <div style={{display:'flex',flexDirection:'column',gap:3}}>
            {Object.entries(values).sort((a,b)=>b[1]-a[1]).map(([val, count]) => {
              const max = Math.max(...Object.values(values));
              return <div key={val} style={{display:'flex',alignItems:'center',gap:8}}>
                <span style={{fontSize:11,width:140,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',color:'var(--tx-1)'}}>{val || '—'}</span>
                <div style={{flex:1,height:14,background:'var(--bg-3)',borderRadius:3,overflow:'hidden'}}>
                  <div style={{width:`${(count/max)*100}%`,height:'100%',background:'var(--teal)',borderRadius:3,transition:'width .3s'}}/>
                </div>
                <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-1)',minWidth:24,textAlign:'right'}}>{count}</span>
              </div>;
            })}
          </div>
        </div>)}
      </div>}

      {results.errors.length > 0 && <div className="card" style={{marginBottom:16}}>
        <span className="section-label">ERRORS</span>
        <div style={{maxHeight:120,overflow:'auto',marginTop:4}}>
          {results.errors.map((e, i) => <div key={i} style={{fontSize:11,color:'var(--red)',padding:'4px 0',borderBottom:'1px solid var(--border-0)'}}>
            Row {e.row}: {e.error}
          </div>)}
        </div>
      </div>}

      <div style={{background:'var(--green-dim)',border:'1px solid rgba(61,214,140,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginBottom:16,display:'flex',gap:10,alignItems:'flex-start'}}>
        <I n="shieldCheck" s={16} c="var(--green)"/>
        <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--green)'}}>No PII in reports.</strong> All {results.created.length} records are individually encrypted with unique AES-256-GCM keys. The demographic summary above shows only anonymized ranges — this is the maximum granularity available for any report. Names, dates of birth, SSNs, addresses, phones, and emails are cryptographically blocked from reporting.
        </div>
      </div>

      <button onClick={onClose} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
        <I n="check" s={15}/> Done — View Clients
      </button>
    </div>}
  </Modal>;
};

/* ═══════════════════ SMALL COMPONENTS ═══════════════════ */
const Spin = ({s=18}) => <div style={{width:s,height:s,border:'2px solid var(--border-1)',borderTopColor:'var(--gold)',borderRadius:'50%',animation:'spin .6s linear infinite'}} />;

const Modal = ({open,onClose,title,w=480,children}) => {
  if (!open) return null;
  return <div style={{position:'fixed',inset:0,zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(0,0,0,.75)',backdropFilter:'blur(6px)'}} onClick={onClose}>
    <div className="anim-up" onClick={e=>e.stopPropagation()} style={{background:'var(--bg-2)',border:'1px solid var(--border-1)',borderRadius:'var(--r-lg)',width:'92%',maxWidth:w,maxHeight:'88vh',overflow:'auto',padding:28}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
        <h3 style={{fontSize:16,fontWeight:700}}>{title}</h3>
        <button onClick={onClose} style={{background:'transparent',color:'var(--tx-2)',padding:4}}><I n="x" s={17}/></button>
      </div>
      {children}
    </div>
  </div>;
};

const Toggle = ({on,onChange,disabled}) => (
  <div className={`toggle-track ${on?'on':'off'}`} onClick={disabled?undefined:onChange} style={disabled?{opacity:.4,cursor:'default'}:{}}>
    <div className="toggle-knob"/>
  </div>
);

const Toast = ({msg,type='info',onClose}) => {
  useEffect(()=>{const t=setTimeout(onClose,3500);return()=>clearTimeout(t)},[]);
  const c = {info:'var(--blue)',success:'var(--green)',error:'var(--red)',warn:'var(--gold)'}[type];
  return <div className="anim-up" style={{position:'fixed',bottom:20,right:20,zIndex:9999,background:'var(--bg-2)',border:`1px solid ${c}30`,borderLeft:`3px solid ${c}`,borderRadius:'var(--r)',padding:'11px 18px',fontSize:12.5,boxShadow:'0 8px 32px rgba(0,0,0,.5)',maxWidth:400}}>{msg}</div>;
};

const OP_COLORS = {INS:'green',ALT:'blue',DES:'gold',SEG:'teal',NUL:'red',REC:'orange',CON:'blue',SYN:'purple',SUP:'gold'};

/* ═══════════════════ MVP BADGE COMPONENTS (§Screen 4) ═══════════════════ */

// Maturity badge: Draft / Trial / Normative / De facto / Deprecated
const MaturityBadge = ({maturity, size='sm'}) => {
  const level = MATURITY_LEVELS[maturity];
  if (!level) return null;
  const pad = size === 'lg' ? '3px 10px' : '2px 7px';
  const fs = size === 'lg' ? 11 : 9.5;
  return <span className={`tag tag-${level.color}`} style={{fontSize:fs, padding:pad}} title={level.desc}>
    {level.label}
  </span>;
};

// Source badge: Network (with propagation level) or Local
const SourceBadge = ({source}) => {
  if (!source) return <span className="tag tag-purple" style={{fontSize:9}}>Local</span>;
  if (source.level === 'local') return <span className="tag tag-purple" style={{fontSize:9}}>Local</span>;
  const prop = PROPAGATION_LEVELS[source.propagation];
  return <span className={`tag tag-${prop?.color || 'blue'}`} style={{fontSize:9}} title={`${source.propagation}: ${prop?.desc || ''}`}>
    Network &middot; {prop?.label || source.propagation}
  </span>;
};

// Consent gradient — not a vote count, a distribution of positions
const ConsentGradient = ({positions = {}, totalOrgs = 0}) => {
  const counts = {};
  let responded = 0;
  for (const [orgId, pos] of Object.entries(positions)) {
    if (pos) { const p = pos.position || 'pending'; counts[p] = (counts[p] || 0) + 1; responded++; }
  }
  const pending = totalOrgs - responded;
  const segments = [
    { key: 'adopt_as_is', count: counts.adopt_as_is || 0, ...CONSENT_POSITIONS.adopt_as_is },
    { key: 'adopt_with_extension', count: counts.adopt_with_extension || 0, ...CONSENT_POSITIONS.adopt_with_extension },
    { key: 'needs_modification', count: counts.needs_modification || 0, ...CONSENT_POSITIONS.needs_modification },
    { key: 'cannot_adopt', count: counts.cannot_adopt || 0, ...CONSENT_POSITIONS.cannot_adopt },
  ];
  const hasBlock = (counts.cannot_adopt || 0) > 0;
  return <div style={{marginTop:8}}>
    <div style={{display:'flex',height:8,borderRadius:4,overflow:'hidden',background:'var(--bg-3)',gap:1}}>
      {segments.map(seg => seg.count > 0 ? <div key={seg.key} style={{
        flex: seg.count, background: `var(--${seg.color})`, transition: 'flex .3s',
      }} title={`${seg.label}: ${seg.count}`}/> : null)}
      {pending > 0 && <div style={{flex:pending,background:'var(--border-1)'}} title={`Pending: ${pending}`}/>}
    </div>
    <div style={{display:'flex',gap:10,marginTop:6,flexWrap:'wrap'}}>
      {segments.filter(s=>s.count>0).map(s=><div key={s.key} style={{display:'flex',alignItems:'center',gap:4}}>
        <div style={{width:8,height:8,borderRadius:2,background:`var(--${s.color})`}}/>
        <span style={{fontSize:10,color:'var(--tx-1)'}}>{s.icon} {s.label} ({s.count})</span>
      </div>)}
      {pending > 0 && <div style={{display:'flex',alignItems:'center',gap:4}}>
        <div style={{width:8,height:8,borderRadius:2,background:'var(--border-1)'}}/>
        <span style={{fontSize:10,color:'var(--tx-3)'}}>Pending ({pending})</span>
      </div>}
    </div>
    {hasBlock && <div style={{marginTop:6,padding:'6px 10px',background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.2)',borderRadius:'var(--r)',fontSize:11,color:'var(--red)'}}>
      Block registered — structured objection required before proceeding
    </div>}
  </div>;
};

// De facto field detection alert
const DeFactoAlert = ({fieldName, orgCount, totalOrgs, onFormalize, onDismiss}) => (
  <div className="card anim-up" style={{padding:'14px 18px',borderColor:'var(--gold)',borderLeft:'3px solid var(--gold)'}}>
    <div style={{display:'flex',alignItems:'flex-start',gap:10}}>
      <div style={{width:32,height:32,borderRadius:'var(--r)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',flexShrink:0}}><I n="zap" s={16}/></div>
      <div style={{flex:1}}>
        <div style={{fontSize:13,fontWeight:600,marginBottom:2}}>De facto standard detected</div>
        <div style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.5}}>
          {orgCount} of {totalOrgs} orgs have a "{fieldName}" field. Formalize as network standard?
        </div>
        <div style={{display:'flex',gap:8,marginTop:10}}>
          <button onClick={onFormalize} className="b-pri b-sm">Propose Formalization</button>
          <button onClick={onDismiss} className="b-gho b-sm">Dismiss</button>
        </div>
      </div>
    </div>
  </div>
);

// Adoption metrics bar (ambient monitoring)
const AdoptionMetrics = ({adopted, total, extensions, divergences}) => (
  <div className="card" style={{padding:14}}>
    <span className="section-label">SCHEMA ADOPTION</span>
    <div style={{display:'flex',alignItems:'baseline',gap:6,marginTop:4}}>
      <span style={{fontSize:22,fontWeight:700,color:'var(--green)'}}>{adopted}</span>
      <span style={{fontSize:13,color:'var(--tx-2)'}}>of {total} network fields adopted</span>
    </div>
    <div style={{display:'flex',height:6,borderRadius:3,overflow:'hidden',background:'var(--bg-3)',marginTop:8,gap:1}}>
      {adopted > 0 && <div style={{flex:adopted,background:'var(--green)'}}/>}
      {extensions > 0 && <div style={{flex:extensions,background:'var(--blue)'}}/>}
      {divergences > 0 && <div style={{flex:divergences,background:'var(--gold)'}}/>}
      {(total - adopted - (extensions||0) - (divergences||0)) > 0 && <div style={{flex:total - adopted - (extensions||0) - (divergences||0),background:'var(--border-1)'}}/>}
    </div>
    <div style={{display:'flex',gap:12,marginTop:6,fontSize:10,color:'var(--tx-2)'}}>
      {extensions > 0 && <span style={{color:'var(--blue)'}}>{extensions} with extensions</span>}
      {divergences > 0 && <span style={{color:'var(--gold)'}}>{divergences} diverged</span>}
    </div>
  </div>
);

// Governance proposal card (MVP §Screen 5)
const ProposalCard = ({proposal, onRespond}) => {
  const status = PROPOSAL_STATUSES[proposal.status] || PROPOSAL_STATUSES.submitted;
  const targetProp = PROPAGATION_LEVELS[proposal.target_propagation];
  const targetMat = MATURITY_LEVELS[proposal.target_maturity];
  const positionEntries = Object.entries(proposal.positions || {});
  const totalOrgs = positionEntries.length;
  return <div className="card" style={{padding:0,overflow:'hidden',marginBottom:10}}>
    <div style={{padding:'14px 18px',borderBottom:'1px solid var(--border-0)'}}>
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6,flexWrap:'wrap'}}>
        <span className={`tag tag-${status.color}`}>{status.label}</span>
        {targetProp && <SourceBadge source={{level:'network',propagation:proposal.target_propagation}}/>}
        {targetMat && <MaturityBadge maturity={proposal.target_maturity}/>}
      </div>
      <div style={{fontSize:14,fontWeight:600,marginBottom:4}}>{proposal.summary}</div>
      {proposal.detail && <div style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.5}}>{proposal.detail}</div>}
      <div style={{display:'flex',gap:12,marginTop:8,fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>
        <span>By: {proposal.proposed_by}</span>
        {proposal.governance_rhythm && <span>{proposal.governance_rhythm}</span>}
        {proposal.deadline && <span>Due: {new Date(proposal.deadline).toLocaleDateString()}</span>}
      </div>
    </div>
    <div style={{padding:'10px 18px'}}>
      <ConsentGradient positions={proposal.positions} totalOrgs={totalOrgs}/>
      {onRespond && proposal.status === 'consent_round' && <div style={{marginTop:10}}>
        <button onClick={onRespond} className="b-pri b-sm">Review & Respond</button>
      </div>}
    </div>
  </div>;
};

// Governance calendar display
const GovernanceCalendar = ({rhythms = Object.values(GOV_RHYTHMS)}) => (
  <div className="card" style={{padding:16}}>
    <span className="section-label">GOVERNANCE CALENDAR</span>
    <div style={{display:'flex',flexDirection:'column',gap:8,marginTop:8}}>
      {rhythms.map(r => <div key={r.id} style={{display:'flex',alignItems:'center',gap:12,padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
        <div style={{width:36,height:36,borderRadius:'var(--r)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',flexShrink:0}}>
          <I n="clock" s={16}/>
        </div>
        <div style={{flex:1}}>
          <div style={{fontSize:13,fontWeight:600}}>{r.name}</div>
          <div style={{fontSize:10.5,color:'var(--tx-2)',marginTop:2}}>{r.frequency} &middot; {r.duration_days} day window &middot; {r.participants}</div>
        </div>
      </div>)}
    </div>
  </div>
);

/* ═══════════════════ GIVEN/MEANT DIVIDE VISUALIZATION ═══════════════════ */

// Core visualization: observation on the left, crossing in the middle, frameworks on the right
const GivenMeantDivide = ({observation, compact = false}) => {
  // observation: {prompt, value, valueLabel, reporter, timestamp, eoTrace, frameworks}
  const [expandedChains, setExpandedChains] = useState(new Set());
  const toggleChain = (id) => setExpandedChains(p => {const n = new Set(p); n.has(id) ? n.delete(id) : n.add(id); return n;});

  if (!observation) return null;
  const {prompt, value, valueLabel, reporter, timestamp, eoTrace, frameworks} = observation;

  // Detect divergence: do frameworks classify differently?
  const classifications = frameworks?.map(f => f.classification) || [];
  const uniqueClassifications = [...new Set(classifications)];
  const hasDivergence = uniqueClassifications.length > 1;

  // Collect all unique EO ops used in the crossing
  const crossingOps = new Set();
  (frameworks || []).forEach(f => (f.eo_chain || []).forEach(s => crossingOps.add(s.op)));

  return <div className="gm-container anim-up" style={compact ? {minHeight:'auto'} : {}}>
    {/* LEFT — GIVEN */}
    <div className="gm-given" style={compact ? {flex:'0 0 280px',padding:14} : {}}>
      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:10}}>
        <span className="tag tag-teal" style={{fontSize:9}}>GIVEN</span>
        <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)'}}>OBSERVATION</span>
      </div>
      {prompt && <div className="gm-obs-field">{prompt}</div>}
      <div className="gm-obs-value">{valueLabel || value}</div>
      <div className="gm-meta-row">
        {reporter && <span>{reporter}</span>}
        {timestamp && <span>{new Date(timestamp).toLocaleDateString()}</span>}
      </div>
      {eoTrace && <div className="gm-eo-trace">{eoTrace}</div>}
      {!compact && <div style={{marginTop:12,padding:'8px 10px',background:'var(--bg-3)',borderRadius:'var(--r)',fontSize:10.5,color:'var(--tx-2)',lineHeight:1.5}}>
        This is ground truth. The observation just <em>is</em>. Everything to the right is what it <em>means</em>, according to whom.
      </div>}
    </div>

    {/* CROSSING */}
    <div className="gm-crossing">
      <div className="gm-crossing-arrow" title="Epistemic crossing: observation becomes interpretation">&#8594;</div>
      <div className="gm-crossing-label">GIVEN &#8594; MEANT</div>
      {[...crossingOps].map(op => <div key={op} className="gm-crossing-op" style={{
        background: `var(--${OP_COLORS[op]||'blue'}-dim)`,
        color: `var(--${OP_COLORS[op]||'blue'})`,
        borderColor: `var(--${OP_COLORS[op]||'blue'})20`
      }}>{op}</div>)}
    </div>

    {/* RIGHT — MEANT */}
    <div className="gm-meant" style={compact ? {padding:14} : {}}>
      <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4}}>
        <span className="tag tag-gold" style={{fontSize:9}}>MEANT</span>
        <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)'}}>FRAMEWORK INTERPRETATIONS ({frameworks?.length || 0})</span>
      </div>

      {hasDivergence && <div className="gm-divergence">
        <span style={{color:'var(--gold)',fontWeight:700,fontSize:13,lineHeight:1}}>&#9670;</span>
        <div>
          <strong style={{color:'var(--gold)',fontSize:11}}>Frameworks diverge</strong>
          <span style={{display:'block',fontSize:10,color:'var(--tx-2)',marginTop:2}}>
            {uniqueClassifications.length} distinct classifications from the same observation.
            This is SUP made visible — the value exists in superposition across frameworks.
          </span>
        </div>
      </div>}

      {(frameworks || []).map((fw, i) => {
        const fwColor = FRAMEWORK_COLORS[fw.authority_id] || {accent:'purple',label:'?'};
        const isExpanded = expandedChains.has(fw.id);
        return <div key={fw.id || i} className="gm-fw-card" data-accent={fwColor.accent}>
          <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:8}}>
            <div style={{flex:1,minWidth:0}}>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4,flexWrap:'wrap'}}>
                <span className={`tag tag-${fwColor.accent}`} style={{fontSize:8.5}}>{fw.authority_org}</span>
                <span style={{fontSize:12,fontWeight:600}}>{fw.authority_name}</span>
              </div>
              <div style={{fontSize:14,fontWeight:700,color:'var(--gold)',marginBottom:4}}>{fw.classification}</div>
              {fw.provision && <div style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',marginBottom:4}}>{fw.provision}</div>}
              {fw.authority_uri && <a href={fw.authority_uri} target="_blank" rel="noopener"
                style={{fontSize:9.5,fontFamily:'var(--mono)',color:'var(--blue)',display:'block',marginBottom:4,
                  overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',textDecoration:'none',maxWidth:'100%'}}>
                {fw.authority_uri}</a>}
              {fw.implication && <div style={{fontSize:11,color:'var(--tx-1)',padding:'4px 8px',background:'var(--bg-3)',
                borderRadius:'var(--r)',display:'inline-block',marginTop:2}}>
                {fw.implication}
              </div>}
            </div>
          </div>

          {/* EO chain */}
          <div style={{marginTop:8,borderTop:'1px solid var(--border-0)',paddingTop:8}}>
            <div onClick={() => toggleChain(fw.id)} style={{cursor:'pointer',display:'flex',alignItems:'center',gap:4}}>
              <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--tx-3)'}}>EO CHAIN</span>
              <I n={isExpanded ? 'x' : 'chevR'} s={9} c="var(--tx-3)"/>
            </div>
            {!isExpanded && fw.eo_compact && <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--purple)',marginTop:3}}>{fw.eo_compact}</div>}
            {isExpanded && <div className="gm-chain">
              {(fw.eo_chain || []).map((step, si) => <React.Fragment key={si}>
                {si > 0 && <span style={{color:'var(--tx-3)',fontSize:10}}>&#8594;</span>}
                <span className="gm-chain-step" style={{
                  background: `var(--${OP_COLORS[step.op]||'blue'}-dim)`,
                  color: `var(--${OP_COLORS[step.op]||'blue'})`
                }}>
                  {step.op}({step.desc})
                </span>
              </React.Fragment>)}
            </div>}
          </div>
        </div>;
      })}

      {(!frameworks || frameworks.length === 0) && <div className="gm-wb-empty">
        <I n="grid" s={24}/>
        <p style={{marginTop:8,fontSize:12}}>No frameworks bound</p>
        <p style={{fontSize:10.5,color:'var(--tx-3)',marginTop:4}}>This observation is recorded but not yet interpreted.</p>
      </div>}
    </div>
  </div>;
};

// Record-level GIVEN/MEANT display for a specific client observation
const RecordGivenMeant = ({promptKey, value, reporter, timestamp}) => {
  const prompt = DEFAULT_PROMPTS.find(p => p.key === promptKey);
  if (!prompt) return null;
  const option = prompt.options?.find(o => o.v === value);
  const binding = FRAMEWORK_BINDINGS[promptKey]?.bindings?.[value];

  const observation = {
    prompt: prompt.question,
    value: value,
    valueLabel: option?.l || value,
    reporter: reporter || `${ROLES.client.label} self-report`,
    timestamp: timestamp,
    eoTrace: prompt.eo?.trace,
    frameworks: binding?.frameworks || []
  };

  return <GivenMeantDivide observation={observation} compact={true}/>;
};

/* ═══════════════════ FRAMEWORK TOGGLE PANEL ═══════════════════
 * Lets users toggle data-field frameworks on/off. Each framework
 * injects a set of vault fields tagged to authoritative URIs,
 * giving local field values an objective semantic anchor.
 * ═══════════════════════════════════════════════════════════════ */
const FrameworkTogglePanel = ({enabledFrameworks, onToggle}) => {
  const [expandedFw, setExpandedFw] = useState(null);

  const handleToggle = (fwId) => {
    const next = enabledFrameworks.includes(fwId)
      ? enabledFrameworks.filter(id => id !== fwId)
      : [...enabledFrameworks, fwId];
    onToggle(next);
  };

  const domainGroups = useMemo(() => {
    const groups = {};
    FRAMEWORK_FIELD_STANDARDS.forEach(fw => {
      if (!groups[fw.domain]) groups[fw.domain] = [];
      groups[fw.domain].push(fw);
    });
    return groups;
  }, []);

  return <div style={{display:'flex',flexDirection:'column',gap:16}}>
    <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
      Toggle frameworks to add their standardized fields to your vault. Each field is tagged to an authoritative URI — turning local data into semantically anchored, interoperable records.
    </div>

    <div style={{display:'flex',gap:8,flexWrap:'wrap',marginBottom:4}}>
      <span style={{fontSize:11,color:'var(--tx-2)',alignSelf:'center'}}>Active:</span>
      <span style={{fontSize:13,fontWeight:700,color:'var(--green)'}}>{enabledFrameworks.length}</span>
      <span style={{fontSize:11,color:'var(--tx-3)'}}>of {FRAMEWORK_FIELD_STANDARDS.length} frameworks</span>
      <span style={{fontSize:11,color:'var(--tx-3)',marginLeft:4}}>&#183;</span>
      <span style={{fontSize:11,color:'var(--tx-2)'}}>{getFrameworkFields(enabledFrameworks).length} fields added</span>
    </div>

    {Object.entries(domainGroups).map(([domain, frameworks]) => <div key={domain}>
      <span className="section-label" style={{fontSize:10,marginBottom:6,display:'block'}}>{domain.toUpperCase()}</span>
      <div style={{display:'flex',flexDirection:'column',gap:6}}>
        {frameworks.map(fw => {
          const isEnabled = enabledFrameworks.includes(fw.id);
          const isExpanded = expandedFw === fw.id;
          return <div key={fw.id} className="card" style={{padding:0,overflow:'hidden',borderColor:isEnabled?`var(--${fw.accent})`:'var(--border-0)',transition:'border-color .2s'}}>
            <div style={{padding:'12px 16px',display:'flex',alignItems:'center',gap:12}}>
              <Toggle on={isEnabled} onChange={() => handleToggle(fw.id)}/>
              <div style={{flex:1,minWidth:0}}>
                <div style={{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}}>
                  <span style={{fontSize:13.5,fontWeight:600}}>{fw.name}</span>
                  <span className={`tag tag-${fw.accent}`} style={{fontSize:8.5}}>{fw.spec}</span>
                  <span style={{fontSize:10.5,color:'var(--tx-2)'}}>{fw.fields.length} fields</span>
                </div>
                <div style={{fontSize:11,color:'var(--tx-2)',marginTop:2}}>{fw.description}</div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <a href={fw.uri} target="_blank" rel="noopener" style={{fontSize:9,fontFamily:'var(--mono)',color:`var(--${fw.accent})`,textDecoration:'none'}} title={fw.uri}>spec</a>
                <span onClick={() => setExpandedFw(isExpanded ? null : fw.id)} style={{cursor:'pointer',color:'var(--tx-3)',transition:'color .15s'}}
                  onMouseEnter={e=>e.currentTarget.style.color='var(--tx-0)'} onMouseLeave={e=>e.currentTarget.style.color='var(--tx-3)'}>
                  <I n={isExpanded ? 'x' : 'chevR'} s={12}/>
                </span>
              </div>
            </div>
            {isExpanded && <div style={{borderTop:'1px solid var(--border-0)',padding:'10px 16px',background:'var(--bg-1)'}}>
              <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:6}}>
                {fw.fields.map(f => <div key={f.key} style={{display:'flex',alignItems:'center',gap:6,padding:'5px 8px',borderRadius:'var(--r)',background:'var(--bg-2)',border:'1px solid var(--border-0)',fontSize:11.5}}>
                  <span style={{flex:1,fontWeight:500}}>{f.label}</span>
                  {f.sensitive && <span className="tag tag-red" style={{fontSize:7.5,padding:'1px 5px'}}>SENSITIVE</span>}
                  <a href={f.uri} target="_blank" rel="noopener" style={{color:`var(--${fw.accent})`,textDecoration:'none',fontSize:9,fontFamily:'var(--mono)'}}>
                    {f.property}
                  </a>
                </div>)}
              </div>
              <div style={{marginTop:8,fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                {fw.uri}
              </div>
            </div>}
          </div>;
        })}
      </div>
    </div>)}
  </div>;
};

/* ═══════════════════ SCHEMA WORKBENCH ═══════════════════ */
const SWC_DARK = {
  bg: "#07090d", surface: "#0e1218", raised: "#151b23", hover: "#1b2330",
  border: "#1d2735", borderLit: "#2c3d52", text: "#c0c9d4", muted: "#7a8da0",
  dim: "#4a5d72", white: "#edf0f5",
  given: "#2dd4a0", givenBorder: "#18694e",
  meant: "#a78bfa", meantBorder: "#4a2d8a",
  fw: ["#60a5fa","#f0abfc","#fbbf24","#34d399","#fb7185"],
  fwBg: i => `${["#60a5fa","#f0abfc","#fbbf24","#34d399","#fb7185"][i%5]}12`,
  fwBorder: i => `${["#60a5fa","#f0abfc","#fbbf24","#34d399","#fb7185"][i%5]}40`,
  sup: "#fbbf24", supBg: "rgba(251,191,36,0.06)", red: "#f87171",
};
const SWC_LIGHT = {
  bg: "#f5f5f7", surface: "#ebedf0", raised: "#e0e2e7", hover: "#d4d7dd",
  border: "#b8bcc6", borderLit: "#a0a5b2", text: "#2e3340", muted: "#4a5168",
  dim: "#8890a0", white: "#111318",
  given: "#137a6a", givenBorder: "#0a5c4d",
  meant: "#6938c0", meantBorder: "#4a2d8a",
  fw: ["#2563b0","#9333b0","#8a6d1e","#177a4a","#c03050"],
  fwBg: i => `${["#2563b0","#9333b0","#8a6d1e","#177a4a","#c03050"][i%5]}14`,
  fwBorder: i => `${["#2563b0","#9333b0","#8a6d1e","#177a4a","#c03050"][i%5]}40`,
  sup: "#8a6d1e", supBg: "rgba(138,109,30,0.08)", red: "#c03030",
};
const useSWC = () => { const {theme} = useTheme(); return theme === 'light' ? SWC_LIGHT : SWC_DARK; };
/* Legacy alias — components that haven't migrated yet still read SWC */
let SWC = SWC_DARK;



const SwTag = ({color=SWC.muted,children,sm,mono,onClick,style:sx}) => (
  <span onClick={onClick} style={{display:"inline-flex",alignItems:"center",padding:sm?"1px 7px":"2px 9px",fontSize:sm?11:12,fontWeight:600,fontFamily:mono?"var(--mono)":"inherit",background:`${color}10`,border:`1px solid ${color}28`,borderRadius:3,color,cursor:onClick?"pointer":"default",letterSpacing:"0.01em",lineHeight:"20px",whiteSpace:"nowrap",...sx}}>{children}</span>
);
const SwDot = ({color,size=6}) => <span style={{width:size,height:size,borderRadius:"50%",background:color,display:"inline-block",flexShrink:0}}/>;
const SwBtn = ({children,accent=SWC.given,ghost,disabled,onClick,style:sx}) => (
  <button disabled={disabled} onClick={onClick} style={{padding:"8px 18px",borderRadius:6,fontSize:13,fontWeight:600,fontFamily:"inherit",cursor:disabled?"default":"pointer",transition:"all 0.15s",opacity:disabled?0.4:1,border:ghost?`1px solid ${accent}40`:`1px solid ${accent}`,background:ghost?"transparent":accent,color:ghost?accent:SWC.bg,...sx}}>{children}</button>
);
const SwInput = ({value,onChange,placeholder,autoFocus,onKeyDown,style:sx}) => (
  <input autoFocus={autoFocus} value={value} onChange={e=>onChange(e.target.value)} onKeyDown={onKeyDown} placeholder={placeholder} style={{width:"100%",padding:"10px 14px",borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:14,fontFamily:"inherit",outline:"none",boxSizing:"border-box",...sx}} onFocus={e=>e.target.style.borderColor=SWC.borderLit} onBlur={e=>e.target.style.borderColor=SWC.border}/>
);
function SwMRow({opt,frameworks,getBindingCode,setBind,clearBind,hasConflict,isLast}) {
  const [openCell,setOpenCell] = useState(null);
  return (
    <div style={{borderBottom:!isLast?`1px solid ${SWC.border}`:"none"}}>
      <div style={{display:"grid",gridTemplateColumns:`minmax(140px,180px) repeat(${frameworks.length}, 1fr)`}}>
        <div style={{padding:"10px 14px",fontSize:14,color:SWC.white,fontWeight:500,display:"flex",alignItems:"center",gap:5}}>
          {opt.label}{hasConflict(opt)&&<span style={{fontSize:11}}>⚡</span>}
        </div>
        {frameworks.map((fw,fi) => {
          const code = getBindingCode(opt.id,fw.id);
          const isOpen = openCell===fw.id;
          const hasCodes = fw.codes.length>0;
          return (
            <div key={fw.id} onClick={()=>{if(hasCodes)setOpenCell(isOpen?null:fw.id);}} style={{
              padding:"9px 10px",textAlign:"center",borderLeft:`1px solid ${SWC.border}`,
              cursor:hasCodes?"pointer":"default",transition:"background 0.1s",
              background:isOpen?SWC.fwBg(fi):"transparent",
            }}
            onMouseEnter={e=>{if(hasCodes&&!isOpen)e.currentTarget.style.background=SWC.hover;}}
            onMouseLeave={e=>{if(!isOpen)e.currentTarget.style.background=isOpen?SWC.fwBg(fi):"transparent";}}
            >
              {code?<SwTag color={SWC.fw[fi%5]} mono style={{fontSize:13}}>{code.code}</SwTag>:hasCodes?<span style={{fontSize:12.5,color:SWC.dim}}>—</span>:<span style={{fontSize:11.5,color:SWC.dim}}>no codes</span>}
            </div>
          );
        })}
      </div>
      {openCell && (()=>{
        const fi=frameworks.findIndex(f=>f.id===openCell);
        const fw=frameworks[fi];
        if(!fw) return null;
        const cur=getBindingCode(opt.id,fw.id);
        return (
          <div style={{padding:"8px 12px 10px",background:SWC.fwBg(fi),borderTop:`1px solid ${SWC.fwBorder(fi)}`}}>
            <div style={{fontSize:12,color:SWC.muted,marginBottom:8,fontWeight:600}}>
              <span style={{color:SWC.fw[fi%5]}}>{fw.name}</span> reading for "{opt.label}":
            </div>
            <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
              {fw.codes.map(c=>{
                const a=cur?.id===c.id;
                return (
                  <div key={c.id} onClick={e=>{e.stopPropagation();if(a)clearBind(opt.id,fw.id);else setBind(opt.id,c.id,fw.id);setOpenCell(null);}} style={{
                    padding:"6px 10px",borderRadius:6,cursor:"pointer",transition:"all 0.12s",display:"flex",alignItems:"center",gap:6,
                    border:`1px solid ${a?SWC.fw[fi%5]:SWC.border}`,background:a?`${SWC.fw[fi%5]}18`:"transparent",
                  }}
                  onMouseEnter={e=>{e.currentTarget.style.borderColor=SWC.fw[fi%5];if(!a)e.currentTarget.style.background=SWC.hover;}}
                  onMouseLeave={e=>{e.currentTarget.style.borderColor=a?SWC.fw[fi%5]:SWC.border;e.currentTarget.style.background=a?`${SWC.fw[fi%5]}18`:"transparent";}}
                  >
                    <SwTag color={SWC.fw[fi%5]} mono sm>{c.code}</SwTag>
                    <span style={{fontSize:13,color:a?SWC.white:SWC.text}}>{c.label}</span>
                    {a && <span style={{fontSize:11.5,color:SWC.fw[fi%5]}}>✓</span>}
                  </div>
                );
              })}
            </div>
            {cur && <div onClick={e=>{e.stopPropagation();clearBind(opt.id,fw.id);setOpenCell(null);}} style={{fontSize:12.5,color:SWC.dim,cursor:"pointer",marginTop:8}}>Clear</div>}
          </div>
        );
      })()}
    </div>
  );
}

/* ═══════════════════ FORM BUILDER — Schema Builder UX ═══════════════════
 * The FormBuilder implements the ideated Schema Builder UX with two modes:
 *
 *   Compose mode — Google-Forms-like drag-and-drop question building.
 *     Questions are GIVEN (observations). Answer options describe observable things.
 *     The GIVEN test nudge guides users toward observation-quality questions.
 *
 *   Wire mode — Connect answer options to framework codes (GIVEN → MEANT).
 *     A wiring panel shows framework bindings with full provenance.
 *     Provenance dots (●/○/⚡) encode binding status at a glance.
 *
 * The five primitives: QUESTION → VALUE → CODE → FRAMEWORK → BINDING + CROSSWALK
 * ═══════════════════════════════════════════════════════════════════════════════ */

// GIVEN test: words that suggest interpretation rather than observation
const MEANT_SIGNAL_WORDS = ['category','classification','level','status','type','code','score','rating','rank','tier','class','grade','priority','eligibility','determination','assessment'];
const checkGivenTest = (text) => {
  const lower = text.toLowerCase();
  const found = MEANT_SIGNAL_WORDS.filter(w => lower.includes(w));
  return found.length > 0 ? found : null;
};
const suggestGivenRephrasing = (text) => {
  const lower = text.toLowerCase();
  if (lower.includes('homeless') && lower.includes('category')) return ['Where did you sleep last night?','Describe your current living situation.'];
  if (lower.includes('status')) return ['What is happening right now?','Describe the current situation.'];
  if (lower.includes('priority') || lower.includes('level')) return ['What did you observe?','Describe what you see.'];
  if (lower.includes('eligibility') || lower.includes('determination')) return ['What information was provided?','What was reported?'];
  if (lower.includes('assessment') || lower.includes('score')) return ['What did you observe during the interaction?','Describe the person\'s current condition.'];
  return ['Rephrase as something a person could answer from their own experience.'];
};

let _fbId = 5000;
const fbUid = () => `fb_${_fbId++}`;

/* ── Form key generation — creates a stable snake_case key from a name ── */
const formNameToKey = (name) => name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '').slice(0, 48) || 'unnamed_form';

/* ── Version diff — compares two form versions and returns structural changes ── */
const diffFormVersions = (oldForm, newForm) => {
  const changes = { added: [], removed: [], renamed: [], typeChanged: [] };
  const oldQs = (oldForm?.sections || []).flatMap(s => s.questions || []);
  const newQs = (newForm?.sections || []).flatMap(s => s.questions || []);
  const oldById = Object.fromEntries(oldQs.map(q => [q.id, q]));
  const newById = Object.fromEntries(newQs.map(q => [q.id, q]));
  // Removed questions
  oldQs.forEach(oq => { if (!newById[oq.id]) changes.removed.push(oq); });
  // Added questions
  newQs.forEach(nq => { if (!oldById[nq.id]) changes.added.push(nq); });
  // Modified questions
  newQs.forEach(nq => {
    const oq = oldById[nq.id];
    if (!oq) return;
    if (oq.prompt !== nq.prompt) changes.renamed.push({ old: oq, new: nq });
    if (oq.type !== nq.type) changes.typeChanged.push({ old: oq, new: nq });
  });
  // Option-level changes
  const oldOpts = oldQs.flatMap(q => (q.options || []).map(o => ({ ...o, questionId: q.id, questionPrompt: q.prompt })));
  const newOpts = newQs.flatMap(q => (q.options || []).map(o => ({ ...o, questionId: q.id, questionPrompt: q.prompt })));
  const oldOptIds = new Set(oldOpts.map(o => o.id));
  const newOptIds = new Set(newOpts.map(o => o.id));
  changes.addedOptions = newOpts.filter(o => !oldOptIds.has(o.id));
  changes.removedOptions = oldOpts.filter(o => !newOptIds.has(o.id));
  return changes;
};

const FormBuilder = ({isOrg = false}) => {
  SWC = useSWC();
  const [mode, setMode] = useState('compose'); // compose | wire | preview
  const [forms, setForms] = useState([{
    id: fbUid(), name: 'New Form', key: 'new_form', description: '', status: 'draft',
    version: 1, versionHistory: [], createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
    maturity: 'draft', source: { level: isOrg ? 'org' : 'local', propagation: 'optional' },
    sections: [{id: fbUid(), title: 'General', questions: []}]
  }]);
  const [activeFormIdx, setActiveFormIdx] = useState(0);
  const [frameworks, setFrameworks] = useState([]);
  const [bindings, setBindings] = useState({}); // `${valueId}__${codeId}` → {t, method, confidence, notes}
  const [crosswalks, setCrosswalks] = useState([]);

  // ── Saved forms library ──
  const [savedForms, setSavedForms] = useState([]); // [{id, name, key, version, maturity, savedAt, form, frameworks, bindings, crosswalks}]
  const [showFormList, setShowFormList] = useState(false);
  const [saving, setSaving] = useState(false);

  // ── Versioning state ──
  const [showVersionHistory, setShowVersionHistory] = useState(false);
  const [showVersionBump, setShowVersionBump] = useState(false);
  const [versionNotes, setVersionNotes] = useState('');

  // ── Answer crosswalk state ──
  const [showAnswerCrosswalk, setShowAnswerCrosswalk] = useState(false);
  const [crosswalkSource, setCrosswalkSource] = useState(null); // saved form (old version) to map from
  const [answerMappings, setAnswerMappings] = useState({}); // oldOptionId → newOptionId

  // UI state
  const [editingFormName, setEditingFormName] = useState(false);
  const [addingSection, setAddingSection] = useState(false);
  const [addingQuestion, setAddingQuestion] = useState(null); // sectionId
  const [addingAnswer, setAddingAnswer] = useState(null); // questionId
  const [addingFw, setAddingFw] = useState(false);
  const [addingCode, setAddingCode] = useState(null); // frameworkId
  const [wiringValue, setWiringValue] = useState(null); // {question, value, sectionIdx}
  const [adoptingFw, setAdoptingFw] = useState(false);
  const [addingXW, setAddingXW] = useState(false);
  const [givenNudge, setGivenNudge] = useState(null); // {questionId, signals, suggestions}
  const [draft, setDraft] = useState('');
  const [draft2, setDraft2] = useState('');
  const [draft3, setDraft3] = useState('');
  const [expandedSections, setExpandedSections] = useState(new Set(['all']));
  const [xwFrom, setXwFrom] = useState('');
  const [xwTo, setXwTo] = useState('');
  const [xwType, setXwType] = useState('equivalent');
  const [xwNotes, setXwNotes] = useState('');

  const form = forms[activeFormIdx];

  // ── Derived data ──
  const allQuestions = form.sections.flatMap(s => s.questions);
  const allValues = allQuestions.flatMap(q => (q.options || []).map(o => ({...o, questionId: q.id, questionPrompt: q.prompt})));
  const allCodes = frameworks.flatMap((f, fi) => f.codes.map(c => ({...c, frameworkId: f.id, frameworkName: f.name, fwIdx: fi})));

  // ── Binding helpers ──
  const getBindingCode = (valId, fwId) => {
    const fw = frameworks.find(f => f.id === fwId);
    if (!fw) return null;
    for (const c of fw.codes) if (bindings[`${valId}__${c.id}`]) return c;
    return null;
  };
  const getBindingsForValue = (valId) => frameworks.map((f, fi) => {
    const c = getBindingCode(valId, f.id);
    return c ? {...c, fwIdx: fi, frameworkName: f.name, frameworkId: f.id} : null;
  }).filter(Boolean);
  const getUnboundFrameworks = (valId) => frameworks.filter(f => !getBindingCode(valId, f.id));
  const hasConflict = (valId) => {
    const cs = getBindingsForValue(valId);
    return cs.length >= 2 && new Set(cs.map(c => c.label)).size > 1;
  };
  const getProvDotState = (valId) => {
    if (frameworks.length === 0) return 'none';
    const bound = getBindingsForValue(valId);
    if (bound.length === 0) return 'unbound';
    if (hasConflict(valId)) return 'conflict';
    return 'bound';
  };
  const doSetBind = (valId, codeId, fwId) => {
    const nb = {...bindings};
    const fw = frameworks.find(f => f.id === fwId);
    if (fw) fw.codes.forEach(c => { delete nb[`${valId}__${c.id}`]; });
    nb[`${valId}__${codeId}`] = {t: Date.now(), method: 'manual', confidence: 1.0};
    setBindings(nb);
  };
  const doClearBind = (valId, fwId) => {
    const nb = {...bindings};
    const fw = frameworks.find(f => f.id === fwId);
    if (fw) fw.codes.forEach(c => { delete nb[`${valId}__${c.id}`]; });
    setBindings(nb);
  };

  // ── Form mutation helpers ──
  const updateForm = (fn) => setForms(fs => fs.map((f, i) => i === activeFormIdx ? fn(f) : f));
  const updateSection = (secId, fn) => updateForm(f => ({...f, sections: f.sections.map(s => s.id === secId ? fn(s) : s)}));
  const updateQuestion = (secId, qId, fn) => updateSection(secId, s => ({...s, questions: s.questions.map(q => q.id === qId ? fn(q) : q)}));

  const doAddSection = () => {
    if (!draft.trim()) return;
    updateForm(f => ({...f, sections: [...f.sections, {id: fbUid(), title: draft.trim(), questions: []}]}));
    setDraft(''); setAddingSection(false);
  };
  const doAddQuestion = (secId) => {
    if (!draft.trim()) return;
    const prompt = draft.trim();
    const qId = fbUid();
    const signals = checkGivenTest(prompt);
    if (signals) {
      setGivenNudge({questionId: qId, signals, suggestions: suggestGivenRephrasing(prompt), originalPrompt: prompt, sectionId: secId});
    }
    updateSection(secId, s => ({...s, questions: [...s.questions, {
      id: qId, prompt, type: draft2 || 'single_select', options: [],
      origin: isOrg ? 'org' : 'local', givenTestPassed: !signals, helpText: ''
    }]}));
    setDraft(''); setDraft2(''); setAddingQuestion(null);
  };
  const doAddAnswer = (secId, qId) => {
    if (!draft.trim()) return;
    updateQuestion(secId, qId, q => ({...q, options: [...q.options, {
      id: fbUid(), label: draft.trim(), origin: isOrg ? 'org' : 'local'
    }]}));
    setDraft('');
  };
  const doRemoveQuestion = (secId, qId) => {
    updateSection(secId, s => ({...s, questions: s.questions.filter(q => q.id !== qId)}));
  };
  const doRemoveAnswer = (secId, qId, valId) => {
    updateQuestion(secId, qId, q => ({...q, options: q.options.filter(o => o.id !== valId)}));
    // Clean up bindings for removed value
    const nb = {...bindings};
    Object.keys(nb).forEach(k => { if (k.startsWith(`${valId}__`)) delete nb[k]; });
    setBindings(nb);
  };
  const doMoveQuestion = (secId, qIdx, dir) => {
    updateSection(secId, s => {
      const qs = [...s.questions];
      const newIdx = qIdx + dir;
      if (newIdx < 0 || newIdx >= qs.length) return s;
      [qs[qIdx], qs[newIdx]] = [qs[newIdx], qs[qIdx]];
      return {...s, questions: qs};
    });
  };

  // ── Framework helpers ──
  const doAddFramework = () => {
    if (!draft.trim()) return;
    setFrameworks(fs => [...fs, {id: fbUid(), name: draft.trim(), fullName: draft2.trim() || null,
      authority: draft3.trim() || null, type: 'local', codes: [], adoptedAt: new Date().toISOString()}]);
    setDraft(''); setDraft2(''); setDraft3(''); setAddingFw(false);
  };
  const doAddCode = (fwId) => {
    if (!draft.trim() || !draft2.trim()) return;
    setFrameworks(fs => fs.map(f => f.id === fwId ? {...f, codes: [...f.codes, {
      id: fbUid(), code: draft.trim(), label: draft2.trim(), definition: draft3.trim() || null
    }]} : f));
    setDraft(''); setDraft2(''); setDraft3('');
  };

  // ── Auto-suggest bindings ──
  const autoSuggestBindings = (fwId) => {
    const fw = frameworks.find(f => f.id === fwId);
    if (!fw || fw.codes.length === 0) return [];
    const suggestions = [];
    allValues.forEach(val => {
      const valLower = val.label.toLowerCase();
      fw.codes.forEach(code => {
        const codeLower = code.label.toLowerCase();
        // Simple label similarity: check if they share significant words
        const valWords = valLower.split(/\s+/).filter(w => w.length > 2);
        const codeWords = codeLower.split(/\s+/).filter(w => w.length > 2);
        const shared = valWords.filter(w => codeWords.some(cw => cw.includes(w) || w.includes(cw)));
        if (shared.length > 0 || valLower.includes(codeLower) || codeLower.includes(valLower)) {
          const confidence = Math.min(0.95, 0.5 + (shared.length * 0.15));
          if (!bindings[`${val.id}__${code.id}`]) {
            suggestions.push({valueId: val.id, valueLabel: val.label, codeId: code.id,
              codeLabel: code.label, codeValue: code.code, fwId, confidence});
          }
        }
      });
    });
    return suggestions;
  };
  const doAcceptSuggestion = (suggestion) => {
    const nb = {...bindings};
    const fw = frameworks.find(f => f.id === suggestion.fwId);
    if (fw) fw.codes.forEach(c => { delete nb[`${suggestion.valueId}__${c.id}`]; });
    nb[`${suggestion.valueId}__${suggestion.codeId}`] = {
      t: Date.now(), method: 'auto_suggested', confidence: suggestion.confidence
    };
    setBindings(nb);
  };
  const doAcceptAllSuggestions = (suggestions) => {
    const nb = {...bindings};
    suggestions.forEach(s => {
      const fw = frameworks.find(f => f.id === s.fwId);
      if (fw) fw.codes.forEach(c => { delete nb[`${s.valueId}__${c.id}`]; });
      nb[`${s.valueId}__${s.codeId}`] = {t: Date.now(), method: 'auto_suggested', confidence: s.confidence};
    });
    setBindings(nb);
  };

  // ── Crosswalk helpers ──
  const doAddXW = () => {
    if (!xwFrom || !xwTo) return;
    setCrosswalks(xws => [...xws, {id: fbUid(), fromCodeId: xwFrom, toCodeId: xwTo, type: xwType, notes: xwNotes}]);
    setAddingXW(false); setXwFrom(''); setXwTo(''); setXwType('equivalent'); setXwNotes('');
  };

  // ── Form naming helpers ──
  const doRenameForm = (newName) => {
    const key = formNameToKey(newName);
    updateForm(f => ({...f, name: newName.trim(), key, updatedAt: new Date().toISOString()}));
    setEditingFormName(false); setDraft('');
  };
  const doSetDescription = (desc) => {
    updateForm(f => ({...f, description: desc, updatedAt: new Date().toISOString()}));
  };
  const doSetMaturity = (maturity) => {
    updateForm(f => ({...f, maturity, updatedAt: new Date().toISOString()}));
  };
  const doSetPropagation = (propagation) => {
    updateForm(f => ({...f, source: {...(f.source || {}), propagation}, updatedAt: new Date().toISOString()}));
  };

  // ── Save form to library ──
  const doSaveForm = () => {
    setSaving(true);
    const snapshot = {
      id: form.key + '_v' + form.version,
      formId: form.id,
      name: form.name,
      key: form.key,
      version: form.version,
      maturity: form.maturity,
      description: form.description,
      source: form.source,
      savedAt: new Date().toISOString(),
      form: JSON.parse(JSON.stringify(form)),
      frameworks: JSON.parse(JSON.stringify(frameworks)),
      bindings: JSON.parse(JSON.stringify(bindings)),
      crosswalks: JSON.parse(JSON.stringify(crosswalks)),
    };
    // Replace existing save for same key+version, or append
    setSavedForms(prev => {
      const idx = prev.findIndex(s => s.key === snapshot.key && s.version === snapshot.version);
      if (idx >= 0) { const next = [...prev]; next[idx] = snapshot; return next; }
      return [...prev, snapshot];
    });
    updateForm(f => ({...f, updatedAt: new Date().toISOString(), status: 'saved'}));
    setTimeout(() => setSaving(false), 600);
  };

  // ── Load form from library ──
  const doLoadForm = (saved) => {
    // Restore form into active slot
    setForms(fs => fs.map((f, i) => i === activeFormIdx ? {...saved.form} : f));
    setFrameworks(saved.frameworks || []);
    setBindings(saved.bindings || {});
    setCrosswalks(saved.crosswalks || []);
    setShowFormList(false);
  };

  // ── New blank form ──
  const doNewForm = () => {
    const newForm = {
      id: fbUid(), name: 'Untitled Form', key: 'untitled_form', description: '', status: 'draft',
      version: 1, versionHistory: [], createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
      maturity: 'draft', source: { level: isOrg ? 'org' : 'local', propagation: 'optional' },
      sections: [{id: fbUid(), title: 'General', questions: []}]
    };
    setForms(fs => [...fs, newForm]);
    setActiveFormIdx(forms.length);
    setFrameworks([]); setBindings({}); setCrosswalks([]);
    setShowFormList(false);
  };

  // ── Delete saved form ──
  const doDeleteSaved = (savedId) => {
    setSavedForms(prev => prev.filter(s => s.id !== savedId));
  };

  // ── Version bump ──
  const doVersionBump = (bumpType) => {
    // Save current as history entry before bumping
    const historyEntry = {
      version: form.version,
      name: form.name,
      snapshot: JSON.parse(JSON.stringify(form)),
      frameworks: JSON.parse(JSON.stringify(frameworks)),
      bindings: JSON.parse(JSON.stringify(bindings)),
      crosswalks: JSON.parse(JSON.stringify(crosswalks)),
      bumpedAt: new Date().toISOString(),
      notes: versionNotes || ('Version ' + form.version + ' snapshot'),
    };
    const nextVersion = bumpType === 'major' ? Math.floor(form.version) + 1 : +(form.version + 0.1).toFixed(1);
    updateForm(f => ({
      ...f,
      version: nextVersion,
      versionHistory: [...(f.versionHistory || []), historyEntry],
      updatedAt: new Date().toISOString(),
      status: 'draft',
    }));
    setShowVersionBump(false);
    setVersionNotes('');
  };

  // ── Answer crosswalk — build mappings from old version to current ──
  const doStartAnswerCrosswalk = (sourceVersion) => {
    // sourceVersion is a history entry or a saved form
    const sourceForm = sourceVersion.snapshot || sourceVersion.form;
    setCrosswalkSource({ ...sourceVersion, form: sourceForm });
    setAnswerMappings({});
    setShowAnswerCrosswalk(true);
  };
  const doSetAnswerMapping = (oldOptId, newOptId) => {
    setAnswerMappings(prev => {
      if (!newOptId) { const next = {...prev}; delete next[oldOptId]; return next; }
      return {...prev, [oldOptId]: newOptId};
    });
  };
  const doSaveAnswerCrosswalk = () => {
    // Save the mapping as a form-level crosswalk record
    const xwRecord = {
      id: fbUid(),
      type: 'answer_version_crosswalk',
      fromFormKey: form.key,
      fromVersion: crosswalkSource.version,
      toVersion: form.version,
      mappings: {...answerMappings},
      createdAt: new Date().toISOString(),
    };
    updateForm(f => ({
      ...f,
      answerCrosswalks: [...(f.answerCrosswalks || []), xwRecord],
      updatedAt: new Date().toISOString(),
    }));
    setShowAnswerCrosswalk(false);
    setCrosswalkSource(null);
    setAnswerMappings({});
  };

  // ── Persist to Matrix schema room (if svc is available) ──
  const doPersistToSchema = async () => {
    if (!svc || !svc.userId) return;
    setSaving(true);
    try {
      // Find schema room from scanned rooms
      const rooms = svc._client?.getRooms?.() || [];
      let schemaRoomId = null;
      for (const r of rooms) {
        try {
          const idEvt = r.currentState?.getStateEvents?.(EVT.IDENTITY, '');
          if (idEvt && idEvt.getContent?.()?.account_type === 'schema') { schemaRoomId = r.roomId; break; }
        } catch(e) { /* skip */ }
      }
      if (!schemaRoomId) { setSaving(false); return; }
      // Build the schema-compatible form object
      const schemaForm = {
        id: form.key || form.id,
        name: form.name,
        version: form.version,
        description: form.description || '',
        maturity: form.maturity || 'draft',
        source: form.source || { level: isOrg ? 'org' : 'local', propagation: 'optional' },
        versionHistory: (form.versionHistory || []).map(h => ({ version: h.version, bumpedAt: h.bumpedAt, notes: h.notes })),
        answerCrosswalks: form.answerCrosswalks || [],
        fields: form.sections.flatMap(sec => sec.questions.map(q => ({
          id: q.id, key: formNameToKey(q.prompt), question: q.prompt, type: q.type,
          version: form.version, maturity: form.maturity || 'draft', section: sec.title,
          options: (q.options || []).map(o => ({ v: formNameToKey(o.label), l: o.label, id: o.id })),
          category: formNameToKey(sec.title), sensitive: false, metrics: true,
        }))),
        eo: {
          chain: [{ op: 'DES', target: { entity: form.key, designation: form.name + ' Form' },
            frame: { type: 'schema', epistemic: 'GIVEN', role: isOrg ? 'org' : 'local' } }],
          trace: `${form.key} = DES (${isOrg ? 'org' : 'local'}-authored, ${form.source?.propagation || 'optional'} propagation)`
        },
        savedAt: new Date().toISOString(),
      };
      await svc.setState(schemaRoomId, EVT.SCHEMA_FORM, schemaForm, schemaForm.id);
      updateForm(f => ({...f, status: 'persisted', updatedAt: new Date().toISOString()}));
    } catch(e) {
      console.error('Failed to persist form to schema room:', e);
    }
    setSaving(false);
  };

  // ── Stats ──
  const totalBindings = Object.keys(bindings).length;
  const totalPossible = allValues.length * frameworks.length;
  const boundCount = allValues.filter(v => getBindingsForValue(v.id).length > 0).length;
  const conflictCount = allValues.filter(v => hasConflict(v.id)).length;

  const toggleSection = (secId) => {
    const next = new Set(expandedSections);
    if (next.has(secId) || next.has('all')) { next.delete(secId); next.delete('all'); }
    else next.add(secId);
    setExpandedSections(next);
  };
  const isSectionExpanded = (secId) => expandedSections.has('all') || expandedSections.has(secId);

  return (
    <div className="anim-up" style={{maxWidth:960,margin:'0 auto'}}>
      {/* ═══ PAGE TITLE + MODE TOGGLE ═══ */}
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:20}}>
        <div>
          <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>Schema Builder</h2>
          <p style={{color:'var(--tx-1)',fontSize:12.5}}>Build forms, wire them to frameworks, and manage your data vocabulary.</p>
        </div>
        <div className="fb-mode-toggle">
          <button className={`fb-mode-btn ${mode==='compose'?'active':''}`} onClick={()=>setMode('compose')}>
            <I n="grid" s={13}/> Compose
          </button>
          <button className={`fb-mode-btn ${mode==='wire'?'active':''}`} onClick={()=>setMode('wire')}>
            <I n="link" s={13}/> Wire
            {frameworks.length > 0 && totalPossible > 0 && (
              <span style={{fontSize:10,color:totalBindings===totalPossible?SWC.given:SWC.dim,fontFamily:'var(--mono)'}}>
                {totalBindings}/{totalPossible}
              </span>
            )}
          </button>
          <button className={`fb-mode-btn ${mode==='preview'?'active':''}`} onClick={()=>setMode('preview')}>
            <I n="eye" s={13}/> Preview
          </button>
        </div>
      </div>

      {/* ═══ FORM HEADER ═══ */}
      <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:12,marginBottom:16,
        padding:'14px 18px',borderRadius:'var(--r-lg)',border:`1px solid ${SWC.border}`,background:SWC.surface}}>
        <div style={{flex:1,minWidth:0}}>
          <div style={{display:'flex',alignItems:'center',gap:8,flexWrap:'wrap'}}>
            {editingFormName ? (
              <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Form name..."
                onKeyDown={e => { if (e.key==='Enter' && draft.trim()) { doRenameForm(draft); }
                  if (e.key==='Escape') { setEditingFormName(false); setDraft(''); }}}
                style={{width:260,padding:'6px 10px',fontSize:17,fontFamily:'var(--serif)',fontWeight:700}}/>
            ) : (
              <span style={{fontFamily:'var(--serif)',fontSize:17,fontWeight:700,cursor:'pointer'}}
                onClick={()=>{setDraft(form.name);setEditingFormName(true);}} title="Click to rename">
                {form.name}
              </span>
            )}
            <SwTag color={MATURITY_LEVELS[form.maturity]?.color === 'green' ? SWC.given : MATURITY_LEVELS[form.maturity]?.color === 'red' ? SWC.red : SWC.meant} sm>
              {MATURITY_LEVELS[form.maturity]?.label || 'Draft'}
            </SwTag>
            <span style={{fontSize:11,color:SWC.dim,fontFamily:'var(--mono)',cursor:'pointer',borderBottom:`1px dashed ${SWC.dim}`}}
              onClick={()=>setShowVersionBump(true)} title="Click to bump version">v{form.version}</span>
            {form.status === 'persisted' && <SwTag color={SWC.given} sm>Saved</SwTag>}
          </div>
          <div style={{fontSize:11,color:SWC.dim,fontFamily:'var(--mono)',marginTop:4}}>
            {allQuestions.length} question{allQuestions.length!==1?'s':''} · {allValues.length} option{allValues.length!==1?'s':''}
            {frameworks.length > 0 && <> · {frameworks.length} fw</>}
            {totalBindings > 0 && <> · {totalBindings} binding{totalBindings!==1?'s':''}</>}
            {conflictCount > 0 && <span style={{color:SWC.sup}}> · {conflictCount} conflict{conflictCount!==1?'s':''}</span>}
          </div>
        </div>
        <div style={{display:'flex',gap:5,alignItems:'center',flexShrink:0}}>
          <SwBtn ghost accent={SWC.muted} onClick={()=>setShowFormList(true)} style={{padding:'5px 10px',fontSize:11}}>
            <I n="folder" s={11}/> Library
            {savedForms.length > 0 && <span style={{marginLeft:4,fontFamily:'var(--mono)',fontSize:10}}>{savedForms.length}</span>}
          </SwBtn>
          <SwBtn ghost accent={SWC.given} onClick={doSaveForm} disabled={saving} style={{padding:'5px 10px',fontSize:11}}>
            {saving ? '...' : 'Save'}
          </SwBtn>
          {(form.versionHistory || []).length > 0 && (
            <SwBtn ghost accent={SWC.dim} onClick={()=>setShowVersionHistory(true)} style={{padding:'5px 10px',fontSize:11}}>
              History
            </SwBtn>
          )}
          <SwBtn ghost accent={SWC.sup} onClick={doPersistToSchema} disabled={saving} style={{padding:'5px 10px',fontSize:11}} title="Save to Matrix schema room">
            Publish
          </SwBtn>
        </div>
      </div>

      {/* ═══ FORM METADATA ═══ */}
      {mode === 'compose' && (
        <div style={{display:'flex',gap:10,alignItems:'center',marginBottom:14,fontSize:12}}>
          <select value={form.maturity || 'draft'} onChange={e => doSetMaturity(e.target.value)}
            style={{padding:'5px 10px',borderRadius:5,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:11,fontFamily:'inherit'}}>
            {Object.entries(MATURITY_LEVELS).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
          </select>
          <select value={form.source?.propagation || 'optional'} onChange={e => doSetPropagation(e.target.value)}
            style={{padding:'5px 10px',borderRadius:5,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:11,fontFamily:'inherit'}}>
            {Object.entries(PROPAGATION_LEVELS).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
          </select>
          <input value={form.description || ''} onChange={e => doSetDescription(e.target.value)} placeholder="Form description..."
            style={{flex:1,padding:'5px 10px',borderRadius:5,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:11,fontFamily:'inherit'}}/>
        </div>
      )}

      {/* ═══ COMPOSE MODE ═══ */}
      {mode === 'compose' && (
        <div>

          {/* Sections */}
          {form.sections.map((sec, secIdx) => (
            <div key={sec.id} className="fb-section">
              <div className="fb-section-header" onClick={()=>toggleSection(sec.id)}>
                <div className="fb-section-title">
                  <span style={{fontSize:11,color:SWC.dim,transform:isSectionExpanded(sec.id)?'rotate(90deg)':'rotate(0)',transition:'transform .15s',display:'inline-block'}}>▶</span>
                  {sec.title}
                  <span className="fb-section-count">{sec.questions.length} question{sec.questions.length!==1?'s':''}</span>
                </div>
                {sec.origin === 'network' && <span className="fb-inherit-lock">🔒 Network</span>}
                {sec.origin === 'local' && sec.questions.some(q=>q.origin==='local') && <span className="fb-inherit-local">🏠 Local</span>}
              </div>

              {isSectionExpanded(sec.id) && (
                <div>
                  {sec.questions.map((q, qIdx) => (
                    <div key={q.id} className="fb-question">
                      <div className="fb-question-prompt">
                        <span>{q.prompt}</span>
                        <span className="fb-question-type">{q.type}</span>
                        {q.origin === 'network' && <span className="fb-inherit-lock">🔒</span>}
                        {q.origin === 'local' && <span className="fb-inherit-local">🏠</span>}
                        {!q.givenTestPassed && <span style={{fontSize:11,color:SWC.sup}} title="This question may embed institutional interpretation">⚠</span>}
                        {hasConflict && q.options?.some(o => hasConflict(o.id)) && <span style={{fontSize:11}} title="Framework conflict">⚡</span>}
                      </div>

                      {/* Answer options */}
                      {(q.type === 'single_select' || q.type === 'multi_select') && (
                        <div className="fb-answer-list">
                          {(q.options || []).map(opt => {
                            const dotState = getProvDotState(opt.id);
                            return (
                              <div key={opt.id} className="fb-answer"
                                onClick={()=>{if(frameworks.length>0){setWiringValue({question:q,value:opt,sectionIdx:secIdx});setMode('wire');}}}
                              >
                                <div className={q.type==='single_select'?'fb-answer-radio':'fb-answer-check'}/>
                                <span className="fb-answer-label">{opt.label}</span>
                                {opt.origin === 'network' && <span className="fb-inherit-lock">🔒</span>}
                                {opt.origin === 'local' && <span className="fb-inherit-local">🏠</span>}
                                <div className="fb-answer-dots">
                                  {frameworks.map((fw, fi) => {
                                    const code = getBindingCode(opt.id, fw.id);
                                    const isConflict = hasConflict(opt.id);
                                    return <span key={fw.id} className={`fb-prov-dot ${code ? (isConflict ? 'conflict' : 'bound') : 'unbound'}`}
                                      title={code ? `${fw.name}: ${code.code} — ${code.label}${isConflict?' (conflict)':''}` : `${fw.name}: not bound`}
                                      style={code ? {background: SWC.fw[fi%5]} : {}}
                                    />;
                                  })}
                                </div>
                                <button onClick={e=>{e.stopPropagation();doRemoveAnswer(sec.id,q.id,opt.id);}} style={{background:'none',border:'none',color:SWC.dim,cursor:'pointer',fontSize:14,padding:'2px 4px',opacity:0.5,transition:'opacity .15s'}}
                                  onMouseEnter={e=>e.currentTarget.style.opacity='1'} onMouseLeave={e=>e.currentTarget.style.opacity='0.5'}>×</button>
                              </div>
                            );
                          })}

                          {/* Add answer inline */}
                          {addingAnswer === q.id ? (
                            <div style={{display:'flex',gap:6,padding:'4px 10px',alignItems:'center'}}>
                              <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Answer option..."
                                onKeyDown={e=>{if(e.key==='Enter'){doAddAnswer(sec.id,q.id);} if(e.key==='Escape'){setAddingAnswer(null);setDraft('');}}}
                                style={{padding:'6px 10px',fontSize:13}}/>
                              <SwBtn onClick={()=>doAddAnswer(sec.id,q.id)} disabled={!draft.trim()} style={{padding:'5px 12px',fontSize:11}}>Add</SwBtn>
                              <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingAnswer(null);setDraft('');}} style={{padding:'5px 8px',fontSize:11}}>×</SwBtn>
                            </div>
                          ) : (
                            <button className="fb-add-btn" onClick={()=>{setAddingAnswer(q.id);setDraft('');}}>+ Add answer option</button>
                          )}
                        </div>
                      )}

                      {/* Question source & wire button */}
                      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:8}}>
                        <div className="fb-source-tag">
                          {q.origin === 'network' ? 'Source: Network (required)' : q.origin === 'org' ? 'Source: Organization' : 'Source: Local'}
                          {!q.givenTestPassed && <span style={{color:SWC.sup,fontSize:10}}>MEANT-origin</span>}
                        </div>
                        <div style={{display:'flex',gap:6,alignItems:'center'}}>
                          {frameworks.length > 0 && q.options?.length > 0 && (
                            <button className="fb-wire-btn" onClick={()=>{setWiringValue({question:q,value:q.options[0],sectionIdx:secIdx});setMode('wire');}}>
                              Wire to frameworks →
                            </button>
                          )}
                          <div style={{display:'flex',gap:2}}>
                            <button onClick={()=>doMoveQuestion(sec.id,qIdx,-1)} disabled={qIdx===0}
                              style={{background:'none',border:'1px solid '+SWC.border,borderRadius:4,color:SWC.dim,cursor:qIdx===0?'default':'pointer',padding:'2px 6px',fontSize:11,opacity:qIdx===0?0.3:1}}>↑</button>
                            <button onClick={()=>doMoveQuestion(sec.id,qIdx,1)} disabled={qIdx===sec.questions.length-1}
                              style={{background:'none',border:'1px solid '+SWC.border,borderRadius:4,color:SWC.dim,cursor:qIdx===sec.questions.length-1?'default':'pointer',padding:'2px 6px',fontSize:11,opacity:qIdx===sec.questions.length-1?0.3:1}}>↓</button>
                            <button onClick={()=>doRemoveQuestion(sec.id,q.id)}
                              style={{background:'none',border:'1px solid '+SWC.border,borderRadius:4,color:SWC.dim,cursor:'pointer',padding:'2px 6px',fontSize:11}}
                              onMouseEnter={e=>e.currentTarget.style.color=SWC.red} onMouseLeave={e=>e.currentTarget.style.color=SWC.dim}>×</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}

                  {/* Add question to section */}
                  {addingQuestion === sec.id ? (
                    <div style={{padding:'14px 18px',borderTop:sec.questions.length>0?`1px solid ${SWC.border}`:'none'}}>
                      <div style={{fontSize:13,fontWeight:600,color:SWC.given,marginBottom:8}}>New Question</div>
                      <SwInput autoFocus value={draft} onChange={v=>{setDraft(v);setGivenNudge(null);}} placeholder="Type your question..."
                        onKeyDown={e=>{if(e.key==='Enter' && draft.trim()){doAddQuestion(sec.id);} if(e.key==='Escape'){setAddingQuestion(null);setDraft('');setDraft2('');setGivenNudge(null);}}}/>
                      <div style={{display:'flex',gap:8,marginTop:8,alignItems:'center'}}>
                        <select value={draft2||'single_select'} onChange={e=>setDraft2(e.target.value)}
                          style={{padding:'7px 10px',borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:12,fontFamily:'inherit'}}>
                          <option value="single_select">Single select</option>
                          <option value="multi_select">Multi select</option>
                          <option value="text">Text</option>
                          <option value="number">Number</option>
                          <option value="date">Date</option>
                          <option value="duration">Duration</option>
                          <option value="boolean">Yes/No</option>
                          <option value="scale">Scale</option>
                        </select>
                        <SwBtn onClick={()=>doAddQuestion(sec.id)} disabled={!draft.trim()}>Create</SwBtn>
                        <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingQuestion(null);setDraft('');setDraft2('');setGivenNudge(null);}}>Cancel</SwBtn>
                      </div>

                      {/* GIVEN test nudge */}
                      {draft.trim() && checkGivenTest(draft) && (
                        <div className="fb-nudge">
                          <div className="fb-nudge-title">
                            <I n="alert" s={12} c={SWC.fw[0]}/>
                            This question may embed institutional interpretation
                          </div>
                          <div style={{marginBottom:6}}>
                            Detected signal words: {checkGivenTest(draft).map(w => <SwTag key={w} color={SWC.sup} sm style={{marginRight:4}}>{w}</SwTag>)}
                          </div>
                          <div style={{fontSize:12.5,color:SWC.dim,marginBottom:6}}>
                            Consider rephrasing as something a person could answer without institutional knowledge:
                          </div>
                          {suggestGivenRephrasing(draft).map((sug, i) => (
                            <div key={i} className="fb-nudge-suggestion" onClick={()=>setDraft(sug)}>{sug}</div>
                          ))}
                          <div style={{marginTop:8,fontSize:12,color:SWC.dim}}>
                            <span style={{cursor:'pointer',textDecoration:'underline'}} onClick={()=>setGivenNudge(null)}>Keep as-is</span> — the question will be tagged as MEANT-origin.
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <button className="fb-add-btn" style={{borderTop:sec.questions.length>0?`1px solid ${SWC.border}`:'none'}}
                      onClick={()=>{setAddingQuestion(sec.id);setDraft('');setDraft2('');}}>
                      + Add question
                    </button>
                  )}
                </div>
              )}
            </div>
          ))}

          {/* Add section */}
          {addingSection ? (
            <div style={{padding:16,border:`1px solid ${SWC.border}`,borderRadius:8,background:SWC.surface,marginBottom:16}}>
              <div style={{fontSize:13,fontWeight:600,color:SWC.white,marginBottom:8}}>New Section</div>
              <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Section title..."
                onKeyDown={e=>{if(e.key==='Enter')doAddSection();if(e.key==='Escape'){setAddingSection(false);setDraft('');}}}/>
              <div style={{display:'flex',gap:8,marginTop:8}}>
                <SwBtn onClick={doAddSection} disabled={!draft.trim()}>Create</SwBtn>
                <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingSection(false);setDraft('');}}>Cancel</SwBtn>
              </div>
            </div>
          ) : (
            <div style={{display:'flex',gap:8,marginBottom:16}}>
              <button className="fb-add-btn" style={{border:`1px dashed ${SWC.border}`,borderRadius:8,justifyContent:'center'}}
                onClick={()=>{setAddingSection(true);setDraft('');}}>+ Add section</button>
            </div>
          )}

          {/* Unbound values notice */}
          {frameworks.length > 0 && allValues.length > 0 && (
            (() => {
              const unboundCount = allValues.filter(v => getBindingsForValue(v.id).length === 0).length;
              return unboundCount > 0 ? (
                <div style={{padding:'12px 16px',borderRadius:8,border:`1px solid ${SWC.meantBorder}`,background:'rgba(167,139,250,0.04)',
                  fontSize:13,color:SWC.muted,lineHeight:1.6,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                  <span>{unboundCount} answer option{unboundCount!==1?'s aren\'t':' isn\'t'} connected to any framework yet.</span>
                  <button className="fb-wire-btn" onClick={()=>setMode('wire')}>Wire them →</button>
                </div>
              ) : null;
            })()
          )}

          {/* No frameworks yet — invitation (not error) */}
          {frameworks.length === 0 && allValues.length > 0 && (
            <div style={{padding:'14px 18px',borderRadius:8,border:`1px solid ${SWC.border}`,background:SWC.surface,
              fontSize:13,color:SWC.muted,lineHeight:1.6}}>
              This form collects observations without connecting them to any reporting framework. You can add framework bindings anytime.
              <button className="fb-wire-btn" style={{marginLeft:8}} onClick={()=>{setMode('wire');setAddingFw(true);setDraft('');setDraft2('');setDraft3('');}}>
                + Add a framework
              </button>
            </div>
          )}
        </div>
      )}

      {/* GIVEN test nudge dismissal */}
      {givenNudge && mode === 'compose' && (
        <div style={{position:'fixed',bottom:24,right:24,zIndex:45,width:380,background:SWC.surface,border:`1px solid ${SWC.fw[0]}40`,
          borderRadius:10,padding:16,boxShadow:'0 8px 32px rgba(0,0,0,0.4)'}}>
          <div style={{fontSize:13,fontWeight:600,color:SWC.fw[0],marginBottom:6}}>GIVEN Test Result</div>
          <div style={{fontSize:13,color:SWC.text,marginBottom:8}}>
            "{givenNudge.originalPrompt}" contains interpretation-language: {givenNudge.signals.join(', ')}
          </div>
          <div style={{fontSize:12,color:SWC.dim,marginBottom:8}}>The question was created but tagged as MEANT-origin. You can rephrase it anytime.</div>
          <SwBtn ghost accent={SWC.muted} onClick={()=>setGivenNudge(null)} style={{fontSize:12,padding:'5px 12px'}}>Dismiss</SwBtn>
        </div>
      )}


      {/* ═══ WIRE MODE ═══ */}
      {mode === 'wire' && (
        <div>
          {/* Framework management bar */}
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}}>
            <div style={{display:'flex',gap:6,alignItems:'center',flexWrap:'wrap'}}>
              {frameworks.map((fw, fi) => (
                <div key={fw.id} style={{display:'flex',alignItems:'center',gap:4,padding:'4px 10px',borderRadius:5,
                  border:`1px solid ${SWC.fw[fi%5]}40`,background:`${SWC.fw[fi%5]}10`,fontSize:12,fontWeight:600,color:SWC.fw[fi%5]}}>
                  <SwDot color={SWC.fw[fi%5]} size={6}/> {fw.name}
                  <span style={{fontSize:10,color:SWC.dim,marginLeft:4}}>{fw.codes.length}c</span>
                </div>
              ))}
              {frameworks.length === 0 && <span style={{fontSize:13,color:SWC.dim}}>No frameworks adopted yet.</span>}
            </div>
            <div style={{display:'flex',gap:6}}>
              <SwBtn ghost accent={SWC.meant} onClick={()=>{setAddingFw(true);setDraft('');setDraft2('');setDraft3('');}}>+ Add framework</SwBtn>
              {allValues.length > 0 && frameworks.length > 0 && (
                <SwBtn ghost accent={SWC.given} onClick={()=>setAdoptingFw(true)}>Auto-suggest bindings</SwBtn>
              )}
            </div>
          </div>

          {/* Add framework panel */}
          {addingFw && (
            <div style={{border:`1px solid ${SWC.meantBorder}`,borderRadius:10,background:SWC.surface,padding:16,marginBottom:16}}>
              <div style={{fontSize:15,fontWeight:600,color:SWC.meant,marginBottom:12}}>Adopt a Reporting Framework</div>
              <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Short name (e.g. HUD HMIS, CoC Priority)"
                onKeyDown={e=>{if(e.key==='Enter'&&draft.trim())doAddFramework();if(e.key==='Escape'){setAddingFw(false);setDraft('');setDraft2('');setDraft3('');}}}/>
              <div style={{marginTop:8}}><SwInput value={draft2} onChange={setDraft2} placeholder="Full name (optional)" onKeyDown={e=>{if(e.key==='Enter'&&draft.trim())doAddFramework();}}/></div>
              <div style={{marginTop:8}}><SwInput value={draft3} onChange={setDraft3} placeholder="Governing authority (optional)" onKeyDown={e=>{if(e.key==='Enter'&&draft.trim())doAddFramework();}}/></div>
              <div style={{fontSize:13,color:SWC.dim,marginTop:8,lineHeight:1.55}}>A framework defines institutional categories (MEANT). Add its codes after creation.</div>
              <div style={{display:'flex',gap:8,marginTop:12}}>
                <SwBtn accent={SWC.meant} onClick={doAddFramework} disabled={!draft.trim()}>Adopt</SwBtn>
                <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingFw(false);setDraft('');setDraft2('');setDraft3('');}}>Cancel</SwBtn>
              </div>
            </div>
          )}

          {/* Binding matrix — overview of all values × frameworks */}
          {allValues.length > 0 && frameworks.length > 0 && (
            <div style={{marginBottom:20}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
                <span style={{fontSize:12,fontWeight:700,textTransform:'uppercase',letterSpacing:'0.08em',color:SWC.muted}}>Binding Matrix</span>
                <SwTag color={SWC.meant} sm>GIVEN → MEANT</SwTag>
              </div>
              {form.sections.map(sec => (
                sec.questions.filter(q=>q.options && q.options.length > 0).map(q => (
                  <div key={q.id} style={{marginBottom:12}}>
                    <div style={{fontSize:14,fontWeight:600,color:SWC.white,marginBottom:6,display:'flex',alignItems:'center',gap:6}}>
                      {q.prompt}
                      {q.options.some(o=>hasConflict(o.id)) && <span style={{fontSize:11}}>⚡</span>}
                    </div>
                    <div style={{border:`1px solid ${SWC.border}`,borderRadius:8,overflow:'hidden',background:SWC.surface}}>
                      {/* Header row */}
                      <div style={{display:'grid',gridTemplateColumns:`minmax(140px,200px) repeat(${frameworks.length}, 1fr)`,
                        borderBottom:`1px solid ${SWC.border}`,background:SWC.raised}}>
                        <div style={{padding:'8px 12px',fontSize:11,fontWeight:700,textTransform:'uppercase',letterSpacing:'0.06em',color:SWC.dim}}>Value</div>
                        {frameworks.map((fw,fi) => (
                          <div key={fw.id} style={{padding:'8px 10px',fontSize:11,fontWeight:600,color:SWC.fw[fi%5],textAlign:'center',
                            borderLeft:`1px solid ${SWC.border}`,display:'flex',alignItems:'center',justifyContent:'center',gap:4}}>
                            <SwDot color={SWC.fw[fi%5]} size={5}/>{fw.name}
                          </div>
                        ))}
                      </div>
                      {/* Value rows */}
                      {q.options.map((opt, oi) => (
                        <SwMRow key={opt.id} opt={opt} frameworks={frameworks} getBindingCode={getBindingCode}
                          setBind={doSetBind} clearBind={doClearBind} hasConflict={(o)=>hasConflict(o.id)}
                          isLast={oi===q.options.length-1}/>
                      ))}
                    </div>
                  </div>
                ))
              ))}
            </div>
          )}

          {/* Frameworks & codes management */}
          {frameworks.length > 0 && (
            <div style={{marginBottom:20}}>
              <div style={{fontSize:12,fontWeight:700,textTransform:'uppercase',letterSpacing:'0.08em',color:SWC.muted,marginBottom:10}}>Framework Codes</div>
              {frameworks.map((fw, fi) => (
                <div key={fw.id} style={{border:`1px solid ${SWC.border}`,borderRadius:8,background:SWC.surface,marginBottom:8,overflow:'hidden'}}>
                  <div style={{padding:'10px 14px',borderBottom:`1px solid ${SWC.border}`,display:'flex',alignItems:'center',gap:6}}>
                    <SwDot color={SWC.fw[fi%5]} size={8}/>
                    <span style={{fontSize:14,fontWeight:600,color:SWC.fw[fi%5]}}>{fw.name}</span>
                    {fw.fullName && <span style={{fontSize:12,color:SWC.dim}}>— {fw.fullName}</span>}
                    {fw.authority && <span style={{fontSize:11,color:SWC.dim,marginLeft:'auto'}}>Authority: {fw.authority}</span>}
                    <span style={{fontSize:12,color:SWC.dim,marginLeft:fw.authority?8:'auto'}}>{fw.codes.length} code{fw.codes.length!==1?'s':''}</span>
                  </div>
                  <div style={{padding:'4px 6px'}}>
                    {fw.codes.map(c => (
                      <div key={c.id} style={{padding:'5px 10px',display:'flex',alignItems:'center',gap:8}}>
                        <SwTag color={SWC.fw[fi%5]} sm mono>{c.code}</SwTag>
                        <span style={{fontSize:13,color:SWC.text}}>{c.label}</span>
                        {c.definition && <span style={{fontSize:11,color:SWC.dim,marginLeft:'auto'}}>{c.definition}</span>}
                      </div>
                    ))}
                    {addingCode === fw.id ? (
                      <div style={{padding:'4px 8px'}}>
                        <div style={{display:'flex',gap:6,marginBottom:4}}>
                          <SwInput autoFocus value={draft} onChange={setDraft} placeholder="Code (e.g. Cat-1)"
                            onKeyDown={e=>{if(e.key==='Escape'){setAddingCode(null);setDraft('');setDraft2('');setDraft3('');}}}
                            style={{padding:'5px 10px',fontSize:12,width:100,flex:'none'}}/>
                          <SwInput value={draft2} onChange={setDraft2} placeholder="Label"
                            onKeyDown={e=>{if(e.key==='Enter'&&draft.trim()&&draft2.trim()){doAddCode(fw.id);}else if(e.key==='Escape'){setAddingCode(null);setDraft('');setDraft2('');setDraft3('');}}}
                            style={{padding:'5px 10px',fontSize:12}}/>
                        </div>
                        <SwInput value={draft3} onChange={setDraft3} placeholder="Definition (optional)"
                          style={{padding:'5px 10px',fontSize:12,marginBottom:6}}/>
                        <div style={{display:'flex',gap:6}}>
                          <SwBtn accent={SWC.meant} onClick={()=>doAddCode(fw.id)} disabled={!draft.trim()||!draft2.trim()} style={{padding:'5px 12px',fontSize:11}}>Add</SwBtn>
                          <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingCode(null);setDraft('');setDraft2('');setDraft3('');}} style={{padding:'5px 8px',fontSize:11}}>×</SwBtn>
                        </div>
                      </div>
                    ) : (
                      <div onClick={()=>{setAddingCode(fw.id);setDraft('');setDraft2('');setDraft3('');}} style={{padding:'8px 12px',fontSize:13,color:SWC.fw[fi%5],cursor:'pointer'}}>+ Add code</div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Crosswalks */}
          {frameworks.length >= 2 && (
            <div style={{marginBottom:20}}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}}>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:12,fontWeight:700,textTransform:'uppercase',letterSpacing:'0.08em',color:SWC.muted}}>Crosswalks</span>
                  <SwTag color={SWC.meant} sm>MEANT ↔ MEANT</SwTag>
                </div>
                {allCodes.length >= 2 && <SwBtn ghost accent={SWC.meant} onClick={()=>setAddingXW(true)}>+ Add crosswalk</SwBtn>}
              </div>
              <div style={{fontSize:13,color:SWC.dim,marginBottom:10,lineHeight:1.55}}>
                Crosswalks translate between frameworks — how one institution's codes map to another's.
              </div>
              {addingXW && (
                <div style={{border:`1px solid ${SWC.meantBorder}`,borderRadius:10,background:SWC.surface,padding:16,marginBottom:12}}>
                  <div style={{fontSize:15,fontWeight:600,color:SWC.meant,marginBottom:12}}>New Crosswalk</div>
                  <div style={{display:'flex',gap:8,marginBottom:8}}>
                    <select value={xwFrom} onChange={e=>setXwFrom(e.target.value)} style={{flex:1,padding:'7px 10px',borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:12,fontFamily:'inherit'}}>
                      <option value="">From code...</option>
                      {allCodes.map(c=><option key={c.id} value={c.id}>{c.frameworkName}: {c.code} — {c.label}</option>)}
                    </select>
                    <select value={xwTo} onChange={e=>setXwTo(e.target.value)} style={{flex:1,padding:'7px 10px',borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:12,fontFamily:'inherit'}}>
                      <option value="">To code...</option>
                      {allCodes.filter(c=>c.id!==xwFrom).map(c=><option key={c.id} value={c.id}>{c.frameworkName}: {c.code} — {c.label}</option>)}
                    </select>
                  </div>
                  <div style={{display:'flex',gap:6,marginBottom:8}}>
                    {['equivalent','implies','overlaps','conflicts'].map(t=>(
                      <SwTag key={t} color={xwType===t?(t==='conflicts'?SWC.sup:t==='equivalent'?SWC.given:SWC.meant):SWC.dim}
                        onClick={()=>setXwType(t)} sm style={{cursor:'pointer',padding:'3px 8px',fontSize:11}}>{t}</SwTag>
                    ))}
                  </div>
                  <SwInput value={xwNotes} onChange={setXwNotes} placeholder="Notes (optional)" style={{marginBottom:10}}/>
                  <div style={{display:'flex',gap:8}}>
                    <SwBtn accent={SWC.meant} onClick={doAddXW} disabled={!xwFrom||!xwTo}>Create</SwBtn>
                    <SwBtn ghost accent={SWC.muted} onClick={()=>{setAddingXW(false);setXwFrom('');setXwTo('');setXwNotes('');}}>Cancel</SwBtn>
                  </div>
                </div>
              )}
              {crosswalks.length === 0 && !addingXW ? (
                <div style={{padding:20,border:`1px dashed ${SWC.border}`,borderRadius:8,textAlign:'center',color:SWC.dim,fontSize:13}}>
                  {allCodes.length < 2 ? 'Need codes in at least two frameworks.' : 'No crosswalks yet.'}
                </div>
              ) : crosswalks.map(xw => {
                const from = allCodes.find(c=>c.id===xw.fromCodeId);
                const to = allCodes.find(c=>c.id===xw.toCodeId);
                if (!from || !to) return null;
                return (
                  <div key={xw.id} style={{border:`1px solid ${SWC.border}`,borderRadius:8,background:SWC.surface,padding:'10px 14px',marginBottom:6}}>
                    <div style={{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap',marginBottom:xw.notes?6:0}}>
                      <SwDot color={SWC.fw[from.fwIdx%5]} size={6}/><SwTag color={SWC.fw[from.fwIdx%5]} sm>{from.frameworkName}: {from.code}</SwTag>
                      <span style={{color:SWC.dim,fontSize:13}}>{xw.type==='equivalent'?'=':xw.type==='implies'?'→':xw.type==='overlaps'?'↔':'⚡'}</span>
                      <SwDot color={SWC.fw[to.fwIdx%5]} size={6}/><SwTag color={SWC.fw[to.fwIdx%5]} sm>{to.frameworkName}: {to.code}</SwTag>
                      <SwTag color={xw.type==='conflicts'?SWC.sup:xw.type==='equivalent'?SWC.given:SWC.meant} sm>{xw.type}</SwTag>
                    </div>
                    {xw.notes && <div style={{fontSize:13,color:SWC.text,lineHeight:1.55}}>{xw.notes}</div>}
                  </div>
                );
              })}
            </div>
          )}

          {/* No questions yet */}
          {allValues.length === 0 && (
            <div style={{padding:32,border:`1px dashed ${SWC.border}`,borderRadius:8,textAlign:'center',color:SWC.dim,fontSize:14}}>
              Add questions with answer options first, then wire them to frameworks here.
              <div style={{marginTop:12}}>
                <SwBtn ghost accent={SWC.given} onClick={()=>setMode('compose')}>← Back to Compose</SwBtn>
              </div>
            </div>
          )}
        </div>
      )}


      {/* ═══ WIRING PANEL (slide-in from right) ═══ */}
      {wiringValue && (
        <div style={{position:'fixed',inset:0,zIndex:39}} onClick={()=>setWiringValue(null)}>
          <div className="fb-wire-panel" onClick={e=>e.stopPropagation()}>
            <div className="fb-wire-panel-header">
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                <div>
                  <SwTag color={SWC.given} sm>GIVEN</SwTag>
                  <div style={{fontSize:13,color:SWC.muted,marginTop:6}}>{wiringValue.question.prompt}</div>
                  <div style={{fontSize:20,fontWeight:700,color:SWC.white,marginTop:3}}>{wiringValue.value.label}</div>
                </div>
                <button onClick={()=>setWiringValue(null)} style={{background:'none',border:'none',color:SWC.muted,cursor:'pointer',fontSize:20,padding:4}}>×</button>
              </div>
              <div style={{marginTop:8,fontSize:12,color:SWC.dim}}>
                This is an observation (GIVEN). Below are its interpretations across active frameworks (MEANT).
              </div>
            </div>
            <div className="fb-wire-panel-body">
              {frameworks.length === 0 ? (
                <div style={{padding:24,textAlign:'center',color:SWC.dim,fontSize:13}}>
                  No frameworks adopted yet.
                  <div style={{marginTop:10}}>
                    <SwBtn accent={SWC.meant} onClick={()=>{setAddingFw(true);setDraft('');setDraft2('');setDraft3('');}}>+ Adopt a framework</SwBtn>
                  </div>
                </div>
              ) : (
                <>
                  {frameworks.map((fw, fi) => {
                    const code = getBindingCode(wiringValue.value.id, fw.id);
                    const binding = code ? bindings[`${wiringValue.value.id}__${code.id}`] : null;
                    return (
                      <div key={fw.id} className="fb-wire-fw-card" style={{borderColor: code ? `${SWC.fw[fi%5]}40` : undefined}}>
                        <div className="fb-wire-fw-card-header">
                          <SwDot color={SWC.fw[fi%5]} size={10}/>
                          <div style={{flex:1}}>
                            <div style={{fontSize:14,fontWeight:600,color:SWC.fw[fi%5]}}>{fw.name}</div>
                            {fw.fullName && <div style={{fontSize:11,color:SWC.dim}}>{fw.fullName}</div>}
                          </div>
                          {code ? (
                            <div style={{display:'flex',alignItems:'center',gap:6}}>
                              <SwTag color={SWC.fw[fi%5]} mono>{code.code}</SwTag>
                              <span style={{fontSize:13,fontWeight:500,color:SWC.white}}>{code.label}</span>
                              <span className={`fb-prov-dot ${hasConflict(wiringValue.value.id)?'conflict':'bound'}`}
                                style={{background:hasConflict(wiringValue.value.id)?undefined:SWC.fw[fi%5]}}/>
                            </div>
                          ) : (
                            <span className="fb-prov-dot unbound"/>
                          )}
                        </div>
                        <div className="fb-wire-fw-card-body">
                          {code && binding && (
                            <div style={{fontSize:12,color:SWC.dim,marginBottom:8}}>
                              Bound via: {binding.method === 'auto_suggested' ? 'auto-suggested' : 'manual'} · Confidence: {Math.round((binding.confidence||1)*100)}% · {new Date(binding.t).toLocaleDateString()}
                            </div>
                          )}
                          {code && code.definition && (
                            <div style={{fontSize:12,color:SWC.text,marginBottom:8,padding:'6px 10px',background:SWC.raised,borderRadius:4}}>
                              {code.definition}
                            </div>
                          )}
                          <div style={{fontSize:12,color:SWC.muted,marginBottom:6,fontWeight:600}}>Select a code:</div>
                          <div style={{display:'flex',flexDirection:'column',gap:4}}>
                            {fw.codes.map(c => {
                              const isActive = code?.id === c.id;
                              return (
                                <div key={c.id} className={`fb-wire-code-option ${isActive?'selected':''}`}
                                  onClick={()=>{if(isActive)doClearBind(wiringValue.value.id,fw.id);else doSetBind(wiringValue.value.id,c.id,fw.id);}}>
                                  <div style={{width:16,height:16,borderRadius:8,border:`2px solid ${isActive?SWC.fw[fi%5]:SWC.border}`,display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}}>
                                    {isActive && <div style={{width:8,height:8,borderRadius:4,background:SWC.fw[fi%5]}}/>}
                                  </div>
                                  <SwTag color={SWC.fw[fi%5]} mono sm>{c.code}</SwTag>
                                  <span style={{fontSize:13,color:isActive?SWC.white:SWC.text}}>{c.label}</span>
                                  {isActive && <span style={{fontSize:11,color:SWC.fw[fi%5],marginLeft:'auto'}}>✓ bound</span>}
                                </div>
                              );
                            })}
                          </div>
                          {fw.codes.length === 0 && (
                            <div style={{fontSize:12,color:SWC.dim,padding:'8px 0'}}>No codes yet.</div>
                          )}
                          {code && (
                            <div onClick={()=>doClearBind(wiringValue.value.id,fw.id)}
                              style={{fontSize:12,color:SWC.dim,cursor:'pointer',marginTop:8}}
                              onMouseEnter={e=>e.currentTarget.style.color=SWC.red}
                              onMouseLeave={e=>e.currentTarget.style.color=SWC.dim}
                            >Clear binding</div>
                          )}
                        </div>
                      </div>
                    );
                  })}

                  {/* Conflict card */}
                  {hasConflict(wiringValue.value.id) && (
                    <div className="fb-wire-conflict">
                      <span style={{color:SWC.sup,fontWeight:600}}>⚡ Superposition — </span>
                      Frameworks disagree about what "{wiringValue.value.label}" means. This isn't an error — it's data about how institutions see differently.
                      <div style={{marginTop:8,display:'flex',gap:8}}>
                        <span style={{fontSize:12,color:SWC.muted,cursor:'pointer'}} onClick={()=>{setWiringValue(null);setAddingXW(true);}}>Document in crosswalks →</span>
                      </div>
                    </div>
                  )}

                  {/* Ground truth reminder */}
                  <div className="fb-wire-ground-truth">
                    <strong style={{color:SWC.given}}>Ground truth reminder:</strong><br/>
                    "{wiringValue.value.label}" is what the person said. Everything above is what institutions decided it means. The observation stands regardless.
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      )}


      {/* ═══ AUTO-SUGGEST BINDINGS MODAL ═══ */}
      {adoptingFw && (
        <div className="fb-adopt-modal" onClick={()=>setAdoptingFw(false)}>
          <div className="fb-adopt-panel" onClick={e=>e.stopPropagation()}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:16}}>
              <div>
                <div style={{fontSize:18,fontWeight:700,color:SWC.white}}>Auto-Suggest Bindings</div>
                <div style={{fontSize:13,color:SWC.muted,marginTop:4}}>
                  The system proposes matches based on label similarity. Review and confirm.
                </div>
              </div>
              <button onClick={()=>setAdoptingFw(false)} style={{background:'none',border:'none',color:SWC.muted,cursor:'pointer',fontSize:20}}>×</button>
            </div>

            {frameworks.map((fw, fi) => {
              const suggestions = autoSuggestBindings(fw.id);
              if (suggestions.length === 0) return (
                <div key={fw.id} style={{padding:'10px 14px',border:`1px solid ${SWC.border}`,borderRadius:8,marginBottom:8,color:SWC.dim,fontSize:13}}>
                  <SwDot color={SWC.fw[fi%5]} size={6}/> <span style={{color:SWC.fw[fi%5],fontWeight:600}}>{fw.name}</span> — no suggestions (all bound or no matches)
                </div>
              );
              return (
                <div key={fw.id} style={{border:`1px solid ${SWC.fw[fi%5]}40`,borderRadius:8,marginBottom:12,overflow:'hidden'}}>
                  <div style={{padding:'10px 14px',background:`${SWC.fw[fi%5]}10`,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                    <div style={{display:'flex',alignItems:'center',gap:6}}>
                      <SwDot color={SWC.fw[fi%5]} size={8}/>
                      <span style={{fontSize:14,fontWeight:600,color:SWC.fw[fi%5]}}>{fw.name}</span>
                      <span style={{fontSize:12,color:SWC.dim}}>{suggestions.length} suggestion{suggestions.length!==1?'s':''}</span>
                    </div>
                    <SwBtn accent={SWC.fw[fi%5]} onClick={()=>doAcceptAllSuggestions(suggestions)} style={{padding:'5px 12px',fontSize:11}}>
                      Accept all
                    </SwBtn>
                  </div>
                  <div style={{padding:'6px 8px'}}>
                    {suggestions.map(s => (
                      <div key={`${s.valueId}_${s.codeId}`} style={{display:'flex',alignItems:'center',gap:8,padding:'6px 10px',borderBottom:`1px solid ${SWC.border}`}}>
                        <span style={{fontSize:13,color:SWC.white,flex:1}}>{s.valueLabel}</span>
                        <span style={{color:SWC.dim,fontSize:12}}>→</span>
                        <SwTag color={SWC.fw[fi%5]} mono sm>{s.codeValue}</SwTag>
                        <span style={{fontSize:12,color:SWC.text,flex:1}}>{s.codeLabel}</span>
                        <span style={{fontSize:11,color:SWC.dim,fontFamily:'var(--mono)'}}>{Math.round(s.confidence*100)}%</span>
                        <SwBtn accent={SWC.fw[fi%5]} onClick={()=>doAcceptSuggestion(s)} style={{padding:'3px 10px',fontSize:10}}>Accept</SwBtn>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })}

            <div style={{marginTop:12,textAlign:'right'}}>
              <SwBtn ghost accent={SWC.muted} onClick={()=>setAdoptingFw(false)}>Done</SwBtn>
            </div>
          </div>
        </div>
      )}


      {/* ═══ PREVIEW MODE ═══ */}
      {mode === 'preview' && (
        <div className="fb-preview">
          <div style={{marginBottom:20,padding:'12px 16px',borderRadius:8,border:`1px solid ${SWC.border}`,background:SWC.surface,
            fontSize:13,color:SWC.muted,lineHeight:1.6}}>
            <strong style={{color:SWC.white}}>Preview:</strong> This is how the form appears to a person filling it out. No framework information is visible — only the questions and answer options.
          </div>
          {form.sections.map(sec => (
            <div key={sec.id} style={{marginBottom:24}}>
              <div style={{fontSize:16,fontWeight:600,color:SWC.white,marginBottom:12,padding:'8px 0',borderBottom:`1px solid ${SWC.border}`}}>{sec.title}</div>
              {sec.questions.map(q => (
                <div key={q.id} className="fb-preview-question">
                  <div className="fb-preview-prompt">{q.prompt}</div>
                  {(q.type === 'single_select' || q.type === 'multi_select') && (q.options || []).map(opt => (
                    <div key={opt.id} className="fb-preview-option">
                      <div className={q.type==='single_select'?'fb-answer-radio':'fb-answer-check'}/>
                      <span style={{fontSize:14}}>{opt.label}</span>
                    </div>
                  ))}
                  {q.type === 'text' && <input placeholder="Type your answer..." style={{width:'100%',padding:'10px 14px',borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:14,fontFamily:'inherit'}} readOnly/>}
                  {q.type === 'number' && <input type="number" placeholder="0" style={{width:120,padding:'10px 14px',borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:14,fontFamily:'inherit'}} readOnly/>}
                  {q.type === 'date' && <input type="date" style={{width:200,padding:'10px 14px',borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:14,fontFamily:'inherit'}} readOnly/>}
                  {q.type === 'boolean' && (
                    <div style={{display:'flex',gap:8}}>
                      <div className="fb-preview-option" style={{flex:1}}><div className="fb-answer-radio"/><span>Yes</span></div>
                      <div className="fb-preview-option" style={{flex:1}}><div className="fb-answer-radio"/><span>No</span></div>
                    </div>
                  )}
                  {q.type === 'duration' && <input placeholder="e.g. 3 months" style={{width:200,padding:'10px 14px',borderRadius:6,border:`1px solid ${SWC.border}`,background:SWC.surface,color:SWC.white,fontSize:14,fontFamily:'inherit'}} readOnly/>}
                </div>
              ))}
              {sec.questions.length === 0 && <div style={{color:SWC.dim,fontSize:13,fontStyle:'italic'}}>No questions in this section yet.</div>}
            </div>
          ))}
        </div>
      )}

      {/* ═══ FORM LIBRARY MODAL ═══ */}
      {showFormList && (
        <div className="fb-adopt-modal" onClick={()=>setShowFormList(false)}>
          <div className="fb-adopt-panel" onClick={e=>e.stopPropagation()} style={{maxWidth:560}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:20}}>
              <div>
                <div style={{fontSize:18,fontWeight:700,fontFamily:'var(--serif)',color:SWC.white}}>Form Library</div>
                <div style={{fontSize:13,color:SWC.dim,marginTop:4}}>
                  Saved forms and their versions.
                </div>
              </div>
              <button onClick={()=>setShowFormList(false)} style={{background:'none',border:'none',color:SWC.muted,cursor:'pointer',fontSize:18,padding:'2px 6px',lineHeight:1}}>×</button>
            </div>

            <SwBtn accent={SWC.given} onClick={doNewForm} style={{marginBottom:20,width:'100%'}}>+ New blank form</SwBtn>

            {savedForms.length === 0 ? (
              <div style={{padding:32,textAlign:'center',color:SWC.dim,fontSize:13,border:`1px dashed ${SWC.border}`,borderRadius:8}}>
                No saved forms yet. Use "Save" to save the current form to your library.
              </div>
            ) : (
              <div style={{display:'flex',flexDirection:'column',gap:10}}>
                {Object.entries(savedForms.reduce((acc, sf) => {
                  (acc[sf.key] = acc[sf.key] || []).push(sf);
                  return acc;
                }, {})).map(([key, versions]) => (
                  <div key={key} style={{border:`1px solid ${SWC.border}`,borderRadius:8,background:SWC.surface,overflow:'hidden'}}>
                    <div style={{padding:'12px 16px',borderBottom:`1px solid ${SWC.border}`,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                      <span style={{fontSize:14,fontWeight:600,color:SWC.white}}>{versions[0].name}</span>
                      <span style={{fontSize:11,color:SWC.dim,fontFamily:'var(--mono)'}}>{versions.length} version{versions.length!==1?'s':''}</span>
                    </div>
                    <div style={{padding:'6px 0'}}>
                      {versions.sort((a,b) => b.version - a.version).map(sv => (
                        <div key={sv.id} style={{padding:'8px 16px',display:'flex',alignItems:'center',gap:10,
                          transition:'background 0.1s',cursor:'pointer'}}
                          onClick={()=>doLoadForm(sv)}
                          onMouseEnter={e=>e.currentTarget.style.background=SWC.hover||SWC.raised}
                          onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
                          <SwTag color={SWC.meant} sm mono>v{sv.version}</SwTag>
                          <SwTag color={MATURITY_LEVELS[sv.maturity]?.color === 'green' ? SWC.given : SWC.dim} sm>{sv.maturity}</SwTag>
                          <span style={{fontSize:12,color:SWC.muted,flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                            {sv.description || '—'}
                          </span>
                          <span style={{fontSize:10,color:SWC.dim,fontFamily:'var(--mono)',flexShrink:0}}>
                            {new Date(sv.savedAt).toLocaleDateString()}
                          </span>
                          <button onClick={e=>{e.stopPropagation();doDeleteSaved(sv.id);}} style={{background:'none',border:'none',color:SWC.dim,cursor:'pointer',fontSize:14,padding:'2px 4px',flexShrink:0}}
                            onMouseEnter={e=>e.currentTarget.style.color=SWC.red} onMouseLeave={e=>e.currentTarget.style.color=SWC.dim}>×</button>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            )}

            <div style={{marginTop:16,textAlign:'right'}}>
              <SwBtn ghost accent={SWC.muted} onClick={()=>setShowFormList(false)}>Done</SwBtn>
            </div>
          </div>
        </div>
      )}

      {/* ═══ VERSION BUMP MODAL ═══ */}
      {showVersionBump && (
        <div className="fb-adopt-modal" onClick={()=>setShowVersionBump(false)}>
          <div className="fb-adopt-panel" onClick={e=>e.stopPropagation()} style={{maxWidth:480}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:16}}>
              <div>
                <div style={{fontSize:18,fontWeight:700,color:SWC.white}}>Bump Version</div>
                <div style={{fontSize:13,color:SWC.muted,marginTop:4}}>
                  Create a new version of <strong style={{color:SWC.white}}>{form.name}</strong>.
                  Current version: <strong style={{color:SWC.meant}}>v{form.version}</strong>
                </div>
              </div>
              <button onClick={()=>setShowVersionBump(false)} style={{background:'none',border:'none',color:SWC.muted,cursor:'pointer',fontSize:20}}>×</button>
            </div>

            <div style={{marginBottom:12}}>
              <div style={{fontSize:12,color:SWC.dim,marginBottom:6}}>Version notes (what changed):</div>
              <SwInput value={versionNotes} onChange={setVersionNotes} placeholder="Describe what changed in this version..."
                onKeyDown={e => { if (e.key === 'Escape') setShowVersionBump(false); }}/>
            </div>

            <div style={{fontSize:12,color:SWC.dim,marginBottom:12,lineHeight:1.6}}>
              The current form state will be saved as v{form.version} in the version history before bumping.
              Prior answers remain linked to the version they were recorded against.
            </div>

            <div style={{display:'flex',gap:8}}>
              <SwBtn accent={SWC.meant} onClick={()=>doVersionBump('minor')} style={{flex:1}}>
                Minor bump → v{+(form.version + 0.1).toFixed(1)}
                <div style={{fontSize:10,fontWeight:400,marginTop:2}}>Additive changes, compatible</div>
              </SwBtn>
              <SwBtn accent={SWC.sup} onClick={()=>doVersionBump('major')} style={{flex:1}}>
                Major bump → v{Math.floor(form.version) + 1}
                <div style={{fontSize:10,fontWeight:400,marginTop:2}}>Breaking changes, crosswalk needed</div>
              </SwBtn>
            </div>

            <div style={{marginTop:12,textAlign:'right'}}>
              <SwBtn ghost accent={SWC.muted} onClick={()=>setShowVersionBump(false)}>Cancel</SwBtn>
            </div>
          </div>
        </div>
      )}

      {/* ═══ VERSION HISTORY MODAL ═══ */}
      {showVersionHistory && (
        <div className="fb-adopt-modal" onClick={()=>setShowVersionHistory(false)}>
          <div className="fb-adopt-panel" onClick={e=>e.stopPropagation()} style={{maxWidth:640}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:16}}>
              <div>
                <div style={{fontSize:18,fontWeight:700,color:SWC.white}}>Version History — {form.name}</div>
                <div style={{fontSize:13,color:SWC.muted,marginTop:4}}>
                  Current: v{form.version} · {(form.versionHistory||[]).length} prior version{(form.versionHistory||[]).length!==1?'s':''}
                </div>
              </div>
              <button onClick={()=>setShowVersionHistory(false)} style={{background:'none',border:'none',color:SWC.muted,cursor:'pointer',fontSize:20}}>×</button>
            </div>

            {/* Current version */}
            <div style={{border:`1px solid ${SWC.givenBorder}`,borderRadius:8,background:'rgba(45,212,160,0.04)',padding:'10px 14px',marginBottom:8}}>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <SwTag color={SWC.given} sm mono>v{form.version}</SwTag>
                <span style={{fontSize:13,fontWeight:600,color:SWC.white}}>Current (working)</span>
                <SwTag color={SWC.given} sm>{form.maturity}</SwTag>
                <span style={{fontSize:11,color:SWC.dim,marginLeft:'auto'}}>{allQuestions.length} questions · {allValues.length} options</span>
              </div>
            </div>

            {/* Prior versions */}
            {(form.versionHistory || []).slice().reverse().map((h, i) => {
              const hQuestions = (h.snapshot?.sections || []).flatMap(s => s.questions || []);
              const hValues = hQuestions.flatMap(q => (q.options || []).map(o => o));
              const diff = diffFormVersions(h.snapshot, form);
              return (
                <div key={i} style={{border:`1px solid ${SWC.border}`,borderRadius:8,background:SWC.surface,padding:'10px 14px',marginBottom:6}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:h.notes?6:0}}>
                    <SwTag color={SWC.meant} sm mono>v{h.version}</SwTag>
                    <span style={{fontSize:13,color:SWC.text,flex:1}}>{h.notes || 'No notes'}</span>
                    <span style={{fontSize:11,color:SWC.dim,fontFamily:'var(--mono)'}}>{new Date(h.bumpedAt).toLocaleDateString()}</span>
                    <span style={{fontSize:11,color:SWC.dim}}>{hQuestions.length}q · {hValues.length}o</span>
                  </div>
                  {/* Diff summary */}
                  {(diff.added.length > 0 || diff.removed.length > 0 || diff.addedOptions.length > 0 || diff.removedOptions.length > 0) && (
                    <div style={{fontSize:11,color:SWC.dim,marginTop:4,display:'flex',gap:8,flexWrap:'wrap'}}>
                      {diff.added.length > 0 && <span style={{color:SWC.given}}>+{diff.added.length} question{diff.added.length!==1?'s':''}</span>}
                      {diff.removed.length > 0 && <span style={{color:SWC.red}}>-{diff.removed.length} question{diff.removed.length!==1?'s':''}</span>}
                      {diff.addedOptions.length > 0 && <span style={{color:SWC.given}}>+{diff.addedOptions.length} option{diff.addedOptions.length!==1?'s':''}</span>}
                      {diff.removedOptions.length > 0 && <span style={{color:SWC.red}}>-{diff.removedOptions.length} option{diff.removedOptions.length!==1?'s':''}</span>}
                      {diff.renamed.length > 0 && <span style={{color:SWC.sup}}>{diff.renamed.length} renamed</span>}
                    </div>
                  )}
                  <div style={{display:'flex',gap:6,marginTop:8}}>
                    <SwBtn ghost accent={SWC.meant} onClick={()=>{setShowVersionHistory(false);doStartAnswerCrosswalk(h);}} style={{padding:'3px 10px',fontSize:10}}>
                      Crosswalk answers from v{h.version}
                    </SwBtn>
                  </div>
                </div>
              );
            })}

            {(form.versionHistory || []).length === 0 && (
              <div style={{padding:24,textAlign:'center',color:SWC.dim,fontSize:13,border:`1px dashed ${SWC.border}`,borderRadius:8}}>
                No prior versions. Use "Version" to create a version snapshot.
              </div>
            )}

            {/* Existing answer crosswalks */}
            {(form.answerCrosswalks || []).length > 0 && (
              <div style={{marginTop:16}}>
                <div style={{fontSize:12,fontWeight:700,textTransform:'uppercase',letterSpacing:'0.08em',color:SWC.muted,marginBottom:8}}>
                  Answer Crosswalks
                </div>
                {form.answerCrosswalks.map(xw => (
                  <div key={xw.id} style={{border:`1px solid ${SWC.border}`,borderRadius:6,background:SWC.surface,padding:'8px 12px',marginBottom:4,
                    display:'flex',alignItems:'center',gap:8}}>
                    <SwTag color={SWC.meant} sm mono>v{xw.fromVersion}</SwTag>
                    <span style={{color:SWC.dim,fontSize:12}}>→</span>
                    <SwTag color={SWC.given} sm mono>v{xw.toVersion}</SwTag>
                    <span style={{fontSize:12,color:SWC.text}}>{Object.keys(xw.mappings).length} mapping{Object.keys(xw.mappings).length!==1?'s':''}</span>
                    <span style={{fontSize:11,color:SWC.dim,marginLeft:'auto',fontFamily:'var(--mono)'}}>{new Date(xw.createdAt).toLocaleDateString()}</span>
                  </div>
                ))}
              </div>
            )}

            <div style={{marginTop:12,textAlign:'right'}}>
              <SwBtn ghost accent={SWC.muted} onClick={()=>setShowVersionHistory(false)}>Done</SwBtn>
            </div>
          </div>
        </div>
      )}

      {/* ═══ ANSWER CROSSWALK MODAL ═══ */}
      {showAnswerCrosswalk && crosswalkSource && (
        <div className="fb-adopt-modal" onClick={()=>{setShowAnswerCrosswalk(false);setCrosswalkSource(null);}}>
          <div className="fb-adopt-panel" onClick={e=>e.stopPropagation()} style={{maxWidth:760}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:16}}>
              <div>
                <div style={{fontSize:18,fontWeight:700,color:SWC.white}}>Answer Crosswalk</div>
                <div style={{fontSize:13,color:SWC.muted,marginTop:4}}>
                  Map answers from <SwTag color={SWC.meant} sm mono>v{crosswalkSource.version}</SwTag> to the current
                  form <SwTag color={SWC.given} sm mono>v{form.version}</SwTag>.
                  Past answers recorded against v{crosswalkSource.version} will be translated using these mappings.
                </div>
              </div>
              <button onClick={()=>{setShowAnswerCrosswalk(false);setCrosswalkSource(null);}} style={{background:'none',border:'none',color:SWC.muted,cursor:'pointer',fontSize:20}}>×</button>
            </div>

            <div style={{fontSize:12,color:SWC.dim,marginBottom:12,padding:'8px 12px',background:SWC.raised,borderRadius:6,lineHeight:1.6}}>
              For each old answer option on the left, select the equivalent current answer option on the right.
              Unmapped answers will be preserved as-is with their original value.
            </div>

            {/* Map old sections/questions to new ones */}
            {(() => {
              const oldSections = crosswalkSource.form?.sections || [];
              const newAllQs = form.sections.flatMap(s => s.questions);
              const newAllOpts = newAllQs.flatMap(q => (q.options || []).map(o => ({...o, questionPrompt: q.prompt, questionId: q.id})));

              return oldSections.map(oldSec => (
                <div key={oldSec.id} style={{marginBottom:12}}>
                  <div style={{fontSize:13,fontWeight:600,color:SWC.muted,marginBottom:6,borderBottom:`1px solid ${SWC.border}`,paddingBottom:4}}>
                    {oldSec.title}
                  </div>
                  {(oldSec.questions || []).filter(q => q.options && q.options.length > 0).map(oldQ => {
                    // Try to find matching new question by id or prompt similarity
                    const matchingNewQ = newAllQs.find(nq => nq.id === oldQ.id) || newAllQs.find(nq => nq.prompt === oldQ.prompt);
                    const targetOpts = matchingNewQ ? (matchingNewQ.options || []) : newAllOpts;

                    return (
                      <div key={oldQ.id} style={{marginBottom:8}}>
                        <div style={{fontSize:13,color:SWC.white,marginBottom:4,display:'flex',alignItems:'center',gap:6}}>
                          <span style={{color:SWC.meant}}>OLD:</span> {oldQ.prompt}
                          {matchingNewQ && <span style={{fontSize:11,color:SWC.given}}>→ matched</span>}
                          {!matchingNewQ && <span style={{fontSize:11,color:SWC.sup}}>→ no exact match (showing all options)</span>}
                        </div>
                        <div style={{border:`1px solid ${SWC.border}`,borderRadius:8,overflow:'hidden',background:SWC.surface}}>
                          {/* Header */}
                          <div style={{display:'grid',gridTemplateColumns:'1fr 40px 1fr',borderBottom:`1px solid ${SWC.border}`,background:SWC.raised}}>
                            <div style={{padding:'6px 10px',fontSize:11,fontWeight:700,textTransform:'uppercase',color:SWC.meant}}>Old answer (v{crosswalkSource.version})</div>
                            <div style={{padding:'6px 4px',fontSize:11,color:SWC.dim,textAlign:'center'}}>→</div>
                            <div style={{padding:'6px 10px',fontSize:11,fontWeight:700,textTransform:'uppercase',color:SWC.given}}>Current answer (v{form.version})</div>
                          </div>
                          {/* Rows */}
                          {oldQ.options.map(oldOpt => (
                            <div key={oldOpt.id} style={{display:'grid',gridTemplateColumns:'1fr 40px 1fr',borderBottom:`1px solid ${SWC.border}`,alignItems:'center'}}>
                              <div style={{padding:'6px 10px',fontSize:13,color:SWC.text}}>{oldOpt.label}</div>
                              <div style={{padding:'6px 4px',fontSize:11,color:SWC.dim,textAlign:'center'}}>→</div>
                              <div style={{padding:'4px 6px'}}>
                                <select value={answerMappings[oldOpt.id] || ''} onChange={e => doSetAnswerMapping(oldOpt.id, e.target.value || null)}
                                  style={{width:'100%',padding:'5px 8px',borderRadius:4,border:`1px solid ${answerMappings[oldOpt.id] ? SWC.givenBorder : SWC.border}`,
                                    background:answerMappings[oldOpt.id] ? 'rgba(45,212,160,0.06)' : SWC.surface,color:SWC.white,fontSize:12,fontFamily:'inherit'}}>
                                  <option value="">— unmapped (keep original) —</option>
                                  {targetOpts.map(nOpt => (
                                    <option key={nOpt.id} value={nOpt.id}>{nOpt.label}</option>
                                  ))}
                                </select>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              ));
            })()}

            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:16}}>
              <div style={{fontSize:12,color:SWC.dim}}>
                {Object.keys(answerMappings).length} mapping{Object.keys(answerMappings).length!==1?'s':''} defined
              </div>
              <div style={{display:'flex',gap:8}}>
                <SwBtn ghost accent={SWC.muted} onClick={()=>{setShowAnswerCrosswalk(false);setCrosswalkSource(null);}}>Cancel</SwBtn>
                <SwBtn accent={SWC.given} onClick={doSaveAnswerCrosswalk} disabled={Object.keys(answerMappings).length === 0}>
                  Save Answer Crosswalk
                </SwBtn>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

/* ═══════════════════ NOTIFICATION CENTER ═══════════════════ */

/* Notification types: schema_update, schema_new, message, data_change, org_event */
const NotificationBell = ({notifications, onNotifClick, onDismiss, onDismissAll}) => {
  const [open, setOpen] = useState(false);
  const ref = useRef(null);
  const unreadCount = notifications.filter(n => !n.read).length;

  // Close on outside click
  useEffect(() => {
    if (!open) return;
    const handleClick = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
    document.addEventListener('mousedown', handleClick);
    return () => document.removeEventListener('mousedown', handleClick);
  }, [open]);

  const iconForType = (type) => {
    switch(type) {
      case 'schema_update': return {icon: 'layers', color: 'var(--gold)', bg: 'rgba(201,163,82,.12)'};
      case 'schema_new': return {icon: 'layers', color: 'var(--teal)', bg: 'rgba(62,201,176,.12)'};
      case 'message': return {icon: 'msg', color: 'var(--blue)', bg: 'rgba(91,156,245,.12)'};
      case 'data_change': return {icon: 'zap', color: 'var(--orange)', bg: 'rgba(224,150,72,.12)'};
      case 'org_event': return {icon: 'shieldCheck', color: 'var(--blue)', bg: 'rgba(91,156,245,.12)'};
      default: return {icon: 'bell', color: 'var(--tx-2)', bg: 'var(--bg-3)'};
    }
  };

  const timeAgo = (ts) => {
    const diff = Date.now() - ts;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
    return `${Math.floor(diff/86400000)}d ago`;
  };

  return (
    <div ref={ref} style={{position:'relative'}}>
      <button className="notif-bell" onClick={() => setOpen(prev => !prev)} title="Notifications">
        <I n="bell" s={16}/>
        {unreadCount > 0 && <span className="notif-badge">{unreadCount > 9 ? '9+' : unreadCount}</span>}
      </button>
      {open && (
        <div className="notif-dropdown">
          <div className="notif-dropdown-hdr">
            <span style={{fontSize:12,fontWeight:600,color:'var(--tx-0)'}}>Notifications</span>
            <div style={{display:'flex',gap:6,alignItems:'center'}}>
              {unreadCount > 0 && <button onClick={() => {onDismissAll(); }} style={{fontSize:10,color:'var(--teal)',background:'none',border:'none',cursor:'pointer',fontFamily:'var(--mono)'}}>Mark all read</button>}
            </div>
          </div>
          <div className="notif-dropdown-list">
            {notifications.length === 0 ? (
              <div className="notif-empty">
                <I n="check" s={18} c="var(--teal)"/>
                <div style={{marginTop:6}}>No notifications</div>
              </div>
            ) : notifications.map((n, i) => {
              const {icon, color, bg} = iconForType(n.type);
              return (
                <div key={n.id || i} className={`notif-item${!n.read ? ' unread' : ''}`}
                  onClick={() => { onNotifClick(n); setOpen(false); }}>
                  <div className="notif-icon" style={{background: bg}}>
                    <I n={icon} s={14} c={color}/>
                  </div>
                  <div className="notif-body">
                    <div className="notif-title">{n.title}</div>
                    {n.description && <div className="notif-desc">{n.description}</div>}
                    <div className="notif-time">{timeAgo(n.timestamp)}</div>
                  </div>
                  {!n.read && <div style={{width:6,height:6,borderRadius:3,background:'var(--teal)',flexShrink:0,marginTop:6}}/>}
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
};

/* ═══════════════════ SCHEMA BUILDER ═══════════════════ */

/* ── Sidebar form list item ── */
const SiFormItem = ({form, isActive, onClick, sourceType}) => {
  const dotClass = isActive ? 'current' : (form._unread ? 'unread' : 'read');
  const matColor = {draft:'var(--blue)',trial:'var(--gold)',normative:'var(--green)',deprecated:'var(--red)'}[form.maturity] || 'var(--tx-2)';
  const srcColor = sourceType === 'network' ? 'var(--teal)' : sourceType === 'org' ? 'var(--blue)' : 'var(--tx-2)';
  const srcLabel = sourceType === 'network' ? 'Network' : sourceType === 'org' ? 'Org' : 'Local';
  return (
    <div className={`si-form-item${isActive ? ' active' : ''}`} onClick={onClick}>
      <div className={`si-dot ${dotClass}`}/>
      <div style={{flex:1,minWidth:0}}>
        <div className="si-form-name">{form.name}</div>
        <div className="si-form-meta">
          <span style={{color:srcColor}}>{srcLabel}</span>
          <span style={{color:'var(--tx-3)'}}>·</span>
          <span>v{form.version}</span>
          <span style={{color:'var(--tx-3)'}}>·</span>
          <span style={{color:matColor}}>{form.maturity || 'draft'}</span>
        </div>
        {form._hasUpdate && <div className="si-form-update">▲ new</div>}
      </div>
    </div>
  );
};

/* ── Sidebar group header ── */
const SiGroupHeader = ({label, icon, count, expanded, onToggle, alert}) => (
  <div className="si-group-header" onClick={onToggle}>
    <span className="si-group-label">
      <I n={expanded ? "chevronDown" : "chevronRight"} s={10}/>
      <I n={icon} s={11}/>
      {label}
    </span>
    <span className={`si-group-count${alert ? ' alert' : ''}`}>{count}</span>
  </div>
);

/* ── Context panel: version timeline ── */
const SiVersionTimeline = ({form, onClickVersion}) => {
  const history = (form.versionHistory || []).slice().reverse();
  return (
    <div className="si-vt">
      <div className="si-vt-node">
        <div className="si-vt-dot current"/>
        <div style={{display:'flex',alignItems:'center',gap:6}}>
          <span style={{fontSize:11,fontFamily:'var(--mono)',fontWeight:600,color:'var(--tx-0)'}}>v{form.version}</span>
          <span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>current</span>
        </div>
        <div style={{fontSize:10,color:'var(--tx-2)',marginTop:2,fontFamily:'var(--mono)'}}>
          {form.sections?.length || 0} sections · {(form.sections || []).flatMap(s => s.questions || []).length} questions
        </div>
      </div>
      {history.map((h, i) => (
        <div key={i} className="si-vt-node" onClick={() => onClickVersion && onClickVersion(h)} style={{cursor:'pointer'}}>
          <div className="si-vt-dot past"/>
          <div style={{display:'flex',alignItems:'center',gap:6}}>
            <span style={{fontSize:11,fontFamily:'var(--mono)',fontWeight:600,color:'var(--tx-1)'}}>v{h.version}</span>
            <span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{h.bumpedAt ? new Date(h.bumpedAt).toLocaleDateString() : ''}</span>
          </div>
          {h.notes && <div style={{fontSize:10.5,color:'var(--tx-2)',marginTop:1,lineHeight:1.4,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{h.notes}</div>}
        </div>
      ))}
      {history.length === 0 && (
        <div style={{fontSize:10.5,color:'var(--tx-3)',padding:'4px 0 0 16px'}}>No prior versions</div>
      )}
    </div>
  );
};

/* ── Context panel: lineage ── */
const SiLineage = ({form, orgMeta, networkMembers, isOrg}) => {
  const isNetwork = form.source?.level === 'network' || form._sourceType === 'network';
  const isOrgForm = form.source?.level === 'org' || form._sourceType === 'org';
  return (
    <div>
      {isNetwork && <>
        <div className="si-lineage-node" style={{background:'rgba(62,201,176,.06)',border:'1px solid rgba(62,201,176,.15)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6}}>
            <I n="globe" s={12} c="var(--teal)"/>
            <span style={{fontSize:12,fontWeight:600,color:'var(--teal)'}}>Network</span>
          </div>
          <div style={{fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)',marginTop:2}}>{form.source?.propagation || 'standard'}</div>
        </div>
        <div className="si-lineage-connector">
          <span style={{fontSize:9,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{form.source?.propagation || 'standard'}</span>
        </div>
      </>}
      {(isNetwork || isOrgForm) && orgMeta?.name && <>
        <div className="si-lineage-node" style={{background:'rgba(91,156,245,.06)',border:'1px solid rgba(91,156,245,.15)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6}}>
            <I n="shieldCheck" s={12} c="var(--blue)"/>
            <span style={{fontSize:12,fontWeight:600,color:'var(--blue)'}}>{orgMeta.name}</span>
          </div>
        </div>
        <div className="si-lineage-connector">
          <span style={{fontSize:9,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>active</span>
        </div>
      </>}
      <div className="si-lineage-node" style={{background:'rgba(230,233,240,.06)',border:'1px solid var(--border-1)'}}>
        <div style={{display:'flex',alignItems:'center',gap:6}}>
          <I n="user" s={12} c="var(--tx-0)"/>
          <span style={{fontSize:12,fontWeight:600,color:'var(--tx-0)'}}>You {isOrg ? '(provider)' : '(local)'}</span>
        </div>
      </div>
    </div>
  );
};

/* ── Context panel: related forms ── */
const SiRelatedForms = ({currentForm, allForms, onNavigate}) => {
  const currentFieldKeys = new Set((currentForm.sections || []).flatMap(s => (s.questions || []).map(q => q.key || q.id)));
  const related = allForms.filter(f => {
    if (f.id === currentForm.id || f.key === currentForm.key) return false;
    const fKeys = new Set((f.sections || []).flatMap(s => (s.questions || []).map(q => q.key || q.id)));
    let shared = 0;
    for (const k of currentFieldKeys) if (fKeys.has(k)) shared++;
    return shared > 0;
  }).map(f => {
    const fKeys = new Set((f.sections || []).flatMap(s => (s.questions || []).map(q => q.key || q.id)));
    let shared = 0;
    for (const k of currentFieldKeys) if (fKeys.has(k)) shared++;
    return {...f, _sharedCount: shared};
  });
  if (related.length === 0) return (
    <div style={{padding:12,border:'1px dashed var(--border-1)',borderRadius:6,textAlign:'center'}}>
      <div style={{fontSize:11,color:'var(--tx-3)',lineHeight:1.5}}>No related forms detected. Forms sharing field keys will appear here.</div>
    </div>
  );
  return (
    <div style={{display:'flex',flexDirection:'column',gap:6}}>
      {related.map(f => (
        <div key={f.id} onClick={() => onNavigate && onNavigate(f)}
          style={{padding:'8px 12px',borderRadius:6,border:'1px solid var(--border-0)',background:'var(--bg-0)',cursor:'pointer',transition:'all 150ms'}}
          onMouseEnter={e => e.currentTarget.style.borderColor = 'var(--border-2)'}
          onMouseLeave={e => e.currentTarget.style.borderColor = 'var(--border-0)'}>
          <div style={{display:'flex',alignItems:'center',gap:6}}>
            <I n="link" s={11} c="var(--tx-3)"/>
            <span style={{fontSize:12,fontWeight:600,color:'var(--tx-0)'}}>{f.name}</span>
          </div>
          <div style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',marginTop:2}}>
            <span style={{color:'var(--teal)'}}>{f._sharedCount}</span> shared field{f._sharedCount !== 1 ? 's' : ''}
          </div>
        </div>
      ))}
    </div>
  );
};

/* ── Context panel (right side) ── */
const SiContextPanel = ({form, collapsed, onToggle, orgMeta, networkMembers, isOrg, allForms, onNavigateForm, onClickVersion}) => {
  if (collapsed) return (
    <div className="si-context collapsed">
      <div className="si-ctx-strip">
        <button onClick={onToggle} title="Expand context"><I n="chevronLeft" s={13}/></button>
        <button onClick={onToggle} title="Lineage"><I n="gitBranch" s={14}/></button>
        <button onClick={onToggle} title="Versions"><I n="clock" s={14}/></button>
        <button onClick={onToggle} title="Related"><I n="link" s={14}/></button>
        <button onClick={onToggle} title="Activity"><I n="activity" s={14}/></button>
      </div>
    </div>
  );
  if (!form) return <div className="si-context"><div className="si-ctx-section"><span className="si-ctx-label">No form selected</span></div></div>;
  return (
    <div className="si-context">
      <div style={{padding:'12px 14px 8px',borderBottom:'1px solid var(--border-0)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <span className="si-ctx-label" style={{marginBottom:0}}>CONTEXT</span>
        <button onClick={onToggle} style={{background:'none',border:'none',color:'var(--tx-3)',cursor:'pointer',padding:2}} title="Collapse"><I n="chevronRight" s={12}/></button>
      </div>
      <div className="si-ctx-section">
        <span className="si-ctx-label">LINEAGE</span>
        <SiLineage form={form} orgMeta={orgMeta} networkMembers={networkMembers} isOrg={isOrg}/>
      </div>
      <div className="si-ctx-section">
        <span className="si-ctx-label">VERSION TIMELINE</span>
        <SiVersionTimeline form={form} onClickVersion={onClickVersion}/>
      </div>
      <div className="si-ctx-section">
        <span className="si-ctx-label">RELATED FORMS</span>
        <SiRelatedForms currentForm={form} allForms={allForms} onNavigate={onNavigateForm}/>
      </div>
      <div className="si-ctx-section">
        <span className="si-ctx-label">ACTIVITY</span>
        <div style={{fontSize:10.5,color:'var(--tx-3)'}}>
          {form.updatedAt && <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4}}>
            <div style={{width:5,height:5,borderRadius:'50%',background:'var(--teal)',flexShrink:0}}/>
            <span style={{fontFamily:'var(--mono)'}}>{new Date(form.updatedAt).toLocaleDateString()}</span>
            <span style={{color:'var(--tx-2)'}}>Last edited</span>
          </div>}
          {form.createdAt && <div style={{display:'flex',alignItems:'center',gap:6}}>
            <div style={{width:5,height:5,borderRadius:'50%',background:'var(--tx-3)',flexShrink:0}}/>
            <span style={{fontFamily:'var(--mono)'}}>{new Date(form.createdAt).toLocaleDateString()}</span>
            <span style={{color:'var(--tx-2)'}}>Created</span>
          </div>}
          {!form.updatedAt && !form.createdAt && <span>No activity recorded</span>}
        </div>
      </div>
    </div>
  );
};

/* ── Forms sidebar (left side) ── */
const SiFormsSidebar = ({myForms, networkForms, orgForms, activeFormId, onSelectForm, onNewForm, searchQuery, onSearchChange, sidebarOpen, onToggleSidebar}) => {
  const [expanded, setExpanded] = useState({my: true, org: false, network: true});
  const [filterMode, setFilterMode] = useState('all'); // 'all' | 'attention'
  const toggle = (g) => setExpanded(prev => ({...prev, [g]: !prev[g]}));

  const filterForms = (forms) => {
    let result = forms;
    if (searchQuery && searchQuery.length >= 2) {
      const q = searchQuery.toLowerCase();
      result = result.filter(f =>
        f.name.toLowerCase().includes(q) ||
        (f.key || '').toLowerCase().includes(q) ||
        (f.description || '').toLowerCase().includes(q) ||
        (f.sections || []).some(s => s.title.toLowerCase().includes(q) || (s.questions || []).some(qn => (qn.prompt || '').toLowerCase().includes(q)))
      );
    }
    if (filterMode === 'attention') {
      result = result.filter(f => f._unread || f._hasUpdate);
    }
    return result;
  };

  const filtMy = filterForms(myForms);
  const filtOrg = filterForms(orgForms);
  const filtNet = filterForms(networkForms);

  // Count items needing attention across all groups
  const attentionCount = [...myForms, ...orgForms, ...networkForms].filter(f => f._unread || f._hasUpdate).length;

  return (
    <div className={`si-sidebar${sidebarOpen ? ' open' : ''}`}>
      <div className="si-header">
        <span className="si-group-label" style={{fontSize:11}}>
          <I n="layers" s={13} c="var(--teal)"/> SCHEMA
        </span>
        <div style={{display:'flex',gap:4}}>
          <button onClick={onNewForm} style={{width:24,height:24,borderRadius:6,background:'transparent',border:'1px solid var(--border-0)',color:'var(--tx-1)',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',transition:'all .15s'}}
            onMouseEnter={e=>{e.currentTarget.style.background='var(--bg-3)';e.currentTarget.style.color='var(--tx-0)';}}
            onMouseLeave={e=>{e.currentTarget.style.background='transparent';e.currentTarget.style.color='var(--tx-1)';}}
            title="New form"><I n="plus" s={12}/></button>
        </div>
      </div>
      <div className="si-search">
        <span className="si-search-icon"><I n="search" s={12} c="var(--tx-3)"/></span>
        <input value={searchQuery} onChange={e => onSearchChange(e.target.value)} placeholder="Search forms..." />
      </div>
      {/* Filter bar — replaces the old INBOX group */}
      <div className="si-filter-bar">
        <button className={`si-filter-btn${filterMode==='all'?' active':''}`} onClick={()=>setFilterMode('all')}>All</button>
        <button className={`si-filter-btn${filterMode==='attention'?' active':''}`} onClick={()=>setFilterMode('attention')}>
          Needs attention{attentionCount > 0 ? ` (${attentionCount})` : ''}
        </button>
      </div>
      <div className="si-sidebar-scroll">
        {/* MY FORMS */}
        <SiGroupHeader label="MY FORMS" icon="folder" count={filtMy.length} expanded={expanded.my} onToggle={() => toggle('my')}/>
        {expanded.my && (filtMy.length > 0 ? filtMy.map(f => (
          <SiFormItem key={f.id} form={f} isActive={f.id === activeFormId} onClick={() => onSelectForm(f)} sourceType="local"/>
        )) : (
          <div className="si-empty">
            <div className="si-empty-title">{filterMode==='attention'?'Nothing needs attention':'No saved forms'}</div>
            <div className="si-empty-desc">{filterMode==='attention'?'All local forms are up to date.':'Use "Save" to save a form here.'}</div>
          </div>
        ))}

        {/* ORG FORMS */}
        <SiGroupHeader label="ORG FORMS" icon="shieldCheck" count={filtOrg.length} expanded={expanded.org} onToggle={() => toggle('org')} alert={filtOrg.some(f => f._unread || f._hasUpdate)}/>
        {expanded.org && (filtOrg.length > 0 ? filtOrg.map(f => (
          <SiFormItem key={f.id} form={f} isActive={f.id === activeFormId} onClick={() => onSelectForm(f)} sourceType="org"/>
        )) : (
          <div className="si-empty">
            <div className="si-empty-desc">{filterMode==='attention'?'No org form updates.':'No org forms available.'}</div>
          </div>
        ))}

        {/* NETWORK */}
        <SiGroupHeader label="NETWORK" icon="globe" count={filtNet.length} expanded={expanded.network} onToggle={() => toggle('network')} alert={filtNet.some(f => f._unread || f._hasUpdate)}/>
        {expanded.network && (filtNet.length > 0 ? filtNet.map(f => (
          <SiFormItem key={f.id} form={f} isActive={f.id === activeFormId} onClick={() => onSelectForm(f)} sourceType="network"/>
        )) : (
          <div className="si-empty">
            <div className="si-empty-desc">{filterMode==='attention'?'No network updates.':'No network schema available.'}</div>
          </div>
        ))}

        {/* Empty state when filtering yields nothing across all groups */}
        {filterMode==='attention' && filtMy.length===0 && filtOrg.length===0 && filtNet.length===0 && (
          <div className="si-empty" style={{paddingTop:40}}>
            <div className="si-empty-icon"><I n="check" s={22} c="var(--teal)"/></div>
            <div className="si-empty-title">All caught up</div>
            <div className="si-empty-desc">No forms need your attention right now.</div>
          </div>
        )}
      </div>
    </div>
  );
};

/* ── SchemaView — Three-zone layout wrapping FormBuilder ── */
const SchemaView = ({isOrg, orgMeta, networkMembers}) => {
  SWC = useSWC();
  const [contextOpen, setContextOpen] = useState(true);
  const [sidebarOpen, setSidebarOpen] = useState(false); // for mobile overlay
  const [searchQuery, setSearchQuery] = useState('');
  const [sidebarSelectedId, setSidebarSelectedId] = useState(null);
  const [sidebarForms, setSidebarForms] = useState([]); // all forms in sidebar across all groups

  // Build sidebar form lists from DEFAULT_FORMS (network commons)
  const networkForms = useMemo(() => DEFAULT_FORMS.map(f => ({
    ...f, _sourceType: 'network', _unread: false, _hasUpdate: false,
    sections: [{id: 'sec_' + f.id, title: f.name, questions: f.fields.map(fld => ({
      id: fld.id || fld.key, key: fld.key, prompt: fld.question, type: fld.type,
      options: (fld.options || []).map((o, oi) => ({id: `${fld.key}_opt_${oi}`, label: o}))
    }))}]
  })), []);

  // Currently active form from FormBuilder (read from formBuilder's own state)
  // We track which form is selected; FormBuilder manages its own full state
  const activeForm = useMemo(() => {
    if (sidebarSelectedId) {
      const found = [...networkForms, ...sidebarForms].find(f => f.id === sidebarSelectedId);
      if (found) return found;
    }
    return null;
  }, [sidebarSelectedId, networkForms, sidebarForms]);

  const allKnownForms = useMemo(() => [...networkForms, ...sidebarForms], [networkForms, sidebarForms]);

  // Breadcrumb
  const breadcrumbGroup = activeForm?._sourceType === 'network' ? 'Network' : activeForm?._sourceType === 'org' ? 'Org Forms' : 'My Forms';

  return (
    <div className="si-wrap anim-up">
      {/* LEFT: Sidebar */}
      <SiFormsSidebar
        myForms={sidebarForms.filter(f => f._sourceType === 'local')}
        networkForms={networkForms}
        orgForms={sidebarForms.filter(f => f._sourceType === 'org')}
        activeFormId={sidebarSelectedId}
        onSelectForm={(f) => setSidebarSelectedId(f.id)}
        onNewForm={() => setSidebarSelectedId(null)}
        searchQuery={searchQuery}
        onSearchChange={setSearchQuery}
        sidebarOpen={sidebarOpen}
        onToggleSidebar={() => setSidebarOpen(prev => !prev)}
      />

      {/* CENTER: Canvas with FormBuilder */}
      <div className="si-canvas">
        {/* Breadcrumb toolbar */}
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}}>
          <div className="si-breadcrumb">
            {/* Mobile hamburger */}
            <button onClick={() => setSidebarOpen(true)}
              style={{background:'none',border:'none',color:'var(--tx-1)',cursor:'pointer',padding:'2px 8px 2px 0',display:'none'}}
              className="si-mobile-menu">
              <I n="menu" s={16}/>
            </button>
            <I n="layers" s={13} c="var(--teal)"/>
            <span className="sep">/</span>
            <span>{breadcrumbGroup}</span>
            {activeForm && <>
              <span className="sep">/</span>
              <span className="current">{activeForm.name}</span>
              <span className="sep">/</span>
              <span style={{fontFamily:'var(--mono)',fontSize:10}}>v{activeForm.version}</span>
            </>}
          </div>
        </div>
        {/* FormBuilder — owns its own internal form state */}
        <FormBuilder isOrg={isOrg}/>
      </div>

      {/* RIGHT: Context panel */}
      <SiContextPanel
        form={activeForm}
        collapsed={!contextOpen}
        onToggle={() => setContextOpen(prev => !prev)}
        orgMeta={orgMeta}
        networkMembers={networkMembers}
        isOrg={isOrg}
        allForms={allKnownForms}
        onNavigateForm={(f) => setSidebarSelectedId(f.id)}
      />

      {/* Mobile sidebar backdrop */}
      {sidebarOpen && <div onClick={() => setSidebarOpen(false)} style={{position:'fixed',inset:0,background:'rgba(0,0,0,.5)',zIndex:39}}/>}
    </div>
  );
};


/* ═══════════════════ ACTIVITY STREAM ═══════════════════ */
const ROOM_COLORS = {vault:'teal',bridge:'blue',roster:'gold',org:'blue',schema:'purple',metrics:'orange',network:'green',client_record:'teal',team:'purple',unknown:'orange'};

// Classify a room from pre-scanned state (no HTTP calls) or fallback to getState
const classifyRoom = async (roomId, scannedState) => {
  const state = scannedState || {};
  const id = state[EVT.IDENTITY] || await svc.getState(roomId, EVT.IDENTITY);
  if (id) {
    if (id.account_type==='client') return {type:'vault',label:'Individual Vault',color:'teal'};
    if (id.account_type==='client_record') return {type:'client_record',label:'Individual Record',color:'teal'};
    if (id.account_type==='provider') return {type:'roster',label:'Team Member Roster',color:'gold'};
    if (id.account_type==='organization') return {type:'org',label:'Organization',color:'blue'};
    if (id.account_type==='schema') return {type:'schema',label:'Schema Room',color:'purple'};
    if (id.account_type==='metrics') return {type:'metrics',label:'Metrics Room',color:'orange'};
    if (id.account_type==='network') return {type:'network',label:'Network Room',color:'green'};
    if (id.account_type==='team') return {type:'team',label:'Team Room',color:'purple'};
  }
  const meta = state[EVT.BRIDGE_META] || await svc.getState(roomId, EVT.BRIDGE_META);
  if (meta) return {type:'bridge',label:'Bridge Room',color:'blue'};
  return {type:'unknown',label:'Unknown',color:'orange'};
};

const classifyEvent = (ev, roomInfo) => {
  const type = ev.getType(); const content = ev.getContent();
  // Native EO operations
  if (type === EVT.OP) return { op:content.op||'INS', epistemic:content.frame?.epistemic||'GIVEN',
    label:`${content.op} Operation`, desc:content.target?.field||content.target?.entity||content.target?.type||'' };
  if (ev.isState && ev.isState()) {
    switch (type) {
      case EVT.IDENTITY: return {op:'INS',epistemic:'GIVEN',label:'Identity Declaration',desc:`Type: ${content.account_type}`};
      case EVT.VAULT_SNAPSHOT: return {op:'ALT',epistemic:'GIVEN',label:'Vault Snapshot',desc:`${Object.keys(content.fields||{}).length} fields`};
      case EVT.VAULT_PROVIDERS: return {op:'SEG',epistemic:'GIVEN',label:'Provider Index',desc:`${(content.providers||[]).length} providers`};
      case EVT.BRIDGE_META: { const rel = RELATIONSHIP_TYPES[content.relationship_type] || RELATIONSHIP_TYPES.client_provider; return {op:'CON',epistemic:'MEANT',label:'Bridge Connection',desc:`${content.status} — ${rel.label} — ${content.client?.slice(0,16)} ↔ ${content.provider?.slice(0,16)}`}; }
      case EVT.BRIDGE_REFS: return {op:'SEG',epistemic:'MEANT',label:'Field Refs Update',desc:`${Object.keys(content.fields||{}).length} encrypted refs${content.revoked?' (REVOKED)':''}`};
      case EVT.ROSTER_INDEX: return {op:'ALT',epistemic:'MEANT',label:'Roster Update',desc:`${(content.cases||[]).length} cases`};
      case EVT.ROSTER_ASSIGN: return {op:'SEG',epistemic:'MEANT',label:'Case Assignment',desc:`${Object.keys(content.assignments||content).length} case${Object.keys(content.assignments||content).length!==1?'s':''} assigned`};
      case EVT.ORG_ROSTER: return {op:'ALT',epistemic:'MEANT',label:'Org Roster',desc:`${(content.staff||[]).length} staff`};
      case EVT.ORG_METADATA: return {op:'DES',epistemic:'MEANT',label:'Org Metadata',desc:content.name||'org'};
      case EVT.ORG_INVITE: return {op:'CON',epistemic:'MEANT',label:'Org Invite',desc:content.userId};
      case EVT.SCHEMA_AUTHORITY: return {op:'CON',epistemic:'MEANT',label:'Authority Binding',desc:content.name?.slice(0,40)};
      case EVT.SCHEMA_PROP: return {op:'REC',epistemic:'MEANT',label:'Schema Propagation',desc:`${content.level}: ${content.prompt_key}`};
      case EVT.SCHEMA_FORM: return {op:'DES',epistemic:'GIVEN',label:'Form Definition',desc:content.name?.slice(0,40)};
      case EVT.SCHEMA_ASSESSMENT: return {op:'DES',epistemic:'MEANT',label:'Assessment Instrument',desc:content.question?.slice(0,40)};
      case EVT.OBSERVATION: return {op:'INS',epistemic:'MEANT',label:'Provider Observation',desc:`${content.prompt_id}: ${content.value}`};
      case EVT.INVITE_TOKEN: return {op:'CON',epistemic:'MEANT',label:'Invite Token',desc:'QR/link token'};
      case EVT.ENCOUNTER_PROV: return {op:'INS',epistemic:'MEANT',label:'Provisional Encounter',desc:content.description?.slice(0,40)};
      case EVT.MATCH_TOKEN: return {op:'CON',epistemic:'MEANT',label:'Match Token',desc:'Blind matching token'};
      case EVT.MATCH_HIT: return {op:'SUP',epistemic:'MEANT',label:'Match Hit',desc:'Potential duplicate'};
      case EVT.MATCH_RESOLVE: return {op:'REC',epistemic:'MEANT',label:'Match Resolved',desc:content.resolution};
      case EVT.SCHEMA_PROMPT: return {op:'DES',epistemic:'GIVEN',label:'Form Field',desc:content.question?.slice(0,40)};
      case EVT.SCHEMA_DEF: return {op:'DES',epistemic:'MEANT',label:'Classification Rule',desc:content.name?.slice(0,40)};
      case EVT.SCHEMA_TRANSFORM: return {op:'REC',epistemic:'MEANT',label:'Transform Rule',desc:`${Object.keys(content.transforms||{}).length} transforms`};
      case EVT.NET_MEMBERS: return {op:'CON',epistemic:'MEANT',label:'Network Members',desc:`${(content.organizations||[]).length} orgs`};
      case EVT.GOV_PROPOSAL: return {op:'INS',epistemic:'MEANT',label:'Governance Proposal',desc:content.summary?.slice(0,50)};
      case EVT.GOV_RHYTHM: return {op:'REC',epistemic:'MEANT',label:'Governance Rhythm',desc:content.name};
      case EVT.SCHEMA_FIELD: return {op:'DES',epistemic:'GIVEN',label:'Form Field',desc:content.question_text?.slice(0,40)};
      case EVT.SCHEMA_BINDING: return {op:'DES',epistemic:'MEANT',label:'Framework Binding',desc:`${content.field_id} → ${content.framework?.name?.slice(0,25)}`};
      // Resource tracking events
      case EVT.RESOURCE_TYPE: return {op:'DES',epistemic:'GIVEN',label:'Resource Type',desc:`${content.name||content.id} (${content.category})`};
      case EVT.RESOURCE_RELATION: return {op:'CON',epistemic:'GIVEN',label:'Resource Relation',desc:`${content.relation_type}: ${content.resource_type_id}`};
      case EVT.RESOURCE_INVENTORY: return {op:'ALT',epistemic:'GIVEN',label:'Resource Inventory',desc:`${content.available}/${content.total_capacity} available`};
      case EVT.RESOURCE_ALLOC: return {op:'INS',epistemic:'GIVEN',label:'Resource Allocation',desc:`${content.quantity} ${content.unit} → ${content.allocated_to?.slice(0,16)}`};
      case EVT.RESOURCE_POLICY: return {op:'SEG',epistemic:'MEANT',label:'Resource Policy',desc:ev.getStateKey()};
      case EVT.RESOURCE_OPACITY: return {op:'SEG',epistemic:'MEANT',label:'Resource Opacity',desc:`${RESOURCE_OPACITY_LABELS[content.opacity]||content.opacity}`};
      case EVT.RESOURCE_VAULT: return {op:'INS',epistemic:'GIVEN',label:'Vault Resource Record',desc:`${content.resource_name}: ${content.quantity} ${content.unit}`};
      case 'm.room.encryption': return {op:'REC',epistemic:'GIVEN',label:'Encryption Policy',desc:content.algorithm};
      case 'm.room.tombstone': return {op:'NUL',epistemic:'MEANT',label:'Room Tombstoned',desc:`→ ${content.replacement_room?.slice(0,24)}…`};
      case 'm.room.create': return {op:'INS',epistemic:'GIVEN',label:'Room Created',desc:'New room initialized'};
      case 'm.room.member': {
        const ms=content.membership;
        if(ms==='join')return{op:'CON',epistemic:'MEANT',label:'Member Joined',desc:ev.getStateKey()};
        if(ms==='invite')return{op:'CON',epistemic:'MEANT',label:'Member Invited',desc:ev.getStateKey()};
        if(ms==='leave')return{op:'NUL',epistemic:'MEANT',label:'Member Left/Kicked',desc:ev.getStateKey()};
        return{op:'ALT',epistemic:'MEANT',label:`Membership: ${ms}`,desc:ev.getStateKey()};
      }
      default: return {op:'INS',epistemic:'GIVEN',label:type,desc:'State event'};
    }
  }
  if (type === EVT.RESOURCE_EVENT) return {op:content.event==='revoked'?'NUL':'ALT',epistemic:'GIVEN',label:'Resource Lifecycle',desc:`${content.event}: ${content.quantity} (${content.allocation_id?.slice(0,12)})`};
  if (type === EVT.METRIC) return {op:'INS',epistemic:'MEANT',label:'Metric Event',desc:`${content.observation?.category}: ${content.observation?.value}`};
  if (type === 'm.room.message') {
    const cvType = content[`${NS}.type`];
    if (cvType==='request') return {op:'DES',epistemic:'MEANT',label:'Info Request',desc:content.body?.slice(0,60)};
    if (cvType==='note') return {op:'INS',epistemic:roomInfo.type==='vault'?'GIVEN':'MEANT',label:'Bridge Note',desc:content.body?.slice(0,60)};
    return {op:'INS',epistemic:'GIVEN',label:'Message',desc:content.body?.slice(0,60)};
  }
  return {op:'INS',epistemic:'GIVEN',label:type,desc:'Timeline event'};
};

const ActivityStream = ({session}) => {
  const [events,setEvents] = useState([]); const [rooms,setRooms] = useState([]);
  const [loading,setLoading] = useState(true); const [filter,setFilter] = useState({roomType:'all',operator:'all',epistemic:'all'});
  const [expanded,setExpanded] = useState(new Set()); const [autoRefresh,setAutoRefresh] = useState(false);

  const loadEvents = useCallback(async () => {
    setLoading(true);
    try {
      // Single scan: classify all rooms without per-room HTTP calls
      const scanned = await svc.scanRooms();
      const roomIds = svc.client ? svc.client.getRooms().map(r=>r.roomId) : Object.keys(scanned);
      const allRooms=[]; const allEvents=[];
      for (const rid of roomIds) {
        const roomInfo = await classifyRoom(rid, scanned[rid]); allRooms.push({id:rid,...roomInfo});
        if (svc.client) {
          const room = svc.client.getRoom(rid);
          if (room) {
            for (const ev of room.getLiveTimeline().getEvents()) {
              const cls = classifyEvent(ev, roomInfo);
              allEvents.push({ id:ev.getId(),roomId:rid,roomInfo,sender:ev.getSender(),ts:ev.getTs(),type:ev.getType(),
                stateKey:(ev.isState&&ev.isState())?ev.getStateKey():null,content:ev.getContent(),isState:ev.isState&&ev.isState(),...cls });
            }
          }
        }
      }
      allEvents.sort((a,b)=>b.ts-a.ts); setRooms(allRooms); setEvents(allEvents);
    } catch(e){console.error('Activity error:',e);}
    setLoading(false);
  },[]);

  useEffect(()=>{loadEvents();},[]);
  useEffect(()=>{if(!autoRefresh)return;const iv=setInterval(loadEvents,5000);return()=>clearInterval(iv);},[autoRefresh]);

  const filtered = useMemo(()=>events.filter(ev=>{
    if(filter.roomType!=='all'&&ev.roomInfo.type!==filter.roomType)return false;
    if(filter.operator!=='all'&&ev.op!==filter.operator)return false;
    if(filter.epistemic!=='all'&&ev.epistemic!==filter.epistemic)return false;
    return true;
  }),[events,filter]);

  const stats = useMemo(()=>{const s={total:events.length,byOp:{},byRoom:{},given:0,meant:0};
    events.forEach(ev=>{s.byOp[ev.op]=(s.byOp[ev.op]||0)+1;s.byRoom[ev.roomInfo.type]=(s.byRoom[ev.roomInfo.type]||0)+1;if(ev.epistemic==='GIVEN')s.given++;else s.meant++;});
    return s;
  },[events]);

  const toggle=(id)=>setExpanded(p=>{const n=new Set(p);n.has(id)?n.delete(id):n.add(id);return n;});

  if(loading)return<div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}><Spin s={28}/></div>;

  return <div className="anim-up" style={{maxWidth:960,margin:'0 auto'}}>
    <div style={{marginBottom:24}}>
      <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:6}}>
        <I n="zap" s={20} c="var(--orange)"/>
        <h2 style={{fontFamily:'var(--serif)',fontSize:24,fontWeight:700,letterSpacing:'-0.02em'}}>Activity Stream</h2>
        <span className="tag tag-orange">DEV</span>
      </div>
      <p style={{color:'var(--tx-1)',fontSize:13}}>Live EO event stream across all rooms. Operator classification, epistemic layer, and room topology.</p>
    </div>

    {/* Room topology */}
    <div className="card" style={{marginBottom:16,padding:16}}>
      <span className="section-label">ROOM TOPOLOGY ({rooms.length} rooms)</span>
      <div style={{display:'flex',gap:8,flexWrap:'wrap',marginTop:8}}>
        {rooms.map(r=><div key={r.id} style={{padding:'6px 10px',borderRadius:'var(--r)',background:`var(--${r.color}-dim)`,border:`1px solid var(--${r.color})20`,display:'flex',alignItems:'center',gap:6}}>
          <div style={{width:7,height:7,borderRadius:'50%',background:`var(--${r.color})`}}/>
          <span style={{fontSize:10,fontWeight:600,color:`var(--${r.color})`}}>{r.label}</span>
          <span style={{fontSize:8,fontFamily:'var(--mono)',color:'var(--tx-3)'}}>{r.id.slice(0,20)}…</span>
        </div>)}
      </div>
    </div>

    {/* Stats */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(120px,1fr))',gap:8,marginBottom:16}}>
      {[{l:'TOTAL',v:stats.total},{l:'GIVEN',v:stats.given,c:'teal'},{l:'MEANT',v:stats.meant,c:'gold'},{l:'ROOMS',v:rooms.length}].map((s,i)=>
        <div key={i} className="card" style={{padding:12}}><span className="section-label">{s.l}</span>
          <span style={{fontSize:20,fontWeight:700,color:s.c?`var(--${s.c})`:'var(--tx-0)'}}>{s.v}</span></div>)}
    </div>

    {/* Filters */}
    <div style={{display:'flex',gap:6,marginBottom:12,flexWrap:'wrap',alignItems:'center'}}>
      <select value={filter.roomType} onChange={e=>setFilter({...filter,roomType:e.target.value})} style={{width:'auto',padding:'5px 8px',fontSize:11}}>
        <option value="all">All Rooms</option>
        {['vault','bridge','roster','schema','metrics','network'].map(t=><option key={t} value={t}>{t}</option>)}
      </select>
      <select value={filter.operator} onChange={e=>setFilter({...filter,operator:e.target.value})} style={{width:'auto',padding:'5px 8px',fontSize:11}}>
        <option value="all">All Operators</option>
        {OPERATORS.map(op=><option key={op} value={op}>{op}</option>)}
      </select>
      <select value={filter.epistemic} onChange={e=>setFilter({...filter,epistemic:e.target.value})} style={{width:'auto',padding:'5px 8px',fontSize:11}}>
        <option value="all">All Epistemic</option><option value="GIVEN">GIVEN</option><option value="MEANT">MEANT</option>
      </select>
      <div style={{marginLeft:'auto',display:'flex',gap:6,alignItems:'center'}}>
        <span style={{fontSize:9,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>AUTO</span>
        <Toggle on={autoRefresh} onChange={()=>setAutoRefresh(!autoRefresh)}/>
        <button onClick={loadEvents} className="b-gho b-xs"><I n="search" s={10}/></button>
      </div>
    </div>
    <div style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)',marginBottom:8}}>Showing {filtered.length} of {events.length}</div>

    {/* Events */}
    <div style={{display:'flex',flexDirection:'column',gap:3}}>
      {filtered.length===0&&<div className="card" style={{textAlign:'center',padding:'30px 20px',borderStyle:'dashed'}}><I n="search" s={24}/><p style={{color:'var(--tx-3)',marginTop:8,fontSize:12}}>No events match filters</p></div>}
      {filtered.slice(0,100).map((ev,i)=>{
        const isExp=expanded.has(ev.id);const opC=OP_COLORS[ev.op]||'blue';const rmC=ROOM_COLORS[ev.roomInfo.type]||'orange';
        return <div key={ev.id||i} style={{background:'var(--bg-2)',border:'1px solid var(--border-0)',borderRadius:'var(--r)',overflow:'hidden'}}>
          <div onClick={()=>toggle(ev.id)} style={{padding:'8px 12px',display:'flex',alignItems:'center',gap:6,cursor:'pointer'}}
            onMouseEnter={e=>e.currentTarget.style.background='var(--bg-3)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
            <div style={{width:7,height:7,borderRadius:'50%',background:`var(--${opC})`,flexShrink:0}}/>
            <span className={`tag tag-${opC}`} style={{fontSize:9,minWidth:26,textAlign:'center'}}>{ev.op}</span>
            <span className={`tag tag-${rmC}`} style={{fontSize:8.5}}>{ev.roomInfo.type.toUpperCase()}</span>
            <span className={`tag ${ev.epistemic==='GIVEN'?'tag-teal':'tag-gold'}`} style={{fontSize:8.5}}>{ev.epistemic}</span>
            <span style={{fontSize:11.5,fontWeight:500,flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ev.label}</span>
            <span style={{fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)',maxWidth:160,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ev.desc}</span>
            <span style={{fontSize:8.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{ev.ts?new Date(ev.ts).toLocaleTimeString():''}</span>
            <I n={isExp?'x':'chevR'} s={10} c="var(--tx-3)"/>
          </div>
          {isExp&&<div className="anim-in" style={{borderTop:'1px solid var(--border-0)',padding:'12px 14px',background:'var(--bg-1)'}}>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
              {[['EVENT TYPE',ev.type],['SENDER',ev.sender],['ROOM',ev.roomId],['TIMESTAMP',ev.ts?new Date(ev.ts).toISOString():'—']].map(([l,v])=>
                <div key={l}><span className="section-label">{l}</span><span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-1)',display:'block',wordBreak:'break-all'}}>{v}</span></div>)}
            </div>
            <span className="section-label">RAW CONTENT</span>
            <pre style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-1)',background:'var(--bg-0)',border:'1px solid var(--border-0)',borderRadius:'var(--r)',padding:10,overflow:'auto',maxHeight:200,whiteSpace:'pre-wrap',wordBreak:'break-all',marginTop:4}}>
{JSON.stringify(ev.content,null,2)}</pre>
          </div>}
        </div>;
      })}
    </div>
  </div>;
};

/* ═══════════════════ WELCOME / INVITATION SCREEN ═══════════════════ */

const WelcomeScreen = ({onContinue}) => (
  <div className="grid-bg" style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center',position:'relative'}}>
    <div style={{position:'absolute',top:16,right:16}}><ThemeToggle/></div>
    <div className="anim-up" style={{width:'100%',maxWidth:600,padding:20}}>
      <div style={{background:'var(--bg-1)',border:'1px solid var(--border-0)',borderRadius:'var(--r-lg)',padding:'48px 44px',position:'relative',overflow:'hidden'}}>
        <div style={{position:'absolute',top:0,left:0,right:0,height:3,background:'linear-gradient(90deg, var(--gold), var(--teal), var(--blue))'}}/>

        <div style={{display:'flex',alignItems:'center',gap:14,marginBottom:6}}>
          <div style={{width:48,height:48,borderRadius:'var(--r-lg)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)'}}><I n="shield" s={26}/></div>
          <div><h1 style={{fontSize:28,fontWeight:800,fontFamily:'var(--serif)',letterSpacing:'-0.02em'}}>Khora</h1>
            <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-2)',letterSpacing:'.08em'}}>SOVEREIGN CASE MANAGEMENT</span></div>
        </div>

        <p style={{color:'var(--tx-0)',fontSize:15,marginTop:24,lineHeight:1.7,fontWeight:500}}>
          You've been invited to access Khora — a system where <em>you</em> own your data.
        </p>
        <p style={{color:'var(--tx-1)',fontSize:13.5,marginTop:12,lineHeight:1.7}}>
          Khora runs on the <strong style={{color:'var(--tx-0)'}}>Matrix protocol</strong>, which means your information lives on a server you choose — not locked inside a single company's platform. To get started you'll need a free Matrix account.
        </p>

        <div style={{background:'var(--bg-2)',border:'1px solid var(--border-1)',borderRadius:'var(--r-lg)',padding:'20px 22px',marginTop:24}}>
          <span style={{fontFamily:'var(--mono)',fontSize:10.5,color:'var(--gold)',letterSpacing:'.06em',fontWeight:600,display:'block',marginBottom:12}}>GETTING STARTED</span>
          <div style={{display:'flex',gap:14,marginBottom:16}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'var(--teal-dim)',color:'var(--teal)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:800,fontFamily:'var(--mono)',flexShrink:0,marginTop:1}}>1</div>
            <div>
              <div style={{fontSize:13.5,fontWeight:600,color:'var(--tx-0)',marginBottom:4}}>Create a Matrix account</div>
              <div style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6}}>
                You can register with any Matrix homeserver. For a free, general-purpose account we recommend <a href="https://app.element.io/#/register" target="_blank" rel="noopener noreferrer" style={{color:'var(--teal)',textDecoration:'none',fontWeight:600}}>matrix.org</a> — sign up takes under a minute.
              </div>
              <div style={{fontSize:11.5,color:'var(--tx-2)',lineHeight:1.5,marginTop:6}}>
                If your organization runs its own server, use that address instead. Your admin will know the homeserver URL.
              </div>
            </div>
          </div>
          <div style={{display:'flex',gap:14,marginBottom:16}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'var(--teal-dim)',color:'var(--teal)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:800,fontFamily:'var(--mono)',flexShrink:0,marginTop:1}}>2</div>
            <div>
              <div style={{fontSize:13.5,fontWeight:600,color:'var(--tx-0)',marginBottom:4}}>Sign in here</div>
              <div style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6}}>
                Use your Matrix username (e.g. <span style={{fontFamily:'var(--mono)',color:'var(--tx-0)',fontSize:12}}>@you:matrix.org</span>) and password to connect.
              </div>
            </div>
          </div>
          <div style={{display:'flex',gap:14}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'var(--teal-dim)',color:'var(--teal)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:800,fontFamily:'var(--mono)',flexShrink:0,marginTop:1}}>3</div>
            <div>
              <div style={{fontSize:13.5,fontWeight:600,color:'var(--tx-0)',marginBottom:4}}>Roles are detected automatically</div>
              <div style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6}}>
                Khora infers your <strong style={{color:'var(--teal)'}}>Client</strong>, <strong style={{color:'var(--gold)'}}>Provider</strong>, Org Admin, and Network roles from room membership. If you hold multiple roles, you can switch contexts without signing out.
              </div>
            </div>
          </div>
        </div>

        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginTop:20,fontSize:12,color:'var(--tx-1)',lineHeight:1.6,display:'flex',gap:10,alignItems:'flex-start'}}>
          <div style={{flexShrink:0,marginTop:1}}><I n="lock" s={15}/></div>
          <span>Your data is encrypted per-field on your device before it ever leaves. Providers see only the specific fields you share. You can revoke access at any time.</span>
        </div>

        <button onClick={onContinue} className="b-pri" style={{width:'100%',padding:14,fontSize:15,marginTop:28,display:'flex',alignItems:'center',justifyContent:'center',gap:10}}>
          Get Started <I n="chevR" s={18}/>
        </button>

        <p style={{textAlign:'center',marginTop:16,fontSize:11.5,color:'var(--tx-3)',fontFamily:'var(--mono)',letterSpacing:'.03em'}}>
          Already have an account? Click above to sign in.
        </p>
      </div>
    </div>
  </div>
);

/* ═══════════════════ LOGIN ═══════════════════ */
const LoginScreen = ({onLogin}) => {
  const [mode,setMode] = useState('login'); // login | register
  const [hs,setHs] = useState('matrix.org'); const [user,setUser] = useState(''); const [pass,setPass] = useState('');
  const [loading,setLoading] = useState(false); const [err,setErr] = useState('');

  // Extract host server from username if present (e.g. @user:matrix.org -> matrix.org)
  const userHost = user.includes(':') ? user.split(':').slice(1).join(':') : '';
  const effectiveHs = userHost || hs;
  const hideHs = !!userHost;

  const go = async (e) => {
    e.preventDefault(); setLoading(true); setErr('');
    try {
      if (mode === 'register') {
        const baseUrl = effectiveHs.startsWith('http') ? effectiveHs : `https://${effectiveHs}`;
        const resp = await fetch(`${baseUrl}/_matrix/client/v3/register`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ username: user.replace(/^@/,'').split(':')[0], password: pass, auth: { type: 'm.login.dummy' } })
        });
        if (!resp.ok) { const e = await resp.json().catch(()=>({})); throw new Error(e.error || `Registration failed (${resp.status}). Try logging in if account exists.`); }
      }
      const s = await svc.login(effectiveHs, user, pass); onLogin(s);
    }
    catch (e) { setErr(e.message); }
    setLoading(false);
  };

  return <div className="grid-bg" style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center',position:'relative'}}>
    <div style={{position:'absolute',top:16,right:16}}><ThemeToggle/></div>
    <div className="anim-up" style={{width:'100%',maxWidth:440,padding:20}}>
      <div style={{background:'var(--bg-1)',border:'1px solid var(--border-0)',borderRadius:'var(--r-lg)',padding:'44px 40px',position:'relative',overflow:'hidden'}}>
        <div style={{position:'absolute',top:0,left:0,right:0,height:3,background:'linear-gradient(90deg, var(--gold), var(--teal), var(--blue))'}}/>
        <div style={{display:'flex',alignItems:'center',gap:14,marginBottom:10}}>
          <div style={{width:44,height:44,borderRadius:'var(--r-lg)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)'}}><I n="shield" s={24}/></div>
          <div><h1 style={{fontSize:24,fontWeight:800,fontFamily:'var(--serif)',letterSpacing:'-0.02em'}}>Khora</h1>
            <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-2)',letterSpacing:'.08em'}}>SOVEREIGN CASE MANAGEMENT</span></div>
        </div>
        <p style={{color:'var(--tx-1)',fontSize:13,marginTop:18,marginBottom:24,lineHeight:1.65}}>
          Client-owned data vaults on Matrix. Per-field encryption. Providers see only what clients share. Each tile is yours to place.
        </p>

        <div className="tabs" style={{marginBottom:20}}>
          <div className={`tab ${mode==='login'?'active':''}`} onClick={()=>{setMode('login');setErr('')}}>Sign In</div>
          <div className={`tab ${mode==='register'?'active':''}`} onClick={()=>{setMode('register');setErr('')}}>Create Account</div>
        </div>

        {mode==='register'&&<div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--teal)'}}>Pick any Matrix homeserver</strong> — we recommend <strong style={{color:'var(--tx-0)'}}>matrix.org</strong> for a free, general-purpose account. If your organization runs its own server, enter that homeserver URL instead.
        </div>}

        <form onSubmit={go}>
          <div style={{marginBottom:14}}><span className="section-label">USERNAME</span><input value={user} onChange={e=>setUser(e.target.value)} placeholder={mode==='register'?'choose a username':'@you:matrix.org'} autoComplete="username"/></div>
          <div style={{marginBottom:14}}><span className="section-label">PASSWORD</span><input type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="••••••••" autoComplete={mode==='register'?'new-password':'current-password'}/></div>
          {!hideHs&&<div style={{marginBottom:14}}><span className="section-label">HOMESERVER</span><input value={hs} onChange={e=>setHs(e.target.value)} placeholder="matrix.org"/></div>}
          {err&&<div style={{background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.2)',borderRadius:'var(--r)',padding:'9px 14px',fontSize:12.5,color:'var(--red)',marginBottom:16}}>{err}</div>}
          <button type="submit" className="b-pri" disabled={loading} style={{width:'100%',padding:12,fontSize:14,display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
            {loading?<Spin s={16}/>:<I n="lock" s={16}/>} {loading?'Connecting...':(mode==='register'?'Create Account & Connect':'Connect')}
          </button>
        </form>
        <div style={{marginTop:16,display:'flex',alignItems:'center',gap:8,justifyContent:'center'}}>
          <div style={{width:6,height:6,borderRadius:'50%',background:typeof matrixcs!=='undefined'?'var(--green)':'var(--gold)'}}/>
          <span style={{fontFamily:'var(--mono)',fontSize:10.5,color:'var(--tx-3)'}}>
            {typeof matrixcs!=='undefined'?'matrix-js-sdk + Megolm E2EE':'SDK loading — fallback ready'}
          </span>
        </div>
      </div>
    </div>
  </div>;
};

/* ═══════════════════ CLIENT APP ═══════════════════ */
const ClientApp = ({session, onLogout, showToast}) => {
  const [vaultRoom, setVaultRoom] = useState(null);
  const [schemaRoom, setSchemaRoom] = useState(null);
  const [vaultData, setVaultData] = useState({});
  const [observations, setObservations] = useState([]);
  const [metricsConsent, setMetricsConsent] = useState({enabled:false,categories:[]});
  const [providers, setProviders] = useState([]);
  const [view, setView] = useState('vault');
  const [activeBridge, setActiveBridge] = useState(null);
  const [loading, setLoading] = useState(true);
  const [editModal, setEditModal] = useState(false);
  const [editData, setEditData] = useState({});
  const [addProviderModal, setAddProviderModal] = useState(false);
  const [newProviderId, setNewProviderId] = useState('');
  const [bridgeMessages, setBridgeMessages] = useState([]);
  const [msgText, setMsgText] = useState('');
  // Inbox chat state
  const [inboxConvo, setInboxConvo] = useState(null); // provider index for active inbox conversation
  const [inboxMessages, setInboxMessages] = useState([]);
  const [inboxMsgText, setInboxMsgText] = useState('');
  const [hardRevokeTarget, setHardRevokeTarget] = useState(null);
  const [obsModal, setObsModal] = useState(null); // prompt object or null
  const [obsValue, setObsValue] = useState('');
  const [obsDate, setObsDate] = useState(new Date().toISOString().slice(0,10));
  const [obsFreeText, setObsFreeText] = useState('');
  const [initError, setInitError] = useState(null);
  const [claimedRooms, setClaimedRooms] = useState([]);
  const [pendingClaims, setPendingClaims] = useState([]);
  const [customFieldDefs, setCustomFieldDefs] = useState([]); // [{key,label,category,sensitive}]
  const [addFieldModal, setAddFieldModal] = useState(false);
  const [newFieldLabel, setNewFieldLabel] = useState('');
  const [newFieldCategory, setNewFieldCategory] = useState('details');
  const [newFieldSensitive, setNewFieldSensitive] = useState(false);
  const [enabledFrameworks, setEnabledFrameworks] = useState([]); // framework ids toggled on
  const [frameworkModal, setFrameworkModal] = useState(false);
  const [myTeams, setMyTeams] = useState([]);

  useEffect(() => { initVault(); }, []);

  // Framework-derived fields from enabled standards
  const frameworkFields = useMemo(() => getFrameworkFields(enabledFrameworks), [enabledFrameworks]);

  // Merge built-in fields + custom fields + framework fields
  const allFields = useMemo(() => [...VAULT_FIELDS, ...customFieldDefs, ...frameworkFields], [customFieldDefs, frameworkFields]);
  const allCategories = useMemo(() => {
    const cats = [...FIELD_CATEGORIES];
    for (const f of [...customFieldDefs, ...frameworkFields]) { if (!cats.includes(f.category)) cats.push(f.category); }
    return cats;
  }, [customFieldDefs, frameworkFields]);

  const handleAddCustomField = async () => {
    const label = newFieldLabel.trim();
    if (!label) return;
    const key = 'custom_' + label.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
    if (allFields.some(f => f.key === key)) { showToast('A field with that name already exists','error'); return; }
    const def = {key, label, category: newFieldCategory, sensitive: newFieldSensitive, custom: true};
    const updated = [...customFieldDefs, def];
    await emitOp(vaultRoom, 'INS', {field:key,entity:'custom_field_def'}, {label,category:newFieldCategory,sensitive:newFieldSensitive}, vaultFrame());
    await saveSnapshot(undefined, undefined, undefined, updated);
    setAddFieldModal(false); setNewFieldLabel(''); setNewFieldCategory('details'); setNewFieldSensitive(false);
    showToast(`Custom field "${label}" created`, 'success');
  };

  const handleDeleteCustomField = async (fieldKey) => {
    const updated = customFieldDefs.filter(f => f.key !== fieldKey);
    const updatedData = {...vaultData};
    delete updatedData[fieldKey];
    await emitOp(vaultRoom, 'NUL', {field:fieldKey,entity:'custom_field_def'}, {reason:'client_deleted'}, vaultFrame());
    await saveSnapshot(updatedData, undefined, undefined, updated);
    showToast('Custom field removed', 'warn');
  };

  const vaultFrame = (room) => ({type:'vault',room:room||vaultRoom,role:'client',epistemic:'GIVEN'});
  const bridgeFrame = (room) => ({type:'bridge',room,role:'client',epistemic:'MEANT'});

  const initVault = async () => {
    setLoading(true);
    setInitError(null);
    try {
      // Phase 1: Auto-join any invited client_record rooms so they appear in scanRooms
      try {
        const invited = await svc.scanInvitedRooms([EVT.IDENTITY]);
        for (const [rid, state] of Object.entries(invited)) {
          const id = state[EVT.IDENTITY];
          if (id?.account_type === 'client_record' && id.client_matrix_id === svc.userId) {
            try { await svc.joinRoom(rid); } catch (e) { console.warn('Auto-join failed for', rid, e.message); }
          }
        }
      } catch (e) { console.warn('Invited room scan failed:', e.message); }

      // Phase 2: Scan joined rooms (now includes any rooms we just auto-joined)
      const scanned = await svc.scanRooms([EVT.PROVIDER_PROFILE, EVT.TEAM_META, EVT.TEAM_MEMBERS]);
      let vault = null, schema = null;
      const detectedPending = [], detectedClaimed = [];
      const bridgeProfiles = {}; // bridgeRoomId → provider profile
      const detectedTeams = [];
      for (const [rid, state] of Object.entries(scanned)) {
        const id = state[EVT.IDENTITY];
        if (id?.account_type === 'client' && id.owner === svc.userId) vault = rid;
        if (id?.account_type === 'schema' && id.owner === svc.userId) schema = rid;
        // Detect client_record rooms where this client was invited or has claimed
        if (id?.account_type === 'client_record' && id.client_matrix_id === svc.userId) {
          if (id.status === 'claimed' && id.owner === svc.userId) {
            detectedClaimed.push({roomId: rid, ...id});
          } else {
            detectedPending.push({roomId: rid, ...id});
          }
        }
        // Detect team rooms the individual belongs to
        if (id?.account_type === 'team') {
          const teamMeta = state[EVT.TEAM_META] || {};
          const teamMembers = state[EVT.TEAM_MEMBERS] || {members:[]};
          detectedTeams.push({roomId:rid, ...teamMeta, members:teamMembers.members||[]});
        }
        // Collect provider profiles and bridge metadata from bridge rooms
        const bridgeMeta = state[EVT.BRIDGE_META];
        const provProfile = state[EVT.PROVIDER_PROFILE];
        if (bridgeMeta && bridgeMeta.client === svc.userId) {
          if (provProfile) bridgeProfiles[rid] = provProfile;
          // Track transferable and org_id from bridge meta
          bridgeProfiles[rid] = {...(bridgeProfiles[rid]||{}), _bridgeMeta: bridgeMeta};
        }
      }
      if (!vault) {
        vault = await svc.createRoom('[Khora Vault]', 'Personal data vault', [
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'client',owner:svc.userId,created:Date.now()}},
          {type:EVT.VAULT_SNAPSHOT,state_key:'',content:{fields:{},observations:[],
            metrics_consent:{enabled:false,categories:[]},
            matching_consent:{enabled:false,layers:[],network_id:null,last_token_ts:null},
            custom_field_defs:[],enabled_frameworks:[]}},
          {type:EVT.VAULT_PROVIDERS,state_key:'',content:{providers:[]}},
        ]);
        showToast('Vault created — encrypted room ready','success');
      }
      if (!schema) {
        schema = await svc.createRoom('[Khora Schema]','Schema definitions', [
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'schema',owner:svc.userId,created:Date.now()}},
        ]);
        const allSeeds = [
          // Forms — GIVEN data collection instruments
          ...DEFAULT_FORMS.map(f => () => svc.setState(schema, EVT.SCHEMA_FORM, f, f.id)),
          ...DEFAULT_PROMPTS.map(p => () => svc.setState(schema, EVT.SCHEMA_PROMPT, p, p.key)),
          // Interpretations — MEANT frameworks
          ...DEFAULT_DEFINITIONS.map(d => () => svc.setState(schema, EVT.SCHEMA_DEF, d, d.key)),
          ...DEFAULT_AUTHORITIES.map(a => () => svc.setState(schema, EVT.SCHEMA_AUTHORITY, a, a.id)),
          [() => svc.setState(schema, EVT.SCHEMA_TRANSFORM, {id:'transform_default',transforms:DEFAULT_TRANSFORMS}, 'default')],
        ].flat();
        for (let i = 0; i < allSeeds.length; i++) {
          await allSeeds[i]();
          if (i % 3 === 2) await new Promise(r => setTimeout(r, 200));
        }
      }
      setVaultRoom(vault); setSchemaRoom(schema);
      await loadVault(vault, bridgeProfiles);
      setPendingClaims(detectedPending);
      setClaimedRooms(detectedClaimed);
      if (detectedTeams.length > 0) setMyTeams(detectedTeams);
    } catch (e) {
      console.error('Vault init failed:', e);
      setInitError(e.message || 'Failed to initialize vault.');
    }
    setLoading(false);
  };

  const loadVault = async (rid, bridgeProfiles) => {
    const snap = await svc.getState(rid, EVT.VAULT_SNAPSHOT);
    setVaultData(snap?.fields || {});
    setObservations(snap?.observations || []);
    setMetricsConsent(snap?.metrics_consent || {enabled:false,categories:[]});
    setCustomFieldDefs(snap?.custom_field_defs || []);
    setEnabledFrameworks(snap?.enabled_frameworks || []);
    const idx = await svc.getState(rid, EVT.VAULT_PROVIDERS);
    // Enrich providers with profile data and bridge meta from bridge rooms
    const enrichedProviders = (idx?.providers || []).map(p => {
      const profile = bridgeProfiles?.[p.bridgeRoomId];
      if (!profile) return p;
      const bm = profile._bridgeMeta;
      const clean = {...profile}; delete clean._bridgeMeta;
      return {...p,
        providerProfile: clean.display_name ? clean : p.providerProfile,
        providerName: clean.display_name || p.providerName,
        transferable: bm?.transferable !== false ? true : false,
        org_id: bm?.org_id || p.org_id || null,
        assigned_staff: bm?.assigned_staff || [p.providerUserId],
      };
    });
    setProviders(enrichedProviders);
  };

  const saveSnapshot = async (fields, obs, mc, cfd, ef) => {
    const snapshot = {fields:fields??vaultData, observations:obs??observations, metrics_consent:mc??metricsConsent, custom_field_defs:cfd??customFieldDefs, enabled_frameworks:ef??enabledFrameworks};
    await svc.setState(vaultRoom, EVT.VAULT_SNAPSHOT, snapshot);
    setVaultData(snapshot.fields); setObservations(snapshot.observations); setMetricsConsent(snapshot.metrics_consent); setCustomFieldDefs(snapshot.custom_field_defs); setEnabledFrameworks(snapshot.enabled_frameworks);
  };

  const saveProviderIndex = async (provs) => {
    await svc.setState(vaultRoom, EVT.VAULT_PROVIDERS, {providers:provs});
    setProviders(provs);
  };

  // Edit identity fields — emits INS or ALT per field
  const handleEditSave = async () => {
    const updated = {...vaultData, ...editData};
    for (const [key, val] of Object.entries(editData)) {
      if (val && !vaultData[key]) {
        await emitOp(vaultRoom, 'INS', {field:key,value:val}, {source:'client_input'}, vaultFrame());
      } else if (val && vaultData[key] && val !== vaultData[key]) {
        await emitOp(vaultRoom, 'ALT', {field:key,entity:'client_profile'}, {from:vaultData[key],to:val,source:'client_input'}, vaultFrame());
      } else if (!val && vaultData[key]) {
        await emitOp(vaultRoom, 'NUL', {field:key,entity:'client_profile'}, {reason:'client_cleared',previous_value:vaultData[key]}, vaultFrame());
      }
    }
    await saveSnapshot(updated);
    setEditModal(false);
    showToast('Vault updated','success');
    // Propagate to bridges (§8.3)
    for (const prov of providers) {
      const changedShared = Object.keys(editData).filter(k => prov.sharedFields?.[k]);
      if (changedShared.length > 0) await syncFieldsToBridge(prov.bridgeRoomId, prov.sharedFields, updated);
    }
  };

  // Record structured observation (Addendum A)
  const handleRecordObservation = async () => {
    if (!obsValue || !obsModal) return;
    const obs = { id:genOpId(), category:obsModal.key, value:obsValue, date:obsDate, prompt_id:obsModal.id,
      schema_version:obsModal.version||1, free_text:obsFreeText||undefined, ts:Date.now() };
    await emitOp(vaultRoom, 'INS', {type:'observation',category:obsModal.key,value:obsValue,date:obsDate},
      {reported_by:'client',method:'self_report',prompt:obsModal.question,free_text:obsFreeText||undefined}, vaultFrame());
    const newObs = [...observations, obs];
    await saveSnapshot(undefined, newObs);
    setObsModal(null); setObsValue(''); setObsFreeText('');
    showToast(`Observation recorded: ${obsModal.question}`,'success');
    // Emit to metrics if consent
    if (metricsConsent.enabled && obsModal.metrics && metricsConsent.categories?.includes(obsModal.category)) {
      for (const prov of providers) {
        if (prov.metricsRoom) {
          await emitMetric(prov.metricsRoom, svc.userId, {category:obsModal.key,value:obsValue,date_bucket:`${obsDate.slice(0,7)}`}, vaultData);
        }
      }
    }
  };

  const handleAddProvider = async () => {
    if (!newProviderId.trim()) return;
    try {
      const bridgeId = await svc.createRoom(`[Khora Bridge] ${svc.userId} ↔ ${newProviderId}`, 'Khora bridge — shared data room', [
        {type:EVT.BRIDGE_META,state_key:'',content:{client:svc.userId,provider:newProviderId,relationship_type:RELATIONSHIP_TYPES.client_provider.id,created:Date.now(),status:'active',transferable:true,org_id:null,assigned_staff:[newProviderId]}},
        {type:EVT.BRIDGE_REFS,state_key:'',content:{fields:{}}},
      ]);
      await svc.invite(bridgeId, newProviderId);
      await emitOp(vaultRoom, 'CON', {source:svc.userId,destination:newProviderId,relationship:RELATIONSHIP_TYPES.client_provider.id},
        {bridge_room:bridgeId,initiated_by:'client'}, vaultFrame());
      const newProv = {bridgeRoomId:bridgeId,providerUserId:newProviderId,sharedFields:{},providerName:newProviderId,transferable:true};
      await saveProviderIndex([...providers, newProv]);
      setAddProviderModal(false); setNewProviderId('');
      showToast(`Bridge created — invite sent to ${newProviderId}`,'success');
    } catch(e) { showToast('Failed: '+e.message,'error'); }
  };

  const syncFieldsToBridge = async (bridgeRoomId, sharedFields, data) => {
    const refs = {};
    for (const [fk, shared] of Object.entries(sharedFields)) {
      if (shared && data[fk]) {
        const keyB64 = await FieldCrypto.generateKey();
        const enc = await FieldCrypto.encrypt(data[fk], keyB64);
        refs[fk] = {...enc, key:keyB64};
      }
    }
    await svc.setState(bridgeRoomId, EVT.BRIDGE_REFS, {fields:refs, updated:Date.now()});
  };

  const handleToggleField = async (pi, fk) => {
    const prov = providers[pi];
    const newShared = {...prov.sharedFields, [fk]:!prov.sharedFields[fk]};
    const ups = [...providers]; ups[pi] = {...prov, sharedFields:newShared};
    await saveProviderIndex(ups);
    await emitOp(prov.bridgeRoomId, 'SEG', {field:fk,visibility:newShared[fk]?'shared':'revoked'},
      {provider:prov.providerUserId}, bridgeFrame(prov.bridgeRoomId), newShared[fk]?[]:[`prev_seg_${fk}`]);
    await syncFieldsToBridge(prov.bridgeRoomId, newShared, vaultData);
    const label = allFields.find(f=>f.key===fk)?.label||fk;
    showToast(newShared[fk]?`Shared ${label} — new key issued`:`Revoked ${label} — key destroyed`, newShared[fk]?'success':'warn');
  };

  // Toggle whether this client allows their case to be transferred between providers within the org
  const handleToggleTransferable = async (pi) => {
    const prov = providers[pi];
    const newVal = !prov.transferable;
    try {
      // Update bridge meta (client has PL 100 — full control)
      const currentMeta = await svc.getState(prov.bridgeRoomId, EVT.BRIDGE_META);
      await svc.setState(prov.bridgeRoomId, EVT.BRIDGE_META, {...currentMeta, transferable: newVal});
      await emitOp(prov.bridgeRoomId, 'ALT', {entity:'bridge',field:'transferable',value:newVal},
        {reason:newVal?'client_enabled_transfer':'client_disabled_transfer'}, bridgeFrame(prov.bridgeRoomId));
      // Update local provider index
      const ups = [...providers]; ups[pi] = {...prov, transferable: newVal};
      await saveProviderIndex(ups);
      showToast(newVal ? 'Provider transfer allowed — org can reassign your case' : 'Provider transfer blocked — only this provider can access your bridge', newVal ? 'success' : 'warn');
    } catch(e) { showToast('Failed to update transfer setting: '+e.message, 'error'); }
  };

  const handleHardRevoke = async (pi) => {
    const prov = providers[pi];
    try {
      const newBridgeId = await svc.createRoom(`[Khora Bridge] ${svc.userId} ↔ ${prov.providerUserId}`, 'Khora bridge — replaced', [
        {type:EVT.BRIDGE_META,state_key:'',content:{client:svc.userId,provider:prov.providerUserId,relationship_type:RELATIONSHIP_TYPES.client_provider.id,created:Date.now(),status:'active',previous:prov.bridgeRoomId,transferable:prov.transferable!==false,org_id:null,assigned_staff:[prov.providerUserId]}},
        {type:EVT.BRIDGE_REFS,state_key:'',content:{fields:{}}},
      ]);
      await emitOp(prov.bridgeRoomId, 'NUL', {entity:'bridge',field:'relationship'}, {reason:'hard_revoke'}, bridgeFrame(prov.bridgeRoomId));
      const stillShared = Object.fromEntries(Object.entries(prov.sharedFields).filter(([,v])=>v));
      if (Object.keys(stillShared).length > 0) await syncFieldsToBridge(newBridgeId, stillShared, vaultData);
      await svc.invite(newBridgeId, prov.providerUserId);
      await svc.tombstone(prov.bridgeRoomId, newBridgeId);
      try { await svc.kick(prov.bridgeRoomId, prov.providerUserId, 'Bridge rotated — data revoked'); } catch {}
      await emitOp(newBridgeId, 'CON', {source:svc.userId,destination:prov.providerUserId,relationship:RELATIONSHIP_TYPES.client_provider.id},
        {bridge_room:newBridgeId,initiated_by:'client',reason:'hard_revoke_replacement'}, bridgeFrame(newBridgeId));
      const ups = [...providers]; ups[pi] = {...prov, bridgeRoomId:newBridgeId};
      await saveProviderIndex(ups);
      setHardRevokeTarget(null);
      showToast('Hard revoke complete — old room tombstoned, all keys rotated','success');
    } catch(e) { showToast('Hard revoke failed: '+e.message,'error'); }
  };

  const handleRemoveProvider = async (pi) => {
    const prov = providers[pi];
    try {
      try { await svc.kick(prov.bridgeRoomId, prov.providerUserId); } catch {}
      await svc.setState(prov.bridgeRoomId, EVT.BRIDGE_REFS, {fields:{},revoked:true,updated:Date.now()});
      await emitOp(vaultRoom, 'NUL', {entity:'team_member_relationship',field:prov.providerUserId},
        {reason:'full_severance',bridge:prov.bridgeRoomId}, vaultFrame());
      await saveProviderIndex(providers.filter((_,i)=>i!==pi));
      showToast(`${ROLES.provider.label} removed, all keys destroyed`,'warn');
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // ─── Room claiming: client takes ownership of a provider-created client_record room ───
  const claimFrame = (room) => ({type:'client_record',room,role:'client',epistemic:'GIVEN'});

  const handleClaimRoom = async (record) => {
    try {
      // 0. Ensure we've joined the room (required before writing state)
      try { await svc.joinRoom(record.roomId); } catch {}
      const prevIdentity = await svc.getState(record.roomId, EVT.IDENTITY);
      const previousOwner = prevIdentity?.owner || record.owner;
      // 1. Ensure client has PL 100 and provider drops to PL 50
      await svc.setPowerLevel(record.roomId, svc.userId, 100);
      if (previousOwner && previousOwner !== svc.userId) {
        await svc.setPowerLevel(record.roomId, previousOwner, 50);
      }
      // 2. Transfer ownership in identity state
      await svc.setState(record.roomId, EVT.IDENTITY, {
        ...prevIdentity,
        owner: svc.userId,
        status: 'claimed',
        claimed_at: Date.now(),
        claimed_by: svc.userId,
        previous_owner: previousOwner,
      });
      // 3. Emit ALT operation recording the ownership transfer
      await emitOp(record.roomId, 'ALT',
        {entity: 'room_ownership', field: 'owner'},
        {from: previousOwner, to: svc.userId, reason: 'client_claim'},
        claimFrame(record.roomId));
      // 4. Move from pending to claimed
      setPendingClaims(prev => prev.filter(r => r.roomId !== record.roomId));
      setClaimedRooms(prev => [...prev, {
        ...record, owner: svc.userId, status: 'claimed',
        claimed_at: Date.now(), previous_owner: previousOwner,
      }]);
      showToast(`Room claimed — you now have full control of "${record.client_name || 'this record'}"`, 'success');
    } catch (e) { showToast('Claim failed: ' + e.message, 'error'); }
  };

  const handleRevokeFromClaimed = async (record, targetUserId) => {
    try {
      await svc.kick(record.roomId, targetUserId, 'Removed by room owner');
      await emitOp(record.roomId, 'NUL',
        {entity: 'room_member', field: targetUserId},
        {reason: 'owner_revocation', removed_by: svc.userId},
        claimFrame(record.roomId));
      showToast(`Removed ${targetUserId} from room`, 'warn');
    } catch (e) { showToast('Remove failed: ' + e.message, 'error'); }
  };

  const handleDeleteClaimedRoom = async (record) => {
    try {
      // Tombstone the room — marks it as permanently closed
      await svc.setState(record.roomId, 'm.room.tombstone', {
        body: 'This room has been closed by the owner',
      });
      await emitOp(record.roomId, 'NUL',
        {entity: 'client_record', field: 'room'},
        {reason: 'owner_closed', closed_by: svc.userId},
        claimFrame(record.roomId));
      setClaimedRooms(prev => prev.filter(r => r.roomId !== record.roomId));
      showToast('Room closed permanently', 'warn');
    } catch (e) { showToast('Close failed: ' + e.message, 'error'); }
  };

  const handleMetricsToggle = async () => {
    const newConsent = {...metricsConsent, enabled:!metricsConsent.enabled,
      categories:!metricsConsent.enabled? DEFAULT_PROMPTS.filter(p=>p.metrics).map(p=>p.category) : []};
    await emitOp(vaultRoom, 'REC', {rule:'metrics_consent',scope:'vault'},
      {consent_level:newConsent.enabled?'anonymized_demographics':'none',categories:newConsent.categories}, vaultFrame());
    await saveSnapshot(undefined, undefined, newConsent);
    showToast(newConsent.enabled?'Metrics consent enabled — anonymized data will flow':'Metrics consent revoked',newConsent.enabled?'success':'warn');
  };

  const loadBridgeMessages = async (bid) => { setBridgeMessages(await svc.getMessages(bid)); };
  const handleSendBridgeMsg = async () => {
    if (!msgText.trim()||!activeBridge) return;
    await svc.sendMessage(activeBridge, msgText, {[`${NS}.type`]:'note'});
    setMsgText(''); setTimeout(()=>loadBridgeMessages(activeBridge),500);
  };
  const openBridge = (bid) => { setActiveBridge(bid); setView('bridge'); loadBridgeMessages(bid); };

  // ─── Inbox chat functions ───
  const loadInboxMessages = async (bid) => { setInboxMessages(await svc.getMessages(bid)); };
  const openInboxConvo = (providerIdx) => {
    setInboxConvo(providerIdx);
    const prov = providers[providerIdx];
    if (prov) loadInboxMessages(prov.bridgeRoomId);
  };
  const handleSendInboxMsg = async () => {
    if (!inboxMsgText.trim() || inboxConvo === null) return;
    const prov = providers[inboxConvo];
    if (!prov) return;
    await svc.sendMessage(prov.bridgeRoomId, inboxMsgText, {[`${NS}.type`]:'note'});
    setInboxMsgText('');
    setTimeout(() => loadInboxMessages(prov.bridgeRoomId), 500);
  };

  const activeProviderIdx = providers.findIndex(p=>p.bridgeRoomId===activeBridge);
  const activeProvider = activeProviderIdx>=0?providers[activeProviderIdx]:null;
  const filledFields = allFields.filter(f=>vaultData[f.key]);
  const sharedCount = providers.reduce((s,p)=>s+Object.values(p.sharedFields||{}).filter(Boolean).length,0);

  if(loading)return<div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}><Spin s={28}/></div>;

  if(initError) return <div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center',maxWidth:400,padding:20}}>
      <div style={{width:48,height:48,borderRadius:'var(--r-lg)',background:'var(--red-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--red)',margin:'0 auto 16px'}}><I n="alert-triangle" s={24}/></div>
      <h3 style={{fontSize:16,fontWeight:700,marginBottom:8}}>Vault Setup Failed</h3>
      <p style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6,marginBottom:16}}>{initError}</p>
      <div style={{display:'flex',gap:8,justifyContent:'center'}}>
        <button onClick={initVault} className="b-pri"><I n="refresh-cw" s={13}/>Retry</button>
        <button onClick={onLogout} className="b-gho">Sign Out</button>
      </div>
    </div>
  </div>;

  return <div style={{display:'flex',height:'100%'}}>
    {/* Sidebar */}
    <div className="app-sidebar" style={{width:250,minWidth:250,height:'100%',background:'var(--bg-1)',borderRight:'1px solid var(--border-0)',display:'flex',flexDirection:'column'}}>
      <div style={{padding:'18px 14px 14px',borderBottom:'1px solid var(--border-0)'}}>
        <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
          <div style={{width:28,height:28,borderRadius:'var(--r)',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)'}}><I n="shield" s={15}/></div>
          <span style={{fontFamily:'var(--serif)',fontWeight:700,fontSize:15}}>Khora</span>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:6,marginTop:8}}>
          <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}}>{svc.userId}</span>
          <span className="tag tag-teal">{ROLES.client.label.toUpperCase()}</span>
        </div>
      </div>
      <div style={{flex:1,overflow:'auto',padding:'6px 6px'}}>
        {[{id:'vault',icon:'folder',label:'My Vault'},{id:'inbox',icon:'msg',label:'Messages'},
          {id:'observations',icon:'clipboard',label:'Observations'},
          {id:'providers',icon:'users',label:'People & Teams'},{id:'records',icon:'shield',label:'My Records'},
          {id:'metrics',icon:'bar',label:'Metrics'},{id:'activity',icon:'zap',label:'Activity Stream'}
        ].map(item=><div key={item.id} onClick={()=>{setView(item.id);setActiveBridge(null);if(item.id!=='inbox')setInboxConvo(null)}}
          style={{padding:'9px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
            background:view===item.id&&!activeBridge?'var(--bg-4)':'transparent',
            borderLeft:view===item.id&&!activeBridge?'2px solid var(--teal)':'2px solid transparent',
            display:'flex',alignItems:'center',gap:8,transition:'all .15s',
            color:view===item.id&&!activeBridge?'var(--tx-0)':'var(--tx-1)'}}
          onMouseEnter={e=>{if(!(view===item.id&&!activeBridge))e.currentTarget.style.background='var(--bg-3)'}}
          onMouseLeave={e=>{if(!(view===item.id&&!activeBridge))e.currentTarget.style.background='transparent'}}>
          <I n={item.icon} s={14}/><span style={{fontSize:12.5,fontWeight:view===item.id?600:400}}>{item.label}</span>
          {item.id==='inbox'&&providers.length>0&&<span className="nav-badge nav-badge-teal">{providers.length}</span>}
          {item.id==='records'&&pendingClaims.length>0&&<span className="nav-badge nav-badge-gold">{pendingClaims.length}</span>}
        </div>)}
        {providers.length>0&&<><div style={{padding:'14px 10px 4px'}}><span className="section-label">BRIDGES</span></div>
          {providers.map((p,i)=><div key={p.bridgeRoomId} onClick={()=>openBridge(p.bridgeRoomId)}
            style={{padding:'8px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
              background:activeBridge===p.bridgeRoomId?'var(--bg-4)':'transparent',
              borderLeft:activeBridge===p.bridgeRoomId?'2px solid var(--gold)':'2px solid transparent',transition:'all .15s'}}
            onMouseEnter={e=>{if(activeBridge!==p.bridgeRoomId)e.currentTarget.style.background='var(--bg-3)'}}
            onMouseLeave={e=>{if(activeBridge!==p.bridgeRoomId)e.currentTarget.style.background='transparent'}}>
            <span style={{fontSize:12,fontWeight:activeBridge===p.bridgeRoomId?600:400,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.providerName||p.providerUserId}</span>
            <div style={{display:'flex',alignItems:'center',gap:4}}>
              {p.providerProfile?.org_membership?.verified && <><I n="shieldCheck" s={9} c="var(--blue)"/><span style={{fontSize:8.5,color:'var(--blue)',fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',maxWidth:100}}>{p.providerProfile.org_membership.org_name}</span></>}
              <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{Object.values(p.sharedFields||{}).filter(Boolean).length} fields</span>
            </div>
          </div>)}</>}
      </div>
      <div style={{padding:'8px 10px',borderTop:'1px solid var(--border-0)',display:'flex',flexDirection:'column',gap:6}}>
        <ThemeToggle style={{width:'100%',justifyContent:'center'}}/>
        <button onClick={onLogout} className="b-gho b-sm" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:5}}><I n="logout" s={12}/>Logout</button>
      </div>
    </div>

    {/* Main content */}
    <div className="app-main" style={{flex:1,overflow:'auto',padding:24}}>

      {/* VAULT VIEW */}
      {view==='vault'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Your Vault</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>All data encrypted in your private Matrix room. Only you can read this.</p></div>
          <div style={{display:'flex',gap:8}}>
            <button onClick={()=>setFrameworkModal(true)} className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="grid" s={14}/>{enabledFrameworks.length > 0 && <span className="tag tag-green" style={{fontSize:8,padding:'1px 5px'}}>{enabledFrameworks.length}</span>}Frameworks</button>
            <button onClick={()=>setAddFieldModal(true)} className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>Add Field</button>
            <button onClick={()=>{setEditData({...vaultData});setEditModal(true)}} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="key" s={14}/>Edit Vault</button>
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(170px,1fr))',gap:10,marginBottom:24}}>
          {[{l:'Fields',v:`${filledFields.length}/${allFields.length}`,c:'teal',i:'folder'},
            {l:ROLES.provider.label+'s',v:providers.length,c:'gold',i:'users'},
            {l:'Observations',v:observations.length,c:'blue',i:'clipboard'},
            {l:'Shared Fields',v:sharedCount,c:'orange',i:'share'},
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {allCategories.map(cat=>{const fields=allFields.filter(f=>f.category===cat);const color=CAT_COLORS[cat]||'gold';
          if(!fields.length) return null;
          return <div key={cat} style={{marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
              <span style={{color:`var(--${color})`}}><I n={CAT_ICONS[cat]||'file'} s={13}/></span>
              <span className="section-label" style={{marginBottom:0}}>{(CAT_LABELS[cat]||cat.charAt(0).toUpperCase()+cat.slice(1)).toUpperCase()}</span></div>
            <div className="card" style={{padding:0,overflow:'hidden'}}>
              {fields.map((f,fi)=><div key={f.key} style={{padding:'10px 16px',borderBottom:fi<fields.length-1?'1px solid var(--border-0)':'none',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:12.5,fontWeight:500}}>{f.label}</span>
                  {f.sensitive&&<span className="tag tag-red" style={{fontSize:8.5}}>SENSITIVE</span>}
                  {f.custom&&<span className="tag tag-purple" style={{fontSize:8.5}}>CUSTOM</span>}
                  {f.framework&&<a href={f.uri||f.frameworkUri} target="_blank" rel="noopener" className={`tag tag-${FRAMEWORK_BY_ID[f.framework]?.accent||'blue'}`} style={{fontSize:8.5,textDecoration:'none',cursor:'pointer'}} title={`${f.frameworkName} — ${f.property}`}>{f.frameworkName}</a>}</div>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontFamily:'var(--mono)',fontSize:11.5,color:vaultData[f.key]?'var(--tx-1)':'var(--tx-3)',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                    {vaultData[f.key]?(f.sensitive?'••••••••':vaultData[f.key]):'—'}</span>
                  {f.custom&&<span onClick={()=>handleDeleteCustomField(f.key)} style={{cursor:'pointer',color:'var(--tx-3)',transition:'color .15s'}}
                    onMouseEnter={e=>e.currentTarget.style.color='var(--red)'} onMouseLeave={e=>e.currentTarget.style.color='var(--tx-3)'}><I n="trash" s={12}/></span>}
                </div>
              </div>)}
            </div>
          </div>;
        })}
      </div>}

      {/* OBSERVATIONS VIEW (Addendum A) */}
      {view==='observations'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Observations</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Structured observations — the thermometer readings. What happened, not what it means.</p></div>
        </div>
        <div className="card" style={{marginBottom:20}}>
          <span className="section-label">RECORD NEW OBSERVATION</span>
          <p style={{fontSize:12,color:'var(--tx-2)',marginBottom:12}}>Choose a form field to record what you observed. Each observation is an immutable GIVEN event in your vault.</p>
          {DEFAULT_FORMS.map(f=><div key={f.id} style={{marginBottom:12}}>
            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
              <span style={{fontSize:11.5,fontWeight:600,color:'var(--tx-0)'}}>{f.name}</span>
              <MaturityBadge maturity={f.maturity}/>
              {f.source && <SourceBadge source={f.source}/>}
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(240px,1fr))',gap:8}}>
              {f.fields.map(p=><div key={p.id} className="card-h" onClick={()=>{setObsModal(p);setObsValue('');setObsFreeText('');setObsDate(new Date().toISOString().slice(0,10))}}
                style={{padding:14}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6,flexWrap:'wrap'}}>
                  <span className={`tag tag-${OBS_CAT_COLORS[p.category]||'blue'}`}>{p.category}</span>
                  {p.sensitive&&<span className="tag tag-red" style={{fontSize:8}}>SENSITIVE</span>}
                  {p.maturity && <MaturityBadge maturity={p.maturity}/>}
                </div>
                <span style={{fontSize:13,fontWeight:600,display:'block'}}>{p.question}</span>
                <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4}}>
                  <span style={{fontSize:10.5,color:'var(--tx-3)'}}>{p.options.length} response options</span>
                </div>
              </div>)}
            </div>
          </div>)}
        </div>
        {/* Observation history */}
        <div className="card">
          <span className="section-label">OBSERVATION HISTORY ({observations.length})</span>
          {observations.length===0?<p style={{color:'var(--tx-3)',fontSize:12.5,padding:'16px 0',textAlign:'center'}}>No observations recorded yet</p>
          :<div style={{display:'flex',flexDirection:'column',gap:4,marginTop:8}}>
            {[...observations].reverse().map((obs,i)=>{
              const prompt = DEFAULT_PROMPTS.find(p=>p.key===obs.category);
              const optLabel = prompt?.options.find(o=>o.v===obs.value)?.l || obs.value;
              return <div key={obs.id||i} style={{padding:'10px 14px',background:'var(--bg-3)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:10}}>
                <span className={`tag tag-${OBS_CAT_COLORS[obs.category]||'blue'}`} style={{fontSize:9}}>{obs.category}</span>
                <span className="tag tag-teal" style={{fontSize:8.5}}>GIVEN</span>
                <span style={{fontSize:12,flex:1}}>{optLabel}</span>
                {obs.free_text&&<span style={{fontSize:10.5,color:'var(--tx-2)',fontStyle:'italic'}}>{obs.free_text}</span>}
                <span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{obs.date}</span>
              </div>;
            })}
          </div>}
        </div>
        {/* GIVEN/MEANT divide for client observations with framework bindings */}
        {observations.filter(obs => FRAMEWORK_BINDINGS[obs.category]?.bindings?.[obs.value]).length > 0 && <div style={{marginTop:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'linear-gradient(135deg,var(--teal),var(--gold))',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-0)',fontSize:11,fontWeight:800}}>&#8594;</div>
            <span style={{fontFamily:'var(--serif)',fontSize:15,fontWeight:700}}>What Your Observations Mean</span>
            <span className="gm-sup-badge">GIVEN &#8594; MEANT</span>
          </div>
          <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Your observations are facts. Below you can see how different institutional frameworks interpret those same facts differently.</p>
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            {observations.filter(obs => FRAMEWORK_BINDINGS[obs.category]?.bindings?.[obs.value]).slice(-3).reverse().map((obs,i) =>
              <RecordGivenMeant key={obs.id||i} promptKey={obs.category} value={obs.value}
                reporter={`${ROLES.client.label} self-report`} timestamp={obs.ts}/>
            )}
          </div>
        </div>}
      </div>}

      {/* PROVIDERS / TEAMS / CONTACTS VIEW */}
      {view==='providers'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>People & Teams</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Your {ROLES.provider.label.toLowerCase()}s, teams you belong to, and contacts — all in one place.</p></div>
          <button onClick={()=>setAddProviderModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>Add {ROLES.provider.label}</button>
        </div>

        {/* ── Section 1: Providers ── */}
        <div style={{marginBottom:24}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:12}}>
            <I n="briefcase" s={16} c="var(--gold)"/>
            <span style={{fontSize:15,fontWeight:700}}>{ROLES.provider.label}s</span>
            <span className="tag tag-gold" style={{fontSize:9}}>{providers.length}</span>
          </div>
          {providers.length===0?<div className="card" style={{textAlign:'center',padding:'24px 20px',borderStyle:'dashed'}}><I n="briefcase" s={24} c="var(--tx-3)"/><p style={{color:'var(--tx-2)',marginTop:8,fontSize:12}}>No {ROLES.provider.label.toLowerCase()}s yet. Add one to create an encrypted bridge.</p></div>
          :<div style={{display:'flex',flexDirection:'column',gap:10}}>
            {providers.map((prov,pi)=>{const shCount=Object.values(prov.sharedFields||{}).filter(Boolean).length;
              const pp = prov.providerProfile;
              const orgInfo = pp?.org_membership;
              return <div key={prov.bridgeRoomId} className="card" style={{padding:0,overflow:'hidden'}}>
                <div style={{padding:'14px 18px',display:'flex',alignItems:'center',justifyContent:'space-between',borderBottom:'1px solid var(--border-0)'}}>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{display:'flex',alignItems:'center',gap:8,flexWrap:'wrap'}}>
                      <span style={{fontSize:14,fontWeight:600}}>{prov.providerName||prov.providerUserId}</span>
                      {pp?.title && <span style={{fontSize:11,color:'var(--tx-2)'}}>{pp.title}</span>}
                      <span className="tag tag-green"><I n="lock" s={9}/>E2EE</span>
                    </div>
                    {orgInfo?.verified ? <div style={{display:'flex',alignItems:'center',gap:5,marginTop:4}}>
                      <I n="shieldCheck" s={12} c="var(--blue)"/>
                      <span style={{fontSize:11,fontWeight:600,color:'var(--blue)'}}>{orgInfo.org_name}</span>
                      {orgInfo.email_verified ? <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>EMAIL VERIFIED</span>
                      : <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>VERIFIED</span>}
                      {orgInfo.role && <span style={{fontSize:9,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{orgInfo.role}</span>}
                    </div> : <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-3)'}}>Independent {ROLES.provider.label.toLowerCase()}</span>}
                    {pp?.credentials && <div style={{marginTop:2}}><span style={{fontSize:9.5,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{pp.credentials}</span></div>}
                    <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-3)',display:'block',marginTop:2}}>Bridge: {prov.bridgeRoomId.slice(0,20)}…</span>
                  </div>
                  <div style={{display:'flex',gap:4}}>
                    <button onClick={()=>openBridge(prov.bridgeRoomId)} className="b-gho b-sm">Open Bridge</button>
                    <button onClick={()=>setHardRevokeTarget(pi)} className="b-red b-sm"><I n="zap" s={11}/></button>
                    <button onClick={()=>handleRemoveProvider(pi)} className="b-gho b-sm" style={{color:'var(--red)'}}><I n="trash" s={12}/></button>
                  </div>
                </div>
                {/* Transferable setting — client controls whether org can reassign */}
                <div style={{padding:'10px 18px',borderBottom:'1px solid var(--border-0)',background:prov.transferable===false?'var(--red-dim)':'var(--green-dim)',display:'flex',alignItems:'center',justifyContent:'space-between',gap:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,flex:1}}>
                    <I n={prov.transferable===false?'lock':'users'} s={14} c={prov.transferable===false?'var(--red)':'var(--green)'}/>
                    <div>
                      <span style={{fontSize:12,fontWeight:600,color:prov.transferable===false?'var(--red)':'var(--green)',display:'block'}}>
                        {prov.transferable===false ? 'Transfer Locked' : 'Transferable'}
                      </span>
                      <span style={{fontSize:10,color:'var(--tx-2)'}}>
                        {prov.transferable===false
                          ? 'Only this provider can access your bridge. Org cannot reassign.'
                          : 'Org can reassign your case to a different provider if needed.'}
                      </span>
                    </div>
                  </div>
                  <Toggle on={prov.transferable!==false} onChange={()=>handleToggleTransferable(pi)}/>
                </div>
                <div style={{padding:'12px 18px'}}>
                  <span className="section-label">FIELD-LEVEL SHARING</span>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0'}}>
                    {allFields.map(f=>{const isShared=prov.sharedFields?.[f.key]||false;const hasData=!!vaultData[f.key];
                      return <div key={f.key} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border-0)',marginRight:16}}>
                        <span style={{fontSize:12,color:hasData?'var(--tx-0)':'var(--tx-3)'}}>{f.label}{f.custom?' ✦':''}</span>
                        <Toggle on={isShared} onChange={()=>handleToggleField(pi,f.key)} disabled={!hasData}/>
                      </div>;})}
                  </div>
                  <div style={{marginTop:10,display:'flex',alignItems:'center',gap:6}}>
                    <I n="key" s={12} c="var(--tx-3)"/>
                    <span style={{fontSize:10.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{shCount}/{allFields.length} fields — unique AES-256-GCM keys</span>
                  </div>
                </div>
              </div>;})}
          </div>}
        </div>

        {/* ── Section 2: Teams ── */}
        <div style={{marginBottom:24}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:12}}>
            <I n="users" s={16} c="var(--purple,var(--blue))"/>
            <span style={{fontSize:15,fontWeight:700}}>My Teams</span>
            <span className="tag tag-blue" style={{fontSize:9}}>{myTeams.length}</span>
          </div>
          {myTeams.length===0?<div className="card" style={{textAlign:'center',padding:'24px 20px',borderStyle:'dashed'}}><I n="users" s={24} c="var(--tx-3)"/><p style={{color:'var(--tx-2)',marginTop:8,fontSize:12}}>Not part of any teams yet. Teams are created by {ROLES.provider.label.toLowerCase()}s to collaborate.</p></div>
          :<div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(250px,1fr))',gap:10}}>
            {myTeams.map(team=><div key={team.roomId} className="card" style={{padding:'14px 18px'}}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
                <span style={{fontSize:14,fontWeight:600}}>{team.name||'Unnamed Team'}</span>
                {team.org_name&&<span className="tag tag-blue" style={{fontSize:8}}>{team.org_name}</span>}
              </div>
              {team.description&&<p style={{fontSize:11,color:'var(--tx-2)',lineHeight:1.5,marginBottom:8}}>{team.description}</p>}
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                <I n="user" s={11} c="var(--tx-3)"/>
                <span style={{fontSize:10.5,color:'var(--tx-2)'}}>
                  {team.members?.length||0} member{(team.members?.length||0)!==1?'s':''}
                </span>
              </div>
              {team.members&&team.members.length>0&&<div style={{display:'flex',gap:3,flexWrap:'wrap',marginTop:6}}>
                {team.members.slice(0,4).map((m,mi)=>
                  <span key={mi} style={{fontSize:9,padding:'2px 6px',background:'var(--bg-3)',borderRadius:'var(--r)',color:'var(--tx-1)'}}>{m.display_name||m.userId?.split(':')[0]?.replace('@','')}</span>)}
                {team.members.length>4&&<span style={{fontSize:9,color:'var(--tx-3)'}}>+{team.members.length-4}</span>}
              </div>}
            </div>)}
          </div>}
        </div>

        {/* ── Section 3: Contacts ── */}
        <div style={{marginBottom:24}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:12}}>
            <I n="msg" s={16} c="var(--teal)"/>
            <span style={{fontSize:15,fontWeight:700}}>Contacts</span>
          </div>
          {(() => {
            // Derive contacts: people who appear across bridges + teams (deduplicated)
            const contactMap = {};
            for (const prov of providers) {
              const uid = prov.providerUserId;
              if (uid && uid !== svc.userId && !contactMap[uid]) {
                contactMap[uid] = {userId:uid, name:prov.providerName||uid, source:'bridge', org:prov.providerProfile?.org_membership?.org_name};
              }
            }
            for (const team of myTeams) {
              for (const m of (team.members||[])) {
                if (m.userId && m.userId !== svc.userId && !contactMap[m.userId]) {
                  contactMap[m.userId] = {userId:m.userId, name:m.display_name||m.userId, source:'team', team:team.name};
                }
              }
            }
            const contacts = Object.values(contactMap);
            return contacts.length===0
              ? <div className="card" style={{textAlign:'center',padding:'24px 20px',borderStyle:'dashed'}}><I n="msg" s={24} c="var(--tx-3)"/><p style={{color:'var(--tx-2)',marginTop:8,fontSize:12}}>No contacts yet. Connect with {ROLES.provider.label.toLowerCase()}s or join teams to build your network.</p></div>
              : <div className="card" style={{padding:0,overflow:'hidden'}}>
                  {contacts.map((c,ci)=><div key={c.userId} style={{padding:'10px 16px',borderBottom:ci<contacts.length-1?'1px solid var(--border-0)':'none',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                      <div style={{width:24,height:24,borderRadius:'50%',background:c.source==='bridge'?'var(--gold-dim)':'var(--blue-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:c.source==='bridge'?'var(--gold)':'var(--blue)',flexShrink:0}}>
                        <I n={c.source==='bridge'?'briefcase':'users'} s={11}/></div>
                      <div>
                        <span style={{fontSize:12.5,fontWeight:500,display:'block'}}>{c.name}</span>
                        <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{c.userId}</span>
                      </div>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:4}}>
                      {c.org&&<span className="tag tag-blue" style={{fontSize:8}}>{c.org}</span>}
                      {c.team&&<span className="tag tag-purple" style={{fontSize:8}}>{c.team}</span>}
                      <span className={`tag ${c.source==='bridge'?'tag-gold':'tag-blue'}`} style={{fontSize:8}}>{c.source==='bridge'?ROLES.provider.label:'Team'}</span>
                    </div>
                  </div>)}
                </div>;
          })()}
        </div>
      </div>}

      {/* MY RECORDS VIEW — rooms claimed from providers */}
      {view==='records'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>My Records</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Rooms created by providers on your behalf. Claim them to take full ownership and control.</p></div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(140px,1fr))',gap:10,marginBottom:20}}>
          {[{l:'Pending',v:pendingClaims.length,c:'gold',i:'clock'},
            {l:'Claimed',v:claimedRooms.length,c:'teal',i:'shield'},
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {/* Pending claims */}
        {pendingClaims.length>0&&<div style={{marginBottom:20}}>
          <span className="section-label">PENDING — AWAITING YOUR CLAIM</span>
          <div style={{display:'flex',flexDirection:'column',gap:8,marginTop:8}}>
            {pendingClaims.map(rec=><div key={rec.roomId} className="card" style={{padding:'14px 18px',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <div>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:14,fontWeight:600}}>{rec.client_name||'Unnamed Record'}</span>
                  <span className="tag tag-gold">Pending</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:10,marginTop:4}}>
                  <span style={{fontSize:10.5,color:'var(--tx-2)'}}>Created by: <span style={{fontFamily:'var(--mono)'}}>{rec.owner}</span></span>
                  {rec.created&&<span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{new Date(rec.created).toLocaleDateString()}</span>}
                </div>
                {rec.notes&&<span style={{fontSize:11,color:'var(--tx-2)',marginTop:4,display:'block',fontStyle:'italic'}}>{rec.notes}</span>}
              </div>
              <button onClick={()=>handleClaimRoom(rec)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6,whiteSpace:'nowrap'}}>
                <I n="shield" s={13}/>Claim Room
              </button>
            </div>)}
          </div>
        </div>}
        {/* Claimed rooms */}
        {claimedRooms.length>0&&<div style={{marginBottom:20}}>
          <span className="section-label">CLAIMED — YOU OWN THESE ROOMS</span>
          <div style={{display:'flex',flexDirection:'column',gap:8,marginTop:8}}>
            {claimedRooms.map(rec=><div key={rec.roomId} className="card" style={{padding:0,overflow:'hidden'}}>
              <div style={{padding:'14px 18px',display:'flex',alignItems:'center',justifyContent:'space-between',borderBottom:'1px solid var(--border-0)'}}>
                <div>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <span style={{fontSize:14,fontWeight:600}}>{rec.client_name||'Record'}</span>
                    <span className="tag tag-teal">Claimed</span>
                    <span className="tag tag-green"><I n="lock" s={9}/>PL 100</span>
                  </div>
                  <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--tx-3)'}}>Room: {rec.roomId.slice(0,25)}…</span>
                </div>
                <div style={{display:'flex',gap:4}}>
                  {rec.previous_owner&&<button onClick={()=>handleRevokeFromClaimed(rec,rec.previous_owner)} className="b-gho b-sm" style={{color:'var(--red)',display:'flex',alignItems:'center',gap:3}}>
                    <I n="userMinus" s={11}/>Remove Provider
                  </button>}
                  <button onClick={()=>handleDeleteClaimedRoom(rec)} className="b-gho b-sm" style={{color:'var(--red)',display:'flex',alignItems:'center',gap:3}}>
                    <I n="trash" s={11}/>Close Room
                  </button>
                </div>
              </div>
              <div style={{padding:'12px 18px',fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
                <div style={{display:'flex',gap:16,flexWrap:'wrap'}}>
                  {rec.previous_owner&&<span>Previous owner: <span style={{fontFamily:'var(--mono)',fontSize:10.5}}>{rec.previous_owner}</span></span>}
                  {rec.claimed_at&&<span>Claimed: <span style={{fontFamily:'var(--mono)',fontSize:10.5}}>{new Date(rec.claimed_at).toLocaleString()}</span></span>}
                </div>
              </div>
            </div>)}
          </div>
        </div>}
        {pendingClaims.length===0&&claimedRooms.length===0&&
          <div className="card" style={{textAlign:'center',padding:'40px 20px',borderStyle:'dashed'}}>
            <I n="shield" s={32}/>
            <p style={{color:'var(--tx-2)',marginTop:10,fontSize:13}}>No records to claim</p>
            <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:4}}>When a provider creates a room for you and sends an invite, it will appear here for you to claim.</p>
          </div>}
        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="shield" s={16} c="var(--teal)"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong style={{color:'var(--teal)'}}>Full control after claiming:</strong> When you claim a room, ownership transfers to you (power level 100). You can remove the provider, close the room, or manage who has access. The provider cannot undo your claim.
          </span>
        </div>
      </div>}

      {/* METRICS VIEW (§B) */}
      {view==='metrics'&&!activeBridge&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:6}}>Metrics Consent</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:20}}>Control whether anonymized observations flow to provider metrics rooms. Your name, DOB, SSN, and address are never transmitted.</p>
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:14}}>
            <div><span style={{fontSize:14,fontWeight:600}}>Anonymized Metrics Reporting</span>
              <p style={{fontSize:11.5,color:'var(--tx-2)',marginTop:2}}>Observations are anonymized before leaving your bridge. PII is always blocked.</p></div>
            <Toggle on={metricsConsent.enabled} onChange={handleMetricsToggle}/>
          </div>
          {metricsConsent.enabled&&<div>
            <span className="section-label">CONSENTED CATEGORIES</span>
            <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
              {metricsConsent.categories?.map(c=><span key={c} className="tag tag-green">{c}</span>)}
            </div>
            <div style={{marginTop:12,padding:'10px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span className="section-label" style={{marginBottom:6}}>WHAT GETS SENT</span>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4,fontSize:11}}>
                {[['Sleep location','pass-through'],['Service contacts','pass-through'],['DOB','age range only'],['Address','census tract only'],
                  ['Income','bracket only'],['Name','BLOCKED'],['SSN','BLOCKED'],['Phone','BLOCKED'],['Email','BLOCKED']].map(([f,t])=>
                  <div key={f} style={{display:'flex',justifyContent:'space-between',padding:'3px 0'}}>
                    <span style={{color:'var(--tx-1)'}}>{f}</span>
                    <span className={`tag ${t==='BLOCKED'?'tag-red':'tag-teal'}`} style={{fontSize:8.5}}>{t}</span>
                  </div>)}
              </div>
            </div>
          </div>}
        </div>
        <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'14px 18px',display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="eye" s={16} c="var(--gold)"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong>K-anonymity (k=5):</strong> No demographic combination with fewer than 5 matching individuals is reported. Data is generalized or suppressed to prevent re-identification.
          </span>
        </div>
      </div>}

      {/* MESSAGES VIEW */}
      {view==='inbox'&&!activeBridge&&<div className="anim-up inbox-wrap">
        <div className="inbox-header">
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Messages</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Encrypted conversations with your providers. Messages are end-to-end encrypted.</p>
          </div>
          <button onClick={()=>setAddProviderModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}><I n="plus" s={14}/>New Conversation</button>
        </div>
        <div className="inbox-panel">
          {/* Conversation list */}
          <div className="inbox-list">
            <div style={{padding:'14px 14px 10px',borderBottom:'1px solid var(--border-0)'}}>
              <span className="section-label" style={{marginBottom:0}}>CONVERSATIONS ({providers.length})</span>
            </div>
            <div style={{flex:1,overflow:'auto'}}>
              {providers.length===0?
                <div style={{padding:'40px 16px',textAlign:'center'}}>
                  <I n="msg" s={28} c="var(--tx-3)"/>
                  <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:10}}>No conversations yet</p>
                  <p style={{color:'var(--tx-3)',fontSize:10.5,marginTop:4}}>Add a provider to start chatting</p>
                </div>
              :providers.map((p,i)=><div key={p.bridgeRoomId} onClick={()=>openInboxConvo(i)}
                style={{padding:'12px 14px',cursor:'pointer',borderBottom:'1px solid var(--border-0)',
                  background:inboxConvo===i?'var(--bg-4)':'transparent',
                  borderLeft:inboxConvo===i?'3px solid var(--teal)':'3px solid transparent',
                  transition:'all .15s'}}
                onMouseEnter={e=>{if(inboxConvo!==i)e.currentTarget.style.background='var(--bg-3)'}}
                onMouseLeave={e=>{if(inboxConvo!==i)e.currentTarget.style.background=inboxConvo===i?'var(--bg-4)':'transparent'}}>
                <div style={{display:'flex',alignItems:'center',gap:10}}>
                  <div style={{width:36,height:36,borderRadius:'50%',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',border:'2px solid var(--gold)',flexShrink:0}}>
                    {p.providerProfile?.org_membership?.verified ? <I n="shieldCheck" s={16}/> : <I n="user" s={16}/>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <span style={{fontSize:13,fontWeight:inboxConvo===i?700:500,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.providerName||p.providerUserId}</span>
                    <div style={{display:'flex',alignItems:'center',gap:4,marginTop:2}}>
                      {p.providerProfile?.org_membership?.verified && <><I n="shieldCheck" s={9} c="var(--blue)"/><span style={{fontSize:9,color:'var(--blue)',fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',maxWidth:120}}>{p.providerProfile.org_membership.org_name}</span></>}
                      <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{Object.values(p.sharedFields||{}).filter(Boolean).length} shared</span>
                    </div>
                  </div>
                </div>
              </div>)}
            </div>
          </div>
          {/* Active conversation */}
          <div className="inbox-chat">
            {inboxConvo!==null&&providers[inboxConvo] ? (() => {
              const p = providers[inboxConvo];
              return <>
                {/* Chat header */}
                <div className="inbox-chat-hdr">
                  <div style={{width:32,height:32,borderRadius:'50%',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',border:'2px solid var(--gold)'}}>
                    {p.providerProfile?.org_membership?.verified ? <I n="shieldCheck" s={14}/> : <I n="user" s={14}/>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <span style={{fontSize:14,fontWeight:700,display:'block'}}>{p.providerName||p.providerUserId}</span>
                    <div style={{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}}>
                      <span className="tag tag-green" style={{fontSize:8}}><I n="lock" s={8}/>E2EE</span>
                      {p.providerProfile?.title && <span style={{fontSize:10,color:'var(--tx-2)'}}>{p.providerProfile.title}</span>}
                      {p.providerProfile?.org_membership?.verified && <span className="tag tag-blue" style={{fontSize:8}}>{p.providerProfile.org_membership.org_name}</span>}
                    </div>
                  </div>
                  <button onClick={()=>openBridge(p.bridgeRoomId)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="share" s={11}/>Bridge</button>
                  <button onClick={()=>loadInboxMessages(p.bridgeRoomId)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="refresh-cw" s={11}/></button>
                </div>
                {/* Messages */}
                <div className="inbox-msgs">
                  {inboxMessages.length===0?
                    <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
                      <I n="msg" s={32} c="var(--tx-3)"/>
                      <p style={{color:'var(--tx-3)',fontSize:12,marginTop:10}}>No messages yet</p>
                      <p style={{color:'var(--tx-3)',fontSize:11,marginTop:4}}>Start the conversation below</p>
                    </div>
                  :[...inboxMessages].reverse().map((msg,i)=>{
                    const isOwn = msg.sender===svc.userId;
                    return <div key={msg.id||i} style={{display:'flex',flexDirection:'column',alignItems:isOwn?'flex-end':'flex-start',marginBottom:4}}>
                      <div style={{maxWidth:'75%',padding:'10px 14px',borderRadius:isOwn?'14px 14px 4px 14px':'14px 14px 14px 4px',
                        background:isOwn?'var(--teal-dim)':'var(--bg-3)',border:`1px solid ${isOwn?'rgba(62,201,176,.2)':'var(--border-0)'}`,
                        transition:'transform .1s'}}>
                        <p style={{fontSize:12.5,color:'var(--tx-0)',lineHeight:1.5,wordBreak:'break-word'}}>{msg.content?.body}</p>
                      </div>
                      <div style={{display:'flex',alignItems:'center',gap:4,marginTop:3,padding:'0 6px'}}>
                        <span style={{fontFamily:'var(--mono)',fontSize:9,color:isOwn?'var(--teal)':'var(--gold)'}}>{isOwn?'You':p.providerName||msg.sender}</span>
                        <span style={{fontFamily:'var(--mono)',fontSize:8,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):''}</span>
                      </div>
                    </div>;
                  })}
                </div>
                {/* Compose */}
                <div className="inbox-compose">
                  <div style={{display:'flex',gap:8}}>
                    <input value={inboxMsgText} onChange={e=>setInboxMsgText(e.target.value)} placeholder="Type a message (E2EE)..."
                      onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendInboxMsg()}}}
                      style={{flex:1,borderRadius:20,padding:'10px 18px'}}/>
                    <button onClick={handleSendInboxMsg} className="b-pri" disabled={!inboxMsgText.trim()}
                      style={{borderRadius:20,width:42,height:42,padding:0,display:'flex',alignItems:'center',justifyContent:'center'}}>
                      <I n="send" s={16}/>
                    </button>
                  </div>
                </div>
              </>;
            })()
            : <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
              <div style={{width:64,height:64,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)',marginBottom:16}}>
                <I n="inbox" s={28}/>
              </div>
              <h3 style={{fontSize:16,fontWeight:700,marginBottom:6}}>Your Inbox</h3>
              <p style={{color:'var(--tx-2)',fontSize:12,maxWidth:280,textAlign:'center',lineHeight:1.6}}>
                {providers.length>0?'Select a conversation from the left to start chatting with your providers.':'Add a provider to begin your first encrypted conversation.'}
              </p>
              {providers.length===0&&<button onClick={()=>setAddProviderModal(true)} className="b-pri" style={{marginTop:14,display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>Add Provider</button>}
            </div>}
          </div>
        </div>
      </div>}

      {/* BRIDGE VIEW */}
      {view==='bridge'&&activeBridge&&activeProvider&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <button onClick={()=>{setView('providers');setActiveBridge(null)}} className="b-gho b-sm" style={{marginBottom:14,display:'flex',alignItems:'center',gap:4}}><I n="back" s={13}/>Back</button>
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:20}}>
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:20,fontWeight:700}}>Bridge: {activeProvider.providerName||activeProvider.providerUserId}</h2>
            {activeProvider.providerProfile?.title && <span style={{fontSize:12,color:'var(--tx-2)',display:'block',marginTop:2}}>{activeProvider.providerProfile.title}</span>}
            <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4,flexWrap:'wrap'}}>
              <span className="tag tag-green"><I n="lock" s={9}/>Megolm + AES-GCM</span>
              {activeProvider.providerProfile?.org_membership?.verified && <span className="tag tag-blue"><I n="shieldCheck" s={9}/>{activeProvider.providerProfile.org_membership.org_name}</span>}
              <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)'}}>{activeBridge}</span>
            </div>
          </div>
          <button onClick={()=>setHardRevokeTarget(activeProviderIdx)} className="b-red b-sm"><I n="zap" s={12}/>Hard Revoke</button>
        </div>
        {activeProvider.providerProfile?.org_membership?.verified && <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:28,height:28,borderRadius:'50%',background:'var(--bg-3)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--blue)',border:'2px solid var(--blue)'}}><I n="shieldCheck" s={14}/></div>
          <div style={{flex:1}}>
            <div style={{display:'flex',alignItems:'center',gap:6}}>
              <span style={{fontSize:12,fontWeight:700,color:'var(--blue)'}}>{activeProvider.providerProfile.org_membership.org_name}</span>
              {activeProvider.providerProfile.org_membership.email_verified ? <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>EMAIL VERIFIED</span>
              : <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>VERIFIED</span>}
            </div>
            <span style={{fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{activeProvider.providerProfile.org_membership.org_type ? (ORG_TYPE_LABELS[activeProvider.providerProfile.org_membership.org_type]||activeProvider.providerProfile.org_membership.org_type)+' · ':''}{activeProvider.providerProfile.org_membership.role}</span>
            {activeProvider.providerProfile.org_membership.verified_domain && <span style={{fontSize:9,color:'var(--green)',fontFamily:'var(--mono)',display:'block',marginTop:2}}>@{activeProvider.providerProfile.org_membership.verified_domain}</span>}
          </div>
          {activeProvider.providerProfile.credentials && <span style={{fontSize:9.5,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{activeProvider.providerProfile.credentials}</span>}
        </div>}
        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">CURRENTLY SHARED</span>
          <div style={{display:'flex',flexWrap:'wrap',gap:6,marginTop:4}}>
            {allFields.filter(f=>activeProvider.sharedFields?.[f.key]).map(f=><span key={f.key} className="tag tag-blue">{f.label}</span>)}
            {Object.values(activeProvider.sharedFields||{}).filter(Boolean).length===0&&<span style={{fontSize:12,color:'var(--tx-3)'}}>No fields shared</span>}
          </div>
        </div>
        <div className="card">
          <span className="section-label">BRIDGE MESSAGES</span>
          <div style={{maxHeight:280,overflow:'auto',marginBottom:12}}>
            {bridgeMessages.length===0?<p style={{color:'var(--tx-3)',fontSize:12,padding:'14px 0',textAlign:'center'}}>No messages yet</p>
            :bridgeMessages.map((msg,i)=><div key={msg.id||i} style={{padding:'8px 0',borderBottom:'1px solid var(--border-0)'}}>
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
                <span style={{fontFamily:'var(--mono)',fontSize:10,color:msg.sender===svc.userId?'var(--teal)':'var(--gold)'}}>{msg.sender===svc.userId?'You':msg.sender}</span>
                <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleString():''}</span></div>
              <p style={{fontSize:12.5,color:'var(--tx-1)'}}>{msg.content?.body}</p>
            </div>)}
          </div>
          <div style={{display:'flex',gap:6}}>
            <input value={msgText} onChange={e=>setMsgText(e.target.value)} placeholder="Message (E2EE)..." onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey)handleSendBridgeMsg()}} style={{flex:1}}/>
            <button onClick={handleSendBridgeMsg} className="b-pri"><I n="send" s={13}/></button>
          </div>
        </div>
      </div>}

      {/* ACTIVITY STREAM */}
      {view==='activity'&&!activeBridge&&<ActivityStream session={session}/>}
    </div>

    {/* EDIT VAULT MODAL */}
    <Modal open={editModal} onClose={()=>setEditModal(false)} title="Edit Vault Data" w={540}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>Changes to shared fields are re-encrypted with new keys per provider. Each edit emits EO operations (INS/ALT/NUL) to the vault timeline.</p>
      {allCategories.map(cat=>{const fields=allFields.filter(f=>f.category===cat);
        if(!fields.length) return null;
        return <div key={cat} style={{marginBottom:14}}>
        <span className="section-label">{(CAT_LABELS[cat]||cat.charAt(0).toUpperCase()+cat.slice(1)).toUpperCase()}</span>
        {fields.map(f=><div key={f.key} style={{marginBottom:8}}>
          <div style={{display:'flex',alignItems:'center',gap:4,marginBottom:3}}>
            <label style={{fontSize:11.5,color:'var(--tx-1)'}}>{f.label}</label>
            {f.sensitive&&<span className="tag tag-red" style={{fontSize:8}}>SENSITIVE</span>}
            {f.custom&&<span className="tag tag-purple" style={{fontSize:8}}>CUSTOM</span>}
            {f.framework&&<span className={`tag tag-${FRAMEWORK_BY_ID[f.framework]?.accent||'blue'}`} style={{fontSize:8}}>{f.frameworkName}</span>}</div>
          {['case_notes','history','medical','documents'].includes(f.key)||(f.custom&&f.category==='case')?
            <textarea value={editData[f.key]||''} onChange={e=>setEditData({...editData,[f.key]:e.target.value})} placeholder={`Enter ${f.label.toLowerCase()}...`} style={{minHeight:50}}/>:
            <input value={editData[f.key]||''} onChange={e=>setEditData({...editData,[f.key]:e.target.value})} placeholder={`Enter ${f.label.toLowerCase()}...`}/>}
        </div>)}
      </div>;})}
      <button onClick={handleEditSave} className="b-pri" style={{width:'100%'}}>Save & Re-encrypt Shared Fields</button>
    </Modal>

    {/* ADD PROVIDER MODAL */}
    <Modal open={addProviderModal} onClose={()=>setAddProviderModal(false)} title="Add Provider">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Creates a new encrypted bridge room and invites the provider. No data shared until you toggle fields on.</p>
      <div style={{marginBottom:14}}><span className="section-label">PROVIDER MATRIX ID</span>
        <input value={newProviderId} onChange={e=>setNewProviderId(e.target.value)} placeholder="@provider:matrix.org"/></div>
      <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14}}>
        <span style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.5}}>Bridge uses Megolm + per-field AES-256-GCM. Keys destroyed on revocation.</span>
      </div>
      <button onClick={handleAddProvider} className="b-pri" style={{width:'100%'}}>Create Bridge Room</button>
    </Modal>

    {/* OBSERVATION MODAL */}
    <Modal open={!!obsModal} onClose={()=>setObsModal(null)} title={obsModal?.question||'Record Observation'} w={500}>
      {obsModal&&<>
        <div style={{marginBottom:14}}><span className="section-label">DATE</span>
          <input type="date" value={obsDate} onChange={e=>setObsDate(e.target.value)}/></div>
        <div style={{marginBottom:14}}><span className="section-label">RESPONSE</span>
          <div style={{display:'flex',flexDirection:'column',gap:4}}>
            {obsModal.options.map(o=><div key={o.v} onClick={()=>setObsValue(o.v)}
              style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',border:`1px solid ${obsValue===o.v?'var(--teal)':'var(--border-1)'}`,
                background:obsValue===o.v?'var(--teal-dim)':'var(--bg-3)',transition:'all .15s'}}>
              <span style={{fontSize:12.5,color:obsValue===o.v?'var(--teal)':'var(--tx-1)'}}>{o.l}</span>
            </div>)}
          </div>
        </div>
        <div style={{marginBottom:14}}><span className="section-label">ADDITIONAL NOTES (OPTIONAL)</span>
          <textarea value={obsFreeText} onChange={e=>setObsFreeText(e.target.value)} placeholder="Any additional context..." style={{minHeight:50}}/></div>
        <div style={{background:'var(--teal-dim)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14,fontSize:11,color:'var(--teal)'}}>
          This observation will be recorded as a GIVEN event in your vault — immutable, append-only.
        </div>
        <button onClick={handleRecordObservation} className="b-pri" disabled={!obsValue} style={{width:'100%'}}>Record Observation</button>
      </>}
    </Modal>

    {/* HARD REVOKE CONFIRM */}
    <Modal open={hardRevokeTarget!==null} onClose={()=>setHardRevokeTarget(null)} title="Hard Revoke" w={440}>
      <div style={{background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginBottom:14}}>
        <p style={{fontSize:12.5,color:'var(--red)',fontWeight:600,marginBottom:4}}>Destructive operation</p>
        <p style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>Current bridge will be <strong>tombstoned</strong>, provider <strong>kicked</strong>. A new bridge with <strong>fresh encryption keys</strong> is created for any still-shared fields.</p>
      </div>
      <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:14,lineHeight:1.6}}>
        <strong>Caveat:</strong> If the provider previously decrypted and cached data, we cannot delete it from their device. This prevents future access, not retroactive erasure.
      </p>
      <div style={{display:'flex',gap:8}}>
        <button onClick={()=>setHardRevokeTarget(null)} className="b-gho" style={{flex:1}}>Cancel</button>
        <button onClick={()=>handleHardRevoke(hardRevokeTarget)} className="b-red" style={{flex:1}}><I n="zap" s={13}/>Execute</button>
      </div>
    </Modal>

    {/* ADD CUSTOM FIELD MODAL */}
    <Modal open={addFieldModal} onClose={()=>{setAddFieldModal(false);setNewFieldLabel('');setNewFieldCategory('details');setNewFieldSensitive(false)}} title="Add Custom Field" w={440}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>Create a new field to store any data you want in your vault. Custom fields work just like built-in fields — encrypted, shareable, and fully under your control.</p>
      <div style={{marginBottom:14}}><span className="section-label">FIELD NAME</span>
        <input value={newFieldLabel} onChange={e=>setNewFieldLabel(e.target.value)} placeholder="e.g. Emergency Contact, Preferred Language..." autoFocus
          onKeyDown={e=>{if(e.key==='Enter'&&newFieldLabel.trim())handleAddCustomField()}}/></div>
      <div style={{marginBottom:14}}><span className="section-label">CATEGORY</span>
        <select value={newFieldCategory} onChange={e=>setNewFieldCategory(e.target.value)} style={{width:'100%'}}>
          {FIELD_CATEGORIES.map(c=><option key={c} value={c}>{CAT_LABELS[c]}</option>)}
        </select></div>
      <div style={{marginBottom:14,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <div><span style={{fontSize:12,fontWeight:500}}>Sensitive field</span>
          <p style={{fontSize:10.5,color:'var(--tx-2)',marginTop:2}}>Sensitive fields are masked in the vault view</p></div>
        <Toggle on={newFieldSensitive} onChange={()=>setNewFieldSensitive(!newFieldSensitive)}/>
      </div>
      <div style={{background:'var(--purple-dim)',border:'1px solid rgba(167,139,250,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14}}>
        <span style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.5}}>Custom fields are encrypted with AES-256-GCM, stored in your vault, and can be selectively shared with providers — identical to built-in fields.</span>
      </div>
      <button onClick={handleAddCustomField} className="b-pri" disabled={!newFieldLabel.trim()} style={{width:'100%'}}>Create Field</button>
    </Modal>

    {/* FRAMEWORK TOGGLE MODAL */}
    <Modal open={frameworkModal} onClose={()=>setFrameworkModal(false)} title="Data Field Frameworks" w={640}>
      <FrameworkTogglePanel
        enabledFrameworks={enabledFrameworks}
        onToggle={async (next) => {
          setEnabledFrameworks(next);
          await saveSnapshot(undefined, undefined, undefined, undefined, next);
          const delta = next.length - enabledFrameworks.length;
          if (delta > 0) showToast(`Framework enabled — ${getFrameworkFields(next).length} total fields`, 'success');
          else if (delta < 0) showToast('Framework disabled', 'warn');
        }}
      />
    </Modal>
  </div>;
};

/* ═══════════════════ PROVIDER APP ═══════════════════ */
const ProviderApp = ({session, onLogout, showToast}) => {
  const [rosterRoom, setRosterRoom] = useState(null);
  const [metricsRoom, setMetricsRoom] = useState(null);
  const [schemaRoom, setSchemaRoom] = useState(null);
  const [networkRoom, setNetworkRoom] = useState(null);
  const [cases, setCases] = useState([]);
  const [metrics, setMetrics] = useState([]);
  const [networkMembers, setNetworkMembers] = useState([]);
  const [activeCase, setActiveCase] = useState(null);
  const [view, setView] = useState('dashboard'); // dashboard|inbox|case|metrics|schema|network|activity|staff|org-settings|org-inbox
  const [loading, setLoading] = useState(true);
  const [messages, setMessages] = useState([]);
  const [msgText, setMsgText] = useState('');
  const [requestText, setRequestText] = useState('');
  const [discoverModal, setDiscoverModal] = useState(false);
  const [discoverUserId, setDiscoverUserId] = useState('');
  const [networkModal, setNetworkModal] = useState(false);
  const [networkName, setNetworkName] = useState('');
  const [joinNetworkModal, setJoinNetworkModal] = useState(false);
  const [joinNetworkId, setJoinNetworkId] = useState('');
  const [provObsModal, setProvObsModal] = useState(null);
  const [provObsValue, setProvObsValue] = useState('');
  const [provObsNotes, setProvObsNotes] = useState('');
  const [provObservations, setProvObservations] = useState([]);
  const [initError, setInitError] = useState(null);
  // Organization context — orgs are a feature within the provider experience
  const [orgRoom, setOrgRoom] = useState(null);
  const [orgMeta, setOrgMeta] = useState({});
  const [staff, setStaff] = useState([]);
  const [orgRole, setOrgRole] = useState(null); // null = no org, 'admin', 'case_manager', etc.
  const [createOrgModal, setCreateOrgModal] = useState(false);
  const [joinOrgModal, setJoinOrgModal] = useState(false);
  const [joinOrgId, setJoinOrgId] = useState('');
  const [setupData, setSetupData] = useState({name:'',type:'direct_service',service_area:'',languages:'en'});
  const [inviteModal, setInviteModal] = useState(false);
  const [inviteUserId, setInviteUserId] = useState('');
  const [inviteRole, setInviteRole] = useState('case_manager');
  // Case assignments — tracks which staff are assigned to which bridges within the org
  const [caseAssignments, setCaseAssignments] = useState({}); // { [bridgeRoomId]: { primary, staff:[], client_name, transferable } }
  const [transferModal, setTransferModal] = useState(null); // case object to transfer
  const [transferTarget, setTransferTarget] = useState(''); // staff user ID to transfer to
  // Client records — provider-created rooms representing clients
  const [clientRecords, setClientRecords] = useState([]);
  const [createClientModal, setCreateClientModal] = useState(false);
  const [clientInviteModal, setClientInviteModal] = useState(null); // client record object or null
  const [newClientName, setNewClientName] = useState('');
  const [newClientMatrixId, setNewClientMatrixId] = useState('');
  const [newClientNotes, setNewClientNotes] = useState('');
  const [clientInviteMatrixId, setClientInviteMatrixId] = useState('');
  const [copiedField, setCopiedField] = useState(null);
  // Teams — flexible groups of people (not tied to a single org)
  const [teams, setTeams] = useState([]);
  const [createTeamModal, setCreateTeamModal] = useState(false);
  const [newTeamName, setNewTeamName] = useState('');
  const [newTeamDesc, setNewTeamDesc] = useState('');
  const [teamInviteModal, setTeamInviteModal] = useState(null); // team object or null
  const [teamInviteUserId, setTeamInviteUserId] = useState('');
  // Client data import
  const [importModal, setImportModal] = useState(false);
  // Provider profile — self-reported identity info
  const [providerProfile, setProviderProfile] = useState({});
  const [profileModal, setProfileModal] = useState(false);
  const [profileDraft, setProfileDraft] = useState({display_name:'',title:'',credentials:'',bio:'',service_types:''});
  // Email verification state
  const [emailVerifyConfig, setEmailVerifyConfig] = useState(EmailVerification.defaultConfig());
  const [emailVerifyModal, setEmailVerifyModal] = useState(false);
  const [verifyEmail, setVerifyEmail] = useState('');
  const [verifyCode, setVerifyCode] = useState('');
  const [verifyStep, setVerifyStep] = useState('email'); // 'email' | 'code' | 'done'
  const [verifyError, setVerifyError] = useState('');
  const [verifyPending, setVerifyPending] = useState(false);
  const [myVerification, setMyVerification] = useState(null); // current user's verification status
  const [emailConfigDraft, setEmailConfigDraft] = useState(EmailVerification.defaultConfig());
  const [emailConfigModal, setEmailConfigModal] = useState(false);
  // ─── Inter-org messaging & opacity ───
  const [orgOpacity, setOrgOpacity] = useState('translucent'); // transparent|translucent|opaque
  const [orgMsgAccess, setOrgMsgAccess] = useState({read:['admin','case_manager'],respond:['admin']});
  const [orgChannels, setOrgChannels] = useState([]); // [{roomId, peerOrg:{name,roomId}, lastMessage, unread}]
  const [activeChannel, setActiveChannel] = useState(null);
  const [channelMessages, setChannelMessages] = useState([]);
  const [orgMsgText, setOrgMsgText] = useState('');
  const [composeOrgModal, setComposeOrgModal] = useState(false);
  const [composePeerOrgId, setComposePeerOrgId] = useState('');
  const [composePeerOrgName, setComposePeerOrgName] = useState('');
  const [msgAccessModal, setMsgAccessModal] = useState(false);
  const [msgAccessDraft, setMsgAccessDraft] = useState({read:[],respond:[]});
  // ─── Org terminology customization ───
  const [orgTerminology, setOrgTerminology] = useState({...TERMINOLOGY_DEFAULTS});
  const [terminologyDraft, setTerminologyDraft] = useState({...TERMINOLOGY_DEFAULTS});
  const [terminologyModal, setTerminologyModal] = useState(false);
  // Convenience accessors for the active terminology
  const T = orgTerminology; // T.client_term, T.client_term_plural, T.provider_term, T.provider_term_plural
  // ─── Inbox chat state ───
  const [inboxConvo, setInboxConvo] = useState(null); // room ID of active inbox conversation
  const [inboxMessages, setInboxMessages] = useState([]);
  const [inboxMsgText, setInboxMsgText] = useState('');
  const [inboxTab, setInboxTab] = useState('cases'); // 'cases' | 'channels'
  // ─── Notifications state ───
  const [notifications, setNotifications] = useState([]);

  // Notification helpers
  const addNotification = (notif) => {
    setNotifications(prev => [{...notif, id: `notif_${Date.now()}_${Math.random().toString(36).slice(2,6)}`, read: false, timestamp: Date.now()}, ...prev].slice(0, 50));
  };
  const handleNotifClick = (notif) => {
    setNotifications(prev => prev.map(n => n.id === notif.id ? {...n, read: true} : n));
    // Navigate based on notification type
    if (notif.type === 'schema_update' || notif.type === 'schema_new') { setView('schema'); setActiveCase(null); }
    else if (notif.type === 'message' && notif.targetView) { setView(notif.targetView); setActiveCase(null); }
    else if (notif.type === 'org_event') { setView('org-settings'); setActiveCase(null); }
  };
  const handleDismissAllNotifs = () => { setNotifications(prev => prev.map(n => ({...n, read: true}))); };

  useEffect(() => { initProvider(); }, []);

  const rosterFrame = (room) => ({type:'roster',room:room||rosterRoom,role:'provider',epistemic:'MEANT'});
  const bridgeFrame = (room) => ({type:'bridge',room,role:'provider',epistemic:'MEANT'});
  const networkFrame = (room) => ({type:'network',room:room||networkRoom,role:'provider',epistemic:'MEANT'});
  const orgFrame = (room) => ({type:'org',room:room||orgRoom,role:orgRole||'admin',epistemic:'MEANT'});

  const initProvider = async () => {
    setLoading(true);
    setInitError(null);
    try {
      // Single-pass scan: fetch all Khora state across rooms in one request
      const scanned = await svc.scanRooms([EVT.ORG_METADATA, EVT.ORG_ROSTER, EVT.PROVIDER_PROFILE, EVT.ORG_OPACITY, EVT.ORG_MSG_ACCESS, EVT.ORG_MSG_CHANNEL, EVT.ORG_TERMINOLOGY, EVT.TEAM_META, EVT.TEAM_MEMBERS]);
      let roster=null, metricsR=null, schema=null, network=null;
      let detectedOrg=null, detectedOrgRole=null;
      const bridgeData = [];
      const detectedClientRecords = [];
      const detectedOrgChannels = [];
      const detectedTeams = [];
      for (const [rid, state] of Object.entries(scanned)) {
        const id = state[EVT.IDENTITY];
        if (id?.account_type==='provider'&&id.owner===svc.userId) roster=rid;
        if (id?.account_type==='metrics'&&id.owner===svc.userId) metricsR=rid;
        if (id?.account_type==='schema'&&id.owner===svc.userId) schema=rid;
        if (id?.account_type==='network') network=rid;
        // Detect client record rooms created by this provider (or claimed from this provider)
        if (id?.account_type==='client_record'&&(id.owner===svc.userId||id.previous_owner===svc.userId)) {
          detectedClientRecords.push({roomId:rid, ...id});
        }
        // Detect org rooms — owned or joined as staff
        if (id?.account_type==='organization') {
          if (id.owner===svc.userId) {
            detectedOrg=rid; detectedOrgRole='admin';
          } else {
            const orgRoster = state[EVT.ORG_ROSTER];
            const entry = orgRoster?.staff?.find(s=>s.userId===svc.userId);
            if (entry) { detectedOrg=rid; detectedOrgRole=entry.role; }
          }
        }
        // Detect inter-org messaging channels
        const chanMeta = state[EVT.ORG_MSG_CHANNEL];
        if (chanMeta && chanMeta.type === 'org_msg_channel') {
          detectedOrgChannels.push({roomId: rid, ...chanMeta});
        }
        // Detect team rooms
        if (id?.account_type==='team') {
          const teamMeta = state[EVT.TEAM_META] || {};
          const teamMembers = state[EVT.TEAM_MEMBERS] || {members:[]};
          detectedTeams.push({roomId:rid, ...teamMeta, members:teamMembers.members||[], owner:id.owner, created:id.created});
        }
        const meta = state[EVT.BRIDGE_META];
        if (meta && meta.status!=='tombstoned') {
          // Include bridges where this user is the provider OR any org staff member is assigned
          if (meta.provider===svc.userId) {
            bridgeData.push({rid, meta, refs: state[EVT.BRIDGE_REFS], mine: true});
          } else if (meta.assigned_staff?.includes(svc.userId)) {
            bridgeData.push({rid, meta, refs: state[EVT.BRIDGE_REFS], mine: true});
          }
        }
      }
      if (!roster) {
        roster = await svc.createRoom('[Khora Roster]','Provider case index',[
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'provider',owner:svc.userId,created:Date.now()}},
          {type:EVT.ROSTER_INDEX,state_key:'',content:{cases:[]}},
        ]);
      }
      if (!metricsR) {
        metricsR = await svc.createRoom('[Khora Metrics]','Anonymized metrics',[
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'metrics',owner:svc.userId,created:Date.now()}},
        ]);
      }
      if (!schema) {
        schema = await svc.createRoom('[Khora Schema]','Schema definitions',[
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'schema',owner:svc.userId,created:Date.now()}},
        ]);
        const allSeeds = [
          // Forms — GIVEN data collection instruments
          ...DEFAULT_FORMS.map(f => () => svc.setState(schema, EVT.SCHEMA_FORM, f, f.id)),
          ...DEFAULT_PROMPTS.map(p => () => svc.setState(schema, EVT.SCHEMA_PROMPT, p, p.key)),
          // Interpretations — MEANT assessments (provider instruments)
          ...DEFAULT_PROVIDER_PROMPTS.map(pp => () => svc.setState(schema, EVT.SCHEMA_ASSESSMENT, pp, pp.key)),
          // Interpretations — classification rules and authorities
          ...DEFAULT_DEFINITIONS.map(d => () => svc.setState(schema, EVT.SCHEMA_DEF, d, d.key)),
          ...DEFAULT_AUTHORITIES.map(a => () => svc.setState(schema, EVT.SCHEMA_AUTHORITY, a, a.id)),
          [() => svc.setState(schema, EVT.SCHEMA_TRANSFORM, {id:'transform_default',transforms:DEFAULT_TRANSFORMS}, 'default')],
        ].flat();
        for (let i = 0; i < allSeeds.length; i++) {
          await allSeeds[i]();
          if (i % 3 === 2) await new Promise(r => setTimeout(r, 200));
        }
      }
      setRosterRoom(roster); setMetricsRoom(metricsR); setSchemaRoom(schema);
      // Load provider profile from roster room
      const rosterState = scanned[roster];
      if (rosterState?.[EVT.PROVIDER_PROFILE]) setProviderProfile(rosterState[EVT.PROVIDER_PROFILE]);
      if (network) { setNetworkRoom(network); await loadNetworkMembers(network); }
      // Load org context if detected during scan
      if (detectedOrg) {
        setOrgRoom(detectedOrg); setOrgRole(detectedOrgRole);
        const orgState = scanned[detectedOrg];
        if (orgState?.[EVT.ORG_METADATA]) setOrgMeta(orgState[EVT.ORG_METADATA]);
        if (orgState?.[EVT.ORG_ROSTER]?.staff) setStaff(orgState[EVT.ORG_ROSTER].staff);
        // Load email verification config
        try {
          const evConfig = await svc.getState(detectedOrg, EVT.ORG_EMAIL_CONFIG).catch(()=>null);
          if (evConfig) { setEmailVerifyConfig(evConfig); setEmailConfigDraft(evConfig); }
          // Load my verification status from roster
          const myStaff = orgState?.[EVT.ORG_ROSTER]?.staff?.find(s=>s.userId===svc.userId);
          if (myStaff?.email_verification) setMyVerification(myStaff.email_verification);
        } catch(e) { console.warn('Email verify config load:', e.message); }
        // Load opacity & message access settings
        if (orgState?.[EVT.ORG_OPACITY]) setOrgOpacity(orgState[EVT.ORG_OPACITY].level || 'translucent');
        if (orgState?.[EVT.ORG_MSG_ACCESS]) setOrgMsgAccess(orgState[EVT.ORG_MSG_ACCESS]);
        // Load org terminology customization
        if (orgState?.[EVT.ORG_TERMINOLOGY]) {
          const t = {...TERMINOLOGY_DEFAULTS, ...orgState[EVT.ORG_TERMINOLOGY]};
          setOrgTerminology(t);
          setTerminologyDraft(t);
        }
        // Load detected org messaging channels
        if (detectedOrgChannels.length > 0) setOrgChannels(detectedOrgChannels);
        // Load case assignments from org room
        try {
          const assignments = await svc.getState(detectedOrg, EVT.ROSTER_ASSIGN);
          if (assignments?.assignments) setCaseAssignments(assignments.assignments);
        } catch(e) { console.warn('Assignment load:', e.message); }
      }
      // Load teams detected during scan
      if (detectedTeams.length > 0) setTeams(detectedTeams);
      // Load client records detected during scan
      if (detectedClientRecords.length > 0) {
        // Check room membership to determine status
        const enriched = [];
        for (const rec of detectedClientRecords) {
          let status = rec.status || 'created';
          // If the identity state already says 'claimed', respect that
          if (status === 'claimed') {
            enriched.push({ ...rec, status });
            continue;
          }
          if (rec.client_matrix_id && svc.client) {
            try {
              const members = await svc.getRoomMembers(rec.roomId);
              const clientMember = members.find(m => m.userId === rec.client_matrix_id);
              if (clientMember) status = 'joined';
              else if (status === 'created' && rec.client_matrix_id) status = 'invited';
            } catch {}
          }
          enriched.push({ ...rec, status });
        }
        setClientRecords(enriched);
      }
      // Process bridge data collected during scan (no second pass needed)
      await loadCasesFromScan(bridgeData, metricsR);
      await loadMetrics(metricsR);
      // Auto-register bridges in org assignments if needed
      if (detectedOrg && bridgeData.length > 0) {
        const currentAssignments = {};
        try {
          const a = await svc.getState(detectedOrg, EVT.ROSTER_ASSIGN);
          if (a?.assignments) Object.assign(currentAssignments, a.assignments);
        } catch {}
        const casesForSync = bridgeData.map(({rid, meta, refs}) => ({
          bridgeRoomId: rid, meta,
          sharedData: {}, clientUserId: meta.client,
          transferable: meta.transferable !== false,
          assigned_staff: meta.assigned_staff || [meta.provider],
        }));
        await syncAssignments(detectedOrg, casesForSync, currentAssignments);
      }
    } catch (e) {
      console.error('Provider init failed:', e);
      setInitError(e.message || 'Failed to initialize provider workspace.');
    }
    setLoading(false);
  };

  const loadCasesFromScan = async (bridgeData, mRoom) => {
    const found = [];
    for (const {rid, meta, refs} of bridgeData) {
      const decrypted = {};
      if (refs?.fields) {
        for (const [key,ref] of Object.entries(refs.fields)) {
          try {
            if (ref.key&&ref.ciphertext&&ref.iv) {
              const plain = await FieldCrypto.decrypt(ref.ciphertext, ref.iv, ref.key);
              if (plain!==null) decrypted[key]=plain;
            }
          } catch { /* skip undecryptable field */ }
        }
      }
      // Backfill org_id on bridge meta if provider has an org and bridge doesn't have one yet
      if (orgRoom && !meta.org_id && meta.provider === svc.userId) {
        try { await svc.setState(rid, EVT.BRIDGE_META, {...meta, org_id: orgRoom}); meta.org_id = orgRoom; } catch {}
      }
      found.push({
        bridgeRoomId:rid, clientUserId:meta.client, meta, sharedData:decrypted,
        metricsRoom:mRoom||metricsRoom,
        transferable: meta.transferable !== false,
        org_id: meta.org_id || null,
        assigned_staff: meta.assigned_staff || [meta.provider],
      });
    }
    setCases(found);
  };

  const loadCases = async () => {
    const scanned = await svc.scanRooms();
    const bridgeData = [];
    for (const [rid, state] of Object.entries(scanned)) {
      const meta = state[EVT.BRIDGE_META];
      if (meta && meta.status!=='tombstoned') {
        if (meta.provider===svc.userId || meta.assigned_staff?.includes(svc.userId)) {
          bridgeData.push({rid, meta, refs: state[EVT.BRIDGE_REFS]});
        }
      }
    }
    await loadCasesFromScan(bridgeData);
  };

  // Auto-register cases in org ROSTER_ASSIGN when they aren't tracked yet
  const syncAssignments = async (orgRoomId, currentCases, currentAssignments) => {
    if (!orgRoomId) return;
    let updated = false;
    const assignments = {...currentAssignments};
    for (const c of currentCases) {
      if (!assignments[c.bridgeRoomId]) {
        assignments[c.bridgeRoomId] = {
          primary: c.meta.provider,
          staff: c.assigned_staff || [c.meta.provider],
          client_name: c.sharedData.full_name || c.clientUserId,
          transferable: c.transferable,
          added: Date.now(),
        };
        updated = true;
      }
    }
    if (updated) {
      try {
        await svc.setState(orgRoomId, EVT.ROSTER_ASSIGN, {assignments});
        setCaseAssignments(assignments);
      } catch(e) { console.warn('Assignment sync failed:', e.message); }
    }
  };

  const loadMetrics = async (mRoom) => {
    if (!svc.client || !mRoom) return;
    const room = svc.client.getRoom(mRoom);
    if (!room) return;
    const evts = room.getLiveTimeline().getEvents().filter(e=>e.getType()===EVT.METRIC).map(e=>e.getContent());
    setMetrics(evts);
  };

  const loadNetworkMembers = async (nRoom) => {
    const members = await svc.getState(nRoom, EVT.NET_MEMBERS);
    setNetworkMembers(members?.organizations || []);
  };

  const loadMessages = async (bid) => { setMessages(await svc.getMessages(bid)); };

  const handleSendMsg = async () => {
    if (!msgText.trim()||!activeCase) return;
    await svc.sendMessage(activeCase, msgText, {[`${NS}.type`]:'note'});
    await emitOp(activeCase, 'INS', {type:'provider_note',field:'message'}, {body:msgText}, bridgeFrame(activeCase));
    setMsgText(''); setTimeout(()=>loadMessages(activeCase),500);
  };

  const handleSendRequest = async () => {
    if (!requestText.trim()||!activeCase) return;
    await svc.sendMessage(activeCase, `Information Request: ${requestText}`, {[`${NS}.type`]:'request'});
    await emitOp(activeCase, 'DES', {type:'information_request',entity:'case'}, {request:requestText}, bridgeFrame(activeCase));
    setRequestText(''); showToast('Request sent to client','success'); setTimeout(()=>loadMessages(activeCase),500);
  };

  // Record structured provider observation in bridge room (MEANT frame)
  const handleProviderObservation = async () => {
    if (!provObsValue || !provObsModal || !activeCase) return;
    const obs = {
      id:genOpId(), prompt_id:provObsModal.id, prompt_key:provObsModal.key,
      value:provObsValue, notes:provObsNotes||undefined,
      schema_version:provObsModal.version||1,
      author:svc.userId, ts:Date.now()
    };
    await svc.sendEvent(activeCase, EVT.OBSERVATION, obs);
    await emitOp(activeCase, 'INS',
      {type:'provider_observation',field:provObsModal.key,value:provObsValue},
      {prompt:provObsModal.question,notes:provObsNotes||undefined,
       epistemic_crossing:provObsModal.category==='assessment'?'GIVEN → MEANT':undefined},
      bridgeFrame(activeCase));
    setProvObservations(prev=>[...prev,obs]);
    setProvObsModal(null); setProvObsValue(''); setProvObsNotes('');
    showToast(`Observation recorded: ${provObsModal.question}`,'success');
  };

  // Load provider observations from bridge
  const loadProviderObservations = async (bid) => {
    if (!svc.client) return;
    const room = svc.client.getRoom(bid);
    if (!room) return;
    const obs = room.getLiveTimeline().getEvents()
      .filter(e=>e.getType()===EVT.OBSERVATION)
      .map(e=>e.getContent());
    setProvObservations(obs);
  };

  // ─── Case transfer between providers within org ───
  const handleTransferCase = async () => {
    if (!transferModal || !transferTarget.trim() || !orgRoom) return;
    const c = transferModal;
    // Check if client has allowed transfers
    if (!c.transferable) {
      showToast(`Transfer blocked — ${T.client_term.toLowerCase()} has disabled provider transfers for this bridge`, 'error');
      return;
    }
    // Don't transfer to the same provider
    if (transferTarget === c.meta.provider) {
      showToast('Case is already assigned to this provider', 'warn');
      return;
    }
    // Verify target is org staff
    const targetStaff = staff.find(s => s.userId === transferTarget);
    if (!targetStaff) {
      showToast('Target must be a member of your organization', 'error');
      return;
    }
    try {
      // Step 1: Invite new provider to the bridge room
      try {
        await svc.invite(c.bridgeRoomId, transferTarget);
      } catch(e) {
        // May fail if already a member or if we lack permissions
        console.warn('Invite during transfer:', e.message);
      }
      // Step 2: Update bridge meta — set new provider, update assigned_staff
      const updatedStaff = [...new Set([...(c.assigned_staff||[]), transferTarget])];
      try {
        const currentMeta = await svc.getState(c.bridgeRoomId, EVT.BRIDGE_META);
        await svc.setState(c.bridgeRoomId, EVT.BRIDGE_META, {
          ...currentMeta,
          provider: transferTarget,
          assigned_staff: updatedStaff,
          transferred_from: c.meta.provider,
          transferred_at: Date.now(),
          transferred_by: svc.userId,
        });
      } catch(e) {
        // Provider may not have state permission — update org assignment instead
        console.warn('Bridge meta update:', e.message);
      }
      // Step 3: Update ROSTER_ASSIGN in org room
      const updatedAssignments = {...caseAssignments};
      updatedAssignments[c.bridgeRoomId] = {
        primary: transferTarget,
        staff: updatedStaff,
        client_name: c.sharedData?.full_name || c.clientUserId,
        transferable: c.transferable,
        transferred_from: c.meta.provider,
        transferred_at: Date.now(),
        transferred_by: svc.userId,
        added: caseAssignments[c.bridgeRoomId]?.added || Date.now(),
      };
      await svc.setState(orgRoom, EVT.ROSTER_ASSIGN, {assignments: updatedAssignments});
      setCaseAssignments(updatedAssignments);
      // Step 4: Emit EO operation
      await emitOp(orgRoom, 'ALT', {
        entity:'case_assignment', field:'provider',
        from: c.meta.provider, to: transferTarget,
      }, {
        bridge_room: c.bridgeRoomId,
        client: c.clientUserId,
        reason: 'org_transfer',
        initiated_by: svc.userId,
      }, orgFrame());
      setTransferModal(null);
      setTransferTarget('');
      showToast(`Case transferred to ${targetStaff.userId}`, 'success');
      // Refresh cases
      await loadCases();
    } catch(e) { showToast('Transfer failed: ' + e.message, 'error'); }
  };

  // ─── Client record management ───
  const handleCreateClientRecord = async () => {
    if (!newClientName.trim()) return;
    try {
      const clientId = newClientMatrixId.trim() || null;
      const roomId = await svc.createClientRoom(
        `[Client] ${newClientName}`,
        `${T.client_term} record for ${newClientName}`,
        [
          { type: EVT.IDENTITY, state_key: '', content: {
            account_type: 'client_record', owner: svc.userId, created: Date.now(),
            client_name: newClientName, client_matrix_id: clientId,
            notes: newClientNotes || undefined, status: 'created',
          }},
        ],
        clientId
      );
      // If client Matrix ID provided, invite them and set them as admin
      if (clientId) {
        try {
          await svc.invite(roomId, clientId);
          await svc.setState(roomId, EVT.IDENTITY, {
            account_type: 'client_record', owner: svc.userId, created: Date.now(),
            client_name: newClientName, client_matrix_id: clientId,
            notes: newClientNotes || undefined, status: 'invited',
          });
        } catch (e) { console.warn('Invite failed:', e.message); }
      }
      const newRecord = {
        roomId, client_name: newClientName, client_matrix_id: clientId,
        notes: newClientNotes || undefined, owner: svc.userId,
        created: Date.now(), status: clientId ? 'invited' : 'created',
      };
      setClientRecords(prev => [...prev, newRecord]);
      setCreateClientModal(false);
      setNewClientName(''); setNewClientMatrixId(''); setNewClientNotes('');
      showToast(`${T.client_term} "${newClientName}" created${clientId ? ' — invite sent' : ''}`,'success');
    } catch (e) { showToast('Failed: ' + e.message, 'error'); }
  };

  const handleClientInvite = async () => {
    if (!clientInviteModal || !clientInviteMatrixId.trim()) return;
    try {
      const clientId = clientInviteMatrixId.trim();
      // Set power levels: client gets PL 100 (superadmin), provider stays at 50
      await svc.setPowerLevel(clientInviteModal.roomId, clientId, 100);
      await svc.setPowerLevel(clientInviteModal.roomId, svc.userId, 50);
      // Invite the client
      await svc.invite(clientInviteModal.roomId, clientId);
      // Update identity state with the client's Matrix ID
      await svc.setState(clientInviteModal.roomId, EVT.IDENTITY, {
        ...clientInviteModal, client_matrix_id: clientId, status: 'invited',
      });
      setClientRecords(prev => prev.map(r =>
        r.roomId === clientInviteModal.roomId
          ? { ...r, client_matrix_id: clientId, status: 'invited' }
          : r
      ));
      showToast(`Invite sent to ${clientId} — they will have full room control`, 'success');
    } catch (e) { showToast('Invite failed: ' + e.message, 'error'); }
  };

  // ─── Team CRUD ───
  const handleCreateTeam = async () => {
    if (!newTeamName.trim()) return;
    try {
      const roomId = await svc.createRoom(`[Khora Team] ${newTeamName}`, newTeamDesc || `Team: ${newTeamName}`, [
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'team',owner:svc.userId,created:Date.now()}},
        {type:EVT.TEAM_META,state_key:'',content:{
          name:newTeamName, description:newTeamDesc||'', created:Date.now(), created_by:svc.userId,
          org_id:orgRoom||null, org_name:orgMeta.name||null,
        }},
        {type:EVT.TEAM_MEMBERS,state_key:'',content:{members:[
          {userId:svc.userId,role:'lead',joined:Date.now(),display_name:providerProfile.display_name||''}
        ]}},
      ]);
      const newTeam = {
        roomId, name:newTeamName, description:newTeamDesc||'', created:Date.now(),
        created_by:svc.userId, org_id:orgRoom||null, org_name:orgMeta.name||null,
        members:[{userId:svc.userId,role:'lead',joined:Date.now(),display_name:providerProfile.display_name||''}],
        owner:svc.userId,
      };
      setTeams(prev => [...prev, newTeam]);
      setCreateTeamModal(false);
      setNewTeamName(''); setNewTeamDesc('');
      showToast(`Team "${newTeamName}" created`,'success');
    } catch(e) { showToast('Failed to create team: '+e.message,'error'); }
  };

  const handleTeamInvite = async () => {
    if (!teamInviteModal || !teamInviteUserId.trim()) return;
    try {
      const uid = teamInviteUserId.trim();
      // Invite user to the team room
      if (svc.client) await svc.client.invite(teamInviteModal.roomId, uid);
      else await svc._api('POST', `/rooms/${encodeURIComponent(teamInviteModal.roomId)}/invite`, {user_id:uid});
      // Update the members list
      const updatedMembers = [...(teamInviteModal.members||[]), {userId:uid,role:'member',joined:Date.now()}];
      await svc.setState(teamInviteModal.roomId, EVT.TEAM_MEMBERS, {members:updatedMembers});
      setTeams(prev => prev.map(t => t.roomId===teamInviteModal.roomId ? {...t, members:updatedMembers} : t));
      showToast(`Invited ${uid} to team`,'success');
      setTeamInviteUserId('');
    } catch(e) { showToast('Team invite failed: '+e.message,'error'); }
  };

  const copyToClipboard = async (text, label) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedField(label);
      setTimeout(() => setCopiedField(null), 2000);
    } catch { showToast('Copy failed — please select and copy manually', 'warn'); }
  };

  // ─── Import completion handler ───
  const handleImportComplete = (importResults) => {
    const newRecords = importResults.created.map(r => ({
      roomId: r.roomId, client_name: r.displayName, client_matrix_id: null,
      notes: `Imported (${r.fieldCount} encrypted fields)`,
      owner: svc.userId, created: Date.now(), status: 'created', imported: true,
    }));
    setClientRecords(prev => [...prev, ...newRecords]);
  };

  const getInviteUrl = (roomId) => `https://matrix.to/#/${roomId}`;

  const getSetupInstructions = (roomId) => {
    const hs = svc._baseUrl ? svc._baseUrl.replace(/^https?:\/\//, '') : 'matrix.org';
    const link = getInviteUrl(roomId);
    return `You've been invited to securely manage your information on Khora.\n\nTo get started:\n\n1. Create a free Matrix account:\n   Go to https://${hs} and click "Create Account"\n   (Matrix is a secure, decentralized messaging protocol — your data stays on the server you choose)\n\n2. Download a Matrix client (optional):\n   Web: https://app.element.io\n   Mobile: Search "Element" in your app store\n   Or use any Matrix-compatible app\n\n3. Sign in with your new account\n\n4. Click this link to join your room:\n   ${link}\n\n5. You will have full control of this room — you can remove anyone from it at any time.\n\nQuestions? Contact your provider for help getting set up.`;
  };

  // Discover client by Matrix ID
  const handleDiscoverClient = async () => {
    if (!discoverUserId.trim()) return;
    try {
      // Check if we already have a bridge with this client
      const existing = cases.find(c=>c.clientUserId===discoverUserId);
      if (existing) { showToast('Already connected with this client','info'); setDiscoverModal(false); return; }
      // We can't create the bridge — the client must initiate. But we can check if one exists.
      const scanned = await svc.scanRooms();
      let found = false;
      for (const [rid, state] of Object.entries(scanned)) {
        const meta = state[EVT.BRIDGE_META];
        if (meta && meta.client===discoverUserId && meta.provider===svc.userId) { found=true; break; }
      }
      if (found) {
        await loadCases(); showToast('Bridge found — refreshing cases','success');
      } else {
        showToast(`No bridge found for ${discoverUserId}. The client must create a bridge and invite you.`,'warn');
      }
      setDiscoverModal(false);
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // Create a network — requires an org
  const handleCreateNetwork = async () => {
    if (!networkName.trim()) return;
    if (!orgRoom) { showToast('Create or join an organization before creating a network','warn'); return; }
    try {
      const nRoom = await svc.createRoom(`[Khora Network] ${networkName}`, 'Network governance room', [
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'network',name:networkName,owner:svc.userId,created:Date.now()}},
        {type:EVT.NET_MEMBERS,state_key:'',content:{organizations:[{id:orgRoom,name:orgMeta.name||'',joined:Date.now(),role:'admin'}],
          governance:{schema_changes_require:'admin_approval',admins:[orgRoom]}}},
      ]);
      // Seed network schema — forms propagate to member orgs, then to clients through providers
      // Forms (GIVEN data collection) — propagate as standard (orgs can extend)
      for (const f of DEFAULT_FORMS) await svc.setState(nRoom, EVT.SCHEMA_FORM, {...f, propagation:f.source?.propagation||'standard', network:networkName}, `net:${f.id}`);
      for (const p of DEFAULT_PROMPTS) await svc.setState(nRoom, EVT.SCHEMA_PROMPT, {...p, propagation:p.source?.propagation||'standard', network:networkName}, `net:${p.key}`);
      // Interpretations — assessments propagate alongside forms
      for (const pp of DEFAULT_PROVIDER_PROMPTS) await svc.setState(nRoom, EVT.SCHEMA_ASSESSMENT, {...pp, propagation:pp.source?.propagation||'standard', network:networkName}, `net:${pp.key}`);
      // Definitions propagate as required (immutable at org level)
      for (const d of DEFAULT_DEFINITIONS) await svc.setState(nRoom, EVT.SCHEMA_DEF, {...d, propagation:'required', network:networkName}, `net:${d.key}`);
      await emitOp(nRoom, 'INS', {entity:'network',field:networkName}, {created_by:svc.userId,org:orgMeta.name}, networkFrame(nRoom));
      setNetworkRoom(nRoom);
      await loadNetworkMembers(nRoom);
      setNetworkModal(false); setNetworkName('');
      showToast(`Network "${networkName}" created`,'success');
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // Join existing network by room ID — requires an org
  const handleJoinNetwork = async () => {
    if (!joinNetworkId.trim()) return;
    if (!orgRoom) { showToast('Create or join an organization before joining a network','warn'); return; }
    try {
      if (svc.client) { await svc.client.joinRoom(joinNetworkId); }
      else { await svc._api('POST', `/join/${encodeURIComponent(joinNetworkId)}`, {}); }
      setNetworkRoom(joinNetworkId);
      await loadNetworkMembers(joinNetworkId);
      setJoinNetworkModal(false); setJoinNetworkId('');
      showToast('Joined network','success');
    } catch(e) { showToast('Failed to join: '+e.message,'error'); }
  };

  // ─── Organization management ───
  const handleCreateOrg = async () => {
    if (!setupData.name.trim()) return;
    try {
      const org = await svc.createRoom(`[Khora Org] ${setupData.name}`, `Organization: ${setupData.name}`, [
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'organization',owner:svc.userId,created:Date.now()}},
        {type:EVT.ORG_METADATA,state_key:'',content:{
          name:setupData.name, type:setupData.type, service_area:setupData.service_area,
          languages:setupData.languages.split(',').map(s=>s.trim()), created:Date.now()}},
        {type:EVT.ORG_ROSTER,state_key:'',content:{staff:[
          {userId:svc.userId,role:'admin',joined:Date.now()}
        ]}},
        {type:EVT.ROSTER_ASSIGN,state_key:'',content:{}},
        {type:EVT.ORG_OPACITY,state_key:'',content:{level:'translucent',updated:Date.now(),updated_by:svc.userId}},
        {type:EVT.ORG_MSG_ACCESS,state_key:'',content:{read:['admin','case_manager'],respond:['admin'],updated:Date.now()}},
      ]);
      await emitOp(org, 'DES', {entity:'organization',designation:setupData.name},
        {type:setupData.type,service_area:setupData.service_area}, orgFrame(org));
      await emitOp(org, 'INS', {entity:'staff',field:svc.userId},
        {role:'admin',initiated_by:'org_creation'}, orgFrame(org));
      setOrgRoom(org); setOrgRole('admin');
      setOrgMeta({name:setupData.name,type:setupData.type,service_area:setupData.service_area});
      setStaff([{userId:svc.userId,role:'admin',joined:Date.now()}]);
      setCreateOrgModal(false);
      setSetupData({name:'',type:'direct_service',service_area:'',languages:'en'});
      showToast(`Organization "${setupData.name}" created`,'success');
      // Create supporting rooms for org
      const orgMetricsR = await svc.createRoom('[Khora Metrics]','Org anonymized metrics',[
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'metrics',owner:svc.userId,created:Date.now()}},
      ]);
      const orgSchema = await svc.createRoom('[Khora Schema]','Org schema definitions',[
        {type:EVT.IDENTITY,state_key:'',content:{account_type:'schema',owner:svc.userId,created:Date.now()}},
      ]);
      // Forms — GIVEN data collection (propagated to clients through providers)
      for (const f of DEFAULT_FORMS) await svc.setState(orgSchema, EVT.SCHEMA_FORM, f, f.id);
      for (const p of DEFAULT_PROMPTS) await svc.setState(orgSchema, EVT.SCHEMA_PROMPT, p, p.key);
      // Interpretations — MEANT assessments, definitions, authorities
      for (const pp of DEFAULT_PROVIDER_PROMPTS) await svc.setState(orgSchema, EVT.SCHEMA_ASSESSMENT, pp, pp.key);
      for (const d of DEFAULT_DEFINITIONS) await svc.setState(orgSchema, EVT.SCHEMA_DEF, d, d.key);
      for (const a of DEFAULT_AUTHORITIES) await svc.setState(orgSchema, EVT.SCHEMA_AUTHORITY, a, a.id);
      await svc.setState(orgSchema, EVT.SCHEMA_TRANSFORM, {id:'transform_default',transforms:DEFAULT_TRANSFORMS}, 'default');
    } catch(e) { showToast('Error creating org: '+e.message,'error'); }
  };

  const handleJoinOrg = async () => {
    if (!joinOrgId.trim()) return;
    try {
      if (svc.client) { await svc.client.joinRoom(joinOrgId); }
      else { await svc._api('POST', `/join/${encodeURIComponent(joinOrgId)}`, {}); }
      // Load the org metadata
      const meta = await svc.getState(joinOrgId, EVT.ORG_METADATA);
      const roster = await svc.getState(joinOrgId, EVT.ORG_ROSTER);
      const entry = roster?.staff?.find(s=>s.userId===svc.userId);
      setOrgRoom(joinOrgId); setOrgRole(entry?.role||'read_only');
      if (meta) setOrgMeta(meta);
      if (roster?.staff) setStaff(roster.staff);
      setJoinOrgModal(false); setJoinOrgId('');
      showToast(`Joined organization${meta?.name?' "'+meta.name+'"':''}`,'success');
    } catch(e) { showToast('Failed to join org: '+e.message,'error'); }
  };

  const handleInviteStaff = async () => {
    if (!inviteUserId.trim()||!orgRoom) return;
    try {
      await svc.invite(orgRoom, inviteUserId);
      const newStaff = [...staff, {userId:inviteUserId,role:inviteRole,joined:Date.now()}];
      await svc.setState(orgRoom, EVT.ORG_ROSTER, {staff:newStaff});
      await emitOp(orgRoom, 'CON', {source:orgRoom,destination:inviteUserId,relationship:'staff'},
        {role:inviteRole,invited_by:svc.userId}, orgFrame());
      setStaff(newStaff);
      setInviteModal(false); setInviteUserId('');
      showToast(`Invited ${inviteUserId} as ${ORG_ROLE_LABELS[inviteRole]}`,'success');
    } catch(e) { showToast('Invite failed: '+e.message,'error'); }
  };

  const handleRemoveStaff = async (userId) => {
    if (userId===svc.userId) { showToast('Cannot remove yourself','error'); return; }
    try {
      await svc.kick(orgRoom, userId, 'Removed from organization');
      const newStaff = staff.filter(s=>s.userId!==userId);
      await svc.setState(orgRoom, EVT.ORG_ROSTER, {staff:newStaff});
      await emitOp(orgRoom, 'NUL', {entity:'staff',field:userId},
        {reason:'removed',removed_by:svc.userId}, orgFrame());
      setStaff(newStaff);
      showToast(`Removed ${userId}`,'warn');
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // ─── Email verification management ───
  const handleSaveEmailVerifyConfig = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const config = {
        enabled: emailConfigDraft.enabled,
        required_domains: emailConfigDraft.required_domains.filter(d => d.trim()),
        require_for_roles: emailConfigDraft.require_for_roles,
        grace_period_hours: emailConfigDraft.grace_period_hours || 72,
      };
      await svc.setState(orgRoom, EVT.ORG_EMAIL_CONFIG, config);
      setEmailVerifyConfig(config);
      await emitOp(orgRoom, 'ALT', {entity:'email_verification_config', field:'enabled', value:config.enabled},
        {domains:config.required_domains, roles:config.require_for_roles}, orgFrame());
      setEmailConfigModal(false);
      showToast(`Email verification ${config.enabled ? 'enabled' : 'disabled'}`, 'success');
    } catch(e) { showToast('Error saving config: '+e.message, 'error'); }
  };

  const handleStartEmailVerify = async () => {
    if (!verifyEmail.trim() || !orgRoom) return;
    setVerifyError('');
    if (!EmailVerification.isValidEmail(verifyEmail)) {
      setVerifyError('Please enter a valid email address');
      return;
    }
    if (emailVerifyConfig.required_domains?.length > 0 && !EmailVerification.domainMatches(verifyEmail, emailVerifyConfig.required_domains)) {
      setVerifyError(`Email must be from: ${emailVerifyConfig.required_domains.join(', ')}`);
      return;
    }
    setVerifyPending(true);
    try {
      const { challenge, plainCode } = await EmailVerification.createChallenge(svc.userId, verifyEmail);
      // Store challenge in org room state (hashed code only)
      await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, challenge, svc.userId);
      // Attempt to deliver via webhook; fall back to Matrix DM display
      const sent = await EmailVerification.sendCodeViaWebhook(verifyEmail, plainCode, orgMeta.name || 'Organization');
      if (!sent) {
        // Fallback: show code in-app for development/demo (in production, email infra handles this)
        showToast(`Verification code: ${plainCode} (demo mode — production sends via email)`, 'info', 12000);
      } else {
        showToast('Verification code sent to ' + verifyEmail, 'success');
      }
      await emitOp(orgRoom, 'INS', {entity:'email_verification', field:svc.userId},
        {email_domain:EmailVerification.extractDomain(verifyEmail), status:'pending'}, orgFrame());
      setVerifyStep('code');
    } catch(e) { setVerifyError('Failed to start verification: ' + e.message); }
    setVerifyPending(false);
  };

  const handleSubmitVerifyCode = async () => {
    if (!verifyCode.trim() || verifyCode.length !== 6 || !orgRoom) return;
    setVerifyError('');
    setVerifyPending(true);
    try {
      // Fetch the stored challenge
      const challenge = await svc.getState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, svc.userId);
      const result = await EmailVerification.validateChallenge(challenge, verifyCode);
      if (!result.valid) {
        // Update attempt count
        if (result.reason === 'incorrect_code') {
          const updated = { ...challenge, attempts: (challenge.attempts || 0) + 1 };
          await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, updated, svc.userId);
          setVerifyError(`Incorrect code (${updated.attempts}/${challenge.max_attempts} attempts)`);
        } else if (result.reason === 'expired') {
          setVerifyError('Code expired. Please request a new one.');
          setVerifyStep('email');
        } else if (result.reason === 'max_attempts') {
          setVerifyError('Too many attempts. Please request a new code.');
          setVerifyStep('email');
        } else {
          setVerifyError('Verification failed. Please try again.');
        }
        setVerifyPending(false);
        return;
      }
      // Success — update roster with verified status
      const verifiedEntry = {
        status: 'verified',
        email: verifyEmail.trim().toLowerCase(),
        domain: EmailVerification.extractDomain(verifyEmail),
        verified_at: Date.now(),
      };
      const newStaff = staff.map(s =>
        s.userId === svc.userId ? { ...s, email_verification: verifiedEntry } : s
      );
      await svc.setState(orgRoom, EVT.ORG_ROSTER, { staff: newStaff });
      // Clear the challenge
      await svc.setState(orgRoom, EVT.ORG_VERIFY_CHALLENGE, { status: 'completed', verified_at: Date.now() }, svc.userId);
      await emitOp(orgRoom, 'ALT', {entity:'email_verification', field:svc.userId, value:'verified'},
        {email_domain:EmailVerification.extractDomain(verifyEmail), verified_at:Date.now()}, orgFrame());
      setStaff(newStaff);
      setMyVerification(verifiedEntry);
      setVerifyStep('done');
      showToast('Email verified successfully', 'success');
    } catch(e) { setVerifyError('Verification error: ' + e.message); }
    setVerifyPending(false);
  };

  const handleRevokeVerification = async (userId) => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const newStaff = staff.map(s =>
        s.userId === userId ? { ...s, email_verification: { status: 'revoked', revoked_at: Date.now(), revoked_by: svc.userId } } : s
      );
      await svc.setState(orgRoom, EVT.ORG_ROSTER, { staff: newStaff });
      await emitOp(orgRoom, 'NUL', {entity:'email_verification', field:userId},
        {reason:'admin_revoked', revoked_by:svc.userId}, orgFrame());
      setStaff(newStaff);
      if (userId === svc.userId) setMyVerification({ status: 'revoked' });
      showToast(`Revoked verification for ${userId}`, 'warn');
    } catch(e) { showToast('Error revoking: '+e.message, 'error'); }
  };

  const openEmailVerifyModal = () => {
    setVerifyEmail('');
    setVerifyCode('');
    setVerifyStep('email');
    setVerifyError('');
    setVerifyPending(false);
    setEmailVerifyModal(true);
  };

  // ─── Provider profile management ───
  const handleSaveProfile = async () => {
    if (!rosterRoom) return;
    try {
      const profile = {
        display_name: profileDraft.display_name.trim(),
        title: profileDraft.title.trim(),
        credentials: profileDraft.credentials.trim(),
        bio: profileDraft.bio.trim(),
        service_types: profileDraft.service_types.trim(),
        org_membership: orgRoom ? {
          org_room_id: orgRoom,
          org_name: orgMeta.name || '',
          org_type: orgMeta.type || '',
          role: orgRole || '',
          verified: myVerification?.status === 'verified' || !emailVerifyConfig.enabled,
          email_verified: myVerification?.status === 'verified',
          verified_email: myVerification?.status === 'verified' ? myVerification.email : null,
          verified_domain: myVerification?.status === 'verified' ? myVerification.domain : null,
        } : null,
        updated: Date.now(),
      };
      await svc.setState(rosterRoom, EVT.PROVIDER_PROFILE, profile);
      setProviderProfile(profile);
      // Broadcast profile to all bridge rooms so clients can see provider identity
      for (const c of cases) {
        try {
          await svc.setState(c.bridgeRoomId, EVT.PROVIDER_PROFILE, profile);
        } catch (e) { console.warn('Profile broadcast failed for bridge', c.bridgeRoomId, e.message); }
      }
      setProfileModal(false);
      showToast('Profile updated — broadcast to all bridges', 'success');
    } catch (e) { showToast('Failed to save profile: ' + e.message, 'error'); }
  };

  const openProfileModal = () => {
    setProfileDraft({
      display_name: providerProfile.display_name || '',
      title: providerProfile.title || '',
      credentials: providerProfile.credentials || '',
      bio: providerProfile.bio || '',
      service_types: providerProfile.service_types || '',
    });
    setProfileModal(true);
  };

  // ─── Inter-org messaging ───

  // Check if current user has permission for an org messaging action
  const hasOrgMsgPermission = useCallback((action) => {
    // action: 'read' or 'respond'
    if (!orgRole) return false;
    const allowed = orgMsgAccess[action] || [];
    return allowed.includes(orgRole);
  }, [orgRole, orgMsgAccess]);

  // Save opacity setting (admin only)
  const handleSaveOpacity = async (level) => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      await svc.setState(orgRoom, EVT.ORG_OPACITY, {level, updated: Date.now(), updated_by: svc.userId});
      setOrgOpacity(level);
      await emitOp(orgRoom, 'ALT', {entity:'org_opacity',field:'level'}, {from:orgOpacity,to:level,changed_by:svc.userId}, orgFrame());
      showToast(`Opacity set to ${OPACITY_LABELS[level]}`,'success');
    } catch(e) { showToast('Failed to update opacity: '+e.message,'error'); }
  };

  // Save message access settings (admin only)
  const handleSaveMsgAccess = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      await svc.setState(orgRoom, EVT.ORG_MSG_ACCESS, {...msgAccessDraft, updated: Date.now()});
      setOrgMsgAccess(msgAccessDraft);
      await emitOp(orgRoom, 'ALT', {entity:'org_msg_access',field:'roles'}, {read:msgAccessDraft.read,respond:msgAccessDraft.respond}, orgFrame());
      setMsgAccessModal(false);
      showToast('Message access roles updated','success');
    } catch(e) { showToast('Failed to update access: '+e.message,'error'); }
  };

  // Save org terminology customization (admin only)
  const handleSaveTerminology = async () => {
    if (!orgRoom || orgRole !== 'admin') return;
    try {
      const payload = {...terminologyDraft, updated: Date.now(), updated_by: svc.userId};
      await svc.setState(orgRoom, EVT.ORG_TERMINOLOGY, payload);
      setOrgTerminology({...TERMINOLOGY_DEFAULTS, ...terminologyDraft});
      setTerminologyModal(false);
      await emitOp(orgRoom, 'ALT', {entity:'org_terminology',field:'terms'}, {
        client_term: terminologyDraft.client_term,
        provider_term: terminologyDraft.provider_term,
        changed_by: svc.userId
      }, orgFrame());
      showToast('Terminology updated','success');
    } catch(e) { showToast('Failed to update terminology: '+e.message,'error'); }
  };

  // Reset terminology to defaults
  const handleResetTerminology = () => {
    setTerminologyDraft({...TERMINOLOGY_DEFAULTS});
  };

  // Create org-to-org messaging channel
  const handleCreateOrgChannel = async () => {
    if (!orgRoom || !composePeerOrgId.trim()) return;
    // Check for existing channel
    const existing = orgChannels.find(c => c.orgs?.includes(composePeerOrgId.trim()));
    if (existing) {
      setActiveChannel(existing.roomId);
      setView('org-inbox');
      setComposeOrgModal(false);
      showToast('Channel already exists — opened','info');
      return;
    }
    try {
      const peerOrgId = composePeerOrgId.trim();
      const channelRoom = await svc.createRoom(
        `[Khora Org Msg] ${orgMeta.name||'Org'} ↔ ${composePeerOrgName||peerOrgId.slice(0,12)}`,
        'Inter-org messaging channel',
        [
          {type:EVT.IDENTITY,state_key:'',content:{account_type:'org_msg_channel',created:Date.now()}},
          {type:EVT.ORG_MSG_CHANNEL,state_key:'',content:{
            type:'org_msg_channel',
            orgs:[orgRoom, peerOrgId],
            org_names:{[orgRoom]:orgMeta.name||'',[peerOrgId]:composePeerOrgName||''},
            created:Date.now(), created_by:svc.userId,
          }},
        ]
      );
      // Invite the peer org room members (the channel inherits access from org rooms)
      try { await svc.invite(channelRoom, peerOrgId); } catch(e) { console.warn('Peer invite:', e.message); }
      await emitOp(channelRoom, 'INS', {entity:'org_msg_channel',field:'channel'},
        {from_org:orgRoom,to_org:peerOrgId}, orgFrame());
      const newChannel = {roomId:channelRoom,orgs:[orgRoom,peerOrgId],
        org_names:{[orgRoom]:orgMeta.name||'',[peerOrgId]:composePeerOrgName||''},type:'org_msg_channel',created:Date.now()};
      setOrgChannels(prev=>[...prev,newChannel]);
      setActiveChannel(channelRoom);
      setView('org-inbox');
      setComposeOrgModal(false); setComposePeerOrgId(''); setComposePeerOrgName('');
      showToast('Messaging channel created','success');
    } catch(e) { showToast('Failed to create channel: '+e.message,'error'); }
  };

  // Load messages for an org channel
  const loadChannelMessages = async (channelRoomId) => {
    if (!channelRoomId) return;
    const msgs = await svc.getMessages(channelRoomId);
    setChannelMessages(msgs);
  };

  // Send a message in an org channel — applies opacity envelope
  const handleSendOrgMsg = async () => {
    if (!orgMsgText.trim() || !activeChannel) return;
    if (!hasOrgMsgPermission('respond')) { showToast('You do not have permission to send org messages','warn'); return; }
    try {
      // Build opacity envelope: what the receiving org sees depends on our opacity setting
      const envelope = {
        [`${NS}.type`]: 'org_message',
        [`${NS}.envelope`]: {
          opacity: orgOpacity,
          org_room_id: orgOpacity === 'opaque' ? undefined : orgRoom,
          org_name: orgOpacity === 'opaque' ? undefined : (orgMeta.name || undefined),
          sender_id: orgOpacity === 'transparent' ? svc.userId : undefined,
          sender_name: orgOpacity === 'transparent' ? (providerProfile.display_name || undefined) : undefined,
          ts: Date.now(),
        },
      };
      await svc.sendMessage(activeChannel, orgMsgText, envelope);
      await emitOp(activeChannel, 'INS', {type:'org_message',field:'message'},
        {opacity:orgOpacity,body_length:orgMsgText.length}, orgFrame());
      setOrgMsgText('');
      setTimeout(()=>loadChannelMessages(activeChannel),500);
    } catch(e) { showToast('Send failed: '+e.message,'error'); }
  };

  // Open a channel
  const openChannel = (channelRoomId) => {
    setActiveChannel(channelRoomId);
    setView('org-inbox');
    loadChannelMessages(channelRoomId);
  };

  // Resolve display info for a message based on opacity
  const resolveMessageSender = useCallback((msg) => {
    const env = msg.content?.[`${NS}.envelope`];
    if (!env) return {label: msg.sender === svc.userId ? 'You' : msg.sender, isOwn: msg.sender === svc.userId};
    const isOwn = msg.sender === svc.userId || env.org_room_id === orgRoom;
    switch (env.opacity) {
      case 'transparent':
        return {label: env.sender_name || env.sender_id || 'Unknown', org: env.org_name, isOwn};
      case 'translucent':
        return {label: env.org_name || 'Organization', org: env.org_name, isOwn};
      case 'opaque':
        return {label: 'An organization', org: null, isOwn};
      default:
        return {label: msg.sender, isOwn};
    }
  }, [orgRoom]);

  // ─── Inbox chat functions ───
  const loadInboxMessages = async (roomId) => { setInboxMessages(await svc.getMessages(roomId)); };
  const openInboxConvo = (roomId) => {
    setInboxConvo(roomId);
    loadInboxMessages(roomId);
  };
  const handleSendInboxMsg = async () => {
    if (!inboxMsgText.trim() || !inboxConvo) return;
    const isOrgChannel = orgChannels.some(ch => ch.roomId === inboxConvo);
    if (isOrgChannel) {
      if (!hasOrgMsgPermission('respond')) { showToast('You do not have permission to send org messages','warn'); return; }
      const envelope = {
        [`${NS}.type`]: 'org_message',
        [`${NS}.envelope`]: {
          opacity: orgOpacity,
          org_room_id: orgOpacity === 'opaque' ? undefined : orgRoom,
          org_name: orgOpacity === 'opaque' ? undefined : (orgMeta.name || undefined),
          sender_id: orgOpacity === 'transparent' ? svc.userId : undefined,
          sender_name: orgOpacity === 'transparent' ? (providerProfile.display_name || undefined) : undefined,
          ts: Date.now(),
        },
      };
      await svc.sendMessage(inboxConvo, inboxMsgText, envelope);
    } else {
      await svc.sendMessage(inboxConvo, inboxMsgText, {[`${NS}.type`]:'note'});
      await emitOp(inboxConvo, 'INS', {type:'provider_note',field:'message'}, {body:inboxMsgText}, bridgeFrame(inboxConvo));
    }
    setInboxMsgText('');
    setTimeout(() => loadInboxMessages(inboxConvo), 500);
  };
  const getInboxConvoName = useCallback((roomId) => {
    const c = cases.find(c => c.bridgeRoomId === roomId);
    if (c) return c.sharedData.full_name || c.clientUserId;
    const ch = orgChannels.find(ch => ch.roomId === roomId);
    if (ch) {
      const peerOrgId = ch.orgs?.find(o => o !== orgRoom);
      return ch.org_names?.[peerOrgId] || peerOrgId?.slice(0,20) || 'Organization';
    }
    return roomId?.slice(0,20) || 'Unknown';
  }, [cases, orgChannels, orgRoom]);
  const getInboxConvoType = useCallback((roomId) => {
    if (cases.some(c => c.bridgeRoomId === roomId)) return 'case';
    if (orgChannels.some(ch => ch.roomId === roomId)) return 'channel';
    return 'unknown';
  }, [cases, orgChannels]);

  // Determine network role based on org membership
  const networkRole = useMemo(() => {
    if (!networkRoom || !orgRoom) return null;
    const myOrg = networkMembers.find(m => m.id === orgRoom || m.id === svc.userId);
    return myOrg?.role || 'member';
  }, [networkRoom, orgRoom, networkMembers]);

  const openCase = (bid) => { setView('case'); setActiveCase(bid); loadMessages(bid); loadProviderObservations(bid); };
  const activeCaseData = cases.find(c=>c.bridgeRoomId===activeCase);

  // Aggregate metrics for dashboard
  const metricsByCategory = useMemo(() => {
    const agg = {};
    metrics.forEach(m => {
      const cat = m.observation?.category||'unknown';
      const val = m.observation?.value||'unknown';
      if (!agg[cat]) agg[cat]={};
      agg[cat][val] = (agg[cat][val]||0) + 1;
    });
    return agg;
  }, [metrics]);

  if(loading) return <div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}><Spin s={28}/></div>;

  if(initError) return <div style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center',maxWidth:400,padding:20}}>
      <div style={{width:48,height:48,borderRadius:'var(--r-lg)',background:'var(--red-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--red)',margin:'0 auto 16px'}}><I n="alert-triangle" s={24}/></div>
      <h3 style={{fontSize:16,fontWeight:700,marginBottom:8}}>Provider Setup Failed</h3>
      <p style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.6,marginBottom:16}}>{initError}</p>
      <div style={{display:'flex',gap:8,justifyContent:'center'}}>
        <button onClick={initProvider} className="b-pri"><I n="refresh-cw" s={13}/>Retry</button>
        <button onClick={onLogout} className="b-gho">Sign Out</button>
      </div>
    </div>
  </div>;

  return <div style={{display:'flex',height:'100%'}}>
    {/* Sidebar */}
    <div className="app-sidebar" style={{width:260,minWidth:260,height:'100%',background:'var(--bg-1)',borderRight:'1px solid var(--border-0)',display:'flex',flexDirection:'column'}}>
      <div style={{padding:'18px 14px 14px',borderBottom:'1px solid var(--border-0)'}}>
        <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
          <div style={{width:28,height:28,borderRadius:'var(--r)',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)'}}><I n="briefcase" s={15}/></div>
          <span style={{fontFamily:'var(--serif)',fontWeight:700,fontSize:15,flex:1}}>Khora</span>
          <NotificationBell
            notifications={notifications}
            onNotifClick={handleNotifClick}
            onDismiss={(n) => setNotifications(prev => prev.filter(x => x.id !== n.id))}
            onDismissAll={handleDismissAllNotifs}
          />
        </div>
        {/* Provider identity card */}
        <div onClick={openProfileModal} style={{marginTop:10,padding:'10px 12px',background:'var(--bg-2)',border:'1px solid var(--border-1)',borderRadius:'var(--r-lg)',cursor:'pointer',transition:'border-color .2s'}}
          onMouseEnter={e=>e.currentTarget.style.borderColor='var(--gold)'}
          onMouseLeave={e=>e.currentTarget.style.borderColor='var(--border-1)'}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
            <div style={{width:32,height:32,borderRadius:'50%',background:orgRoom?'var(--blue-dim)':'var(--gold-dim)',
              display:'flex',alignItems:'center',justifyContent:'center',color:orgRoom?'var(--blue)':'var(--gold)',
              border:orgRoom?'2px solid var(--blue)':'2px solid var(--gold)'}}>
              <I n={orgRoom?'shieldCheck':'user'} s={16}/>
            </div>
            <div style={{flex:1,minWidth:0}}>
              <span style={{fontSize:13,fontWeight:700,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',color:'var(--tx-0)'}}>
                {providerProfile.display_name || svc.userId?.split(':')[0]?.replace('@','') || T.provider_term}
              </span>
              {providerProfile.title && <span style={{fontSize:10,color:'var(--tx-2)',display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{providerProfile.title}</span>}
            </div>
          </div>
          {orgRoom ? <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.2)',borderRadius:'var(--r)',padding:'6px 8px',display:'flex',alignItems:'center',gap:6}}>
            <I n="shieldCheck" s={12} c="var(--blue)"/>
            <div style={{flex:1,minWidth:0}}>
              <span style={{fontSize:10.5,fontWeight:600,color:'var(--blue)',display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{orgMeta.name || 'Organization'}</span>
              <span style={{fontSize:9,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{ORG_ROLE_LABELS[orgRole]||orgRole} · {ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type}</span>
            </div>
            {myVerification?.status==='verified' ? <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>VERIFIED</span>
            : emailVerifyConfig.enabled ? <span className="tag tag-gold" style={{fontSize:7.5,padding:'1px 5px',cursor:'pointer'}} onClick={openEmailVerifyModal}>UNVERIFIED</span>
            : <span className="tag tag-green" style={{fontSize:7.5,padding:'1px 5px'}}>VERIFIED</span>}
          </div> : <div style={{display:'flex',alignItems:'center',gap:4,padding:'4px 0'}}>
            <span style={{fontSize:9.5,color:'var(--tx-3)',fontStyle:'italic'}}>No organization — unaffiliated</span>
          </div>}
          <div style={{display:'flex',alignItems:'center',gap:4,marginTop:6}}>
            <span style={{fontFamily:'var(--mono)',fontSize:8.5,color:'var(--tx-3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}}>{svc.userId}</span>
            <span className="tag tag-gold" style={{fontSize:8}}>{T.provider_term.toUpperCase()}</span>
          </div>
          {providerProfile.credentials && <div style={{marginTop:4}}>
            <span style={{fontSize:9,color:'var(--tx-2)',fontFamily:'var(--mono)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',display:'block'}}>{providerProfile.credentials}</span>
          </div>}
        </div>
      </div>
      <div style={{flex:1,overflow:'auto',padding:'6px 6px'}}>
        {/* Personal nav */}
        {(()=>{
          const schemaNotifCount = notifications.filter(n => (n.type === 'schema_update' || n.type === 'schema_new') && !n.read).length;
          const activityNotifCount = notifications.filter(n => n.type === 'data_change' && !n.read).length;
          return [{id:'dashboard',icon:'briefcase',label:'Dashboard'},
          {id:'inbox',icon:'msg',label:'Messages'},
          {id:'clients',icon:'users',label:T.client_term_plural},
          {id:'metrics',icon:'bar',label:'Metrics'},
          {id:'teams',icon:'users',label:`Teams${teams.length?` (${teams.length})`:''}`},
          {id:'schema',icon:'grid',label:'Schema',badge:schemaNotifCount,badgeClass:'nav-badge-teal'},
          {id:'activity',icon:'zap',label:'Activity Stream',badge:activityNotifCount,badgeClass:'nav-badge-teal'}
        ].map(item=><div key={item.id} onClick={()=>{setView(item.id);setActiveCase(null);if(item.id!=='inbox'){setInboxConvo(null);setInboxMessages([])}}}
          style={{padding:'9px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
            background:view===item.id&&!activeCase?'var(--bg-4)':'transparent',
            borderLeft:view===item.id&&!activeCase?'2px solid var(--gold)':'2px solid transparent',
            display:'flex',alignItems:'center',gap:8,transition:'all .15s',
            color:view===item.id&&!activeCase?'var(--tx-0)':'var(--tx-1)'}}
          onMouseEnter={e=>{if(!(view===item.id&&!activeCase))e.currentTarget.style.background='var(--bg-3)'}}
          onMouseLeave={e=>{if(!(view===item.id&&!activeCase))e.currentTarget.style.background='transparent'}}>
          <I n={item.icon} s={14}/><span style={{fontSize:12.5,fontWeight:view===item.id?600:400}}>{item.label}</span>
          {item.id==='inbox'&&(cases.length+orgChannels.length)>0&&<span className="nav-badge nav-badge-gold">{cases.length+orgChannels.length}</span>}
          {item.badge>0&&<span className={`nav-badge ${item.badgeClass}`}>{item.badge}</span>}
        </div>);
        })()}

        {/* Organization section */}
        <div style={{padding:'14px 10px 4px'}}><span className="section-label">ORGANIZATION</span></div>
        {orgRoom ? <>
          <div style={{padding:'6px 10px',marginBottom:4}}>
            <div style={{display:'flex',alignItems:'center',gap:6}}>
              <div style={{width:20,height:20,borderRadius:'var(--r)',background:'var(--blue-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--blue)'}}><I n="users" s={11}/></div>
              <span style={{fontSize:11.5,fontWeight:600,color:'var(--tx-0)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{orgMeta.name||'Organization'}</span>
            </div>
            {orgMeta.type&&<span className="tag tag-teal" style={{fontSize:8,marginTop:4,marginLeft:26}}>{ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type}</span>}
          </div>
          {[
            {id:'org-settings',icon:'settings',label:'Org Settings',reqRole:'admin'},
            {id:'org-inbox',icon:'msg',label:`Messages${orgChannels.length?` (${orgChannels.length})`:''}`},
            {id:'staff',icon:'users',label:'Staff'},
            {id:'network',icon:'globe',label:'Network'},
          ].filter(item=>!item.reqRole||orgRole===item.reqRole).filter(item=>item.id!=='org-inbox'||hasOrgMsgPermission('read')).map(item=><div key={item.id} onClick={()=>{setView(item.id);setActiveCase(null)}}
            style={{padding:'9px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
              background:view===item.id&&!activeCase?'var(--bg-4)':'transparent',
              borderLeft:view===item.id&&!activeCase?'2px solid var(--blue)':'2px solid transparent',
              display:'flex',alignItems:'center',gap:8,transition:'all .15s',
              color:view===item.id&&!activeCase?'var(--tx-0)':'var(--tx-1)'}}
            onMouseEnter={e=>{if(!(view===item.id&&!activeCase))e.currentTarget.style.background='var(--bg-3)'}}
            onMouseLeave={e=>{if(!(view===item.id&&!activeCase))e.currentTarget.style.background='transparent'}}>
            <I n={item.icon} s={14}/><span style={{fontSize:12.5,fontWeight:view===item.id?600:400}}>{item.label}</span>
          </div>)}
        </> : <div style={{padding:'4px 10px',display:'flex',flexDirection:'column',gap:4}}>
          <button onClick={()=>setCreateOrgModal(true)} className="b-gho b-sm" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:4}}>
            <I n="plus" s={12}/>Create Organization</button>
          <button onClick={()=>setJoinOrgModal(true)} className="b-gho b-xs" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:4}}>
            <I n="users" s={10}/>Join Organization</button>
        </div>}

        {/* Cases section */}
        <div style={{padding:'14px 10px 4px'}}><span className="section-label">CASES ({cases.length})</span></div>
        {cases.length===0&&<p style={{color:'var(--tx-3)',fontSize:11.5,padding:'12px 10px',textAlign:'center'}}>No clients shared with you yet</p>}
        {cases.map((c,i)=>{
          const assignment = caseAssignments[c.bridgeRoomId];
          const isPrimary = (assignment?.primary || c.meta?.provider) === svc.userId;
          return <div key={c.bridgeRoomId} onClick={()=>openCase(c.bridgeRoomId)}
          style={{padding:'8px 10px',borderRadius:'var(--r)',cursor:'pointer',marginBottom:1,
            background:activeCase===c.bridgeRoomId?'var(--bg-4)':'transparent',
            borderLeft:activeCase===c.bridgeRoomId?'2px solid var(--gold)':'2px solid transparent',transition:'all .15s'}}
          onMouseEnter={e=>{if(activeCase!==c.bridgeRoomId)e.currentTarget.style.background='var(--bg-3)'}}
          onMouseLeave={e=>{if(activeCase!==c.bridgeRoomId)e.currentTarget.style.background='transparent'}}>
          <span style={{fontSize:12,fontWeight:activeCase===c.bridgeRoomId?600:400,display:'block'}}>{c.sharedData.full_name||c.clientUserId}</span>
          <div style={{display:'flex',alignItems:'center',gap:4,marginTop:1}}>
            <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{Object.keys(c.sharedData).length} fields</span>
            {c.transferable ? <I n="users" s={8} c="var(--teal)"/> : <I n="lock" s={8} c="var(--red)"/>}
            {!isPrimary && <span style={{fontSize:8,color:'var(--gold)',fontFamily:'var(--mono)'}}>{(assignment?.primary||c.meta?.provider)?.split(':')[0]?.replace('@','')}</span>}
          </div>
        </div>;})}

        <div style={{padding:'12px 10px',display:'flex',flexDirection:'column',gap:4}}>
          <button onClick={()=>setDiscoverModal(true)} className="b-gho b-sm" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:4}}>
            <I n="search" s={12}/>Find Client</button>
          <button onClick={()=>loadCases()} className="b-gho b-xs" style={{width:'100%'}}><I n="search" s={10}/>Refresh</button>
        </div>
      </div>
      <div style={{padding:'8px 10px',borderTop:'1px solid var(--border-0)',display:'flex',flexDirection:'column',gap:6}}>
        <ThemeToggle style={{width:'100%',justifyContent:'center'}}/>
        <button onClick={onLogout} className="b-gho b-sm" style={{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:5}}><I n="logout" s={12}/>Logout</button>
      </div>
    </div>

    {/* Main */}
    <div className="app-main" style={{flex:1,overflow:'auto',padding:24}}>

      {/* DASHBOARD */}
      {view==='dashboard'&&!activeCase&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>{T.provider_term} Dashboard</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:24}}>You can only see data {T.client_term_plural.toLowerCase()} have explicitly shared. Each case is a separate encrypted bridge room.</p>

        {/* Provider identity card */}
        <div className="card" style={{marginBottom:20,padding:0,overflow:'hidden'}}>
          <div style={{padding:'16px 18px',display:'flex',alignItems:'center',gap:14}}>
            <div style={{width:48,height:48,borderRadius:'50%',background:orgRoom?'var(--blue-dim)':'var(--gold-dim)',
              display:'flex',alignItems:'center',justifyContent:'center',color:orgRoom?'var(--blue)':'var(--gold)',
              border:orgRoom?'2px solid var(--blue)':'2px solid var(--gold)',flexShrink:0}}>
              <I n={orgRoom?'shieldCheck':'user'} s={24}/>
            </div>
            <div style={{flex:1,minWidth:0}}>
              <span style={{fontSize:17,fontWeight:700,display:'block'}}>{providerProfile.display_name || svc.userId?.split(':')[0]?.replace('@','') || T.provider_term}</span>
              {providerProfile.title && <span style={{fontSize:12,color:'var(--tx-2)',display:'block'}}>{providerProfile.title}</span>}
              {providerProfile.credentials && <span style={{fontSize:10.5,color:'var(--tx-2)',fontFamily:'var(--mono)',display:'block',marginTop:2}}>{providerProfile.credentials}</span>}
            </div>
            <button onClick={openProfileModal} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="settings" s={11}/>Edit</button>
          </div>
          {orgRoom ? <div style={{padding:'10px 18px',background:'var(--blue-dim)',borderTop:'1px solid rgba(91,156,245,.12)',display:'flex',alignItems:'center',gap:10}}>
            <I n="shieldCheck" s={16} c="var(--blue)"/>
            <div style={{flex:1}}>
              <span style={{fontSize:12.5,fontWeight:600,color:'var(--blue)',display:'block'}}>{orgMeta.name||'Organization'}</span>
              <span style={{fontSize:10,color:'var(--tx-2)'}}>{ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type} · {staff.length} staff · {ORG_ROLE_LABELS[orgRole]||orgRole}</span>
            </div>
            {myVerification?.status==='verified' ? <span className="tag tag-green" style={{fontSize:8}}>VERIFIED</span>
            : emailVerifyConfig.enabled ? <span className="tag tag-gold" style={{fontSize:8,cursor:'pointer'}} onClick={openEmailVerifyModal}>VERIFY</span>
            : <span className="tag tag-green" style={{fontSize:8}}>VERIFIED</span>}
            <button onClick={()=>setView('org-settings')} className="b-gho b-xs"><I n="settings" s={11}/></button>
          </div> : <div style={{padding:'10px 18px',background:'var(--gold-dim)',borderTop:'1px solid var(--gold-mid)',display:'flex',alignItems:'center',gap:8}}>
            <I n="alert" s={14} c="var(--gold)"/>
            <span style={{fontSize:11,color:'var(--gold)',flex:1}}>Not affiliated with an organization</span>
            <button onClick={()=>setCreateOrgModal(true)} className="b-gho b-xs">Set Up</button>
          </div>}
          {providerProfile.bio && <div style={{padding:'10px 18px',borderTop:'1px solid var(--border-0)'}}>
            <span style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.5}}>{providerProfile.bio}</span>
          </div>}
          {!providerProfile.display_name && <div style={{padding:'10px 18px',borderTop:'1px solid var(--border-0)',display:'flex',alignItems:'center',gap:8}}>
            <I n="alert" s={13} c="var(--gold)"/>
            <span style={{fontSize:11,color:'var(--gold)'}}>Set up your profile — {T.client_term_plural.toLowerCase()} will see your name, title, and org membership on bridges.</span>
            <button onClick={openProfileModal} className="b-pri b-xs">Set Up</button>
          </div>}
        </div>

        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))',gap:10,marginBottom:24}}>
          {[{l:'Active Cases',v:cases.length,c:'gold',i:'briefcase'},
            {l:orgRoom?'Staff':'Organization',v:orgRoom?`${staff.length} members`:'Not set up',c:orgRoom?'blue':'teal',i:orgRoom?'users':'plus'},
            {l:'Access Model',v:`${T.client_term}-granted`,c:'teal',i:'shield'},{l:'Metric Events',v:metrics.length,c:'orange',i:'bar'}
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {cases.length>0&&<><span className="section-label">ALL CASES</span>
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(250px,1fr))',gap:10,marginTop:6}}>
            {cases.map(c=>{
              const assignment = caseAssignments[c.bridgeRoomId];
              const primaryProvider = assignment?.primary || c.meta?.provider;
              const isPrimaryMine = primaryProvider === svc.userId;
              return <div key={c.bridgeRoomId} className="card-h" onClick={()=>openCase(c.bridgeRoomId)}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
                <span style={{fontSize:14,fontWeight:600}}>{c.sharedData.full_name||`Anonymous ${T.client_term}`}</span>
                <I n="chevR" s={13} c="var(--tx-3)"/></div>
              {c.sharedData.email&&<span style={{fontFamily:'var(--mono)',fontSize:10.5,color:'var(--tx-2)',display:'block',marginBottom:6}}>{c.sharedData.email}</span>}
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                <span className="tag tag-green"><I n="lock" s={9}/>E2EE</span>
                <span className="tag tag-blue">{Object.keys(c.sharedData).length} fields</span>
                {c.transferable ? <span className="tag tag-teal"><I n="users" s={9}/>Transferable</span>
                  : <span className="tag tag-red"><I n="lock" s={9}/>Locked</span>}
                {!isPrimaryMine && <span className="tag tag-gold" style={{fontSize:8}}>{primaryProvider?.split(':')[0]?.replace('@','')}</span>}
              </div>
              {assignment?.transferred_from && <div style={{marginTop:6,fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>
                Transferred from {assignment.transferred_from.split(':')[0]?.replace('@','')}
              </div>}
            </div>;})}
          </div></>}
        <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="eye" s={16} c="var(--gold)"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>As a provider, you cannot modify client vault data. Clients can revoke your access at any time.{!orgRoom&&' Create or join an organization to manage staff, cases across your team, and participate in networks.'}{orgRoom&&' Cases marked "Transferable" can be reassigned to other org staff. Clients can lock transfers at any time.'}</span>
        </div>
      </div>}

      {/* MESSAGES VIEW */}
      {view==='inbox'&&!activeCase&&<div className="anim-up inbox-wrap">
        <div className="inbox-header">
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Messages</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Encrypted conversations with {T.client_term_plural.toLowerCase()}{orgRoom?' and organizations':''} in one place.</p>
          </div>
          <div style={{display:'flex',gap:6,flexShrink:0}}>
            <button onClick={()=>setDiscoverModal(true)} className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="search" s={14}/>Find Client</button>
            {orgRoom&&hasOrgMsgPermission('read')&&<button onClick={()=>setComposeOrgModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>New Channel</button>}
          </div>
        </div>
        {/* Tabs */}
        {orgRoom&&hasOrgMsgPermission('read')&&<div className="tabs" style={{marginBottom:16}}>
          <div className={`tab${inboxTab==='cases'?' active':''}`} onClick={()=>{setInboxTab('cases');setInboxConvo(null);setInboxMessages([])}}>Cases ({cases.length})</div>
          <div className={`tab${inboxTab==='channels'?' active':''}`} onClick={()=>{setInboxTab('channels');setInboxConvo(null);setInboxMessages([])}}>Org Channels ({orgChannels.length})</div>
        </div>}
        <div className="inbox-panel">
          {/* Conversation list */}
          <div className="inbox-list">
            <div style={{padding:'14px 14px 10px',borderBottom:'1px solid var(--border-0)'}}>
              <span className="section-label" style={{marginBottom:0}}>{inboxTab==='cases'?`CASES (${cases.length})`:`CHANNELS (${orgChannels.length})`}</span>
            </div>
            <div style={{flex:1,overflow:'auto'}}>
              {inboxTab==='cases' ? <>
                {cases.length===0?
                  <div style={{padding:'40px 16px',textAlign:'center'}}>
                    <I n="briefcase" s={28} c="var(--tx-3)"/>
                    <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:10}}>No cases yet</p>
                    <p style={{color:'var(--tx-3)',fontSize:10.5,marginTop:4}}>Clients must share a bridge with you first</p>
                  </div>
                :cases.map(c=><div key={c.bridgeRoomId} onClick={()=>openInboxConvo(c.bridgeRoomId)}
                  style={{padding:'12px 14px',cursor:'pointer',borderBottom:'1px solid var(--border-0)',
                    background:inboxConvo===c.bridgeRoomId?'var(--bg-4)':'transparent',
                    borderLeft:inboxConvo===c.bridgeRoomId?'3px solid var(--gold)':'3px solid transparent',
                    transition:'all .15s'}}
                  onMouseEnter={e=>{if(inboxConvo!==c.bridgeRoomId)e.currentTarget.style.background='var(--bg-3)'}}
                  onMouseLeave={e=>{if(inboxConvo!==c.bridgeRoomId)e.currentTarget.style.background=inboxConvo===c.bridgeRoomId?'var(--bg-4)':'transparent'}}>
                  <div style={{display:'flex',alignItems:'center',gap:10}}>
                    <div style={{width:36,height:36,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)',border:'2px solid var(--teal)',flexShrink:0}}>
                      <I n="user" s={16}/>
                    </div>
                    <div style={{flex:1,minWidth:0}}>
                      <span style={{fontSize:13,fontWeight:inboxConvo===c.bridgeRoomId?700:500,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{c.sharedData.full_name||c.clientUserId}</span>
                      <div style={{display:'flex',alignItems:'center',gap:4,marginTop:2}}>
                        <span className="tag tag-green" style={{fontSize:8}}><I n="lock" s={7}/>E2EE</span>
                        <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{Object.keys(c.sharedData).length} fields</span>
                      </div>
                    </div>
                  </div>
                </div>)}
              </> : <>
                {orgChannels.length===0?
                  <div style={{padding:'40px 16px',textAlign:'center'}}>
                    <I n="msg" s={28} c="var(--tx-3)"/>
                    <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:10}}>No channels yet</p>
                    <p style={{color:'var(--tx-3)',fontSize:10.5,marginTop:4}}>Create a channel to message another org</p>
                  </div>
                :orgChannels.map(ch=>{
                  const peerOrgId = ch.orgs?.find(o=>o!==orgRoom);
                  const peerName = ch.org_names?.[peerOrgId]||peerOrgId?.slice(0,20)||'Unknown Org';
                  return <div key={ch.roomId} onClick={()=>openInboxConvo(ch.roomId)}
                    style={{padding:'12px 14px',cursor:'pointer',borderBottom:'1px solid var(--border-0)',
                      background:inboxConvo===ch.roomId?'var(--bg-4)':'transparent',
                      borderLeft:inboxConvo===ch.roomId?'3px solid var(--blue)':'3px solid transparent',
                      transition:'all .15s'}}
                    onMouseEnter={e=>{if(inboxConvo!==ch.roomId)e.currentTarget.style.background='var(--bg-3)'}}
                    onMouseLeave={e=>{if(inboxConvo!==ch.roomId)e.currentTarget.style.background=inboxConvo===ch.roomId?'var(--bg-4)':'transparent'}}>
                    <div style={{display:'flex',alignItems:'center',gap:10}}>
                      <div style={{width:36,height:36,borderRadius:'50%',background:'var(--blue-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--blue)',border:'2px solid var(--blue)',flexShrink:0}}>
                        <I n="users" s={16}/>
                      </div>
                      <div style={{flex:1,minWidth:0}}>
                        <span style={{fontSize:13,fontWeight:inboxConvo===ch.roomId?700:500,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{peerName}</span>
                        <div style={{display:'flex',alignItems:'center',gap:4,marginTop:2}}>
                          <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:8}}>{orgOpacity}</span>
                          <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>org channel</span>
                        </div>
                      </div>
                    </div>
                  </div>;
                })}
              </>}
            </div>
          </div>
          {/* Active conversation */}
          <div className="inbox-chat">
            {inboxConvo ? (() => {
              const convoType = getInboxConvoType(inboxConvo);
              const convoName = getInboxConvoName(inboxConvo);
              const caseData = cases.find(c => c.bridgeRoomId === inboxConvo);
              const channelData = orgChannels.find(ch => ch.roomId === inboxConvo);
              return <>
                {/* Chat header */}
                <div className="inbox-chat-hdr">
                  <div style={{width:32,height:32,borderRadius:'50%',background:convoType==='case'?'var(--teal-dim)':'var(--blue-dim)',
                    display:'flex',alignItems:'center',justifyContent:'center',color:convoType==='case'?'var(--teal)':'var(--blue)',
                    border:`2px solid ${convoType==='case'?'var(--teal)':'var(--blue)'}`}}>
                    <I n={convoType==='case'?'user':'users'} s={14}/>
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <span style={{fontSize:14,fontWeight:700,display:'block'}}>{convoName}</span>
                    <div style={{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}}>
                      <span className="tag tag-green" style={{fontSize:8}}><I n="lock" s={8}/>E2EE</span>
                      {convoType==='case'&&caseData&&<span style={{fontSize:10,color:'var(--tx-2)'}}>{Object.keys(caseData.sharedData).length} shared fields</span>}
                      {convoType==='channel'&&<span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:8}}>OUTGOING: {orgOpacity}</span>}
                    </div>
                  </div>
                  {convoType==='case'&&<button onClick={()=>openCase(inboxConvo)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="briefcase" s={11}/>Full Case</button>}
                  {convoType==='channel'&&<button onClick={()=>openChannel(inboxConvo)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="msg" s={11}/>Full Channel</button>}
                  <button onClick={()=>loadInboxMessages(inboxConvo)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="refresh-cw" s={11}/></button>
                </div>
                {/* Messages */}
                <div className="inbox-msgs">
                  {inboxMessages.length===0?
                    <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
                      <I n="msg" s={32} c="var(--tx-3)"/>
                      <p style={{color:'var(--tx-3)',fontSize:12,marginTop:10}}>No messages yet</p>
                      <p style={{color:'var(--tx-3)',fontSize:11,marginTop:4}}>Start the conversation below</p>
                    </div>
                  :[...inboxMessages].reverse().map((msg,i)=>{
                    const isOwn = msg.sender===svc.userId;
                    const sender = convoType==='channel' ? resolveMessageSender(msg) : {label:isOwn?'You':T.client_term,isOwn};
                    return <div key={msg.id||i} style={{display:'flex',flexDirection:'column',alignItems:sender.isOwn?'flex-end':'flex-start',marginBottom:4}}>
                      <div style={{maxWidth:'75%',padding:'10px 14px',borderRadius:sender.isOwn?'14px 14px 4px 14px':'14px 14px 14px 4px',
                        background:sender.isOwn?'var(--gold-dim)':'var(--bg-3)',border:`1px solid ${sender.isOwn?'rgba(201,163,82,.2)':'var(--border-0)'}`,
                        transition:'transform .1s'}}>
                        <p style={{fontSize:12.5,color:'var(--tx-0)',lineHeight:1.5,wordBreak:'break-word'}}>{msg.content?.body}</p>
                      </div>
                      <div style={{display:'flex',alignItems:'center',gap:4,marginTop:3,padding:'0 6px'}}>
                        <span style={{fontFamily:'var(--mono)',fontSize:9,color:sender.isOwn?'var(--gold)':'var(--teal)'}}>{sender.isOwn?'You'+(sender.org?` (${sender.org})`:convoType==='case'?` (${T.provider_term})`:''):sender.label}</span>
                        <span style={{fontFamily:'var(--mono)',fontSize:8,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):''}</span>
                      </div>
                    </div>;
                  })}
                </div>
                {/* Compose */}
                <div className="inbox-compose">
                  {(convoType==='case'||hasOrgMsgPermission('respond'))?<div style={{display:'flex',gap:8}}>
                    <input value={inboxMsgText} onChange={e=>setInboxMsgText(e.target.value)}
                      placeholder={convoType==='channel'?`Message as ${orgOpacity==='transparent'?(providerProfile.display_name||'you'):orgOpacity==='translucent'?(orgMeta.name||'your org'):'anonymous org'}... (E2EE)`:'Type a message (E2EE)...'}
                      onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendInboxMsg()}}}
                      style={{flex:1,borderRadius:20,padding:'10px 18px'}}/>
                    <button onClick={handleSendInboxMsg} className="b-pri" disabled={!inboxMsgText.trim()}
                      style={{borderRadius:20,width:42,height:42,padding:0,display:'flex',alignItems:'center',justifyContent:'center'}}>
                      <I n="send" s={16}/>
                    </button>
                  </div>
                  :<div style={{padding:'10px 14px',background:'var(--gold-dim)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:8}}>
                    <I n="lock" s={13} c="var(--gold)"/>
                    <span style={{fontSize:11.5,color:'var(--gold)'}}>Your role ({orgRole}) does not have permission to respond. Contact your admin.</span>
                  </div>}
                </div>
              </>;
            })()
            : <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}}>
              <div style={{width:64,height:64,borderRadius:'50%',background:'var(--gold-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--gold)',marginBottom:16}}>
                <I n="inbox" s={28}/>
              </div>
              <h3 style={{fontSize:16,fontWeight:700,marginBottom:6}}>{T.provider_term} Inbox</h3>
              <p style={{color:'var(--tx-2)',fontSize:12,maxWidth:300,textAlign:'center',lineHeight:1.6}}>
                {(cases.length+orgChannels.length)>0?'Select a conversation from the left to start chatting.':`No conversations yet. ${T.client_term_plural} must share a bridge, or create an org channel.`}
              </p>
            </div>}
          </div>
        </div>
      </div>}

      {/* CLIENTS TABLE VIEW */}
      {view==='clients'&&!activeCase&&<div className="anim-up" style={{maxWidth:960,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>{T.client_term_plural}</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Each {T.client_term.toLowerCase()} record is a private encrypted room. Invite {T.client_term_plural.toLowerCase()} to give them full control.</p>
          </div>
          <div style={{display:'flex',gap:8}}>
            <button onClick={()=>setImportModal(true)} className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="upload" s={14}/>Import Data</button>
            <button onClick={()=>{setCreateClientModal(true);setNewClientName('');setNewClientMatrixId('');setNewClientNotes('')}} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>New {T.client_term}</button>
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(140px,1fr))',gap:10,marginBottom:20}}>
          {[{l:`Total ${T.client_term_plural}`,v:clientRecords.length,c:'teal',i:'users'},
            {l:'Imported',v:clientRecords.filter(r=>r.imported).length,c:'purple',i:'upload'},
            {l:'Invited',v:clientRecords.filter(r=>r.status==='invited').length,c:'gold',i:'send'},
            {l:'Joined',v:clientRecords.filter(r=>r.status==='joined').length,c:'green',i:'check'},
            {l:'Claimed',v:clientRecords.filter(r=>r.status==='claimed').length,c:'teal',i:'shield'},
            {l:'Pending',v:clientRecords.filter(r=>r.status==='created'&&!r.imported).length,c:'orange',i:'clock'},
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {clientRecords.length===0?
          <div className="card" style={{textAlign:'center',padding:'40px 20px',borderStyle:'dashed'}}>
            <I n="users" s={32}/>
            <p style={{color:'var(--tx-2)',marginTop:10,fontSize:13}}>No {T.client_term.toLowerCase()} records yet</p>
            <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:4}}>Click "New {T.client_term}" to create a record, or "Import Data" to upload a CSV/JSON. Each {T.client_term.toLowerCase()} gets their own encrypted room.</p>
          </div>
        :<div className="card" style={{padding:0,overflow:'hidden'}}>
          {/* Table header */}
          <div style={{display:'grid',gridTemplateColumns:'2fr 1.5fr 1fr 1fr 1.2fr',gap:0,padding:'10px 16px',background:'var(--bg-3)',borderBottom:'1px solid var(--border-1)'}}>
            {['NAME','MATRIX ID','STATUS','CREATED','ACTIONS'].map(h=>
              <span key={h} style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.07em',fontWeight:600}}>{h}</span>)}
          </div>
          {/* Table rows */}
          {clientRecords.map((rec,i)=>{
            const statusColors = {created:'orange',invited:'gold',joined:'green',claimed:'teal'};
            const statusLabels = {created:'Pending',invited:'Invited',joined:'Joined',claimed:'Claimed'};
            return <div key={rec.roomId} style={{display:'grid',gridTemplateColumns:'2fr 1.5fr 1fr 1fr 1.2fr',gap:0,padding:'12px 16px',
              borderBottom:i<clientRecords.length-1?'1px solid var(--border-0)':'none',alignItems:'center',
              transition:'background .15s'}}
              onMouseEnter={e=>e.currentTarget.style.background='var(--bg-3)'}
              onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
              <div>
                <div style={{display:'flex',alignItems:'center',gap:6}}>
                  <span style={{fontSize:13,fontWeight:600}}>{rec.client_name}</span>
                  {rec.imported&&<span className="tag tag-purple" style={{fontSize:8}}><I n="lock" s={8}/>Encrypted</span>}
                </div>
                {rec.notes&&<span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:2}}>{rec.notes}</span>}
              </div>
              <span style={{fontFamily:'var(--mono)',fontSize:10.5,color:rec.client_matrix_id?'var(--tx-1)':'var(--tx-3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                {rec.client_matrix_id||'—'}
              </span>
              <span className={`tag tag-${statusColors[rec.status]||'orange'}`} style={{fontSize:9,justifySelf:'start'}}>
                {statusLabels[rec.status]||rec.status}
              </span>
              <span style={{fontSize:10.5,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>
                {rec.created?new Date(rec.created).toLocaleDateString():'—'}
              </span>
              <div style={{display:'flex',gap:4}}>
                <button onClick={()=>{setClientInviteModal(rec);setClientInviteMatrixId(rec.client_matrix_id||'');setCopiedField(null)}}
                  className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:3}}>
                  <I n="userPlus" s={11}/>Invite
                </button>
                <button onClick={()=>openCase(rec.roomId)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:3}}>
                  <I n="chevR" s={11}/>Open
                </button>
              </div>
            </div>;
          })}
        </div>}
        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="shield" s={16} c="var(--teal)"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong style={{color:'var(--teal)'}}>{T.client_term} sovereignty:</strong> When a {T.client_term.toLowerCase()} joins their room, they receive superadmin power level (100). When they claim the room, ownership transfers to them permanently. They can kick anyone — including you — from their room at any time. You cannot remove a joined or claimed {T.client_term.toLowerCase()}.
          </span>
        </div>
      </div>}

      {/* TEAMS VIEW */}
      {view==='teams'&&!activeCase&&<div className="anim-up" style={{maxWidth:960,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div>
            <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Teams</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Flexible groups of people for collaboration. Teams can span across organizations — anyone with a Matrix ID can be invited.</p>
          </div>
          <button onClick={()=>{setCreateTeamModal(true);setNewTeamName('');setNewTeamDesc('')}} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>New Team</button>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(140px,1fr))',gap:10,marginBottom:20}}>
          {[{l:'Total Teams',v:teams.length,c:'purple',i:'users'},
            {l:'My Teams',v:teams.filter(t=>t.owner===svc.userId).length,c:'gold',i:'briefcase'},
            {l:'Total Members',v:teams.reduce((sum,t)=>(sum+(t.members?.length||0)),0),c:'teal',i:'user'},
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
              <span style={{fontSize:18,fontWeight:700}}>{s.v}</span>
              <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
        </div>
        {teams.length===0?
          <div className="card" style={{textAlign:'center',padding:'40px 20px',borderStyle:'dashed'}}>
            <I n="users" s={32}/>
            <p style={{color:'var(--tx-2)',marginTop:10,fontSize:13}}>No teams yet</p>
            <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:4}}>Create a team to collaborate with people across your organization or beyond.</p>
          </div>
        :<div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:10}}>
          {teams.map(team=><div key={team.roomId} className="card" style={{padding:0,overflow:'hidden'}}>
            <div style={{padding:'14px 18px',borderBottom:'1px solid var(--border-0)'}}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:4}}>
                <span style={{fontSize:15,fontWeight:700}}>{team.name||'Unnamed Team'}</span>
                <div style={{display:'flex',gap:4}}>
                  {team.owner===svc.userId&&<span className="tag tag-gold" style={{fontSize:8}}>LEAD</span>}
                  {team.org_name&&<span className="tag tag-blue" style={{fontSize:8}}>{team.org_name}</span>}
                </div>
              </div>
              {team.description&&<p style={{fontSize:11.5,color:'var(--tx-2)',lineHeight:1.5}}>{team.description}</p>}
            </div>
            <div style={{padding:'10px 18px'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>MEMBERS ({team.members?.length||0})</span>
              <div style={{display:'flex',flexDirection:'column',gap:3}}>
                {(team.members||[]).slice(0,5).map((m,mi)=><div key={mi} style={{display:'flex',alignItems:'center',gap:6}}>
                  <div style={{width:18,height:18,borderRadius:'50%',background:m.role==='lead'?'var(--gold-dim)':'var(--bg-3)',display:'flex',alignItems:'center',justifyContent:'center',color:m.role==='lead'?'var(--gold)':'var(--tx-2)',flexShrink:0}}>
                    <I n={m.role==='lead'?'briefcase':'user'} s={9}/></div>
                  <span style={{fontSize:11,color:'var(--tx-1)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{m.display_name||m.userId}</span>
                  <span className={`tag ${m.role==='lead'?'tag-gold':'tag-blue'}`} style={{fontSize:7.5,marginLeft:'auto'}}>{m.role?.toUpperCase()}</span>
                </div>)}
                {(team.members?.length||0)>5&&<span style={{fontSize:10,color:'var(--tx-3)',fontStyle:'italic'}}>+{team.members.length-5} more</span>}
              </div>
            </div>
            <div style={{padding:'8px 18px 14px',display:'flex',gap:6}}>
              {team.owner===svc.userId&&<button onClick={()=>{setTeamInviteModal(team);setTeamInviteUserId('')}}
                className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:3}}>
                <I n="userPlus" s={11}/>Invite</button>}
              <button className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:3}} onClick={()=>{
                if(navigator.clipboard) navigator.clipboard.writeText(team.roomId);
                showToast('Team room ID copied','success');
              }}><I n="share" s={11}/>Share ID</button>
            </div>
          </div>)}
        </div>}
        <div style={{background:'var(--purple-dim,var(--blue-dim))',border:'1px solid rgba(128,90,213,.15)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="users" s={16} c="var(--purple,var(--blue))"/>
          <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong>Teams are flexible.</strong> They can include anyone — staff from your org, people from other orgs, or unaffiliated individuals. Teams are not governed by org policies; they're lightweight collaboration groups.
          </span>
        </div>
      </div>}

      {/* CASE VIEW */}
      {view==='case'&&activeCaseData&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <button onClick={()=>{setView('dashboard');setActiveCase(null)}} className="b-gho b-sm" style={{marginBottom:14,display:'flex',alignItems:'center',gap:4}}><I n="back" s={13}/>All Cases</button>
        <div style={{marginBottom:20}}>
          <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between'}}>
            <div>
              <h2 style={{fontFamily:'var(--serif)',fontSize:20,fontWeight:700}}>{activeCaseData.sharedData.full_name||activeCaseData.clientUserId}</h2>
              <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4,flexWrap:'wrap'}}>
                <span className="tag tag-green"><I n="lock" s={9}/>Megolm + AES-GCM</span>
                <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)'}}>Client-owned bridge</span>
                {activeCaseData.transferable
                  ? <span className="tag tag-teal"><I n="users" s={9}/>Transferable</span>
                  : <span className="tag tag-red"><I n="lock" s={9}/>Transfer Locked</span>}
              </div>
            </div>
            {orgRoom && (orgRole==='admin'||orgRole==='case_manager') && staff.length > 1 &&
              <button onClick={()=>{setTransferModal(activeCaseData);setTransferTarget('')}} className="b-gho b-sm" style={{display:'flex',alignItems:'center',gap:5}}>
                <I n="users" s={12}/>Transfer
              </button>}
          </div>
          {/* Assignment info */}
          {(()=>{
            const assignment = caseAssignments[activeCaseData.bridgeRoomId];
            if (!assignment || !orgRoom) return null;
            return <div style={{marginTop:10,padding:'10px 14px',background:'var(--bg-2)',border:'1px solid var(--border-0)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:10}}>
              <I n="briefcase" s={14} c="var(--gold)"/>
              <div style={{flex:1}}>
                <span style={{fontSize:11.5,fontWeight:600,display:'block'}}>Assigned to: {assignment.primary?.split(':')[0]?.replace('@','')}</span>
                {assignment.staff?.length > 1 && <span style={{fontSize:10,color:'var(--tx-2)'}}>
                  +{assignment.staff.length - 1} additional staff with access
                </span>}
                {assignment.transferred_from && <span style={{fontSize:9.5,color:'var(--tx-2)',fontFamily:'var(--mono)',display:'block',marginTop:2}}>
                  Transferred from {assignment.transferred_from.split(':')[0]?.replace('@','')} on {new Date(assignment.transferred_at).toLocaleDateString()}
                </span>}
              </div>
              {assignment.primary === svc.userId && <span className="tag tag-gold" style={{fontSize:8}}>YOU</span>}
            </div>;
          })()}
        </div>
        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">SHARED DATA — CLIENT CONTROLLED</span>
          {(()=>{
            const allFwFields = getFrameworkFields(FRAMEWORK_FIELD_STANDARDS.map(fw=>fw.id));
            const knownKeys = new Set([...VAULT_FIELDS.map(f=>f.key), ...allFwFields.map(f=>f.key)]);
            const fwFieldsByKey = {};
            allFwFields.forEach(f => { fwFieldsByKey[f.key] = f; });
            const customShared = Object.keys(activeCaseData.sharedData).filter(k=>!knownKeys.has(k));
            const sharedFwFields = allFwFields.filter(f => activeCaseData.sharedData[f.key]);
            return <>
              {FIELD_CATEGORIES.map(cat=>{const fields=VAULT_FIELDS.filter(f=>f.category===cat&&activeCaseData.sharedData[f.key]);
                if(!fields.length) return null;
                return <div key={cat} style={{marginBottom:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
                    <span style={{color:`var(--${CAT_COLORS[cat]})`}}><I n={CAT_ICONS[cat]} s={12}/></span>
                    <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.05em'}}>{CAT_LABELS[cat].toUpperCase()}</span></div>
                  {fields.map(f=><div key={f.key} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border-0)'}}>
                    <span style={{fontSize:12,color:'var(--tx-1)'}}>{f.label}</span>
                    <span style={{fontSize:12.5,fontWeight:500,maxWidth:260,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{activeCaseData.sharedData[f.key]}</span>
                  </div>)}
                </div>;})}
              {sharedFwFields.length>0&&<div style={{marginBottom:10}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
                  <span style={{color:'var(--blue)'}}><I n="grid" s={12}/></span>
                  <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.05em'}}>FRAMEWORK FIELDS</span></div>
                {sharedFwFields.map(f=><div key={f.key} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom:'1px solid var(--border-0)'}}>
                  <div style={{display:'flex',alignItems:'center',gap:6}}>
                    <span style={{fontSize:12,color:'var(--tx-1)'}}>{f.label}</span>
                    <span className={`tag tag-${FRAMEWORK_BY_ID[f.framework]?.accent||'blue'}`} style={{fontSize:7.5,padding:'1px 5px'}}>{f.frameworkName}</span>
                  </div>
                  <span style={{fontSize:12.5,fontWeight:500,maxWidth:220,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{activeCaseData.sharedData[f.key]}</span>
                </div>)}
              </div>}
              {customShared.length>0&&<div style={{marginBottom:10}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
                  <span style={{color:'var(--purple)'}}><I n="file" s={12}/></span>
                  <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.05em'}}>CLIENT CUSTOM FIELDS</span></div>
                {customShared.map(k=><div key={k} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border-0)'}}>
                  <span style={{fontSize:12,color:'var(--tx-1)'}}>{k.replace(/^custom_/,'').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</span>
                  <span style={{fontSize:12.5,fontWeight:500,maxWidth:260,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{activeCaseData.sharedData[k]}</span>
                </div>)}
              </div>}
            </>;
          })()}
          {Object.keys(activeCaseData.sharedData).length===0&&<p style={{color:'var(--tx-3)',fontSize:12,padding:'10px 0'}}>No fields shared yet</p>}
        </div>
        {/* GIVEN/MEANT DIVIDE — Record-level framework interpretations */}
        {provObservations.filter(obs => {
          const prompt = [...DEFAULT_PROMPTS,...DEFAULT_PROVIDER_PROMPTS].find(p=>p.id===obs.prompt_id||p.key===obs.prompt_key);
          return prompt && FRAMEWORK_BINDINGS[prompt.key]?.bindings?.[obs.value];
        }).length > 0 && <div style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
            <div style={{width:24,height:24,borderRadius:'50%',background:'linear-gradient(135deg,var(--teal),var(--gold))',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-0)',fontSize:11,fontWeight:800}}>&#8594;</div>
            <span style={{fontFamily:'var(--serif)',fontSize:15,fontWeight:700}}>GIVEN / MEANT Divide</span>
            <span className="gm-sup-badge">SUP</span>
          </div>
          <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Same observations, different institutional meanings. Each framework interprets the data according to its own rules.</p>
          <div style={{display:'flex',flexDirection:'column',gap:10}}>
            {provObservations.filter(obs => {
              const prompt = [...DEFAULT_PROMPTS,...DEFAULT_PROVIDER_PROMPTS].find(p=>p.id===obs.prompt_id||p.key===obs.prompt_key);
              return prompt && FRAMEWORK_BINDINGS[prompt.key]?.bindings?.[obs.value];
            }).map((obs,i) => {
              const prompt = [...DEFAULT_PROMPTS,...DEFAULT_PROVIDER_PROMPTS].find(p=>p.id===obs.prompt_id||p.key===obs.prompt_key);
              return <RecordGivenMeant key={obs.id||i} promptKey={prompt.key} value={obs.value}
                reporter={obs.author ? `${T.provider_term}: ${obs.author}` : `${T.provider_term} observation`}
                timestamp={obs.ts}/>;
            })}
          </div>
        </div>}
        {/* PROVIDER OBSERVATIONS (MEANT frame) */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}}>
            <span className="section-label" style={{marginBottom:0}}>{T.provider_term.toUpperCase()} OBSERVATIONS (MEANT)</span>
            <span className="tag tag-gold">EPISTEMIC: MEANT</span>
          </div>
          <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Structured assessments and case management observations. Each entry is an EO event in the bridge room with full provenance.</p>
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:6,marginBottom:12}}>
            {DEFAULT_PROVIDER_PROMPTS.map(p=><div key={p.id} className="card-h" onClick={()=>{setProvObsModal(p);setProvObsValue('');setProvObsNotes('')}}
              style={{padding:10}}>
              <div style={{display:'flex',alignItems:'center',gap:4,marginBottom:4,flexWrap:'wrap'}}>
                <span className={`tag tag-${OBS_CAT_COLORS[p.category]||'purple'}`} style={{fontSize:8.5}}>{p.category}</span>
                {p.maturity && <MaturityBadge maturity={p.maturity}/>}
                {p.source && <SourceBadge source={p.source}/>}
              </div>
              <span style={{fontSize:11.5,fontWeight:600,display:'block'}}>{p.question}</span>
            </div>)}
          </div>
          {provObservations.length>0&&<>
            <span className="section-label">RECORDED ({provObservations.length})</span>
            <div style={{display:'flex',flexDirection:'column',gap:3,marginTop:4}}>
              {[...provObservations].reverse().map((obs,i)=>{
                const prompt = DEFAULT_PROVIDER_PROMPTS.find(p=>p.id===obs.prompt_id||p.key===obs.prompt_key);
                const optLabel = prompt?.options?.find(o=>o.v===obs.value)?.l || obs.value;
                return <div key={obs.id||i} style={{padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:8}}>
                  <span className={`tag tag-${OBS_CAT_COLORS[prompt?.category]||'purple'}`} style={{fontSize:8.5}}>{prompt?.category||'obs'}</span>
                  <span className="tag tag-gold" style={{fontSize:8}}>MEANT</span>
                  <span style={{fontSize:11.5,flex:1}}>{prompt?.question}: <strong>{optLabel}</strong></span>
                  {obs.notes&&<span style={{fontSize:10,color:'var(--tx-2)',fontStyle:'italic'}}>{obs.notes}</span>}
                  <span style={{fontSize:9,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{obs.ts?new Date(obs.ts).toLocaleTimeString():''}</span>
                </div>;
              })}
            </div>
          </>}
        </div>

        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">REQUEST INFORMATION</span>
          <div style={{display:'flex',gap:6}}>
            <input value={requestText} onChange={e=>setRequestText(e.target.value)} placeholder="e.g. Could you share employment docs?" onKeyDown={e=>{if(e.key==='Enter')handleSendRequest()}}/>
            <button onClick={handleSendRequest} className="b-pri" style={{whiteSpace:'nowrap'}}><I n="send" s={12}/>Request</button>
          </div>
        </div>
        <div className="card">
          <span className="section-label">BRIDGE MESSAGES</span>
          <div style={{maxHeight:260,overflow:'auto',marginBottom:12}}>
            {messages.length===0?<p style={{color:'var(--tx-3)',fontSize:12,padding:'12px 0',textAlign:'center'}}>No messages</p>
            :messages.map((msg,i)=><div key={msg.id||i} style={{padding:'8px 0',borderBottom:'1px solid var(--border-0)'}}>
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
                <span style={{fontFamily:'var(--mono)',fontSize:10,color:msg.sender===svc.userId?'var(--gold)':'var(--teal)'}}>{msg.sender===svc.userId?`You (${T.provider_term})`:T.client_term}</span>
                <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleString():''}</span></div>
              <p style={{fontSize:12.5,color:'var(--tx-1)'}}>{msg.content?.body}</p>
            </div>)}
          </div>
          <div style={{display:'flex',gap:6}}>
            <input value={msgText} onChange={e=>setMsgText(e.target.value)} placeholder="Message (E2EE)..." onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey)handleSendMsg()}} style={{flex:1}}/>
            <button onClick={handleSendMsg} className="b-pri"><I n="send" s={13}/></button>
          </div>
        </div>
      </div>}

      {/* METRICS DASHBOARD (§B.5) */}
      {view==='metrics'&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>Metrics Dashboard</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:20}}>Anonymized, aggregate data from consenting clients. No PII — names, DOBs, SSNs, and addresses are never present.</p>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(170px,1fr))',gap:10,marginBottom:20}}>
          {[{l:'Metric Events',v:metrics.length,c:'orange'},{l:'Unique Cohorts',v:new Set(metrics.map(m=>m.cohort_hash)).size,c:'blue'},
            {l:'Categories',v:Object.keys(metricsByCategory).length,c:'teal'}
          ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
            <span style={{fontSize:18,fontWeight:700,color:`var(--${s.c})`}}>{s.v}</span></div>)}
        </div>
        {Object.keys(metricsByCategory).length===0?
          <div className="card" style={{textAlign:'center',padding:'30px',borderStyle:'dashed'}}><I n="bar" s={28}/><p style={{color:'var(--tx-3)',marginTop:8}}>No metric events yet. Clients must consent to anonymized reporting.</p></div>
        :Object.entries(metricsByCategory).map(([cat,vals])=><div key={cat} className="card" style={{marginBottom:12}}>
          <span className="section-label">{cat.toUpperCase()}</span>
          <div style={{display:'flex',flexDirection:'column',gap:4,marginTop:6}}>
            {Object.entries(vals).sort((a,b)=>b[1]-a[1]).map(([val,count])=>{
              const max = Math.max(...Object.values(vals));
              return <div key={val} style={{display:'flex',alignItems:'center',gap:8}}>
                <span style={{fontSize:11.5,width:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{val}</span>
                <div style={{flex:1,height:16,background:'var(--bg-3)',borderRadius:3,overflow:'hidden'}}>
                  <div style={{width:`${(count/max)*100}%`,height:'100%',background:'var(--teal)',borderRadius:3,transition:'width .3s'}}/>
                </div>
                <span style={{fontSize:11,fontFamily:'var(--mono)',color:'var(--tx-1)',minWidth:30,textAlign:'right'}}>{count}</span>
              </div>;
            })}
          </div>
        </div>)}
        {/* DEMOGRAPHIC RANGES from imported/consented data */}
        {(()=>{
          const demoAgg = {};
          metrics.forEach(m => {
            if (!m.demographics) return;
            for (const [k,v] of Object.entries(m.demographics)) {
              if (!v) return;
              if (!demoAgg[k]) demoAgg[k] = {};
              demoAgg[k][v] = (demoAgg[k][v]||0) + 1;
            }
          });
          return Object.keys(demoAgg).length > 0 ? <div className="card" style={{marginTop:12}}>
            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
              <span className="section-label" style={{marginBottom:0}}>DEMOGRAPHIC RANGES</span>
              <span className="tag tag-green" style={{fontSize:8}}><I n="shieldCheck" s={8}/>NO PII</span>
            </div>
            <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Aggregated from anonymized transforms. Names, DOBs, SSNs, addresses, phones, and emails are cryptographically blocked — only bucketed ranges appear.</p>
            {Object.entries(demoAgg).map(([cat,vals])=><div key={cat} style={{marginBottom:8}}>
              <span style={{fontSize:10.5,fontWeight:600,color:'var(--tx-1)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.05em'}}>{cat}</span>
              <div style={{display:'flex',flexDirection:'column',gap:3,marginTop:4}}>
                {Object.entries(vals).sort((a,b)=>b[1]-a[1]).map(([val,count])=>{
                  const max = Math.max(...Object.values(vals));
                  return <div key={val} style={{display:'flex',alignItems:'center',gap:8}}>
                    <span style={{fontSize:11,width:140,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{val}</span>
                    <div style={{flex:1,height:14,background:'var(--bg-3)',borderRadius:3,overflow:'hidden'}}>
                      <div style={{width:`${(count/max)*100}%`,height:'100%',background:'var(--green)',borderRadius:3,transition:'width .3s'}}/>
                    </div>
                    <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-1)',minWidth:24,textAlign:'right'}}>{count}</span>
                  </div>;
                })}
              </div>
            </div>)}
          </div> : null;
        })()}

        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'12px 16px',marginTop:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--teal)'}}>K-anonymity (k=5):</strong> Combinations with fewer than 5 matching individuals are suppressed. This data is suitable for compliance reporting and aggregate analysis. PII fields (name, DOB, SSN, address, phone, email) are never present — only demographic ranges and hashed identifiers.
        </div>
      </div>}

      {/* SCHEMA BUILDER — Three-zone layout with sidebar, canvas, context panel */}
      {view==='schema'&&<SchemaView isOrg={!!orgRoom} orgMeta={orgMeta} networkMembers={networkMembers}/>}

      {/* ORG SETTINGS VIEW (admin only) */}
      {view==='org-settings'&&orgRoom&&orgRole==='admin'&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>Organization Settings</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:24}}>Manage your organization metadata, privacy, and inter-org messaging configuration.</p>
        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">ORGANIZATION DETAILS</span>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginTop:8}}>
            {[{l:'Name',v:orgMeta.name||'—'},{l:'Type',v:ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type||'—'},
              {l:'Service Area',v:orgMeta.service_area||'—'},{l:'Languages',v:(orgMeta.languages||[]).join(', ')||'—'},
              {l:'Staff',v:`${staff.length} members`},{l:'Room',v:orgRoom?.slice(0,24)+'…'}
            ].map((s,i)=><div key={i}><span className="section-label">{s.l.toUpperCase()}</span>
              <span style={{fontSize:13,fontWeight:500,display:'block'}}>{s.v}</span></div>)}
          </div>
        </div>

        {/* TERMINOLOGY CUSTOMIZATION */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <I n="settings" s={16} c="var(--gold)"/>
              <span className="section-label" style={{marginBottom:0}}>TERMINOLOGY</span>
              {(T.client_term!=='Client'||T.provider_term!=='Provider')&&<span className="tag tag-gold" style={{fontSize:8}}>CUSTOMIZED</span>}
            </div>
            <button onClick={()=>{setTerminologyDraft({...orgTerminology});setTerminologyModal(true)}} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="settings" s={11}/>Customize</button>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:14,lineHeight:1.6}}>
            Customize what your organization calls its service recipients and service providers. These terms appear throughout the interface for all staff in your organization.
          </p>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
            <div style={{padding:'12px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>SERVICE RECIPIENT</span>
              <span style={{fontSize:15,fontWeight:700,display:'block'}}>{T.client_term}</span>
              <span style={{fontSize:11,color:'var(--tx-2)'}}>Plural: {T.client_term_plural}</span>
            </div>
            <div style={{padding:'12px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>SERVICE PROVIDER</span>
              <span style={{fontSize:15,fontWeight:700,display:'block'}}>{T.provider_term}</span>
              <span style={{fontSize:11,color:'var(--tx-2)'}}>Plural: {T.provider_term_plural}</span>
            </div>
          </div>
          {(T.client_term!=='Client'||T.provider_term!=='Provider')&&<div style={{marginTop:10,padding:'8px 12px',background:'var(--gold-dim)',borderRadius:'var(--r)',fontSize:11,color:'var(--gold)',display:'flex',alignItems:'center',gap:6}}>
            <I n="alert" s={12} c="var(--gold)"/>
            Custom terminology active — staff will see "{T.client_term}" and "{T.provider_term}" instead of the defaults.
          </div>}
        </div>

        {/* OPACITY SETTINGS */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
            <I n="eyeOff" s={16} c="var(--purple)"/>
            <span className="section-label" style={{marginBottom:0}}>ORGANIZATION OPACITY</span>
            <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:9}}>{OPACITY_LABELS[orgOpacity]?.toUpperCase()}</span>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:14,lineHeight:1.6}}>
            Controls how much of your organization's identity is revealed when communicating with other organizations. This affects all outgoing inter-org messages.
          </p>
          <div style={{display:'flex',flexDirection:'column',gap:8}}>
            {OPACITY_LEVELS.map(level => <div key={level} onClick={()=>handleSaveOpacity(level)}
              style={{padding:'14px 16px',borderRadius:'var(--r-lg)',cursor:'pointer',
                border:`2px solid ${orgOpacity===level?'var(--gold)':'var(--border-1)'}`,
                background:orgOpacity===level?'var(--gold-dim)':'var(--bg-3)',transition:'all .18s'}}
              onMouseEnter={e=>{if(orgOpacity!==level)e.currentTarget.style.borderColor='var(--border-2)'}}
              onMouseLeave={e=>{if(orgOpacity!==level)e.currentTarget.style.borderColor='var(--border-1)'}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
                <span style={{width:10,height:10,borderRadius:'50%',border:`2px solid ${orgOpacity===level?'var(--gold)':'var(--tx-3)'}`,
                  background:orgOpacity===level?'var(--gold)':'transparent',flexShrink:0}}/>
                <span style={{fontSize:14,fontWeight:700,color:orgOpacity===level?'var(--gold)':'var(--tx-0)'}}>{OPACITY_LABELS[level]}</span>
                {level==='opaque'&&<span className="tag tag-red" style={{fontSize:8}}>MAX PRIVACY</span>}
                {level==='translucent'&&<span className="tag tag-gold" style={{fontSize:8}}>RECOMMENDED</span>}
                {level==='transparent'&&<span className="tag tag-green" style={{fontSize:8}}>OPEN</span>}
              </div>
              <p style={{fontSize:11.5,color:'var(--tx-2)',lineHeight:1.5,marginLeft:18}}>{OPACITY_DESCRIPTIONS[level]}</p>
              {/* Preview of what external org sees */}
              <div style={{marginTop:8,marginLeft:18,padding:'8px 12px',background:'var(--bg-1)',borderRadius:'var(--r)',border:'1px solid var(--border-0)'}}>
                <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:4}}>EXTERNAL ORG SEES:</span>
                <span style={{fontSize:11,color:'var(--tx-1)'}}>
                  {level==='transparent'?`"${providerProfile.display_name||'Jamie R.'} from ${orgMeta.name||'Your Org'}"`
                  :level==='translucent'?`"${orgMeta.name||'Your Org'}"`
                  :'"An organization"'}
                </span>
              </div>
            </div>)}
          </div>
        </div>

        {/* MESSAGE ACCESS CONTROLS */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <I n="lock" s={16} c="var(--blue)"/>
              <span className="section-label" style={{marginBottom:0}}>INTER-ORG MESSAGE ACCESS</span>
            </div>
            <button onClick={()=>{setMsgAccessDraft({...orgMsgAccess});setMsgAccessModal(true)}} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="settings" s={11}/>Configure</button>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:12,lineHeight:1.6}}>
            Control which staff roles can read and respond to messages sent to your organization from other organizations.
          </p>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
            <div style={{padding:'10px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>CAN READ</span>
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                {orgMsgAccess.read?.map(r=><span key={r} className="tag tag-blue" style={{fontSize:9}}>{ORG_ROLE_LABELS[r]||r}</span>)}
                {(!orgMsgAccess.read||orgMsgAccess.read.length===0)&&<span style={{fontSize:10,color:'var(--tx-3)',fontStyle:'italic'}}>No roles assigned</span>}
              </div>
            </div>
            <div style={{padding:'10px 14px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>CAN RESPOND</span>
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                {orgMsgAccess.respond?.map(r=><span key={r} className="tag tag-gold" style={{fontSize:9}}>{ORG_ROLE_LABELS[r]||r}</span>)}
                {(!orgMsgAccess.respond||orgMsgAccess.respond.length===0)&&<span style={{fontSize:10,color:'var(--tx-3)',fontStyle:'italic'}}>No roles assigned</span>}
              </div>
            </div>
          </div>
        </div>

        {/* ORG MESSAGING CHANNELS */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <I n="msg" s={16} c="var(--teal)"/>
              <span className="section-label" style={{marginBottom:0}}>MESSAGING CHANNELS ({orgChannels.length})</span>
            </div>
            <button onClick={()=>setComposeOrgModal(true)} className="b-pri b-sm" style={{display:'flex',alignItems:'center',gap:4}}><I n="plus" s={12}/>New Channel</button>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-2)',marginBottom:10,lineHeight:1.6}}>
            Secure encrypted channels for org-to-org communication. Messages are governed by your opacity setting.
          </p>
          {orgChannels.length===0?<div style={{textAlign:'center',padding:'20px 0'}}>
            <I n="msg" s={24}/>
            <p style={{color:'var(--tx-3)',fontSize:11,marginTop:6}}>No messaging channels yet. Create one to start communicating with another organization.</p>
          </div>
          :<div style={{display:'flex',flexDirection:'column',gap:4}}>
            {orgChannels.map(ch=>{
              const peerOrgId = ch.orgs?.find(o=>o!==orgRoom);
              const peerName = ch.org_names?.[peerOrgId]||peerOrgId?.slice(0,20)||'Unknown Org';
              return <div key={ch.roomId} onClick={()=>openChannel(ch.roomId)}
                className="card-h" style={{padding:'10px 14px'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <div style={{width:28,height:28,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)'}}><I n="msg" s={14}/></div>
                    <div>
                      <span style={{fontSize:12.5,fontWeight:600,display:'block'}}>{peerName}</span>
                      <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{ch.roomId?.slice(0,20)}…</span>
                    </div>
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:6}}>
                    <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:8}}>{OPACITY_LABELS[orgOpacity]}</span>
                    <I n="chevR" s={13} c="var(--tx-3)"/>
                  </div>
                </div>
              </div>;
            })}
          </div>}
        </div>

        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">ORG ROOM ID</span>
          <div style={{fontFamily:'var(--mono)',fontSize:11,color:'var(--tx-1)',background:'var(--bg-3)',padding:'8px 12px',borderRadius:'var(--r)',wordBreak:'break-all',marginTop:4}}>{orgRoom}</div>
          <p style={{fontSize:11,color:'var(--tx-2)',marginTop:8}}>Share this room ID with providers who want to join your organization, or with other orgs to open a messaging channel.</p>
        </div>

        {/* EMAIL VERIFICATION CONFIGURATION */}
        <div className="card" style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <I n="shieldCheck" s={16} c={emailVerifyConfig.enabled ? 'var(--green)' : 'var(--tx-3)'}/>
              <span className="section-label" style={{margin:0}}>EMAIL VERIFICATION</span>
              <span className={`tag ${emailVerifyConfig.enabled ? 'tag-green' : 'tag-gold'}`} style={{fontSize:8}}>
                {emailVerifyConfig.enabled ? 'ENABLED' : 'DISABLED'}
              </span>
            </div>
            <button onClick={()=>{setEmailConfigDraft({...emailVerifyConfig});setEmailConfigModal(true)}} className="b-gho b-xs">
              <I n="settings" s={11}/> Configure
            </button>
          </div>
          {emailVerifyConfig.enabled ? <div>
            <p style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6,marginBottom:8}}>
              Staff members must verify their identity via email before accessing cases. Verification confirms they control an email address at an approved domain.
            </p>
            {emailVerifyConfig.required_domains?.length > 0 && <div style={{marginBottom:8}}>
              <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginBottom:4}}>APPROVED DOMAINS</span>
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                {emailVerifyConfig.required_domains.map((d,i)=><span key={i} className="tag tag-blue" style={{fontSize:9}}>@{d}</span>)}
              </div>
            </div>}
            <div style={{marginBottom:8}}>
              <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginBottom:4}}>REQUIRED FOR ROLES</span>
              <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                {emailVerifyConfig.require_for_roles?.map((r,i)=><span key={i} className="tag tag-gold" style={{fontSize:9}}>{ORG_ROLE_LABELS[r]||r}</span>)}
              </div>
            </div>
            <div style={{fontSize:10,color:'var(--tx-3)'}}>
              Grace period: {emailVerifyConfig.grace_period_hours}h · {staff.filter(s=>s.email_verification?.status==='verified').length}/{staff.length} verified
            </div>
          </div> : <p style={{fontSize:11.5,color:'var(--tx-2)',lineHeight:1.6}}>
            Email verification is disabled. Enable it to require staff members to confirm their identity with an organization email address before accessing cases.
          </p>}
        </div>
      </div>}

      {/* STAFF ROSTER VIEW */}
      {view==='staff'&&orgRoom&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
          <div><h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Staff Roster</h2>
            <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>Manage staff membership and roles. Each role determines case access level.</p></div>
          {orgRole==='admin'&&<button onClick={()=>setInviteModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>Invite Staff</button>}
        </div>
        <div className="card" style={{marginBottom:16}}>
          <span className="section-label">ROLE DEFINITIONS</span>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginTop:6}}>
            {ORG_ROLES.map(r=><div key={r} style={{padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <span className="tag tag-blue" style={{fontSize:9,marginBottom:4}}>{ORG_ROLE_LABELS[r]}</span>
              <p style={{fontSize:10.5,color:'var(--tx-2)',marginTop:2}}>
                {r==='admin'?'Full access. Manage staff, see all cases, configure schema.':
                 r==='case_manager'?'Assigned cases only. Full read/write on assigned bridges.':
                 r==='field_worker'?'Assigned cases. Record encounters. Limited to own observations.':
                 r==='intake_coordinator'?'Create new bridges. Run intake assessments. Route to case managers.':
                 'View aggregate dashboards only. No PII access.'}
              </p>
            </div>)}
          </div>
        </div>
        <div className="card">
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <span className="section-label">CURRENT STAFF ({staff.length})</span>
            {emailVerifyConfig.enabled && <span style={{fontSize:10,color:'var(--tx-3)'}}>
              {staff.filter(s=>s.email_verification?.status==='verified').length} of {staff.length} verified
            </span>}
          </div>
          <div style={{display:'flex',flexDirection:'column',gap:4,marginTop:6}}>
            {staff.map(s=>{
              const ev = s.email_verification;
              const needsVerify = emailVerifyConfig.enabled && EmailVerification.needsVerification(emailVerifyConfig, s);
              const isMe = s.userId === svc.userId;
              return <div key={s.userId} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'10px 0',borderBottom:'1px solid var(--border-0)'}}>
              <div>
                <div style={{display:'flex',alignItems:'center',gap:6}}>
                  <span style={{fontSize:13,fontWeight:500}}>{s.userId}</span>
                  {ev?.status==='verified' && <span className="tag tag-green" style={{fontSize:8}}>VERIFIED</span>}
                  {needsVerify && !ev && <span className="tag tag-gold" style={{fontSize:8}}>UNVERIFIED</span>}
                  {ev?.status==='pending' && <span className="tag tag-gold" style={{fontSize:8}}>PENDING</span>}
                  {ev?.status==='revoked' && <span className="tag tag-red" style={{fontSize:8}}>REVOKED</span>}
                </div>
                <span style={{fontSize:10,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>
                  Joined {s.joined?new Date(s.joined).toLocaleDateString():'—'}
                  {ev?.status==='verified' && ev.email && <> · {ev.email}</>}
                </span>
              </div>
              <div style={{display:'flex',gap:6,alignItems:'center'}}>
                <span className={`tag ${s.role==='admin'?'tag-gold':'tag-blue'}`} style={{fontSize:9}}>{ORG_ROLE_LABELS[s.role]}</span>
                {isMe && needsVerify && ev?.status!=='verified' && <button onClick={openEmailVerifyModal} className="b-pri b-xs" style={{fontSize:10}}>Verify Email</button>}
                {orgRole==='admin' && ev?.status==='verified' && s.userId!==svc.userId && <button onClick={()=>handleRevokeVerification(s.userId)} className="b-gho b-xs" title="Revoke verification"><I n="x" s={10}/></button>}
                {orgRole==='admin'&&s.userId!==svc.userId&&<button onClick={()=>handleRemoveStaff(s.userId)} className="b-gho b-xs" style={{color:'var(--red)'}}><I n="trash" s={11}/></button>}
              </div>
            </div>})}
          </div>
        </div>
        {/* Verification prompt for current user */}
        {emailVerifyConfig.enabled && myVerification?.status!=='verified' && EmailVerification.needsVerification(emailVerifyConfig, {role:orgRole, email_verification:myVerification}) && <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:16}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
            <I n="alert" s={16} c="var(--gold)"/>
            <span style={{fontSize:13,fontWeight:700,color:'var(--gold)'}}>Email Verification Required</span>
          </div>
          <p style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6,marginBottom:10}}>
            Your organization requires email verification for your role ({ORG_ROLE_LABELS[orgRole]}). Verify your identity with an approved email address{emailVerifyConfig.required_domains?.length > 0 ? ` (${emailVerifyConfig.required_domains.map(d=>'@'+d).join(', ')})` : ''}.
          </p>
          <button onClick={openEmailVerifyModal} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}>
            <I n="shieldCheck" s={14}/> Verify My Email
          </button>
        </div>}
      </div>}

      {/* NETWORK VIEW (Addendum E) — org-to-org relationships */}
      {view==='network'&&<div className="anim-up" style={{maxWidth:820,margin:'0 auto'}}>
        <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700,marginBottom:4}}>Network</h2>
        <p style={{color:'var(--tx-1)',fontSize:12.5,marginBottom:20}}>Networks are org-to-org relationships. Organizations join voluntarily; the network defines shared vocabulary that propagates.</p>

        {!orgRoom?<div>
          <div className="card" style={{textAlign:'center',padding:'30px',borderStyle:'dashed'}}>
            <I n="users" s={32}/><p style={{color:'var(--tx-2)',marginTop:8,marginBottom:8}}>Create or join an organization to participate in networks</p>
            <p style={{fontSize:11,color:'var(--tx-3)'}}>Networks are org-to-org relationships. An independent provider who wants to join a network first needs to create an organization.</p>
          </div>
        </div>
        :!networkRoom?<div>
          <div className="card" style={{textAlign:'center',padding:'30px',borderStyle:'dashed',marginBottom:16}}>
            <I n="globe" s={32}/><p style={{color:'var(--tx-2)',marginTop:8}}>Not part of a network yet</p>
            <p style={{fontSize:11,color:'var(--tx-3)',marginTop:4}}>Your org "{orgMeta.name}" can create or join a network.</p>
          </div>
          <div style={{display:'flex',gap:10}}>
            <button onClick={()=>setNetworkModal(true)} className="b-pri" style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
              <I n="plus" s={14}/>Create Network</button>
            <button onClick={()=>setJoinNetworkModal(true)} className="b-gho" style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
              <I n="globe" s={14}/>Join Network</button>
          </div>
        </div>
        :<div>
          <div className="card" style={{marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <span className="tag tag-green"><I n="globe" s={10}/>NETWORK</span>
                <span style={{fontSize:15,fontWeight:700}}>Connected</span>
                <span className={`tag ${networkRole==='admin'?'tag-gold':'tag-blue'}`} style={{fontSize:9}}>{networkRole==='admin'?'ADMIN':'MEMBER'}</span>
              </div>
              <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)'}}>{networkRoom.slice(0,24)}…</span>
            </div>

            {/* Network Admin controls */}
            {networkRole==='admin'&&<div style={{marginBottom:16}}>
              <span className="section-label">NETWORK ADMINISTRATION</span>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginTop:6}}>
                <div style={{padding:'10px 14px',background:'var(--gold-dim)',borderRadius:'var(--r)',border:'1px solid var(--gold-mid)'}}>
                  <span style={{fontSize:11,fontWeight:600,color:'var(--gold)',display:'block',marginBottom:2}}>Invite Organization</span>
                  <span style={{fontSize:10,color:'var(--tx-2)'}}>Invite orgs by room ID or token</span>
                </div>
                <div style={{padding:'10px 14px',background:'var(--purple-dim)',borderRadius:'var(--r)',border:'1px solid rgba(167,139,250,.15)'}}>
                  <span style={{fontSize:11,fontWeight:600,color:'var(--purple)',display:'block',marginBottom:2}}>Schema Proposals</span>
                  <span style={{fontSize:10,color:'var(--tx-2)'}}>Review pending schema changes</span>
                </div>
                <div style={{padding:'10px 14px',background:'var(--blue-dim)',borderRadius:'var(--r)',border:'1px solid rgba(91,156,245,.15)'}}>
                  <span style={{fontSize:11,fontWeight:600,color:'var(--blue)',display:'block',marginBottom:2}}>Authority Catalog</span>
                  <span style={{fontSize:10,color:'var(--tx-2)'}}>Shared external authorities</span>
                </div>
                <div style={{padding:'10px 14px',background:'var(--teal-dim)',borderRadius:'var(--r)',border:'1px solid rgba(62,201,176,.15)'}}>
                  <span style={{fontSize:11,fontWeight:600,color:'var(--teal)',display:'block',marginBottom:2}}>Metrics Aggregation</span>
                  <span style={{fontSize:10,color:'var(--tx-2)'}}>Configure cross-org aggregation</span>
                </div>
              </div>
            </div>}

            <span className="section-label">MEMBER ORGANIZATIONS ({networkMembers.length})</span>
            <div style={{display:'flex',flexDirection:'column',gap:4}}>
              {networkMembers.map((m,i)=><div key={i} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid var(--border-0)'}}>
                <div>
                  <span style={{fontSize:12,fontWeight:500}}>{m.name||m.id}</span>
                  {m.name&&<span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)',display:'block'}}>{m.id}</span>}
                </div>
                <div style={{display:'flex',gap:6,alignItems:'center'}}>
                  <span className={`tag ${m.role==='admin'?'tag-gold':'tag-blue'}`} style={{fontSize:9}}>{m.role}</span>
                  {networkRole==='admin'&&m.role!=='admin'&&<button className="b-gho b-xs" style={{color:'var(--red)'}}><I n="trash" s={10}/></button>}
                </div>
              </div>)}
            </div>
          </div>

          {/* Schema Commons — Network schema catalog organized by forms + interpretations */}
          <div className="card" style={{marginBottom:16}}>
            <span className="section-label">SCHEMA COMMONS</span>
            <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Network schema organized into forms (GIVEN data collection) and interpretations (MEANT frameworks). Forms propagate to member organizations and down to clients through providers.</p>

            {/* Forms — GIVEN data collection */}
            <div style={{marginBottom:14}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                <span style={{fontSize:11,fontFamily:'var(--mono)',color:'var(--teal)',fontWeight:600,letterSpacing:'.05em'}}>FORMS</span>
                <span className="tag tag-teal" style={{fontSize:8}}>GIVEN</span>
              </div>
              <div style={{display:'flex',flexDirection:'column',gap:6}}>
                {DEFAULT_FORMS.map(f=><div key={f.id} style={{background:'var(--bg-3)',borderRadius:'var(--r)',border:'1px solid var(--border-0)',overflow:'hidden'}}>
                  <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 12px',borderBottom:'1px solid var(--border-0)'}}>
                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                      <span style={{fontSize:12,fontWeight:600}}>{f.name}</span>
                      <span style={{fontSize:10,color:'var(--tx-2)'}}>{f.fields.length} field{f.fields.length!==1?'s':''}</span>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:6}}>
                      <MaturityBadge maturity={f.maturity || 'normative'}/>
                      <SourceBadge source={f.source || {level:'network',propagation:'standard'}}/>
                    </div>
                  </div>
                  <div style={{padding:'4px 12px'}}>
                    {f.fields.map(p=><div key={p.key} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border-0)'}}>
                      <span style={{fontSize:11.5,color:'var(--tx-1)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.question}</span>
                      <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)',flexShrink:0,marginLeft:8}}>{p.type}</span>
                    </div>)}
                  </div>
                </div>)}
              </div>
            </div>

            {/* Interpretations — MEANT frameworks */}
            <div>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                <span style={{fontSize:11,fontFamily:'var(--mono)',color:'var(--gold)',fontWeight:600,letterSpacing:'.05em'}}>INTERPRETATIONS</span>
                <span className="tag tag-gold" style={{fontSize:8}}>MEANT</span>
              </div>
              <div style={{display:'flex',flexDirection:'column',gap:4}}>
                {DEFAULT_PROVIDER_PROMPTS.map(p=><div key={p.key} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,flex:1,minWidth:0}}>
                    <span style={{fontSize:12,fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.question}</span>
                    <span className="tag tag-gold" style={{fontSize:8}}>ASSESSMENT</span>
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}>
                    <MaturityBadge maturity={p.maturity || 'normative'}/>
                    <SourceBadge source={p.source || {level:'network',propagation:'standard'}}/>
                  </div>
                </div>)}
                {DEFAULT_DEFINITIONS.map(d=><div key={d.key} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,flex:1,minWidth:0}}>
                    <span style={{fontSize:12,fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{d.name}</span>
                    <span className="tag tag-purple" style={{fontSize:8}}>CLASSIFICATION</span>
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}>
                    <MaturityBadge maturity={d.maturity || 'normative'}/>
                    <SourceBadge source={d.source || {level:'network',propagation:'required'}}/>
                  </div>
                </div>)}
              </div>
            </div>
          </div>

          {/* Adoption metrics (MVP §Screen 4B — ambient monitoring) */}
          <AdoptionMetrics adopted={DEFAULT_FORMS.length + DEFAULT_DEFINITIONS.length + DEFAULT_PROVIDER_PROMPTS.length}
            total={DEFAULT_FORMS.length + DEFAULT_DEFINITIONS.length + DEFAULT_PROVIDER_PROMPTS.length + 2}
            extensions={1} divergences={0}/>

          {/* Propagation model reference */}
          <div className="card" style={{marginBottom:16,marginTop:16}}>
            <span className="section-label">PROPAGATION MODEL (CON SEMANTICS)</span>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginTop:6}}>
              {Object.values(PROPAGATION_LEVELS).map(p=><div key={p.id} style={{padding:'8px 12px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
                <span className={`tag tag-${p.color}`} style={{marginBottom:4,fontSize:9}}>{p.label.toUpperCase()}</span>
                <p style={{fontSize:11,color:'var(--tx-2)',marginTop:2}}>{p.desc}</p>
              </div>)}
            </div>
          </div>

          {/* Active Proposals (MVP §Screen 5B) */}
          <div className="card" style={{marginBottom:16}}>
            <span className="section-label">ACTIVE PROPOSALS</span>
            <p style={{fontSize:11,color:'var(--tx-2)',marginBottom:10}}>Consent-based governance. Required/standard proposals trigger a consent round; recommended/optional use lazy consensus.</p>
            {/* Example proposal — in production these come from GOV_PROPOSAL events in the network room */}
            <ProposalCard proposal={{
              proposal_id: 'prop_example_001',
              type: 'add_field',
              summary: 'Add "safe parking program" as a network-standard option for sleep location',
              detail: 'Multiple orgs already track this locally. Formalizing ensures consistent reporting across the network.',
              proposed_by: '@steward:khora.io',
              proposed_at: Date.now() - 86400000 * 3,
              target_propagation: 'standard',
              target_maturity: 'trial',
              governance_rhythm: 'monthly_review',
              deadline: Date.now() + 86400000 * 4,
              status: 'consent_round',
              positions: {
                '!org_a:khora.io': { position: 'adopt_as_is', at: Date.now() - 86400000 * 2 },
                '!org_b:khora.io': { position: 'adopt_with_extension', at: Date.now() - 86400000, note: 'Will add "safe lot" sub-type' },
                '!org_c:khora.io': null,
                '!org_d:khora.io': null,
              }
            }}/>
            <div style={{textAlign:'center',padding:'12px',fontSize:11,color:'var(--tx-3)'}}>
              Active proposals from the network room will appear here. Proposals use consent-based governance — not majority voting.
            </div>
          </div>

          {/* Governance Calendar (MVP §Screen 5C) */}
          <div style={{marginBottom:16}}>
            <GovernanceCalendar/>
          </div>

          {/* De facto detection placeholder (MVP §Screen 5A) */}
          <div style={{marginBottom:16}}>
            <DeFactoAlert fieldName="safe parking" orgCount={4} totalOrgs={5}
              onFormalize={()=>showToast('Proposal creation flow coming in Phase 3','info')}
              onDismiss={()=>showToast('Dismissed','info')}/>
          </div>

          {/* Member-specific actions */}
          {networkRole!=='admin'&&<div style={{display:'flex',gap:8}}>
            <button className="b-gho" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={13}/>Propose Schema Change</button>
            <button className="b-red b-sm" style={{marginLeft:'auto'}}>Leave Network</button>
          </div>}

          <div style={{background:'var(--green-dim)',border:'1px solid rgba(61,214,140,.15)',borderRadius:'var(--r)',padding:'12px 16px',fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6,marginTop:16}}>
            <strong style={{color:'var(--green)'}}>Polycentric governance:</strong> Shared prompts propagate Network → Org → Provider → Client. Observations vary locally; interpretations feeding into shared metrics use network-level definitions for consistency.
          </div>
        </div>}
      </div>}

      {/* ORG INBOX — Inter-org messaging view */}
      {view==='org-inbox'&&orgRoom&&<div className="anim-up" style={{maxWidth:860,margin:'0 auto'}}>
        {!activeChannel ? <>
          {/* Channel list */}
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:24}}>
            <div>
              <h2 style={{fontFamily:'var(--serif)',fontSize:22,fontWeight:700}}>Organization Inbox</h2>
              <p style={{color:'var(--tx-1)',fontSize:12.5,marginTop:4}}>
                Encrypted org-to-org messaging. Your opacity is set to <strong style={{color:orgOpacity==='opaque'?'var(--red)':orgOpacity==='translucent'?'var(--gold)':'var(--green)'}}>{OPACITY_LABELS[orgOpacity]}</strong>.
                {orgRole==='admin'&&<span style={{color:'var(--tx-3)'}}> — change in Org Settings</span>}
              </p>
            </div>
            <button onClick={()=>setComposeOrgModal(true)} className="b-pri" style={{display:'flex',alignItems:'center',gap:6}}><I n="plus" s={14}/>New Channel</button>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(160px,1fr))',gap:10,marginBottom:20}}>
            {[{l:'Channels',v:orgChannels.length,c:'teal',i:'msg'},
              {l:'Opacity',v:OPACITY_LABELS[orgOpacity],c:orgOpacity==='opaque'?'red':orgOpacity==='translucent'?'gold':'green',i:'eyeOff'},
              {l:'Your Role',v:ORG_ROLE_LABELS[orgRole]||orgRole,c:'blue',i:'user'},
            ].map((s,i)=><div key={i} className="card" style={{padding:14}}><span className="section-label">{s.l.toUpperCase()}</span>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:2}}>
                <span style={{fontSize:16,fontWeight:700}}>{s.v}</span>
                <span style={{color:`var(--${s.c})`,opacity:.5}}><I n={s.i} s={15}/></span></div></div>)}
          </div>
          {orgChannels.length===0?
            <div className="card" style={{textAlign:'center',padding:'40px 20px',borderStyle:'dashed'}}>
              <I n="msg" s={32}/>
              <p style={{color:'var(--tx-2)',marginTop:10,fontSize:13}}>No messaging channels</p>
              <p style={{color:'var(--tx-3)',fontSize:11.5,marginTop:4}}>Create a channel to start communicating with another organization.</p>
              <button onClick={()=>setComposeOrgModal(true)} className="b-pri" style={{marginTop:14}}><I n="plus" s={14}/>New Channel</button>
            </div>
          :<div className="card" style={{padding:0,overflow:'hidden'}}>
            <div style={{padding:'10px 16px',background:'var(--bg-3)',borderBottom:'1px solid var(--border-1)',display:'grid',gridTemplateColumns:'2fr 1fr 1fr',gap:0}}>
              {['ORGANIZATION','OPACITY','ACTIONS'].map(h=>
                <span key={h} style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-2)',letterSpacing:'.07em',fontWeight:600}}>{h}</span>)}
            </div>
            {orgChannels.map((ch,i)=>{
              const peerOrgId = ch.orgs?.find(o=>o!==orgRoom);
              const peerName = ch.org_names?.[peerOrgId]||peerOrgId?.slice(0,20)||'Unknown Org';
              return <div key={ch.roomId} style={{display:'grid',gridTemplateColumns:'2fr 1fr 1fr',gap:0,padding:'12px 16px',
                borderBottom:i<orgChannels.length-1?'1px solid var(--border-0)':'none',alignItems:'center',transition:'background .15s'}}
                onMouseEnter={e=>e.currentTarget.style.background='var(--bg-3)'}
                onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <div style={{width:28,height:28,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)'}}><I n="msg" s={14}/></div>
                  <div>
                    <span style={{fontSize:13,fontWeight:600,display:'block'}}>{peerName}</span>
                    <span style={{fontSize:9.5,color:'var(--tx-3)',fontFamily:'var(--mono)'}}>{ch.roomId?.slice(0,20)}…</span>
                  </div>
                </div>
                <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:9,justifySelf:'start'}}>{OPACITY_LABELS[orgOpacity]}</span>
                <button onClick={()=>openChannel(ch.roomId)} className="b-gho b-sm" style={{justifySelf:'start',display:'flex',alignItems:'center',gap:4}}>
                  <I n="msg" s={12}/>Open
                </button>
              </div>;
            })}
          </div>}
          <div style={{background:'var(--purple-dim)',border:'1px solid rgba(167,139,250,.15)',borderRadius:'var(--r)',padding:'14px 18px',marginTop:20,display:'flex',gap:10,alignItems:'flex-start'}}>
            <I n="eyeOff" s={16} c="var(--purple)"/>
            <span style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6}}>
              <strong style={{color:'var(--purple)'}}>Opacity governs outgoing messages.</strong> When your org responds, the receiving org will see your identity according to your opacity setting ({OPACITY_LABELS[orgOpacity]}). Incoming messages are displayed according to the <em>sending</em> org's opacity setting — you cannot force another org to reveal more than they choose to.
            </span>
          </div>
        </>
        : <>
          {/* Active channel — message thread */}
          <button onClick={()=>{setActiveChannel(null);setChannelMessages([])}} className="b-gho b-sm" style={{marginBottom:14,display:'flex',alignItems:'center',gap:4}}><I n="back" s={13}/>All Channels</button>
          {(() => {
            const ch = orgChannels.find(c=>c.roomId===activeChannel);
            const peerOrgId = ch?.orgs?.find(o=>o!==orgRoom);
            const peerName = ch?.org_names?.[peerOrgId]||peerOrgId?.slice(0,20)||'Unknown Org';
            return <>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:20}}>
                <div>
                  <h2 style={{fontFamily:'var(--serif)',fontSize:20,fontWeight:700}}>{peerName}</h2>
                  <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4}}>
                    <span className="tag tag-teal"><I n="lock" s={9}/>E2EE</span>
                    <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:9}}>OUTGOING: {OPACITY_LABELS[orgOpacity]?.toUpperCase()}</span>
                    <span style={{fontFamily:'var(--mono)',fontSize:9.5,color:'var(--tx-3)'}}>org-to-org channel</span>
                  </div>
                </div>
                <button onClick={()=>loadChannelMessages(activeChannel)} className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:4}}><I n="refresh-cw" s={11}/>Refresh</button>
              </div>
              <div className="card" style={{marginBottom:16}}>
                <span className="section-label">MESSAGES</span>
                <div style={{maxHeight:400,overflow:'auto',marginBottom:12}}>
                  {channelMessages.length===0?
                    <p style={{color:'var(--tx-3)',fontSize:12,padding:'20px 0',textAlign:'center'}}>No messages yet. Start the conversation.</p>
                  :channelMessages.map((msg,i)=>{
                    const sender = resolveMessageSender(msg);
                    return <div key={msg.id||i} style={{padding:'10px 0',borderBottom:'1px solid var(--border-0)'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
                        <div style={{display:'flex',alignItems:'center',gap:6}}>
                          <span style={{fontFamily:'var(--mono)',fontSize:10.5,fontWeight:600,
                            color:sender.isOwn?'var(--gold)':'var(--teal)'}}>
                            {sender.isOwn?'You'+(sender.org?` (${sender.org})`:''):sender.label}
                          </span>
                          {msg.content?.[`${NS}.envelope`]&&<span className={`tag ${
                            msg.content[`${NS}.envelope`].opacity==='opaque'?'tag-red':
                            msg.content[`${NS}.envelope`].opacity==='translucent'?'tag-gold':'tag-green'
                          }`} style={{fontSize:7.5}}>
                            {msg.content[`${NS}.envelope`].opacity?.toUpperCase()}
                          </span>}
                        </div>
                        <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--tx-3)'}}>{msg.ts?new Date(msg.ts).toLocaleString():''}</span>
                      </div>
                      <p style={{fontSize:12.5,color:'var(--tx-1)',lineHeight:1.5}}>{msg.content?.body}</p>
                    </div>;
                  })}
                </div>
                {hasOrgMsgPermission('respond')?<div style={{display:'flex',gap:6}}>
                  <input value={orgMsgText} onChange={e=>setOrgMsgText(e.target.value)}
                    placeholder={`Message as ${orgOpacity==='transparent'?(providerProfile.display_name||'you'):orgOpacity==='translucent'?(orgMeta.name||'your org'):'anonymous org'}... (E2EE)`}
                    onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey)handleSendOrgMsg()}} style={{flex:1}}/>
                  <button onClick={handleSendOrgMsg} className="b-pri" style={{display:'flex',alignItems:'center',gap:4}}><I n="send" s={13}/>Send</button>
                </div>
                :<div style={{padding:'10px 14px',background:'var(--gold-dim)',borderRadius:'var(--r)',display:'flex',alignItems:'center',gap:8}}>
                  <I n="lock" s={13} c="var(--gold)"/>
                  <span style={{fontSize:11.5,color:'var(--gold)'}}>Your role ({ORG_ROLE_LABELS[orgRole]||orgRole}) does not have permission to respond to org messages. Contact your admin.</span>
                </div>}
              </div>
            </>;
          })()}
        </>}
      </div>}

      {/* ACTIVITY */}
      {view==='activity'&&<ActivityStream session={session}/>}
    </div>

    {/* DISCOVER CLIENT MODAL */}
    <Modal open={discoverModal} onClose={()=>setDiscoverModal(false)} title="Find Client">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Look up a client by their Matrix ID. If they've created a bridge room and invited you, it will appear in your cases.</p>
      <div style={{marginBottom:14}}><span className="section-label">CLIENT MATRIX ID</span>
        <input value={discoverUserId} onChange={e=>setDiscoverUserId(e.target.value)} placeholder="@client:matrix.org"/></div>
      <button onClick={handleDiscoverClient} className="b-pri" style={{width:'100%'}}>Search for Bridge</button>
    </Modal>

    {/* CREATE ORGANIZATION MODAL */}
    <Modal open={createOrgModal} onClose={()=>setCreateOrgModal(false)} title="Create Organization" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Create an organization to manage staff, cases across your team, and participate in networks. You'll be the admin.</p>
      <div style={{marginBottom:14}}>
        <span className="section-label">ORGANIZATION NAME</span>
        <input value={setupData.name} onChange={e=>setSetupData({...setupData,name:e.target.value})} placeholder="e.g. Metro Services Organization"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">ORGANIZATION TYPE</span>
        <select value={setupData.type} onChange={e=>setSetupData({...setupData,type:e.target.value})}>
          {ORG_TYPES.map(t=><option key={t} value={t}>{ORG_TYPE_LABELS[t]}</option>)}
        </select>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">SERVICE AREA</span>
        <input value={setupData.service_area} onChange={e=>setSetupData({...setupData,service_area:e.target.value})} placeholder="e.g. Davidson County, TN"/>
      </div>
      <div style={{marginBottom:20}}>
        <span className="section-label">LANGUAGES (comma-separated)</span>
        <input value={setupData.languages} onChange={e=>setSetupData({...setupData,languages:e.target.value})} placeholder="en, es"/>
      </div>
      <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        This creates an encrypted Matrix room for your organization. You'll be the admin. Staff can be invited with specific roles. Your provider account gains org context — you can manage staff, cases, and networks from your dashboard.
      </div>
      <button onClick={handleCreateOrg} className="b-pri" disabled={!setupData.name.trim()} style={{width:'100%',padding:12,fontSize:14}}>
        <I n="users" s={16}/> Create Organization
      </button>
    </Modal>

    {/* JOIN ORGANIZATION MODAL */}
    <Modal open={joinOrgModal} onClose={()=>setJoinOrgModal(false)} title="Join Organization">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Enter the Matrix room ID of an existing Khora organization to join it. The org admin must have invited you.</p>
      <div style={{marginBottom:14}}><span className="section-label">ORGANIZATION ROOM ID</span>
        <input value={joinOrgId} onChange={e=>setJoinOrgId(e.target.value)} placeholder="!roomid:matrix.org"/></div>
      <button onClick={handleJoinOrg} className="b-pri" style={{width:'100%'}}>Join Organization</button>
    </Modal>

    {/* INVITE STAFF MODAL */}
    <Modal open={inviteModal} onClose={()=>setInviteModal(false)} title="Invite Staff Member">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Invite a provider to your organization. They'll receive access to cases based on their assigned role.</p>
      <div style={{marginBottom:14}}><span className="section-label">MATRIX ID</span>
        <input value={inviteUserId} onChange={e=>setInviteUserId(e.target.value)} placeholder="@staff:matrix.org"/></div>
      <div style={{marginBottom:14}}><span className="section-label">ROLE</span>
        <select value={inviteRole} onChange={e=>setInviteRole(e.target.value)}>
          {ORG_ROLES.map(r=><option key={r} value={r}>{ORG_ROLE_LABELS[r]}</option>)}
        </select></div>
      <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14,fontSize:11.5,color:'var(--tx-1)'}}>
        Role determines which cases and data the staff member can access. Admins see everything; read-only users see only aggregate dashboards.
      </div>
      <button onClick={handleInviteStaff} className="b-pri" style={{width:'100%'}}>Send Invite</button>
    </Modal>

    {/* CREATE NETWORK MODAL */}
    <Modal open={networkModal} onClose={()=>setNetworkModal(false)} title="Create Network">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Create a new governance network for your organization. Other organizations can join. Networks define shared vocabulary and schema propagation.</p>
      <div style={{marginBottom:14}}><span className="section-label">NETWORK NAME</span>
        <input value={networkName} onChange={e=>setNetworkName(e.target.value)} placeholder="e.g. Metro Partnership"/></div>
      <div style={{background:'var(--green-dim)',border:'1px solid rgba(61,214,140,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14,fontSize:11.5,color:'var(--tx-1)'}}>
        The network room will contain shared schema definitions that propagate to all member organizations. Your org "{orgMeta.name}" will be the network admin.
      </div>
      <button onClick={handleCreateNetwork} className="b-pri" style={{width:'100%'}}>Create Network</button>
    </Modal>

    {/* JOIN NETWORK MODAL */}
    <Modal open={joinNetworkModal} onClose={()=>setJoinNetworkModal(false)} title="Join Network">
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>Enter the Matrix room ID of an existing Khora network to join as "{orgMeta.name||'your organization'}".</p>
      <div style={{marginBottom:14}}><span className="section-label">NETWORK ROOM ID</span>
        <input value={joinNetworkId} onChange={e=>setJoinNetworkId(e.target.value)} placeholder="!roomid:matrix.org"/></div>
      <button onClick={handleJoinNetwork} className="b-pri" style={{width:'100%'}}>Join Network</button>
    </Modal>

    {/* PROVIDER OBSERVATION MODAL */}
    <Modal open={!!provObsModal} onClose={()=>setProvObsModal(null)} title={provObsModal?.question||'Record Observation'} w={500}>
      {provObsModal&&<>
        {provObsModal.eo?.trace&&<div style={{background:'var(--purple-dim)',border:'1px solid rgba(167,139,250,.15)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14}}>
          <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--purple)'}}>{provObsModal.eo.trace}</span>
        </div>}
        <div style={{marginBottom:14}}>
          <span className="section-label">RESPONSE</span>
          {provObsModal.type==='numeric'?
            <div>
              <input type="number" value={provObsValue} onChange={e=>setProvObsValue(e.target.value)}
                placeholder={`${provObsModal.range?.min||0} — ${provObsModal.range?.max||100}`}
                min={provObsModal.range?.min} max={provObsModal.range?.max}/>
              {provObsModal.thresholds&&<div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:6}}>
                {provObsModal.thresholds.map((t,i)=><span key={i} style={{fontSize:9.5,padding:'2px 8px',
                  background:provObsValue>=t.v&&(i===provObsModal.thresholds.length-1||provObsValue<provObsModal.thresholds[i+1]?.v)?'var(--gold-dim)':'var(--bg-3)',
                  borderRadius:10,color:provObsValue>=t.v&&(i===provObsModal.thresholds.length-1||provObsValue<provObsModal.thresholds[i+1]?.v)?'var(--gold)':'var(--tx-2)'}}>
                  {t.v}+ {t.l}</span>)}
              </div>}
            </div>
          :<div style={{display:'flex',flexDirection:'column',gap:4}}>
            {provObsModal.options?.map(o=><div key={o.v} onClick={()=>setProvObsValue(o.v)}
              style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',
                border:`1px solid ${provObsValue===o.v?'var(--gold)':'var(--border-1)'}`,
                background:provObsValue===o.v?'var(--gold-dim)':'var(--bg-3)',transition:'all .15s'}}>
              <span style={{fontSize:12.5,color:provObsValue===o.v?'var(--gold)':'var(--tx-1)'}}>{o.l}</span>
            </div>)}
          </div>}
        </div>
        <div style={{marginBottom:14}}>
          <span className="section-label">CLINICAL NOTES (OPTIONAL)</span>
          <textarea value={provObsNotes} onChange={e=>setProvObsNotes(e.target.value)} placeholder="Additional clinical context..." style={{minHeight:50}}/>
        </div>
        <div style={{background:'var(--gold-dim)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14,fontSize:11,color:'var(--gold)'}}>
          This observation is recorded as a MEANT event — a professional assessment with full EO provenance chain.
        </div>
        <button onClick={handleProviderObservation} className="b-pri" disabled={!provObsValue} style={{width:'100%'}}>Record {T.provider_term} Observation</button>
      </>}
    </Modal>

    {/* PROVIDER PROFILE MODAL */}
    <Modal open={profileModal} onClose={()=>setProfileModal(false)} title={`${T.provider_term} Profile`} w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Your profile is stored in your roster room and broadcast to all bridge rooms. {T.client_term_plural} see your name, title, credentials, and organization membership.
      </p>
      <div style={{marginBottom:14}}>
        <span className="section-label">DISPLAY NAME</span>
        <input value={profileDraft.display_name} onChange={e=>setProfileDraft({...profileDraft,display_name:e.target.value})} placeholder="e.g. Jamie Rivera"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">TITLE / ROLE</span>
        <input value={profileDraft.title} onChange={e=>setProfileDraft({...profileDraft,title:e.target.value})} placeholder="e.g. Case Manager, Outreach Worker"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">CREDENTIALS / CERTIFICATIONS</span>
        <input value={profileDraft.credentials} onChange={e=>setProfileDraft({...profileDraft,credentials:e.target.value})} placeholder="e.g. LCSW, CHW, HMIS Certified"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">SERVICE TYPES</span>
        <input value={profileDraft.service_types} onChange={e=>setProfileDraft({...profileDraft,service_types:e.target.value})} placeholder="e.g. Housing navigation, Benefits enrollment"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">BIO</span>
        <textarea value={profileDraft.bio} onChange={e=>setProfileDraft({...profileDraft,bio:e.target.value})} placeholder="Brief description of your role and how you help clients..." style={{minHeight:70}}/>
      </div>
      {orgRoom ? <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.2)',borderRadius:'var(--r)',padding:'12px 14px',marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
          <I n="shieldCheck" s={16} c="var(--blue)"/>
          <span style={{fontSize:13,fontWeight:700,color:'var(--blue)'}}>Organization Membership</span>
          {myVerification?.status==='verified' ? <span className="tag tag-green" style={{fontSize:8}}>EMAIL VERIFIED</span>
          : emailVerifyConfig.enabled ? <span className="tag tag-gold" style={{fontSize:8}}>EMAIL UNVERIFIED</span>
          : <span className="tag tag-green" style={{fontSize:8}}>ROSTER VERIFIED</span>}
        </div>
        <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong>{orgMeta.name}</strong> · {ORG_TYPE_LABELS[orgMeta.type]||orgMeta.type}<br/>
          Role: <strong>{ORG_ROLE_LABELS[orgRole]||orgRole}</strong>
          {orgMeta.service_area && <><br/>Service Area: {orgMeta.service_area}</>}
          {myVerification?.status==='verified' && myVerification.email && <><br/>Verified email: <strong>{myVerification.email}</strong></>}
        </div>
        {emailVerifyConfig.enabled && myVerification?.status!=='verified' ?
          <div style={{marginTop:8}}>
            <p style={{fontSize:10,color:'var(--gold)',marginBottom:6}}>Your organization requires email verification. Verify your email to display a verified badge to clients.</p>
            <button onClick={openEmailVerifyModal} className="b-pri b-sm" style={{fontSize:11}}>
              <I n="shieldCheck" s={12}/> Verify Email Now
            </button>
          </div>
        : <p style={{fontSize:10,color:'var(--tx-2)',marginTop:6}}>
            {myVerification?.status==='verified' ? 'Your identity is email-verified and visible to clients on all bridges.' : 'Your organization membership is verified through the Matrix room roster and will be visible to clients on all bridges.'}
          </p>}
      </div> : <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'12px 14px',marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <I n="alert" s={14} c="var(--gold)"/>
          <span style={{fontSize:11.5,color:'var(--gold)',fontWeight:600}}>No organization affiliation</span>
        </div>
        <p style={{fontSize:10.5,color:'var(--tx-2)',marginTop:4}}>Clients will see you as an independent provider. Create or join an organization to display a verified affiliation badge on your profile.</p>
      </div>}
      <button onClick={handleSaveProfile} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
        <I n="check" s={16}/> Save Profile & Broadcast
      </button>
    </Modal>

    {/* EMAIL VERIFICATION MODAL */}
    <Modal open={emailVerifyModal} onClose={()=>setEmailVerifyModal(false)} title="Verify Your Email" w={480}>
      {verifyStep==='email' && <>
        <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
          Enter your organization email address to verify your identity. A 6-digit code will be sent to your email.
          {emailVerifyConfig.required_domains?.length > 0 && <> Your email must be from: <strong>{emailVerifyConfig.required_domains.map(d=>'@'+d).join(', ')}</strong>.</>}
        </p>
        <div style={{marginBottom:14}}>
          <span className="section-label">EMAIL ADDRESS</span>
          <input value={verifyEmail} onChange={e=>{setVerifyEmail(e.target.value);setVerifyError('')}} placeholder={emailVerifyConfig.required_domains?.[0] ? `you@${emailVerifyConfig.required_domains[0]}` : 'you@organization.org'} type="email"/>
        </div>
        {verifyError && <div style={{background:'var(--red-dim)',border:'1px solid rgba(239,68,68,.2)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14,fontSize:11.5,color:'var(--red)'}}>{verifyError}</div>}
        <div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14,fontSize:11,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--blue)'}}>How it works:</strong> We'll send a one-time 6-digit code to this email. Enter it on the next screen to confirm you control this address. The code expires after 15 minutes.
        </div>
        <button onClick={handleStartEmailVerify} disabled={verifyPending || !verifyEmail.trim()} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
          {verifyPending ? 'Sending...' : <><I n="msg" s={14}/> Send Verification Code</>}
        </button>
      </>}
      {verifyStep==='code' && <>
        <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
          A verification code was sent to <strong>{verifyEmail}</strong>. Enter the 6-digit code below.
        </p>
        <div style={{marginBottom:14}}>
          <span className="section-label">VERIFICATION CODE</span>
          <input value={verifyCode} onChange={e=>{setVerifyCode(e.target.value.replace(/\D/g,'').slice(0,6));setVerifyError('')}}
            placeholder="000000" maxLength={6}
            style={{fontSize:28,letterSpacing:'0.3em',textAlign:'center',fontFamily:'var(--mono)',fontWeight:700}}/>
        </div>
        {verifyError && <div style={{background:'var(--red-dim)',border:'1px solid rgba(239,68,68,.2)',borderRadius:'var(--r)',padding:'8px 12px',marginBottom:14,fontSize:11.5,color:'var(--red)'}}>{verifyError}</div>}
        <div style={{display:'flex',gap:8}}>
          <button onClick={()=>{setVerifyStep('email');setVerifyCode('');setVerifyError('')}} className="b-gho" style={{flex:1}}>
            Back
          </button>
          <button onClick={handleSubmitVerifyCode} disabled={verifyPending || verifyCode.length !== 6} className="b-pri" style={{flex:2,padding:12,fontSize:14}}>
            {verifyPending ? 'Verifying...' : <><I n="shieldCheck" s={14}/> Verify</>}
          </button>
        </div>
      </>}
      {verifyStep==='done' && <>
        <div style={{textAlign:'center',padding:'20px 0'}}>
          <div style={{width:60,height:60,borderRadius:'50%',background:'var(--green-dim)',border:'2px solid var(--green)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 16px'}}>
            <I n="check" s={28} c="var(--green)"/>
          </div>
          <h3 style={{fontSize:18,fontWeight:700,color:'var(--green)',marginBottom:8}}>Email Verified</h3>
          <p style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.6,marginBottom:4}}>
            Your identity has been confirmed via <strong>{myVerification?.email}</strong>
          </p>
          <p style={{fontSize:11,color:'var(--tx-2)'}}>
            Your verified status is now visible to clients on all bridges and reflected in your provider profile.
          </p>
        </div>
        <button onClick={()=>setEmailVerifyModal(false)} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>Done</button>
      </>}
    </Modal>

    {/* EMAIL VERIFICATION CONFIG MODAL (admin only) */}
    <Modal open={emailConfigModal} onClose={()=>setEmailConfigModal(false)} title="Email Verification Settings" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Configure email verification requirements for your organization. When enabled, staff members must verify they control an email at an approved domain before accessing cases.
      </p>
      <div style={{marginBottom:16}}>
        <label style={{display:'flex',alignItems:'center',gap:10,cursor:'pointer',padding:'12px 14px',background:emailConfigDraft.enabled?'var(--green-dim)':'var(--bg-3)',border:`1px solid ${emailConfigDraft.enabled?'rgba(61,214,140,.2)':'var(--border-0)'}`,borderRadius:'var(--r)'}}>
          <input type="checkbox" checked={emailConfigDraft.enabled} onChange={e=>setEmailConfigDraft({...emailConfigDraft,enabled:e.target.checked})} style={{width:16,height:16}}/>
          <div>
            <span style={{fontSize:13,fontWeight:600,display:'block'}}>Require Email Verification</span>
            <span style={{fontSize:11,color:'var(--tx-2)'}}>Staff must verify their email before full access</span>
          </div>
        </label>
      </div>
      {emailConfigDraft.enabled && <>
        <div style={{marginBottom:14}}>
          <span className="section-label">APPROVED EMAIL DOMAINS</span>
          <input value={(emailConfigDraft.required_domains||[]).join(', ')}
            onChange={e=>setEmailConfigDraft({...emailConfigDraft,required_domains:e.target.value.split(',').map(s=>s.trim().replace(/^@/,''))})}
            placeholder="e.g. metroservices.org, metro-services.com"/>
          <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>Comma-separated list of allowed email domains. Leave empty to allow any domain.</span>
        </div>
        <div style={{marginBottom:14}}>
          <span className="section-label">REQUIRED FOR ROLES</span>
          <div style={{display:'flex',flexWrap:'wrap',gap:6,marginTop:4}}>
            {ORG_ROLES.map(r=>{
              const active = (emailConfigDraft.require_for_roles||[]).includes(r);
              return <label key={r} style={{display:'flex',alignItems:'center',gap:4,cursor:'pointer',padding:'4px 8px',background:active?'var(--blue-dim)':'var(--bg-3)',border:`1px solid ${active?'rgba(91,156,245,.2)':'var(--border-0)'}`,borderRadius:6,fontSize:11}}>
                <input type="checkbox" checked={active} onChange={e=>{
                  const roles = e.target.checked ? [...(emailConfigDraft.require_for_roles||[]),r] : (emailConfigDraft.require_for_roles||[]).filter(x=>x!==r);
                  setEmailConfigDraft({...emailConfigDraft,require_for_roles:roles});
                }} style={{width:12,height:12}}/>
                {ORG_ROLE_LABELS[r]}
              </label>;
            })}
          </div>
        </div>
        <div style={{marginBottom:14}}>
          <span className="section-label">GRACE PERIOD (HOURS)</span>
          <input type="number" min={0} max={720} value={emailConfigDraft.grace_period_hours||72}
            onChange={e=>setEmailConfigDraft({...emailConfigDraft,grace_period_hours:parseInt(e.target.value)||72})}/>
          <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>Time before unverified staff lose access. 0 = immediate.</span>
        </div>
        <div style={{background:'var(--gold-dim)',border:'1px solid var(--gold-mid)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:14,fontSize:11,color:'var(--tx-1)',lineHeight:1.6}}>
          <strong style={{color:'var(--gold)'}}>Note:</strong> Enabling verification will prompt all existing staff in the selected roles to verify their email. Currently {staff.filter(s=>s.email_verification?.status==='verified').length} of {staff.length} staff are verified.
        </div>
      </>}
      <button onClick={handleSaveEmailVerifyConfig} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
        <I n="shieldCheck" s={16}/> Save Verification Settings
      </button>
    </Modal>

    {/* CREATE TEAM MODAL */}
    <Modal open={createTeamModal} onClose={()=>setCreateTeamModal(false)} title="New Team" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Create a team for collaboration. Teams are flexible — they can include people from your organization, other organizations, or individuals with no org affiliation. Anyone with a Matrix ID can be invited.
      </p>
      <div style={{marginBottom:14}}>
        <span className="section-label">TEAM NAME *</span>
        <input value={newTeamName} onChange={e=>setNewTeamName(e.target.value)} placeholder="e.g. Outreach Unit, Housing Support Team"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">DESCRIPTION (OPTIONAL)</span>
        <textarea value={newTeamDesc} onChange={e=>setNewTeamDesc(e.target.value)} placeholder="What is this team for?" style={{minHeight:50}}/>
      </div>
      {orgRoom&&<div style={{background:'var(--blue-dim)',border:'1px solid rgba(91,156,245,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        <strong style={{color:'var(--blue)'}}>Org affiliation:</strong> This team will be tagged with your org "{orgMeta.name||'Organization'}" but is not restricted to org members.
      </div>}
      <button onClick={handleCreateTeam} className="b-pri" disabled={!newTeamName.trim()} style={{width:'100%',padding:12,fontSize:14}}>
        <I n="users" s={16}/> Create Team
      </button>
    </Modal>

    {/* TEAM INVITE MODAL */}
    <Modal open={!!teamInviteModal} onClose={()=>{setTeamInviteModal(null);setTeamInviteUserId('')}} title={`Invite to: ${teamInviteModal?.name||''}`} w={520}>
      {teamInviteModal&&<>
        <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
          Invite someone to join this team. They'll be added as a member and can participate in team activities.
        </p>
        <div style={{marginBottom:14}}>
          <span className="section-label">MATRIX ID</span>
          <div style={{display:'flex',gap:6}}>
            <input value={teamInviteUserId} onChange={e=>setTeamInviteUserId(e.target.value)}
              placeholder="@user:matrix.org" style={{flex:1}}/>
            <button onClick={handleTeamInvite} className="b-pri" disabled={!teamInviteUserId.trim()}
              style={{whiteSpace:'nowrap',display:'flex',alignItems:'center',gap:4}}>
              <I n="send" s={12}/>Invite
            </button>
          </div>
        </div>
        <div style={{marginBottom:14}}>
          <span className="section-label">CURRENT MEMBERS ({teamInviteModal.members?.length||0})</span>
          <div style={{display:'flex',flexDirection:'column',gap:4,marginTop:6}}>
            {(teamInviteModal.members||[]).map((m,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:8,padding:'6px 10px',background:'var(--bg-3)',borderRadius:'var(--r)'}}>
              <I n={m.role==='lead'?'briefcase':'user'} s={12} c={m.role==='lead'?'var(--gold)':'var(--tx-2)'}/>
              <span style={{fontSize:11.5,flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{m.display_name||m.userId}</span>
              <span className={`tag ${m.role==='lead'?'tag-gold':'tag-blue'}`} style={{fontSize:8}}>{m.role?.toUpperCase()}</span>
            </div>)}
          </div>
        </div>
        <div style={{background:'var(--bg-3)',borderRadius:'var(--r)',padding:'10px 14px'}}>
          <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:4}}>TEAM ROOM ID</span>
          <span style={{fontSize:10.5,fontFamily:'var(--mono)',color:'var(--tx-1)',wordBreak:'break-all'}}>{teamInviteModal.roomId}</span>
        </div>
      </>}
    </Modal>

    {/* TERMINOLOGY CUSTOMIZATION MODAL */}
    <Modal open={terminologyModal} onClose={()=>setTerminologyModal(false)} title="Customize Terminology" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Customize the terms your organization uses for service recipients and service providers. These labels will appear throughout the interface for all staff at your organization.
      </p>
      <div style={{marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:12}}>
          <I n="shield" s={14} c="var(--teal)"/>
          <span style={{fontSize:13,fontWeight:700}}>Service Recipient Term</span>
          <span style={{fontSize:10,color:'var(--tx-3)'}}>(default: Individual)</span>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
          <div>
            <span className="section-label">SINGULAR</span>
            <input value={terminologyDraft.client_term} onChange={e=>setTerminologyDraft({...terminologyDraft,client_term:e.target.value})} placeholder="e.g. Patient, Participant, Member"/>
          </div>
          <div>
            <span className="section-label">PLURAL</span>
            <input value={terminologyDraft.client_term_plural} onChange={e=>setTerminologyDraft({...terminologyDraft,client_term_plural:e.target.value})} placeholder="e.g. Patients, Participants, Members"/>
          </div>
        </div>
        <div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:8}}>
          {['Individual','Client','Patient','Participant','Member','Resident','Student','Guest'].map(t=>
            <span key={t} onClick={()=>setTerminologyDraft({...terminologyDraft,client_term:t,client_term_plural:t+'s'})}
              className={`tag ${terminologyDraft.client_term===t?'tag-teal':'tag-blue'}`}
              style={{fontSize:9,cursor:'pointer',transition:'all .15s'}}>{t}</span>)}
        </div>
      </div>
      <div style={{marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:12}}>
          <I n="briefcase" s={14} c="var(--gold)"/>
          <span style={{fontSize:13,fontWeight:700}}>Service Provider Term</span>
          <span style={{fontSize:10,color:'var(--tx-3)'}}>(default: Team Member)</span>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
          <div>
            <span className="section-label">SINGULAR</span>
            <input value={terminologyDraft.provider_term} onChange={e=>setTerminologyDraft({...terminologyDraft,provider_term:e.target.value})} placeholder="e.g. Counselor, Therapist, Advocate"/>
          </div>
          <div>
            <span className="section-label">PLURAL</span>
            <input value={terminologyDraft.provider_term_plural} onChange={e=>setTerminologyDraft({...terminologyDraft,provider_term_plural:e.target.value})} placeholder="e.g. Counselors, Therapists, Advocates"/>
          </div>
        </div>
        <div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:8}}>
          {['Team Member','Provider','Counselor','Therapist','Advocate','Case Worker','Coordinator','Staff'].map(t=>
            <span key={t} onClick={()=>setTerminologyDraft({...terminologyDraft,provider_term:t,provider_term_plural:t+(t.endsWith('f')?'s':t.endsWith('or')?'s':'s')})}
              className={`tag ${terminologyDraft.provider_term===t?'tag-gold':'tag-blue'}`}
              style={{fontSize:9,cursor:'pointer',transition:'all .15s'}}>{t}</span>)}
        </div>
      </div>
      <div style={{background:'var(--bg-3)',borderRadius:'var(--r)',padding:'12px 14px',marginBottom:16}}>
        <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:8}}>PREVIEW</span>
        <div style={{fontSize:12,color:'var(--tx-1)',lineHeight:1.8}}>
          <span>"{terminologyDraft.provider_term||'Provider'} Dashboard" &middot; "My {terminologyDraft.client_term_plural||'Clients'}" &middot; "New {terminologyDraft.client_term||'Client'} Record"</span><br/>
          <span>"Anonymous {terminologyDraft.client_term||'Client'}" &middot; "{terminologyDraft.provider_term||'Provider'} Observation" &middot; "{terminologyDraft.provider_term||'Provider'} Profile"</span>
        </div>
      </div>
      <div style={{display:'flex',gap:8}}>
        <button onClick={handleResetTerminology} className="b-gho" style={{flex:1,padding:10}}>Reset to Defaults</button>
        <button onClick={handleSaveTerminology} className="b-pri"
          disabled={!terminologyDraft.client_term?.trim()||!terminologyDraft.client_term_plural?.trim()||!terminologyDraft.provider_term?.trim()||!terminologyDraft.provider_term_plural?.trim()}
          style={{flex:1,padding:10,fontSize:14}}>
          <I n="shieldCheck" s={14}/> Save Terminology
        </button>
      </div>
    </Modal>

    {/* CREATE CLIENT RECORD MODAL */}
    <Modal open={createClientModal} onClose={()=>setCreateClientModal(false)} title={`New ${T.client_term} Record`} w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
        Create a {T.client_term.toLowerCase()} record. This creates a private encrypted Matrix room. If you provide a Matrix ID, the {T.client_term.toLowerCase()} will be invited and given superadmin control (power level 100) — they can remove anyone from the room.
      </p>
      <div style={{marginBottom:14}}>
        <span className="section-label">{T.client_term.toUpperCase()} NAME *</span>
        <input value={newClientName} onChange={e=>setNewClientName(e.target.value)} placeholder="e.g. John Doe"/>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">{T.client_term.toUpperCase()} MATRIX ID (OPTIONAL)</span>
        <input value={newClientMatrixId} onChange={e=>setNewClientMatrixId(e.target.value)} placeholder="@user:matrix.org"/>
        <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>If provided, the {T.client_term.toLowerCase()} will be invited immediately. You can also invite them later.</span>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">NOTES (OPTIONAL)</span>
        <textarea value={newClientNotes} onChange={e=>setNewClientNotes(e.target.value)} placeholder={`Any notes about this ${T.client_term.toLowerCase()}...`} style={{minHeight:50}}/>
      </div>
      <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        <strong style={{color:'var(--teal)'}}>Data sovereignty:</strong> The {T.client_term.toLowerCase()} will receive power level 100 (superadmin). They can kick any member — including you — from their room at any time.
      </div>
      <button onClick={handleCreateClientRecord} className="b-pri" disabled={!newClientName.trim()} style={{width:'100%',padding:12,fontSize:14}}>
        <I n="plus" s={16}/> Create {T.client_term} Record
      </button>
    </Modal>

    {/* CLIENT INVITE MODAL */}
    <Modal open={!!clientInviteModal} onClose={()=>{setClientInviteModal(null);setCopiedField(null)}} title={`Invite: ${clientInviteModal?.client_name||''}`} w={600}>
      {clientInviteModal&&<>
        <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
          Generate an invite link and setup instructions to share with this {T.client_term.toLowerCase()}. When they join, they'll have full control of their room.
        </p>

        {/* Matrix ID input */}
        <div style={{marginBottom:16}}>
          <span className="section-label">{T.client_term.toUpperCase()} MATRIX ID</span>
          <div style={{display:'flex',gap:6}}>
            <input value={clientInviteMatrixId} onChange={e=>setClientInviteMatrixId(e.target.value)}
              placeholder="@user:matrix.org" style={{flex:1}}/>
            <button onClick={handleClientInvite} className="b-pri" disabled={!clientInviteMatrixId.trim()}
              style={{whiteSpace:'nowrap',display:'flex',alignItems:'center',gap:4}}>
              <I n="send" s={12}/>Send Invite
            </button>
          </div>
          <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>
            Enter the client's Matrix ID to send a direct room invite and grant them superadmin (PL 100).
          </span>
        </div>

        {/* Invite link */}
        <div style={{marginBottom:16}}>
          <span className="section-label">INVITE LINK</span>
          <div style={{display:'flex',gap:6,alignItems:'center'}}>
            <div style={{flex:1,fontFamily:'var(--mono)',fontSize:11,color:'var(--tx-1)',background:'var(--bg-3)',padding:'10px 14px',borderRadius:'var(--r)',border:'1px solid var(--border-1)',wordBreak:'break-all',userSelect:'all'}}>
              {getInviteUrl(clientInviteModal.roomId)}
            </div>
            <button onClick={()=>copyToClipboard(getInviteUrl(clientInviteModal.roomId),'link')}
              className="b-gho b-sm" style={{display:'flex',alignItems:'center',gap:4,whiteSpace:'nowrap'}}>
              <I n={copiedField==='link'?'check':'copy'} s={12}/>
              {copiedField==='link'?'Copied':'Copy'}
            </button>
          </div>
        </div>

        {/* Setup instructions */}
        <div style={{marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
            <span className="section-label" style={{marginBottom:0}}>SETUP INSTRUCTIONS — SHARE WITH CLIENT</span>
            <button onClick={()=>copyToClipboard(getSetupInstructions(clientInviteModal.roomId),'instructions')}
              className="b-gho b-xs" style={{display:'flex',alignItems:'center',gap:3}}>
              <I n={copiedField==='instructions'?'check':'copy'} s={11}/>
              {copiedField==='instructions'?'Copied':'Copy All'}
            </button>
          </div>
          <div style={{fontFamily:'var(--mono)',fontSize:10.5,color:'var(--tx-1)',background:'var(--bg-1)',border:'1px solid var(--border-1)',
            borderRadius:'var(--r)',padding:'14px 16px',lineHeight:1.7,whiteSpace:'pre-wrap',maxHeight:300,overflow:'auto'}}>
            {getSetupInstructions(clientInviteModal.roomId)}
          </div>
        </div>

        {/* Power level info */}
        <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'12px 16px',display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="shield" s={16} c="var(--teal)"/>
          <div style={{fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong style={{color:'var(--teal)'}}>Client gets power level 100 (superadmin).</strong> Once joined, they can remove anyone from this room — including you. This ensures the client always has sovereign control over who can access their space.
          </div>
        </div>
      </>}
    </Modal>
    {/* IMPORT DATA MODAL */}
    <ImportDataModal open={importModal} onClose={()=>setImportModal(false)}
      showToast={showToast} metricsRoom={metricsRoom} onComplete={handleImportComplete}/>

    {/* COMPOSE ORG MESSAGE CHANNEL MODAL */}
    <Modal open={composeOrgModal} onClose={()=>setComposeOrgModal(false)} title="New Org Messaging Channel" w={520}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:14,lineHeight:1.6}}>
        Create an encrypted messaging channel with another organization. Messages you send will be governed by your opacity setting (<strong style={{color:orgOpacity==='opaque'?'var(--red)':orgOpacity==='translucent'?'var(--gold)':'var(--green)'}}>{OPACITY_LABELS[orgOpacity]}</strong>).
      </p>
      <div style={{marginBottom:14}}>
        <span className="section-label">PEER ORGANIZATION ROOM ID</span>
        <input value={composePeerOrgId} onChange={e=>setComposePeerOrgId(e.target.value)} placeholder="!orgroom:matrix.org"/>
        <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>The Matrix room ID of the organization you want to message.</span>
      </div>
      <div style={{marginBottom:14}}>
        <span className="section-label">ORGANIZATION NAME (OPTIONAL)</span>
        <input value={composePeerOrgName} onChange={e=>setComposePeerOrgName(e.target.value)} placeholder="e.g. Metro Housing Authority"/>
        <span style={{fontSize:10,color:'var(--tx-3)',display:'block',marginTop:4}}>A display name for the other org. Helps identify the channel.</span>
      </div>
      {/* Opacity preview */}
      <div style={{background:'var(--bg-3)',borderRadius:'var(--r)',padding:'12px 14px',marginBottom:14}}>
        <span style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--tx-3)',display:'block',marginBottom:6}}>OPACITY PREVIEW — THEY WILL SEE:</span>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <span className={`tag ${orgOpacity==='opaque'?'tag-red':orgOpacity==='translucent'?'tag-gold':'tag-green'}`} style={{fontSize:9}}>{OPACITY_LABELS[orgOpacity]?.toUpperCase()}</span>
          <span style={{fontSize:12,color:'var(--tx-1)'}}>
            {orgOpacity==='transparent'?`${providerProfile.display_name||'Staff Name'} from ${orgMeta.name||'Your Org'}`
            :orgOpacity==='translucent'?orgMeta.name||'Your Org'
            :'An organization'}
          </span>
        </div>
      </div>
      <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        Both organizations maintain independent opacity settings. You control what they see about you; they control what you see about them.
      </div>
      <button onClick={handleCreateOrgChannel} className="b-pri" disabled={!composePeerOrgId.trim()} style={{width:'100%',padding:12,fontSize:14}}>
        <I n="msg" s={16}/> Create Channel
      </button>
    </Modal>

    {/* MESSAGE ACCESS CONFIGURATION MODAL */}
    <Modal open={msgAccessModal} onClose={()=>setMsgAccessModal(false)} title="Configure Message Access" w={560}>
      <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
        Control which staff roles in your organization can read and respond to inter-org messages. Only roles listed under "Respond" can send messages on behalf of your organization.
      </p>
      <div style={{marginBottom:16}}>
        <span className="section-label">CAN READ ORG MESSAGES</span>
        <p style={{fontSize:10.5,color:'var(--tx-3)',marginBottom:8}}>Select roles that can view messages sent to your organization.</p>
        <div style={{display:'flex',flexDirection:'column',gap:4}}>
          {ORG_ROLES.map(role=><div key={role} onClick={()=>{
            setMsgAccessDraft(prev=>({...prev,read:prev.read.includes(role)?prev.read.filter(r=>r!==role):[...prev.read,role]}));
          }} style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'space-between',
            border:`1px solid ${msgAccessDraft.read?.includes(role)?'var(--blue)':'var(--border-1)'}`,
            background:msgAccessDraft.read?.includes(role)?'var(--blue-dim)':'var(--bg-3)',transition:'all .15s'}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <span style={{width:14,height:14,borderRadius:3,border:`2px solid ${msgAccessDraft.read?.includes(role)?'var(--blue)':'var(--tx-3)'}`,
                background:msgAccessDraft.read?.includes(role)?'var(--blue)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontSize:9,fontWeight:800}}>
                {msgAccessDraft.read?.includes(role)?'✓':''}
              </span>
              <span style={{fontSize:12.5,fontWeight:msgAccessDraft.read?.includes(role)?600:400}}>{ORG_ROLE_LABELS[role]}</span>
            </div>
            <span className="tag tag-blue" style={{fontSize:8}}>READ</span>
          </div>)}
        </div>
      </div>
      <div style={{marginBottom:16}}>
        <span className="section-label">CAN RESPOND TO ORG MESSAGES</span>
        <p style={{fontSize:10.5,color:'var(--tx-3)',marginBottom:8}}>Select roles that can send messages on behalf of your organization. These roles can also read.</p>
        <div style={{display:'flex',flexDirection:'column',gap:4}}>
          {ORG_ROLES.map(role=><div key={role} onClick={()=>{
            setMsgAccessDraft(prev=>({...prev,respond:prev.respond.includes(role)?prev.respond.filter(r=>r!==role):[...prev.respond,role]}));
          }} style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'space-between',
            border:`1px solid ${msgAccessDraft.respond?.includes(role)?'var(--gold)':'var(--border-1)'}`,
            background:msgAccessDraft.respond?.includes(role)?'var(--gold-dim)':'var(--bg-3)',transition:'all .15s'}}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <span style={{width:14,height:14,borderRadius:3,border:`2px solid ${msgAccessDraft.respond?.includes(role)?'var(--gold)':'var(--tx-3)'}`,
                background:msgAccessDraft.respond?.includes(role)?'var(--gold)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-0)',fontSize:9,fontWeight:800}}>
                {msgAccessDraft.respond?.includes(role)?'✓':''}
              </span>
              <span style={{fontSize:12.5,fontWeight:msgAccessDraft.respond?.includes(role)?600:400}}>{ORG_ROLE_LABELS[role]}</span>
            </div>
            <span className="tag tag-gold" style={{fontSize:8}}>RESPOND</span>
          </div>)}
        </div>
      </div>
      <div style={{background:'var(--purple-dim)',border:'1px solid rgba(167,139,250,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
        <strong style={{color:'var(--purple)'}}>Opacity + Access = Privacy.</strong> Opacity controls <em>what</em> external orgs see. Access controls <em>who inside your org</em> can participate. Together, they form your org's communication privacy posture.
      </div>
      <button onClick={handleSaveMsgAccess} className="b-pri" style={{width:'100%',padding:12,fontSize:14}}>
        <I n="check" s={16}/> Save Access Settings
      </button>
    </Modal>

    {/* TRANSFER CASE MODAL */}
    <Modal open={!!transferModal} onClose={()=>{setTransferModal(null);setTransferTarget('')}} title="Transfer Case" w={520}>
      {transferModal&&<>
        <p style={{fontSize:12,color:'var(--tx-1)',marginBottom:16,lineHeight:1.6}}>
          Reassign this case to a different {T.provider_term.toLowerCase()} within your organization. The new {T.provider_term.toLowerCase()} will be invited to the encrypted bridge room.
        </p>
        {/* Current assignment info */}
        <div className="card" style={{padding:14,marginBottom:16}}>
          <span className="section-label">CURRENT CASE</span>
          <div style={{display:'flex',alignItems:'center',gap:10,marginTop:4}}>
            <div style={{width:36,height:36,borderRadius:'50%',background:'var(--teal-dim)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--teal)',border:'2px solid var(--teal)'}}>
              <I n="user" s={16}/>
            </div>
            <div>
              <span style={{fontSize:14,fontWeight:600,display:'block'}}>{transferModal.sharedData?.full_name||transferModal.clientUserId}</span>
              <span style={{fontSize:10.5,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>Currently: {transferModal.meta?.provider?.split(':')[0]?.replace('@','')}</span>
            </div>
          </div>
        </div>
        {/* Transferable status */}
        {!transferModal.transferable && <div style={{background:'var(--red-dim)',border:'1px solid rgba(232,93,93,.18)',borderRadius:'var(--r)',padding:'12px 16px',marginBottom:16,display:'flex',gap:10,alignItems:'flex-start'}}>
          <I n="lock" s={16} c="var(--red)"/>
          <div>
            <span style={{fontSize:12,fontWeight:600,color:'var(--red)',display:'block'}}>Transfer Blocked by {T.client_term}</span>
            <span style={{fontSize:11,color:'var(--tx-1)'}}>This {T.client_term.toLowerCase()} has disabled provider transfers. Only they can change this setting.</span>
          </div>
        </div>}
        {transferModal.transferable && <>
          {/* Select new provider */}
          <div style={{marginBottom:16}}>
            <span className="section-label">ASSIGN TO {T.provider_term.toUpperCase()}</span>
            <div style={{display:'flex',flexDirection:'column',gap:4}}>
              {staff.filter(s=>s.userId!==transferModal.meta?.provider).map(s=>{
                const isSelected = transferTarget === s.userId;
                return <div key={s.userId} onClick={()=>setTransferTarget(s.userId)}
                  style={{padding:'10px 14px',borderRadius:'var(--r)',cursor:'pointer',display:'flex',alignItems:'center',gap:10,
                    border:`1px solid ${isSelected?'var(--gold)':'var(--border-1)'}`,
                    background:isSelected?'var(--gold-dim)':'var(--bg-3)',transition:'all .15s'}}>
                  <span style={{width:14,height:14,borderRadius:'50%',border:`2px solid ${isSelected?'var(--gold)':'var(--tx-3)'}`,
                    background:isSelected?'var(--gold)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-0)',fontSize:9,fontWeight:800}}>
                    {isSelected?'✓':''}
                  </span>
                  <div style={{flex:1}}>
                    <span style={{fontSize:12.5,fontWeight:isSelected?600:400,display:'block'}}>{s.userId.split(':')[0]?.replace('@','')}</span>
                    <span style={{fontSize:10,color:'var(--tx-2)',fontFamily:'var(--mono)'}}>{ORG_ROLE_LABELS[s.role]||s.role}</span>
                  </div>
                  <span className={`tag tag-${s.role==='admin'?'gold':s.role==='case_manager'?'blue':'teal'}`} style={{fontSize:8}}>
                    {(ORG_ROLE_LABELS[s.role]||s.role).toUpperCase()}
                  </span>
                </div>;
              })}
              {staff.filter(s=>s.userId!==transferModal.meta?.provider).length===0&&
                <div style={{padding:16,textAlign:'center',color:'var(--tx-3)',fontSize:12}}>No other staff available for transfer.</div>}
            </div>
          </div>
          <div style={{background:'var(--teal-dim)',border:'1px solid rgba(62,201,176,.15)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:16,fontSize:11.5,color:'var(--tx-1)',lineHeight:1.6}}>
            <strong style={{color:'var(--teal)'}}>The {T.client_term.toLowerCase()} retains full control.</strong> They can revoke access from the new {T.provider_term.toLowerCase()} at any time. Encrypted field keys remain {T.client_term.toLowerCase()}-owned.
          </div>
          <button onClick={handleTransferCase} className="b-pri" disabled={!transferTarget}
            style={{width:'100%',padding:12,fontSize:14}}>
            <I n="users" s={16}/> Transfer Case
          </button>
        </>}
      </>}
    </Modal>
  </div>;
};



/* ═══════════════════ MAIN APP ═══════════════════ */
const App = () => {
  const [welcomed, setWelcomed] = useState(false);
  const [session, setSession] = useState(null);
  const [availableContexts, setAvailableContexts] = useState([]);
  const [activeContext, setActiveContext] = useState(null);
  const [detectedRoles, setDetectedRoles] = useState(null); // roles from inferRolesFromRooms
  const [toast, setToast] = useState(null);
  const [webhookData, setWebhookData] = useState(null);
  const [restoring, setRestoring] = useState(true);
  const [detectingRoles, setDetectingRoles] = useState(false);

  const showToast = (msg, type='info') => setToast({msg, type, k:Date.now()});

  // Context detection: scan rooms to infer roles (MVP §Screen 1)
  // Uses inferRolesFromRooms for fine-grained role detection (client/provider/org_admin/network)
  const detectContexts = React.useCallback(async () => {
    setDetectingRoles(true);
    try {
      const scanned = await svc.scanRooms([EVT.ORG_ROSTER]);
      // Fine-grained role detection via inferRolesFromRooms
      const roles = inferRolesFromRooms(scanned, svc.userId);
      setDetectedRoles(roles);

      // Context detection for app routing (client vs provider)
      let hasClient = false;
      let hasProvider = false;
      for (const state of Object.values(scanned || {})) {
        const accountType = state?.[EVT.IDENTITY]?.account_type;
        if (accountType === 'client' || accountType === 'client_record') hasClient = true;
        if (accountType === 'provider' || accountType === 'organization' || accountType === 'schema' || accountType === 'metrics' || accountType === 'network') hasProvider = true;
      }

      const contexts = [];
      if (hasProvider) contexts.push('provider');
      if (hasClient) contexts.push('client');
      if (contexts.length === 0) contexts.push('provider');
      setAvailableContexts(contexts);

      let preferred = null;
      try { preferred = localStorage.getItem('khora_active_context'); } catch {}
      const next = (preferred && contexts.includes(preferred)) ? preferred : contexts[0];
      setActiveContext(next);
    } catch (e) {
      console.warn('Context detection failed, defaulting to provider:', e.message);
      setAvailableContexts(['provider']);
      setActiveContext('provider');
    }
    setDetectingRoles(false);
  }, []);

  const switchContext = (context) => {
    if (!availableContexts.includes(context)) return;
    setActiveContext(context);
    try { localStorage.setItem('khora_active_context', context); } catch {}
  };

  // Attempt to restore previous session from localStorage on mount
  React.useEffect(() => {
    (async () => {
      try {
        const restored = await svc.restoreSession();
        if (restored) {
          setSession(restored);
          // Hydrate webhook data in background
          try {
            const tables = await hydrateFromWebhooks(svc._token);
            setWebhookData(tables);
          } catch (e) { console.warn('Webhook hydration failed:', e.message); }
          await detectContexts();
        }
      } catch {} finally { setRestoring(false); }
    })();
  }, [detectContexts]);

  const handleLogin = async (s) => {
    setSession(s);
    // Detect contexts + roles from room membership (MVP §Screen 1)
    await detectContexts();
    // Hydrate Airtable data from n8n webhooks in background
    try {
      const tables = await hydrateFromWebhooks(svc._token);
      setWebhookData(tables);
    } catch (e) {
      console.warn('Webhook hydration failed (CORS or network):', e.message);
    }
  };

  if (restoring || detectingRoles) return <div className="grid-bg" style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center'}}><Spin s={32}/><p style={{color:'var(--tx-2)',fontSize:13,marginTop:16}}>{detectingRoles ? 'Detecting roles from room membership…' : 'Restoring session…'}</p></div>
  </div>;
  if (!welcomed && !session) return <WelcomeScreen onContinue={() => setWelcomed(true)}/>;
  if (!session) return <LoginScreen onLogin={handleLogin}/>;
  if (!activeContext) return <div className="grid-bg" style={{height:'100%',display:'flex',alignItems:'center',justifyContent:'center'}}>
    <div style={{textAlign:'center'}}><Spin s={28}/><p style={{color:'var(--tx-2)',fontSize:13,marginTop:16}}>Detecting role context…</p></div>
  </div>;

  const handleLogout = async () => {
    try { localStorage.removeItem('khora_session'); localStorage.removeItem('khora_active_context'); } catch {}
    await svc.logout(); setSession(null); setAvailableContexts([]); setActiveContext(null); setDetectedRoles(null); setWebhookData(null);
  };

  return <>
    {activeContext === 'client' ?
      <ClientApp session={session} onLogout={handleLogout} showToast={showToast} webhookData={webhookData}/> :
      <ProviderApp session={session} onLogout={handleLogout} showToast={showToast} webhookData={webhookData}/>
    }
    {/* Context switcher — visible when user has multiple role contexts */}
    {availableContexts.length > 1 && <div style={{position:'fixed',bottom:14,right:14,zIndex:30,display:'flex',gap:6,padding:'6px',border:'1px solid var(--border-0)',background:'var(--bg-2)',borderRadius:'999px',backdropFilter:'blur(4px)'}}>
      {[{id:'provider',label:ROLES.provider.label,icon:'briefcase'},{id:'client',label:ROLES.client.label,icon:'shield'}]
        .filter(opt => availableContexts.includes(opt.id))
        .map(opt => <button key={opt.id} onClick={()=>switchContext(opt.id)} className={activeContext===opt.id?'b-pri b-xs':'b-gho b-xs'} style={{display:'inline-flex',alignItems:'center',gap:4,borderRadius:'999px'}}>
          <I n={opt.icon} s={11}/>{opt.label}
        </button>)}
    </div>}
    {toast && <Toast key={toast.k} msg={toast.msg} type={toast.type} onClose={()=>setToast(null)}/>}
  </>;
};

ReactDOM.createRoot(document.getElementById('root')).render(<ThemeProvider><App/></ThemeProvider>);
</script>
</body>
</html>
